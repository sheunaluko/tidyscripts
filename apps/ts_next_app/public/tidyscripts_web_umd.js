/*! For license information please see tidyscripts_web_umd.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.tidyscripts_web=t():e.tidyscripts_web=t()}(this,(()=>(()=>{var e={515:(e,t)=>{var n={78:(e,t)=>{var n={749:(e,t,n)=>{e=n.nmd(e);const r=(e=0)=>t=>`[${38+e};5;${t}m`,a=(e=0)=>(t,n,r)=>`[${38+e};2;${t};${n};${r}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(const[n,r]of Object.entries(t)){for(const[n,a]of Object.entries(r))t[n]={open:`[${a[0]}m`,close:`[${a[1]}m`},r[n]=t[n],e.set(a[0],a[1]);Object.defineProperty(t,n,{value:r,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="[39m",t.bgColor.close="[49m",t.color.ansi256=r(),t.color.ansi16m=a(),t.bgColor.ansi256=r(10),t.bgColor.ansi16m=a(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,n)=>e===t&&t===n?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(n/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:n}=t.groups;3===n.length&&(n=n.split("").map((e=>e+e)).join(""));const r=Number.parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},991:(e,t)=>{t.byteLength=function(e){var t=o(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,i=o(e),s=i[0],c=i[1],u=new a(function(e,t,n){return 3*(t+n)/4-n}(0,s,c)),l=0,d=c>0?s-4:s;for(n=0;n<d;n+=4)t=r[e.charCodeAt(n)]<<18|r[e.charCodeAt(n+1)]<<12|r[e.charCodeAt(n+2)]<<6|r[e.charCodeAt(n+3)],u[l++]=t>>16&255,u[l++]=t>>8&255,u[l++]=255&t;return 2===c&&(t=r[e.charCodeAt(n)]<<2|r[e.charCodeAt(n+1)]>>4,u[l++]=255&t),1===c&&(t=r[e.charCodeAt(n)]<<10|r[e.charCodeAt(n+1)]<<4|r[e.charCodeAt(n+2)]>>2,u[l++]=t>>8&255,u[l++]=255&t),u},t.fromByteArray=function(e){for(var t,r=e.length,a=r%3,i=[],s=16383,o=0,u=r-a;o<u;o+=s)i.push(c(e,o,o+s>u?u:o+s));return 1===a?(t=e[r-1],i.push(n[t>>2]+n[t<<4&63]+"==")):2===a&&(t=(e[r-2]<<8)+e[r-1],i.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"=")),i.join("")};for(var n=[],r=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0;s<64;++s)n[s]=i[s],r[i.charCodeAt(s)]=s;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function c(e,t,r){for(var a,i,s=[],o=t;o<r;o+=3)a=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),s.push(n[(i=a)>>18&63]+n[i>>12&63]+n[i>>6&63]+n[63&i]);return s.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},832:e=>{const t=/[\p{Lu}]/u,n=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,a=/([\p{Alpha}\p{N}_]|$)/u,i=/[_.\- ]+/,s=new RegExp("^"+i.source),o=new RegExp(i.source+a.source,"gu"),c=new RegExp("\\d+"+a.source,"gu"),u=(e,a)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(a={pascalCase:!1,preserveConsecutiveUppercase:!1,...a},0===(e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim()).length)return"";const i=!1===a.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(a.locale),u=!1===a.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(a.locale);return 1===e.length?a.pascalCase?u(e):i(e):(e!==i(e)&&(e=((e,r,a)=>{let i=!1,s=!1,o=!1;for(let c=0;c<e.length;c++){const u=e[c];i&&t.test(u)?(e=e.slice(0,c)+"-"+e.slice(c),i=!1,o=s,s=!0,c++):s&&o&&n.test(u)?(e=e.slice(0,c-1)+"-"+e.slice(c-1),o=s,s=!1,i=!0):(i=r(u)===u&&a(u)!==u,o=s,s=a(u)===u&&r(u)!==u)}return e})(e,i,u)),e=e.replace(s,""),e=a.preserveConsecutiveUppercase?((e,t)=>(r.lastIndex=0,e.replace(r,(e=>t(e)))))(e,i):i(e),a.pascalCase&&(e=u(e.charAt(0))+e.slice(1)),((e,t)=>(o.lastIndex=0,c.lastIndex=0,e.replace(o,((e,n)=>t(n))).replace(c,(e=>t(e)))))(e,u))};e.exports=u,e.exports.default=u},409:e=>{e.exports=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},985:e=>{var t=Object.prototype.hasOwnProperty,n="~";function r(){}function a(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function i(e,t,r,i,s){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new a(r,i||e,s),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,a=[];if(0===this._eventsCount)return a;for(r in e=this._events)t.call(e,r)&&a.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(e)):a},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var a=0,i=r.length,s=new Array(i);a<i;a++)s[a]=r[a].fn;return s},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,a,i,s){var o=n?n+e:e;if(!this._events[o])return!1;var c,u,l=this._events[o],d=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),d){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,a),!0;case 5:return l.fn.call(l.context,t,r,a,i),!0;case 6:return l.fn.call(l.context,t,r,a,i,s),!0}for(u=1,c=new Array(d-1);u<d;u++)c[u-1]=arguments[u];l.fn.apply(l.context,c)}else{var h,f=l.length;for(u=0;u<f;u++)switch(l[u].once&&this.removeListener(e,l[u].fn,void 0,!0),d){case 1:l[u].fn.call(l[u].context);break;case 2:l[u].fn.call(l[u].context,t);break;case 3:l[u].fn.call(l[u].context,t,r);break;case 4:l[u].fn.call(l[u].context,t,r,a);break;default:if(!c)for(h=1,c=new Array(d-1);h<d;h++)c[h-1]=arguments[h];l[u].fn.apply(l[u].context,c)}}return!0},o.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,a){var i=n?n+e:e;if(!this._events[i])return this;if(!t)return s(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||a&&!o.once||r&&o.context!==r||s(this,i);else{for(var c=0,u=[],l=o.length;c<l;c++)(o[c].fn!==t||a&&!o[c].once||r&&o[c].context!==r)&&u.push(o[c]);u.length?this._events[i]=1===u.length?u[0]:u:s(this,i)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&s(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o},425:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(985),a=n(856),i=n(147),s=()=>{},o=new a.TimeoutError;t.default=class extends r{constructor(e){var t,n,r,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=s,this._resolveIdle=s,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:i.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==n?n:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(a=null===(r=e.interval)||void 0===r?void 0:r.toString())&&void 0!==a?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=s,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=s,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((n,r)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const i=void 0===this._timeout&&void 0===t.timeout?e():a.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&r(o)}));n(await i)}catch(e){r(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},657:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n){let r=0,a=e.length;for(;a>0;){const i=a/2|0;let s=r+i;n(e[s],t)<=0?(r=++s,a-=i+1):a=i}return r}},147:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(657);t.default=class{constructor(){this._queue=[]}enqueue(e,t){const n={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(n);const a=r.default(this._queue,n,((e,t)=>t.priority-e.priority));this._queue.splice(a,0,n)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}}},201:(e,t,n)=>{const r=n(364),a=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class i extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const s=(e,t)=>new Promise(((n,s)=>{t={onFailedAttempt:()=>{},retries:10,...t};const o=r.operation(t);o.attempt((async r=>{try{n(await e(r))}catch(e){if(!(e instanceof Error))return void s(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof i)o.stop(),s(e.originalError);else if(e instanceof TypeError&&(c=e.message,!a.includes(c)))o.stop(),s(e);else{((e,t,n)=>{const r=n.retries-(t-1);e.attemptNumber=t,e.retriesLeft=r})(e,r,t);try{await t.onFailedAttempt(e)}catch(e){return void s(e)}o.retry(e)||s(o.mainError())}}var c}))}));e.exports=s,e.exports.default=s,e.exports.AbortError=i},856:(e,t,n)=>{const r=n(70);class a extends Error{constructor(e){super(e),this.name="TimeoutError"}}const i=(e,t,n)=>new Promise(((i,s)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void i(e);const o=setTimeout((()=>{if("function"==typeof n){try{i(n())}catch(e){s(e)}return}const r=n instanceof Error?n:new a("string"==typeof n?n:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),s(r)}),t);r(e.then(i,s),(()=>{clearTimeout(o)}))}));e.exports=i,e.exports.default=i,e.exports.TimeoutError=a},70:e=>{e.exports=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))))},364:(e,t,n)=>{e.exports=n(386)},386:(e,t,n)=>{var r=n(884);t.operation=function(e){var n=t.timeouts(e);return new r(n,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var n in e)t[n]=e[n];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],a=0;a<t.retries;a++)r.push(this.createTimeout(a,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(a,t)),r.sort((function(e,t){return e-t})),r},t.createTimeout=function(e,t){var n=t.randomize?Math.random()+1:1,r=Math.round(n*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(r,t.maxTimeout)},t.wrap=function(e,n,r){if(n instanceof Array&&(r=n,n=null),!r)for(var a in r=[],e)"function"==typeof e[a]&&r.push(a);for(var i=0;i<r.length;i++){var s=r[i],o=e[s];e[s]=function(r){var a=t.operation(n),i=Array.prototype.slice.call(arguments,1),s=i.pop();i.push((function(e){a.retry(e)||(e&&(arguments[0]=a.mainError()),s.apply(this,arguments))})),a.attempt((function(){r.apply(e,i)}))}.bind(e,o),e[s].options=n}}},884:e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(void 0===n){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1)}var r=this;return this._timer=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),n),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){n._operationTimeoutCb()}),n._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,n=0,r=0;r<this._errors.length;r++){var a=this._errors[r],i=a.message,s=(e[i]||0)+1;e[i]=s,s>=n&&(t=a,n=s)}return t}}},r={};function a(e){var t=r[e];if(void 0!==t)return t.exports;var i=r[e]={id:e,loaded:!1,exports:{}};return n[e](i,i.exports,a),i.loaded=!0,i.exports}a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.nmd=e=>(e.paths=[],e.children||(e.children=[]),e);var i={};(()=>{a.r(i),a.d(i,{R:()=>n,apis:()=>v,asnc:()=>f,dates:()=>x,fp:()=>t,get_json_from_url:()=>Kv,logger:()=>e,midi_encoder:()=>w,trading:()=>o,util:()=>h});var e={};a.r(e),a.d(e,{get_logger:()=>Ue,suppress:()=>Le,unsuppress:()=>De});var t={};a.r(t),a.d(t,{add:()=>pn,adder:()=>_n,all_false:()=>yt,all_true:()=>mt,any_false:()=>_t,any_is_array:()=>Ht,any_true:()=>gt,apply_function_dictionary_to_object:()=>An,async_apply_function_dictionary_to_object:()=>Sn,clone:()=>St,clone_array:()=>ot,concat:()=>Nt,concat_accross_index:()=>At,dict_to_list:()=>at,diff:()=>xn,divide:()=>yn,divider:()=>vn,enumerate:()=>xt,enumermap:()=>Tt,equals:()=>kn,filter:()=>Ft,filter_key:()=>zt,filter_key_equals:()=>Zt,first:()=>ct,flat_once:()=>Wt,format:()=>fn,fourth:()=>dt,get:()=>Ve,getter:()=>Ye,im_arr_rm:()=>Et,im_push:()=>Pt,indexer:()=>pt,invert_dictionary:()=>st,is_array:()=>nn,is_empty:()=>Ut,is_empty_array:()=>Dt,is_empty_map:()=>tt,is_empty_string:()=>on,is_map:()=>sn,is_null:()=>Qt,is_object:()=>an,is_something:()=>tn,is_string:()=>rn,is_undefined:()=>en,is_zero:()=>Mt,join:()=>ln,joiner:()=>dn,keys:()=>qe,last:()=>ht,len:()=>Lt,list_to_dict:()=>Xt,make_debouncer:()=>On,map:()=>wt,map_get:()=>Ct,map_indexed:()=>ze,map_items:()=>rt,map_over_dic_values:()=>it,map_prop:()=>kt,map_prop_reduce:()=>Ot,map_set:()=>Rt,map_set_im:()=>$t,merge_dictionaries:()=>Ke,merge_dictionary:()=>Je,multiplier:()=>wn,multiply:()=>gn,nchars:()=>un,not_empty:()=>Bt,nth:()=>ft,partition:()=>jt,range:()=>vt,recursive_flat:()=>Jt,recursive_flat_remove_empty:()=>Kt,remove_empty:()=>qt,repeat:()=>bt,second:()=>ut,set:()=>Ge,set_im:()=>Xe,setter:()=>Qe,setter_im:()=>et,shallow_copy:()=>Ze,sort_by_prop:()=>It,split:()=>hn,substring:()=>cn,subtract:()=>mn,subtractor:()=>bn,third:()=>lt,update_at:()=>nt,values:()=>We,values_cloned:()=>He,zip:()=>Gt,zip2:()=>Vt,zip_map:()=>Yt});var n={};a.r(n),a.d(n,{F:()=>Pn,T:()=>En,__:()=>In,add:()=>jn,addIndex:()=>j,addIndexRight:()=>Tn,adjust:()=>Cn,all:()=>Mn,allPass:()=>Bn,always:()=>Fn,and:()=>zn,andThen:()=>Sc,any:()=>qn,anyPass:()=>Wn,ap:()=>Kn,aperture:()=>Gn,append:()=>Xn,apply:()=>Yn,applySpec:()=>nr,applyTo:()=>rr,ascend:()=>ar,assoc:()=>lr,assocPath:()=>cr,binary:()=>hr,bind:()=>je,both:()=>mr,call:()=>gr,chain:()=>kr,clamp:()=>Ar,clone:()=>jr,collectBy:()=>Tr,comparator:()=>Nr,complement:()=>Rr,compose:()=>Fr,composeWith:()=>Wr,concat:()=>we,cond:()=>Jr,construct:()=>Gr,constructN:()=>Vr,converge:()=>Xr,count:()=>Yr,countBy:()=>na,curry:()=>Kr,curryN:()=>I,dec:()=>ra,defaultTo:()=>aa,descend:()=>ia,difference:()=>ua,differenceWith:()=>da,dissoc:()=>ga,dissocPath:()=>pa,divide:()=>ya,drop:()=>ba,dropLast:()=>ka,dropLastWhile:()=>Aa,dropRepeats:()=>Ta,dropRepeatsBy:()=>Ca,dropRepeatsWith:()=>ja,dropWhile:()=>Ma,either:()=>Da,empty:()=>Ua,endsWith:()=>Fa,eqBy:()=>Na,eqProps:()=>Za,equals:()=>se,evolve:()=>Ha,filter:()=>ye,find:()=>Ka,findIndex:()=>Xa,findLast:()=>Qa,findLastIndex:()=>ti,flatten:()=>ni,flip:()=>ri,forEach:()=>ii,forEachObjIndexed:()=>oi,fromPairs:()=>ci,groupBy:()=>ui,groupWith:()=>di,gt:()=>hi,gte:()=>fi,has:()=>gi,hasIn:()=>_i,hasPath:()=>pi,head:()=>zr,identical:()=>vi,identity:()=>qr,ifElse:()=>wi,inc:()=>xi,includes:()=>ki,indexBy:()=>Oi,indexOf:()=>Ai,init:()=>Si,innerJoin:()=>Pi,insert:()=>Ei,insertAll:()=>Ii,intersection:()=>$i,intersperse:()=>Mi,into:()=>Zi,invert:()=>Hi,invertObj:()=>Ji,invoker:()=>Ki,is:()=>Vi,isEmpty:()=>Gi,isNil:()=>sr,isNotNil:()=>Xi,join:()=>Yi,juxt:()=>Qi,keys:()=>V,keysIn:()=>ts,last:()=>Ea,lastIndexOf:()=>ns,length:()=>as,lens:()=>ss,lensIndex:()=>cs,lensPath:()=>ds,lensProp:()=>hs,lift:()=>pr,liftN:()=>fr,lt:()=>fs,lte:()=>ps,map:()=>X,mapAccum:()=>gs,mapAccumRight:()=>ys,mapObjIndexed:()=>bs,match:()=>ws,mathMod:()=>xs,max:()=>Ln,maxBy:()=>ks,mean:()=>As,median:()=>Ps,memoizeWith:()=>Is,mergeAll:()=>js,mergeDeepLeft:()=>Cs,mergeDeepRight:()=>Rs,mergeDeepWith:()=>$s,mergeDeepWithKey:()=>Ns,mergeLeft:()=>Ms,mergeRight:()=>Ls,mergeWith:()=>Ds,mergeWithKey:()=>Ts,min:()=>Us,minBy:()=>Bs,modify:()=>qs,modifyPath:()=>zs,modulo:()=>Hs,move:()=>Ws,multiply:()=>Js,nAry:()=>dr,negate:()=>Gs,none:()=>Xs,not:()=>Cr,nth:()=>ke,nthArg:()=>Ys,o:()=>Qs,objOf:()=>Ui,of:()=>eo,omit:()=>no,on:()=>ro,once:()=>ao,or:()=>La,otherwise:()=>so,over:()=>uo,pair:()=>lo,partial:()=>fo,partialObject:()=>Vs,partialRight:()=>po,partition:()=>mo,path:()=>ls,pathEq:()=>go,pathOr:()=>yo,pathSatisfies:()=>_o,paths:()=>us,pick:()=>bo,pickAll:()=>wo,pickBy:()=>ko,pipe:()=>Ur,pipeWith:()=>Hr,pluck:()=>Dn,prepend:()=>Oo,product:()=>Ao,project:()=>Po,promap:()=>jo,prop:()=>Oe,propEq:()=>To,propIs:()=>No,propOr:()=>Co,propSatisfies:()=>Ro,props:()=>$o,range:()=>Mo,reduce:()=>Re,reduceBy:()=>ta,reduceRight:()=>Lo,reduceWhile:()=>Do,reduced:()=>Uo,reject:()=>_e,remove:()=>ha,repeat:()=>Zo,replace:()=>Ho,reverse:()=>Br,scan:()=>Go,sequence:()=>Xo,set:()=>Qo,slice:()=>Lr,sort:()=>ec,sortBy:()=>tc,sortWith:()=>rc,split:()=>ac,splitAt:()=>sc,splitEvery:()=>oc,splitWhen:()=>uc,splitWhenever:()=>dc,startsWith:()=>hc,subtract:()=>fc,sum:()=>Os,swap:()=>mc,symmetricDifference:()=>gc,symmetricDifferenceWith:()=>yc,tail:()=>Dr,take:()=>wa,takeLast:()=>Ba,takeLastWhile:()=>_c,takeWhile:()=>wc,tap:()=>kc,test:()=>Ac,thunkify:()=>ku,times:()=>Fo,toLower:()=>Pc,toPairs:()=>Ic,toPairsIn:()=>Tc,toString:()=>ve,toUpper:()=>Nc,transduce:()=>Cc,transpose:()=>$c,traverse:()=>Mc,trim:()=>Uc,tryCatch:()=>Bc,type:()=>re,unapply:()=>Fc,unary:()=>zc,uncurryN:()=>qc,unfold:()=>Hc,union:()=>Wc,unionWith:()=>Gc,uniq:()=>Ci,uniqBy:()=>Ni,uniqWith:()=>Vc,unless:()=>Xc,unnest:()=>Yc,until:()=>Qc,unwind:()=>tu,update:()=>os,useWith:()=>So,values:()=>er,valuesIn:()=>ru,view:()=>su,when:()=>ou,where:()=>uu,whereAny:()=>du,whereEq:()=>hu,without:()=>pu,xor:()=>mu,xprod:()=>gu,zip:()=>_u,zipObj:()=>vu,zipWith:()=>xu});var r={};a.r(r),a.d(r,{MarketTradeType:()=>Ou,PortfolioBalancer:()=>Au});var s={};a.r(s),a.d(s,{BacktestBalancer:()=>Su});var o={};a.r(o),a.d(o,{backtest_balancer:()=>s,portfolio_balancer_lib:()=>r});var c={};a.r(c),a.d(c,{abs:()=>ju,flat_float32_array:()=>Ru,length:()=>Pu,mean:()=>Tu,mean_abs:()=>Nu,min_max_mean:()=>Cu,power:()=>Eu,sum:()=>Iu});var u={};a.r(u),a.d(u,{ms:()=>$u});var l={};a.r(l),a.d(l,{add:()=>Lu,db:()=>Mu,get:()=>Du,log:()=>Uu});var d={};a.r(d),a.d(d,{prepend_timestamp_as_bytes:()=>Fu,timestampToByteArray:()=>Bu});var h={};a.r(h),a.d(h,{bytes:()=>d,debug:()=>l,dsp:()=>c,is_browser:()=>zu,is_node:()=>Zu,performance:()=>u,unix_timestamp_ms:()=>qu});var f={};a.r(f),a.d(f,{status:()=>Wu,wait:()=>Vu,wait_until:()=>Ku});var p={};a.r(p),a.d(p,{ai_cds:()=>el,ask_ai:()=>Xu,clean_json_string:()=>Gu,example_patient:()=>Yu,generate_patient_data:()=>tl,generate_prompt:()=>Qu});var m={};a.r(m),a.d(m,{code:()=>nl});var g={};a.r(g),a.d(g,{build_index:()=>hl,get_medications:()=>ol,index:()=>sl,init:()=>cl,medications:()=>il,parse_ar_text:()=>ml,parse_subsection_1:()=>fl,parse_subsection_2:()=>pl,raw_medications:()=>al,search_for_medication:()=>ul,search_for_side_effect:()=>ll});var y={};a.r(y),a.d(y,{APIConnectionError:()=>$l,APIConnectionTimeoutError:()=>Ml,APIError:()=>Cl,APIUserAbortError:()=>Rl,AuthenticationError:()=>Dl,BadRequestError:()=>Ll,ConflictError:()=>Fl,InternalServerError:()=>ql,NotFoundError:()=>Bl,OpenAIError:()=>Nl,PermissionDeniedError:()=>Ul,RateLimitError:()=>Zl,UnprocessableEntityError:()=>zl});var _={};a.r(_),a.d(_,{JsonPatchError:()=>D_,_areEquals:()=>K_,applyOperation:()=>Z_,applyPatch:()=>q_,applyReducer:()=>H_,deepClone:()=>U_,getValueByPointer:()=>z_,validate:()=>J_,validator:()=>W_});var b={};a.r(b),a.d(b,{get_chat_model:()=>Tv});var v={};a.r(v),a.d(v,{OpenAI:()=>up,aidx:()=>p,langchain:()=>b,loinc:()=>m,medications:()=>g});var w={};a.r(w),a.d(w,{control_change:()=>Rv,note_off:()=>Cv,note_on:()=>Nv});var x={};function k(e,t){var n;t=t||[];var r=(e=e||[]).length,a=t.length,i=[];for(n=0;n<r;)i[i.length]=e[n],n+=1;for(n=0;n<a;)i[i.length]=t[n],n+=1;return i}function O(e){return null!=e&&"object"==typeof e&&!0===e["@@functional/placeholder"]}function A(e){return function t(n){return 0===arguments.length||O(n)?t:e.apply(this,arguments)}}function S(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,n){return t.apply(this,arguments)};case 3:return function(e,n,r){return t.apply(this,arguments)};case 4:return function(e,n,r,a){return t.apply(this,arguments)};case 5:return function(e,n,r,a,i){return t.apply(this,arguments)};case 6:return function(e,n,r,a,i,s){return t.apply(this,arguments)};case 7:return function(e,n,r,a,i,s,o){return t.apply(this,arguments)};case 8:return function(e,n,r,a,i,s,o,c){return t.apply(this,arguments)};case 9:return function(e,n,r,a,i,s,o,c,u){return t.apply(this,arguments)};case 10:return function(e,n,r,a,i,s,o,c,u,l){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}}function P(e){return function t(n,r){switch(arguments.length){case 0:return t;case 1:return O(n)?t:A((function(t){return e(n,t)}));default:return O(n)&&O(r)?t:O(n)?A((function(t){return e(t,r)})):O(r)?A((function(t){return e(n,t)})):e(n,r)}}}function E(e,t,n){return function(){for(var r=[],a=0,i=e,s=0,o=!1;s<t.length||a<arguments.length;){var c;s<t.length&&(!O(t[s])||a>=arguments.length)?c=t[s]:(c=arguments[a],a+=1),r[s]=c,O(c)?o=!0:i-=1,s+=1}return!o&&i<=0?n.apply(this,r):S(Math.max(0,i),E(e,r,n))}}a.r(x),a.d(x,{copy_date:()=>zv,dates_eq:()=>Fv,day_string:()=>Zv,iso_day_filename:()=>Dv,iso_now:()=>Mv,ms_now:()=>Bv,round_date:()=>qv,shift_date:()=>Hv,times_in_ms:()=>Wv,to_iso:()=>$v,to_iso_day_filename:()=>Lv,to_ms:()=>Uv});const I=P((function(e,t){return 1===e?A(t):S(e,E(e,[],t))})),j=A((function(e){return I(e.length,(function(){var t=0,n=arguments[0],r=arguments[arguments.length-1],a=Array.prototype.slice.call(arguments,0);return a[0]=function(){var e=n.apply(this,k(arguments,[t,r]));return t+=1,e},e.apply(this,a)}))}));function T(e,t,n){for(var r=0,a=n.length;r<a;)t=e(t,n[r]),r+=1;return t}const N=Array.isArray||function(e){return null!=e&&e.length>=0&&"[object Array]"===Object.prototype.toString.call(e)};function C(e){return null!=e&&"function"==typeof e["@@transducer/step"]}function $(e,t,n){return function(){if(0===arguments.length)return n();var r=arguments[arguments.length-1];if(!N(r)){for(var a=0;a<e.length;){if("function"==typeof r[e[a]])return r[e[a]].apply(r,Array.prototype.slice.call(arguments,0,-1));a+=1}if(C(r))return t.apply(null,Array.prototype.slice.call(arguments,0,-1))(r)}return n.apply(this,arguments)}}function M(e,t){for(var n=0,r=t.length,a=Array(r);n<r;)a[n]=e(t[n]),n+=1;return a}const L=function(){return this.xf["@@transducer/init"]()},D=function(e){return this.xf["@@transducer/result"](e)};var U=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=D,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},e}();const B=function(e){return function(t){return new U(e,t)}};function F(e,t){return Object.prototype.hasOwnProperty.call(t,e)}var z=Object.prototype.toString;const Z=function(){return"[object Arguments]"===z.call(arguments)?function(e){return"[object Arguments]"===z.call(e)}:function(e){return F("callee",e)}}();var q=!{toString:null}.propertyIsEnumerable("toString"),H=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],W=function(){return arguments.propertyIsEnumerable("length")}(),J=function(e,t){for(var n=0;n<e.length;){if(e[n]===t)return!0;n+=1}return!1},K="function"!=typeof Object.keys||W?A((function(e){if(Object(e)!==e)return[];var t,n,r=[],a=W&&Z(e);for(t in e)!F(t,e)||a&&"length"===t||(r[r.length]=t);if(q)for(n=H.length-1;n>=0;)F(t=H[n],e)&&!J(r,t)&&(r[r.length]=t),n-=1;return r})):A((function(e){return Object(e)!==e?[]:Object.keys(e)}));const V=K;var G=P($(["fantasy-land/map","map"],B,(function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return I(t.length,(function(){return e.call(this,t.apply(this,arguments))}));case"[object Object]":return T((function(n,r){return n[r]=e(t[r]),n}),{},V(t));default:return M(e,t)}})));const X=G;function Y(e){var t=Object.prototype.toString.call(e);return"[object Function]"===t||"[object AsyncFunction]"===t||"[object GeneratorFunction]"===t||"[object AsyncGeneratorFunction]"===t}function Q(e){return"[object String]"===Object.prototype.toString.call(e)}function ee(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n}function te(e,t,n){for(var r=0,a=n.length;r<a;){if(e(t,n[r]))return!0;r+=1}return!1}const ne="function"==typeof Object.is?Object.is:function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t},re=A((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)}));function ae(e,t,n,r){var a=ee(e);function i(e,t){return ie(e,t,n.slice(),r.slice())}return!te((function(e,t){return!te(i,t,e)}),ee(t),a)}function ie(e,t,n,r){if(ne(e,t))return!0;var a=re(e);if(a!==re(t))return!1;if("function"==typeof e["fantasy-land/equals"]||"function"==typeof t["fantasy-land/equals"])return"function"==typeof e["fantasy-land/equals"]&&e["fantasy-land/equals"](t)&&"function"==typeof t["fantasy-land/equals"]&&t["fantasy-land/equals"](e);if("function"==typeof e.equals||"function"==typeof t.equals)return"function"==typeof e.equals&&e.equals(t)&&"function"==typeof t.equals&&t.equals(e);switch(a){case"Arguments":case"Array":case"Object":if("function"==typeof e.constructor&&"Promise"===function(e){var t=String(e).match(/^function (\w*)/);return null==t?"":t[1]}(e.constructor))return e===t;break;case"Boolean":case"Number":case"String":if(typeof e!=typeof t||!ne(e.valueOf(),t.valueOf()))return!1;break;case"Date":if(!ne(e.valueOf(),t.valueOf()))return!1;break;case"Error":return e.name===t.name&&e.message===t.message;case"RegExp":if(e.source!==t.source||e.global!==t.global||e.ignoreCase!==t.ignoreCase||e.multiline!==t.multiline||e.sticky!==t.sticky||e.unicode!==t.unicode)return!1}for(var i=n.length-1;i>=0;){if(n[i]===e)return r[i]===t;i-=1}switch(a){case"Map":return e.size===t.size&&ae(e.entries(),t.entries(),n.concat([e]),r.concat([t]));case"Set":return e.size===t.size&&ae(e.values(),t.values(),n.concat([e]),r.concat([t]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var s=V(e);if(s.length!==V(t).length)return!1;var o=n.concat([e]),c=r.concat([t]);for(i=s.length-1;i>=0;){var u=s[i];if(!F(u,t)||!ie(t[u],e[u],o,c))return!1;i-=1}return!0}const se=P((function(e,t){return ie(e,t,[],[])}));function oe(e,t,n){var r,a;if("function"==typeof e.indexOf)switch(typeof t){case"number":if(0===t){for(r=1/t;n<e.length;){if(0===(a=e[n])&&1/a===r)return n;n+=1}return-1}if(t!=t){for(;n<e.length;){if("number"==typeof(a=e[n])&&a!=a)return n;n+=1}return-1}return e.indexOf(t,n);case"string":case"boolean":case"function":case"undefined":return e.indexOf(t,n);case"object":if(null===t)return e.indexOf(t,n)}for(;n<e.length;){if(se(e[n],t))return n;n+=1}return-1}function ce(e,t){return oe(t,e,0)>=0}function ue(e){return'"'+e.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0").replace(/"/g,'\\"')+'"'}var le=function(e){return(e<10?"0":"")+e};const de="function"==typeof Date.prototype.toISOString?function(e){return e.toISOString()}:function(e){return e.getUTCFullYear()+"-"+le(e.getUTCMonth()+1)+"-"+le(e.getUTCDate())+"T"+le(e.getUTCHours())+":"+le(e.getUTCMinutes())+":"+le(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"};function he(e){return function(){return!e.apply(this,arguments)}}function fe(e,t){for(var n=0,r=t.length,a=[];n<r;)e(t[n])&&(a[a.length]=t[n]),n+=1;return a}function pe(e){return"[object Object]"===Object.prototype.toString.call(e)}var me=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=D,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):e},e}(),ge=P($(["fantasy-land/filter","filter"],(function(e){return function(t){return new me(e,t)}}),(function(e,t){return pe(t)?T((function(n,r){return e(t[r])&&(n[r]=t[r]),n}),{},V(t)):fe(e,t)})));const ye=ge,_e=P((function(e,t){return ye(he(e),t)}));function be(e,t){var n=function(n){var r=t.concat([e]);return ce(n,r)?"<Circular>":be(n,r)},r=function(e,t){return M((function(t){return ue(t)+": "+n(e[t])}),t.slice().sort())};switch(Object.prototype.toString.call(e)){case"[object Arguments]":return"(function() { return arguments; }("+M(n,e).join(", ")+"))";case"[object Array]":return"["+M(n,e).concat(r(e,_e((function(e){return/^\d+$/.test(e)}),V(e)))).join(", ")+"]";case"[object Boolean]":return"object"==typeof e?"new Boolean("+n(e.valueOf())+")":e.toString();case"[object Date]":return"new Date("+(isNaN(e.valueOf())?n(NaN):ue(de(e)))+")";case"[object Map]":return"new Map("+n(Array.from(e))+")";case"[object Null]":return"null";case"[object Number]":return"object"==typeof e?"new Number("+n(e.valueOf())+")":1/e==-1/0?"-0":e.toString(10);case"[object Set]":return"new Set("+n(Array.from(e).sort())+")";case"[object String]":return"object"==typeof e?"new String("+n(e.valueOf())+")":ue(e);case"[object Undefined]":return"undefined";default:if("function"==typeof e.toString){var a=e.toString();if("[object Object]"!==a)return a}return"{"+r(e,V(e)).join(", ")+"}"}}const ve=A((function(e){return be(e,[])})),we=P((function(e,t){if(N(e)){if(N(t))return e.concat(t);throw new TypeError(ve(t)+" is not an array")}if(Q(e)){if(Q(t))return e+t;throw new TypeError(ve(t)+" is not a string")}if(null!=e&&Y(e["fantasy-land/concat"]))return e["fantasy-land/concat"](t);if(null!=e&&Y(e.concat))return e.concat(t);throw new TypeError(ve(e)+' does not have a method named "concat" or "fantasy-land/concat"')})),xe=Number.isInteger||function(e){return(0|e)===e},ke=P((function(e,t){var n=e<0?t.length+e:e;return Q(t)?t.charAt(n):t[n]})),Oe=P((function(e,t){if(null!=t)return xe(e)?ke(e,t):t[e]}));function Ae(e){return function t(n,r,a){switch(arguments.length){case 0:return t;case 1:return O(n)?t:P((function(t,r){return e(n,t,r)}));case 2:return O(n)&&O(r)?t:O(n)?P((function(t,n){return e(t,r,n)})):O(r)?P((function(t,r){return e(n,t,r)})):A((function(t){return e(n,r,t)}));default:return O(n)&&O(r)&&O(a)?t:O(n)&&O(r)?P((function(t,n){return e(t,n,a)})):O(n)&&O(a)?P((function(t,n){return e(t,r,n)})):O(r)&&O(a)?P((function(t,r){return e(n,t,r)})):O(n)?A((function(t){return e(t,r,a)})):O(r)?A((function(t){return e(n,t,a)})):O(a)?A((function(t){return e(n,r,t)})):e(n,r,a)}}}const Se=A((function(e){return!!N(e)||!!e&&"object"==typeof e&&!Q(e)&&(0===e.length||e.length>0&&e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1))}));var Pe="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";function Ee(e,t,n){return function(r,a,i){if(Se(i))return e(r,a,i);if(null==i)return a;if("function"==typeof i["fantasy-land/reduce"])return t(r,a,i,"fantasy-land/reduce");if(null!=i[Pe])return n(r,a,i[Pe]());if("function"==typeof i.next)return n(r,a,i);if("function"==typeof i.reduce)return t(r,a,i,"reduce");throw new TypeError("reduce: list must be array or iterable")}}function Ie(e,t,n){for(var r=0,a=n.length;r<a;){if((t=e["@@transducer/step"](t,n[r]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r+=1}return e["@@transducer/result"](t)}const je=P((function(e,t){return S(e.length,(function(){return e.apply(t,arguments)}))})),Te=Ee(Ie,(function(e,t,n,r){return e["@@transducer/result"](n[r](je(e["@@transducer/step"],e),t))}),(function(e,t,n){for(var r=n.next();!r.done;){if((t=e["@@transducer/step"](t,r.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r=n.next()}return e["@@transducer/result"](t)}));var Ne=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},e}();function Ce(e){return new Ne(e)}const Re=Ae((function(e,t,n){return Te("function"==typeof e?Ce(e):e,t,n)})),$e=Ue({id:"log"});var Me={};function Le(e,t){Me[e]=!0,$e(`Suppressing ${e}, reason=${t||"none_given"}`)}function De(e){Me[e]=!1,$e(`Unsuppressing ${e}`)}function Ue(e){let{id:t}=e;return function(e){Me[t]||("[object Object]"==e.toString()?(console.log(`[${t}]:: > `),console.log(e)):console.log(`[${t}]:: ${e}`))}}const Be=Ue({id:"fp"}),Fe=j(X);function ze(e,t){return Fe(((t,n)=>e(n,t)),t)}function Ze(e){return nn(e)?ot(e):sn(e)?St(e):e}function qe(e){return Object.keys(e)}function He(e){let t=qe(e),n=St(e);return Ut(t)?[]:wt(t,(e=>n[e]))}function We(e){let t=qe(e);return Ut(t)?[]:wt(t,(t=>e[t]))}function Je(e,t){return Object.assign(St(e),t)}function Ke(e){return e.reduce(Je,{})}function Ve(e,t){return e[t]}function Ge(e,t,n){return e[t]=n,e}function Xe(e,t,n){let r=St(e);return r[t]=n,r}function Ye(e){return function(t){return t[e]}}function Qe(e,t){return function(n){return Ge(n,e,t)}}function et(e,t){return function(n){return Ge(n,e,t)}}function tt(e){return sn(e)&&Mt(Lt(qe(e)))}function nt(e,t,n){for(var r=e,a=0;a<t.length-1;a++)r=r[a];let i=ht(t);return r[i]=n(r[i]),St(e)}function rt(e){return Vt(qe(e),We(e))}var at=rt;function it(e,t){let n=wt(We(e),t);return Yt(qe(e),n)}function st(e,t=[]){let n=V(e),r=[];for(var a of n){let n=e[a];if(sn(n))st(n,we(t,[a])).map((e=>r.push(e)));else{let e=we(t,[a]);r.push({value:n,path:e})}}return r}function ot(e){return JSON.parse(JSON.stringify(e))}function ct(e){return e[0]}function ut(e){return e[1]}function lt(e){return e[2]}function dt(e){return e[3]}function ht(e){return e[e.length-1]}function ft(e,t){return e[t]}function pt(e){return function(t){return ft(t,e)}}function mt(e){return e.reduce(((e,t)=>e&&t))}function gt(e){return!Ut(e)&&e.reduce(((e,t)=>e||t))}function yt(e){return!gt(e)}function _t(e){return!mt(e)}function bt(e,t){let n=[];for(var r of vt(t))n.push(Ze(e));return n}function vt(e,t=null){if(t){for(var n=Array(t-e).fill(0),r=0;r<n.length;r++)n[r]=r+e;return n}for(n=Array(e).fill(0),r=0;r<n.length;r++)n[r]=r;return n}function wt(e,t){return e.map(t)}function xt(e){return ze(((e,t)=>[e,t]),e)}function kt(e,t){return X(Oe(e))(t)}function Ot(e,t,n,r){return Re(t,n,kt(e,r))}function At(e){let t=[],n=e[0].length,r=e.length;for(var a=0;a<n;a++){for(var i=new Array,s=0;s<r;s++)i.push(e[s][a]);t.push(i)}return t}function St(e){return JSON.parse(JSON.stringify(e))}function Pt(e,t){let n=St(e);return n.push(t),n}function Et(e,t){return St(e).filter((e=>!(e==t)))}function It(e){var t=1;return"-"===e[0]&&(t=-1,e=e.substr(1)),function(n,r){return(n[e]<r[e]?-1:n[e]>r[e]?1:0)*t}}function jt(e,t){let n=Math.ceil(e.length/t),r=Array(n).fill(null).map((e=>new Array)),a=0;for(var i=0;i<e.length;i++)i%t==0&&0!=i&&(a+=1),r[a].push(e[i]);return r}function Tt(e,t){let n=[];for(var[r,a]of xt(e))n.push(t(r,a));return n}function Nt(e,t){return e.concat(t)}function Ct(e,t){return wt(e,Ye(t))}function Rt(e,t,n){return wt(e,Qe(t,n))}function $t(e,t,n){return wt(e,et(t,n))}function Mt(e){return 0==e}function Lt(e){return e.length}function Dt(e){return nn(e)&&Mt(Lt(e))}function Ut(e){return Qt(e)||en(e)||Dt(e)||on(e)||tt(e)}function Bt(e){return!Ut(e)}function Ft(e,t){return e.filter(t)}function zt(e,t,n){return Ft(e,(e=>n(Ve(e,t))))}function Zt(e,t,n){return zt(e,t,(e=>e==n))}function qt(e){return Ft(e,Bt)}function Ht(e){return gt(wt(e,nn))}function Wt(e){return e.flat()}function Jt(e){return Ht(e)?Jt(Wt(e)):e}function Kt(e){return qt(Jt(e))}function Vt(e,t){let n=[];for(var r=0;r<e.length;r++)n.push([e[r],t[r]]);return n}var Gt=Vt;function Xt(e){let t={};for(var[n,r]of e)t[n]=r;return t}function Yt(e,t){return Xt(Gt(e,t))}function Qt(e){return null==e}function en(e){return null==e}function tn(e){return!(Qt(e)||en(e))}function nn(e){return tn(e)&&e.constructor==Array}function rn(e){return tn(e)&&e.constructor==String}function an(e){return tn(e)&&e.constructor==Object}function sn(e){return tn(e)&&an(e)&&!nn(e)}function on(e){return""==e}function cn(e,t,n){return e.substring(t,n)}function un(e,t){return cn(e,0,t)}function ln(e,t){return e.join(t)}function dn(e){return function(t){return ln(t,e)}}function hn(e,t){return e.split(t)}function fn(e,t){let n=ot(t),r=n.shift(),a=e;for(;r;)a=a.replace("{}",String(r)),r=n.shift();return a}function pn(e,t){return e+t}function mn(e,t){return e-t}function gn(e,t){return e*t}function yn(e,t){return e/t}function _n(e){return function(t){return t+e}}function bn(e){return function(t){return t-e}}function vn(e){return function(t){return t/e}}function wn(e){return function(t){return t*e}}function xn(e){let t=[];for(var n=1;n<e.length;n++)t.push(e[n]-e[n-1]);return t}function kn(e,t){return e==t}function On(e,t){var n={attempt_ref:null};return r=>{n.attempt_ref&&clearTimeout(n.attempt_ref),n.attempt_ref=setTimeout((function(){t(r)}),e)}}function An(e,t){let n={},r=[];return V(e).map((a=>{try{n[a]=e[a](t)}catch(e){r.push(e),n[a]=null}})),r.length&&(Be("Error while applying function to dictionary"),Be(r),Be(n)),n}async function Sn(e,t){let n={},r=[],a=V(e).map((async a=>{try{n[a]=await e[a](t)}catch(e){r.push(e),n[a]=null}}));return await Promise.all(a),r.length&&(Be("Error while applying function to dictionary"),Be(r),Be(n)),n}const Pn=function(){return!1},En=function(){return!0},In={"@@functional/placeholder":!0},jn=P((function(e,t){return Number(e)+Number(t)})),Tn=A((function(e){return I(e.length,(function(){var t=arguments[0],n=arguments[arguments.length-1],r=n.length-1,a=Array.prototype.slice.call(arguments,0);return a[0]=function(){var e=t.apply(this,k(arguments,[r,n]));return r-=1,e},e.apply(this,a)}))}));var Nn=Ae((function(e,t,n){var r=n.length;if(e>=r||e<-r)return n;var a=(r+e)%r,i=k(n);return i[a]=t(n[a]),i}));const Cn=Nn;function Rn(e){return e&&e["@@transducer/reduced"]?e:{"@@transducer/value":e,"@@transducer/reduced":!0}}var $n=function(){function e(e,t){this.xf=t,this.f=e,this.all=!0}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=function(e){return this.all&&(e=this.xf["@@transducer/step"](e,!0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)||(this.all=!1,e=Rn(this.xf["@@transducer/step"](e,!1))),e},e}();const Mn=P($(["all"],(function(e){return function(t){return new $n(e,t)}}),(function(e,t){for(var n=0;n<t.length;){if(!e(t[n]))return!1;n+=1}return!0}))),Ln=P((function(e,t){if(e===t)return t;function n(e,t){if(e>t!=t>e)return t>e?t:e}var r=n(e,t);if(void 0!==r)return r;var a=n(typeof e,typeof t);if(void 0!==a)return a===typeof e?e:t;var i=ve(e),s=n(i,ve(t));return void 0!==s&&s===i?e:t})),Dn=P((function(e,t){return X(Oe(e),t)}));var Un=A((function(e){return I(Re(Ln,0,Dn("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(!e[t].apply(this,arguments))return!1;t+=1}return!0}))}));const Bn=Un,Fn=A((function(e){return function(){return e}})),zn=P((function(e,t){return e&&t}));var Zn=function(){function e(e,t){this.xf=t,this.f=e,this.any=!1}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=function(e){return this.any||(e=this.xf["@@transducer/step"](e,!1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.any=!0,e=Rn(this.xf["@@transducer/step"](e,!0))),e},e}();const qn=P($(["any"],(function(e){return function(t){return new Zn(e,t)}}),(function(e,t){for(var n=0;n<t.length;){if(e(t[n]))return!0;n+=1}return!1})));var Hn=A((function(e){return I(Re(Ln,0,Dn("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(e[t].apply(this,arguments))return!0;t+=1}return!1}))}));const Wn=Hn,Jn=Ee(T,(function(e,t,n,r){return n[r](e,t)}),(function(e,t,n){for(var r=n.next();!r.done;)t=e(t,r.value),r=n.next();return t})),Kn=P((function(e,t){return"function"==typeof t["fantasy-land/ap"]?t["fantasy-land/ap"](e):"function"==typeof e.ap?e.ap(t):"function"==typeof e?function(n){return e(n)(t(n))}:Jn((function(e,n){return k(e,X(n,t))}),[],e)}));var Vn=function(){function e(e,t){this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.store(t),this.full?this.xf["@@transducer/step"](e,this.getCopy()):e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},e.prototype.getCopy=function(){return k(Array.prototype.slice.call(this.acc,this.pos),Array.prototype.slice.call(this.acc,0,this.pos))},e}();const Gn=P($([],(function(e){return function(t){return new Vn(e,t)}}),(function(e,t){for(var n=0,r=t.length-(e-1),a=new Array(r>=0?r:0);n<r;)a[n]=Array.prototype.slice.call(t,n,n+e),n+=1;return a}))),Xn=P((function(e,t){return k(t,[e])})),Yn=P((function(e,t){return e.apply(this,t)}));var Qn=A((function(e){for(var t=V(e),n=t.length,r=[],a=0;a<n;)r[a]=e[t[a]],a+=1;return r}));const er=Qn;function tr(e,t){return N(t)?t.map(e):V(t).reduce((function(n,r){return n[r]=e(t[r]),n}),{})}const nr=A((function e(t){return t=tr((function(t){return"function"==typeof t?t:e(t)}),t),I(Re(Ln,0,Dn("length",er(t))),(function(){var e=arguments;return tr((function(t){return Yn(t,e)}),t)}))})),rr=P((function(e,t){return t(e)})),ar=Ae((function(e,t,n){var r=e(t),a=e(n);return r<a?-1:r>a?1:0}));function ir(e,t,n){if(xe(e)&&N(n)){var r=[].concat(n);return r[e]=t,r}var a={};for(var i in n)a[i]=n[i];return a[e]=t,a}const sr=A((function(e){return null==e}));var or=Ae((function e(t,n,r){if(0===t.length)return n;var a=t[0];if(t.length>1){var i=!sr(r)&&F(a,r)&&"object"==typeof r[a]?r[a]:xe(t[1])?[]:{};n=e(Array.prototype.slice.call(t,1),n,i)}return ir(a,n,r)}));const cr=or;var ur=Ae((function(e,t,n){return cr([e],t,n)}));const lr=ur,dr=P((function(e,t){switch(e){case 0:return function(){return t.call(this)};case 1:return function(e){return t.call(this,e)};case 2:return function(e,n){return t.call(this,e,n)};case 3:return function(e,n,r){return t.call(this,e,n,r)};case 4:return function(e,n,r,a){return t.call(this,e,n,r,a)};case 5:return function(e,n,r,a,i){return t.call(this,e,n,r,a,i)};case 6:return function(e,n,r,a,i,s){return t.call(this,e,n,r,a,i,s)};case 7:return function(e,n,r,a,i,s,o){return t.call(this,e,n,r,a,i,s,o)};case 8:return function(e,n,r,a,i,s,o,c){return t.call(this,e,n,r,a,i,s,o,c)};case 9:return function(e,n,r,a,i,s,o,c,u){return t.call(this,e,n,r,a,i,s,o,c,u)};case 10:return function(e,n,r,a,i,s,o,c,u,l){return t.call(this,e,n,r,a,i,s,o,c,u,l)};default:throw new Error("First argument to nAry must be a non-negative integer no greater than ten")}})),hr=A((function(e){return dr(2,e)})),fr=P((function(e,t){var n=I(e,t);return I(e,(function(){return T(Kn,X(n,arguments[0]),Array.prototype.slice.call(arguments,1))}))})),pr=A((function(e){return fr(e.length,e)})),mr=P((function(e,t){return Y(e)?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:pr(zn)(e,t)})),gr=A((function(e){return e.apply(this,Array.prototype.slice.call(arguments,1))}));function yr(e){return function t(n){for(var r,a,i,s=[],o=0,c=n.length;o<c;){if(Se(n[o]))for(i=0,a=(r=e?t(n[o]):n[o]).length;i<a;)s[s.length]=r[i],i+=1;else s[s.length]=n[o];o+=1}return s}}var _r="@@transducer/init",br="@@transducer/step",vr="@@transducer/result",wr=function(){function e(e){this.xf=e}return e.prototype[_r]=L,e.prototype[vr]=D,e.prototype[br]=function(e,t){var n=this.xf[br](e,t);return n["@@transducer/reduced"]?{"@@transducer/value":n,"@@transducer/reduced":!0}:n},e}(),xr=function(){function e(e){this.xf=new wr(e)}return e.prototype[_r]=L,e.prototype[vr]=D,e.prototype[br]=function(e,t){return Se(t)?Te(this.xf,e,t):Ie(this.xf,e,[t])},e}();const kr=P($(["fantasy-land/chain","chain"],(function(e){return function(t){return B(e)(function(e){return new xr(e)}(t))}}),(function(e,t){return"function"==typeof t?function(n){return e(t(n))(n)}:yr(!1)(X(e,t))})));var Or=Ae((function(e,t,n){if(e>t)throw new Error("min must not be greater than max in clamp(min, max, value)");return n<e?e:n>t?t:n}));const Ar=Or;function Sr(e){return new RegExp(e.source,e.flags?e.flags:(e.global?"g":"")+(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.sticky?"y":"")+(e.unicode?"u":"")+(e.dotAll?"s":""))}function Pr(e,t,n){if(n||(n=new Er),a=typeof(r=e),null==r||"object"!=a&&"function"!=a)return e;var r,a,i=function(r){var a=n.get(e);if(a)return a;for(var i in n.set(e,r),e)Object.prototype.hasOwnProperty.call(e,i)&&(r[i]=t?Pr(e[i],!0,n):e[i]);return r};switch(re(e)){case"Object":return i(Object.create(Object.getPrototypeOf(e)));case"Array":return i([]);case"Date":return new Date(e.valueOf());case"RegExp":return Sr(e);case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":return e.slice();default:return e}}var Er=function(){function e(){this.map={},this.length=0}return e.prototype.set=function(e,t){const n=this.hash(e);let r=this.map[n];r||(this.map[n]=r=[]),r.push([e,t]),this.length+=1},e.prototype.hash=function(e){let t=[];for(var n in e)t.push(Object.prototype.toString.call(e[n]));return t.join()},e.prototype.get=function(e){if(this.length<=180){for(const t in this.map){const n=this.map[t];for(let t=0;t<n.length;t+=1){const r=n[t];if(r[0]===e)return r[1]}}return}const t=this.hash(e),n=this.map[t];if(n)for(let t=0;t<n.length;t+=1){const r=n[t];if(r[0]===e)return r[1]}},e}(),Ir=A((function(e){return null!=e&&"function"==typeof e.clone?e.clone():Pr(e,!0)}));const jr=Ir,Tr=P((function(e,t){var n=Jn((function(t,n){var r=e(n);return void 0===t[r]&&(t[r]=[]),t[r].push(n),t}),{},t),r=[];for(var a in n)r.push(n[a]);return r})),Nr=A((function(e){return function(t,n){return e(t,n)?-1:e(n,t)?1:0}})),Cr=A((function(e){return!e})),Rr=pr(Cr);function $r(e,t){return function(){return t.call(this,e.apply(this,arguments))}}function Mr(e,t){return function(){var n=arguments.length;if(0===n)return t();var r=arguments[n-1];return N(r)||"function"!=typeof r[e]?t.apply(this,arguments):r[e].apply(r,Array.prototype.slice.call(arguments,0,n-1))}}const Lr=Ae(Mr("slice",(function(e,t,n){return Array.prototype.slice.call(n,e,t)}))),Dr=A(Mr("tail",Lr(1,1/0)));function Ur(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return S(arguments[0].length,Re($r,arguments[0],Dr(arguments)))}const Br=A((function(e){return Q(e)?e.split("").reverse().join(""):Array.prototype.slice.call(e,0).reverse()}));function Fr(){if(0===arguments.length)throw new Error("compose requires at least one argument");return Ur.apply(this,Br(arguments))}const zr=ke(0);function Zr(e){return e}const qr=A(Zr),Hr=P((function(e,t){if(t.length<=0)return qr;var n=zr(t),r=Dr(t);return S(n.length,(function(){return Jn((function(t,n){return e.call(this,n,t)}),n.apply(this,arguments),r)}))})),Wr=P((function(e,t){return Hr.apply(this,[e,Br(t)])})),Jr=A((function(e){return S(Re(Ln,0,X((function(e){return e[0].length}),e)),(function(){for(var t=0;t<e.length;){if(e[t][0].apply(this,arguments))return e[t][1].apply(this,arguments);t+=1}}))})),Kr=A((function(e){return I(e.length,e)})),Vr=P((function(e,t){if(e>10)throw new Error("Constructor with greater than ten arguments");return 0===e?function(){return new t}:Kr(dr(e,(function(n,r,a,i,s,o,c,u,l,d){switch(e){case 1:return new t(n);case 2:return new t(n,r);case 3:return new t(n,r,a);case 4:return new t(n,r,a,i);case 5:return new t(n,r,a,i,s);case 6:return new t(n,r,a,i,s,o);case 7:return new t(n,r,a,i,s,o,c);case 8:return new t(n,r,a,i,s,o,c,u);case 9:return new t(n,r,a,i,s,o,c,u,l);case 10:return new t(n,r,a,i,s,o,c,u,l,d)}})))})),Gr=A((function(e){return Vr(e.length,e)})),Xr=P((function(e,t){return I(Re(Ln,0,Dn("length",t)),(function(){var n=arguments,r=this;return e.apply(r,M((function(e){return e.apply(r,n)}),t))}))})),Yr=Kr((function(e,t){return Jn((function(t,n){return e(n)?t+1:t}),0,t)}));var Qr=function(){function e(e,t,n,r){this.valueFn=e,this.valueAcc=t,this.keyFn=n,this.xf=r,this.inputs={}}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=function(e){var t;for(t in this.inputs)if(F(t,this.inputs)&&(e=this.xf["@@transducer/step"](e,this.inputs[t]))["@@transducer/reduced"]){e=e["@@transducer/value"];break}return this.inputs=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){var n=this.keyFn(t);return this.inputs[n]=this.inputs[n]||[n,Pr(this.valueAcc,!1)],this.inputs[n][1]=this.valueFn(this.inputs[n][1],t),e},e}(),ea=E(4,[],$([],(function(e,t,n){return function(r){return new Qr(e,t,n,r)}}),(function(e,t,n,r){var a=Ce((function(r,a){var i=n(a),s=e(F(i,r)?r[i]:Pr(t,!1),a);return s&&s["@@transducer/reduced"]?Rn(r):(r[i]=s,r)}));return Te(a,{},r)})));const ta=ea,na=ta((function(e,t){return e+1}),0),ra=jn(-1),aa=P((function(e,t){return null==t||t!=t?e:t})),ia=Ae((function(e,t,n){var r=e(t),a=e(n);return r>a?-1:r<a?1:0}));function sa(e,t,n){var r,a=typeof e;switch(a){case"string":case"number":return 0===e&&1/e==-1/0?!!n._items["-0"]||(t&&(n._items["-0"]=!0),!1):null!==n._nativeSet?t?(r=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===r):n._nativeSet.has(e):a in n._items?e in n._items[a]||(t&&(n._items[a][e]=!0),!1):(t&&(n._items[a]={},n._items[a][e]=!0),!1);case"boolean":if(a in n._items){var i=e?1:0;return!!n._items[a][i]||(t&&(n._items[a][i]=!0),!1)}return t&&(n._items[a]=e?[!1,!0]:[!0,!1]),!1;case"function":return null!==n._nativeSet?t?(r=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===r):n._nativeSet.has(e):a in n._items?!!ce(e,n._items[a])||(t&&n._items[a].push(e),!1):(t&&(n._items[a]=[e]),!1);case"undefined":return!!n._items[a]||(t&&(n._items[a]=!0),!1);case"object":if(null===e)return!!n._items.null||(t&&(n._items.null=!0),!1);default:return(a=Object.prototype.toString.call(e))in n._items?!!ce(e,n._items[a])||(t&&n._items[a].push(e),!1):(t&&(n._items[a]=[e]),!1)}}const oa=function(){function e(){this._nativeSet="function"==typeof Set?new Set:null,this._items={}}return e.prototype.add=function(e){return!sa(e,!0,this)},e.prototype.has=function(e){return sa(e,!1,this)},e}();var ca=P((function(e,t){for(var n=[],r=0,a=e.length,i=t.length,s=new oa,o=0;o<i;o+=1)s.add(t[o]);for(;r<a;)s.add(e[r])&&(n[n.length]=e[r]),r+=1;return n}));const ua=ca;var la=Ae((function(e,t,n){for(var r=[],a=0,i=t.length;a<i;)te(e,t[a],n)||te(e,t[a],r)||r.push(t[a]),a+=1;return r}));const da=la,ha=Ae((function(e,t,n){var r=Array.prototype.slice.call(n,0);return r.splice(e,t),r}));var fa=P((function e(t,n){if(null==n)return n;switch(t.length){case 0:return n;case 1:return function(e,t){if(null==t)return t;if(xe(e)&&N(t))return ha(e,1,t);var n={};for(var r in t)n[r]=t[r];return delete n[e],n}(t[0],n);default:var r=t[0],a=Array.prototype.slice.call(t,1);return null==n[r]?function(e,t){if(xe(e)&&N(t))return[].concat(t);var n={};for(var r in t)n[r]=t[r];return n}(r,n):lr(r,e(a,n[r]),n)}}));const pa=fa;var ma=P((function(e,t){return pa([e],t)}));const ga=ma,ya=P((function(e,t){return e/t}));var _a=function(){function e(e,t){this.xf=t,this.n=e}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=D,e.prototype["@@transducer/step"]=function(e,t){return this.n>0?(this.n-=1,e):this.xf["@@transducer/step"](e,t)},e}();const ba=P($(["drop"],(function(e){return function(t){return new _a(e,t)}}),(function(e,t){return Lr(Math.max(0,e),1/0,t)})));var va=function(){function e(e,t){this.xf=t,this.n=e,this.i=0}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=D,e.prototype["@@transducer/step"]=function(e,t){this.i+=1;var n=0===this.n?e:this.xf["@@transducer/step"](e,t);return this.n>=0&&this.i>=this.n?Rn(n):n},e}();const wa=P($(["take"],(function(e){return function(t){return new va(e,t)}}),(function(e,t){return Lr(0,e<0?1/0:e,t)})));var xa=function(){function e(e,t){if(e<=0)return t;this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.full&&(e=this.xf["@@transducer/step"](e,this.acc[this.pos])),this.store(t),e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},e}();const ka=P($([],(function(e){return function(t){return new xa(e,t)}}),(function(e,t){return wa(e<t.length?t.length-e:0,t)})));var Oa=function(){function e(e,t){this.f=e,this.retained=[],this.xf=t}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=function(e){return this.retained=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.retain(e,t):this.flush(e,t)},e.prototype.flush=function(e,t){return e=Te(this.xf,e,this.retained),this.retained=[],this.xf["@@transducer/step"](e,t)},e.prototype.retain=function(e,t){return this.retained.push(t),e},e}();const Aa=P($([],(function(e){return function(t){return new Oa(e,t)}}),(function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return Lr(0,n+1,t)})));var Sa=function(){function e(e,t){this.xf=t,this.pred=e,this.lastValue=void 0,this.seenFirstValue=!1}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=D,e.prototype["@@transducer/step"]=function(e,t){var n=!1;return this.seenFirstValue?this.pred(this.lastValue,t)&&(n=!0):this.seenFirstValue=!0,this.lastValue=t,n?e:this.xf["@@transducer/step"](e,t)},e}();function Pa(e){return function(t){return new Sa(e,t)}}const Ea=ke(-1);var Ia=P($([],Pa,(function(e,t){var n=[],r=1,a=t.length;if(0!==a)for(n[0]=t[0];r<a;)e(Ea(n),t[r])||(n[n.length]=t[r]),r+=1;return n})));const ja=Ia,Ta=A($([],(function(){return Pa(se)}),ja(se))),Na=Ae((function(e,t,n){return se(e(t),e(n))})),Ca=P((function(e,t){return $([],(function(){return Pa(Na(e))}),ja(Na(e)))(t)}));var Ra=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=D,e.prototype["@@transducer/step"]=function(e,t){if(this.f){if(this.f(t))return e;this.f=null}return this.xf["@@transducer/step"](e,t)},e}(),$a=P($(["dropWhile"],(function(e){return function(t){return new Ra(e,t)}}),(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return Lr(n,1/0,t)})));const Ma=$a,La=P((function(e,t){return e||t})),Da=P((function(e,t){return Y(e)?function(){return e.apply(this,arguments)||t.apply(this,arguments)}:pr(La)(e,t)})),Ua=A((function(e){return null!=e&&"function"==typeof e["fantasy-land/empty"]?e["fantasy-land/empty"]():null!=e&&null!=e.constructor&&"function"==typeof e.constructor["fantasy-land/empty"]?e.constructor["fantasy-land/empty"]():null!=e&&"function"==typeof e.empty?e.empty():null!=e&&null!=e.constructor&&"function"==typeof e.constructor.empty?e.constructor.empty():N(e)?[]:Q(e)?"":pe(e)?{}:Z(e)?function(){return arguments}():(t=e,"[object Uint8ClampedArray]"===(n=Object.prototype.toString.call(t))||"[object Int8Array]"===n||"[object Uint8Array]"===n||"[object Int16Array]"===n||"[object Uint16Array]"===n||"[object Int32Array]"===n||"[object Uint32Array]"===n||"[object Float32Array]"===n||"[object Float64Array]"===n||"[object BigInt64Array]"===n||"[object BigUint64Array]"===n?e.constructor.from(""):void 0);var t,n})),Ba=P((function(e,t){return ba(e>=0?t.length-e:0,t)})),Fa=P((function(e,t){return se(Ba(e.length,t),e)}));var za=Ae((function(e,t,n){return se(t[e],n[e])}));const Za=za;var qa=P((function e(t,n){if(!pe(n)&&!N(n))return n;var r,a,i,s=n instanceof Array?[]:{};for(a in n)i=typeof(r=t[a]),s[a]="function"===i?r(n[a]):r&&"object"===i?e(r,n[a]):n[a];return s}));const Ha=qa;var Wa=function(){function e(e,t){this.xf=t,this.f=e,this.found=!1}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,void 0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.found=!0,e=Rn(this.xf["@@transducer/step"](e,t))),e},e}(),Ja=P($(["find"],(function(e){return function(t){return new Wa(e,t)}}),(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return t[n];n+=1}})));const Ka=Ja;var Va=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.found=!1}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,-1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.found=!0,e=Rn(this.xf["@@transducer/step"](e,this.idx))),e},e}(),Ga=P($([],(function(e){return function(t){return new Va(e,t)}}),(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return n;n+=1}return-1})));const Xa=Ga;var Ya=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.last))},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.last=t),e},e}();const Qa=P($([],(function(e){return function(t){return new Ya(e,t)}}),(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return t[n];n-=1}})));var ei=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.lastIdx=-1}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.lastIdx))},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.lastIdx=this.idx),e},e}();const ti=P($([],(function(e){return function(t){return new ei(e,t)}}),(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return n;n-=1}return-1}))),ni=A(yr(!0)),ri=A((function(e){return I(e.length,(function(t,n){var r=Array.prototype.slice.call(arguments,0);return r[0]=n,r[1]=t,e.apply(this,r)}))}));var ai=P(Mr("forEach",(function(e,t){for(var n=t.length,r=0;r<n;)e(t[r]),r+=1;return t})));const ii=ai;var si=P((function(e,t){for(var n=V(t),r=0;r<n.length;){var a=n[r];e(t[a],a,t),r+=1}return t}));const oi=si,ci=A((function(e){for(var t={},n=0;n<e.length;)t[e[n][0]]=e[n][1],n+=1;return t})),ui=P(Mr("groupBy",ta((function(e,t){return e.push(t),e}),[])));var li=P((function(e,t){for(var n=[],r=0,a=t.length;r<a;){for(var i=r+1;i<a&&e(t[i-1],t[i]);)i+=1;n.push(t.slice(r,i)),r=i}return n}));const di=li,hi=P((function(e,t){return e>t})),fi=P((function(e,t){return e>=t})),pi=P((function(e,t){if(0===e.length||sr(t))return!1;for(var n=t,r=0;r<e.length;){if(sr(n)||!F(e[r],n))return!1;n=n[e[r]],r+=1}return!0}));var mi=P((function(e,t){return pi([e],t)}));const gi=mi;var yi=P((function(e,t){return!sr(t)&&e in t}));const _i=yi;var bi=function(e,t){switch(arguments.length){case 0:return bi;case 1:return function t(n){return 0===arguments.length?t:ne(e,n)};default:return ne(e,t)}};const vi=bi,wi=Ae((function(e,t,n){return I(Math.max(e.length,t.length,n.length),(function(){return e.apply(this,arguments)?t.apply(this,arguments):n.apply(this,arguments)}))})),xi=jn(1),ki=P(ce),Oi=ta((function(e,t){return t}),null),Ai=P((function(e,t){return"function"!=typeof t.indexOf||N(t)?oe(t,e,0):t.indexOf(e)})),Si=Lr(0,-1),Pi=Ae((function(e,t,n){return fe((function(t){return te(e,t,n)}),t)})),Ei=Ae((function(e,t,n){e=e<n.length&&e>=0?e:n.length;var r=Array.prototype.slice.call(n,0);return r.splice(e,0,t),r})),Ii=Ae((function(e,t,n){return e=e<n.length&&e>=0?e:n.length,[].concat(Array.prototype.slice.call(n,0,e),t,Array.prototype.slice.call(n,e))}));var ji=function(){function e(e,t){this.xf=t,this.f=e,this.set=new oa}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=D,e.prototype["@@transducer/step"]=function(e,t){return this.set.add(this.f(t))?this.xf["@@transducer/step"](e,t):e},e}(),Ti=P($([],(function(e){return function(t){return new ji(e,t)}}),(function(e,t){for(var n,r,a=new oa,i=[],s=0;s<t.length;)n=e(r=t[s]),a.add(n)&&i.push(r),s+=1;return i})));const Ni=Ti,Ci=Ni(qr);var Ri=P((function(e,t){for(var n=new oa,r=0;r<e.length;r+=1)n.add(e[r]);return Ci(fe(n.has.bind(n),t))}));const $i=Ri,Mi=P(Mr("intersperse",(function(e,t){for(var n=[],r=0,a=t.length;r<a;)r===a-1?n.push(t[r]):n.push(t[r],e),r+=1;return n}))),Li="function"==typeof Object.assign?Object.assign:function(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),n=1,r=arguments.length;n<r;){var a=arguments[n];if(null!=a)for(var i in a)F(i,a)&&(t[i]=a[i]);n+=1}return t};var Di=P((function(e,t){var n={};return n[e]=t,n}));const Ui=Di;var Bi={"@@transducer/init":Array,"@@transducer/step":function(e,t){return e.push(t),e},"@@transducer/result":Zr},Fi={"@@transducer/init":String,"@@transducer/step":function(e,t){return e+t},"@@transducer/result":Zr},zi={"@@transducer/init":Object,"@@transducer/step":function(e,t){return Li(e,Se(t)?Ui(t[0],t[1]):t)},"@@transducer/result":Zr};const Zi=Ae((function(e,t,n){var r=t(C(e)?e:function(e){if(C(e))return e;if(Se(e))return Bi;if("string"==typeof e)return Fi;if("object"==typeof e)return zi;throw new Error("Cannot create transformer for "+e)}(e));return Te(r,r["@@transducer/init"](),n)}));var qi=A((function(e){for(var t=V(e),n=t.length,r=0,a={};r<n;){var i=t[r],s=e[i],o=F(s,a)?a[s]:a[s]=[];o[o.length]=i,r+=1}return a}));const Hi=qi;var Wi=A((function(e){for(var t=V(e),n=t.length,r=0,a={};r<n;){var i=t[r];a[e[i]]=i,r+=1}return a}));const Ji=Wi,Ki=P((function(e,t){return I(e+1,(function(){var n=arguments[e];if(null!=n&&Y(n[t]))return n[t].apply(n,Array.prototype.slice.call(arguments,0,e));throw new TypeError(ve(n)+' does not have a method named "'+t+'"')}))})),Vi=P((function(e,t){return t instanceof e||null!=t&&(t.constructor===e||"Object"===e.name&&"object"==typeof t)})),Gi=A((function(e){return null!=e&&se(e,Ua(e))})),Xi=A((function(e){return!sr(e)})),Yi=Ki(1,"join"),Qi=A((function(e){return Xr((function(){return Array.prototype.slice.call(arguments,0)}),e)}));var es=A((function(e){var t,n=[];for(t in e)n[n.length]=t;return n}));const ts=es,ns=P((function(e,t){if("function"!=typeof t.lastIndexOf||N(t)){for(var n=t.length-1;n>=0;){if(se(t[n],e))return n;n-=1}return-1}return t.lastIndexOf(e)}));function rs(e){return"[object Number]"===Object.prototype.toString.call(e)}const as=A((function(e){return null!=e&&rs(e.length)?e.length:NaN}));var is=P((function(e,t){return function(n){return function(r){return X((function(e){return t(e,r)}),n(e(r)))}}}));const ss=is,os=Ae((function(e,t,n){return Cn(e,Fn(t),n)})),cs=A((function(e){return ss(ke(e),os(e))})),us=P((function(e,t){return e.map((function(e){for(var n,r=t,a=0;a<e.length;){if(null==r)return;n=e[a],r=xe(n)?ke(n,r):r[n],a+=1}return r}))})),ls=P((function(e,t){return us([e],t)[0]})),ds=A((function(e){return ss(ls(e),cr(e))})),hs=A((function(e){return ss(Oe(e),lr(e))})),fs=P((function(e,t){return e<t})),ps=P((function(e,t){return e<=t}));var ms=Ae((function(e,t,n){for(var r=0,a=n.length,i=[],s=[t];r<a;)s=e(s[0],n[r]),i[r]=s[1],r+=1;return[s[0],i]}));const gs=ms,ys=Ae((function(e,t,n){for(var r=n.length-1,a=[],i=[t];r>=0;)i=e(i[0],n[r]),a[r]=i[1],r-=1;return[i[0],a]}));var _s=P((function(e,t){return T((function(n,r){return n[r]=e(t[r],r,t),n}),{},V(t))}));const bs=_s;var vs=P((function(e,t){return t.match(e)||[]}));const ws=vs,xs=P((function(e,t){return xe(e)?!xe(t)||t<1?NaN:(e%t+t)%t:NaN})),ks=Ae((function(e,t,n){var r=e(n);return Ln(e(t),r)===r?n:t})),Os=Re(jn,0),As=A((function(e){return Os(e)/e.length}));var Ss=A((function(e){var t=e.length;if(0===t)return NaN;var n=2-t%2,r=(t-n)/2;return As(Array.prototype.slice.call(e,0).sort((function(e,t){return e<t?-1:e>t?1:0})).slice(r,r+n))}));const Ps=Ss;var Es=P((function(e,t){var n={};return S(t.length,(function(){var r=e.apply(this,arguments);return F(r,n)||(n[r]=t.apply(this,arguments)),n[r]}))}));const Is=Es,js=A((function(e){return Li.apply(null,[{}].concat(e))})),Ts=Ae((function(e,t,n){var r,a={};for(r in n=n||{},t=t||{})F(r,t)&&(a[r]=F(r,n)?e(r,t[r],n[r]):t[r]);for(r in n)F(r,n)&&!F(r,a)&&(a[r]=n[r]);return a})),Ns=Ae((function e(t,n,r){return Ts((function(n,r,a){return pe(r)&&pe(a)?e(t,r,a):t(n,r,a)}),n,r)})),Cs=P((function(e,t){return Ns((function(e,t,n){return t}),e,t)})),Rs=P((function(e,t){return Ns((function(e,t,n){return n}),e,t)})),$s=Ae((function(e,t,n){return Ns((function(t,n,r){return e(n,r)}),t,n)})),Ms=P((function(e,t){return Li({},t,e)})),Ls=P((function(e,t){return Li({},e,t)})),Ds=Ae((function(e,t,n){return Ts((function(t,n,r){return e(n,r)}),t,n)})),Us=P((function(e,t){if(e===t)return e;function n(e,t){if(e<t!=t<e)return t<e?t:e}var r=n(e,t);if(void 0!==r)return r;var a=n(typeof e,typeof t);if(void 0!==a)return a===typeof e?e:t;var i=ve(e),s=n(i,ve(t));return void 0!==s?s===i?e:t:e})),Bs=Ae((function(e,t,n){var r=e(n);return Us(e(t),r)===r?n:t}));var Fs=Ae((function e(t,n,r){if(!pe(r)&&!N(r))return r;if(0===t.length)return n(r);var a=t[0];if(!F(a,r))return r;if(1===t.length)return function(e,t,n){if(xe(e)&&N(n)){var r=[].concat(n);return r[e]=t(r[e]),r}var a={};for(var i in n)a[i]=n[i];return a[e]=t(a[e]),a}(a,n,r);var i=e(Array.prototype.slice.call(t,1),n,r[a]);return i===r[a]?r:ir(a,i,r)}));const zs=Fs;var Zs=Ae((function(e,t,n){return zs([e],t,n)}));const qs=Zs,Hs=P((function(e,t){return e%t})),Ws=Ae((function(e,t,n){var r=n.length,a=n.slice(),i=e<0?r+e:e,s=t<0?r+t:t,o=a.splice(i,1);return i<0||i>=n.length||s<0||s>=n.length?n:[].concat(a.slice(0,s)).concat(o).concat(a.slice(s,n.length))})),Js=P((function(e,t){return e*t}));var Ks=P(((e,t)=>n=>e.call(void 0,Rs(t,n))));const Vs=Ks,Gs=A((function(e){return-e})),Xs=P((function(e,t){return Mn(he(e),t)})),Ys=A((function(e){return I(e<0?1:e+1,(function(){return ke(e,arguments)}))})),Qs=Ae((function(e,t,n){return e(t(n))})),eo=P((function(e,t){return"function"==typeof e["fantasy-land/of"]?e["fantasy-land/of"](t):"function"==typeof e.of?e.of(t):[t]}));var to=P((function(e,t){for(var n={},r={},a=0,i=e.length;a<i;)r[e[a]]=1,a+=1;for(var s in t)r.hasOwnProperty(s)||(n[s]=t[s]);return n}));const no=to,ro=E(4,[],(function(e,t,n,r){return e(t(n),t(r))})),ao=A((function(e){var t,n=!1;return S(e.length,(function(){return n?t:(n=!0,t=e.apply(this,arguments))}))}));function io(e,t){if(null==t||!Y(t.then))throw new TypeError("`"+e+"` expected a Promise, received "+be(t,[]))}const so=P((function(e,t){return io("otherwise",t),t.then(null,e)}));var oo=function(e){return{value:e,map:function(t){return oo(t(e))}}},co=Ae((function(e,t,n){return e((function(e){return oo(t(e))}))(n).value}));const uo=co,lo=P((function(e,t){return[e,t]}));function ho(e){return P((function(t,n){return S(Math.max(0,t.length-n.length),(function(){return t.apply(this,e(n,arguments))}))}))}const fo=ho(k),po=ho(ri(k)),mo=Qi([ye,_e]),go=Ae((function(e,t,n){return se(ls(t,n),e)})),yo=Ae((function(e,t,n){return aa(e,ls(t,n))})),_o=Ae((function(e,t,n){return e(ls(t,n))})),bo=P((function(e,t){for(var n={},r=0;r<e.length;)e[r]in t&&(n[e[r]]=t[e[r]]),r+=1;return n}));var vo=P((function(e,t){for(var n={},r=0,a=e.length;r<a;){var i=e[r];n[i]=t[i],r+=1}return n}));const wo=vo;var xo=P((function(e,t){var n={};for(var r in t)e(t[r],r,t)&&(n[r]=t[r]);return n}));const ko=xo,Oo=P((function(e,t){return k([e],t)})),Ao=Re(Js,1),So=P((function(e,t){return I(t.length,(function(){for(var n=[],r=0;r<t.length;)n.push(t[r].call(this,arguments[r])),r+=1;return e.apply(this,n.concat(Array.prototype.slice.call(arguments,t.length)))}))})),Po=So(M,[wo,qr]);function Eo(e,t,n){return function(r){return t(n(e(r)))}}var Io=function(){function e(e,t,n){this.xf=n,this.f=e,this.g=t}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=D,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,Eo(this.f,this.g,t))},e}();const jo=Ae($(["fantasy-land/promap","promap"],(function(e,t){return function(n){return new Io(e,t,n)}}),Eo)),To=Ae((function(e,t,n){return se(e,Oe(t,n))})),No=Ae((function(e,t,n){return Vi(e,Oe(t,n))})),Co=Ae((function(e,t,n){return aa(e,Oe(t,n))})),Ro=Ae((function(e,t,n){return e(Oe(t,n))})),$o=P((function(e,t){return e.map((function(e){return ls([e],t)}))})),Mo=P((function(e,t){if(!rs(e)||!rs(t))throw new TypeError("Both arguments to range must be numbers");for(var n=[],r=e;r<t;)n.push(r),r+=1;return n})),Lo=Ae((function(e,t,n){for(var r=n.length-1;r>=0;){if((t=e(n[r],t))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r-=1}return t})),Do=E(4,[],(function(e,t,n,r){var a=Ce((function(n,r){return e(n,r)?t(n,r):Rn(n)}));return Te(a,n,r)})),Uo=A(Rn);var Bo=P((function(e,t){var n,r=Number(t),a=0;if(r<0||isNaN(r))throw new RangeError("n must be a non-negative number");for(n=[];a<r;)n.push(e(a)),a+=1;return n}));const Fo=Bo;var zo=P((function(e,t){return Fo(Fn(e),t)}));const Zo=zo;var qo=Ae((function(e,t,n){return n.replace(e,t)}));const Ho=qo;var Wo="@@transducer/init",Jo="@@transducer/step",Ko=function(){function e(e,t,n){this.xf=n,this.f=e,this.acc=t}return e.prototype[Wo]=function(){return this.xf[Jo](this.xf[Wo](),this.acc)},e.prototype["@@transducer/result"]=D,e.prototype[Jo]=function(e,t){return e["@@transducer/reduced"]?e:(this.acc=this.f(this.acc,t),this.xf[Jo](e,this.acc))},e}(),Vo=Ae($([],Ae((function(e,t,n){return new Ko(e,t,n)})),(function(e,t,n){for(var r=0,a=n.length,i=[t];r<a;)t=e(t,n[r]),i[r+1]=t,r+=1;return i})));const Go=Vo,Xo=P((function(e,t){var n="function"==typeof e["fantasy-land/of"]?e["fantasy-land/of"]:"function"==typeof e.of?e.of:e,r={"fantasy-land/of":n};return"function"==typeof t["fantasy-land/traverse"]?t["fantasy-land/traverse"](r,Zr):"function"==typeof t.traverse?t.traverse(r,Zr):Lo((function(e,t){return Kn(X(Oo,e),t)}),n([]),t)}));var Yo=Ae((function(e,t,n){return uo(e,Fn(t),n)}));const Qo=Yo,ec=P((function(e,t){return Array.prototype.slice.call(t,0).sort(e)})),tc=P((function(e,t){return Array.prototype.slice.call(t,0).sort((function(t,n){var r=e(t),a=e(n);return r<a?-1:r>a?1:0}))}));var nc=P((function(e,t){return Array.prototype.slice.call(t,0).sort((function(t,n){for(var r=0,a=0;0===r&&a<e.length;)r=e[a](t,n),a+=1;return r}))}));const rc=nc,ac=Ki(1,"split");var ic=P((function(e,t){return[Lr(0,e,t),Lr(e,as(t),t)]}));const sc=ic,oc=P((function(e,t){if(e<=0)throw new Error("First argument to splitEvery must be a positive integer");for(var n=[],r=0;r<t.length;)n.push(Lr(r,r+=e,t));return n}));var cc=P((function(e,t){for(var n=0,r=t.length,a=[];n<r&&!e(t[n]);)a.push(t[n]),n+=1;return[a,Array.prototype.slice.call(t,n)]}));const uc=cc;var lc=E(2,[],(function(e,t){for(var n=[],r=[],a=0;a<t.length;a+=1)e(t[a])||r.push(t[a]),(a<t.length-1&&e(t[a+1])||a===t.length-1)&&r.length>0&&(n.push(r),r=[]);return n}));const dc=lc,hc=P((function(e,t){return se(wa(e.length,t),e)})),fc=P((function(e,t){return Number(e)-Number(t)}));var pc=function(e,t,n){var r=n.length,a=n.slice(),i=e<0?r+e:e,s=t<0?r+t:t,o=Math.min(i,s),c=Math.max(i,s);return i<0||i>r||s<0||s>r||i===s?a:a=[].concat(a.slice(0,o)).concat([a[c]]).concat(a.slice(o+1,c)).concat([a[o]]).concat(a.slice(c+1,r))};const mc=Ae((function(e,t,n){return N(n)?pc(e,t,n):Q(n)?function(e,t,n){var r=pc(e,t,n);return N(r)?r.join(""):r}(e,t,n):function(e,t,n){var r=jr(n),a=Object.getOwnPropertyNames(r);if(a.includes(e)&&a.includes(t)){var i=r[e];r[e]=r[t],r[t]=i}return r}(e,t,n)})),gc=P((function(e,t){return we(ua(e,t),ua(t,e))})),yc=Ae((function(e,t,n){return we(da(e,t,n),da(e,n,t))})),_c=P((function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return Lr(n+1,1/0,t)}));var bc=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=D,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):Rn(e)},e}(),vc=P($(["takeWhile"],(function(e){return function(t){return new bc(e,t)}}),(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return Lr(0,n,t)})));const wc=vc;var xc=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=D,e.prototype["@@transducer/step"]=function(e,t){return this.f(t),this.xf["@@transducer/step"](e,t)},e}();const kc=P($([],(function(e){return function(t){return new xc(e,t)}}),(function(e,t){return e(t),t})));var Oc=P((function(e,t){if(n=e,"[object RegExp]"!==Object.prototype.toString.call(n))throw new TypeError("‘test’ requires a value of type RegExp as its first argument; received "+ve(e));var n;return Sr(e).test(t)}));const Ac=Oc,Sc=P((function(e,t){return io("andThen",t),t.then(e)})),Pc=Ki(0,"toLowerCase");var Ec=A((function(e){var t=[];for(var n in e)F(n,e)&&(t[t.length]=[n,e[n]]);return t}));const Ic=Ec;var jc=A((function(e){var t=[];for(var n in e)t[t.length]=[n,e[n]];return t}));const Tc=jc,Nc=Ki(0,"toUpperCase"),Cc=I(4,(function(e,t,n,r){return Te(e("function"==typeof t?Ce(t):t),n,r)}));var Rc=A((function(e){for(var t=0,n=[];t<e.length;){for(var r=e[t],a=0;a<r.length;)void 0===n[a]&&(n[a]=[]),n[a].push(r[a]),a+=1;t+=1}return n}));const $c=Rc,Mc=Ae((function(e,t,n){var r={"fantasy-land/of":"function"==typeof e["fantasy-land/of"]?e["fantasy-land/of"]:"function"==typeof e.of?e.of:e};return"function"==typeof n["fantasy-land/traverse"]?n["fantasy-land/traverse"](r,t):"function"==typeof n.traverse?n.traverse(r,t):Xo(r,X(t,n))}));var Lc="\t\n\v\f\r                　\u2028\u2029\ufeff",Dc=A("function"==typeof String.prototype.trim&&!Lc.trim()&&"​".trim()?function(e){return e.trim()}:function(e){var t=new RegExp("^["+Lc+"]["+Lc+"]*"),n=new RegExp("["+Lc+"]["+Lc+"]*$");return e.replace(t,"").replace(n,"")});const Uc=Dc,Bc=P((function(e,t){return S(e.length,(function(){try{return e.apply(this,arguments)}catch(e){return t.apply(this,k([e],arguments))}}))})),Fc=A((function(e){return function(){return e(Array.prototype.slice.call(arguments,0))}})),zc=A((function(e){return dr(1,e)}));var Zc=P((function(e,t){return I(e,(function(){for(var n,r=1,a=t,i=0;r<=e&&"function"==typeof a;)n=r===e?arguments.length:i+a.length,a=a.apply(this,Array.prototype.slice.call(arguments,i,n)),r+=1,i=n;return a}))}));const qc=Zc,Hc=P((function(e,t){for(var n=e(t),r=[];n&&n.length;)r[r.length]=n[0],n=e(n[1]);return r})),Wc=P(Fr(Ci,k));var Jc=function(){function e(e,t){this.xf=t,this.pred=e,this.items=[]}return e.prototype["@@transducer/init"]=L,e.prototype["@@transducer/result"]=D,e.prototype["@@transducer/step"]=function(e,t){return te(this.pred,t,this.items)?e:(this.items.push(t),this.xf["@@transducer/step"](e,t))},e}(),Kc=P($([],(function(e){return function(t){return new Jc(e,t)}}),(function(e,t){for(var n,r=0,a=t.length,i=[];r<a;)te(e,n=t[r],i)||(i[i.length]=n),r+=1;return i})));const Vc=Kc,Gc=Ae((function(e,t,n){return Vc(e,k(t,n))})),Xc=Ae((function(e,t,n){return e(n)?n:t(n)})),Yc=kr(Zr),Qc=Ae((function(e,t,n){for(var r=n;!e(r);)r=t(r);return r}));var eu=P((function(e,t){return e in t&&N(t[e])?M((function(n){return ir(e,n,t)}),t[e]):[t]}));const tu=eu;var nu=A((function(e){var t,n=[];for(t in e)n[n.length]=e[t];return n}));const ru=nu;var au=function(e){return{value:e,"fantasy-land/map":function(){return this}}},iu=P((function(e,t){return e(au)(t).value}));const su=iu,ou=Ae((function(e,t,n){return e(n)?t(n):n}));var cu=P((function(e,t){for(var n in e)if(F(n,e)&&!e[n](t[n]))return!1;return!0}));const uu=cu;var lu=P((function(e,t){for(var n in e)if(F(n,e)&&e[n](t[n]))return!0;return!1}));const du=lu,hu=P((function(e,t){return uu(X(se,e),t)}));var fu=P((function(e,t){for(var n=new oa,r=0;r<e.length;r+=1)n.add(e[r]);return _e(n.has.bind(n),t)}));const pu=fu,mu=P((function(e,t){return Boolean(!e^!t)})),gu=P((function(e,t){for(var n,r=0,a=e.length,i=t.length,s=[];r<a;){for(n=0;n<i;)s[s.length]=[e[r],t[n]],n+=1;r+=1}return s}));var yu=P((function(e,t){for(var n=[],r=0,a=Math.min(e.length,t.length);r<a;)n[r]=[e[r],t[r]],r+=1;return n}));const _u=yu;var bu=P((function(e,t){for(var n=0,r=Math.min(e.length,t.length),a={};n<r;)a[e[n]]=t[n],n+=1;return a}));const vu=bu;var wu=Ae((function(e,t,n){for(var r=[],a=0,i=Math.min(t.length,n.length);a<i;)r[a]=e(t[a],n[a]),a+=1;return r}));const xu=wu,ku=A((function(e){return I(e.length,(function(){var t=arguments;return function(){return e.apply(this,t)}}))}));var Ou;!function(e){e[e.BUY=0]="BUY",e[e.SELL=1]="SELL"}(Ou||(Ou={}));class Au{constructor(e){this.Params=e,this.Logger=Ue({id:e.logger_id}),this.last_balance_data={},this.log_mode="verbose",this.state={price_history:[],last_price:null,r:e.target_ratio},this.Params.alpha=this.Params.alpha||.01}log(e){this.Logger(e)}async balance_portfolio(){let{base_asset:e,quote_asset:t}=this.Params;"verbose"==this.log_mode&&this.log("Balancing...");let n=await this.get_balance_data(),{base_amt:r,quote_amt:a,base_price:i,portfolio_value:s,current_ratio:o,ratio_error:c,target_achieved:u,target_base_amt:l,base_delta:d,trade_type:h,base_market_amt:f}=n;if("verbose"==this.log_mode&&this.log(n),this.Params.adaptive&&this.state.last_price){let e=i-this.state.last_price,t=e=>Math.max(Math.min(1,e),0);this.state.r=t(this.state.r-this.Params.alpha*e),this.Params.target_ratio=this.state.r}if(this.state.last_price=i,this.state.price_history.push(i),u)return"verbose"==this.log_mode&&this.log("Target ratio already achieved. Returning"),{balanced:!1,balance_needed:!1,info:null};{"verbose"==this.log_mode&&(this.log("Target ratio NOT achieved. Continuing."),this.log(`Processing order to ${h} ${f} ${e}`));let t=await this.do_market_trade(h,f),{error:n,info:r}=t;return{balanced:!n,balance_needed:!0,info:r}}}async get_balance_data(){let{target_ratio:e,target_precision:t,quote_asset:n,base_asset:r}=this.Params,a=await this.get_base_balance(r),i=await this.get_quote_balance(n),s=await this.get_base_price(r,n),o=a*s+i,c=a*s/o,u=e-c,l=o*e/s,d=l-a,h={base_amt:a,quote_amt:i,base_price:s,portfolio_value:o,current_ratio:c,ratio_error:u,target_achieved:Math.abs(u)<t,target_ratio:e,target_precision:t,target_base_amt:l,base_delta:d,trade_type:d>=0?Ou.BUY:Ou.SELL,base_market_amt:Math.abs(d)};return this.last_balance_data=h,h}set_log_mode(e){"verbose"==this.log_mode&&(this.log(`Setting log mode to ${e}`),this.log_mode=e)}}class Su extends Au{constructor(e){super(e),this.data=e.data,this.current_index=-1,this.portfolio=Object.assign({},e.initial_portfolio),this.initial_portfolio=Object.assign({},e.initial_portfolio),this.rebalances=[],this.slippage=e.slippage,this.fee=e.fee,this.transactions_costs={fees:{base:0,quote:0},slippage:{base:0,quote:0}},this.balance_portfolio_series=[],this.hodl_portfolio_series=[],this.ratio_series=[]}async get_quote_balance(e){return this.portfolio.quote_balance}async get_base_balance(e){return this.portfolio.base_balance}async get_base_price(e,t){return this.data[this.current_index].p}async do_market_trade(e,t){let n=await this.get_base_price("",""),r=this.data[this.current_index];n!=r.p&&(this.log("Sanity check failed! - there is a problem with price indexing"),process.exit(1));let{p:a,t:i}=r;var s,o;switch(e){case Ou.BUY:s=t*(1-this.fee),o=-t*a*(1+this.slippage),this.transactions_costs.fees.base+=t*this.fee,this.transactions_costs.slippage.quote+=t*a*this.slippage;break;case Ou.SELL:s=-t,o=t*a*(1-this.fee)*(1-this.slippage),this.transactions_costs.fees.quote+=t*a*this.fee,this.transactions_costs.slippage.quote+=t*a*this.slippage}let c=this.portfolio.base_balance+=s,u=this.portfolio.quote_balance+=o;return this.portfolio={base_balance:c,quote_balance:u},this.rebalances.push({index:this.current_index,p:a,t:i,trade_type:e,base_amt:t,quote_amt:t*a,portfolio:this.get_portfolio_value_and_time(this.portfolio,a,i),hodl_portfolio:this.get_portfolio_value_and_time(this.initial_portfolio,a,i),cummulative_transactions_costs:{raw:Object.assign({},this.transactions_costs),values:this.get_transactions_costs_values(this.transactions_costs,a)}}),{error:!1,info:null}}symbol_generator(e,t){return"BACKTESTER"}async process_data(){this.current_index+=1,await this.balance_portfolio();let{p:e,t}=this.data[this.current_index];this.hodl_portfolio_series.push(this.get_portfolio_value_and_time(this.initial_portfolio,e,t)),this.balance_portfolio_series.push(this.get_portfolio_value_and_time(this.portfolio,e,t)),this.ratio_series.push(this.Params.target_ratio)}get_portfolio_value_and_time(e,t,n){let r=e.base_balance*t+e.quote_balance;return{base_balance:e.base_balance,quote_balance:e.quote_balance,value:r,p:t,t:n}}get_transactions_costs_values(e,t){let{fees:n,slippage:r}=e,a=n.base*t+n.quote,i=r.base*t+r.quote;return{fee_cost:a,slippage_cost:i,total:a+i}}async backtest(){this.log("Starting backtest...");let e=this.data.length;for(var t=0;t<e;t++)await this.process_data(),t%100==0&&this.log(`Progress = ${t}/${e}`);this.log("Done")}}function Pu(e){return e.length}function Eu(e){let t=0;for(var n=0;n<e.length;n++)t+=window.Math.pow(e[n],2);return Math.pow(t,.5)}function Iu(e){let t=0;for(var n=0;n<e.length;n++)t+=e[n];return t}function ju(e){let t=[];for(var n=0;n<e.length;n++)t[n]=Math.abs(e[n]);return t}function Tu(e){return Iu(e)/Pu(e)}function Nu(e){return Tu(ju(e))}function Cu(e){return{max:Math.max.apply(null,e),min:Math.min.apply(null,e),mean:Tu(e)}}function Ru(e){const t=e.reduce(((e,t)=>e+t.length),0),n=new Float32Array(t);let r=0;return e.forEach((e=>{n.set(e,r),r+=e.length})),n}function $u(){return performance.now()}var Mu={};function Lu(e,t){Mu[e]=t}function Du(e){return Mu[e]}var Uu=Ue({id:"debug"});function Bu(e){let t=new ArrayBuffer(8);return new DataView(t).setBigUint64(0,BigInt(e),!1),new Uint8Array(t)}function Fu(e){let t=Bu(Date.now()),n=new Uint8Array(t.length+e.length);return n.set(t),n.set(e,t.length),n}function zu(){return"undefined"!=typeof window&&void 0!==window.document}function Zu(){return"undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node}function qu(){return Number(new Date)}let Hu=()=>performance.now();var Wu,Ju;function Ku(e,t,n){var r=Hu();return n=n||200,new Promise(((a,i)=>{let s=setInterval((function(){let n=Hu();e()?(a(!1),clearInterval(s)):t&&n-r>=t&&(a(!0),clearInterval(s))}),n)}))}function Vu(e){return new Promise(((t,n)=>{setTimeout((function(){t(Wu.TIMEOUT)}),e)}))}function Gu(e){Lu("pre_clean",e);let t=e.split("\n").join("").replace(/  /g,"").replace(",}","}"),n=t.indexOf("{"),r=t.indexOf("[");var a;return a=n<0?r:r<0?n:Math.min(n,r),t=t.slice(a,t.length),Uu(`extracting json starting at index ${a}=${t[a]}`),Lu("post_clean",t),Uu(`Cleaned ${e} to \n\n\n ${t}`),t}async function Xu(e,t){try{var n;n=zu()?`${window.origin}/api/openai_davinci`:"https://www.tidyscripts.com/api/openai_davinci";let a=await Kv(n,{prompt:e,max_tokens:t});Lu("api_response",a),Uu("Logged the api repsonse"),Uu("Cleaning json string");var r=Gu(a.text);return Uu(`Got cleaned response: ${r}`),{error:!1,data:JSON.parse(r)}}catch(e){return Lu("api_error",e),Uu("api_error experienced"),{error:!0,data:"api error"}}}(Ju=Wu||(Wu={}))[Ju.TIMEOUT=0]="TIMEOUT";const Yu={demographics:{age:35,gender:"Male",ethnicity:"Caucasian",occupation:"Software Engineer"},symptoms:["Fever","Cough","Fatigue"],lab_values:[{lab:"Magnesium",value:1.5},{lab:"Calcium",value:9.2},{lab:"Potassium",value:4},{lab:"Sodium",value:138}],medical_history:["Asthma","Seasonal Allergies"],medications:[{medication:"Albuterol",dose:{value:"2 puffs",frequency:"as needed"}},{medication:"Fluticasone",dose:{value:"1 spray",frequency:"daily"}}],tests:[{test:"Chest X-ray",result:"Negative"}],physical_exam:["Mild wheezing on auscultation"]};function Qu(e){const{demographics:t,symptoms:n,lab_values:r,medical_history:a,medications:i,tests:s,physical_exam:o}=e;return`\n    Given the following patient information:\n    Demographics: ${JSON.stringify(t)}\n    Symptoms: ${JSON.stringify(n)}\n    Lab values: ${JSON.stringify(r)}\n    Medical history: ${JSON.stringify(a)}\n    Medications: ${JSON.stringify(i)}\n    Tests: ${JSON.stringify(s)}\n    Physical exam: ${JSON.stringify(o)}\n\n    Please generate a list of the most likely diagnoses, along with their likelihood and any potential further workup needed to confirm or exclude each diagnosis.\nThe returned value should be a stringified JSON object that is an Array of objects that each have  "diagnosis", "likelihood", "reasoning",  and "suggested_workup" fields. \n    The suggested_workup field should be an array of strings where each string is a single suggested workup, such as "echocardiogram" or "chest x-ray" or "Basic metabolic panel (BMP)".\n    The likelihood field should be a number from 0 to 1 that estimates the probability that this is the diagnosis.\nThe reasoning field provides reasoning for ONLY the diagnosis and NOT for the suggested workup. It should be a string of atleast 5 sentences that directly references the provided information and specific numbers that went into your decision making process, and the logic behind the decision. If you conclude a lab value is high or low please provide a reference range in your explanation.\n    The returned array should have atleast 10 elements that are ranked with the highest likelihood first. \n  `}async function el(e){let t=Qu(e);return await Xu(t,2048)}async function tl(e){try{const t=`Given the medical one-liner "${e.one_liner}" and History and Physical "${e.hp}", generate a patient_data object which conforms\nto the following PatientData type definition in typescript:\n\ntype PatientData = {\n  demographics: {\n    age: number,\n    gender?: string,\n    ethnicity?: string,\n    occupation?: string\n  },\n  symptoms: string[],\n  lab_values: {\n    lab : string ,\n    value : any \n  }[],\n  medical_history: string[],\n  medications: {\n    medication : string,\n    dose : { value : string, frequency : string } \n  }[],\n  tests: {\n    test: string,\n    result: string\n  }[],\n  physical_exam: string[]\n}\n\nThe repsonse should be a json string. \nOnly include the optional fields in the response if that information is explicity present in the one_liner or hp\nDo not include any text in the response other than the json string itself \n\n\nEXAMPLE RESPONSE: \n\n{\n  "demographics": {\n    "age": 30,\n    "gender": "Female",\n    "occupation": "Software Engineer"\n  },\n  "symptoms": ["Fever", "Cough", "Fatigue"],\n  "lab_values": [\n    {\n      "lab": "Magnesium",\n      "value": 1.5\n    },\n    {\n      "lab": "Calcium",\n      "value": 9.2\n    },\n    {\n      "lab": "Potassium",\n      "value": 4.0\n    },\n    {\n      "lab": "Sodium",\n      "value": 138\n    }\n  ],\n  "medical_history": ["Asthma", "Seasonal Allergies"],\n  "medications": [\n    {\n      "medication": "Albuterol",\n      "dose": {\n        "value": "2 puffs",\n        "frequency": "as needed"\n      }\n    },\n    {\n      "medication": "Fluticasone",\n      "dose": {\n        "value": "1 spray",\n        "frequency": "daily"\n      }\n    }\n  ],\n  "tests": [\n    {\n      "test": "Chest X-ray",\n      "result": "Negative"\n    }\n  ],\n  "physical_exam": ["Mild wheezing on auscultation"]\n}\n`;return(await Xu(t,2048)).data}catch(e){return Uu("An error occurred"),Lu("generate_error",e),null}}var nl="1111";const rl=Ue({id:"medications"});var al=[],il=[],sl=null;async function ol(){return await cl(),il}async function cl(){il.length&&sl||(rl("Downloading medications"),al=await Kv("https://storage.googleapis.com/tidyscripts/medication_data.json",{}),rl("Parsing medications"),(il=St(al)).map((function(e){try{e.adverse_reactions=ml(e.adverse_reactions),e.name=e.name.replace("-drug-information","")}catch(t){rl("error parsing med:"),console.log(e),process.exit()}})),rl("Building index"),sl=hl(il),rl("Done"))}function ul(e){return il.filter((function(t){return t.name.match(e)}))}function ll(e){let t=R.keys(sl).filter((t=>t.match(e)));return Object.fromEntries(t.map((e=>[e,sl[e]])))}function dl(e,t){if(!e.adverse_reactions)return t;let n=st(e.adverse_reactions);for(var r of n){let{value:n,path:i}=r,s=i[0];for(var a of n)t[a]||(t[a]={}),t[a][s]||(t[a][s]=[]),t[a][s].push(e.name)}return t}function hl(e){let t={};for(var n of e)t=dl(n,t);return t}function fl(e){let t=e.split("\n\n").filter((e=>e.length>1));var n={};return t.map((function(e){let t=e.split(":"),r=t[0].trim(),a=t.slice(1).join("").replace(/\([\s\S]*?\)/g,"").split(",").map((e=>e.toLowerCase().trim()));n[r]=a})),n}function pl(e){return e.replace(/\([\s\S]*?\)/g,"").split(",").map((e=>e.toLowerCase().trim()))}function ml(e){if(!e)return null;let t=new RegExp([">10%:","1% to 10%:","2% to 10%:","Frequency not defined:","Frequency not defined.\n\n","<1%, postmarketing, and/or case reports:","<2%, postmarketing, and/or case reports:","<2%:","<1%:","Postmarketing:","Postmarketing and/or case reports:","Case Reports:"].join("|"),"g"),n=e.match(t);if(!n)return null;let r=e.split(t);var a={};return ze((function(e,t){try{let n=r[e+1];"<1%, postmarketing, and/or case reports:"==t.trim()||"<2%, postmarketing, and/or case reports:"==t.trim()?a[t]=pl(n):a[t]=fl(n)}catch(e){a[t]=!1}}),n),a}const gl="4.47.1";let yl,_l,bl,vl,wl,xl,kl,Ol,Al,Sl=!1,Pl=null,El=null,Il=null,jl=null;class Tl{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}yl||function(e,t={auto:!1}){if(Sl)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(yl)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${yl}'\``);Sl=t.auto,yl=e.kind,_l=e.fetch,Pl=e.Request,El=e.Response,Il=e.Headers,bl=e.FormData,jl=e.Blob,vl=e.File,wl=e.ReadableStream,xl=e.getMultipartRequestOptions,kl=e.getDefaultAgent,Ol=e.fileFromPath,Al=e.isFsReadStream}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import … from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,r,a,i;try{n=fetch,r=Request,a=Response,i=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:r,Response:a,Headers:i,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new Tl(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0});class Nl extends Error{}class Cl extends Nl{constructor(e,t,n,r){super(`${Cl.makeMessage(e,t,n)}`),this.status=e,this.headers=r,this.request_id=r?.["x-request-id"];const a=t;this.error=a,this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(e,t,n){const r=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,n,r){if(!e)return new $l({cause:Od(t)});const a=t?.error;return 400===e?new Ll(e,a,n,r):401===e?new Dl(e,a,n,r):403===e?new Ul(e,a,n,r):404===e?new Bl(e,a,n,r):409===e?new Fl(e,a,n,r):422===e?new zl(e,a,n,r):429===e?new Zl(e,a,n,r):e>=500?new ql(e,a,n,r):new Cl(e,a,n,r)}}class Rl extends Cl{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}}class $l extends Cl{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}}class Ml extends $l{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Ll extends Cl{constructor(){super(...arguments),this.status=400}}class Dl extends Cl{constructor(){super(...arguments),this.status=401}}class Ul extends Cl{constructor(){super(...arguments),this.status=403}}class Bl extends Cl{constructor(){super(...arguments),this.status=404}}class Fl extends Cl{constructor(){super(...arguments),this.status=409}}class zl extends Cl{constructor(){super(...arguments),this.status=422}}class Zl extends Cl{constructor(){super(...arguments),this.status=429}}class ql extends Cl{}class Hl{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;return new Hl((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const n of async function*(e,t){if(!e.body)throw t.abort(),new Nl("Attempted to iterate over a response with no body");const n=new Jl,r=new Kl,a=Vl(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let r,a=new Uint8Array(t.length+e.length);for(a.set(t),a.set(e,t.length),t=a;-1!==(r=Wl(t));)yield t.slice(0,r),t=t.slice(r)}t.length>0&&(yield t)}(a))for(const t of r.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of r.flush()){const t=n.decode(e);t&&(yield t)}}(e,t))if(!r)if(n.data.startsWith("[DONE]"))r=!0;else if(null===n.event){let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if(e&&e.error)throw new Cl(void 0,e.error,void 0,void 0);yield e}else{let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("error"==n.event)throw new Cl(void 0,e.error,e.message,void 0);yield{event:n.event,data:e}}r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}static fromReadableStream(e,t){let n=!1;return new Hl((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const t of async function*(){const t=new Kl,n=Vl(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())r||t&&(yield JSON.parse(t));r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),r=r=>({next:()=>{if(0===r.length){const r=n.next();e.push(r),t.push(r)}return r.shift()}});return[new Hl((()=>r(e)),this.controller),new Hl((()=>r(t)),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new wl({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:r,done:a}=await t.next();if(a)return e.close();const i=n.encode(JSON.stringify(r)+"\n");e.enqueue(i)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}function Wl(e){for(let t=0;t<e.length-2;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}class Jl{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=function(e,t){const n=e.indexOf(":");return-1!==n?[e.substring(0,n),":",e.substring(n+1)]:[e,"",""]}(e);return r.startsWith(" ")&&(r=r.substring(1)),"event"===t?this.event=r:"data"===t&&this.data.push(r),null}}class Kl{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const n=Kl.NEWLINE_CHARS.has(t[t.length-1]||"");let r=t.split(Kl.NEWLINE_REGEXP);return n&&r.pop(),1!==r.length||n?(this.buffer.length>0&&(r=[this.buffer.join("")+r[0],...r.slice(1)],this.buffer=[]),n||(this.buffer=[r.pop()||""]),r):(this.buffer.push(r[0]),[])}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new Nl(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new Nl(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new Nl("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}function Vl(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}Kl.NEWLINE_CHARS=new Set(["\n","\r"]),Kl.NEWLINE_REGEXP=/\r\n|[\n\r]/g;const Gl=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,Xl=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&Yl(e),Yl=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function Ql(e,t,n){if(e=await e,n??(n=Xl(e)?{lastModified:e.lastModified,type:e.type}:{}),Gl(e)){const r=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new vl([r],t,n)}const r=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(Yl(e))t.push(await e.arrayBuffer());else{if(!td(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){return`[${Object.getOwnPropertyNames(e).map((e=>`"${e}"`)).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return ed(e.name)||ed(e.filename)||ed(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n.type){const e=r[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new vl(r,t,n)}const ed=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,td=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],nd=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],rd=async e=>{const t=await ad(e.body);return xl(t,e)},ad=async e=>{const t=new bl;return await Promise.all(Object.entries(e||{}).map((([e,n])=>id(t,e,n)))),t},id=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if((e=>Xl(e)||Gl(e)||Al(e))(n)){const r=await Ql(n);e.append(t,r)}else if(Array.isArray(n))await Promise.all(n.map((n=>id(e,t+"[]",n))));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map((([n,r])=>id(e,`${t}[${n}]`,r))))}}};var sd;async function od(e){const{response:t}=e;if(e.options.stream)return Id("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):Hl.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type");if(n?.includes("application/json")||n?.includes("application/vnd.api+json")){const e=await t.json();return Id("response",t.status,t.url,t.headers,e),e}const r=await t.text();return Id("response",t.status,t.url,t.headers,r),r}class cd extends Promise{constructor(e,t=od){super((e=>{e(null)})),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new cd(this.responsePromise,(async t=>e(await this.parseResponse(t))))}asResponse(){return this.responsePromise.then((e=>e.response))}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class ud{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:r,fetch:a}){this.baseURL=e,this.maxRetries=kd("maxRetries",t),this.timeout=kd("timeout",n),this.httpAgent=r,this.fetch=a??_l}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),..._d(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${jd()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then((n=>({method:e,path:t,...n}))))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e).length.toString()}return null}buildRequest(e){const{method:t,path:n,query:r,headers:a={}}=e,i=nd(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,s=this.calculateContentLength(i),o=this.buildURL(n,r);"timeout"in e&&kd("timeout",e.timeout);const c=e.timeout??this.timeout,u=e.httpAgent??this.httpAgent??kl(o),l=c+1e3;return"number"==typeof u?.options?.timeout&&l>(u.options.timeout??0)&&(u.options.timeout=l),this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey),{req:{method:t,...i&&{body:i},headers:this.buildHeaders({options:e,headers:a,contentLength:s}),...u&&{agent:u},signal:e.signal??null},url:o,timeout:c}}buildHeaders({options:e,headers:t,contentLength:n}){const r={};return n&&(r["content-length"]=n),Ed(r,this.defaultHeaders(e)),Ed(r,t),nd(e.body)&&"node"!==yl&&delete r["content-type"],this.validateHeaders(r,t),r}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map((e=>[...e]))):{...e}:{}}makeStatusError(e,t,n,r){return Cl.generate(e,t,n,r)}request(e,t=null){return new cd(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e;null==t&&(t=n.maxRetries??this.maxRetries),await this.prepareOptions(n);const{req:r,url:a,timeout:i}=this.buildRequest(n);if(await this.prepareRequest(r,{url:a,options:n}),Id("request",a,n,r.headers),n.signal?.aborted)throw new Rl;const s=new AbortController,o=await this.fetchWithTimeout(a,r,i,s).catch(Od);if(o instanceof Error){if(n.signal?.aborted)throw new Rl;if(t)return this.retryRequest(n,t);if("AbortError"===o.name)throw new Ml;throw new $l({cause:o})}const c=hd(o.headers);if(!o.ok){if(t&&this.shouldRetry(o))return Id(`response (error; retrying, ${t} attempts remaining)`,o.status,a,c),this.retryRequest(n,t,c);const e=await o.text().catch((e=>Od(e).message)),r=bd(e),i=r?void 0:e;throw Id(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,o.status,a,c,i),this.makeStatusError(o.status,r,i,c)}return{response:o,options:n,controller:s}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new dd(this,n,e)}buildURL(e,t){const n=wd(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return Sd(r)||(t={...r,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter((([e,t])=>void 0!==t)).map((([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new Nl(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)})).join("&")}async fetchWithTimeout(e,t,n,r){const{signal:a,...i}=t||{};a&&a.addEventListener("abort",(()=>r.abort()));const s=setTimeout((()=>r.abort()),n);return this.getRequestClient().fetch.call(void 0,e,{signal:r.signal,...i}).finally((()=>{clearTimeout(s)}))}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,n){let r;const a=n?.["retry-after-ms"];if(a){const e=parseFloat(a);Number.isNaN(e)||(r=e)}const i=n?.["retry-after"];if(i&&!r){const e=parseFloat(i);r=Number.isNaN(e)?Date.parse(i)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const n=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,n)}return await xd(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${gl}`}}class ld{constructor(e,t,n,r){sd.set(this,void 0),function(e,t,n,r,a){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");t.set(e,n)}(this,sd,e),this.options=r,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new Nl("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,r]of n)e.url.searchParams.set(t,r);t.query=void 0,t.path=e.url.toString()}return await function(e,t,n,r){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t.get(e)}(this,sd).requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(sd=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class dd extends cd{constructor(e,t,n){super(t,(async t=>new n(e,t.response,await od(t),t.options)))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}const hd=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),fd={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryResponse:!0,__streamClass:!0},pd=e=>"object"==typeof e&&null!==e&&!Sd(e)&&Object.keys(e).every((e=>Pd(fd,e))),md=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",gd=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let yd;const _d=()=>yd??(yd=(()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":gl,"X-Stainless-OS":gd(Deno.build.os),"X-Stainless-Arch":md(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":gl,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":gl,"X-Stainless-OS":gd(process.platform),"X-Stainless-Arch":md(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":gl,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":gl,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),bd=e=>{try{return JSON.parse(e)}catch(e){return}},vd=new RegExp("^(?:[a-z]+:)?//","i"),wd=e=>vd.test(e),xd=e=>new Promise((t=>setTimeout(t,e))),kd=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new Nl(`${e} must be an integer`);if(t<0)throw new Nl(`${e} must be a positive integer`);return t},Od=e=>e instanceof Error?e:new Error(e),Ad=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function Sd(e){if(!e)return!0;for(const t in e)return!1;return!0}function Pd(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function Ed(e,t){for(const n in t){if(!Pd(t,n))continue;const r=n.toLowerCase();if(!r)continue;const a=t[n];null===a?delete e[r]:void 0!==a&&(e[r]=a)}}function Id(e,...t){"undefined"!=typeof process&&"true"===process?.env?.DEBUG&&console.log(`OpenAI:DEBUG:${e}`,...t)}const jd=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}));function Td(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class Nd extends ld{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class Cd extends ld{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class Rd{constructor(e){this._client=e}}class $d extends Rd{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}$d||($d={});class Md extends Rd{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}}Md||(Md={});class Ld extends Rd{constructor(){super(...arguments),this.completions=new Md(this._client)}}!function(e){e.Completions=Md}(Ld||(Ld={}));class Dd extends Rd{create(e,t){return this._client.post("/embeddings",{body:e,...t})}}Dd||(Dd={});class Ud extends Rd{create(e,t){return this._client.post("/files",rd({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return pd(e)?this.list({},e):this._client.getAPIList("/files",Bd,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t?.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const r=new Set(["processed","error","deleted"]),a=Date.now();let i=await this.retrieve(e);for(;!i.status||!r.has(i.status);)if(await xd(t),i=await this.retrieve(e),Date.now()-a>n)throw new Ml({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return i}}class Bd extends Nd{}!function(e){e.FileObjectsPage=Bd}(Ud||(Ud={}));class Fd extends Rd{createVariation(e,t){return this._client.post("/images/variations",rd({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",rd({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}Fd||(Fd={});class zd extends Rd{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}}zd||(zd={});class Zd extends Rd{create(e,t){return this._client.post("/audio/transcriptions",rd({body:e,...t}))}}Zd||(Zd={});class qd extends Rd{create(e,t){return this._client.post("/audio/translations",rd({body:e,...t}))}}qd||(qd={});class Hd extends Rd{constructor(){super(...arguments),this.transcriptions=new Zd(this._client),this.translations=new qd(this._client),this.speech=new zd(this._client)}}!function(e){e.Transcriptions=Zd,e.Translations=qd,e.Speech=zd}(Hd||(Hd={}));class Wd extends Rd{create(e,t){return this._client.post("/moderations",{body:e,...t})}}Wd||(Wd={});class Jd extends Rd{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Kd,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Kd extends Nd{}!function(e){e.ModelsPage=Kd}(Jd||(Jd={}));class Vd extends Rd{list(e,t={},n){return pd(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Gd,{query:t,...n})}}class Gd extends Cd{}!function(e){e.FineTuningJobCheckpointsPage=Gd}(Vd||(Vd={}));class Xd extends Rd{constructor(){super(...arguments),this.checkpoints=new Vd(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return pd(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Yd,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return pd(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Qd,{query:t,...n})}}class Yd extends Cd{}class Qd extends Cd{}!function(e){e.FineTuningJobsPage=Yd,e.FineTuningJobEventsPage=Qd,e.Checkpoints=Vd,e.FineTuningJobCheckpointsPage=Gd}(Xd||(Xd={}));class eh extends Rd{constructor(){super(...arguments),this.jobs=new Xd(this._client)}}!function(e){e.Jobs=Xd,e.FineTuningJobsPage=Yd,e.FineTuningJobEventsPage=Qd}(eh||(eh={}));class th extends Rd{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return pd(e)?this.list({},e):this._client.getAPIList("/assistants",nh,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class nh extends Cd{}function rh(e){return"function"==typeof e.parse}!function(e){e.AssistantsPage=nh}(th||(th={}));const ah=e=>"assistant"===e?.role,ih=e=>"function"===e?.role,sh=e=>"tool"===e?.role;var oh,ch,uh,lh,dh,hh,fh,ph,mh,gh,yh,_h,bh,vh,wh,xh,kh,Oh,Ah,Sh,Ph=function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n},Eh=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};const Ih=10;class jh{constructor(){oh.add(this),this.controller=new AbortController,ch.set(this,void 0),uh.set(this,(()=>{})),lh.set(this,(()=>{})),dh.set(this,void 0),hh.set(this,(()=>{})),fh.set(this,(()=>{})),ph.set(this,{}),this._chatCompletions=[],this.messages=[],mh.set(this,!1),gh.set(this,!1),yh.set(this,!1),_h.set(this,!1),Oh.set(this,(e=>{if(Ph(this,gh,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new Rl),e instanceof Rl)return Ph(this,yh,!0,"f"),this._emit("abort",e);if(e instanceof Nl)return this._emit("error",e);if(e instanceof Error){const t=new Nl(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Nl(String(e)))})),Ph(this,ch,new Promise(((e,t)=>{Ph(this,uh,e,"f"),Ph(this,lh,t,"f")})),"f"),Ph(this,dh,new Promise(((e,t)=>{Ph(this,hh,e,"f"),Ph(this,fh,t,"f")})),"f"),Eh(this,ch,"f").catch((()=>{})),Eh(this,dh,"f").catch((()=>{}))}_run(e){setTimeout((()=>{e().then((()=>{this._emitFinal(),this._emit("end")}),Eh(this,Oh,"f"))}),0)}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(ih(e)||sh(e))&&e.content)this._emit("functionCallResult",e.content);else if(ah(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(ah(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}_connected(){this.ended||(Eh(this,uh,"f").call(this),this._emit("connect"))}get ended(){return Eh(this,mh,"f")}get errored(){return Eh(this,gh,"f")}get aborted(){return Eh(this,yh,"f")}abort(){this.controller.abort()}on(e,t){return(Eh(this,ph,"f")[e]||(Eh(this,ph,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=Eh(this,ph,"f")[e];if(!n)return this;const r=n.findIndex((e=>e.listener===t));return r>=0&&n.splice(r,1),this}once(e,t){return(Eh(this,ph,"f")[e]||(Eh(this,ph,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{Ph(this,_h,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){Ph(this,_h,!0,"f"),await Eh(this,dh,"f")}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new Nl("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Eh(this,oh,"m",bh).call(this)}async finalMessage(){return await this.done(),Eh(this,oh,"m",vh).call(this)}async finalFunctionCall(){return await this.done(),Eh(this,oh,"m",wh).call(this)}async finalFunctionCallResult(){return await this.done(),Eh(this,oh,"m",xh).call(this)}async totalUsage(){return await this.done(),Eh(this,oh,"m",kh).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emit(e,...t){if(Eh(this,mh,"f"))return;"end"===e&&(Ph(this,mh,!0,"f"),Eh(this,hh,"f").call(this));const n=Eh(this,ph,"f")[e];if(n&&(Eh(this,ph,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return Eh(this,_h,"f")||n?.length||Promise.reject(e),Eh(this,lh,"f").call(this,e),Eh(this,fh,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];Eh(this,_h,"f")||n?.length||Promise.reject(e),Eh(this,lh,"f").call(this,e),Eh(this,fh,"f").call(this,e),this._emit("end")}}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=Eh(this,oh,"m",vh).call(this);t&&this._emit("finalMessage",t);const n=Eh(this,oh,"m",bh).call(this);n&&this._emit("finalContent",n);const r=Eh(this,oh,"m",wh).call(this);r&&this._emit("finalFunctionCall",r);const a=Eh(this,oh,"m",xh).call(this);null!=a&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some((e=>e.usage))&&this._emit("totalUsage",Eh(this,oh,"m",kh).call(this))}async _createChatCompletion(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),Eh(this,oh,"m",Ah).call(this,t);const a=await e.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(a)}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){const r="function",{function_call:a="auto",stream:i,...s}=t,o="string"!=typeof a&&a?.name,{maxChatCompletions:c=Ih}=n||{},u={};for(const e of t.functions)u[e.name||e.function.name]=e;const l=t.functions.map((e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description})));for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...s,function_call:a,functions:l,messages:[...this.messages]},n),i=t.choices[0]?.message;if(!i)throw new Nl("missing message in ChatCompletion response");if(!i.function_call)return;const{name:c,arguments:d}=i.function_call,h=u[c];if(!h){const e=`Invalid function_call: ${JSON.stringify(c)}. Available options are: ${l.map((e=>JSON.stringify(e.name))).join(", ")}. Please try again`;this._addMessage({role:r,name:c,content:e});continue}if(o&&o!==c){const e=`Invalid function_call: ${JSON.stringify(c)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,name:c,content:e});continue}let f;try{f=rh(h)?await h.parse(d):d}catch(e){this._addMessage({role:r,name:c,content:e instanceof Error?e.message:String(e)});continue}const p=await h.function(f,this),m=Eh(this,oh,"m",Sh).call(this,p);if(this._addMessage({role:r,name:c,content:m}),o)return}}async _runTools(e,t,n){const r="tool",{tool_choice:a="auto",stream:i,...s}=t,o="string"!=typeof a&&a?.function?.name,{maxChatCompletions:c=Ih}=n||{},u={};for(const e of t.tools)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);const l="tools"in t?t.tools.map((e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description}}:e)):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...s,tool_choice:a,tools:l,messages:[...this.messages]},n),i=t.choices[0]?.message;if(!i)throw new Nl("missing message in ChatCompletion response");if(!i.tool_calls)return;for(const t of i.tool_calls){if("function"!==t.type)continue;const n=t.id,{name:a,arguments:i}=t.function,s=u[a];if(!s){const e=`Invalid tool_call: ${JSON.stringify(a)}. Available options are: ${l.map((e=>JSON.stringify(e.function.name))).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:n,content:e});continue}if(o&&o!==a){const e=`Invalid tool_call: ${JSON.stringify(a)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,tool_call_id:n,content:e});continue}let c;try{c=rh(s)?await s.parse(i):i}catch(e){const t=e instanceof Error?e.message:String(e);this._addMessage({role:r,tool_call_id:n,content:t});continue}const d=await s.function(c,this),h=Eh(this,oh,"m",Sh).call(this,d);if(this._addMessage({role:r,tool_call_id:n,content:h}),o)return}}}}ch=new WeakMap,uh=new WeakMap,lh=new WeakMap,dh=new WeakMap,hh=new WeakMap,fh=new WeakMap,ph=new WeakMap,mh=new WeakMap,gh=new WeakMap,yh=new WeakMap,_h=new WeakMap,Oh=new WeakMap,oh=new WeakSet,bh=function(){return Eh(this,oh,"m",vh).call(this).content??null},vh=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(ah(t))return{...t,content:t.content??null}}throw new Nl("stream ended without producing a ChatCompletionMessage with role=assistant")},wh=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(ah(t)&&t?.function_call)return t.function_call;if(ah(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},xh=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(ih(t)&&null!=t.content)return t.content;if(sh(t)&&null!=t.content&&this.messages.some((e=>"assistant"===e.role&&e.tool_calls?.some((e=>"function"===e.type&&e.id===t.tool_call_id)))))return t.content}},kh=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Ah=function(e){if(null!=e.n&&e.n>1)throw new Nl("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Sh=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class Th extends jh{static runFunctions(e,t,n){const r=new Th,a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,a))),r}static runTools(e,t,n){const r=new Th,a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,a))),r}_addMessage(e){super._addMessage(e),ah(e)&&e.content&&this._emit("content",e.content)}}var Nh,Ch,Rh,$h,Mh,Lh,Dh=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},Uh=function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n};class Bh extends jh{constructor(){super(...arguments),Nh.add(this),Ch.set(this,void 0)}get currentChatCompletionSnapshot(){return Dh(this,Ch,"f")}static fromReadableStream(e){const t=new Bh;return t._run((()=>t._fromReadableStream(e))),t}static createChatCompletion(e,t,n){const r=new Bh;return r._run((()=>r._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}async _createChatCompletion(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),Dh(this,Nh,"m",Rh).call(this);const a=await e.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of a)Dh(this,Nh,"m",$h).call(this,e);if(a.controller.signal?.aborted)throw new Rl;return this._addChatCompletion(Dh(this,Nh,"m",Mh).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),Dh(this,Nh,"m",Rh).call(this),this._connected();const r=Hl.fromReadableStream(e,this.controller);let a;for await(const e of r)a&&a!==e.id&&this._addChatCompletion(Dh(this,Nh,"m",Mh).call(this)),Dh(this,Nh,"m",$h).call(this,e),a=e.id;if(r.controller.signal?.aborted)throw new Rl;return this._addChatCompletion(Dh(this,Nh,"m",Mh).call(this))}[(Ch=new WeakMap,Nh=new WeakSet,Rh=function(){this.ended||Uh(this,Ch,void 0,"f")},$h=function(e){if(this.ended)return;const t=Dh(this,Nh,"m",Lh).call(this,e);this._emit("chunk",e,t);const n=e.choices[0]?.delta?.content,r=t.choices[0]?.message;null!=n&&"assistant"===r?.role&&r?.content&&this._emit("content",n,r.content)},Mh=function(){if(this.ended)throw new Nl("stream has ended, this shouldn't happen");const e=Dh(this,Ch,"f");if(!e)throw new Nl("request ended without sending any chunks");return Uh(this,Ch,void 0,"f"),function(e){const{id:t,choices:n,created:r,model:a,system_fingerprint:i,...s}=e;return{...s,id:t,choices:n.map((({message:t,finish_reason:n,index:r,logprobs:a,...i})=>{if(!n)throw new Nl(`missing finish_reason for choice ${r}`);const{content:s=null,function_call:o,tool_calls:c,...u}=t,l=t.role;if(!l)throw new Nl(`missing role for choice ${r}`);if(o){const{arguments:e,name:t}=o;if(null==e)throw new Nl(`missing function_call.arguments for choice ${r}`);if(!t)throw new Nl(`missing function_call.name for choice ${r}`);return{...i,message:{content:s,function_call:{arguments:e,name:t},role:l},finish_reason:n,index:r,logprobs:a}}return c?{...i,index:r,finish_reason:n,logprobs:a,message:{...u,role:l,content:s,tool_calls:c.map(((t,n)=>{const{function:a,type:i,id:s,...o}=t,{arguments:c,name:u,...l}=a||{};if(null==s)throw new Nl(`missing choices[${r}].tool_calls[${n}].id\n${Fh(e)}`);if(null==i)throw new Nl(`missing choices[${r}].tool_calls[${n}].type\n${Fh(e)}`);if(null==u)throw new Nl(`missing choices[${r}].tool_calls[${n}].function.name\n${Fh(e)}`);if(null==c)throw new Nl(`missing choices[${r}].tool_calls[${n}].function.arguments\n${Fh(e)}`);return{...o,id:s,type:i,function:{...l,name:u,arguments:c}}}))}}:{...i,message:{...u,content:s,role:l},finish_reason:n,index:r,logprobs:a}})),created:r,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}}}(e)},Lh=function(e){var t,n,r;let a=Dh(this,Ch,"f");const{choices:i,...s}=e;a?Object.assign(a,s):a=Uh(this,Ch,{...s,choices:[]},"f");for(const{delta:i,finish_reason:s,index:o,logprobs:c=null,...u}of e.choices){let e=a.choices[o];if(e||(e=a.choices[o]={finish_reason:s,index:o,message:{},logprobs:c,...u}),c)if(e.logprobs){const{content:n,...r}=c;Object.assign(e.logprobs,r),n&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...n))}else e.logprobs=Object.assign({},c);if(s&&(e.finish_reason=s),Object.assign(e,u),!i)continue;const{content:l,function_call:d,role:h,tool_calls:f,...p}=i;if(Object.assign(e.message,p),l&&(e.message.content=(e.message.content||"")+l),h&&(e.message.role=h),d&&(e.message.function_call?(d.name&&(e.message.function_call.name=d.name),d.arguments&&((n=e.message.function_call).arguments??(n.arguments=""),e.message.function_call.arguments+=d.arguments)):e.message.function_call=d),f){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:a,function:i,...s}of f){const o=(r=e.message.tool_calls)[t]??(r[t]={});Object.assign(o,s),n&&(o.id=n),a&&(o.type=a),i&&(o.function??(o.function={arguments:""})),i?.name&&(o.function.name=i.name),i?.arguments&&(o.function.arguments+=i.arguments)}}}return a},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Hl(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Fh(e){return JSON.stringify(e)}class zh extends Bh{static fromReadableStream(e){const t=new zh;return t._run((()=>t._fromReadableStream(e))),t}static runFunctions(e,t,n){const r=new zh,a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,a))),r}static runTools(e,t,n){const r=new zh,a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,a))),r}}class Zh extends Rd{runFunctions(e,t){return e.stream?zh.runFunctions(this._client.chat.completions,e,t):Th.runFunctions(this._client.chat.completions,e,t)}runTools(e,t){return e.stream?zh.runTools(this._client.chat.completions,e,t):Th.runTools(this._client.chat.completions,e,t)}stream(e,t){return Bh.createChatCompletion(this._client.chat.completions,e,t)}}class qh extends Rd{constructor(){super(...arguments),this.completions=new Zh(this._client)}}!function(e){e.Completions=Zh}(qh||(qh={}));var Hh,Wh,Jh,Kh,Vh,Gh,Xh,Yh,Qh,ef,tf,nf,rf=function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n},af=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class sf{constructor(){this.controller=new AbortController,Hh.set(this,void 0),Wh.set(this,(()=>{})),Jh.set(this,(()=>{})),Kh.set(this,void 0),Vh.set(this,(()=>{})),Gh.set(this,(()=>{})),Xh.set(this,{}),Yh.set(this,!1),Qh.set(this,!1),ef.set(this,!1),tf.set(this,!1),nf.set(this,(e=>{if(rf(this,Qh,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new Rl),e instanceof Rl)return rf(this,ef,!0,"f"),this._emit("abort",e);if(e instanceof Nl)return this._emit("error",e);if(e instanceof Error){const t=new Nl(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Nl(String(e)))})),rf(this,Hh,new Promise(((e,t)=>{rf(this,Wh,e,"f"),rf(this,Jh,t,"f")})),"f"),rf(this,Kh,new Promise(((e,t)=>{rf(this,Vh,e,"f"),rf(this,Gh,t,"f")})),"f"),af(this,Hh,"f").catch((()=>{})),af(this,Kh,"f").catch((()=>{}))}_run(e){setTimeout((()=>{e().then((()=>{this._emit("end")}),af(this,nf,"f"))}),0)}_addRun(e){return e}_connected(){this.ended||(af(this,Wh,"f").call(this),this._emit("connect"))}get ended(){return af(this,Yh,"f")}get errored(){return af(this,Qh,"f")}get aborted(){return af(this,ef,"f")}abort(){this.controller.abort()}on(e,t){return(af(this,Xh,"f")[e]||(af(this,Xh,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=af(this,Xh,"f")[e];if(!n)return this;const r=n.findIndex((e=>e.listener===t));return r>=0&&n.splice(r,1),this}once(e,t){return(af(this,Xh,"f")[e]||(af(this,Xh,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{rf(this,tf,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){rf(this,tf,!0,"f"),await af(this,Kh,"f")}_emit(e,...t){if(af(this,Yh,"f"))return;"end"===e&&(rf(this,Yh,!0,"f"),af(this,Vh,"f").call(this));const n=af(this,Xh,"f")[e];if(n&&(af(this,Xh,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return af(this,tf,"f")||n?.length||Promise.reject(e),af(this,Jh,"f").call(this,e),af(this,Gh,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];af(this,tf,"f")||n?.length||Promise.reject(e),af(this,Jh,"f").call(this,e),af(this,Gh,"f").call(this,e),this._emit("end")}}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,r){return await this._createAssistantStream(t,e,n,r)}async _runToolAssistantStream(e,t,n,r,a){return await this._createToolAssistantStream(n,e,t,r,a)}async _createThreadAssistantStream(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort())));const a=await e.createAndRun({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addRun(a)}async _createToolAssistantStream(e,t,n,r,a){const i=a?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",(()=>this.controller.abort())));const s=await e.submitToolOutputs(t,n,{...r,stream:!1},{...a,signal:this.controller.signal});return this._connected(),this._addRun(s)}async _createAssistantStream(e,t,n,r){const a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",(()=>this.controller.abort())));const i=await e.create(t,{...n,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addRun(i)}}Hh=new WeakMap,Wh=new WeakMap,Jh=new WeakMap,Kh=new WeakMap,Vh=new WeakMap,Gh=new WeakMap,Xh=new WeakMap,Yh=new WeakMap,Qh=new WeakMap,ef=new WeakMap,tf=new WeakMap,nf=new WeakMap;var of,cf,uf,lf,df,hf,ff,pf,mf,gf,yf,_f,bf,vf,wf,xf,kf,Of,Af,Sf,Pf,Ef,If,jf=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},Tf=function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n};class Nf extends sf{constructor(){super(...arguments),of.add(this),cf.set(this,[]),uf.set(this,{}),lf.set(this,{}),df.set(this,void 0),hf.set(this,void 0),ff.set(this,void 0),pf.set(this,void 0),mf.set(this,void 0),gf.set(this,void 0),yf.set(this,void 0),_f.set(this,void 0),bf.set(this,void 0)}[(cf=new WeakMap,uf=new WeakMap,lf=new WeakMap,df=new WeakMap,hf=new WeakMap,ff=new WeakMap,pf=new WeakMap,mf=new WeakMap,gf=new WeakMap,yf=new WeakMap,_f=new WeakMap,bf=new WeakMap,of=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new Nf;return t._run((()=>t._fromReadableStream(e))),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),this._connected();const r=Hl.fromReadableStream(e,this.controller);for await(const e of r)jf(this,of,"m",vf).call(this,e);if(r.controller.signal?.aborted)throw new Rl;return this._addRun(jf(this,of,"m",wf).call(this))}toReadableStream(){return new Hl(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,r,a){const i=new Nf;return i._run((()=>i._runToolAssistantStream(e,t,n,r,{...a,headers:{...a?.headers,"X-Stainless-Helper-Method":"stream"}}))),i}async _createToolAssistantStream(e,t,n,r,a){const i=a?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",(()=>this.controller.abort())));const s={...r,stream:!0},o=await e.submitToolOutputs(t,n,s,{...a,signal:this.controller.signal});this._connected();for await(const e of o)jf(this,of,"m",vf).call(this,e);if(o.controller.signal?.aborted)throw new Rl;return this._addRun(jf(this,of,"m",wf).call(this))}static createThreadAssistantStream(e,t,n){const r=new Nf;return r._run((()=>r._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}static createAssistantStream(e,t,n,r){const a=new Nf;return a._run((()=>a._runAssistantStream(e,t,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}}))),a}currentEvent(){return jf(this,yf,"f")}currentRun(){return jf(this,_f,"f")}currentMessageSnapshot(){return jf(this,df,"f")}currentRunStepSnapshot(){return jf(this,bf,"f")}async finalRunSteps(){return await this.done(),Object.values(jf(this,uf,"f"))}async finalMessages(){return await this.done(),Object.values(jf(this,lf,"f"))}async finalRun(){if(await this.done(),!jf(this,hf,"f"))throw Error("Final run was not received.");return jf(this,hf,"f")}async _createThreadAssistantStream(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort())));const a={...t,stream:!0},i=await e.createAndRun(a,{...n,signal:this.controller.signal});this._connected();for await(const e of i)jf(this,of,"m",vf).call(this,e);if(i.controller.signal?.aborted)throw new Rl;return this._addRun(jf(this,of,"m",wf).call(this))}async _createAssistantStream(e,t,n,r){const a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",(()=>this.controller.abort())));const i={...n,stream:!0},s=await e.create(t,i,{...r,signal:this.controller.signal});this._connected();for await(const e of s)jf(this,of,"m",vf).call(this,e);if(s.controller.signal?.aborted)throw new Rl;return this._addRun(jf(this,of,"m",wf).call(this))}static accumulateDelta(e,t){for(const[n,r]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=r;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof r)t+=r;else if("number"==typeof t&&"number"==typeof r)t+=r;else if(Td(t)&&Td(r))t=this.accumulateDelta(t,r);else{if(!Array.isArray(t)||!Array.isArray(r))throw Error(`Unhandled record type: ${n}, deltaValue: ${r}, accValue: ${t}`);if(t.every((e=>"string"==typeof e||"number"==typeof e))){t.push(...r);continue}}e[n]=t}else e[n]=r;else e[n]=r}return e}}vf=function(e){if(!this.ended)switch(Tf(this,yf,e,"f"),jf(this,of,"m",Of).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":jf(this,of,"m",Ef).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":jf(this,of,"m",kf).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":jf(this,of,"m",xf).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},wf=function(){if(this.ended)throw new Nl("stream has ended, this shouldn't happen");if(!jf(this,hf,"f"))throw Error("Final run has not been received");return jf(this,hf,"f")},xf=function(e){const[t,n]=jf(this,of,"m",Sf).call(this,e,jf(this,df,"f"));Tf(this,df,t,"f"),jf(this,lf,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,r=t.content[n.index];if(!r||"text"!=r.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,r.text)}if(n.index!=jf(this,ff,"f")){if(jf(this,pf,"f"))switch(jf(this,pf,"f").type){case"text":this._emit("textDone",jf(this,pf,"f").text,jf(this,df,"f"));break;case"image_file":this._emit("imageFileDone",jf(this,pf,"f").image_file,jf(this,df,"f"))}Tf(this,ff,n.index,"f")}Tf(this,pf,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==jf(this,ff,"f")){const t=e.data.content[jf(this,ff,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,jf(this,df,"f"));break;case"text":this._emit("textDone",t.text,jf(this,df,"f"))}}jf(this,df,"f")&&this._emit("messageDone",e.data),Tf(this,df,void 0,"f")}},kf=function(e){const t=jf(this,of,"m",Af).call(this,e);switch(Tf(this,bf,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==jf(this,mf,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(jf(this,gf,"f")&&this._emit("toolCallDone",jf(this,gf,"f")),Tf(this,mf,e.index,"f"),Tf(this,gf,t.step_details.tool_calls[e.index],"f"),jf(this,gf,"f")&&this._emit("toolCallCreated",jf(this,gf,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Tf(this,bf,void 0,"f"),"tool_calls"==e.data.step_details.type&&jf(this,gf,"f")&&(this._emit("toolCallDone",jf(this,gf,"f")),Tf(this,gf,void 0,"f")),this._emit("runStepDone",e.data,t)}},Of=function(e){jf(this,cf,"f").push(e),this._emit("event",e)},Af=function(e){switch(e.event){case"thread.run.step.created":return jf(this,uf,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=jf(this,uf,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const r=Nf.accumulateDelta(t,n.delta);jf(this,uf,"f")[e.data.id]=r}return jf(this,uf,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":jf(this,uf,"f")[e.data.id]=e.data}if(jf(this,uf,"f")[e.data.id])return jf(this,uf,"f")[e.data.id];throw new Error("No snapshot available")},Sf=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const e of r.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=jf(this,of,"m",Pf).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Pf=function(e,t){return Nf.accumulateDelta(t,e)},Ef=function(e){switch(Tf(this,_f,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Tf(this,hf,e.data,"f"),jf(this,gf,"f")&&(this._emit("toolCallDone",jf(this,gf,"f")),Tf(this,gf,void 0,"f"))}};class Cf extends Rd{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return pd(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Rf,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class Rf extends Cd{}!function(e){e.MessagesPage=Rf}(Cf||(Cf={}));class $f extends Rd{retrieve(e,t,n,r){return this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t,n={},r){return pd(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Mf,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class Mf extends Cd{}!function(e){e.RunStepsPage=Mf}($f||($f={}));class Lf extends Rd{constructor(){super(...arguments),this.steps=new $f(this._client)}create(e,t,n){return this._client.post(`/threads/${e}/runs`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return pd(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Df,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}createAndStream(e,t,n){return Nf.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:a,response:i}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...r}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=i.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await xd(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,t,n){return Nf.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,r){const a=await this.submitToolOutputs(e,t,n,r);return await this.poll(e,a.id,r)}submitToolOutputsStream(e,t,n,r){return Nf.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,r)}}class Df extends Cd{}!function(e){e.RunsPage=Df,e.Steps=$f,e.RunStepsPage=Mf}(Lf||(Lf={}));class Uf extends Rd{constructor(){super(...arguments),this.runs=new Lf(this._client),this.messages=new Cf(this._client)}create(e={},t){return pd(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return Nf.createThreadAssistantStream(e,this._client.beta.threads,t)}}!function(e){e.Runs=Lf,e.RunsPage=Df,e.Messages=Cf,e.MessagesPage=Rf}(Uf||(Uf={}));class Bf extends Rd{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},n){return pd(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,Ff,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const a=await this.retrieve(e,t,{...n,headers:r}).withResponse(),i=a.data;switch(i.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await xd(e);break;case"failed":case"completed":return i}}}async upload(e,t,n){const r=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:r.id},n)}async uploadAndPoll(e,t,n){const r=await this.upload(e,t,n);return await this.poll(e,r.id,n)}}class Ff extends Cd{}!function(e){e.VectorStoreFilesPage=Ff}(Bf||(Bf={}));class zf extends Rd{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t);return await this.poll(e,r.id,n)}listFiles(e,t,n={},r){return pd(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Ff,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:a,response:i}=await this.retrieve(e,t,{...n,headers:r}).withResponse();switch(a.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=i.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await xd(e);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},r){if(null===t||0==t.length)throw new Error("No files provided to process.");const a=r?.maxConcurrency??5,i=Math.min(a,t.length),s=this._client,o=t.values(),c=[...n],u=Array(i).fill(o).map((async function(e){for(let t of e){const e=await s.files.create({file:t,purpose:"assistants"},r);c.push(e.id)}}));return await(async e=>{const t=await Promise.allSettled(e),n=t.filter((e=>"rejected"===e.status));if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const e of t)"fulfilled"===e.status&&r.push(e.value);return r})(u),await this.createAndPoll(e,{file_ids:c})}}zf||(zf={});class Zf extends Rd{constructor(){super(...arguments),this.files=new Bf(this._client),this.fileBatches=new zf(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return pd(e)?this.list({},e):this._client.getAPIList("/vector_stores",qf,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class qf extends Cd{}!function(e){e.VectorStoresPage=qf,e.Files=Bf,e.VectorStoreFilesPage=Ff,e.FileBatches=zf}(Zf||(Zf={}));class Hf extends Rd{constructor(){super(...arguments),this.vectorStores=new Zf(this._client),this.chat=new qh(this._client),this.assistants=new th(this._client),this.threads=new Uf(this._client)}}!function(e){e.VectorStores=Zf,e.VectorStoresPage=qf,e.Chat=qh,e.Assistants=th,e.AssistantsPage=nh,e.Threads=Uf}(Hf||(Hf={}));class Wf extends Rd{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return pd(e)?this.list({},e):this._client.getAPIList("/batches",Jf,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class Jf extends Cd{}!function(e){e.BatchesPage=Jf}(Wf||(Wf={}));class Kf extends ud{constructor({baseURL:e=Ad("OPENAI_BASE_URL"),apiKey:t=Ad("OPENAI_API_KEY"),organization:n=Ad("OPENAI_ORG_ID")??null,project:r=Ad("OPENAI_PROJECT_ID")??null,...a}={}){if(void 0===t)throw new Nl("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:t,organization:n,project:r,...a,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new Nl("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new $d(this),this.chat=new Ld(this),this.embeddings=new Dd(this),this.files=new Ud(this),this.images=new Fd(this),this.audio=new Hd(this),this.moderations=new Wd(this),this.models=new Jd(this),this.fineTuning=new eh(this),this.beta=new Hf(this),this.batches=new Wf(this),this._options=i,this.apiKey=t,this.organization=n,this.project=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}}If=Kf,Kf.OpenAI=If,Kf.OpenAIError=Nl,Kf.APIError=Cl,Kf.APIConnectionError=$l,Kf.APIConnectionTimeoutError=Ml,Kf.APIUserAbortError=Rl,Kf.NotFoundError=Bl,Kf.ConflictError=Fl,Kf.RateLimitError=Zl,Kf.BadRequestError=Ll,Kf.AuthenticationError=Dl,Kf.InternalServerError=ql,Kf.PermissionDeniedError=Ul,Kf.UnprocessableEntityError=zl,Kf.toFile=Ql,Kf.fileFromPath=Ol;const{OpenAIError:Vf,APIError:Gf,APIConnectionError:Xf,APIConnectionTimeoutError:Yf,APIUserAbortError:Qf,NotFoundError:ep,ConflictError:tp,RateLimitError:np,BadRequestError:rp,AuthenticationError:ap,InternalServerError:ip,PermissionDeniedError:sp,UnprocessableEntityError:op}=y;var cp;(cp=Kf||(Kf={})).Page=Nd,cp.CursorPage=Cd,cp.Completions=$d,cp.Chat=Ld,cp.Embeddings=Dd,cp.Files=Ud,cp.FileObjectsPage=Bd,cp.Images=Fd,cp.Audio=Hd,cp.Moderations=Wd,cp.Models=Jd,cp.ModelsPage=Kd,cp.FineTuning=eh,cp.Beta=Hf,cp.Batches=Wf,cp.BatchesPage=Jf,new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations","/batches"]);const up=Kf;function lp(e,t=dp){e=e.trim();const n=/```(json)?(.*)```/s.exec(e);return t(n?n[2]:e)}function dp(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const n=[];let r=!1,a=!1;for(let i of e){if(r)'"'!==i||a?"\n"!==i||a?a="\\"===i&&!a:i="\\n":r=!1;else if('"'===i)r=!0,a=!1;else if("{"===i)n.push("}");else if("["===i)n.push("]");else if("}"===i||"]"===i){if(!n||n[n.length-1]!==i)return null;n.pop()}t+=i}r&&(t+='"');for(let e=n.length-1;e>=0;e-=1)t+=n[e];try{return JSON.parse(t)}catch(e){return null}}var hp=a(409);function fp(e,t){return t?.[e]||hp(e)}function pp(e,t,n){const r={};for(const a in e)Object.hasOwn(e,a)&&(r[t(a,n)]=e[a]);return r}function mp(e){return Array.isArray(e)?[...e]:{...e}}function gp(e,t){const n=mp(e);for(const[e,r]of Object.entries(t)){const[t,...a]=e.split(".").reverse();let i=n;for(const e of a.reverse()){if(void 0===i[e])break;i[e]=mp(i[e]),i=i[e]}void 0!==i[t]&&(i[t]={lc:1,type:"secret",id:[r]})}return n}function yp(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}a(832);class _p{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,yp(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof _p||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},n=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let r=Object.getPrototypeOf(this);r;r=Object.getPrototypeOf(r))Object.assign(e,Reflect.get(r,"lc_aliases",this)),Object.assign(t,Reflect.get(r,"lc_secrets",this)),Object.assign(n,Reflect.get(r,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,r=n;const[a,...i]=e.split(".").reverse();for(const e of i.reverse()){if(!(e in t)||void 0===t[e])return;e in r&&void 0!==r[e]||("object"==typeof t[e]&&null!=t[e]?r[e]={}:Array.isArray(t[e])&&(r[e]=[])),t=t[e],r=r[e]}a in t&&void 0!==t[a]&&(r[a]=r[a]||t[a])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:pp(Object.keys(t).length?gp(n,t):n,fp,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function bp(e,t){return"string"==typeof e?"string"==typeof t?e+t:[{type:"text",text:e},...t]:Array.isArray(t)?[...e,...t]:[...e,{type:"text",text:t}]}class vp extends _p{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:""}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}}function wp(e,t){const n={...e};for(const[e,r]of Object.entries(t))if(null==n[e])n[e]=r;else{if(null==r)continue;if(typeof n[e]!=typeof r||Array.isArray(n[e])!==Array.isArray(r))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof n[e])n[e]=n[e]+r;else if(Array.isArray(n[e])||"object"!=typeof n[e])if(Array.isArray(n[e]))n[e]=xp(n[e],r);else{if(n[e]===r)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else n[e]=wp(n[e],r)}return n}function xp(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const n=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=n.findIndex((t=>t.index===e.index));-1!==t?n[t]=wp(n[t],e):n.push(e)}else n.push(e);return n}}}class kp extends vp{}function Op(e){return"function"==typeof e?._getType}class Ap extends kp{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new Ap({content:bp(this.content,e.content),additional_kwargs:wp(this.additional_kwargs,e.additional_kwargs),response_metadata:wp(this.response_metadata,e.response_metadata),tool_call_id:this.tool_call_id})}}class Sp extends vp{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let n;if("string"==typeof e)n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{n=e;const t=n.additional_kwargs?.tool_calls,r=n.tool_calls;null!=t&&t.length>0&&(void 0===r||0===r.length)&&console.warn(["New LangChain packages are available that more efficiently handle","tool calling.\n\nPlease upgrade your packages to versions that set","message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(null!=t&&void 0===r){const[e,r]=function(e){const t=[],n=[];for(const r of e)if(r.function){const e=r.function.name;try{const n={name:e||"",args:JSON.parse(r.function.arguments)||{},id:r.id};t.push(n)}catch(t){n.push({name:e,args:r.function.arguments,id:r.id,error:"Malformed args."})}}return[t,n]}(t);n.tool_calls=e??[],n.invalid_tool_calls=r??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch(e){n.tool_calls=[],n.invalid_tool_calls=[]}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),"string"!=typeof n&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls)}static lc_name(){return"AIMessage"}_getType(){return"ai"}}class Pp extends kp{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else{const n=[],r=[];for(const t of e.tool_call_chunks){let a={};try{if(a=dp(t.args??"{}")??{},"object"!=typeof a||Array.isArray(a))throw new Error("Malformed tool call chunk args.");n.push({name:t.name??"",args:a,id:t.id})}catch(e){r.push({name:t.name,args:t.args,id:t.id,error:"Malformed args."})}}t={...e,tool_calls:n,invalid_tool_calls:r}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.tool_call_chunks=t?.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t?.tool_calls??this.tool_calls,this.invalid_tool_calls=t?.invalid_tool_calls??this.invalid_tool_calls}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){const t={content:bp(this.content,e.content),additional_kwargs:wp(this.additional_kwargs,e.additional_kwargs),response_metadata:wp(this.response_metadata,e.response_metadata),tool_call_chunks:[]};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const n=xp(this.tool_call_chunks,e.tool_call_chunks);void 0!==n&&n.length>0&&(t.tool_call_chunks=n)}return new Pp(t)}}class Ep extends vp{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return Ep}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}}class Ip extends kp{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new Ip({content:bp(this.content,e.content),additional_kwargs:wp(this.additional_kwargs,e.additional_kwargs),response_metadata:wp(this.response_metadata,e.response_metadata),role:this.role})}}class jp extends kp{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new jp({content:bp(this.content,e.content),additional_kwargs:wp(this.additional_kwargs,e.additional_kwargs),response_metadata:wp(this.response_metadata,e.response_metadata),name:this.name??""})}}class Tp extends vp{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class Np extends kp{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new Np({content:bp(this.content,e.content),additional_kwargs:wp(this.additional_kwargs,e.additional_kwargs),response_metadata:wp(this.response_metadata,e.response_metadata)})}}class Cp extends vp{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class Rp extends kp{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new Rp({content:bp(this.content,e.content),additional_kwargs:wp(this.additional_kwargs,e.additional_kwargs),response_metadata:wp(this.response_metadata,e.response_metadata)})}}function $p(e){if("string"==typeof e)return new Tp(e);if(Op(e))return e;const[t,n]=e;if("human"===t||"user"===t)return new Tp({content:n});if("ai"===t||"assistant"===t)return new Sp({content:n});if("system"===t)return new Cp({content:n});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function Mp(e,t="Human",n="AI"){const r=[];for(const a of e){let e;if("human"===a._getType())e=t;else if("ai"===a._getType())e=n;else if("system"===a._getType())e="System";else if("function"===a._getType())e="Function";else if("tool"===a._getType())e="Tool";else{if("generic"!==a._getType())throw new Error(`Got unsupported message type: ${a._getType()}`);e=a.role}const i=a.name?`${a.name}, `:"";r.push(`${e}: ${i}${a.content}`)}return r.join("\n")}function Lp(e){const t=e._getType();if("human"===t)return new Np({...e});if("ai"===t)return new Pp({...e});if("system"===t)return new Rp({...e});if("function"===t)return new jp({...e});if(Ep.isInstance(e))return new Ip({...e});throw new Error("Unknown message type.")}const Dp="__run";class Up{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new Up({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class Bp extends Up{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new Bp({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}const Fp=()=>"undefined"!=typeof Deno;let zp;async function Zp(){if(void 0===zp){const e=(()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||Fp()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":Fp()?"deno":"other":"node",e})();zp={library:"langchain-js",runtime:e}}return zp}function qp(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}var Hp="object"==typeof window?window:{},Wp="0123456789abcdef".split(""),Jp=[-2147483648,8388608,32768,128],Kp=[24,16,8,0],Vp=[];function Gp(e){e?(Vp[0]=Vp[16]=Vp[1]=Vp[2]=Vp[3]=Vp[4]=Vp[5]=Vp[6]=Vp[7]=Vp[8]=Vp[9]=Vp[10]=Vp[11]=Vp[12]=Vp[13]=Vp[14]=Vp[15]=0,this.blocks=Vp):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Gp.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===Hp.ArrayBuffer&&(e=new Uint8Array(e));for(var n,r,a=0,i=e.length||0,s=this.blocks;a<i;){if(this.hashed&&(this.hashed=!1,s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),t)for(r=this.start;a<i&&r<64;++a)s[r>>2]|=e[a]<<Kp[3&r++];else for(r=this.start;a<i&&r<64;++a)(n=e.charCodeAt(a))<128?s[r>>2]|=n<<Kp[3&r++]:n<2048?(s[r>>2]|=(192|n>>6)<<Kp[3&r++],s[r>>2]|=(128|63&n)<<Kp[3&r++]):n<55296||n>=57344?(s[r>>2]|=(224|n>>12)<<Kp[3&r++],s[r>>2]|=(128|n>>6&63)<<Kp[3&r++],s[r>>2]|=(128|63&n)<<Kp[3&r++]):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++a)),s[r>>2]|=(240|n>>18)<<Kp[3&r++],s[r>>2]|=(128|n>>12&63)<<Kp[3&r++],s[r>>2]|=(128|n>>6&63)<<Kp[3&r++],s[r>>2]|=(128|63&n)<<Kp[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=s[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},Gp.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=Jp[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},Gp.prototype.hash=function(){var e,t,n=this.h0,r=this.h1,a=this.h2,i=this.h3,s=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)n=(t=(r=(t=(a=(t=(i=(t=(s=(t=n<<5|n>>>27)+(r&a|~r&i)+s+1518500249+o[e]|0)<<5|s>>>27)+(n&(r=r<<30|r>>>2)|~n&a)+i+1518500249+o[e+1]|0)<<5|i>>>27)+(s&(n=n<<30|n>>>2)|~s&r)+a+1518500249+o[e+2]|0)<<5|a>>>27)+(i&(s=s<<30|s>>>2)|~i&n)+r+1518500249+o[e+3]|0)<<5|r>>>27)+(a&(i=i<<30|i>>>2)|~a&s)+n+1518500249+o[e+4]|0,a=a<<30|a>>>2;for(;e<40;e+=5)n=(t=(r=(t=(a=(t=(i=(t=(s=(t=n<<5|n>>>27)+(r^a^i)+s+1859775393+o[e]|0)<<5|s>>>27)+(n^(r=r<<30|r>>>2)^a)+i+1859775393+o[e+1]|0)<<5|i>>>27)+(s^(n=n<<30|n>>>2)^r)+a+1859775393+o[e+2]|0)<<5|a>>>27)+(i^(s=s<<30|s>>>2)^n)+r+1859775393+o[e+3]|0)<<5|r>>>27)+(a^(i=i<<30|i>>>2)^s)+n+1859775393+o[e+4]|0,a=a<<30|a>>>2;for(;e<60;e+=5)n=(t=(r=(t=(a=(t=(i=(t=(s=(t=n<<5|n>>>27)+(r&a|r&i|a&i)+s-1894007588+o[e]|0)<<5|s>>>27)+(n&(r=r<<30|r>>>2)|n&a|r&a)+i-1894007588+o[e+1]|0)<<5|i>>>27)+(s&(n=n<<30|n>>>2)|s&r|n&r)+a-1894007588+o[e+2]|0)<<5|a>>>27)+(i&(s=s<<30|s>>>2)|i&n|s&n)+r-1894007588+o[e+3]|0)<<5|r>>>27)+(a&(i=i<<30|i>>>2)|a&s|i&s)+n-1894007588+o[e+4]|0,a=a<<30|a>>>2;for(;e<80;e+=5)n=(t=(r=(t=(a=(t=(i=(t=(s=(t=n<<5|n>>>27)+(r^a^i)+s-899497514+o[e]|0)<<5|s>>>27)+(n^(r=r<<30|r>>>2)^a)+i-899497514+o[e+1]|0)<<5|i>>>27)+(s^(n=n<<30|n>>>2)^r)+a-899497514+o[e+2]|0)<<5|a>>>27)+(i^(s=s<<30|s>>>2)^n)+r-899497514+o[e+3]|0)<<5|r>>>27)+(a^(i=i<<30|i>>>2)^s)+n-899497514+o[e+4]|0,a=a<<30|a>>>2;this.h0=this.h0+n|0,this.h1=this.h1+r|0,this.h2=this.h2+a|0,this.h3=this.h3+i|0,this.h4=this.h4+s|0},Gp.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,a=this.h4;return Wp[e>>28&15]+Wp[e>>24&15]+Wp[e>>20&15]+Wp[e>>16&15]+Wp[e>>12&15]+Wp[e>>8&15]+Wp[e>>4&15]+Wp[15&e]+Wp[t>>28&15]+Wp[t>>24&15]+Wp[t>>20&15]+Wp[t>>16&15]+Wp[t>>12&15]+Wp[t>>8&15]+Wp[t>>4&15]+Wp[15&t]+Wp[n>>28&15]+Wp[n>>24&15]+Wp[n>>20&15]+Wp[n>>16&15]+Wp[n>>12&15]+Wp[n>>8&15]+Wp[n>>4&15]+Wp[15&n]+Wp[r>>28&15]+Wp[r>>24&15]+Wp[r>>20&15]+Wp[r>>16&15]+Wp[r>>12&15]+Wp[r>>8&15]+Wp[r>>4&15]+Wp[15&r]+Wp[a>>28&15]+Wp[a>>24&15]+Wp[a>>20&15]+Wp[a>>16&15]+Wp[a>>12&15]+Wp[a>>8&15]+Wp[a>>4&15]+Wp[15&a]},Gp.prototype.toString=Gp.prototype.hex,Gp.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,a=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24&255,r>>16&255,r>>8&255,255&r,a>>24&255,a>>16&255,a>>8&255,255&a]},Gp.prototype.array=Gp.prototype.digest,Gp.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};const Xp=(...e)=>{return t=e.join("_"),new Gp(!0).update(t).hex();var t};class Yp{}const Qp=new Map;class em extends Yp{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Xp(e,t))??null)}async update(e,t,n){this.cache.set(Xp(e,t),n)}static global(){return new em(Qp)}}class tm extends _p{}class nm extends tm{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Tp(this.value)]}}class rm extends tm{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Mp(this.messages)}toChatMessages(){return this.messages}}var am=a(201),im=a(425);const sm=[400,401,402,403,404,405,406,407,409],om=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&sm.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class cm{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??om;const t=im.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>am((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}var um=a(991),lm=Object.defineProperty;function dm(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let n=Array.from({length:e.length},((e,t)=>({start:t,end:t+1})));for(;n.length>1;){let r=null;for(let a=0;a<n.length-1;a++){const i=e.slice(n[a].start,n[a+1].end),s=t.get(i.join(","));null!=s&&(null==r||s<r[0])&&(r=[s,a])}if(null==r)break;{const e=r[1];n[e]={start:n[e].start,end:n[e+1].end},n.splice(e+1,1)}}return n}(e,t).map((n=>t.get(e.slice(n.start,n.end).join(",")))).filter((e=>null!=e))}var hm,fm,pm=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const n=e.bpe_ranks.split("\n").filter(Boolean).reduce(((e,t)=>{const[n,r,...a]=t.split(" "),i=Number.parseInt(r,10);return a.forEach(((t,n)=>e[t]=i+n)),e}),{});for(const[e,t]of Object.entries(n)){const n=um.toByteArray(e);this.rankMap.set(n.join(","),t),this.textMap.set(t,n)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce(((e,[t,n])=>(e[n]=this.textEncoder.encode(t),e)),{})}encode(e,t=[],n="all"){const r=new RegExp(this.patStr,"ug"),a=pm.specialTokenRegex(Object.keys(this.specialTokens)),i=[],s=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===n?Object.keys(this.specialTokens).filter((e=>!s.has(e))):n);if(o.size>0){const t=pm.specialTokenRegex([...o]),n=e.match(t);if(null!=n)throw new Error(`The text contains a special token that is not allowed: ${n[0]}`)}let c=0;for(;;){let t=null,n=c;for(;a.lastIndex=n,t=a.exec(e),null!=t&&!s.has(t[0]);)n=t.index+1;const o=t?.index??e.length;for(const t of e.substring(c,o).matchAll(r)){const e=this.textEncoder.encode(t[0]),n=this.rankMap.get(e.join(","));null==n?i.push(...dm(e,this.rankMap)):i.push(n)}if(null==t)break;let u=this.specialTokens[t[0]];i.push(u),c=t.index+t[0].length}return i}decode(e){const t=[];let n=0;for(let r=0;r<e.length;++r){const a=e[r],i=this.textMap.get(a)??this.inverseSpecialTokens[a];null!=i&&(t.push(i),n+=i.length)}const r=new Uint8Array(n);let a=0;for(const e of t)r.set(e,a),a+=e.length;return this.textDecoder.decode(r)}},mm=pm;fm=e=>new RegExp(e.map((e=>function(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}(e))).join("|"),"g"),((e,t,n)=>{t in e?lm(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(mm,"symbol"!=typeof(hm="specialTokenRegex")?hm+"":hm,fm);const gm={},ym=new cm({});var _m,bm;!function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter((e=>"number"!=typeof t[t[e]])),r={};for(const e of n)r[e]=t[e];return e.objectValues(r)},e.objectValues=t=>e.objectKeys(t).map((function(e){return t[e]})),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map((e=>"string"==typeof e?`'${e}'`:e)).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(_m||(_m={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(bm||(bm={}));const vm=_m.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),wm=e=>{switch(typeof e){case"undefined":return vm.undefined;case"string":return vm.string;case"number":return isNaN(e)?vm.nan:vm.number;case"boolean":return vm.boolean;case"function":return vm.function;case"bigint":return vm.bigint;case"symbol":return vm.symbol;case"object":return Array.isArray(e)?vm.array:null===e?vm.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?vm.promise:"undefined"!=typeof Map&&e instanceof Map?vm.map:"undefined"!=typeof Set&&e instanceof Set?vm.set:"undefined"!=typeof Date&&e instanceof Date?vm.date:vm.object;default:return vm.unknown}},xm=_m.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class km extends Error{constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(e){return e.message},n={_errors:[]},r=e=>{for(const a of e.issues)if("invalid_union"===a.code)a.unionErrors.map(r);else if("invalid_return_type"===a.code)r(a.returnTypeError);else if("invalid_arguments"===a.code)r(a.argumentsError);else if(0===a.path.length)n._errors.push(t(a));else{let e=n,r=0;for(;r<a.path.length;){const n=a.path[r];r===a.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(a))):e[n]=e[n]||{_errors:[]},e=e[n],r++}}};return r(this),n}static assert(e){if(!(e instanceof km))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,_m.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=(e=>e.message)){const t={},n=[];for(const r of this.issues)r.path.length>0?(t[r.path[0]]=t[r.path[0]]||[],t[r.path[0]].push(e(r))):n.push(e(r));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}km.create=e=>new km(e);const Om=(e,t)=>{let n;switch(e.code){case xm.invalid_type:n=e.received===vm.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case xm.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,_m.jsonStringifyReplacer)}`;break;case xm.unrecognized_keys:n=`Unrecognized key(s) in object: ${_m.joinValues(e.keys,", ")}`;break;case xm.invalid_union:n="Invalid input";break;case xm.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${_m.joinValues(e.options)}`;break;case xm.invalid_enum_value:n=`Invalid enum value. Expected ${_m.joinValues(e.options)}, received '${e.received}'`;break;case xm.invalid_arguments:n="Invalid function arguments";break;case xm.invalid_return_type:n="Invalid function return type";break;case xm.invalid_date:n="Invalid date";break;case xm.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:_m.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case xm.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case xm.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case xm.custom:n="Invalid input";break;case xm.invalid_intersection_types:n="Intersection results could not be merged";break;case xm.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case xm.not_finite:n="Number must be finite";break;default:n=t.defaultError,_m.assertNever(e)}return{message:n}};let Am=Om;function Sm(){return Am}const Pm=e=>{const{data:t,path:n,errorMaps:r,issueData:a}=e,i=[...n,...a.path||[]],s={...a,path:i};if(void 0!==a.message)return{...a,path:i,message:a.message};let o="";const c=r.filter((e=>!!e)).slice().reverse();for(const e of c)o=e(s,{data:t,defaultError:o}).message;return{...a,path:i,message:o}};function Em(e,t){const n=Sm(),r=Pm({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===Om?void 0:Om].filter((e=>!!e))});e.common.issues.push(r)}class Im{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const r of t){if("aborted"===r.status)return jm;"dirty"===r.status&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,r=await e.value;n.push({key:t,value:r})}return Im.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const r of t){const{key:t,value:a}=r;if("aborted"===t.status)return jm;if("aborted"===a.status)return jm;"dirty"===t.status&&e.dirty(),"dirty"===a.status&&e.dirty(),"__proto__"===t.value||void 0===a.value&&!r.alwaysSet||(n[t.value]=a.value)}return{status:e.value,value:n}}}const jm=Object.freeze({status:"aborted"}),Tm=e=>({status:"dirty",value:e}),Nm=e=>({status:"valid",value:e}),Cm=e=>"aborted"===e.status,Rm=e=>"dirty"===e.status,$m=e=>"valid"===e.status,Mm=e=>"undefined"!=typeof Promise&&e instanceof Promise;function Lm(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function Dm(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n}var Um,Bm,Fm;"function"==typeof SuppressedError&&SuppressedError,function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(Um||(Um={}));class zm{constructor(e,t,n,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=r}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Zm=(e,t)=>{if($m(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new km(e.common.issues);return this._error=t,this._error}}};function qm(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:r,description:a}=e;if(t&&(n||r))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:a}:{errorMap:(t,a)=>{var i,s;const{message:o}=e;return"invalid_enum_value"===t.code?{message:null!=o?o:a.defaultError}:void 0===a.data?{message:null!==(i=null!=o?o:r)&&void 0!==i?i:a.defaultError}:"invalid_type"!==t.code?{message:a.defaultError}:{message:null!==(s=null!=o?o:n)&&void 0!==s?s:a.defaultError}},description:a}}class Hm{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return wm(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:wm(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Im,ctx:{common:e.parent.common,data:e.data,parsedType:wm(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Mm(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;const r={common:{issues:[],async:null!==(n=null==t?void 0:t.async)&&void 0!==n&&n,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:wm(e)},a=this._parseSync({data:e,path:r.path,parent:r});return Zm(r,a)}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:wm(e)},r=this._parse({data:e,path:n.path,parent:n}),a=await(Mm(r)?r:Promise.resolve(r));return Zm(n,a)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement(((t,r)=>{const a=e(t),i=()=>r.addIssue({code:xm.custom,...n(t)});return"undefined"!=typeof Promise&&a instanceof Promise?a.then((e=>!!e||(i(),!1))):!!a||(i(),!1)}))}refinement(e,t){return this._refinement(((n,r)=>!!e(n)||(r.addIssue("function"==typeof t?t(n,r):t),!1)))}_refinement(e){return new Ug({schema:this,typeName:Xg.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return Bg.create(this,this._def)}nullable(){return Fg.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return vg.create(this,this._def)}promise(){return Dg.create(this,this._def)}or(e){return kg.create([this,e],this._def)}and(e){return Pg.create(this,e,this._def)}transform(e){return new Ug({...qm(this._def),schema:this,typeName:Xg.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new zg({...qm(this._def),innerType:this,defaultValue:t,typeName:Xg.ZodDefault})}brand(){return new Wg({typeName:Xg.ZodBranded,type:this,...qm(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new Zg({...qm(this._def),innerType:this,catchValue:t,typeName:Xg.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return Jg.create(this,e)}readonly(){return Kg.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Wm=/^c[^\s-]{8,}$/i,Jm=/^[0-9a-z]+$/,Km=/^[0-9A-HJKMNP-TV-Z]{26}$/,Vm=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Gm=/^[a-z0-9_-]{21}$/i,Xm=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Ym=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let Qm;const eg=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,tg=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ng=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,rg="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",ag=new RegExp(`^${rg}$`);function ig(e){let t="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),t}function sg(e){let t=`${rg}T${ig(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}class og extends Hm{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==vm.string){const t=this._getOrReturnCtx(e);return Em(t,{code:xm.invalid_type,expected:vm.string,received:t.parsedType}),jm}const t=new Im;let n;for(const i of this._def.checks)if("min"===i.kind)e.data.length<i.value&&(n=this._getOrReturnCtx(e,n),Em(n,{code:xm.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),t.dirty());else if("max"===i.kind)e.data.length>i.value&&(n=this._getOrReturnCtx(e,n),Em(n,{code:xm.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),t.dirty());else if("length"===i.kind){const r=e.data.length>i.value,a=e.data.length<i.value;(r||a)&&(n=this._getOrReturnCtx(e,n),r?Em(n,{code:xm.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):a&&Em(n,{code:xm.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),t.dirty())}else if("email"===i.kind)Ym.test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{validation:"email",code:xm.invalid_string,message:i.message}),t.dirty());else if("emoji"===i.kind)Qm||(Qm=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Qm.test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{validation:"emoji",code:xm.invalid_string,message:i.message}),t.dirty());else if("uuid"===i.kind)Vm.test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{validation:"uuid",code:xm.invalid_string,message:i.message}),t.dirty());else if("nanoid"===i.kind)Gm.test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{validation:"nanoid",code:xm.invalid_string,message:i.message}),t.dirty());else if("cuid"===i.kind)Wm.test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{validation:"cuid",code:xm.invalid_string,message:i.message}),t.dirty());else if("cuid2"===i.kind)Jm.test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{validation:"cuid2",code:xm.invalid_string,message:i.message}),t.dirty());else if("ulid"===i.kind)Km.test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{validation:"ulid",code:xm.invalid_string,message:i.message}),t.dirty());else if("url"===i.kind)try{new URL(e.data)}catch(r){n=this._getOrReturnCtx(e,n),Em(n,{validation:"url",code:xm.invalid_string,message:i.message}),t.dirty()}else"regex"===i.kind?(i.regex.lastIndex=0,i.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{validation:"regex",code:xm.invalid_string,message:i.message}),t.dirty())):"trim"===i.kind?e.data=e.data.trim():"includes"===i.kind?e.data.includes(i.value,i.position)||(n=this._getOrReturnCtx(e,n),Em(n,{code:xm.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),t.dirty()):"toLowerCase"===i.kind?e.data=e.data.toLowerCase():"toUpperCase"===i.kind?e.data=e.data.toUpperCase():"startsWith"===i.kind?e.data.startsWith(i.value)||(n=this._getOrReturnCtx(e,n),Em(n,{code:xm.invalid_string,validation:{startsWith:i.value},message:i.message}),t.dirty()):"endsWith"===i.kind?e.data.endsWith(i.value)||(n=this._getOrReturnCtx(e,n),Em(n,{code:xm.invalid_string,validation:{endsWith:i.value},message:i.message}),t.dirty()):"datetime"===i.kind?sg(i).test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{code:xm.invalid_string,validation:"datetime",message:i.message}),t.dirty()):"date"===i.kind?ag.test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{code:xm.invalid_string,validation:"date",message:i.message}),t.dirty()):"time"===i.kind?new RegExp(`^${ig(i)}$`).test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{code:xm.invalid_string,validation:"time",message:i.message}),t.dirty()):"duration"===i.kind?Xm.test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{validation:"duration",code:xm.invalid_string,message:i.message}),t.dirty()):"ip"===i.kind?(r=e.data,("v4"!==(a=i.version)&&a||!eg.test(r))&&("v6"!==a&&a||!tg.test(r))&&(n=this._getOrReturnCtx(e,n),Em(n,{validation:"ip",code:xm.invalid_string,message:i.message}),t.dirty())):"base64"===i.kind?ng.test(e.data)||(n=this._getOrReturnCtx(e,n),Em(n,{validation:"base64",code:xm.invalid_string,message:i.message}),t.dirty()):_m.assertNever(i);var r,a;return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement((t=>e.test(t)),{validation:t,code:xm.invalid_string,...Um.errToObj(n)})}_addCheck(e){return new og({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...Um.errToObj(e)})}url(e){return this._addCheck({kind:"url",...Um.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...Um.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...Um.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...Um.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...Um.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...Um.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...Um.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...Um.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...Um.errToObj(e)})}datetime(e){var t,n;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(n=null==e?void 0:e.local)&&void 0!==n&&n,...Um.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...Um.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...Um.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...Um.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...Um.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...Um.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...Um.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...Um.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...Um.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...Um.errToObj(t)})}nonempty(e){return this.min(1,Um.errToObj(e))}trim(){return new og({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new og({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new og({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find((e=>"datetime"===e.kind))}get isDate(){return!!this._def.checks.find((e=>"date"===e.kind))}get isTime(){return!!this._def.checks.find((e=>"time"===e.kind))}get isDuration(){return!!this._def.checks.find((e=>"duration"===e.kind))}get isEmail(){return!!this._def.checks.find((e=>"email"===e.kind))}get isURL(){return!!this._def.checks.find((e=>"url"===e.kind))}get isEmoji(){return!!this._def.checks.find((e=>"emoji"===e.kind))}get isUUID(){return!!this._def.checks.find((e=>"uuid"===e.kind))}get isNANOID(){return!!this._def.checks.find((e=>"nanoid"===e.kind))}get isCUID(){return!!this._def.checks.find((e=>"cuid"===e.kind))}get isCUID2(){return!!this._def.checks.find((e=>"cuid2"===e.kind))}get isULID(){return!!this._def.checks.find((e=>"ulid"===e.kind))}get isIP(){return!!this._def.checks.find((e=>"ip"===e.kind))}get isBase64(){return!!this._def.checks.find((e=>"base64"===e.kind))}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function cg(e,t){const n=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,a=n>r?n:r;return parseInt(e.toFixed(a).replace(".",""))%parseInt(t.toFixed(a).replace(".",""))/Math.pow(10,a)}og.create=e=>{var t;return new og({checks:[],typeName:Xg.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...qm(e)})};class ug extends Hm{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==vm.number){const t=this._getOrReturnCtx(e);return Em(t,{code:xm.invalid_type,expected:vm.number,received:t.parsedType}),jm}let t;const n=new Im;for(const r of this._def.checks)"int"===r.kind?_m.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),Em(t,{code:xm.invalid_type,expected:"integer",received:"float",message:r.message}),n.dirty()):"min"===r.kind?(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),Em(t,{code:xm.too_small,minimum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty()):"max"===r.kind?(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),Em(t,{code:xm.too_big,maximum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty()):"multipleOf"===r.kind?0!==cg(e.data,r.value)&&(t=this._getOrReturnCtx(e,t),Em(t,{code:xm.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):"finite"===r.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),Em(t,{code:xm.not_finite,message:r.message}),n.dirty()):_m.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,Um.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Um.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Um.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Um.toString(t))}setLimit(e,t,n,r){return new ug({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Um.toString(r)}]})}_addCheck(e){return new ug({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:Um.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:Um.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:Um.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:Um.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:Um.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Um.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:Um.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:Um.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:Um.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find((e=>"int"===e.kind||"multipleOf"===e.kind&&_m.isInteger(e.value)))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}ug.create=e=>new ug({checks:[],typeName:Xg.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...qm(e)});class lg extends Hm{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==vm.bigint){const t=this._getOrReturnCtx(e);return Em(t,{code:xm.invalid_type,expected:vm.bigint,received:t.parsedType}),jm}let t;const n=new Im;for(const r of this._def.checks)"min"===r.kind?(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),Em(t,{code:xm.too_small,type:"bigint",minimum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty()):"max"===r.kind?(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),Em(t,{code:xm.too_big,type:"bigint",maximum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty()):"multipleOf"===r.kind?e.data%r.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),Em(t,{code:xm.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):_m.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,Um.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Um.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Um.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Um.toString(t))}setLimit(e,t,n,r){return new lg({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Um.toString(r)}]})}_addCheck(e){return new lg({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:Um.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:Um.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:Um.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:Um.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Um.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}lg.create=e=>{var t;return new lg({checks:[],typeName:Xg.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...qm(e)})};class dg extends Hm{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==vm.boolean){const t=this._getOrReturnCtx(e);return Em(t,{code:xm.invalid_type,expected:vm.boolean,received:t.parsedType}),jm}return Nm(e.data)}}dg.create=e=>new dg({typeName:Xg.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...qm(e)});class hg extends Hm{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==vm.date){const t=this._getOrReturnCtx(e);return Em(t,{code:xm.invalid_type,expected:vm.date,received:t.parsedType}),jm}if(isNaN(e.data.getTime()))return Em(this._getOrReturnCtx(e),{code:xm.invalid_date}),jm;const t=new Im;let n;for(const r of this._def.checks)"min"===r.kind?e.data.getTime()<r.value&&(n=this._getOrReturnCtx(e,n),Em(n,{code:xm.too_small,message:r.message,inclusive:!0,exact:!1,minimum:r.value,type:"date"}),t.dirty()):"max"===r.kind?e.data.getTime()>r.value&&(n=this._getOrReturnCtx(e,n),Em(n,{code:xm.too_big,message:r.message,inclusive:!0,exact:!1,maximum:r.value,type:"date"}),t.dirty()):_m.assertNever(r);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new hg({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:Um.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:Um.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}hg.create=e=>new hg({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:Xg.ZodDate,...qm(e)});class fg extends Hm{_parse(e){if(this._getType(e)!==vm.symbol){const t=this._getOrReturnCtx(e);return Em(t,{code:xm.invalid_type,expected:vm.symbol,received:t.parsedType}),jm}return Nm(e.data)}}fg.create=e=>new fg({typeName:Xg.ZodSymbol,...qm(e)});class pg extends Hm{_parse(e){if(this._getType(e)!==vm.undefined){const t=this._getOrReturnCtx(e);return Em(t,{code:xm.invalid_type,expected:vm.undefined,received:t.parsedType}),jm}return Nm(e.data)}}pg.create=e=>new pg({typeName:Xg.ZodUndefined,...qm(e)});class mg extends Hm{_parse(e){if(this._getType(e)!==vm.null){const t=this._getOrReturnCtx(e);return Em(t,{code:xm.invalid_type,expected:vm.null,received:t.parsedType}),jm}return Nm(e.data)}}mg.create=e=>new mg({typeName:Xg.ZodNull,...qm(e)});class gg extends Hm{constructor(){super(...arguments),this._any=!0}_parse(e){return Nm(e.data)}}gg.create=e=>new gg({typeName:Xg.ZodAny,...qm(e)});class yg extends Hm{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Nm(e.data)}}yg.create=e=>new yg({typeName:Xg.ZodUnknown,...qm(e)});class _g extends Hm{_parse(e){const t=this._getOrReturnCtx(e);return Em(t,{code:xm.invalid_type,expected:vm.never,received:t.parsedType}),jm}}_g.create=e=>new _g({typeName:Xg.ZodNever,...qm(e)});class bg extends Hm{_parse(e){if(this._getType(e)!==vm.undefined){const t=this._getOrReturnCtx(e);return Em(t,{code:xm.invalid_type,expected:vm.void,received:t.parsedType}),jm}return Nm(e.data)}}bg.create=e=>new bg({typeName:Xg.ZodVoid,...qm(e)});class vg extends Hm{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),r=this._def;if(t.parsedType!==vm.array)return Em(t,{code:xm.invalid_type,expected:vm.array,received:t.parsedType}),jm;if(null!==r.exactLength){const e=t.data.length>r.exactLength.value,a=t.data.length<r.exactLength.value;(e||a)&&(Em(t,{code:e?xm.too_big:xm.too_small,minimum:a?r.exactLength.value:void 0,maximum:e?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty())}if(null!==r.minLength&&t.data.length<r.minLength.value&&(Em(t,{code:xm.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),null!==r.maxLength&&t.data.length>r.maxLength.value&&(Em(t,{code:xm.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map(((e,n)=>r.type._parseAsync(new zm(t,e,t.path,n))))).then((e=>Im.mergeArray(n,e)));const a=[...t.data].map(((e,n)=>r.type._parseSync(new zm(t,e,t.path,n))));return Im.mergeArray(n,a)}get element(){return this._def.type}min(e,t){return new vg({...this._def,minLength:{value:e,message:Um.toString(t)}})}max(e,t){return new vg({...this._def,maxLength:{value:e,message:Um.toString(t)}})}length(e,t){return new vg({...this._def,exactLength:{value:e,message:Um.toString(t)}})}nonempty(e){return this.min(1,e)}}function wg(e){if(e instanceof xg){const t={};for(const n in e.shape){const r=e.shape[n];t[n]=Bg.create(wg(r))}return new xg({...e._def,shape:()=>t})}return e instanceof vg?new vg({...e._def,type:wg(e.element)}):e instanceof Bg?Bg.create(wg(e.unwrap())):e instanceof Fg?Fg.create(wg(e.unwrap())):e instanceof Eg?Eg.create(e.items.map((e=>wg(e)))):e}vg.create=(e,t)=>new vg({type:e,minLength:null,maxLength:null,exactLength:null,typeName:Xg.ZodArray,...qm(t)});class xg extends Hm{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=_m.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==vm.object){const t=this._getOrReturnCtx(e);return Em(t,{code:xm.invalid_type,expected:vm.object,received:t.parsedType}),jm}const{status:t,ctx:n}=this._processInputParams(e),{shape:r,keys:a}=this._getCached(),i=[];if(!(this._def.catchall instanceof _g&&"strip"===this._def.unknownKeys))for(const e in n.data)a.includes(e)||i.push(e);const s=[];for(const e of a){const t=r[e],a=n.data[e];s.push({key:{status:"valid",value:e},value:t._parse(new zm(n,a,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof _g){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of i)s.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)i.length>0&&(Em(n,{code:xm.unrecognized_keys,keys:i}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of i){const r=n.data[t];s.push({key:{status:"valid",value:t},value:e._parse(new zm(n,r,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then((async()=>{const e=[];for(const t of s){const n=await t.key,r=await t.value;e.push({key:n,value:r,alwaysSet:t.alwaysSet})}return e})).then((e=>Im.mergeObjectSync(t,e))):Im.mergeObjectSync(t,s)}get shape(){return this._def.shape()}strict(e){return Um.errToObj,new xg({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{var r,a,i,s;const o=null!==(i=null===(a=(r=this._def).errorMap)||void 0===a?void 0:a.call(r,t,n).message)&&void 0!==i?i:n.defaultError;return"unrecognized_keys"===t.code?{message:null!==(s=Um.errToObj(e).message)&&void 0!==s?s:o}:{message:o}}}:{}})}strip(){return new xg({...this._def,unknownKeys:"strip"})}passthrough(){return new xg({...this._def,unknownKeys:"passthrough"})}extend(e){return new xg({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new xg({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:Xg.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new xg({...this._def,catchall:e})}pick(e){const t={};return _m.objectKeys(e).forEach((n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])})),new xg({...this._def,shape:()=>t})}omit(e){const t={};return _m.objectKeys(this.shape).forEach((n=>{e[n]||(t[n]=this.shape[n])})),new xg({...this._def,shape:()=>t})}deepPartial(){return wg(this)}partial(e){const t={};return _m.objectKeys(this.shape).forEach((n=>{const r=this.shape[n];e&&!e[n]?t[n]=r:t[n]=r.optional()})),new xg({...this._def,shape:()=>t})}required(e){const t={};return _m.objectKeys(this.shape).forEach((n=>{if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof Bg;)e=e._def.innerType;t[n]=e}})),new xg({...this._def,shape:()=>t})}keyof(){return $g(_m.objectKeys(this.shape))}}xg.create=(e,t)=>new xg({shape:()=>e,unknownKeys:"strip",catchall:_g.create(),typeName:Xg.ZodObject,...qm(t)}),xg.strictCreate=(e,t)=>new xg({shape:()=>e,unknownKeys:"strict",catchall:_g.create(),typeName:Xg.ZodObject,...qm(t)}),xg.lazycreate=(e,t)=>new xg({shape:e,unknownKeys:"strip",catchall:_g.create(),typeName:Xg.ZodObject,...qm(t)});class kg extends Hm{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map((async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}}))).then((function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map((e=>new km(e.ctx.common.issues)));return Em(t,{code:xm.invalid_union,unionErrors:n}),jm}));{let e;const r=[];for(const a of n){const n={...t,common:{...t.common,issues:[]},parent:null},i=a._parseSync({data:t.data,path:t.path,parent:n});if("valid"===i.status)return i;"dirty"!==i.status||e||(e={result:i,ctx:n}),n.common.issues.length&&r.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const a=r.map((e=>new km(e)));return Em(t,{code:xm.invalid_union,unionErrors:a}),jm}}get options(){return this._def.options}}kg.create=(e,t)=>new kg({options:e,typeName:Xg.ZodUnion,...qm(t)});const Og=e=>e instanceof Cg?Og(e.schema):e instanceof Ug?Og(e.innerType()):e instanceof Rg?[e.value]:e instanceof Mg?e.options:e instanceof Lg?_m.objectValues(e.enum):e instanceof zg?Og(e._def.innerType):e instanceof pg?[void 0]:e instanceof mg?[null]:e instanceof Bg?[void 0,...Og(e.unwrap())]:e instanceof Fg?[null,...Og(e.unwrap())]:e instanceof Wg||e instanceof Kg?Og(e.unwrap()):e instanceof Zg?Og(e._def.innerType):[];class Ag extends Hm{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==vm.object)return Em(t,{code:xm.invalid_type,expected:vm.object,received:t.parsedType}),jm;const n=this.discriminator,r=t.data[n],a=this.optionsMap.get(r);return a?t.common.async?a._parseAsync({data:t.data,path:t.path,parent:t}):a._parseSync({data:t.data,path:t.path,parent:t}):(Em(t,{code:xm.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),jm)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const r=new Map;for(const n of t){const t=Og(n.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const a of t){if(r.has(a))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(a)}`);r.set(a,n)}}return new Ag({typeName:Xg.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:r,...qm(n)})}}function Sg(e,t){const n=wm(e),r=wm(t);if(e===t)return{valid:!0,data:e};if(n===vm.object&&r===vm.object){const n=_m.objectKeys(t),r=_m.objectKeys(e).filter((e=>-1!==n.indexOf(e))),a={...e,...t};for(const n of r){const r=Sg(e[n],t[n]);if(!r.valid)return{valid:!1};a[n]=r.data}return{valid:!0,data:a}}if(n===vm.array&&r===vm.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let r=0;r<e.length;r++){const a=Sg(e[r],t[r]);if(!a.valid)return{valid:!1};n.push(a.data)}return{valid:!0,data:n}}return n===vm.date&&r===vm.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}class Pg extends Hm{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=(e,r)=>{if(Cm(e)||Cm(r))return jm;const a=Sg(e.value,r.value);return a.valid?((Rm(e)||Rm(r))&&t.dirty(),{status:t.value,value:a.data}):(Em(n,{code:xm.invalid_intersection_types}),jm)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then((([e,t])=>r(e,t))):r(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}Pg.create=(e,t,n)=>new Pg({left:e,right:t,typeName:Xg.ZodIntersection,...qm(n)});class Eg extends Hm{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==vm.array)return Em(n,{code:xm.invalid_type,expected:vm.array,received:n.parsedType}),jm;if(n.data.length<this._def.items.length)return Em(n,{code:xm.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),jm;!this._def.rest&&n.data.length>this._def.items.length&&(Em(n,{code:xm.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const r=[...n.data].map(((e,t)=>{const r=this._def.items[t]||this._def.rest;return r?r._parse(new zm(n,e,n.path,t)):null})).filter((e=>!!e));return n.common.async?Promise.all(r).then((e=>Im.mergeArray(t,e))):Im.mergeArray(t,r)}get items(){return this._def.items}rest(e){return new Eg({...this._def,rest:e})}}Eg.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Eg({items:e,typeName:Xg.ZodTuple,rest:null,...qm(t)})};class Ig extends Hm{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==vm.object)return Em(n,{code:xm.invalid_type,expected:vm.object,received:n.parsedType}),jm;const r=[],a=this._def.keyType,i=this._def.valueType;for(const e in n.data)r.push({key:a._parse(new zm(n,e,n.path,e)),value:i._parse(new zm(n,n.data[e],n.path,e)),alwaysSet:e in n.data});return n.common.async?Im.mergeObjectAsync(t,r):Im.mergeObjectSync(t,r)}get element(){return this._def.valueType}static create(e,t,n){return new Ig(t instanceof Hm?{keyType:e,valueType:t,typeName:Xg.ZodRecord,...qm(n)}:{keyType:og.create(),valueType:e,typeName:Xg.ZodRecord,...qm(t)})}}class jg extends Hm{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==vm.map)return Em(n,{code:xm.invalid_type,expected:vm.map,received:n.parsedType}),jm;const r=this._def.keyType,a=this._def.valueType,i=[...n.data.entries()].map((([e,t],i)=>({key:r._parse(new zm(n,e,n.path,[i,"key"])),value:a._parse(new zm(n,t,n.path,[i,"value"]))})));if(n.common.async){const e=new Map;return Promise.resolve().then((async()=>{for(const n of i){const r=await n.key,a=await n.value;if("aborted"===r.status||"aborted"===a.status)return jm;"dirty"!==r.status&&"dirty"!==a.status||t.dirty(),e.set(r.value,a.value)}return{status:t.value,value:e}}))}{const e=new Map;for(const n of i){const r=n.key,a=n.value;if("aborted"===r.status||"aborted"===a.status)return jm;"dirty"!==r.status&&"dirty"!==a.status||t.dirty(),e.set(r.value,a.value)}return{status:t.value,value:e}}}}jg.create=(e,t,n)=>new jg({valueType:t,keyType:e,typeName:Xg.ZodMap,...qm(n)});class Tg extends Hm{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==vm.set)return Em(n,{code:xm.invalid_type,expected:vm.set,received:n.parsedType}),jm;const r=this._def;null!==r.minSize&&n.data.size<r.minSize.value&&(Em(n,{code:xm.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),t.dirty()),null!==r.maxSize&&n.data.size>r.maxSize.value&&(Em(n,{code:xm.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),t.dirty());const a=this._def.valueType;function i(e){const n=new Set;for(const r of e){if("aborted"===r.status)return jm;"dirty"===r.status&&t.dirty(),n.add(r.value)}return{status:t.value,value:n}}const s=[...n.data.values()].map(((e,t)=>a._parse(new zm(n,e,n.path,t))));return n.common.async?Promise.all(s).then((e=>i(e))):i(s)}min(e,t){return new Tg({...this._def,minSize:{value:e,message:Um.toString(t)}})}max(e,t){return new Tg({...this._def,maxSize:{value:e,message:Um.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Tg.create=(e,t)=>new Tg({valueType:e,minSize:null,maxSize:null,typeName:Xg.ZodSet,...qm(t)});class Ng extends Hm{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==vm.function)return Em(t,{code:xm.invalid_type,expected:vm.function,received:t.parsedType}),jm;function n(e,n){return Pm({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Sm(),Om].filter((e=>!!e)),issueData:{code:xm.invalid_arguments,argumentsError:n}})}function r(e,n){return Pm({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Sm(),Om].filter((e=>!!e)),issueData:{code:xm.invalid_return_type,returnTypeError:n}})}const a={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof Dg){const e=this;return Nm((async function(...t){const s=new km([]),o=await e._def.args.parseAsync(t,a).catch((e=>{throw s.addIssue(n(t,e)),s})),c=await Reflect.apply(i,this,o);return await e._def.returns._def.type.parseAsync(c,a).catch((e=>{throw s.addIssue(r(c,e)),s}))}))}{const e=this;return Nm((function(...t){const s=e._def.args.safeParse(t,a);if(!s.success)throw new km([n(t,s.error)]);const o=Reflect.apply(i,this,s.data),c=e._def.returns.safeParse(o,a);if(!c.success)throw new km([r(o,c.error)]);return c.data}))}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new Ng({...this._def,args:Eg.create(e).rest(yg.create())})}returns(e){return new Ng({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new Ng({args:e||Eg.create([]).rest(yg.create()),returns:t||yg.create(),typeName:Xg.ZodFunction,...qm(n)})}}class Cg extends Hm{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Cg.create=(e,t)=>new Cg({getter:e,typeName:Xg.ZodLazy,...qm(t)});class Rg extends Hm{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return Em(t,{received:t.data,code:xm.invalid_literal,expected:this._def.value}),jm}return{status:"valid",value:e.data}}get value(){return this._def.value}}function $g(e,t){return new Mg({values:e,typeName:Xg.ZodEnum,...qm(t)})}Rg.create=(e,t)=>new Rg({value:e,typeName:Xg.ZodLiteral,...qm(t)});class Mg extends Hm{constructor(){super(...arguments),Bm.set(this,void 0)}_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return Em(t,{expected:_m.joinValues(n),received:t.parsedType,code:xm.invalid_type}),jm}if(Lm(this,Bm,"f")||Dm(this,Bm,new Set(this._def.values),"f"),!Lm(this,Bm,"f").has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return Em(t,{received:t.data,code:xm.invalid_enum_value,options:n}),jm}return Nm(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Mg.create(e,{...this._def,...t})}exclude(e,t=this._def){return Mg.create(this.options.filter((t=>!e.includes(t))),{...this._def,...t})}}Bm=new WeakMap,Mg.create=$g;class Lg extends Hm{constructor(){super(...arguments),Fm.set(this,void 0)}_parse(e){const t=_m.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==vm.string&&n.parsedType!==vm.number){const e=_m.objectValues(t);return Em(n,{expected:_m.joinValues(e),received:n.parsedType,code:xm.invalid_type}),jm}if(Lm(this,Fm,"f")||Dm(this,Fm,new Set(_m.getValidEnumValues(this._def.values)),"f"),!Lm(this,Fm,"f").has(e.data)){const e=_m.objectValues(t);return Em(n,{received:n.data,code:xm.invalid_enum_value,options:e}),jm}return Nm(e.data)}get enum(){return this._def.values}}Fm=new WeakMap,Lg.create=(e,t)=>new Lg({values:e,typeName:Xg.ZodNativeEnum,...qm(t)});class Dg extends Hm{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==vm.promise&&!1===t.common.async)return Em(t,{code:xm.invalid_type,expected:vm.promise,received:t.parsedType}),jm;const n=t.parsedType===vm.promise?t.data:Promise.resolve(t.data);return Nm(n.then((e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap}))))}}Dg.create=(e,t)=>new Dg({type:e,typeName:Xg.ZodPromise,...qm(t)});class Ug extends Hm{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===Xg.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=this._def.effect||null,a={addIssue:e=>{Em(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(a.addIssue=a.addIssue.bind(a),"preprocess"===r.type){const e=r.transform(n.data,a);if(n.common.async)return Promise.resolve(e).then((async e=>{if("aborted"===t.value)return jm;const r=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===r.status?jm:"dirty"===r.status||"dirty"===t.value?Tm(r.value):r}));{if("aborted"===t.value)return jm;const r=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===r.status?jm:"dirty"===r.status||"dirty"===t.value?Tm(r.value):r}}if("refinement"===r.type){const e=e=>{const t=r.refinement(e,a);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const r=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===r.status?jm:("dirty"===r.status&&t.dirty(),e(r.value),{status:t.value,value:r.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((n=>"aborted"===n.status?jm:("dirty"===n.status&&t.dirty(),e(n.value).then((()=>({status:t.value,value:n.value}))))))}if("transform"===r.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!$m(e))return e;const i=r.transform(e.value,a);if(i instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:i}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((e=>$m(e)?Promise.resolve(r.transform(e.value,a)).then((e=>({status:t.value,value:e}))):e))}_m.assertNever(r)}}Ug.create=(e,t,n)=>new Ug({schema:e,typeName:Xg.ZodEffects,effect:t,...qm(n)}),Ug.createWithPreprocess=(e,t,n)=>new Ug({schema:t,effect:{type:"preprocess",transform:e},typeName:Xg.ZodEffects,...qm(n)});class Bg extends Hm{_parse(e){return this._getType(e)===vm.undefined?Nm(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Bg.create=(e,t)=>new Bg({innerType:e,typeName:Xg.ZodOptional,...qm(t)});class Fg extends Hm{_parse(e){return this._getType(e)===vm.null?Nm(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Fg.create=(e,t)=>new Fg({innerType:e,typeName:Xg.ZodNullable,...qm(t)});class zg extends Hm{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===vm.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}zg.create=(e,t)=>new zg({innerType:e,typeName:Xg.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...qm(t)});class Zg extends Hm{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Mm(r)?r.then((e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new km(n.common.issues)},input:n.data})}))):{status:"valid",value:"valid"===r.status?r.value:this._def.catchValue({get error(){return new km(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}Zg.create=(e,t)=>new Zg({innerType:e,typeName:Xg.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...qm(t)});class qg extends Hm{_parse(e){if(this._getType(e)!==vm.nan){const t=this._getOrReturnCtx(e);return Em(t,{code:xm.invalid_type,expected:vm.nan,received:t.parsedType}),jm}return{status:"valid",value:e.data}}}qg.create=e=>new qg({typeName:Xg.ZodNaN,...qm(e)});const Hg=Symbol("zod_brand");class Wg extends Hm{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class Jg extends Hm{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?jm:"dirty"===e.status?(t.dirty(),Tm(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})();{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?jm:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new Jg({in:e,out:t,typeName:Xg.ZodPipeline})}}class Kg extends Hm{_parse(e){const t=this._def.innerType._parse(e),n=e=>($m(e)&&(e.value=Object.freeze(e.value)),e);return Mm(t)?t.then((e=>n(e))):n(t)}unwrap(){return this._def.innerType}}function Vg(e,t={},n){return e?gg.create().superRefine(((r,a)=>{var i,s;if(!e(r)){const e="function"==typeof t?t(r):"string"==typeof t?{message:t}:t,o=null===(s=null!==(i=e.fatal)&&void 0!==i?i:n)||void 0===s||s,c="string"==typeof e?{message:e}:e;a.addIssue({code:"custom",...c,fatal:o})}})):gg.create()}Kg.create=(e,t)=>new Kg({innerType:e,typeName:Xg.ZodReadonly,...qm(t)});const Gg={object:xg.lazycreate};var Xg;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(Xg||(Xg={}));const Yg=og.create,Qg=ug.create,ey=qg.create,ty=lg.create,ny=dg.create,ry=hg.create,ay=fg.create,iy=pg.create,sy=mg.create,oy=gg.create,cy=yg.create,uy=_g.create,ly=bg.create,dy=vg.create,hy=xg.create,fy=xg.strictCreate,py=kg.create,my=Ag.create,gy=Pg.create,yy=Eg.create,_y=Ig.create,by=jg.create,vy=Tg.create,wy=Ng.create,xy=Cg.create,ky=Rg.create,Oy=Mg.create,Ay=Lg.create,Sy=Dg.create,Py=Ug.create,Ey=Bg.create,Iy=Fg.create,jy=Ug.createWithPreprocess,Ty=Jg.create,Ny={string:e=>og.create({...e,coerce:!0}),number:e=>ug.create({...e,coerce:!0}),boolean:e=>dg.create({...e,coerce:!0}),bigint:e=>lg.create({...e,coerce:!0}),date:e=>hg.create({...e,coerce:!0})},Cy=jm;var Ry=Object.freeze({__proto__:null,defaultErrorMap:Om,setErrorMap:function(e){Am=e},getErrorMap:Sm,makeIssue:Pm,EMPTY_PATH:[],addIssueToContext:Em,ParseStatus:Im,INVALID:jm,DIRTY:Tm,OK:Nm,isAborted:Cm,isDirty:Rm,isValid:$m,isAsync:Mm,get util(){return _m},get objectUtil(){return bm},ZodParsedType:vm,getParsedType:wm,ZodType:Hm,datetimeRegex:sg,ZodString:og,ZodNumber:ug,ZodBigInt:lg,ZodBoolean:dg,ZodDate:hg,ZodSymbol:fg,ZodUndefined:pg,ZodNull:mg,ZodAny:gg,ZodUnknown:yg,ZodNever:_g,ZodVoid:bg,ZodArray:vg,ZodObject:xg,ZodUnion:kg,ZodDiscriminatedUnion:Ag,ZodIntersection:Pg,ZodTuple:Eg,ZodRecord:Ig,ZodMap:jg,ZodSet:Tg,ZodFunction:Ng,ZodLazy:Cg,ZodLiteral:Rg,ZodEnum:Mg,ZodNativeEnum:Lg,ZodPromise:Dg,ZodEffects:Ug,ZodTransformer:Ug,ZodOptional:Bg,ZodNullable:Fg,ZodDefault:zg,ZodCatch:Zg,ZodNaN:qg,BRAND:Hg,ZodBranded:Wg,ZodPipeline:Jg,ZodReadonly:Kg,custom:Vg,Schema:Hm,ZodSchema:Hm,late:Gg,get ZodFirstPartyTypeKind(){return Xg},coerce:Ny,any:oy,array:dy,bigint:ty,boolean:ny,date:ry,discriminatedUnion:my,effect:Py,enum:Oy,function:wy,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>Vg((t=>t instanceof e),t),intersection:gy,lazy:xy,literal:ky,map:by,nan:ey,nativeEnum:Ay,never:uy,null:sy,nullable:Iy,number:Qg,object:hy,oboolean:()=>ny().optional(),onumber:()=>Qg().optional(),optional:Ey,ostring:()=>Yg().optional(),pipeline:Ty,preprocess:jy,promise:Sy,record:_y,set:vy,strictObject:fy,string:Yg,symbol:ay,transformer:Py,tuple:yy,undefined:iy,union:py,unknown:cy,void:ly,NEVER:Cy,ZodIssueCode:xm,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:km});const $y={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let My;const Ly=new Uint8Array(16);function Dy(){if(!My&&(My="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!My))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return My(Ly)}const Uy=[];for(let e=0;e<256;++e)Uy.push((e+256).toString(16).slice(1));const By=function(e,t,n){if($y.randomUUID&&!t&&!e)return $y.randomUUID();const r=(e=e||{}).random||(e.rng||Dy)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return function(e,t=0){return Uy[e[t+0]]+Uy[e[t+1]]+Uy[e[t+2]]+Uy[e[t+3]]+"-"+Uy[e[t+4]]+Uy[e[t+5]]+"-"+Uy[e[t+6]]+Uy[e[t+7]]+"-"+Uy[e[t+8]]+Uy[e[t+9]]+"-"+Uy[e[t+10]]+Uy[e[t+11]]+Uy[e[t+12]]+Uy[e[t+13]]+Uy[e[t+14]]+Uy[e[t+15]]}(r)};class Fy{}class zy extends Fy{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,yp(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"true"!==qp("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.awaitHandlers=e._awaitHandler??this.awaitHandlers)}copy(){return new this.constructor(this)}toJSON(){return _p.prototype.toJSON.call(this)}toJSONNotImplemented(){return _p.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends zy{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:By()}),Object.assign(this,e)}}}}var Zy=a(749);function qy(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}class Hy extends zy{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){const t=function(e,t,n){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${r}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),n={...e};if(void 0!==n.parent_run_id){const e=this.runMap.get(n.parent_run_id);e&&(this._addChildRun(e,n),e.child_execution_order=Math.max(e.child_execution_order,n.child_execution_order),n.trace_id=e.trace_id,void 0!==e.dotted_order&&(n.dotted_order=[e.dotted_order,t].join(".")))}else n.trace_id=n.id,n.dotted_order=t;this.runMap.set(n.id,n),await(this.onRunCreate?.(n))}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,n,r,a,i,s,o){const c=this._getExecutionOrder(r),u=Date.now(),l=s?{...a,metadata:s}:a,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:l??{},tags:i||[]};return await this._startTrace(d),await(this.onLLMStart?.(d)),d}async handleChatModelStart(e,t,n,r,a,i,s,o){const c=this._getExecutionOrder(r),u=Date.now(),l=s?{...a,metadata:s}:a,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:l??{},tags:i||[]};return await this._startTrace(d),await(this.onLLMStart?.(d)),d}async handleLLMEnd(e,t){const n=this.runMap.get(t);if(!n||"llm"!==n?.run_type)throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.outputs=e,n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onLLMEnd?.(n)),await this._endTrace(n),n}async handleLLMError(e,t){const n=this.runMap.get(t);if(!n||"llm"!==n?.run_type)throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onLLMError?.(n)),await this._endTrace(n),n}async handleChainStart(e,t,n,r,a,i,s,o){const c=this._getExecutionOrder(r),u=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:s??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(l),await(this.onChainStart?.(l)),l}async handleChainEnd(e,t,n,r,a){const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=qy(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),void 0!==a?.inputs&&(i.inputs=qy(a.inputs,"input")),await(this.onChainEnd?.(i)),await this._endTrace(i),i}async handleChainError(e,t,n,r,a){const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),void 0!==a?.inputs&&(i.inputs=qy(a.inputs,"input")),await(this.onChainError?.(i)),await this._endTrace(i),i}async handleToolStart(e,t,n,r,a,i,s){const o=this._getExecutionOrder(r),c=Date.now(),u={id:n,name:s??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(u),await(this.onToolStart?.(u)),u}async handleToolEnd(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onToolEnd?.(n)),await this._endTrace(n),n}async handleToolError(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onToolError?.(n)),await this._endTrace(n),n}async handleAgentAction(e,t){const n=this.runMap.get(t);if(!n||"chain"!==n?.run_type)return;const r=n;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(n))}async handleAgentEnd(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(n)))}async handleRetrieverStart(e,t,n,r,a,i,s){const o=this._getExecutionOrder(r),c=Date.now(),u={id:n,name:s??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(u),await(this.onRetrieverStart?.(u)),u}async handleRetrieverEnd(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverEnd?.(n)),await this._endTrace(n),n}async handleRetrieverError(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverError?.(n)),await this._endTrace(n),n}async handleText(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(n)))}async handleLLMNewToken(e,t,n,r,a,i){const s=this.runMap.get(n);if(!s||"llm"!==s?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await(this.onLLMNewToken?.(s,e,{chunk:i?.chunk})),s}}function Wy(e,t){return`${e.open}${t}${e.close}`}function Jy(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function Ky(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:Vy}=Zy;class Gy extends Hy{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let n=e;for(;n.parent_run_id;){const e=this.runMap.get(n.parent_run_id);if(!e)break;t.push(e),n=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,n)=>{const r=`${e.execution_order}:${e.run_type}:${e.name}`;return t===n.length-1?Wy(Zy.bold,r):r})).join(" > ");return Wy(Vy.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Vy.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Jy(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Vy.cyan,"[chain/end]")} [${t}] [${Ky(e)}] Exiting Chain run with output: ${Jy(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Vy.red,"[chain/error]")} [${t}] [${Ky(e)}] Chain run errored with error: ${Jy(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${Wy(Vy.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Jy(n,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Vy.cyan,"[llm/end]")} [${t}] [${Ky(e)}] Exiting LLM run with output: ${Jy(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Vy.red,"[llm/error]")} [${t}] [${Ky(e)}] LLM run errored with error: ${Jy(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Vy.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Vy.cyan,"[tool/end]")} [${t}] [${Ky(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Vy.red,"[tool/error]")} [${t}] [${Ky(e)}] Tool run errored with error: ${Jy(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Vy.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Jy(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Vy.cyan,"[retriever/end]")} [${t}] [${Ky(e)}] Exiting Retriever run with output: ${Jy(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Vy.red,"[retriever/error]")} [${t}] [${Ky(e)}] Retriever run errored with error: ${Jy(e.error,"[error]")}`)}onAgentAction(e){const t=e,n=this.getBreadcrumbs(e);console.log(`${Wy(Vy.blue,"[agent/action]")} [${n}] Agent selected action: ${Jy(t.actions[t.actions.length-1],"[action]")}`)}}const Xy=[400,401,403,404,405,406,407,408],Yy=[409];class Qy{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.queue=new im.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const n=this.onFailedResponseHook;return this.queue.add((()=>am((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response,r=t?.status;if(r){if(Xy.includes(+r))throw e;if(Yy.includes(+r))return;n&&await n(t)}},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}function e_(e){return"function"==typeof e?._getType}function t_(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}let n_;const r_=()=>"undefined"!=typeof Deno;let a_,i_;function s_(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}const o_=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,c_=function(e){return"string"==typeof e&&o_.test(e)};function u_(e){if(!c_(e))throw new Error(`Invalid UUID: ${e}`)}async function l_(e){const t=await async function(){if(void 0===a_){const e=n_||(n_="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||r_()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":r_()?"deno":"other":"node",n_),t=function(){if(void 0!==i_)return i_;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const n of e){const e=s_(n);void 0!==e&&(t[n]=e)}return i_=t,t}();a_={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:g_,...t}}return a_}(),n=function(){const e=function(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce(((e,[t,n])=>(e[t]=String(n),e)),{}):void 0}catch(e){return}}()||{},t={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[r,a]of Object.entries(e))!r.startsWith("LANGCHAIN_")||"string"!=typeof a||n.includes(r)||r.toLowerCase().includes("key")||r.toLowerCase().includes("secret")||r.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===r?t.revision_id=a:t[r]=a);return t}();return e.map((e=>{const r=e.extra??{},a=r.metadata;return e.extra={...r,runtime:{...t,...r?.runtime},metadata:{...n,...n.revision_id||e.revision_id?{revision_id:e.revision_id??n.revision_id}:{},...a}},e}))}const d_=async(e,t)=>{const n=await e.text();if(!e.ok)throw new Error(`Failed to ${t}: ${e.status} ${e.statusText} ${n}`)};function h_(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const f_=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise((e=>setTimeout(e,t))),!0}return!1};class p_{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise((t=>{this.items.push([e,t])}))}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");const t=[];for(;t.length<e&&this.items.length;){const e=this.items.shift();if(!e)break;t.push(e)}return[t.map((e=>e[0])),()=>t.forEach((e=>e[1]()))]}}class m_{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new p_}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=m_.getDefaultClientConfig();this.tracingSampleRate=(()=>{const e=s_("LANGCHAIN_TRACING_SAMPLING_RATE");if(void 0===e)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t})(),this.apiUrl=h_(e.apiUrl??t.apiUrl)??"",this.apiKey=h_(e.apiKey??t.apiKey),this.webUrl=h_(e.webUrl??t.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new Qy(e.callerOptions??{}),this.batchIngestCaller=new Qy({...e.callerOptions??{},onFailedResponseHook:f_}),this.hideInputs=e.hideInputs??t.hideInputs,this.hideOutputs=e.hideOutputs??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){const e=s_("LANGCHAIN_API_KEY");return{apiUrl:s_("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===s_("LANGCHAIN_HIDE_INPUTS"),hideOutputs:"true"===s_("LANGCHAIN_HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(e=>{const t=this.apiUrl.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t})()?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${g_}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const n=t?.toString()??"",r=`${this.apiUrl}${e}?${n}`,a=await this.caller.call(fetch,r,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!a.ok)throw new Error(`Failed to fetch ${e}: ${a.status} ${a.statusText}`);return a}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let n=Number(t.get("offset"))||0;const r=Number(t.get("limit"))||100;for(;;){t.set("offset",String(n)),t.set("limit",String(r));const a=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);const s=await i.json();if(0===s.length)break;if(yield s,s.length<r)break;n+=s.length}}async*_getCursorPaginatedList(e,t=null,n="POST",r="runs"){const a=t?{...t}:{};for(;;){const t=await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)}),i=await t.json();if(!i)break;if(!i[r])break;yield i[r];const s=i.cursors;if(!s)break;if(!s.next)break;a.cursor=s.next}}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const n of e)this.sampledPostUuids.has(n.id)&&(t.push(n),this.sampledPostUuids.delete(n.id));return t}{const t=[];for(const n of e)Math.random()<this.tracingSampleRate&&(t.push(n),this.sampledPostUuids.add(n.id));return t}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){const[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length)return void t();try{await this.batchIngestRuns({runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))})}finally{t()}}}async processRunOperation(e,t){const n=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;const r=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)}),n?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),r}async _getServerInfo(){const e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch(e){return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},n=e.project_name;delete e.project_name;const r=this.prepareRunCreateOrUpdateInputs({session_name:n,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void this.processRunOperation({action:"create",item:r}).catch(console.error);const a=await l_([r]),i=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(a[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await d_(i,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let n=e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[],r=t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[];if(n.length>0&&r.length>0){const e=n.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const n of r)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);n=Object.values(e),r=t}const a={post:this._filterForSampling(n),patch:this._filterForSampling(r,!0)};if(!a.post.length&&!a.patch.length)return;if(n=await l_(n),void 0===this.batchEndpointSupported&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(const e of a.post)await this.createRun(e);for(const e of a.patch)void 0!==e.id&&await this.updateRun(e.id,e);return}const i=this.serverInfo?.batch_ingest_config?.size_limit_bytes??20971520,s={post:[],patch:[]};let o=0;for(const e of["post","patch"]){const t=e,n=a[t].reverse();let r=n.pop();for(;void 0!==r;){const e=JSON.stringify(r);o>0&&o+e.length>i&&(await this._postBatchIngestRuns(JSON.stringify(s)),o=0,s.post=[],s.patch=[]),o+=e.length,s[t].push(r),r=n.pop()}}(s.post.length>0||s.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(s))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},n=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await d_(n,"batch create run")}async updateRun(e,t){u_(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const n={...t,id:e};if(!this._filterForSampling([n],!0).length)return;if(this.autoBatchTracing&&void 0!==n.trace_id&&void 0!==n.dotted_order)return void 0!==t.end_time&&void 0===n.parent_run_id?void await this.processRunOperation({action:"update",item:n},!0):void this.processRunOperation({action:"update",item:n}).catch(console.error);const r={...this.headers,"Content-Type":"application/json"},a=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:r,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await d_(a,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){u_(e);let n=await this._get(`/runs/${e}`);return t&&n.child_run_ids&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(void 0!==t){let e;e=t.session_id?t.session_id:n?.projectName?(await this.readProject({projectName:n?.projectName})).id:n?.projectId?n?.projectId:(await this.readProject({projectName:s_("LANGCHAIN_PROJECT")||"default"})).id;const r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const n of e)t.push(n);return t}(this.listRuns({id:e.child_run_ids})),n={},r={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in n||(n[e.parent_run_id]=[]),n[e.parent_run_id].push(e),r[e.id]=e}e.child_runs=n[e.id]||[];for(const t in n)t!==e.id&&(r[t].child_runs=n[t]);return e}async*listRuns(e){const{projectId:t,projectName:n,parentRunId:r,traceId:a,referenceExampleId:i,startTime:s,executionOrder:o,isRoot:c,runType:u,error:l,id:d,query:h,filter:f,traceFilter:p,treeFilter:m,limit:g,select:y}=e;let _=[];if(t&&(_=Array.isArray(t)?t:[t]),n){const e=Array.isArray(n)?n:[n],t=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));_.push(...t)}const b={session:_.length?_:null,run_type:u,reference_example:i,query:h,filter:f,trace_filter:p,tree_filter:m,execution_order:o,parent_run:r,start_time:s?s.toISOString():null,error:l,id:d,limit:g,trace:a,select:y||["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:c};let v=0;for await(const e of this._getCursorPaginatedList("/runs/query",b))if(g){if(v>=g)break;if(e.length+v>g){const t=e.slice(0,g-v);yield*t;break}v+=e.length,yield*e}else yield*e}async shareRun(e,{shareId:t}={}){const n={run_id:e,share_token:t||By()};u_(e);const r=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await r.json();if(null===a||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){u_(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await d_(t,"unshare run")}async readRunSharedLink(e){u_(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await t.json();if(null!==n&&"share_token"in n)return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const n=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)n.append("id",e);u_(e);const r=await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await r.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),u_(e);const n=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await n.json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const n={dataset_id:e};u_(e);const r=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await r.json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){u_(e);const t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await d_(t,"unshare dataset")}async readSharedDataset(e){u_(e);const t=await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:r=!1,projectExtra:a=null,referenceDatasetId:i=null}){const s=r?"?upsert=true":"",o=`${this.apiUrl}/sessions${s}`,c=a||{};n&&(c.metadata=n);const u={name:e,extra:c,description:t};null!==i&&(u.reference_dataset_id=i);const l=await this.caller.call(fetch,o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),d=await l.json();if(!l.ok)throw new Error(`Failed to create session ${e}: ${l.status} ${l.statusText}`);return d}async updateProject(e,{name:t=null,description:n=null,metadata:r=null,projectExtra:a=null,endTime:i=null}){const s=`${this.apiUrl}/sessions/${e}`;let o=a;r&&(o={...o||{},metadata:r});const c={name:t,extra:o,description:n,end_time:i?new Date(i).toISOString():null},u=await this.caller.call(fetch,s,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),l=await u.json();if(!u.ok)throw new Error(`Failed to update project ${e}: ${u.status} ${u.statusText}`);return l}async hasProject({projectId:e,projectName:t}){let n="/sessions";const r=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)u_(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");r.append("name",t)}const a=await this.caller.call(fetch,`${this.apiUrl}${n}?${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const e=await a.json();return!!a.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let r="/sessions";const a=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)u_(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");a.append("name",t)}void 0!==n&&a.append("include_stats",n.toString());const i=await this._get(r,a);let s;if(Array.isArray(i)){if(0===i.length)throw new Error(`Project[id=${e}, name=${t}] not found`);s=i[0]}else s=i;return s}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${n.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:r,referenceDatasetName:a,referenceFree:i}={}){const s=new URLSearchParams;if(void 0!==e)for(const t of e)s.append("id",t);if(void 0!==t&&s.append("name",t),void 0!==n&&s.append("name_contains",n),void 0!==r)s.append("reference_dataset",r);else if(void 0!==a){const e=await this.readDataset({datasetName:a});s.append("reference_dataset",e.id)}void 0!==i&&s.append("reference_free",i.toString());for await(const e of this._getPaginated("/sessions",s))yield*e}async deleteProject({projectId:e,projectName:t}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");n=void 0===e?(await this.readProject({projectName:t})).id:e,u_(n);const r=await this.caller.call(fetch,`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await d_(r,`delete session ${n} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:r,description:a,dataType:i,name:s}){const o=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),n.forEach((e=>{c.append("input_keys",e)})),r.forEach((e=>{c.append("output_keys",e)})),a&&c.append("description",a),i&&c.append("data_type",i),s&&c.append("name",s);const u=await this.caller.call(fetch,o,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!u.ok){const e=await u.json();if(e.detail&&e.detail.includes("already exists"))throw new Error(`Dataset ${t} already exists`);throw new Error(`Failed to upload CSV: ${u.status} ${u.statusText}`)}return await u.json()}async createDataset(e,{description:t,dataType:n}={}){const r={name:e,description:t};n&&(r.data_type=n);const a=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!a.ok){const t=await a.json();if(t.detail&&t.detail.includes("already exists"))throw new Error(`Dataset ${e} already exists`);throw new Error(`Failed to create dataset ${a.status} ${a.statusText}`)}return await a.json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets";const r=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)u_(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");r.append("name",t)}const a=await this._get(n,r);let i;if(Array.isArray(a)){if(0===a.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=a[0]}else i=a;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:r}){let a=e;if(void 0===a&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==a&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");void 0===a&&(a=(await this.readDataset({datasetName:t})).id);const i=new URLSearchParams({from_version:"string"==typeof n?n:n.toISOString(),to_version:"string"==typeof r?r:r.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const n=await this._getResponse(`/datasets/${e}/openai_ft`);return(await n.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:r,datasetNameContains:a}={}){const i=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==n)for(const e of n)i.append("id",e);void 0!==r&&i.append("name",r),void 0!==a&&i.append("name_contains",a);for await(const e of this._getPaginated("/datasets",i))yield*e}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",r=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(r=(await this.readDataset({datasetName:t})).id),void 0===r)throw new Error("Must provide datasetName or datasetId");u_(r),n+=`/${r}`;const a=await this.caller.call(fetch,this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!a.ok)throw new Error(`Failed to delete ${n}: ${a.status} ${a.statusText}`);await a.json()}async createExample(e,t,{datasetId:n,datasetName:r,createdAt:a,exampleId:i,metadata:s}){let o=n;if(void 0===o&&void 0===r)throw new Error("Must provide either datasetName or datasetId");if(void 0!==o&&void 0!==r)throw new Error("Must provide either datasetName or datasetId, not both");void 0===o&&(o=(await this.readDataset({datasetName:r})).id);const c=a||new Date,u={dataset_id:o,inputs:e,outputs:t,created_at:c?.toISOString(),id:i,metadata:s},l=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!l.ok)throw new Error(`Failed to create example: ${l.status} ${l.statusText}`);return await l.json()}async createExamples(e){const{inputs:t,outputs:n,metadata:r,sourceRunIds:a,exampleIds:i,datasetId:s,datasetName:o}=e;let c=s;if(void 0===c&&void 0===o)throw new Error("Must provide either datasetName or datasetId");if(void 0!==c&&void 0!==o)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===c){const e=await this.readDataset({datasetName:o});c=e.id}const u=t.map(((e,t)=>({dataset_id:c,inputs:e,outputs:n?n[t]:void 0,metadata:r?r[t]:void 0,id:i?i[t]:void 0,source_run_id:a?a[t]:void 0}))),l=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!l.ok)throw new Error(`Failed to create examples: ${l.status} ${l.statusText}`);return await l.json()}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){const r=e.map((e=>e_(e)?t_(e):e)),a=e_(t)?t_(t):t;return this.createExample({input:r},{output:a},n)}async readExample(e){u_(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:r,inlineS3Urls:a,metadata:i}={}){let s;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)s=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");s=(await this.readDataset({datasetName:t})).id}const o=new URLSearchParams({dataset:s}),c=r?"string"==typeof r?r:r?.toISOString():void 0;c&&o.append("as_of",c);const u=a??!0;if(o.append("inline_s3_urls",u.toString()),void 0!==n)for(const e of n)o.append("id",e);if(void 0!==i){const e=JSON.stringify(i);o.append("metadata",e)}for await(const e of this._getPaginated("/examples",o))yield*e}async deleteExample(e){u_(e);const t=`/examples/${e}`,n=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to delete ${t}: ${n.status} ${n.statusText}`);await n.json()}async updateExample(e,t){u_(e);const n=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to update example ${e}: ${n.status} ${n.statusText}`);return await n.json()}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:r,referenceExample:a}={loadChildRuns:!1}){let i;if("string"==typeof e)i=await this.readRun(e,{loadChildRuns:r});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);i=e}null!==i.reference_example_id&&void 0!==i.reference_example_id&&(a=await this.readExample(i.reference_example_id));const s=await t.evaluateRun(i,a);let o=n??{};s.evaluatorInfo&&(o={...o,...s.evaluatorInfo});const c=s.targetRunId??i.id;return await this.createFeedback(c,s.key,{score:s?.score,value:s?.value,comment:s?.comment,correction:s?.correction,sourceInfo:o,feedbackSourceType:"model",sourceRunId:s?.sourceRunId})}async createFeedback(e,t,{score:n,value:r,correction:a,comment:i,sourceInfo:s,feedbackSourceType:o="api",sourceRunId:c,feedbackId:u,feedbackConfig:l,projectId:d,comparativeExperimentId:h}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");const f={type:o??"api",metadata:s??{}};void 0===c||void 0===f?.metadata||f.metadata.__run||(f.metadata.__run={run_id:c}),void 0!==f?.metadata&&void 0!==f.metadata.__run?.run_id&&u_(f.metadata.__run.run_id);const p={id:u??By(),run_id:e,key:t,score:n,value:r,correction:a,comment:i,feedback_source:f,comparative_experiment_id:h,feedbackConfig:l,session_id:d},m=`${this.apiUrl}/feedback`,g=await this.caller.call(fetch,m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(p),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await d_(g,"create feedback"),p}async updateFeedback(e,{score:t,value:n,correction:r,comment:a}){const i={};null!=t&&(i.score=t),null!=n&&(i.value=n),null!=r&&(i.correction=r),null!=a&&(i.comment=a),u_(e);const s=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await d_(s,"update feedback")}async readFeedback(e){u_(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){u_(e);const t=`/feedback/${e}`,n=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to delete ${t}: ${n.status} ${n.statusText}`);await n.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){const r=new URLSearchParams;if(e&&r.append("run",e.join(",")),t)for(const e of t)r.append("key",e);if(n)for(const e of n)r.append("source",e);for await(const e of this._getPaginated("/feedback",r))yield*e}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:r}={}){const a={run_id:e,feedback_key:t,feedback_config:r};n?"string"==typeof n?a.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(a.expires_in=n):a.expires_in={hours:3};const i=await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await i.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:r,description:a,metadata:i,id:s}){if(0===t.length)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!n)throw new Error("A reference dataset is required");const o={id:s,name:e,experiment_ids:t,reference_dataset_id:n,description:a,created_at:(r??new Date)?.toISOString(),extra:{}};i&&(o.extra.metadata=i);const c=await this.caller.call(fetch,`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await c.json()}async*listPresignedFeedbackTokens(e){u_(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:[e],t}async logEvaluationFeedback(e,t,n){const r=this._selectEvalResults(e);for(const e of r){let r=n||{};e.evaluatorInfo&&(r={...e.evaluatorInfo,...r});let a=null;e.targetRunId?a=e.targetRunId:t&&(a=t.id),await this.createFeedback(a,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:r,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"})}return r}}const g_="0.1.25";class y_ extends Hy{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:n,client:r}=e;this.projectName=n??qp("LANGCHAIN_PROJECT")??qp("LANGCHAIN_SESSION"),this.exampleId=t,this.client=r??new m_({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Zp()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}}let __;async function b_(e,t){!0===t?await e():(void 0===__&&(__=new(0,im.default)({autoStart:!0,concurrency:1})),__.add(e))}"true"===qp("LANGCHAIN_TRACING_V2")&&"true"!==qp("LANGCHAIN_CALLBACKS_BACKGROUND")&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join("\n");class v_{setHandler(e){return this.setHandlers([e])}}class w_{constructor(e,t,n,r,a,i,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}async handleText(e){await Promise.all(this.handlers.map((t=>b_((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleText: ${e}`)}}),t.awaitHandlers))))}}class x_ extends w_{getChild(e){const t=new S_(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>b_((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>b_((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${e}`)}}),t.awaitHandlers))))}}class k_ extends w_{async handleLLMNewToken(e,t,n,r,a,i){await Promise.all(this.handlers.map((n=>b_((async()=>{if(!n.ignoreLLM)try{await(n.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(e){console.error(`Error in handler ${n.constructor.name}, handleLLMNewToken: ${e}`)}}),n.awaitHandlers))))}async handleLLMError(e){await Promise.all(this.handlers.map((t=>b_((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`)}}),t.awaitHandlers))))}async handleLLMEnd(e){await Promise.all(this.handlers.map((t=>b_((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`)}}),t.awaitHandlers))))}}class O_ extends w_{getChild(e){const t=new S_(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,r,a){await Promise.all(this.handlers.map((t=>b_((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${e}`)}}),t.awaitHandlers))))}async handleChainEnd(e,t,n,r,a){await Promise.all(this.handlers.map((t=>b_((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`)}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>b_((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`)}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>b_((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`)}}),t.awaitHandlers))))}}class A_ extends w_{getChild(e){const t=new S_(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>b_((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${e}`)}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>b_((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`)}}),t.awaitHandlers))))}}class S_ extends v_{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,n=void 0,r=void 0,a=void 0,i=void 0,s=void 0,o=void 0){return Promise.all(t.map((async(t,r)=>{const i=0===r&&n?n:By();return await Promise.all(this.handlers.map((n=>b_((async()=>{if(!n.ignoreLLM)try{await(n.handleLLMStart?.(e,[t],i,this._parentRunId,a,this.tags,this.metadata,o))}catch(e){console.error(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`)}}),n.awaitHandlers)))),new k_(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,t,n=void 0,r=void 0,a=void 0,i=void 0,s=void 0,o=void 0){return Promise.all(t.map((async(t,r)=>{const i=0===r&&n?n:By();return await Promise.all(this.handlers.map((n=>b_((async()=>{if(!n.ignoreLLM)try{if(n.handleChatModelStart)await(n.handleChatModelStart?.(e,[t],i,this._parentRunId,a,this.tags,this.metadata,o));else if(n.handleLLMStart){const r=Mp(t);await(n.handleLLMStart?.(e,[r],i,this._parentRunId,a,this.tags,this.metadata,o))}}catch(e){console.error(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`)}}),n.awaitHandlers)))),new k_(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,t,n=By(),r=void 0,a=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map((a=>b_((async()=>{if(!a.ignoreChain)try{await(a.handleChainStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,r,s))}catch(e){console.error(`Error in handler ${a.constructor.name}, handleChainStart: ${e}`)}}),a.awaitHandlers)))),new O_(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,n=By(),r=void 0,a=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map((r=>b_((async()=>{if(!r.ignoreAgent)try{await(r.handleToolStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,s))}catch(e){console.error(`Error in handler ${r.constructor.name}, handleToolStart: ${e}`)}}),r.awaitHandlers)))),new A_(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,n=By(),r=void 0,a=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map((r=>b_((async()=>{if(!r.ignoreRetriever)try{await(r.handleRetrieverStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,s))}catch(e){console.error(`Error in handler ${r.constructor.name}, handleRetrieverStart: ${e}`)}}),r.awaitHandlers)))),new x_(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const n=new S_(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);n.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);n.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);n.addMetadata({[e]:this.metadata[e]},t)}for(const r of e)n.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===r.name))||n.addHandler(r,t);return n}static fromHandlers(e){const t=new this;return t.addHandler(new class extends zy{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:By()}),Object.assign(this,e)}}),t}static async configure(e,t,n,r,a,i,s){let o;(e||t)&&(Array.isArray(e)||!e?(o=new S_,o.setHandlers(e?.map(P_)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(P_):t?.handlers,!1));const c="true"===qp("LANGCHAIN_VERBOSE")||s?.verbose,u="true"===qp("LANGCHAIN_TRACING_V2"),l=u||(qp("LANGCHAIN_TRACING")??!1);if(c||l){if(o||(o=new S_),c&&!o.handlers.some((e=>e.name===Gy.prototype.name))){const e=new Gy;o.addHandler(e,!0)}l&&!o.handlers.some((e=>"langchain_tracer"===e.name))&&u&&o.addHandler(await async function(){return new y_}(),!0)}return(n||r)&&o&&(o.addTags(n??[]),o.addTags(r??[],!1)),(a||i)&&o&&(o.addMetadata(a??{}),o.addMetadata(i??{},!1)),o}}function P_(e){return"name"in e?e:zy.fromMethods(e)}const E_=Object.prototype.hasOwnProperty;function I_(e,t){return E_.call(e,t)}function j_(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let n in e)I_(e,n)&&t.push(n);return t}function T_(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function N_(e){let t=0;const n=e.length;let r;for(;t<n;){if(r=e.charCodeAt(t),!(r>=48&&r<=57))return!1;t++}return!0}function C_(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function R_(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function $_(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if($_(e[t]))return!0}else if("object"==typeof e){const n=j_(e),r=n.length;for(var t=0;t<r;t++)if($_(e[n[t]]))return!0}return!1}function M_(e,t){const n=[e];for(const e in t){const r="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==r&&n.push(`${e}: ${r}`)}return n.join("\n")}class L_ extends Error{constructor(e,t,n,r,a){super(M_(e,{name:t,index:n,operation:r,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=M_(e,{name:t,index:n,operation:r,tree:a})}}const D_=L_,U_=T_,B_={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){let r=z_(n,this.path);r&&(r=T_(r));const a=Z_(n,{op:"remove",path:this.from}).removed;return Z_(n,{op:"add",path:this.path,value:a}),{newDocument:n,removed:r}},copy:function(e,t,n){const r=z_(n,this.from);return Z_(n,{op:"add",path:this.path,value:T_(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:K_(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}};var F_={add:function(e,t,n){return N_(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){return{newDocument:n,removed:e.splice(t,1)[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:B_.move,copy:B_.copy,test:B_.test,_get:B_._get};function z_(e,t){if(""==t)return e;var n={op:"_get",path:t};return Z_(e,n),n.value}function Z_(e,t,n=!1,r=!0,a=!0,i=0){if(n&&("function"==typeof n?n(t,0,e,t.path):W_(t,0)),""===t.path){let r={newDocument:e};if("add"===t.op)return r.newDocument=t.value,r;if("replace"===t.op)return r.newDocument=t.value,r.removed=e,r;if("move"===t.op||"copy"===t.op)return r.newDocument=z_(e,t.from),"move"===t.op&&(r.removed=e),r;if("test"===t.op){if(r.test=K_(e,t.value),!1===r.test)throw new D_("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r.newDocument=e,r}if("remove"===t.op)return r.removed=e,r.newDocument=null,r;if("_get"===t.op)return t.value=e,r;if(n)throw new D_("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return r}{r||(e=T_(e));const s=(t.path||"").split("/");let o,c,u,l=e,d=1,h=s.length;for(u="function"==typeof n?n:W_;;){if(c=s[d],c&&-1!=c.indexOf("~")&&(c=R_(c)),a&&("__proto__"==c||"prototype"==c&&d>0&&"constructor"==s[d-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&void 0===o&&(void 0===l[c]?o=s.slice(0,d).join("/"):d==h-1&&(o=t.path),void 0!==o&&u(t,0,e,o)),d++,Array.isArray(l)){if("-"===c)c=l.length;else{if(n&&!N_(c))throw new D_("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);N_(c)&&(c=~~c)}if(d>=h){if(n&&"add"===t.op&&c>l.length)throw new D_("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);const r=F_[t.op].call(t,l,c,e);if(!1===r.test)throw new D_("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r}}else if(d>=h){const n=B_[t.op].call(t,l,c,e);if(!1===n.test)throw new D_("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return n}if(l=l[c],n&&d<h&&(!l||"object"!=typeof l))throw new D_("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function q_(e,t,n,r=!0,a=!0){if(n&&!Array.isArray(t))throw new D_("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=T_(e));const i=new Array(t.length);for(let r=0,s=t.length;r<s;r++)i[r]=Z_(e,t[r],n,!0,a,r),e=i[r].newDocument;return i.newDocument=e,i}function H_(e,t,n){const r=Z_(e,t);if(!1===r.test)throw new D_("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return r.newDocument}function W_(e,t,n,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new D_("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(!B_[e.op])throw new D_("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n);if("string"!=typeof e.path)throw new D_("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new D_('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new D_("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new D_("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&$_(e.value))throw new D_("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n)if("add"==e.op){var a=e.path.split("/").length,i=r.split("/").length;if(a!==i+1&&a!==i)throw new D_("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new D_("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if("move"===e.op||"copy"===e.op){var s=J_([{op:"_get",path:e.from,value:void 0}],n);if(s&&"OPERATION_PATH_UNRESOLVABLE"===s.name)throw new D_("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}function J_(e,t,n){try{if(!Array.isArray(e))throw new D_("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)q_(T_(t),T_(e),n||!0);else{n=n||W_;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(e){if(e instanceof D_)return e;throw e}}function K_(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var n,r,a,i=Array.isArray(e),s=Array.isArray(t);if(i&&s){if((r=e.length)!=t.length)return!1;for(n=r;0!=n--;)if(!K_(e[n],t[n]))return!1;return!0}if(i!=s)return!1;var o=Object.keys(e);if((r=o.length)!==Object.keys(t).length)return!1;for(n=r;0!=n--;)if(!t.hasOwnProperty(o[n]))return!1;for(n=r;0!=n--;)if(!K_(e[a=o[n]],t[a]))return!1;return!0}return e!=e&&t!=t}function V_(e,t,n,r,a){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var i=j_(t),s=j_(e),o=!1,c=s.length-1;c>=0;c--){var u=e[d=s[c]];if(!I_(t,d)||void 0===t[d]&&void 0!==u&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(a&&n.push({op:"test",path:r+"/"+C_(d),value:T_(u)}),n.push({op:"remove",path:r+"/"+C_(d)}),o=!0):(a&&n.push({op:"test",path:r,value:e}),n.push({op:"replace",path:r,value:t}));else{var l=t[d];"object"==typeof u&&null!=u&&"object"==typeof l&&null!=l&&Array.isArray(u)===Array.isArray(l)?V_(u,l,n,r+"/"+C_(d),a):u!==l&&(a&&n.push({op:"test",path:r+"/"+C_(d),value:T_(u)}),n.push({op:"replace",path:r+"/"+C_(d),value:T_(l)}))}}if(o||i.length!=s.length)for(c=0;c<i.length;c++){var d;I_(e,d=i[c])||void 0===t[d]||n.push({op:"add",path:r+"/"+C_(d),value:T_(t[d])})}}}function G_(e,t,n=!1){var r=[];return V_(e,t,r,"",n),r}new WeakMap;class X_ extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new X_({start:e=>function n(){return t.read().then((({done:t,value:r})=>{if(!t)return e.enqueue(r),n();e.close()}))}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new X_({async pull(t){const{value:n,done:r}=await e.next();r&&t.close(),t.enqueue(n)},async cancel(t){await e.return(t)}})}}function Y_(e,t=2){const n=Array.from({length:t},(()=>[]));return n.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of n)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function Q_(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const n={...e};for(const[e,r]of Object.entries(t))e in n&&!Array.isArray(n[e])?n[e]=Q_(n[e],r):n[e]=r;return n}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class eb{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise(((n,r)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(n,r):this.firstResult.then((e=>n(void 0)),r)}))}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}class tb{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),n=q_({},t);return new nb({ops:t,state:n[n.length-1].newDocument})}}class nb extends tb{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),n=q_(this.state,e.ops);return new nb({ops:t,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){const t=q_({},e.ops);return new nb({ops:e.ops,state:t[t.length-1].newDocument})}}async function rb(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=e;return["retriever","llm","prompt"].includes(e.run_type)?n:1!==Object.keys(n).length||""!==n?.input?n.input:void 0}async function ab(e,t){const{outputs:n}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?n:void 0!==n&&1===Object.keys(n).length&&void 0!==n?.output?n.output:n}class ib extends Hy{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=X_.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(n=n||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(n=n&&t.every((e=>!this.excludeTags?.includes(e)))),n}async*tapOutputIterable(e,t){for await(const n of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new tb({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new tb({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(n.inputs=await rb(e,this._schemaFormat)),await this.writer.write(new tb({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const n=[];"streaming_events"===this._schemaFormat&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await rb(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await ab(e,this._schemaFormat)}),void 0!==e.end_time&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const r=new tb({ops:n});await this.writer.write(r)}finally{if(e.id===this.rootId){const t=new tb({ops:[{op:"replace",path:"/final_output",value:await ab(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){const r=this.keyMapByRunId[e.id];if(void 0===r)return;let a;var i;void 0!==e.inputs.messages?(i=n?.chunk,a=void 0!==i&&void 0!==i.message?n?.chunk:new Pp(t)):a=t;const s=new tb({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${r}/streamed_output/-`,value:a}]});await this.writer.write(s)}}class sb{getStore(){}run(e,t){return t()}}const ob=new class{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new sb}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}};async function cb(e){return S_.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function ub(...e){const t={};for(const n of e.filter((e=>!!e)))for(const e of Object.keys(n))if("metadata"===e)t[e]={...t[e],...n[e]};else if("tags"===e){const r=t[e]??[];t[e]=[...new Set(r.concat(n[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...n[e]};else if("callbacks"===e){const e=t.callbacks,r=n.callbacks;if(Array.isArray(r))if(e)if(Array.isArray(e))t.callbacks=e.concat(r);else{const n=e.copy();for(const e of r)n.addHandler(P_(e),!0);t.callbacks=n}else t.callbacks=r;else if(r)if(e)if(Array.isArray(e)){const n=r.copy();for(const t of e)n.addHandler(P_(t),!0);t.callbacks=n}else t.callbacks=new S_(r._parentRunId,{handlers:e.handlers.concat(r.handlers),inheritableHandlers:e.inheritableHandlers.concat(r.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(r.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(r.inheritableTags))),metadata:{...e.metadata,...r.metadata}});else t.callbacks=r}else{const r=e;t[r]=n[r]??t[r]}return t}const lb=new Set(["string","number","boolean"]);function db(e){const t=e??ob.getInstance().getStore();let n={tags:[],metadata:{},callbacks:void 0,recursionLimit:25,runId:void 0};if(t&&(n={...n,...t}),t?.configurable)for(const e of Object.keys(t.configurable))lb.has(typeof t.configurable[e])&&!n.metadata?.[e]&&(n.metadata||(n.metadata={}),n.metadata[e]=t.configurable[e]);return n}function hb(e={},{callbacks:t,maxConcurrency:n,recursionLimit:r,runName:a,configurable:i,runId:s}={}){const o=db(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==r&&(o.recursionLimit=r),void 0!==n&&(o.maxConcurrency=n),void 0!==a&&(o.runName=a),void 0!==i&&(o.configurable={...o.configurable,...i}),void 0!==s&&delete o.runId,o}class fb extends Hy{constructor({config:e,onStart:t,onEnd:n,onError:r}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(1===this.argOnStart.length?await this.argOnStart(e):2===this.argOnStart.length&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(1===this.argOnError.length?await this.argOnError(e):2===this.argOnError.length&&await this.argOnError(e,this.config)):this.argOnEnd&&(1===this.argOnEnd.length?await this.argOnEnd(e):2===this.argOnEnd.length&&await this.argOnEnd(e,this.config)))}}function pb(e){return!!e&&e.lc_runnable}class mb{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let n=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const r=e.tags??[];return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(t)),void 0!==this.includeTags&&(n=n||r.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(n=n&&r.every((e=>!this.excludeTags?.includes(e)))),n}}const gb=Symbol("Let zodToJsonSchema decide on which parser to use"),yb={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",emailStrategy:"format:email",base64Strategy:"contentEncoding:base64"};function _b(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function bb(e,t,n,r,a){e[t]=n,_b(e,t,r,a)}function vb(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(((n,r)=>vb(e,t,n)))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return wb(e,t)}}const wb=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":bb(n,"minimum",r.value,r.message,t);break;case"max":bb(n,"maximum",r.value,r.message,t)}return n},xb={cuid:"^[cC][^\\s-]{8,}$",cuid2:"^[a-z][a-z0-9]*$",ulid:"^[0-9A-HJKMNP-TV-Z]{26}$",email:"^(?!\\.)(?!.*\\.\\.)([a-zA-Z0-9_+-\\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\\-]*\\.)+[a-zA-Z]{2,}$",emoji:"^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",uuid:"^[0-9a-fA-F]{8}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{12}$",ipv4:"^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$",ipv6:"^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$",base64:"^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$",nanoid:"^[a-zA-Z0-9_-]{21}$"};function kb(e,t){const n={type:"string"};function r(e){return"escape"===t.patternStrategy?Ob(e):e}if(e.checks)for(const a of e.checks)switch(a.kind){case"min":bb(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,a.value):a.value,a.message,t);break;case"max":bb(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":Ab(n,"email",a.message,t);break;case"format:idn-email":Ab(n,"idn-email",a.message,t);break;case"pattern:zod":Sb(n,xb.email,a.message,t)}break;case"url":Ab(n,"uri",a.message,t);break;case"uuid":Ab(n,"uuid",a.message,t);break;case"regex":Sb(n,a.regex.source,a.message,t);break;case"cuid":Sb(n,xb.cuid,a.message,t);break;case"cuid2":Sb(n,xb.cuid2,a.message,t);break;case"startsWith":Sb(n,"^"+r(a.value),a.message,t);break;case"endsWith":Sb(n,r(a.value)+"$",a.message,t);break;case"datetime":Ab(n,"date-time",a.message,t);break;case"date":Ab(n,"date",a.message,t);break;case"time":Ab(n,"time",a.message,t);break;case"duration":Ab(n,"duration",a.message,t);break;case"length":bb(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,a.value):a.value,a.message,t),bb(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,a.value):a.value,a.message,t);break;case"includes":Sb(n,r(a.value),a.message,t);break;case"ip":"v6"!==a.version&&Ab(n,"ipv4",a.message,t),"v4"!==a.version&&Ab(n,"ipv6",a.message,t);break;case"emoji":Sb(n,xb.emoji,a.message,t);break;case"ulid":Sb(n,xb.ulid,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":Ab(n,"binary",a.message,t);break;case"contentEncoding:base64":bb(n,"contentEncoding","base64",a.message,t);break;case"pattern:zod":Sb(n,xb.base64,a.message,t)}break;case"nanoid":Sb(n,xb.nanoid,a.message,t)}return n}const Ob=e=>Array.from(e).map((e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`)).join(""),Ab=(e,t,n,r)=>{e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):bb(e,"format",t,n,r)},Sb=(e,t,n,r)=>{e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:t,...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):bb(e,"pattern",t,n,r)};function Pb(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===Xg.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((n,r)=>({...n,[r]:Tb(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}})),{}),additionalProperties:!1};const n={type:"object",additionalProperties:Tb(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===Xg.ZodString&&e.keyType._def.checks?.length){const r=Object.entries(kb(e.keyType._def,t)).reduce(((e,[t,n])=>"type"===t?e:{...e,[t]:n}),{});return{...n,propertyNames:r}}return e.keyType?._def.typeName===Xg.ZodEnum?{...n,propertyNames:{enum:e.keyType._def.values}}:n}const Eb={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},Ib=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,n)=>Tb(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return n.length?{anyOf:n}:void 0};function jb(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:Tb(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:Tb(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function Tb(e,t,n=!1){const r=t.seen.get(e);if(t.override){const a=t.override?.(e,t,r,n);if(a!==gb)return a}if(r&&!n){const e=Nb(r,t);if(void 0!==e)return e}const a={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,a);const i=Rb(e,e.typeName,t);return i&&$b(e,t,i),a.jsonSchema=i,i}const Nb=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:Cb(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,n)=>t.currentPath[n]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},Cb=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},Rb=(e,t,n)=>{switch(t){case Xg.ZodString:return kb(e,n);case Xg.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",_b(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?bb(n,"minimum",r.value,r.message,t):bb(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),bb(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?bb(n,"maximum",r.value,r.message,t):bb(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),bb(n,"maximum",r.value,r.message,t));break;case"multipleOf":bb(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case Xg.ZodObject:return function(e,t){const n={type:"object",...Object.entries(e.shape()).reduce(((e,[n,r])=>{if(void 0===r||void 0===r._def)return e;const a=Tb(r._def,{...t,currentPath:[...t.currentPath,"properties",n],propertyPath:[...t.currentPath,"properties",n]});return void 0===a?e:{properties:{...e.properties,[n]:a},required:r.isOptional()?e.required:[...e.required,n]}}),{properties:{},required:[]}),additionalProperties:jb(e,t)};return n.required.length||delete n.required,n}(e,n);case Xg.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?bb(n,"minimum",r.value,r.message,t):bb(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),bb(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?bb(n,"maximum",r.value,r.message,t):bb(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),bb(n,"maximum",r.value,r.message,t));break;case"multipleOf":bb(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case Xg.ZodBoolean:return{type:"boolean"};case Xg.ZodDate:return vb(e,n);case Xg.ZodUndefined:return{not:{}};case Xg.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case Xg.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def?.typeName!==Xg.ZodAny&&(n.items=Tb(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&bb(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&bb(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(bb(n,"minItems",e.exactLength.value,e.exactLength.message,t),bb(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case Xg.ZodUnion:case Xg.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return Ib(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every((e=>e._def.typeName in Eb&&(!e._def.checks||!e._def.checks.length)))){const e=n.reduce(((e,t)=>{const n=Eb[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e}),[]);return{type:e.length>1?e:e[0]}}if(n.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=n.reduce(((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===n.length){const t=e.filter(((e,t,n)=>n.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:n.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(n.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:n.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return Ib(e,t)}(e,n);case Xg.ZodIntersection:return function(e,t){const n=[Tb(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),Tb(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const a=[];return n.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;a.push(t)}else a.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t})),a.length?{allOf:a,...r}:void 0}(e,n);case Xg.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,n)=>Tb(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:Tb(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,n)=>Tb(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,n);case Xg.ZodRecord:return Pb(e,n);case Xg.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case Xg.ZodEnum:return function(e){return{type:"string",enum:e.values}}(e);case Xg.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])).map((e=>t[e])),r=Array.from(new Set(n.map((e=>typeof e))));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case Xg.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:Eb[e.innerType._def.typeName],nullable:!0}:{type:[Eb[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=Tb(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=Tb(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case Xg.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return Tb(e.innerType._def,t);const n=Tb(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case Xg.ZodMap:return function(e,t){return"record"===t.mapStrategy?Pb(e,t):{type:"array",maxItems:125,items:{type:"array",items:[Tb(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},Tb(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case Xg.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:Tb(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&bb(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&bb(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case Xg.ZodLazy:return Tb(e.getter()._def,n);case Xg.ZodPromise:return function(e,t){return Tb(e.type._def,t)}(e,n);case Xg.ZodNaN:case Xg.ZodNever:return{not:{}};case Xg.ZodEffects:return function(e,t){return"input"===t.effectStrategy?Tb(e.schema._def,t):{}}(e,n);case Xg.ZodAny:case Xg.ZodUnknown:return{};case Xg.ZodDefault:return function(e,t){return{...Tb(e.innerType._def,t),default:e.defaultValue()}}(e,n);case Xg.ZodBranded:return function(e,t){return Tb(e.type._def,t)}(e,n);case Xg.ZodReadonly:case Xg.ZodCatch:return((e,t)=>Tb(e.innerType._def,t))(e,n);case Xg.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return Tb(e.in._def,t);if("output"===t.pipeStrategy)return Tb(e.out._def,t);const n=Tb(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,Tb(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter((e=>void 0!==e))}})(e,n);case Xg.ZodFunction:case Xg.ZodVoid:case Xg.ZodSymbol:default:return}},$b=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),Mb=(e,t)=>{const n=(e=>{const t=(e=>"string"==typeof e?{...yb,name:e}:{...yb,...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map((([e,n])=>[n._def,{def:n._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}})(t),r="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce(((e,[t,r])=>({...e,[t]:Tb(r._def,{...n,currentPath:[...n.basePath,n.definitionPath,t]},!0)??{}})),{}):void 0,a="string"==typeof t?t:t?.name,i=Tb(e._def,void 0===a?n:{...n,currentPath:[...n.basePath,n.definitionPath,a]},!1)??{},s=void 0===a?r?{...i,[n.definitionPath]:r}:i:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,a].join("/"),[n.definitionPath]:{...r,[a]:i}};return"jsonSchema7"===n.target?s.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===n.target&&(s.$schema="https://json-schema.org/draft/2019-09/schema#"),s};function Lb(e){return pb(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...Mb(e.data.schema),title:e.data.name}}}class Db{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){const e={};return Object.values(this.nodes).forEach(((t,n)=>{e[t.id]=c_(t.id)?n:t.id})),{nodes:Object.values(this.nodes).map((t=>({id:e[t.id],...Lb(t)}))),edges:this.edges.map((t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]}))}}addNode(e,t){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const n=t||By(),r={id:n,data:e};return this.nodes[n]=r,r}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter((t=>t.source!==e.id&&t.target!==e.id))}addEdge(e,t,n){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const r={source:e.id,target:t.id,data:n};return this.edges.push(r),r}firstNode(){const e=new Set(this.edges.map((e=>e.target))),t=[];return Object.values(this.nodes).forEach((n=>{e.has(n.id)||t.push(n)})),t[0]}lastNode(){const e=new Set(this.edges.map((e=>e.source))),t=[];return Object.values(this.nodes).forEach((n=>{e.has(n.id)||t.push(n)})),t[0]}extend(e){Object.entries(e.nodes).forEach((([e,t])=>{this.nodes[e]=t})),this.edges=[...this.edges,...e.edges]}trimFirstNode(){const e=this.firstNode();if(e){const t=this.edges.filter((t=>t.source===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}trimLastNode(){const e=this.lastNode();if(e){const t=this.edges.filter((t=>t.target===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}}function Ub(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function Bb(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*Fb(e,t){const n=ob.getInstance();for(;;){const{value:r,done:a}=n.run(e,t.next.bind(t));if(a)break;yield r}}async function*zb(e,t){const n=ob.getInstance(),r=t[Symbol.asyncIterator]();for(;;){const{value:a,done:i}=await n.run(e,r.next.bind(t));if(i)break;yield a}}function Zb(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class qb extends _p{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Hb({bound:this,kwargs:e,config:{}})}map(){return new Wb({bound:this})}withRetry(e){return new Jb({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new Hb({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new Xb({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(db);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const n=Object.fromEntries(Object.entries(e).filter((([e])=>"runId"!==e)));return Array.from({length:t},((t,r)=>db(0===r?e:n)))}return Array.from({length:t},(()=>db(e)))}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),a=r[0]?.maxConcurrency??n?.maxConcurrency,i=new cm({maxConcurrency:a,onFailedAttempt:e=>{throw e}}),s=e.map(((e,t)=>i.call((async()=>{try{return await this.invoke(e,r[t])}catch(e){if(n?.returnExceptions)return e;throw e}}))));return Promise.all(s)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const n=new eb(this._streamIterator(e,db(t)));return await n.setup,X_.fromAsyncGenerator(n)}_separateRunnableConfigFromCallOptions(e){let t;t=db(void 0===e?e:{callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,[t,n]}async _callWithConfig(e,t,n){const r=db(n),a=await cb(r),i=await(a?.handleChainStart(this.toJSON(),Zb(t,"input"),r.runId,r?.runType,void 0,void 0,r?.runName??this.getName()));let s;delete r.runId;try{s=await e.call(this,t,r,i)}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(Zb(s,"output"))),s}async _batchWithConfig(e,t,n,r){const a=this._getOptionsList(n??{},t.length),i=await Promise.all(a.map(cb)),s=await Promise.all(i.map((async(e,n)=>{const r=await(e?.handleChainStart(this.toJSON(),Zb(t[n],"input"),a[n].runId,a[n].runType,void 0,void 0,a[n].runName??this.getName()));return delete a[n].runId,r})));let o;try{o=await e.call(this,t,a,s,r)}catch(e){throw await Promise.all(s.map((t=>t?.handleChainError(e)))),e}return await Promise.all(s.map((e=>e?.handleChainEnd(Zb(o,"output"))))),o}async*_transformStreamWithConfig(e,t,n){let r,a,i=!0,s=!0;const o=db(n),c=await cb(o);let u;try{const n=await async function(e,t,n,...r){const a=new eb(t,n),i=await a.setup;return{output:e(a,i,...r),setup:i}}(t.bind(this),async function*(){for await(const t of e){if(i)if(void 0===r)r=t;else try{r=Q_(r,t)}catch{r=void 0,i=!1}yield t}}(),(async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName())),o);delete o.runId,u=n.setup;const l=e=>"log_stream_tracer"===e.name,d=u?.handlers.find(l);let h=n.output;void 0!==d&&void 0!==u&&(h=await d.tapOutputIterable(u.runId,n.output));for await(const e of h)if(yield e,s)if(void 0===a)a=e;else try{a=Q_(a,e)}catch{a=void 0,s=!1}}catch(e){throw await(u?.handleChainError(e,void 0,void 0,void 0,{inputs:Zb(r,"input")})),e}await(u?.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:Zb(r,"input")}))}getGraph(e){const t=new Db,n=t.addNode({name:`${this.getName()}Input`,schema:Ry.any()}),r=t.addNode(this),a=t.addNode({name:`${this.getName()}Output`,schema:Ry.any()});return t.addEdge(n,r),t.addEdge(r,a),t}pipe(e){return new Kb({first:this,last:Yb(e)})}pick(e){return this.pipe(new ev(e))}assign(e){return this.pipe(new Qb(new Vb({steps:e})))}async*transform(e,t){let n;for await(const t of e)n=void 0===n?t:Q_(n,t);yield*this._streamIterator(n,db(t))}async*streamLog(e,t,n){const r=new ib({...n,autoClose:!1,_schemaFormat:"original"}),a=db(t);yield*this._streamLog(e,r,a)}async*_streamLog(e,t,n){const{callbacks:r}=n;if(void 0===r)n.callbacks=[t];else if(Array.isArray(r))n.callbacks=r.concat([t]);else{const e=r.copy();e.inheritableHandlers.push(t),n.callbacks=e}const a=this.stream(e,n),i=async function(){try{const e=await a;for await(const n of e){const e=new tb({ops:[{op:"add",path:"/streamed_output/-",value:n}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await i}}async*streamEvents(e,t,n){if("text/event-stream"===t.encoding){const r=await this._streamEvents(e,t,n);yield*function(e){const t=new TextEncoder,n=new ReadableStream({async start(n){for await(const r of e)n.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(r)}\n\n`));n.enqueue(t.encode("event: end\n\n")),n.close()}});return X_.fromReadableStream(n)}(r)}else yield*this._streamEvents(e,t,n)}async*_streamEvents(e,t,n){if("v1"!==t.version)throw new Error('Only version "v1" of the events schema is currently supported.');let r,a=!1;const i=db(t),s=i.tags??[],o=i.metadata??{},c=i.runName??this.getName(),u=new ib({...n,autoClose:!1,_schemaFormat:"streaming_events"}),l=new mb({...n}),d=this._streamLog(e,u,i);for await(const t of d){if(r=r?r.concat(t):nb.fromRunLogPatch(t),void 0===r.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const t={...r.state},n={run_id:t.id,event:`on_${t.type}_start`,name:c,tags:s,metadata:o,data:{input:e}};l.includeEvent(n,t.type)&&(yield n)}const n=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),i=[...new Set(n)];for(const e of i){let t,n={};const a=r.state.logs[e];if(t=void 0===a.end_time?a.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==a.inputs&&(n.input=a.inputs);else if("end"===t)void 0!==a.inputs&&(n.input=a.inputs),n.output=a.final_output;else if("stream"===t){const e=a.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${a.name}"`);n={chunk:a.streamed_output[0]},a.streamed_output=[]}yield{event:`on_${a.type}_${t}`,name:a.name,run_id:a.id,tags:a.tags,metadata:a.metadata,data:n}}const{state:u}=r;if(u.streamed_output.length>0){const e=u.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${u.name}"`);const t={chunk:u.streamed_output[0]};u.streamed_output=[];const n={event:`on_${u.type}_stream`,run_id:u.id,tags:s,metadata:o,name:c,data:t};l.includeEvent(n,u.type)&&(yield n)}}const h=r?.state;if(void 0!==h){const e={event:`on_${h.type}_end`,name:c,run_id:h.id,tags:s,metadata:o,data:{output:h.final_output}};l.includeEvent(e,h.type)&&(yield e)}}static isRunnable(e){return pb(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new Hb({bound:this,config:{},configFactories:[r=>({callbacks:[new fb({config:r,onStart:e,onEnd:t,onError:n})]})]})}}class Hb extends qb{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=ub(this.config,...e);return ub(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(db(t),this.kwargs))}async batch(e,t,n){const r=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig(db(e),this.kwargs)))):await this._mergeConfig(db(t),this.kwargs);return this.bound.batch(e,r,n)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(db(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(db(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(db(t),this.kwargs))}async*streamEvents(e,t,n){yield*this.bound.streamEvents(e,{...await this._mergeConfig(db(t),this.kwargs),version:t.version},n)}static isRunnableBinding(e){return e.bound&&qb.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:n}){return new Hb({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[r=>({callbacks:[new fb({config:r,onStart:e,onEnd:t,onError:n})]})]})}}class Wb extends qb{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Wb({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,n){return this.bound.batch(e,hb(t,{callbacks:n?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:n}){return new Wb({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:n})})}}class Jb extends Hb{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){const r=e>1?`retry:attempt:${e}`:void 0;return hb(t,{callbacks:n?.getChild(r)})}async _invoke(e,t,n){return am((r=>super.invoke(e,this._patchConfigForRetry(r,t,n))),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,n,r){const a={};try{await am((async i=>{const s=e.map(((e,t)=>t)).filter((e=>void 0===a[e.toString()]||a[e.toString()]instanceof Error)),o=s.map((t=>e[t])),c=s.map((e=>this._patchConfigForRetry(i,t?.[e],n?.[e]))),u=await super.batch(o,c,{...r,returnExceptions:!0});let l;for(let e=0;e<u.length;e+=1){const t=u[e],n=s[e];t instanceof Error&&void 0===l&&(l=t,l.input=o[e]),a[n.toString()]=t}if(l)throw l;return u}),{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==r?.returnExceptions)throw e}return Object.keys(a).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>a[parseInt(e,10)]))}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}}class Kb extends qb{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const n=db(t),r=await cb(n),a=await(r?.handleChainStart(this.toJSON(),Zb(e,"input"),n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;let i,s=e;try{const e=[this.first,...this.middle];for(let t=0;t<e.length;t+=1){const r=e[t];s=await r.invoke(s,hb(n,{callbacks:a?.getChild(`seq:step:${t+1}`)}))}i=await this.last.invoke(s,hb(n,{callbacks:a?.getChild(`seq:step:${this.steps.length}`)}))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(Zb(i,"output"))),i}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),a=await Promise.all(r.map(cb)),i=await Promise.all(a.map((async(t,n)=>{const a=await(t?.handleChainStart(this.toJSON(),Zb(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,a})));let s=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e];s=await t.batch(s,i.map(((t,n)=>{const a=t?.getChild(`seq:step:${e+1}`);return hb(r[n],{callbacks:a})})),n)}}catch(e){throw await Promise.all(i.map((t=>t?.handleChainError(e)))),e}return await Promise.all(i.map((e=>e?.handleChainEnd(Zb(s,"output"))))),s}async*_streamIterator(e,t){const n=await cb(t),{runId:r,...a}=t??{},i=await(n?.handleChainStart(this.toJSON(),Zb(e,"input"),r,void 0,void 0,void 0,a?.runName)),s=[this.first,...this.middle,this.last];let o,c=!0;try{let t=s[0].transform(async function*(){yield e}(),hb(a,{callbacks:i?.getChild("seq:step:1")}));for(let e=1;e<s.length;e+=1){const n=s[e];t=await n.transform(t,hb(a,{callbacks:i?.getChild(`seq:step:${e+1}`)}))}for await(const n of t)if(yield n,c)if(void 0===o)o=n;else try{o=Q_(o,n)}catch(e){o=void 0,c=!1}}catch(e){throw await(i?.handleChainError(e)),e}await(i?.handleChainEnd(Zb(o,"output")))}getGraph(e){const t=new Db;let n=null;return this.steps.forEach(((r,a)=>{const i=r.getGraph(e);0!==a&&i.trimFirstNode(),a!==this.steps.length-1&&i.trimLastNode(),t.extend(i);const s=i.firstNode();if(!s)throw new Error(`Runnable ${r} has no first node`);n&&t.addEdge(n,s),n=i.lastNode()})),t}pipe(e){return Kb.isRunnableSequence(e)?new Kb({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new Kb({first:this.first,middle:[...this.middle,this.last],last:Yb(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&qb.isRunnable(e)}static from([e,...t],n){return new Kb({first:Yb(e),middle:t.slice(0,-1).map(Yb),last:Yb(t[t.length-1]),name:n})}}class Vb extends qb{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,n]of Object.entries(e.steps))this.steps[t]=Yb(n)}static from(e){return new Vb({steps:e})}async invoke(e,t){const n=db(t),r=await cb(n),a=await(r?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;const i={};try{await Promise.all(Object.entries(this.steps).map((async([t,r])=>{i[t]=await r.invoke(e,hb(n,{callbacks:a?.getChild(`map:key:${t}`)}))})))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(i)),i}async*_transform(e,t,n){const r={...this.steps},a=Y_(e,Object.keys(r).length),i=new Map(Object.entries(r).map((([e,r],i)=>{const s=r.transform(a[i],hb(n,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,s.next().then((t=>({key:e,gen:s,result:t})))]})));for(;i.size;){const{key:e,result:t,gen:n}=await Promise.race(i.values());i.delete(e),t.done||(yield{[e]:t.value},i.set(e,n.next().then((t=>({key:e,gen:n,result:t})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=new eb(this.transform(async function*(){yield e}(),t));return await n.setup,X_.fromAsyncGenerator(n)}}class Gb extends qb{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new Gb({func:e})}async _invoke(e,t,n){return new Promise(((r,a)=>{const i=hb(t,{callbacks:n?.getChild(),recursionLimit:(t?.recursionLimit??25)-1});ob.getInstance().run(i,(async()=>{try{let n=await this.func(e,{...i,config:i});if(n&&qb.isRunnable(n)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");n=await n.invoke(e,{...i,recursionLimit:(i.recursionLimit??25)-1})}else if(Bb(n)){let e;for await(const t of zb(i,n))if(void 0===e)e=t;else try{e=Q_(e,t)}catch(n){e=t}n=e}else if(Ub(n)){let e;for(const t of Fb(i,n))if(void 0===e)e=t;else try{e=Q_(e,t)}catch(n){e=t}n=e}r(n)}catch(e){a(e)}}))}))}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,n){let r;for await(const t of e)if(void 0===r)r=t;else try{r=Q_(r,t)}catch(e){r=t}const a=await new Promise(((e,t)=>{ob.getInstance().run(n,(async()=>{try{const t=await this.func(r,{...n,config:n});e(t)}catch(e){t(e)}}))}));if(a&&qb.isRunnable(a)){if(0===n?.recursionLimit)throw new Error("Recursion limit reached.");const e=await a.stream(r,hb(n,{callbacks:t?.getChild(),recursionLimit:(n?.recursionLimit??25)-1}));for await(const t of e)yield t}else if(Bb(a))for await(const e of zb(n,a))yield e;else if(Ub(a))for(const e of Fb(n,a))yield e;else yield a}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=new eb(this.transform(async function*(){yield e}(),t));return await n.setup,X_.fromAsyncGenerator(n)}}class Xb extends qb{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const n=await S_.configure(t?.callbacks,void 0,t?.tags,void 0,t?.metadata),{runId:r,...a}=t??{},i=await(n?.handleChainStart(this.toJSON(),Zb(e,"input"),r,void 0,void 0,void 0,a?.runName));let s;for(const t of this.runnables())try{const n=await t.invoke(e,hb(a,{callbacks:i?.getChild()}));return await(i?.handleChainEnd(Zb(n,"output"))),n}catch(e){void 0===s&&(s=e)}if(void 0===s)throw new Error("No error stored at end of fallback.");throw await(i?.handleChainError(s)),s}async batch(e,t,n){if(n?.returnExceptions)throw new Error("Not implemented.");const r=this._getOptionsList(t??{},e.length),a=await Promise.all(r.map((e=>S_.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)))),i=await Promise.all(a.map((async(t,n)=>{const a=await(t?.handleChainStart(this.toJSON(),Zb(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,a})));let s;for(const t of this.runnables())try{const a=await t.batch(e,i.map(((e,t)=>hb(r[t],{callbacks:e?.getChild()}))),n);return await Promise.all(i.map(((e,t)=>e?.handleChainEnd(Zb(a[t],"output"))))),a}catch(e){void 0===s&&(s=e)}if(!s)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(i.map((e=>e?.handleChainError(s)))),s}}function Yb(e){if("function"==typeof e)return new Gb({func:e});if(qb.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[n,r]of Object.entries(e))t[n]=Yb(r);return new Vb({steps:t})}}class Qb extends qb{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Vb&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){const r=this.mapper.getStepsKeys(),[a,i]=Y_(e),s=this.mapper.transform(i,hb(n,{callbacks:t?.getChild()})),o=s.next();for await(const e of a){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!r.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of s)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=new eb(this.transform(async function*(){yield e}(),t));return await n.setup,X_.fromAsyncGenerator(n)}}class ev extends qb{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=new eb(this.transform(async function*(){yield e}(),t));return await n.setup,X_.fromAsyncGenerator(n)}}class tv extends qb{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class nv extends tv{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){super({callbacks:e??t,...n}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof n.cache?this.cache=n.cache:n.cache?this.cache=em.global():this.cache=void 0,this.caller=new cm(n??{})}async getNumTokens(e){if("string"!=typeof e)return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await async function(e){return async function(e){return e in gm||(gm[e]=ym.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then((e=>e.json())).then((e=>new mm(e))).catch((t=>{throw delete gm[e],t}))),await gm[e]}(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":return"o200k_base";default:throw new Error("Unknown model")}}(e))}("modelName"in this?(n=this.modelName,n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}var n;if(this._encoding)try{t=this._encoding.encode(e).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return t}static _convertInputToPromptValue(e){return"string"==typeof e?new nm(e):Array.isArray(e)?new rm(e.map($p)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()},r=Object.entries(n).filter((([e,t])=>void 0!==t)),a=r.map((([e,t])=>`${e}:${JSON.stringify(t)}`)).sort().join(",");return a}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class rv extends nv{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n?.timeout&&!n.signal&&(n.signal=AbortSignal.timeout(n.timeout)),[t,n]}async invoke(e,t){const n=rv._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===rv.prototype._streamResponseChunks)yield this.invoke(e,t);else{const n=rv._convertInputToPromptValue(e).toChatMessages(),[r,a]=this._separateRunnableConfigFromCallOptions(t),i=await S_.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),s={options:a,invocation_params:this?.invocationParams(a),batch_size:1},o=await(i?.handleChatModelStart(this.toJSON(),[n],r.runId,void 0,s,void 0,void 0,r.runName));let c;try{for await(const e of this._streamResponseChunks(n,a,o?.[0]))e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,c=c?c.concat(e):e}catch(e){throw await Promise.all((o??[]).map((t=>t?.handleLLMError(e)))),e}await Promise.all((o??[]).map((e=>e?.handleLLMEnd({generations:[[c]]}))))}}async _generateUncached(e,t,n){const r=e.map((e=>e.map($p))),a=await S_.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),i={options:t,invocation_params:this?.invocationParams(t),batch_size:1},s=await(a?.handleChatModelStart(this.toJSON(),r,n.runId,void 0,i,void 0,void 0,n.runName)),o=await Promise.allSettled(r.map(((e,n)=>this._generate(e,{...t,promptIndex:n},s?.[n])))),c=[],u=[];await Promise.all(o.map((async(e,t)=>{if("fulfilled"===e.status){const n=e.value;for(const e of n.generations)e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};return 1===n.generations.length&&(n.generations[0].message.response_metadata={...n.llmOutput,...n.generations[0].message.response_metadata}),c[t]=n.generations,u[t]=n.llmOutput,s?.[t]?.handleLLMEnd({generations:[n.generations],llmOutput:n.llmOutput})}return await(s?.[t]?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const l={generations:c,llmOutput:u.length?this._combineLLMOutput?.(...u):void 0};return Object.defineProperty(l,Dp,{value:s?{runIds:s?.map((e=>e.runId))}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:r,handledOptions:a}){const i=e.map((e=>e.map($p))),s=await S_.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),o={options:r,invocation_params:this?.invocationParams(r),batch_size:1,cached:!0},c=await(s?.handleChatModelStart(this.toJSON(),i,a.runId,void 0,o,void 0,void 0,a.runName)),u=[],l=await Promise.allSettled(i.map((async(e,r)=>{const a=rv._convertInputToPromptValue(e).toString(),i=await t.lookup(a,n);return null==i&&u.push(r),i}))),d=l.map(((e,t)=>({result:e,runManager:c?.[t]}))).filter((({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status)),h=[];await Promise.all(d.map((async({result:e,runManager:t},n)=>{if("fulfilled"===e.status){const r=e.value;return h[n]=r,r.length&&await(t?.handleLLMNewToken(r[0].text)),t?.handleLLMEnd({generations:[r]})}return await(t?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const f={generations:h,missingPromptIndices:u};return Object.defineProperty(f,Dp,{value:c?{runIds:c?.map((e=>e.runId))}:void 0,configurable:!0}),f}async generate(e,t,n){let r;r=Array.isArray(t)?{stop:t}:t;const a=e.map((e=>e.map($p))),[i,s]=this._separateRunnableConfigFromCallOptions(r);if(i.callbacks=i.callbacks??n,!this.cache)return this._generateUncached(a,s,i);const{cache:o}=this,c=this._getSerializedCacheKeyParametersForCall(s),{generations:u,missingPromptIndices:l}=await this._generateCached({messages:a,cache:o,llmStringKey:c,parsedOptions:s,handledOptions:i});let d={};if(l.length>0){const e=await this._generateUncached(l.map((e=>a[e])),s,i);await Promise.all(e.generations.map((async(e,t)=>{const n=l[t];u[n]=e;const r=rv._convertInputToPromptValue(a[n]).toString();return o.update(r,c,e)}))),d=e.llmOutput??{}}return{generations:u,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){const r=e.map((e=>e.toChatMessages()));return this.generate(r,t,n)}async call(e,t,n){return(await this.generate([e.map($p)],t,n)).generations[0][0].message}async callPrompt(e,t,n){const r=e.toChatMessages();return this.call(r,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const r=new Tp(e),a=await this.call([r],t,n);if("string"!=typeof a.content)throw new Error("Cannot use predict when output is not a string.");return a.content}}function av(e){return{name:e.name,description:e.description,parameters:Mb(e.schema)}}function iv(e){return function(e){return void 0!==e&&Array.isArray(e.lc_namespace)}(e)?{type:"function",function:av(e)}:e}class sv extends qb{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const n=db(t);return this.func&&await this.func(e,n),this._callWithConfig((e=>Promise.resolve(e)),e,n)}async*transform(e,t){const n=db(t);let r,a=!0;for await(const t of this._transformStreamWithConfig(e,(e=>e),n))if(yield t,a)if(void 0===r)r=t;else try{r=Q_(r,t)}catch{r=void 0,a=!1}this.func&&void 0!==r&&await this.func(r,n)}static assign(e){return new Qb(new Vb({steps:e}))}}class ov extends qb{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig((async(e,t)=>this.parseResult([{text:e}],t?.callbacks)),e,{...t,runType:"parser"}):this._callWithConfig((async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks)),e,{...t,runType:"parser"})}}class cv extends ov{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}}class uv extends Error{constructor(e,t,n,r=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=r,r&&(void 0===n||void 0===t))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}}function lv(e,t){const n=typeof e;if(n!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const n=e.length;if(n!==t.length)return!1;for(let r=0;r<n;r++)if(!lv(e[r],t[r]))return!1;return!0}if("object"===n){if(!e||!t)return e===t;const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(const r of n)if(!lv(e[r],t[r]))return!1;return!0}return e===t}"undefined"!=typeof self&&self.location&&"null"!==self.location.origin&&(self.location.origin,self.location.pathname,location.search);class dv extends cv{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class hv extends dv{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,n;for await(const a of e){if("string"!=typeof a&&"string"!=typeof a.content)throw new Error("Cannot handle non-string output.");let e;if(Op(r=a)&&"function"==typeof r.concat){if("string"!=typeof a.content)throw new Error("Cannot handle non-string message output.");e=new Bp({message:a,text:a.content})}else if(Op(a)){if("string"!=typeof a.content)throw new Error("Cannot handle non-string message output.");e=new Bp({message:Lp(a),text:a.content})}else e=new Up({text:a});n=void 0===n?e:n.concat(e);const i=await this.parsePartialResult([n]);null==i||lv(i,t)||(this.diff?yield this._diff(t,i):yield i,t=i)}var r}}class fv extends cv{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(Ry.object(Object.fromEntries(Object.entries(e).map((([e,t])=>[e,Ry.string().describe(t)])))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.\n\n"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.\n\nFor example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}\nwould match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.\nThus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.\n\nYour output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!\n\nHere is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:\n\`\`\`json\n${JSON.stringify(Mb(this.schema))}\n\`\`\`\n`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,((e,t)=>`"${t.replace(/\n/g,"\\n")}"`)).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new uv(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class pv extends hv{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?G_(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return lp(e[0].text)}async parse(e){return lp(e,JSON.parse)}getFormatInstructions(){return""}}function mv(e,t){if(void 0===e.function)return;let n;if(t?.partial)try{n=dp(e.function.arguments??"{}")}catch(e){return}else try{n=JSON.parse(e.function.arguments)}catch(t){throw new uv([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${t.message}`].join("\n"))}const r={name:e.function.name,args:n};return t?.returnId&&(r.id=e.id),r}function gv(e){if(void 0===e.id)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function yv(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t}}class _v extends ov{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}async parseResult(e){const t=e[0].message.additional_kwargs.tool_calls;if(!t)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);const n=JSON.parse(JSON.stringify(t)),r=[];for(const e of n){const t=mv(e,{partial:!0});if(void 0!==t){const e={type:t.name,args:t.args,id:t.id};Object.defineProperty(e,"name",{get(){return this.type}}),Object.defineProperty(e,"arguments",{get(){return this.args}}),r.push(e)}}return r}}class bv extends ov{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.initialParser=new _v(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new uv(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=(await this.initialParser.parseResult(e)).filter((e=>e.type===this.keyName));let n=t;if(this.returnId||(n=t.map((e=>e.args))),this.returnSingle)return this._validateResult(n[0]);const r=await Promise.all(n.map((e=>this._validateResult(e))));return r}}function vv(e,t){const n=[];for(const[r,a]of Object.entries(e.properties??{}))a.description&&t<2&&n.push(`// ${a.description}`),e.required?.includes(r)?n.push(`${r}: ${wv(a,t)},`):n.push(`${r}?: ${wv(a,t)},`);return n.map((e=>" ".repeat(t)+e)).join("\n")}function wv(e,t){if(function(e){return void 0!==e.anyOf&&Array.isArray(e.anyOf)}(e))return e.anyOf.map((e=>wv(e,t))).join(" | ");switch(e.type){case"string":return e.enum?e.enum.map((e=>`"${e}"`)).join(" | "):"string";case"number":case"integer":return e.enum?e.enum.map((e=>`${e}`)).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",vv(e,t+2),"}"].join("\n");case"array":return e.items?`${wv(e.items,t)}[]`:"any[]";default:return""}}function xv(e){const t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!Ep.isInstance(e))throw new Error("Invalid generic chat message");return function(e){return"system"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role}(e);default:throw new Error(`Unknown message type: ${t}`)}}function kv(e){const t=e.tool_calls;if("assistant"===e.role){const n=[],r=[];for(const e of t??[])try{n.push(mv(e,{returnId:!0}))}catch(t){r.push(yv(e,t.message))}return new Sp({content:e.content||"",tool_calls:n,invalid_tool_calls:r,additional_kwargs:{function_call:e.function_call,tool_calls:t}})}return new Ep(e.content||"",e.role??"unknown")}function Ov(e,t){const n=e.role??t,r=e.content??"";let a;if(a=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},"user"===n)return new Np({content:r});if("assistant"===n){const t=[];if(Array.isArray(e.tool_calls))for(const n of e.tool_calls)t.push({name:n.function?.name,args:n.function?.arguments,id:n.id,index:n.index});return new Pp({content:r,tool_call_chunks:t,additional_kwargs:a})}return"system"===n?new Rp({content:r}):"function"===n?new jp({content:r,additional_kwargs:a,name:e.name}):"tool"===n?new Ap({content:r,additional_kwargs:a,tool_call_id:e.tool_call_id}):new Ip({content:r,role:n})}function Av(e){return e.map((e=>{const t={role:xv(e),content:e.content};return null!=e.name&&(t.name=e.name),null!=e.additional_kwargs.function_call&&(t.function_call=e.additional_kwargs.function_call),"ai"===e._getType()&&e.tool_calls?.length?t.tool_calls=e.tool_calls.map(gv):(null!=e.additional_kwargs.tool_calls&&(t.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(t.tool_call_id=e.tool_call_id)),t}))}class Sv extends rv{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??qp("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??qp("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.apiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??qp("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??qp("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??qp("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??qp("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??qp("OPENAI_ORGANIZATION"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??""}this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}bindTools(e,t){return this.bind({tools:e.map(iv),...t})}invocationParams(e){var t;return{model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:(t=e?.tools,void 0!==t&&t.every((e=>Array.isArray(e.lc_namespace)))?e?.tools.map(iv):e?.tools),tool_choice:e?.tool_choice,response_format:e?.response_format,seed:e?.seed,...this.modelKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){const r=Av(e),a={...this.invocationParams(t),messages:r,stream:!0};let i;const s=await this.completionWithRetry(a,t);for await(const e of s){const r=e?.choices[0];if(!r)continue;const{delta:a}=r;if(!a)continue;const s=Ov(a,i);i=a.role??i;const o={prompt:t.promptIndex??0,completion:r.index??0};if("string"!=typeof s.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const c={...o};void 0!==r.finish_reason&&(c.finish_reason=r.finish_reason),this.logprobs&&(c.logprobs=r.logprobs);const u=new Bp({message:s,text:s.content,generationInfo:c});yield u,n?.handleLLMNewToken(u.text??"",o,void 0,void 0,void 0,{chunk:u})}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,n){const r={},a=this.invocationParams(t),i=Av(e);if(a.stream){const a=this._streamResponseChunks(e,t,n),i={};for await(const e of a){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};const t=e.generationInfo?.completion??0;void 0===i[t]?i[t]=e:i[t]=i[t].concat(e)}const s=Object.entries(i).sort((([e],[t])=>parseInt(e,10)-parseInt(t,10))).map((([e,t])=>t)),{functions:o,function_call:c}=this.invocationParams(t),u=await this.getEstimatedTokenCountFromPrompt(e,o,c),l=await this.getNumTokensFromGenerations(s);return r.promptTokens=u,r.completionTokens=l,r.totalTokens=u+l,{generations:s,llmOutput:{estimatedTokenUsage:r}}}{const e=await this.completionWithRetry({...a,stream:!1,messages:i},{signal:t?.signal,...t?.options}),{completion_tokens:n,prompt_tokens:s,total_tokens:o}=e?.usage??{};n&&(r.completionTokens=(r.completionTokens??0)+n),s&&(r.promptTokens=(r.promptTokens??0)+s),o&&(r.totalTokens=(r.totalTokens??0)+o);const c=[];for(const t of e?.choices??[]){const e={text:t.message?.content??"",message:kv(t.message??{role:"assistant"})};e.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},c.push(e)}return{generations:c,llmOutput:{tokenUsage:r}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let r=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==n){const e=function(e){const t=["namespace functions {",""];for(const n of e)n.description&&t.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(t.push(`type ${n.name} = (_: {`),t.push(vv(n.parameters,0)),t.push("}) => any;")):t.push(`type ${n.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);r+=await this.getNumTokens(e),r+=9}return t&&e.find((e=>"system"===e._getType()))&&(r-=4),"none"===n?r+=1:"object"==typeof n&&(r+=await this.getNumTokens(n.name)+4),r}async getNumTokensFromGenerations(e){return(await Promise.all(e.map((async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content))))).reduce(((e,t)=>e+t),0)}async getNumTokensFromMessages(e){let t=0,n=0,r=0;"gpt-3.5-turbo-0301"===this.model?(n=4,r=-1):(n=3,r=1);const a=await Promise.all(e.map((async e=>{const a=await this.getNumTokens(e.content),i=await this.getNumTokens(xv(e)),s=void 0!==e.name?r+await this.getNumTokens(e.name):0;let o=a+n+i+s;const c=e;if("function"===c._getType()&&(o-=2),c.additional_kwargs?.function_call&&(o+=3),c?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(c.additional_kwargs.function_call?.name)),c.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(c.additional_kwargs.function_call?.arguments)))}catch(e){console.error("Error parsing function arguments",e,JSON.stringify(c.additional_kwargs.function_call)),o+=await this.getNumTokens(c.additional_kwargs.function_call?.arguments)}return t+=o,o})));return t+=3,{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call((async()=>{try{return await this.client.chat.completions.create(e,n)}catch(e){throw function(e){let t;return e.constructor.name===Yf.name?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===Qf.name?(t=new Error(e.message),t.name="AbortError"):t=e,t}(e)}}))}_getClientOptions(e){if(!this.client){const e=function(e){const{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:a,baseURL:i}=e;if(r&&a&&t)return`${a}/${t}`;if(r){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${t}`}return i}({azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new Kf(t)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce(((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e)),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,r,a,i;var s;let o,c;if(void 0!==(s=e)&&"object"==typeof s.schema?(n=e.schema,r=e.name,a=e.method,i=e.includeRaw):(n=e,r=t?.name,a=t?.method,i=t?.includeRaw),"jsonMode"===a)o=this.bind({response_format:{type:"json_object"}}),c=Pv(n)?fv.fromZodSchema(n):new pv;else{let e=r??"extract";if(Pv(n)){const t=Mb(n);o=this.bind({tools:[{type:"function",function:{name:e,description:t.description,parameters:t}}],tool_choice:{type:"function",function:{name:e}}}),c=new bv({returnSingle:!0,keyName:e,zodSchema:n})}else{let t;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(t=n,e=n.name):(e=n.title??e,t={name:e,description:n.description??"",parameters:n}),o=this.bind({tools:[{type:"function",function:t}],tool_choice:{type:"function",function:{name:e}}}),c=new bv({returnSingle:!0,keyName:e})}}if(!i)return o.pipe(c);const u=sv.assign({parsed:(e,t)=>c.invoke(e.raw,t)}),l=sv.assign({parsed:()=>null}),d=u.withFallbacks({fallbacks:[l]});return Kb.from([{raw:o},d])}}function Pv(e){return"function"==typeof e?.parse}class Ev extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}class Iv extends tv{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1})}async invoke(e,t){return this.call(e,db(t))}async call(e,t,n){let r;try{r=await this.schema.parseAsync(e)}catch(t){throw new Ev("Received tool input did not match expected schema",JSON.stringify(e))}const a=function(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}(t),i=await S_.configure(a.callbacks,this.callbacks,a.tags||n,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),s=await(i?.handleToolStart(this.toJSON(),"string"==typeof r?r:JSON.stringify(r),a.runId,void 0,void 0,void 0,a.runName));let o;delete a.runId;try{o=await this._call(r,s,a)}catch(e){throw await(s?.handleToolError(e)),e}return await(s?.handleToolEnd(o)),o}}class jv extends Iv{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:Ry.object({input:Ry.string().optional()}).transform((e=>e.input))})}call(e,t){return super.call("string"!=typeof e&&e?e:{input:e},t)}}function Tv(){return new Sv({})}function Nv(e,t,n){return Uint8Array.from([144+e,t,n])}function Cv(e,t,n){return Uint8Array.from([128+e,t,n])}function Rv(e,t,n){return Uint8Array.from([176+e,t,n])}function $v(e){return e.toISOString()}function Mv(){return $v(new Date)}function Lv(e){return $v(e).split("T")[0].replace(/-/g,"_")}function Dv(){return Lv(new Date)}function Uv(e){return Number(e)}function Bv(){return Uv(new Date)}function Fv(e,t){return e.getTime()==t.getTime()}function zv(e){return new Date(e.getTime())}function Zv(e){return e.toString().split(" ").slice(0,4).join(" ").replace(" ","_")}function qv(e,t){let n=zv(e);switch(t){case"year":n.setMonth(0);case"month":n.setDate(1);case"day":n.setHours(0);case"hour":n.setMinutes(0);case"minute":n.setSeconds(0);case"second":n.setMilliseconds(0);case"millisecond":break;default:return n}return n}function Hv(e,t,n){let r=zv(e);switch(n){case"year":r.setFullYear(r.getFullYear()+t);break;case"month":r.setMonth(r.getMonth()+t);break;case"day":r.setDate(r.getDate()+t);break;case"hour":r.setHours(r.getHours()+t);break;case"minute":r.setMinutes(r.getMinutes()+t);break;case"second":r.setSeconds(r.getSeconds()+t);break;case"millisecond":r.setMilliseconds(r.getMilliseconds()+t);break;default:return r}return r}Object.defineProperty(class extends jv{static lc_name(){return"DallEAPIWrapper"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t={apiKey:e?.apiKey??e?.openAIApiKey??qp("OPENAI_API_KEY"),organization:e?.organization??qp("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0};this.client=new Kf(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.responseFormat=e?.responseFormat??this.responseFormat,this.user=e?.user}async _call(e){const t=await this.client.images.generate({model:this.model,prompt:e,n:this.n,size:this.size,response_format:this.responseFormat,style:this.style,quality:this.quality,user:this.user});let n="";return"url"===this.responseFormat?[n]=t.data.map((e=>e.url)).filter((e=>"undefined"!==e)):[n]=t.data.map((e=>e.b64_json)).filter((e=>"undefined"!==e)),n}},"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var Wv={"1sec":1e3,"5sec":5e3,"10sec":1e4,"30sec":3e4,"1min":6e4,"2min":12e4,"5min":3e5,"10min":6e5,"30min":18e5,"1hr":36e5,"1day":864e5};const Jv=Ue({id:"common"});async function Kv(e,t){let n=`${e}?${new URLSearchParams(t)}`;return Jv(`Querying with url= ${n}`),(await fetch(n,{method:"GET",cache:"no-cache",headers:{"Content-Type":"application/json"},redirect:"follow"})).json()}})();var s=t;for(var o in i)s[o]=i[o];i.__esModule&&Object.defineProperty(s,"__esModule",{value:!0})}},r={};function a(e){var t=r[e];if(void 0!==t)return t.exports;var i=r[e]={exports:{}};return n[e](i,i.exports,a),i.exports}a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};(()=>{a.r(i),a.d(i,{apis:()=>E,common:()=>N,components:()=>I,cryptocurrency:()=>m,umd:()=>T,util:()=>h});var e={};a.r(e),a.d(e,{_speak:()=>V,default_rate:()=>J,finished_speaking:()=>B,finished_utterance:()=>U,get_voice:()=>Z,get_voice_by_name:()=>q,get_voices:()=>z,is_speaking:()=>F,set_default_rate:()=>K,speak:()=>G,speech_que:()=>D,tts:()=>L,voices_ready:()=>H,wait_until_voices_ready:()=>W});var t={};a.r(t),a.d(t,{get_recognition_object:()=>X});var n={};a.r(n),a.d(n,{audio_context:()=>te,error:()=>he,input_ready:()=>fe,m2f:()=>Y,note_obj_to_midi:()=>ae,note_to_freq:()=>oe,note_to_midi:()=>se,note_to_note_obj:()=>ie,play_note:()=>ce,play_notes:()=>ue,play_notes_delay:()=>le,proceed:()=>pe,success:()=>de,tone:()=>re});var r={};a.r(r),a.d(r,{audio_primitives:()=>ge,connect:()=>_e,disconnect:()=>be});var s={};a.r(s),a.d(s,{_recorder:()=>xe,get_current_data:()=>Ee,get_recorder_object:()=>ke,get_recorder_state:()=>Ie,is_supported:()=>we,pause_recording:()=>Se,resume_recording:()=>Pe,start_recording:()=>Oe,stop_recording:()=>Ae});var o={};a.r(o),a.d(o,{audio_detector:()=>Me,detection_threshold:()=>Re,listeners:()=>Ce,media_recorder:()=>s,mic:()=>r,set_detection_threshold:()=>$e,start_power:()=>Ne,stop:()=>Le});var c={};a.r(c),a.d(c,{dot_join:()=>ze,full_name:()=>Ze,get:()=>He,get_header:()=>Je,get_keys:()=>We,get_t:()=>Ve,set_storage_header:()=>Fe,store:()=>qe,store_t:()=>Ke});var u={};a.r(u),a.d(u,{RecognitionState:()=>Ge,ap:()=>o,initialize_recognition:()=>et,pause_recognition:()=>tt,recognition:()=>Ye,recognition_state:()=>Qe,set_default_tts_rate:()=>ot,set_default_voice_from_name_preference_list:()=>ct,set_default_voice_uri:()=>st,speak:()=>lt,speak_with_rate:()=>dt,speak_with_voice:()=>ut,sr:()=>t,start_recognition:()=>rt,start_recognition_and_detection:()=>it,stop_recognition:()=>nt,stop_recognition_and_detection:()=>at,tts:()=>e});var l={};a.r(l),a.d(l,{WebSocketMaker:()=>ft});var d={};a.r(d),a.d(d,{set_value_by_id:()=>pt});var h={};a.r(h),a.d(h,{add_css:()=>kt,add_script:()=>wt,alert:()=>gt,audio_processing:()=>o,define:()=>vt,dom:()=>d,inject_script:()=>xt,is_chrome:()=>yt,is_mobile:()=>_t,sounds:()=>n,speech_recognition:()=>t,tts:()=>e,uuid:()=>bt,voice_interface:()=>u,ws:()=>l});var f={};a.r(f),a.d(f,{basic_spot_kine_socket:()=>St,basic_spot_trade_socket:()=>Et,spot_kline_socket:()=>At,spot_trade_socket:()=>Pt});var p={};a.r(p),a.d(p,{buy_beep:()=>Tt,sell_beep:()=>Nt,set_sound_options:()=>jt,sound_options:()=>It,trade_beeper:()=>Ct});var m={};a.r(m),a.d(m,{binance_listener:()=>p,binance_ws:()=>f});var g={};a.r(g),a.d(g,{load_key_handlers:()=>$t});var y={};a.r(y),a.d(y,{keys:()=>zt,keys_to_notes_1:()=>Zt,load_sound_key_handler:()=>Ht,sound_key_handler:()=>qt});var _={};a.r(_),a.d(_,{get_openai:()=>Gt,get_openai_tts_response:()=>Qt,openai_davinci_prompt:()=>en,speak:()=>Xt,text_to_audio:()=>Yt});var b={};a.r(b),a.d(b,{encode_json_to_uint8:()=>nn,get_datagram_writer:()=>rn,get_json_writer:()=>sn,init:()=>tn,write_json_datagram:()=>an});var v={};a.r(v),a.d(v,{libraries:()=>cn,load_all:()=>pn,load_firebase_app:()=>un,load_firebase_auth:()=>ln,load_firebase_firestore:()=>hn,load_firebase_ui:()=>dn,load_firebase_ui_css:()=>fn});var w={};a.r(w),a.d(w,{loader:()=>v});var x={};a.r(x),a.d(x,{get_midi_writer:()=>mn});var k={};a.r(k),a.d(k,{webtransport:()=>x});var O={};a.r(O),a.d(O,{log_motion:()=>wn,log_orientation:()=>xn,motion_handler:()=>Pn,motion_subscribers:()=>bn,orientation_handler:()=>En,orientation_subscribers:()=>vn,start_device_motion:()=>In,start_device_orientation:()=>jn,stop_device_motion:()=>Tn,stop_device_orientation:()=>Nn,subscribe_to_motion:()=>kn,subscribe_to_orientation:()=>On,unsubscribe_motion_id:()=>An,unsubscribe_orientation_id:()=>Sn});var A={};a.r(A),a.d(A,{CACHE_CHECK_INTERVAL:()=>Bn,GET_DB:()=>Hn,LOCAL_DB_HANDLE_CACHE:()=>Un,START_CACHE_CHECK:()=>Vn,STOP_CACHE_CHECK:()=>Gn,cache_check_interval_id:()=>Jn,default_db_header:()=>zn,default_store_name:()=>Fn,deleteDB:()=>Xn,do_cache_check:()=>Kn,exportDBString:()=>Yn,importFromJson:()=>Qn,log:()=>Ln,set_cache_check_interval:()=>Wn});var S={};a.r(S),a.d(S,{load_bokeh_scripts:()=>nr});var P={};a.r(P),a.d(P,{SoundEventDetector:()=>vr,a1:()=>wr,a2:()=>xr,analyser:()=>sr,ctx:()=>ar,data_array:()=>yr,decode_audio_array_buffer:()=>hr,decode_audio_blob:()=>fr,get_audio_context:()=>ur,get_audio_stream:()=>lr,get_sampling_rate:()=>dr,get_sound_event_detector:()=>Or,initialize_microphone:()=>br,mic_callbacks:()=>pr,mic_initialized:()=>_r,plot_data:()=>Ar,register_mic_callback:()=>mr,run_mic_callbacks:()=>gr,sound_event_detector:()=>or,stream:()=>ir,test_diff:()=>kr});var E={};a.r(E),a.d(E,{bind_sounds_to_keys:()=>y,bokeh:()=>S,db:()=>A,firebase:()=>w,key_presses:()=>g,local_storage:()=>c,midi:()=>k,openai:()=>_,sensor:()=>O,web_audio:()=>P,webtransport:()=>b});var I={};a.r(I);var j={};a.r(j),a.d(j,{adjust_tts_rate:()=>Br,click_input:()=>Er,configure_tts:()=>Fr,default_monitoring_interval:()=>zr,enter_input:()=>Ir,finish_stream_handler:()=>Mr,initialize_voice_system:()=>Zr,initialize_voice_system_with_tts:()=>qr,input_area:()=>Sr,monitor_responses:()=>Lr,new_text_handler:()=>Cr,set_input:()=>Pr,speak:()=>$r,speech_text_handler:()=>Rr,start_speech_recognition_and_link_to_input:()=>jr,stop_monitoring:()=>Ur,voice_preference_order:()=>Dr});var T={};a.r(T),a.d(T,{chatgpt:()=>j});var N=a(78);let{asnc:C,fp:R,logger:$}=N,M=$.get_logger({id:"tts"});var L=function(){return window.speechSynthesis},D=[];async function U(){await C.wait_until((()=>!L().speaking),1/0,200)}async function B(){await C.wait_until((()=>!L().speaking&&D.length<1),1/0,200)}function F(){return L().speaking||D.length>0}function z(){return L().getVoices()}function Z(e){let t=L().getVoices().filter((t=>t.voiceURI==e));return t.length>0?t[0]:null}function q(e){let t=L().getVoices().filter((t=>t.name==e));return t.length>0?t[0]:null}function H(){try{return L().getVoices().length>0}catch(e){return!1}}async function W(){await N.asnc.wait_until(H,3e3,200),M("voices_ready")}var J=1;function K(e){J=e,M("Default rate set to: "+e)}async function V(e){let{voiceURI:t,rate:n=J,text:r}=e;if(L().speaking)console.log("Scheduling speech for later."),D.push(e);else{var a=new window.SpeechSynthesisUtterance(r);if(t){let e=Z(t);e&&(a.voice=e)}a.rate=n,L().speak(a),await U();let e=D.shift();e?V(e):console.log("done with speech que")}}function G(e){let{voiceURI:t,rate:n=J,text:r}=e;M("Request to speak  =:> "+r),M("With voice =:> "+t),R.map(R.partition(R.split(r," "),20),R.joiner(" ")).forEach((function(t){let n=R.clone(e);n.text=t,V(n)}))}function X(e={}){let{result_dispatch:t="tidyscripts_web_speech_recognition_result"}=e,{continuous:n=!0,interimResults:r=!1,onStart:a=(()=>{console.log("Recognition started")}),onSoundStart:i=(()=>{console.log("Sound started...")}),onSoundEnd:s=(()=>{console.log("Sound ended...")}),onSpeechStart:o=(()=>{console.log("Speech started...")}),onSpeechEnd:c=(()=>{console.log("Speech ended...")}),onResult:u=function(e){let n=e.results[e.resultIndex][0].transcript;console.log("Recognition result: "+n),window.dispatchEvent(new CustomEvent(t,{detail:n}))},onError:l=(e=>{console.log("Recognition error: "),console.log(e)}),onEnd:d=(()=>{console.log("Recognition ended")}),lang:h="en-US"}=e,f=new window.webkitSpeechRecognition;return f.onresult=u,f.onerror=l,f.onend=d,f.continuous=n,f.interimResults=r,f.onstart=a,f.onsoundstart=i,f.onsoundend=s,f.onspeechstart=o,f.onspeechend=c,f}var Y={12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:27.5,22:29.135,23:30.868,24:32.703,25:34.648,26:36.708,27:38.891,28:41.203,29:43.654,30:46.249,31:48.999,32:51.913,33:55,34:58.27,35:61.735,36:65.406,37:69.296,38:73.416,39:77.782,40:82.407,41:87.307,42:92.499,43:97.999,44:103.826,45:110,46:116.541,47:123.471,48:130.813,49:138.591,50:146.832,51:155.564,52:164.814,53:174.614,54:184.997,55:195.998,56:207.652,57:220,58:233.082,59:246.942,60:261.626,61:277.183,62:293.665,63:311.127,64:329.628,65:349.228,66:369.994,67:391.995,68:415.305,69:440,70:466.164,71:493.883,72:523.251,73:554.365,74:587.33,75:622.254,76:659.255,77:698.457,78:739.989,79:783.991,80:830.609,81:880,82:932.328,83:987.767,84:1046.502,85:1108.731,86:1174.659,87:1244.508,88:1318.51,89:1396.913,90:1479.978,91:1567.982,92:1661.219,93:1760,94:1864.655,95:1975.533,96:2093.005,97:2217.461,98:2349.318,99:2489.016,100:2637.021,101:2793.826,102:2959.956,103:3135.964,104:3322.438,105:3520,106:3729.31,107:3951.066,108:4186.009,109:4434.922,110:4698.637,111:4978.032,112:5274.042,113:5587.652,114:5919.912,115:6271.928,116:6644.876,117:7040,118:7458.62,119:7902.133,120:8372.019,121:8869.845,122:9397.273,123:9956.064,124:10548.083,125:11175.305,126:11839.823,127:12543.855};let{fp:Q,asnc:ee}=N;var te=null,ne=function(){if(te)return te;{let e=window.AudioContext||window.webkitAudioContext;return te=new e}};async function re(e){let{type:t="sine",duration:n=600,gain:r=.5,delay:a,freq:i}=e,s=ne();var o=s.createOscillator();o.frequency.value=i,o.type=t;var c=s.createGain();if(a){var u=s.createDelay();u.delayTime.value=a,c.connect(u),u.connect(s.destination)}c.gain.value=r,o.connect(c),c.connect(s.destination),o.start(0),await ee.wait(n),o.stop()}function ae(e){let{num:t,mod:n,octave:r}=e,a=function(e){return Q.nth([0,0,2,4,5,7,9,11,12],e)}(t)+12*r;return n&&(a+="#"==n?1:-1),a}function ie(e){let t=e.split(".");var n=0,r=null,a=null;return t.length>1&&(n=Number(t[1])),t[0].length>1?(r=t[0][0],a=Number(t[0][1])):a=Number(t[0][0]),{num:a,mod:r,octave:n}}function se(e){return ae(ie(e))}function oe(e){return Y[se(e)]}async function ce(e,t,n){console.log(Q.format("note | n= {}, dur={}, k={}",[e,t,n]));let r=n?se(n):60,a=se(e),i=Y[String(r+a)],s=t||500;try{await re({freq:i,duration:s})}catch(e){console.log("Error playing. You likely played a note outside of currently supported range"),console.log(e),console.log("freq + duration:"),console.log({freq:i,duration:s})}}async function ue(e,t,n){e.map((e=>ce(e,t,n)))}async function le(e,t,n,r){for(var a of e)ce(a,n,r),await ee.wait(t)}function de(){ue(["1","3"],400,"3.5")}function he(){ue(["1","b5"],200,"3.5")}function fe(){le(["1","3"],100,100,"3.5")}function pe(){ue(["5.-1"],100,"3.5")}const me=N.logger.get_logger({id:"mic"});var ge={context:null,source:null,processor:null,stream:null,mic_sample_rate:null},ye=function(e,t){return function(n){var r,a,i,s,o;ge.stream=n,ge.context=new window.AudioContext,ge.source=null===(r=ge.context)||void 0===r?void 0:r.createMediaStreamSource(n),ge.processor=null===(a=ge.context)||void 0===a?void 0:a.createScriptProcessor(1024,1,1),null===(i=ge.source)||void 0===i||i.connect(ge.processor),null===(s=ge.processor)||void 0===s||s.connect(null===(o=ge.context)||void 0===o?void 0:o.destination),ge.processor.onaudioprocess=function(n){let r=e(n.inputBuffer.getChannelData(0));const a=new window.CustomEvent(t,{detail:r});window.dispatchEvent(a)};let c=n.getAudioTracks()[0].getSettings().sampleRate;ge.mic_sample_rate=c,me(`Determined sample rate of mic : ${ge.mic_sample_rate}`)}};function _e(e,t){let n=t||"tidyscripts_web_mic";window.navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(ye(e,n))}function be(){let e=ge.context;e&&e.close(),ge={context:null,source:null,processor:null,stream:null,mic_sample_rate:null}}const ve=N.logger.get_logger({id:"media_recorder"});function we(){return!!window.navigator.mediaDevices}var xe=null;async function ke(){if(xe)return xe;if(!we())return void ve("NOT SUPPORTED");let e=await navigator.mediaDevices.getUserMedia({audio:!0});return xe=new MediaRecorder(e)}async function Oe(e,t){let n=await ke();n.addEventListener("dataavailable",(async function(t){e(await t.data)})),n.start(t),ve("Recording started")}async function Ae(){(await ke()).stop(),ve("Recording stopped")}async function Se(){(await ke()).pause(),ve("Recording paused")}async function Pe(){(await ke()).resume(),ve("Recording resumed")}async function Ee(){return(await ke()).requestData()}async function Ie(){return(await ke()).state}let{dsp:je,performance:Te}=N.util;function Ne(){_e((e=>je.power(e)),"tidyscripts_web_mic")}var Ce=[],Re=1e3;function $e(e){Re=e}function Me(e,t){Ne(),t&&$e(t);var n=0,r=Te.ms();let a=t=>{let a=t.detail;if(0==n)return void(n=a);let i=a/n*100;Te.ms()-r>600&&i>Re&&e(),n=a};window.addEventListener("tidyscripts_web_mic",a),Ce.push(["tidyscripts_web_mic",a])}function Le(){for(var e of(be(),Ce))window.removeEventListener(e[0],e[1]);Ce=[]}let{fp:De}=N,Ue=function(){return window.localStorage};var Be="tidyscripts";function Fe(e){Be=e}function ze(e){return e.join(".")}function Ze(e){return ze([Be,e])}function qe(e,t){Ue()[Ze(t)]=JSON.stringify(e)}function He(e){let t=Ue()[Ze(e)];return t?JSON.parse(t):null}function We(){return Object.keys(Ue())}function Je(e){let t=We();return De.filter(t,(t=>t.startsWith(e)))}function Ke(e,t){qe({timestamp:Number(new Date),data:e},t)}function Ve(e){return He(e)}var Ge,Xe=N.logger.get_logger({id:"voice_interface"}),Ye=null;!function(e){e.NULL="NULL",e.STOPPED="STOPPED",e.PAUSED="PAUSED",e.LISTENING="LISTENING",e.STOPPING="STOPPING"}(Ge||(Ge={}));var Qe=Ge.NULL;function et(e){nt();let t=(e=e||{}).onEnd;e.onEnd=function(){Qe==Ge.STOPPING?(Xe("Recognition stopped"),Qe=Ge.STOPPED):(Qe=Ge.PAUSED,Xe("Recognition paused")),t&&t()},Ye=X(e),Qe=Ge.PAUSED,Me(rt)}function tt(){Ye&&(Ye.abort(),Qe=Ge.PAUSED)}function nt(){Ye&&(Xe("Stopping recognition"),Qe=Ge.STOPPING,Ye.abort(),Ye=null,Le())}async function rt(){Qe!=Ge.LISTENING&&(F()&&Xe("Wont start recognition while tts active"),Ye?Ye.start():(et(),Xe("Recognition initialized without args")),Qe=Ge.LISTENING)}function at(){let e=Re;return tt(),$e(1/0),e}function it(e){rt(),$e(e)}function st(e){qe("default_voice_uri",e)}function ot(e){K(e)}function ct(e){for(var t of e){let e=q(t);if(e)return st(e.voiceURI),void Xe(`Set default voice to: ${e.name}`)}Xe("Unable to set default voice to any matching name in provided list")}async function ut(e,t,n){if(Ye){let r=at();G({text:e,voiceURI:t,rate:n}),await B(),it(r)}else G({text:e,voiceURI:t,rate:n}),await B()}async function lt(e){ut(e,He("default_voice_uri"),J)}async function dt(e,t){ut(e,He("default_voice_uri"),t)}let ht=N.logger.get_logger({id:"ws"});function ft(e){var{url:t,handler:n,open:r,error:a,close:i}=e;r=r||(()=>{ht(`ws to ${t} opened`)}),i=i||(()=>{ht(`ws to ${t} closed`)}),a=a||(e=>{ht(`ws to ${t} errored: ${JSON.stringify(e)}`)});let s=new WebSocket(t);return s.onopen=r,s.onclose=i,s.onerror=a,s.onmessage=e=>{n(e.data)},s}function pt(e,t){document.getElementById(e).value=t}let mt=N.logger.get_logger({id:"wutil"});function gt(e){mt("Alerting web page!"),window.alert(e)}function yt(){return/Chrome/.test(window.navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}function _t(){return/Mobi/.test(window.navigator.userAgent)}function bt(){var e=new Uint32Array(4);window.crypto.getRandomValues(e);var t=-1;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(n){t++;var r=e[t>>3]>>t%8*4&15;return("x"==n?r:3&r|8).toString(16)}))}async function vt(e,t){window[t]=await e,mt(`Defined ${t} on the window object :)`)}function wt(e){return new Promise(((t,n)=>{const r=window.document.createElement("script");r.setAttribute("src",e),r.addEventListener("load",t),r.addEventListener("error",n),document.body.appendChild(r)}))}function xt(e){return new Promise(((t,n)=>{const r=window.document.createElement("script");r.setAttribute("src",e.src);let a=e.attributes;if(a){let e=Object.keys(a);for(let t of e)r.setAttribute(t,a[t])}r.addEventListener("load",t),r.addEventListener("error",n),document.body.appendChild(r)}))}function kt(e){return new Promise(((t,n)=>{var r=document.createElement("link");r.rel="stylesheet",r.type="text/css",r.href=e,r.media="all",r.addEventListener("load",t),r.addEventListener("error",n),document.getElementsByTagName("head")[0].appendChild(r)}))}let Ot=N.logger.get_logger({id:"bws"});function At(e,t){let{sym:n,handler:r,error:a,close:i,open:s}=e;n=n.toLowerCase();let o=`wss://stream.binance.com:9443/ws/${n}@kline_${t=t||"1m"}`;return Ot("Using url for spot kline socket: "+o),ft({url:o,handler:r,error:a,close:i,open:s})}function St(e,t){return At({sym:e,handler:t=t||(e=>{console.log(JSON.parse(e))})})}function Pt(e){let{sym:t,handler:n,error:r,close:a,open:i}=e;t=t.toLowerCase();let s=`wss://stream.binance.com:9443/ws/${t}@aggTrade`;return Ot("Using url for spot trade socket: "+s),ft({url:s,handler:n,error:r,close:a,open:i})}function Et(e,t){return Pt({sym:e,handler:t=t||(e=>{console.log(JSON.parse(e))})})}var It={freq:{buy:620,sell:580},duration:{buy:30,sell:30}};function jt(e){It=e}function Tt(e){re({freq:It.freq.buy,gain:e,duration:It.duration.buy})}function Nt(e){re({freq:It.freq.sell,gain:e,duration:It.duration.sell})}function Ct(e){return Et(e,(function(e){let t=JSON.parse(e),{m:n,p:r,q:a}=t,i=Number(a),s=i>1?1:i;console.log(t),n?Nt(s):Tt(s)}))}let Rt=N.logger.get_logger({id:"key_presses"});function $t(e){window.onkeypress=function(t){Rt("Keypress!");let n=t.key;console.log(n),e[n]&&e[n]()}}N.fp,N.util.debug;let Mt=N.logger.get_logger({id:"key_sounds"}),Lt=N.fp,Dt=N.util.debug;var Ut=["q","w","e","r","t","y","u","i","o","p","["],Bt=["a","s","d","f","g","h","j","k","l",";"],Ft=["z","x","c","v","b","n","m",","],zt={hi:Ut,mid:Bt,lo:Ft};function Zt(e){let t=Ft.concat(Bt).concat(Ut),n=0,r={};for(var a of Lt.enumerate(t)){a[0]%7==0&&(n+=1);let e=a[0]%7+1,t=Lt.format("{}.{}",[e,n]);r[a[1]]=t}return r}function qt(e,t=30,n="1.4"){let r={};for(var a of Lt.dict_to_list(e)){let e=a[0],i=a[1];r[e]=function(){Mt(String(i)),ce(String(i),t,n)}}return r}function Ht(e=30,t="1.4"){let n=qt(Zt(),e,t);$t(n),Dt.add("km",n)}let{get_json_from_url:Wt}=N,{OpenAI:Jt}=N.apis;var Kt=null;const Vt=N.logger.get_logger({id:"open_ai_web"});function Gt(){if(Kt)return Vt("OpenAI already initialized"),Kt;{Vt("Initializing open api in browser");let e=localStorage.OAAK;if(e)return Kt=new Jt({apiKey:e,dangerouslyAllowBrowser:!0}),Vt("Complete"),Kt;{let e='Unable to find API key; please make sure api key is under "OOAK" in local storage';return Vt(e),window.alert(e),1}}}async function Xt(e){Vt(`Request to speak ${e}`);let t=await Yt(e);return Vt("Retrieved audio data from openai"),Vt("Playing audio and returning data"),t.audio_element.play(),t}async function Yt(e){let t=await Qt(e),n=await t.blob(),r=URL.createObjectURL(n);return{audio_element:new Audio(r),blob:n}}async function Qt(e){let t=Gt();return await t.audio.speech.create({model:"tts-1",voice:"alloy",input:e})}async function en(e,t){return await Wt("https://www.tidyscripts.com/api/openai_davinci",{prompt:e,max_tokens:t})}function tn(e){return new WebTransport(e)}function nn(e){return(new TextEncoder).encode(JSON.stringify(e))}function rn(e){let t=tn(e);return{writer:t.datagrams.writable.getWriter(),transport:t}}async function an(e,t){let n=nn(t);await e.write(n)}function sn(e){let{writer:t,transport:n}=rn(e);return t.write_json=async function(e){await t.write(nn(e))},t}const on=N.logger.get_logger({id:"firebase_loader"}),cn={app:"https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js",auth:"https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js",firestore:"https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js",ui:"https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js",ui_css:"https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css"};async function un(){return wt(cn.app)}async function ln(){return wt(cn.auth)}async function dn(){return wt(cn.ui)}async function hn(){return wt(cn.firestore)}async function fn(){return kt(cn.ui_css)}async function pn(){on("Loading firebase resources"),await un(),await Promise.all([ln(),dn(),fn(),hn()]),on("Done")}function mn(e){let t=rn(e);return t.note_on=function(e,n,r){let a=N.midi_encoder.note_on(e,n,r);t.write(a)},t.note_off=function(e,n,r){let a=Uint8Array.from([128+e,n,r]);t.write(a)},t.control_change=function(e,n,r){let a=N.midi_encoder.control_change(e,n,r);t.write(a)},t}const gn=N.logger.get_logger({id:"sensors"});var yn=!1,_n=!1,bn={},vn={};function wn(e){let t="default.motion.logger";kn(t,(function(e){let{acceleration:t,rotationRate:n}=e,{x:r,y:a,z:i}=t,{alpha:s,beta:o,gamma:c}=n;gn(`x,y,z,alpha,beta,gamma=${r},${a},${i},${s},${o},${c}`)})),window.setTimeout((function(){An(t)}),1e3*e)}function xn(e){let t="default.orientation.logger";On(t,(function(e){let{alpha:t,beta:n,gamma:r}=e;gn(`alpha,beta,gamma=${t},${n},${r}`)})),window.setTimeout((function(){Sn(t)}),1e3*e)}function kn(e,t){In(),bn[e]&&gn(`WARNING! motion subscription id ${e} has already been used`),bn[e]=t}function On(e,t){jn(),vn[e]&&gn(`WARNING! orientation subscription id ${e} has already been used`),vn[e]=t}function An(e){delete bn[e],gn(`Unsubscribed motion id: ${e}`),N.fp.is_empty_array(N.fp.keys(bn))&&(gn("No more motion subscribers; so listener will be detached"),Tn())}function Sn(e){delete vn[e],gn(`Unsubscribed orientation id: ${e}`),N.fp.is_empty_array(N.fp.keys(vn))&&(gn("No more orientation subscribers; so listener will be detached"),Nn())}function Pn(e){N.fp.values(bn).map((t=>t(e)))}function En(e){N.fp.values(vn).map((t=>t(e)))}function In(){yn||(window.addEventListener("devicemotion",Pn),gn("Started listening to device motion (registered handler"),yn=!0)}function jn(){_n||(window.addEventListener("deviceorientation",En),gn("Started listening to device orientation (registered handler"),_n=!0)}function Tn(){window.removeEventListener("devicemotion",Pn),yn=!1,gn("Unregistered device motion handler")}function Nn(){window.removeEventListener("deviceorientation",En),_n=!1,gn("Unregistered device orientation handler")}const Cn=N.logger.get_logger({id:"idbmod"});class Rn{constructor(e="keyval-store",t="keyval"){this.storeName=t,this._db=null,this._dbp=new Promise(((n,r)=>{let a=this;const i=indexedDB.open(e,1);i.onerror=()=>r(i.error),i.onsuccess=function(){n(i.result),a._db=i.result},i.onupgradeneeded=()=>{Cn(`creating store: ${e},  ${t}`),i.result.createObjectStore(t)}}))}_withIDBStore(e,t){return this._dbp.then((n=>new Promise(((r,a)=>{const i=n.transaction(this.storeName,e);i.oncomplete=()=>r(),i.onabort=i.onerror=()=>a(i.error),t(i.objectStore(this.storeName))}))))}get_db(){return this._db}}let $n;function Mn(){return $n||($n=new Rn),$n}const Ln=N.logger.get_logger({id:"db"}),Dn=N.dates,Un={};var Bn=5e3;const Fn="main_store",zn="TIDYSCRIPTS_WEB_";var Zn=null,qn=!1;function Hn(e,t=!0){if(qn||(Ln("initializing TTL"),qn=!0,Zn=Hn("TTL")),Un[e])return t&&Ln(`getting db from local cache: ${e}`),Un[e];var n=new Rn(zn+e,Fn);function r(e,t){return function(e,t,n=Mn()){return n._withIDBStore("readwrite",(n=>{n.put(t,e)}))}(e,t,n)}let a={store:n,set:r,get:function(e){return function(e,t=Mn()){let n;return t._withIDBStore("readonly",(t=>{n=t.get(e)})).then((()=>n.result))}(e,n)},del:function(e){return function(e,t=Mn()){return t._withIDBStore("readwrite",(t=>{t.delete(e)}))}(e,n)},keys:function(){return function(e=Mn()){const t=[];return e._withIDBStore("readonly",(e=>{(e.openKeyCursor||e.openCursor).call(e).onsuccess=function(){this.result&&(t.push(this.result.key),this.result.continue())}})).then((()=>t))}(n)},clear:function(){return function(e=Mn()){return e._withIDBStore("readwrite",(e=>{e.clear()}))}(n)},set_with_ttl:async function(t){let{id:n,ttl_ms:a,value:i}=t,s=a+Dn.ms_now();Ln(`In db "${e}" setting "${n}" with ttl_ms ${a}, expiration = ${s}`),await r(n,i),await Zn.set(s,{db_id:e,del_id:n}),Ln("done setting with ttl \\(^.^)/")},get_db_store:function(){return n},ready:function(){return n._dbp}};return Un[e]=a,t&&Ln(`getting db: ${e}`),a}function Wn(e){Bn=e,Ln("Updated cache check interval to "+e+" ms")}var Jn=null;async function Kn(){let e=await Zn.keys(),t=e.length,n=e.filter((e=>e<Dn.ms_now())),r=n.length,a=[];for(var i of n){let{db_id:e,del_id:t}=await Zn.get(i),n=Hn(e,!1);await n.del(t),await Zn.del(i),a.push({db_id:e,del_id:t})}Ln(`CacheCheck |> ${r}/${t} expired:`),r>0&&Ln(a)}function Vn(e){Jn&&(Ln("Already checking, will clear old interval."),Gn()),Wn(e),Jn=setInterval(Kn,Bn)}function Gn(){clearInterval(Jn),Ln("Stopped cache check")}function Xn(e){return window.indexedDB.deleteDatabase(zn+e)}async function Yn(e){let t=Hn(e).get_db_store()._db;return await(n=t,new Promise(((e,t)=>{const r={};if(0===n.objectStoreNames.length)e(JSON.stringify(r));else{const a=n.transaction(n.objectStoreNames,"readonly");a.addEventListener("error",t);for(const t of n.objectStoreNames){const i=[];a.objectStore(t).openCursor().addEventListener("success",(a=>{const s=a.target.result;s?(i.push([s.key,s.value]),s.continue()):(r[t]=i,n.objectStoreNames.length===Object.keys(r).length&&e(JSON.stringify(r)))}))}}})));var n}async function Qn(e,t){let n=Hn(e);await n.ready();let r=n.get_db_store()._db;return await(a=r,i=t,new Promise(((e,t)=>{const n=a.transaction(a.objectStoreNames,"readwrite");n.addEventListener("error",t);var r=JSON.parse(i);for(const t of a.objectStoreNames){let a=0;for(const i of r[t]){let[s,o]=i;n.objectStore(t).add(o,s).addEventListener("success",(()=>{a++,a===r[t].length&&(delete r[t],0===Object.keys(r).length&&e("ok"))}))}}})));var a,i}const er=N.logger.get_logger({id:"bokeh"});var tr=!1;async function nr(){if(window.Bokeh)return void er("Bokeh is already loaded! Skipping load for now...");if(tr)return void er("Bokeh is already loading! Skipping load for now...");tr=!0;let e="3.0.0",t=[`https://cdn.bokeh.org/bokeh/release/bokeh-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-widgets-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-tables-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-api-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-gl-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-mathjax-${e}.min.js`];for(var n of(er("Loading scripts"),t))er(`Loading ${n}`),await xt({src:n,attributes:{crossorigin:"anonymous"}});er("Done")}const rr=N.util.dsp;N.util.debug;var ar=null,ir=null,sr=null,or=null;const cr=N.logger.get_logger({id:"web_audio"});async function ur(){return ar||(ar=new window.AudioContext,ir=await window.navigator.mediaDevices.getUserMedia({audio:!0}),ar)}async function lr(){return ir||(await ur(),await window.navigator.mediaDevices.getUserMedia({audio:!0}))}async function dr(){return(await lr()).getAudioTracks()[0].getSettings().sampleRate}async function hr(e){let t=await ur();return await t.decodeAudioData(e)}async function fr(e){return await hr(await e.arrayBuffer())}var pr={};function mr(e,t){pr[e]=t}function gr(e){Object.keys(pr).length>0&&N.fp.apply_function_dictionary_to_object(pr,e)}var yr,_r=!1;async function br(){if(_r)return cr("mic already initialized");let e=await ur(),t=await lr(),n=e.createMediaStreamSource(t);(sr=e.createAnalyser()).fftSize=2048,yr=new Float32Array(sr.frequencyBinCount),n.connect(sr),_r=!0,function e(){requestAnimationFrame(e),sr.getFloatTimeDomainData(yr),gr(yr)}()}var vr,wr=new Float32Array(1024),xr=new Float32Array(1024);async function kr(e){cr(`testing diff with ${e} ms`),sr.getFloatTimeDomainData(wr),window.setTimeout((function(){sr.getFloatTimeDomainData(xr);let e=JSON.stringify(wr)==JSON.stringify(xr);cr(`Equality = ${e}`)}),e)}async function Or(e){if(await br(),or)return cr("sound event detector already initialized"),or;let t={threshold:.2,margin:600,audio_buffer_size:yr.length,register_fn:mr},n=Object.assign(t,e);return or=new vr(n),await or.init(),or}async function Ar(e,t){await nr();const n=N.fp.range(0,e.length),r=Array.from(e),a=new Bokeh.ColumnDataSource({data:{x:n,y:r}}),i=new Bokeh.Plot({width:300,height:100}),s=new Bokeh.LinearAxis({axis_line_color:null}),o=new Bokeh.LinearAxis({axis_line_color:null});i.add_layout(s,"below"),i.add_layout(o,"left");const c=new Bokeh.Grid({ticker:s.ticker,dimension:0}),u=new Bokeh.Grid({ticker:o.ticker,dimension:1});i.add_layout(c),i.add_layout(u);const l=new Bokeh.Line({x:{field:"x"},y:{field:"y"},line_color:"#666699",line_width:2});i.add_glyph(l,a),Bokeh.Plotting.show(i,document.getElementById(t))}function Sr(){return document.querySelector("textarea")}function Pr(e){Sr().value=e}function Er(){Sr().parentElement.querySelector("button").click()}function Ir(e){Pr(e),Er()}function jr(){window.addEventListener("tidyscripts_web_speech_recognition_result",(function(e){Ir(e.detail)})),et()}"undefined"!=typeof window&&(vr=class extends window.EventTarget{constructor(e){super();let{threshold:t,margin:n,register_fn:r,audio_buffer_size:a}=e;this.threshold=t,this.margin=n,this.register_fn=r,this.log=N.logger.get_logger({id:"snd_evt"}),this.sampling_rate=48e3,this.audio_buffer_size=a,this.tmp_buffer=[],this.tmp_buffer_max_length=10,this.recording_event=!1,this.event_start_time=0,this.time_of_last_detection=performance.now(),this.media_recorder=null}async init(){let e=this;this.register_fn("SED",(function(t){e.handle_data(t)})),this.log("Linked sound event detector to audio source"),this.sampling_rate=await dr(),this.log(`Got sampling rate ${this.sampling_rate}`);let t=this.num_buffers_to_cover_margin();this.log(`Created tmp buffer of size ${t}`),this.tmp_buffer_max_length=t,this.tmp_buffer=N.fp.range(0,t).map((e=>new Float32Array(this.audio_buffer_size)));let n=await lr();this.media_recorder=new window.MediaRecorder(n),this.log("Initialized media recorder")}handle_data(e){this.tmp_buffer.shift(),this.tmp_buffer.push(e),this.analyze_tmp_buffer()}analyze_tmp_buffer(){let e=this.tmp_buffer,t=N.fp.all_true(e.map((e=>rr.mean_abs(e)>this.threshold)));if(this.recording_event){if(t)return void(this.time_of_last_detection=performance.now());let n=N.fp.all_true(e.map((e=>rr.mean_abs(e)<this.threshold))),r=performance.now()-this.time_of_last_detection>this.margin;n&&r&&(this.log("Detected quiet while recording event..."),this.recording_event=!1,this.media_recorder.stop(),this.log("Stopped recording"))}else if(t){let e=this;this.media_recorder.ondataavailable=function(t){let n=t.data,r=new window.CustomEvent("sound_event_ended",{detail:n});e.dispatchEvent(r)},this.media_recorder.start(),this.log("Detected event start"),this.time_since_last_detection=performance.now();let t=new window.Event("sound_event_started");this.dispatchEvent(t),this.recording_event=!0,this.event_start_time=N.util.unix_timestamp_ms()}}samples_to_ms(e){return 1e3*e/this.sampling_rate}ms_to_samples(e){return e*this.sampling_rate/1e3}num_buffers_to_cover_margin(){let e=this.ms_to_samples(this.margin);return Math.ceil(e/this.audio_buffer_size)}});var Tr=null,Nr="";function Cr(e){console.log("new text:"+e)}function Rr(e){lt(e)}function $r(e){lt(e)}function Mr(){console.log("finished stream"),et()}function Lr(e,t){let n=e;Tr=window.setInterval((function(){let e=document.querySelector(".result-streaming");if(e){let n=e.innerText,r=n.replace(Nr,"");t?Rr(r):Cr(r),Nr=n}else if(""==Nr);else{let e=N.fp.last(Array.from(document.querySelectorAll("div.markdown"))).innerText.replace(Nr,"");t?Rr(e):Cr(e),Nr="",Mr()}}),n)}var Dr=["Google UK English Female","Google UK English Male","Google UK English","Karen","Rishi"];function Ur(){window.clearInterval(Tr)}function Br(e){ot(e)}async function Fr(){await W(),ot(1.3),ct(Dr)}var zr=2e3;async function Zr(){jr(),await Fr(),Lr(zr,!1)}async function qr(){jr(),await Fr(),Lr(zr,!0)}})();var s=t;for(var o in i)s[o]=i[o];i.__esModule&&Object.defineProperty(s,"__esModule",{value:!0})}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var i=t[r]={exports:{}};return e[r](i,i.exports,n),i.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};return(()=>{"use strict";n.r(r);var e=n(515);window.tsw=e})(),r})()));