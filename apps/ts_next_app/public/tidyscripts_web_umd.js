/*! For license information please see tidyscripts_web_umd.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.tidyscripts_web=t():e.tidyscripts_web=t()}(this,(()=>(()=>{var e={515:(e,t,n)=>{var r={78:(e,t)=>{var n={749:(e,t,n)=>{e=n.nmd(e);const r=(e=0)=>t=>`[${38+e};5;${t}m`,i=(e=0)=>(t,n,r)=>`[${38+e};2;${t};${n};${r}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(const[n,r]of Object.entries(t)){for(const[n,i]of Object.entries(r))t[n]={open:`[${i[0]}m`,close:`[${i[1]}m`},r[n]=t[n],e.set(i[0],i[1]);Object.defineProperty(t,n,{value:r,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="[39m",t.bgColor.close="[49m",t.color.ansi256=r(),t.color.ansi16m=i(),t.bgColor.ansi256=r(10),t.bgColor.ansi16m=i(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,n)=>e===t&&t===n?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(n/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:n}=t.groups;3===n.length&&(n=n.split("").map((e=>e+e)).join(""));const r=Number.parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},991:(e,t)=>{t.byteLength=function(e){var t=o(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,s=o(e),a=s[0],c=s[1],u=new i(function(e,t,n){return 3*(t+n)/4-n}(0,a,c)),l=0,h=c>0?a-4:a;for(n=0;n<h;n+=4)t=r[e.charCodeAt(n)]<<18|r[e.charCodeAt(n+1)]<<12|r[e.charCodeAt(n+2)]<<6|r[e.charCodeAt(n+3)],u[l++]=t>>16&255,u[l++]=t>>8&255,u[l++]=255&t;return 2===c&&(t=r[e.charCodeAt(n)]<<2|r[e.charCodeAt(n+1)]>>4,u[l++]=255&t),1===c&&(t=r[e.charCodeAt(n)]<<10|r[e.charCodeAt(n+1)]<<4|r[e.charCodeAt(n+2)]>>2,u[l++]=t>>8&255,u[l++]=255&t),u},t.fromByteArray=function(e){for(var t,r=e.length,i=r%3,s=[],a=16383,o=0,u=r-i;o<u;o+=a)s.push(c(e,o,o+a>u?u:o+a));return 1===i?(t=e[r-1],s.push(n[t>>2]+n[t<<4&63]+"==")):2===i&&(t=(e[r-2]<<8)+e[r-1],s.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"=")),s.join("")};for(var n=[],r=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0;a<64;++a)n[a]=s[a],r[s.charCodeAt(a)]=a;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function c(e,t,r){for(var i,s,a=[],o=t;o<r;o+=3)i=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),a.push(n[(s=i)>>18&63]+n[s>>12&63]+n[s>>6&63]+n[63&s]);return a.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},832:e=>{const t=/[\p{Lu}]/u,n=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,i=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,a=new RegExp("^"+s.source),o=new RegExp(s.source+i.source,"gu"),c=new RegExp("\\d+"+i.source,"gu"),u=(e,i)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(i={pascalCase:!1,preserveConsecutiveUppercase:!1,...i},0===(e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim()).length)return"";const s=!1===i.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(i.locale),u=!1===i.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(i.locale);return 1===e.length?i.pascalCase?u(e):s(e):(e!==s(e)&&(e=((e,r,i)=>{let s=!1,a=!1,o=!1;for(let c=0;c<e.length;c++){const u=e[c];s&&t.test(u)?(e=e.slice(0,c)+"-"+e.slice(c),s=!1,o=a,a=!0,c++):a&&o&&n.test(u)?(e=e.slice(0,c-1)+"-"+e.slice(c-1),o=a,a=!1,s=!0):(s=r(u)===u&&i(u)!==u,o=a,a=i(u)===u&&r(u)!==u)}return e})(e,s,u)),e=e.replace(a,""),e=i.preserveConsecutiveUppercase?((e,t)=>(r.lastIndex=0,e.replace(r,(e=>t(e)))))(e,s):s(e),i.pascalCase&&(e=u(e.charAt(0))+e.slice(1)),((e,t)=>(o.lastIndex=0,c.lastIndex=0,e.replace(o,((e,n)=>t(n))).replace(c,(e=>t(e)))))(e,u))};e.exports=u,e.exports.default=u},409:e=>{e.exports=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},985:e=>{var t=Object.prototype.hasOwnProperty,n="~";function r(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,r,s,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new i(r,s||e,a),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,i=[];if(0===this._eventsCount)return i;for(r in e=this._events)t.call(e,r)&&i.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,s=r.length,a=new Array(s);i<s;i++)a[i]=r[i].fn;return a},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,i,s,a){var o=n?n+e:e;if(!this._events[o])return!1;var c,u,l=this._events[o],h=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),h){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,i),!0;case 5:return l.fn.call(l.context,t,r,i,s),!0;case 6:return l.fn.call(l.context,t,r,i,s,a),!0}for(u=1,c=new Array(h-1);u<h;u++)c[u-1]=arguments[u];l.fn.apply(l.context,c)}else{var d,f=l.length;for(u=0;u<f;u++)switch(l[u].once&&this.removeListener(e,l[u].fn,void 0,!0),h){case 1:l[u].fn.call(l[u].context);break;case 2:l[u].fn.call(l[u].context,t);break;case 3:l[u].fn.call(l[u].context,t,r);break;case 4:l[u].fn.call(l[u].context,t,r,i);break;default:if(!c)for(d=1,c=new Array(h-1);d<h;d++)c[d-1]=arguments[d];l[u].fn.apply(l[u].context,c)}}return!0},o.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,i){var s=n?n+e:e;if(!this._events[s])return this;if(!t)return a(this,s),this;var o=this._events[s];if(o.fn)o.fn!==t||i&&!o.once||r&&o.context!==r||a(this,s);else{for(var c=0,u=[],l=o.length;c<l;c++)(o[c].fn!==t||i&&!o[c].once||r&&o[c].context!==r)&&u.push(o[c]);u.length?this._events[s]=1===u.length?u[0]:u:a(this,s)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o},46:e=>{var t,n="object"==typeof Reflect?Reflect:null,r=n&&"function"==typeof n.apply?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function s(){s.init.call(this)}e.exports=s,e.exports.once=function(e,t){return new Promise((function(n,r){function i(n){e.removeListener(t,s),r(n)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}m(e,t,s,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&m(e,"error",t,{once:!0})}(e,i)}))},s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var a=10;function o(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function u(e,t,n,r){var i,s,a,u;if(o(n),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),a=s[t]),void 0===a)a=s[t]=n,++e._eventsCount;else if("function"==typeof a?a=s[t]=r?[n,a]:[a,n]:r?a.unshift(n):a.push(n),(i=c(e))>0&&a.length>i&&!a.warned){a.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=a.length,u=l,console&&console.warn&&console.warn(u)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=l.bind(r);return i.listener=n,r.wrapFn=i,i}function d(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):p(i,i.length)}function f(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function p(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function m(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(s){r.once&&e.removeEventListener(t,i),n(s)}))}}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i="error"===e,s=this._events;if(void 0!==s)i=i&&void 0===s.error;else if(!i)return!1;if(i){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var c=s[e];if(void 0===c)return!1;if("function"==typeof c)r(c,this,t);else{var u=c.length,l=p(c,u);for(n=0;n<u;++n)r(l[n],this,t)}return!0},s.prototype.addListener=function(e,t){return u(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return u(this,e,t,!0)},s.prototype.once=function(e,t){return o(t),this.on(e,h(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){return o(t),this.prependListener(e,h(this,e,t)),this},s.prototype.removeListener=function(e,t){var n,r,i,s,a;if(o(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){a=n[s].listener,i=s;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,a||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,s=Object.keys(n);for(r=0;r<s.length;++r)"removeListener"!==(i=s[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},s.prototype.listeners=function(e){return d(this,e,!0)},s.prototype.rawListeners=function(e){return d(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},s.prototype.listenerCount=f,s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},425:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(985),i=n(856),s=n(147),a=()=>{},o=new i.TimeoutError;t.default=class extends r{constructor(e){var t,n,r,i;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=a,this._resolveIdle=a,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:s.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==n?n:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(i=null===(r=e.interval)||void 0===r?void 0:r.toString())&&void 0!==i?i:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=a,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=a,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((n,r)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const s=void 0===this._timeout&&void 0===t.timeout?e():i.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&r(o)}));n(await s)}catch(e){r(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},657:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n){let r=0,i=e.length;for(;i>0;){const s=i/2|0;let a=r+s;n(e[a],t)<=0?(r=++a,i-=s+1):i=s}return r}},147:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(657);t.default=class{constructor(){this._queue=[]}enqueue(e,t){const n={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(n);const i=r.default(this._queue,n,((e,t)=>t.priority-e.priority));this._queue.splice(i,0,n)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}}},201:(e,t,n)=>{const r=n(364),i=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class s extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const a=(e,t)=>new Promise(((n,a)=>{t={onFailedAttempt:()=>{},retries:10,...t};const o=r.operation(t);o.attempt((async r=>{try{n(await e(r))}catch(e){if(!(e instanceof Error))return void a(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof s)o.stop(),a(e.originalError);else if(e instanceof TypeError&&(c=e.message,!i.includes(c)))o.stop(),a(e);else{((e,t,n)=>{const r=n.retries-(t-1);e.attemptNumber=t,e.retriesLeft=r})(e,r,t);try{await t.onFailedAttempt(e)}catch(e){return void a(e)}o.retry(e)||a(o.mainError())}}var c}))}));e.exports=a,e.exports.default=a,e.exports.AbortError=s},856:(e,t,n)=>{const r=n(70);class i extends Error{constructor(e){super(e),this.name="TimeoutError"}}const s=(e,t,n)=>new Promise(((s,a)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void s(e);const o=setTimeout((()=>{if("function"==typeof n){try{s(n())}catch(e){a(e)}return}const r=n instanceof Error?n:new i("string"==typeof n?n:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),a(r)}),t);r(e.then(s,a),(()=>{clearTimeout(o)}))}));e.exports=s,e.exports.default=s,e.exports.TimeoutError=i},70:e=>{e.exports=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))))},364:(e,t,n)=>{e.exports=n(386)},386:(e,t,n)=>{var r=n(884);t.operation=function(e){var n=t.timeouts(e);return new r(n,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var n in e)t[n]=e[n];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],i=0;i<t.retries;i++)r.push(this.createTimeout(i,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(i,t)),r.sort((function(e,t){return e-t})),r},t.createTimeout=function(e,t){var n=t.randomize?Math.random()+1:1,r=Math.round(n*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(r,t.maxTimeout)},t.wrap=function(e,n,r){if(n instanceof Array&&(r=n,n=null),!r)for(var i in r=[],e)"function"==typeof e[i]&&r.push(i);for(var s=0;s<r.length;s++){var a=r[s],o=e[a];e[a]=function(r){var i=t.operation(n),s=Array.prototype.slice.call(arguments,1),a=s.pop();s.push((function(e){i.retry(e)||(e&&(arguments[0]=i.mainError()),a.apply(this,arguments))})),i.attempt((function(){r.apply(e,s)}))}.bind(e,o),e[a].options=n}}},884:e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(void 0===n){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1)}var r=this;return this._timer=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),n),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){n._operationTimeoutCb()}),n._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,n=0,r=0;r<this._errors.length;r++){var i=this._errors[r],s=i.message,a=(e[s]||0)+1;e[s]=a,a>=n&&(t=i,n=a)}return t}}},r={};function i(e){var t=r[e];if(void 0!==t)return t.exports;var s=r[e]={id:e,loaded:!1,exports:{}};return n[e](s,s.exports,i),s.loaded=!0,s.exports}i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.nmd=e=>(e.paths=[],e.children||(e.children=[]),e);var s={};(()=>{i.r(s),i.d(s,{R:()=>n,apis:()=>M,asnc:()=>f,dates:()=>U,fp:()=>t,get_json_from_url:()=>px,logger:()=>e,midi_encoder:()=>$,trading:()=>o,util:()=>d});var e={};i.r(e),i.d(e,{get_logger:()=>st,suppress:()=>rt,unsuppress:()=>it});var t={};i.r(t),i.d(t,{add:()=>jn,adder:()=>$n,all_false:()=>Mt,all_true:()=>Lt,any_false:()=>$t,any_is_array:()=>dn,any_true:()=>Dt,apply_function_dictionary_to_object:()=>Hn,async_apply_function_dictionary_to_object:()=>Kn,clone:()=>Kt,clone_array:()=>Ot,concat:()=>Xt,concat_accross_index:()=>Ht,dict_to_list:()=>St,diff:()=>Vn,divide:()=>Mn,divider:()=>Fn,enumerate:()=>Vt,enumermap:()=>Qt,equals:()=>zn,filter:()=>cn,filter_key:()=>un,filter_key_equals:()=>ln,first:()=>At,flat_once:()=>fn,format:()=>Rn,fourth:()=>Ct,get:()=>mt,getter:()=>vt,im_arr_rm:()=>Gt,im_push:()=>Wt,indexer:()=>jt,invert_dictionary:()=>It,is_array:()=>kn,is_empty:()=>an,is_empty_array:()=>sn,is_empty_map:()=>bt,is_empty_string:()=>On,is_map:()=>In,is_null:()=>wn,is_object:()=>Tn,is_something:()=>En,is_string:()=>Sn,is_undefined:()=>bn,is_zero:()=>nn,join:()=>Pn,joiner:()=>Cn,keys:()=>lt,last:()=>Nt,len:()=>rn,list_to_dict:()=>vn,make_debouncer:()=>qn,map:()=>Bt,map_get:()=>Yt,map_indexed:()=>ct,map_items:()=>kt,map_over_dic_values:()=>Tt,map_prop:()=>zt,map_prop_reduce:()=>qt,map_set:()=>en,map_set_im:()=>tn,merge_dictionaries:()=>pt,merge_dictionary:()=>ft,multiplier:()=>Bn,multiply:()=>Dn,nchars:()=>xn,not_empty:()=>on,nth:()=>Rt,partition:()=>Jt,range:()=>Ft,recursive_flat:()=>pn,recursive_flat_remove_empty:()=>mn,remove_empty:()=>hn,repeat:()=>Ut,second:()=>xt,set:()=>gt,set_im:()=>yt,setter:()=>_t,setter_im:()=>wt,shallow_copy:()=>ut,sort_by_prop:()=>Zt,split:()=>Nn,substring:()=>An,subtract:()=>Ln,subtractor:()=>Un,third:()=>Pt,update_at:()=>Et,values:()=>dt,values_cloned:()=>ht,zip:()=>yn,zip2:()=>gn,zip_map:()=>_n});var n={};i.r(n),i.d(n,{F:()=>Wn,T:()=>Gn,__:()=>Zn,add:()=>Qn,addIndex:()=>W,addIndexRight:()=>Xn,adjust:()=>er,all:()=>rr,allPass:()=>ur,always:()=>lr,and:()=>dr,andThen:()=>el,any:()=>pr,anyPass:()=>gr,ap:()=>vr,aperture:()=>wr,append:()=>br,apply:()=>Er,applySpec:()=>Ir,applyTo:()=>Or,ascend:()=>xr,assoc:()=>Lr,assocPath:()=>Rr,binary:()=>$r,bind:()=>Je,both:()=>Vr,call:()=>zr,chain:()=>Jr,clamp:()=>Xr,clone:()=>ri,collectBy:()=>si,comparator:()=>oi,complement:()=>li,compose:()=>yi,composeWith:()=>Ei,concat:()=>Fe,cond:()=>Si,construct:()=>Ai,constructN:()=>Oi,converge:()=>Pi,count:()=>Ni,countBy:()=>Di,curry:()=>Ti,curryN:()=>K,dec:()=>Mi,defaultTo:()=>Ui,descend:()=>Bi,difference:()=>Hi,differenceWith:()=>Wi,dissoc:()=>Yi,dissocPath:()=>Qi,divide:()=>ts,drop:()=>is,dropLast:()=>us,dropLastWhile:()=>hs,dropRepeats:()=>ys,dropRepeatsBy:()=>_s,dropRepeatsWith:()=>gs,dropWhile:()=>Es,either:()=>Is,empty:()=>Os,endsWith:()=>Ps,eqBy:()=>vs,eqProps:()=>Ns,equals:()=>ke,evolve:()=>js,filter:()=>Le,find:()=>Ms,findIndex:()=>Fs,findLast:()=>Vs,findLastIndex:()=>qs,flatten:()=>Hs,flip:()=>Ws,forEach:()=>Zs,forEachObjIndexed:()=>Qs,fromPairs:()=>Ys,groupBy:()=>ea,groupWith:()=>na,gt:()=>ia,gte:()=>aa,has:()=>ua,hasIn:()=>ha,hasPath:()=>oa,head:()=>vi,identical:()=>fa,identity:()=>wi,ifElse:()=>pa,inc:()=>ma,includes:()=>ga,indexBy:()=>ya,indexOf:()=>va,init:()=>_a,innerJoin:()=>wa,insert:()=>ba,insertAll:()=>Ea,intersection:()=>Aa,intersperse:()=>xa,into:()=>Da,invert:()=>$a,invertObj:()=>Fa,invoker:()=>Ba,is:()=>Va,isEmpty:()=>za,isNil:()=>Cr,isNotNil:()=>qa,join:()=>Ha,juxt:()=>Wa,keys:()=>he,keysIn:()=>Za,last:()=>ps,lastIndexOf:()=>Ja,length:()=>Xa,lens:()=>eo,lensIndex:()=>ro,lensPath:()=>co,lensProp:()=>lo,lift:()=>Fr,liftN:()=>Ur,lt:()=>fo,lte:()=>mo,map:()=>fe,mapAccum:()=>yo,mapAccumRight:()=>vo,mapObjIndexed:()=>wo,match:()=>Eo,mathMod:()=>So,max:()=>sr,maxBy:()=>Io,mean:()=>Ao,median:()=>Po,memoizeWith:()=>No,mergeAll:()=>Ro,mergeDeepLeft:()=>$o,mergeDeepRight:()=>Uo,mergeDeepWith:()=>Fo,mergeDeepWithKey:()=>Mo,mergeLeft:()=>Vo,mergeRight:()=>qo,mergeWith:()=>Ko,mergeWithKey:()=>Lo,min:()=>Go,minBy:()=>Jo,modify:()=>ec,modifyPath:()=>Xo,modulo:()=>nc,move:()=>rc,multiply:()=>sc,nAry:()=>Mr,negate:()=>uc,none:()=>lc,not:()=>ui,nth:()=>Ve,nthArg:()=>dc,o:()=>pc,objOf:()=>Na,of:()=>mc,omit:()=>yc,on:()=>_c,once:()=>wc,or:()=>Ss,otherwise:()=>kc,over:()=>Ic,pair:()=>Oc,partial:()=>xc,partialObject:()=>oc,partialRight:()=>Pc,partition:()=>Cc,path:()=>ao,pathEq:()=>Nc,pathOr:()=>jc,pathSatisfies:()=>Lc,paths:()=>so,pick:()=>Dc,pickAll:()=>$c,pickBy:()=>Fc,pipe:()=>mi,pipeWith:()=>bi,pluck:()=>or,prepend:()=>Bc,product:()=>Vc,project:()=>qc,promap:()=>Wc,prop:()=>qe,propEq:()=>Gc,propIs:()=>Zc,propOr:()=>Qc,propSatisfies:()=>Xc,props:()=>eu,range:()=>nu,reduce:()=>et,reduceBy:()=>Li,reduceRight:()=>ru,reduceWhile:()=>su,reduced:()=>au,reject:()=>De,remove:()=>Zi,repeat:()=>lu,replace:()=>du,reverse:()=>gi,scan:()=>yu,sequence:()=>vu,set:()=>wu,slice:()=>fi,sort:()=>Eu,sortBy:()=>Su,sortWith:()=>Iu,split:()=>Ou,splitAt:()=>xu,splitEvery:()=>Cu,splitWhen:()=>Ru,splitWhenever:()=>Lu,startsWith:()=>Mu,subtract:()=>Uu,sum:()=>Oo,swap:()=>Vu,symmetricDifference:()=>zu,symmetricDifferenceWith:()=>qu,tail:()=>pi,take:()=>os,takeLast:()=>xs,takeLastWhile:()=>Hu,takeWhile:()=>Gu,tap:()=>Ju,test:()=>Xu,thunkify:()=>eh,times:()=>cu,toLower:()=>tl,toPairs:()=>rl,toPairsIn:()=>sl,toString:()=>$e,toUpper:()=>al,transduce:()=>ol,transpose:()=>ul,traverse:()=>ll,trim:()=>fl,tryCatch:()=>ml,type:()=>_e,unapply:()=>gl,unary:()=>yl,uncurryN:()=>_l,unfold:()=>wl,union:()=>bl,unionWith:()=>Tl,uniq:()=>Ia,uniqBy:()=>Ta,uniqWith:()=>Sl,unless:()=>Il,unnest:()=>Ol,until:()=>Al,unwind:()=>Pl,update:()=>to,useWith:()=>zc,values:()=>Sr,valuesIn:()=>Nl,view:()=>Ll,when:()=>Dl,where:()=>$l,whereAny:()=>Fl,whereEq:()=>Bl,without:()=>zl,xor:()=>Hl,xprod:()=>Wl,zip:()=>Zl,zipObj:()=>Ql,zipWith:()=>Yl});var r={};i.r(r),i.d(r,{MarketTradeType:()=>th,PortfolioBalancer:()=>nh});var a={};i.r(a),i.d(a,{BacktestBalancer:()=>rh});var o={};i.r(o),i.d(o,{backtest_balancer:()=>a,portfolio_balancer_lib:()=>r});var c={};i.r(c),i.d(c,{abs:()=>oh,flat_float32_array:()=>hh,length:()=>ih,mean:()=>ch,mean_abs:()=>uh,min_max_mean:()=>lh,power:()=>sh,sum:()=>ah});var u={};i.r(u),i.d(u,{ms:()=>dh});var l={};i.r(l),i.d(l,{add:()=>mh,db:()=>ph,get:()=>gh,log:()=>fh});var h={};i.r(h),i.d(h,{prepend_timestamp_as_bytes:()=>vh,timestampToByteArray:()=>yh});var d={};i.r(d),i.d(d,{bytes:()=>h,debug:()=>l,dsp:()=>c,is_browser:()=>_h,is_json_string:()=>Eh,is_node:()=>wh,performance:()=>u,unix_timestamp_ms:()=>bh});var f={};i.r(f),i.d(f,{status:()=>Sh,wait:()=>Oh,wait_until:()=>Ih});var p={};i.r(p),i.d(p,{ai_cds:()=>Nh,ask_ai:()=>xh,clean_json_string:()=>Ah,example_patient:()=>Ph,generate_patient_data:()=>Rh,generate_prompt:()=>Ch});var m={};i.r(m),i.d(m,{code:()=>jh});var g={};i.r(g),i.d(g,{build_index:()=>qh,get_medications:()=>Uh,index:()=>$h,init:()=>Fh,medications:()=>Mh,parse_ar_text:()=>Wh,parse_subsection_1:()=>Hh,parse_subsection_2:()=>Kh,raw_medications:()=>Dh,search_for_medication:()=>Bh,search_for_side_effect:()=>Vh});var y={};i.r(y),i.d(y,{JsonPatchError:()=>Iw,_areEquals:()=>Dw,applyOperation:()=>Cw,applyPatch:()=>Nw,applyReducer:()=>Rw,deepClone:()=>Ow,getValueByPointer:()=>Pw,validate:()=>Lw,validator:()=>jw});var v={};i.r(v),i.d(v,{get_chat_model:()=>_E});var _={};i.r(_),i.d(_,{clean_json_string:()=>IE,generate_loinc:()=>TE,generate_random_fhir_patient:()=>kE,generic_completion_json:()=>EE,get_fhir_data:()=>SE,get_openai:()=>bE});var w={};i.r(w),i.d(w,{call_structured_completion:()=>ek,generic_completion_json_structured:()=>nk,get_embedding:()=>rk,get_openai:()=>YE,test_1:()=>tk});var b={};i.r(b),i.d(b,{empty_prompt:()=>ik});var E={};i.r(E),i.d(E,{evaluation:()=>mk,evaluation_without_supplementary_data:()=>gk,extraction:()=>lk,medication_evaluation_prompt:()=>hk,medication_evaluation_prompt_without_supplementary_data:()=>dk,medication_evaluation_response_format:()=>pk,medication_extraction_prompt:()=>ok,medication_extraction_response_format:()=>uk,patient_information_placeholder:()=>sk,supplementary_information_placeholder:()=>ak});var k={};i.r(k),i.d(k,{general:()=>b,medications:()=>E});var S={};i.r(S),i.d(S,{empty_data:()=>yk});var T={};i.r(T),i.d(T,{hp:()=>wk,info:()=>_k,name:()=>vk});var I={};i.r(I),i.d(I,{copd_vap:()=>bk,hp:()=>kk,info:()=>Ek});var O={};i.r(O),i.d(O,{copd_vap:()=>I,esrd_hyperkalemia_losartan:()=>T});var A={};i.r(A),i.d(A,{ap:()=>S,hp:()=>O});var x={};i.r(x),i.d(x,{BaseEngine:()=>Ik,base_llm_args:()=>Tk});var P={};i.r(P),i.d(P,{MedicationEngine:()=>Nk});var C={};i.r(C),i.d(C,{base_engine:()=>x,medications:()=>P});var N={};i.r(N),i.d(N,{init:()=>jk,main:()=>Lk});var j={};i.r(j),i.d(j,{engines:()=>C,init:()=>Mk,prompting:()=>k,tamie:()=>N,test_data:()=>A});var L={};i.r(L),i.d(L,{get_sentences:()=>ZA,nlp:()=>WA,parse:()=>GA});var D={};i.r(D),i.d(D,{buffer_to_hex:()=>QA,sha256:()=>JA});var M={};i.r(M),i.d(M,{OpenAI:()=>Qm,aidx:()=>p,amie:()=>j,cryptography:()=>D,data_generator:()=>_,langchain:()=>v,loinc:()=>m,medications:()=>g,oai:()=>w,tnlp:()=>L});var $={};i.r($),i.d($,{control_change:()=>ex,note_off:()=>YA,note_on:()=>XA});var U={};function F(e,t){var n;t=t||[];var r=(e=e||[]).length,i=t.length,s=[];for(n=0;n<r;)s[s.length]=e[n],n+=1;for(n=0;n<i;)s[s.length]=t[n],n+=1;return s}function B(e){return null!=e&&"object"==typeof e&&!0===e["@@functional/placeholder"]}function V(e){return function t(n){return 0===arguments.length||B(n)?t:e.apply(this,arguments)}}function z(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,n){return t.apply(this,arguments)};case 3:return function(e,n,r){return t.apply(this,arguments)};case 4:return function(e,n,r,i){return t.apply(this,arguments)};case 5:return function(e,n,r,i,s){return t.apply(this,arguments)};case 6:return function(e,n,r,i,s,a){return t.apply(this,arguments)};case 7:return function(e,n,r,i,s,a,o){return t.apply(this,arguments)};case 8:return function(e,n,r,i,s,a,o,c){return t.apply(this,arguments)};case 9:return function(e,n,r,i,s,a,o,c,u){return t.apply(this,arguments)};case 10:return function(e,n,r,i,s,a,o,c,u,l){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}}function q(e){return function t(n,r){switch(arguments.length){case 0:return t;case 1:return B(n)?t:V((function(t){return e(n,t)}));default:return B(n)&&B(r)?t:B(n)?V((function(t){return e(t,r)})):B(r)?V((function(t){return e(n,t)})):e(n,r)}}}function H(e,t,n){return function(){for(var r=[],i=0,s=e,a=0,o=!1;a<t.length||i<arguments.length;){var c;a<t.length&&(!B(t[a])||i>=arguments.length)?c=t[a]:(c=arguments[i],i+=1),r[a]=c,B(c)?o=!0:s-=1,a+=1}return!o&&s<=0?n.apply(this,r):z(Math.max(0,s),H(e,r,n))}}i.r(U),i.d(U,{copy_date:()=>cx,dates_eq:()=>ox,day_string:()=>ux,iso_day_filename:()=>ix,iso_now:()=>nx,ms_now:()=>ax,round_date:()=>lx,shift_date:()=>hx,times_in_ms:()=>dx,to_iso:()=>tx,to_iso_day_filename:()=>rx,to_ms:()=>sx});const K=q((function(e,t){return 1===e?V(t):z(e,H(e,[],t))})),W=V((function(e){return K(e.length,(function(){var t=0,n=arguments[0],r=arguments[arguments.length-1],i=Array.prototype.slice.call(arguments,0);return i[0]=function(){var e=n.apply(this,F(arguments,[t,r]));return t+=1,e},e.apply(this,i)}))}));function G(e,t,n){for(var r=0,i=n.length;r<i;)t=e(t,n[r]),r+=1;return t}const Z=Array.isArray||function(e){return null!=e&&e.length>=0&&"[object Array]"===Object.prototype.toString.call(e)};function J(e){return null!=e&&"function"==typeof e["@@transducer/step"]}function Q(e,t,n){return function(){if(0===arguments.length)return n();var r=arguments[arguments.length-1];if(!Z(r)){for(var i=0;i<e.length;){if("function"==typeof r[e[i]])return r[e[i]].apply(r,Array.prototype.slice.call(arguments,0,-1));i+=1}if(J(r))return t.apply(null,Array.prototype.slice.call(arguments,0,-1))(r)}return n.apply(this,arguments)}}function X(e,t){for(var n=0,r=t.length,i=Array(r);n<r;)i[n]=e(t[n]),n+=1;return i}const Y=function(){return this.xf["@@transducer/init"]()},ee=function(e){return this.xf["@@transducer/result"](e)};var te=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=ee,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},e}();const ne=function(e){return function(t){return new te(e,t)}};function re(e,t){return Object.prototype.hasOwnProperty.call(t,e)}var ie=Object.prototype.toString;const se=function(){return"[object Arguments]"===ie.call(arguments)?function(e){return"[object Arguments]"===ie.call(e)}:function(e){return re("callee",e)}}();var ae=!{toString:null}.propertyIsEnumerable("toString"),oe=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],ce=function(){return arguments.propertyIsEnumerable("length")}(),ue=function(e,t){for(var n=0;n<e.length;){if(e[n]===t)return!0;n+=1}return!1},le="function"!=typeof Object.keys||ce?V((function(e){if(Object(e)!==e)return[];var t,n,r=[],i=ce&&se(e);for(t in e)!re(t,e)||i&&"length"===t||(r[r.length]=t);if(ae)for(n=oe.length-1;n>=0;)re(t=oe[n],e)&&!ue(r,t)&&(r[r.length]=t),n-=1;return r})):V((function(e){return Object(e)!==e?[]:Object.keys(e)}));const he=le;var de=q(Q(["fantasy-land/map","map"],ne,(function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return K(t.length,(function(){return e.call(this,t.apply(this,arguments))}));case"[object Object]":return G((function(n,r){return n[r]=e(t[r]),n}),{},he(t));default:return X(e,t)}})));const fe=de;function pe(e){var t=Object.prototype.toString.call(e);return"[object Function]"===t||"[object AsyncFunction]"===t||"[object GeneratorFunction]"===t||"[object AsyncGeneratorFunction]"===t}function me(e){return"[object String]"===Object.prototype.toString.call(e)}function ge(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n}function ye(e,t,n){for(var r=0,i=n.length;r<i;){if(e(t,n[r]))return!0;r+=1}return!1}const ve="function"==typeof Object.is?Object.is:function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t},_e=V((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)}));function we(e,t,n,r){var i=ge(e);function s(e,t){return be(e,t,n.slice(),r.slice())}return!ye((function(e,t){return!ye(s,t,e)}),ge(t),i)}function be(e,t,n,r){if(ve(e,t))return!0;var i=_e(e);if(i!==_e(t))return!1;if("function"==typeof e["fantasy-land/equals"]||"function"==typeof t["fantasy-land/equals"])return"function"==typeof e["fantasy-land/equals"]&&e["fantasy-land/equals"](t)&&"function"==typeof t["fantasy-land/equals"]&&t["fantasy-land/equals"](e);if("function"==typeof e.equals||"function"==typeof t.equals)return"function"==typeof e.equals&&e.equals(t)&&"function"==typeof t.equals&&t.equals(e);switch(i){case"Arguments":case"Array":case"Object":if("function"==typeof e.constructor&&"Promise"===function(e){var t=String(e).match(/^function (\w*)/);return null==t?"":t[1]}(e.constructor))return e===t;break;case"Boolean":case"Number":case"String":if(typeof e!=typeof t||!ve(e.valueOf(),t.valueOf()))return!1;break;case"Date":if(!ve(e.valueOf(),t.valueOf()))return!1;break;case"Error":return e.name===t.name&&e.message===t.message;case"RegExp":if(e.source!==t.source||e.global!==t.global||e.ignoreCase!==t.ignoreCase||e.multiline!==t.multiline||e.sticky!==t.sticky||e.unicode!==t.unicode)return!1}for(var s=n.length-1;s>=0;){if(n[s]===e)return r[s]===t;s-=1}switch(i){case"Map":return e.size===t.size&&we(e.entries(),t.entries(),n.concat([e]),r.concat([t]));case"Set":return e.size===t.size&&we(e.values(),t.values(),n.concat([e]),r.concat([t]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var a=he(e);if(a.length!==he(t).length)return!1;var o=n.concat([e]),c=r.concat([t]);for(s=a.length-1;s>=0;){var u=a[s];if(!re(u,t)||!be(t[u],e[u],o,c))return!1;s-=1}return!0}var Ee=q((function(e,t){return be(e,t,[],[])}));const ke=Ee;function Se(e,t,n){var r,i;if("function"==typeof e.indexOf)switch(typeof t){case"number":if(0===t){for(r=1/t;n<e.length;){if(0===(i=e[n])&&1/i===r)return n;n+=1}return-1}if(t!=t){for(;n<e.length;){if("number"==typeof(i=e[n])&&i!=i)return n;n+=1}return-1}return e.indexOf(t,n);case"string":case"boolean":case"function":case"undefined":return e.indexOf(t,n);case"object":if(null===t)return e.indexOf(t,n)}for(;n<e.length;){if(ke(e[n],t))return n;n+=1}return-1}function Te(e,t){return Se(t,e,0)>=0}function Ie(e){return'"'+e.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0").replace(/"/g,'\\"')+'"'}var Oe=function(e){return(e<10?"0":"")+e},Ae="function"==typeof Date.prototype.toISOString?function(e){return e.toISOString()}:function(e){return e.getUTCFullYear()+"-"+Oe(e.getUTCMonth()+1)+"-"+Oe(e.getUTCDate())+"T"+Oe(e.getUTCHours())+":"+Oe(e.getUTCMinutes())+":"+Oe(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"};const xe=Ae;function Pe(e){return function(){return!e.apply(this,arguments)}}function Ce(e,t){for(var n=0,r=t.length,i=[];n<r;)e(t[n])&&(i[i.length]=t[n]),n+=1;return i}function Ne(e){return"[object Object]"===Object.prototype.toString.call(e)}var Re=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=ee,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):e},e}(),je=q(Q(["fantasy-land/filter","filter"],(function(e){return function(t){return new Re(e,t)}}),(function(e,t){return Ne(t)?G((function(n,r){return e(t[r])&&(n[r]=t[r]),n}),{},he(t)):Ce(e,t)})));const Le=je,De=q((function(e,t){return Le(Pe(e),t)}));function Me(e,t){var n=function(n){var r=t.concat([e]);return Te(n,r)?"<Circular>":Me(n,r)},r=function(e,t){return X((function(t){return Ie(t)+": "+n(e[t])}),t.slice().sort())};switch(Object.prototype.toString.call(e)){case"[object Arguments]":return"(function() { return arguments; }("+X(n,e).join(", ")+"))";case"[object Array]":return"["+X(n,e).concat(r(e,De((function(e){return/^\d+$/.test(e)}),he(e)))).join(", ")+"]";case"[object Boolean]":return"object"==typeof e?"new Boolean("+n(e.valueOf())+")":e.toString();case"[object Date]":return"new Date("+(isNaN(e.valueOf())?n(NaN):Ie(xe(e)))+")";case"[object Map]":return"new Map("+n(Array.from(e))+")";case"[object Null]":return"null";case"[object Number]":return"object"==typeof e?"new Number("+n(e.valueOf())+")":1/e==-1/0?"-0":e.toString(10);case"[object Set]":return"new Set("+n(Array.from(e).sort())+")";case"[object String]":return"object"==typeof e?"new String("+n(e.valueOf())+")":Ie(e);case"[object Undefined]":return"undefined";default:if("function"==typeof e.toString){var i=e.toString();if("[object Object]"!==i)return i}return"{"+r(e,he(e)).join(", ")+"}"}}const $e=V((function(e){return Me(e,[])}));var Ue=q((function(e,t){if(Z(e)){if(Z(t))return e.concat(t);throw new TypeError($e(t)+" is not an array")}if(me(e)){if(me(t))return e+t;throw new TypeError($e(t)+" is not a string")}if(null!=e&&pe(e["fantasy-land/concat"]))return e["fantasy-land/concat"](t);if(null!=e&&pe(e.concat))return e.concat(t);throw new TypeError($e(e)+' does not have a method named "concat" or "fantasy-land/concat"')}));const Fe=Ue,Be=Number.isInteger||function(e){return(0|e)===e},Ve=q((function(e,t){var n=e<0?t.length+e:e;return me(t)?t.charAt(n):t[n]}));var ze=q((function(e,t){if(null!=t)return Be(e)?Ve(e,t):t[e]}));const qe=ze;function He(e){return function t(n,r,i){switch(arguments.length){case 0:return t;case 1:return B(n)?t:q((function(t,r){return e(n,t,r)}));case 2:return B(n)&&B(r)?t:B(n)?q((function(t,n){return e(t,r,n)})):B(r)?q((function(t,r){return e(n,t,r)})):V((function(t){return e(n,r,t)}));default:return B(n)&&B(r)&&B(i)?t:B(n)&&B(r)?q((function(t,n){return e(t,n,i)})):B(n)&&B(i)?q((function(t,n){return e(t,r,n)})):B(r)&&B(i)?q((function(t,r){return e(n,t,r)})):B(n)?V((function(t){return e(t,r,i)})):B(r)?V((function(t){return e(n,t,i)})):B(i)?V((function(t){return e(n,r,t)})):e(n,r,i)}}}const Ke=V((function(e){return!!Z(e)||!!e&&"object"==typeof e&&!me(e)&&(0===e.length||e.length>0&&e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1))}));var We="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";function Ge(e,t,n){return function(r,i,s){if(Ke(s))return e(r,i,s);if(null==s)return i;if("function"==typeof s["fantasy-land/reduce"])return t(r,i,s,"fantasy-land/reduce");if(null!=s[We])return n(r,i,s[We]());if("function"==typeof s.next)return n(r,i,s);if("function"==typeof s.reduce)return t(r,i,s,"reduce");throw new TypeError("reduce: list must be array or iterable")}}function Ze(e,t,n){for(var r=0,i=n.length;r<i;){if((t=e["@@transducer/step"](t,n[r]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r+=1}return e["@@transducer/result"](t)}const Je=q((function(e,t){return z(e.length,(function(){return e.apply(t,arguments)}))})),Qe=Ge(Ze,(function(e,t,n,r){return e["@@transducer/result"](n[r](Je(e["@@transducer/step"],e),t))}),(function(e,t,n){for(var r=n.next();!r.done;){if((t=e["@@transducer/step"](t,r.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r=n.next()}return e["@@transducer/result"](t)}));var Xe=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},e}();function Ye(e){return new Xe(e)}const et=He((function(e,t,n){return Qe("function"==typeof e?Ye(e):e,t,n)})),tt=st({id:"log"});var nt={};function rt(e,t){nt[e]=!0,tt(`Suppressing ${e}, reason=${t||"none_given"}`)}function it(e){nt[e]=!1,tt(`Unsuppressing ${e}`)}function st(e){let{id:t}=e;return function(e){nt[t]||("[object Object]"==e.toString()?(console.log(`[${t}]:: > `),console.log(e)):console.log(`[${t}]:: ${e}`))}}const at=st({id:"fp"}),ot=W(fe);function ct(e,t){return ot(((t,n)=>e(n,t)),t)}function ut(e){return kn(e)?Ot(e):In(e)?Kt(e):e}function lt(e){return Object.keys(e)}function ht(e){let t=lt(e),n=Kt(e);return an(t)?[]:Bt(t,(e=>n[e]))}function dt(e){let t=lt(e);return an(t)?[]:Bt(t,(t=>e[t]))}function ft(e,t){return Object.assign(Kt(e),t)}function pt(e){return e.reduce(ft,{})}function mt(e,t){return e[t]}function gt(e,t,n){return e[t]=n,e}function yt(e,t,n){let r=Kt(e);return r[t]=n,r}function vt(e){return function(t){return t[e]}}function _t(e,t){return function(n){return gt(n,e,t)}}function wt(e,t){return function(n){return gt(n,e,t)}}function bt(e){return In(e)&&nn(rn(lt(e)))}function Et(e,t,n){for(var r=e,i=0;i<t.length-1;i++)r=r[i];let s=Nt(t);return r[s]=n(r[s]),Kt(e)}function kt(e){return gn(lt(e),dt(e))}var St=kt;function Tt(e,t){let n=Bt(dt(e),t);return _n(lt(e),n)}function It(e,t=[]){let n=he(e),r=[];for(var i of n){let n=e[i];if(In(n))It(n,Fe(t,[i])).map((e=>r.push(e)));else{let e=Fe(t,[i]);r.push({value:n,path:e})}}return r}function Ot(e){return JSON.parse(JSON.stringify(e))}function At(e){return e[0]}function xt(e){return e[1]}function Pt(e){return e[2]}function Ct(e){return e[3]}function Nt(e){return e[e.length-1]}function Rt(e,t){return e[t]}function jt(e){return function(t){return Rt(t,e)}}function Lt(e){return e.reduce(((e,t)=>e&&t))}function Dt(e){return!an(e)&&e.reduce(((e,t)=>e||t))}function Mt(e){return!Dt(e)}function $t(e){return!Lt(e)}function Ut(e,t){let n=[];for(var r of Ft(t))n.push(ut(e));return n}function Ft(e,t=null){if(t){for(var n=Array(t-e).fill(0),r=0;r<n.length;r++)n[r]=r+e;return n}for(n=Array(e).fill(0),r=0;r<n.length;r++)n[r]=r;return n}function Bt(e,t){return e.map(t)}function Vt(e){return ct(((e,t)=>[e,t]),e)}function zt(e,t){return fe(qe(e))(t)}function qt(e,t,n,r){return et(t,n,zt(e,r))}function Ht(e){let t=[],n=e[0].length,r=e.length;for(var i=0;i<n;i++){for(var s=new Array,a=0;a<r;a++)s.push(e[a][i]);t.push(s)}return t}function Kt(e){return JSON.parse(JSON.stringify(e))}function Wt(e,t){let n=Kt(e);return n.push(t),n}function Gt(e,t){return Kt(e).filter((e=>!(e==t)))}function Zt(e){var t=1;return"-"===e[0]&&(t=-1,e=e.substr(1)),function(n,r){return(n[e]<r[e]?-1:n[e]>r[e]?1:0)*t}}function Jt(e,t){let n=Math.ceil(e.length/t),r=Array(n).fill(null).map((e=>new Array)),i=0;for(var s=0;s<e.length;s++)s%t==0&&0!=s&&(i+=1),r[i].push(e[s]);return r}function Qt(e,t){let n=[];for(var[r,i]of Vt(e))n.push(t(r,i));return n}function Xt(e,t){return e.concat(t)}function Yt(e,t){return Bt(e,vt(t))}function en(e,t,n){return Bt(e,_t(t,n))}function tn(e,t,n){return Bt(e,wt(t,n))}function nn(e){return 0==e}function rn(e){return e.length}function sn(e){return kn(e)&&nn(rn(e))}function an(e){return wn(e)||bn(e)||sn(e)||On(e)||bt(e)}function on(e){return!an(e)}function cn(e,t){return e.filter(t)}function un(e,t,n){return cn(e,(e=>n(mt(e,t))))}function ln(e,t,n){return un(e,t,(e=>e==n))}function hn(e){return cn(e,on)}function dn(e){return Dt(Bt(e,kn))}function fn(e){return e.flat()}function pn(e){return dn(e)?pn(fn(e)):e}function mn(e){return hn(pn(e))}function gn(e,t){let n=[];for(var r=0;r<e.length;r++)n.push([e[r],t[r]]);return n}var yn=gn;function vn(e){let t={};for(var[n,r]of e)t[n]=r;return t}function _n(e,t){return vn(yn(e,t))}function wn(e){return null==e}function bn(e){return null==e}function En(e){return!(wn(e)||bn(e))}function kn(e){return En(e)&&e.constructor==Array}function Sn(e){return En(e)&&e.constructor==String}function Tn(e){return En(e)&&e.constructor==Object}function In(e){return En(e)&&Tn(e)&&!kn(e)}function On(e){return""==e}function An(e,t,n){return e.substring(t,n)}function xn(e,t){return An(e,0,t)}function Pn(e,t){return e.join(t)}function Cn(e){return function(t){return Pn(t,e)}}function Nn(e,t){return e.split(t)}function Rn(e,t){let n=Ot(t),r=n.shift(),i=e;for(;r;)i=i.replace("{}",String(r)),r=n.shift();return i}function jn(e,t){return e+t}function Ln(e,t){return e-t}function Dn(e,t){return e*t}function Mn(e,t){return e/t}function $n(e){return function(t){return t+e}}function Un(e){return function(t){return t-e}}function Fn(e){return function(t){return t/e}}function Bn(e){return function(t){return t*e}}function Vn(e){let t=[];for(var n=1;n<e.length;n++)t.push(e[n]-e[n-1]);return t}function zn(e,t){return e==t}function qn(e,t){var n={attempt_ref:null};return r=>{n.attempt_ref&&clearTimeout(n.attempt_ref),n.attempt_ref=setTimeout((function(){t(r)}),e)}}function Hn(e,t){let n={},r=[];return he(e).map((i=>{try{n[i]=e[i](t)}catch(e){r.push(e),n[i]=null}})),r.length&&(at("Error while applying function to dictionary"),at(r),at(n)),n}async function Kn(e,t){let n={},r=[],i=he(e).map((async i=>{try{n[i]=await e[i](t)}catch(e){r.push(e),n[i]=null}}));return await Promise.all(i),r.length&&(at("Error while applying function to dictionary"),at(r),at(n)),n}const Wn=function(){return!1},Gn=function(){return!0},Zn={"@@functional/placeholder":!0};var Jn=q((function(e,t){return Number(e)+Number(t)}));const Qn=Jn,Xn=V((function(e){return K(e.length,(function(){var t=arguments[0],n=arguments[arguments.length-1],r=n.length-1,i=Array.prototype.slice.call(arguments,0);return i[0]=function(){var e=t.apply(this,F(arguments,[r,n]));return r-=1,e},e.apply(this,i)}))}));var Yn=He((function(e,t,n){var r=n.length;if(e>=r||e<-r)return n;var i=(r+e)%r,s=F(n);return s[i]=t(n[i]),s}));const er=Yn;function tr(e){return e&&e["@@transducer/reduced"]?e:{"@@transducer/value":e,"@@transducer/reduced":!0}}var nr=function(){function e(e,t){this.xf=t,this.f=e,this.all=!0}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=function(e){return this.all&&(e=this.xf["@@transducer/step"](e,!0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)||(this.all=!1,e=tr(this.xf["@@transducer/step"](e,!1))),e},e}();const rr=q(Q(["all"],(function(e){return function(t){return new nr(e,t)}}),(function(e,t){for(var n=0;n<t.length;){if(!e(t[n]))return!1;n+=1}return!0})));var ir=q((function(e,t){if(e===t)return t;function n(e,t){if(e>t!=t>e)return t>e?t:e}var r=n(e,t);if(void 0!==r)return r;var i=n(typeof e,typeof t);if(void 0!==i)return i===typeof e?e:t;var s=$e(e),a=n(s,$e(t));return void 0!==a&&a===s?e:t}));const sr=ir;var ar=q((function(e,t){return fe(qe(e),t)}));const or=ar;var cr=V((function(e){return K(et(sr,0,or("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(!e[t].apply(this,arguments))return!1;t+=1}return!0}))}));const ur=cr,lr=V((function(e){return function(){return e}}));var hr=q((function(e,t){return e&&t}));const dr=hr;var fr=function(){function e(e,t){this.xf=t,this.f=e,this.any=!1}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=function(e){return this.any||(e=this.xf["@@transducer/step"](e,!1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.any=!0,e=tr(this.xf["@@transducer/step"](e,!0))),e},e}();const pr=q(Q(["any"],(function(e){return function(t){return new fr(e,t)}}),(function(e,t){for(var n=0;n<t.length;){if(e(t[n]))return!0;n+=1}return!1})));var mr=V((function(e){return K(et(sr,0,or("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(e[t].apply(this,arguments))return!0;t+=1}return!1}))}));const gr=mr,yr=Ge(G,(function(e,t,n,r){return n[r](e,t)}),(function(e,t,n){for(var r=n.next();!r.done;)t=e(t,r.value),r=n.next();return t})),vr=q((function(e,t){return"function"==typeof t["fantasy-land/ap"]?t["fantasy-land/ap"](e):"function"==typeof e.ap?e.ap(t):"function"==typeof e?function(n){return e(n)(t(n))}:yr((function(e,n){return F(e,fe(n,t))}),[],e)}));var _r=function(){function e(e,t){this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.store(t),this.full?this.xf["@@transducer/step"](e,this.getCopy()):e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},e.prototype.getCopy=function(){return F(Array.prototype.slice.call(this.acc,this.pos),Array.prototype.slice.call(this.acc,0,this.pos))},e}();const wr=q(Q([],(function(e){return function(t){return new _r(e,t)}}),(function(e,t){for(var n=0,r=t.length-(e-1),i=new Array(r>=0?r:0);n<r;)i[n]=Array.prototype.slice.call(t,n,n+e),n+=1;return i}))),br=q((function(e,t){return F(t,[e])})),Er=q((function(e,t){return e.apply(this,t)}));var kr=V((function(e){for(var t=he(e),n=t.length,r=[],i=0;i<n;)r[i]=e[t[i]],i+=1;return r}));const Sr=kr;function Tr(e,t){return Z(t)?t.map(e):he(t).reduce((function(n,r){return n[r]=e(t[r]),n}),{})}const Ir=V((function e(t){return t=Tr((function(t){return"function"==typeof t?t:e(t)}),t),K(et(sr,0,or("length",Sr(t))),(function(){var e=arguments;return Tr((function(t){return Er(t,e)}),t)}))})),Or=q((function(e,t){return t(e)}));var Ar=He((function(e,t,n){var r=e(t),i=e(n);return r<i?-1:r>i?1:0}));const xr=Ar;function Pr(e,t,n){if(Be(e)&&Z(n)){var r=[].concat(n);return r[e]=t,r}var i={};for(var s in n)i[s]=n[s];return i[e]=t,i}const Cr=V((function(e){return null==e}));var Nr=He((function e(t,n,r){if(0===t.length)return n;var i=t[0];if(t.length>1){var s=!Cr(r)&&re(i,r)&&"object"==typeof r[i]?r[i]:Be(t[1])?[]:{};n=e(Array.prototype.slice.call(t,1),n,s)}return Pr(i,n,r)}));const Rr=Nr;var jr=He((function(e,t,n){return Rr([e],t,n)}));const Lr=jr;var Dr=q((function(e,t){switch(e){case 0:return function(){return t.call(this)};case 1:return function(e){return t.call(this,e)};case 2:return function(e,n){return t.call(this,e,n)};case 3:return function(e,n,r){return t.call(this,e,n,r)};case 4:return function(e,n,r,i){return t.call(this,e,n,r,i)};case 5:return function(e,n,r,i,s){return t.call(this,e,n,r,i,s)};case 6:return function(e,n,r,i,s,a){return t.call(this,e,n,r,i,s,a)};case 7:return function(e,n,r,i,s,a,o){return t.call(this,e,n,r,i,s,a,o)};case 8:return function(e,n,r,i,s,a,o,c){return t.call(this,e,n,r,i,s,a,o,c)};case 9:return function(e,n,r,i,s,a,o,c,u){return t.call(this,e,n,r,i,s,a,o,c,u)};case 10:return function(e,n,r,i,s,a,o,c,u,l){return t.call(this,e,n,r,i,s,a,o,c,u,l)};default:throw new Error("First argument to nAry must be a non-negative integer no greater than ten")}}));const Mr=Dr,$r=V((function(e){return Mr(2,e)})),Ur=q((function(e,t){var n=K(e,t);return K(e,(function(){return G(vr,fe(n,arguments[0]),Array.prototype.slice.call(arguments,1))}))})),Fr=V((function(e){return Ur(e.length,e)}));var Br=q((function(e,t){return pe(e)?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:Fr(dr)(e,t)}));const Vr=Br,zr=V((function(e){return e.apply(this,Array.prototype.slice.call(arguments,1))}));function qr(e){return function t(n){for(var r,i,s,a=[],o=0,c=n.length;o<c;){if(Ke(n[o]))for(s=0,i=(r=e?t(n[o]):n[o]).length;s<i;)a[a.length]=r[s],s+=1;else a[a.length]=n[o];o+=1}return a}}var Hr="@@transducer/init",Kr="@@transducer/step",Wr="@@transducer/result",Gr=function(){function e(e){this.xf=e}return e.prototype[Hr]=Y,e.prototype[Wr]=ee,e.prototype[Kr]=function(e,t){var n=this.xf[Kr](e,t);return n["@@transducer/reduced"]?{"@@transducer/value":n,"@@transducer/reduced":!0}:n},e}(),Zr=function(){function e(e){this.xf=new Gr(e)}return e.prototype[Hr]=Y,e.prototype[Wr]=ee,e.prototype[Kr]=function(e,t){return Ke(t)?Qe(this.xf,e,t):Ze(this.xf,e,[t])},e}();const Jr=q(Q(["fantasy-land/chain","chain"],(function(e){return function(t){return ne(e)(function(e){return new Zr(e)}(t))}}),(function(e,t){return"function"==typeof t?function(n){return e(t(n))(n)}:qr(!1)(fe(e,t))})));var Qr=He((function(e,t,n){if(e>t)throw new Error("min must not be greater than max in clamp(min, max, value)");return n<e?e:n>t?t:n}));const Xr=Qr;function Yr(e){return new RegExp(e.source,e.flags?e.flags:(e.global?"g":"")+(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.sticky?"y":"")+(e.unicode?"u":"")+(e.dotAll?"s":""))}function ei(e,t,n){if(n||(n=new ti),i=typeof(r=e),null==r||"object"!=i&&"function"!=i)return e;var r,i,s=function(r){var i=n.get(e);if(i)return i;for(var s in n.set(e,r),e)Object.prototype.hasOwnProperty.call(e,s)&&(r[s]=t?ei(e[s],!0,n):e[s]);return r};switch(_e(e)){case"Object":return s(Object.create(Object.getPrototypeOf(e)));case"Array":return s([]);case"Date":return new Date(e.valueOf());case"RegExp":return Yr(e);case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":return e.slice();default:return e}}var ti=function(){function e(){this.map={},this.length=0}return e.prototype.set=function(e,t){const n=this.hash(e);let r=this.map[n];r||(this.map[n]=r=[]),r.push([e,t]),this.length+=1},e.prototype.hash=function(e){let t=[];for(var n in e)t.push(Object.prototype.toString.call(e[n]));return t.join()},e.prototype.get=function(e){if(this.length<=180){for(const t in this.map){const n=this.map[t];for(let t=0;t<n.length;t+=1){const r=n[t];if(r[0]===e)return r[1]}}return}const t=this.hash(e),n=this.map[t];if(n)for(let t=0;t<n.length;t+=1){const r=n[t];if(r[0]===e)return r[1]}},e}(),ni=V((function(e){return null!=e&&"function"==typeof e.clone?e.clone():ei(e,!0)}));const ri=ni;var ii=q((function(e,t){var n=yr((function(t,n){var r=e(n);return void 0===t[r]&&(t[r]=[]),t[r].push(n),t}),{},t),r=[];for(var i in n)r.push(n[i]);return r}));const si=ii;var ai=V((function(e){return function(t,n){return e(t,n)?-1:e(n,t)?1:0}}));const oi=ai;var ci=V((function(e){return!e}));const ui=ci,li=Fr(ui);function hi(e,t){return function(){return t.call(this,e.apply(this,arguments))}}function di(e,t){return function(){var n=arguments.length;if(0===n)return t();var r=arguments[n-1];return Z(r)||"function"!=typeof r[e]?t.apply(this,arguments):r[e].apply(r,Array.prototype.slice.call(arguments,0,n-1))}}const fi=He(di("slice",(function(e,t,n){return Array.prototype.slice.call(n,e,t)}))),pi=V(di("tail",fi(1,1/0)));function mi(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return z(arguments[0].length,et(hi,arguments[0],pi(arguments)))}const gi=V((function(e){return me(e)?e.split("").reverse().join(""):Array.prototype.slice.call(e,0).reverse()}));function yi(){if(0===arguments.length)throw new Error("compose requires at least one argument");return mi.apply(this,gi(arguments))}const vi=Ve(0);function _i(e){return e}const wi=V(_i),bi=q((function(e,t){if(t.length<=0)return wi;var n=vi(t),r=pi(t);return z(n.length,(function(){return yr((function(t,n){return e.call(this,n,t)}),n.apply(this,arguments),r)}))})),Ei=q((function(e,t){return bi.apply(this,[e,gi(t)])}));var ki=V((function(e){return z(et(sr,0,fe((function(e){return e[0].length}),e)),(function(){for(var t=0;t<e.length;){if(e[t][0].apply(this,arguments))return e[t][1].apply(this,arguments);t+=1}}))}));const Si=ki,Ti=V((function(e){return K(e.length,e)}));var Ii=q((function(e,t){if(e>10)throw new Error("Constructor with greater than ten arguments");return 0===e?function(){return new t}:Ti(Mr(e,(function(n,r,i,s,a,o,c,u,l,h){switch(e){case 1:return new t(n);case 2:return new t(n,r);case 3:return new t(n,r,i);case 4:return new t(n,r,i,s);case 5:return new t(n,r,i,s,a);case 6:return new t(n,r,i,s,a,o);case 7:return new t(n,r,i,s,a,o,c);case 8:return new t(n,r,i,s,a,o,c,u);case 9:return new t(n,r,i,s,a,o,c,u,l);case 10:return new t(n,r,i,s,a,o,c,u,l,h)}})))}));const Oi=Ii,Ai=V((function(e){return Oi(e.length,e)}));var xi=q((function(e,t){return K(et(sr,0,or("length",t)),(function(){var n=arguments,r=this;return e.apply(r,X((function(e){return e.apply(r,n)}),t))}))}));const Pi=xi;var Ci=Ti((function(e,t){return yr((function(t,n){return e(n)?t+1:t}),0,t)}));const Ni=Ci;var Ri=function(){function e(e,t,n,r){this.valueFn=e,this.valueAcc=t,this.keyFn=n,this.xf=r,this.inputs={}}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=function(e){var t;for(t in this.inputs)if(re(t,this.inputs)&&(e=this.xf["@@transducer/step"](e,this.inputs[t]))["@@transducer/reduced"]){e=e["@@transducer/value"];break}return this.inputs=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){var n=this.keyFn(t);return this.inputs[n]=this.inputs[n]||[n,ei(this.valueAcc,!1)],this.inputs[n][1]=this.valueFn(this.inputs[n][1],t),e},e}(),ji=H(4,[],Q([],(function(e,t,n){return function(r){return new Ri(e,t,n,r)}}),(function(e,t,n,r){var i=Ye((function(r,i){var s=n(i),a=e(re(s,r)?r[s]:ei(t,!1),i);return a&&a["@@transducer/reduced"]?tr(r):(r[s]=a,r)}));return Qe(i,{},r)})));const Li=ji,Di=Li((function(e,t){return e+1}),0),Mi=Qn(-1);var $i=q((function(e,t){return null==t||t!=t?e:t}));const Ui=$i;var Fi=He((function(e,t,n){var r=e(t),i=e(n);return r>i?-1:r<i?1:0}));const Bi=Fi;function Vi(e,t,n){var r,i=typeof e;switch(i){case"string":case"number":return 0===e&&1/e==-1/0?!!n._items["-0"]||(t&&(n._items["-0"]=!0),!1):null!==n._nativeSet?t?(r=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===r):n._nativeSet.has(e):i in n._items?e in n._items[i]||(t&&(n._items[i][e]=!0),!1):(t&&(n._items[i]={},n._items[i][e]=!0),!1);case"boolean":if(i in n._items){var s=e?1:0;return!!n._items[i][s]||(t&&(n._items[i][s]=!0),!1)}return t&&(n._items[i]=e?[!1,!0]:[!0,!1]),!1;case"function":return null!==n._nativeSet?t?(r=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===r):n._nativeSet.has(e):i in n._items?!!Te(e,n._items[i])||(t&&n._items[i].push(e),!1):(t&&(n._items[i]=[e]),!1);case"undefined":return!!n._items[i]||(t&&(n._items[i]=!0),!1);case"object":if(null===e)return!!n._items.null||(t&&(n._items.null=!0),!1);default:return(i=Object.prototype.toString.call(e))in n._items?!!Te(e,n._items[i])||(t&&n._items[i].push(e),!1):(t&&(n._items[i]=[e]),!1)}}const zi=function(){function e(){this._nativeSet="function"==typeof Set?new Set:null,this._items={}}return e.prototype.add=function(e){return!Vi(e,!0,this)},e.prototype.has=function(e){return Vi(e,!1,this)},e}();var qi=q((function(e,t){for(var n=[],r=0,i=e.length,s=t.length,a=new zi,o=0;o<s;o+=1)a.add(t[o]);for(;r<i;)a.add(e[r])&&(n[n.length]=e[r]),r+=1;return n}));const Hi=qi;var Ki=He((function(e,t,n){for(var r=[],i=0,s=t.length;i<s;)ye(e,t[i],n)||ye(e,t[i],r)||r.push(t[i]),i+=1;return r}));const Wi=Ki;var Gi=He((function(e,t,n){var r=Array.prototype.slice.call(n,0);return r.splice(e,t),r}));const Zi=Gi;var Ji=q((function e(t,n){if(null==n)return n;switch(t.length){case 0:return n;case 1:return function(e,t){if(null==t)return t;if(Be(e)&&Z(t))return Zi(e,1,t);var n={};for(var r in t)n[r]=t[r];return delete n[e],n}(t[0],n);default:var r=t[0],i=Array.prototype.slice.call(t,1);return null==n[r]?function(e,t){if(Be(e)&&Z(t))return[].concat(t);var n={};for(var r in t)n[r]=t[r];return n}(r,n):Lr(r,e(i,n[r]),n)}}));const Qi=Ji;var Xi=q((function(e,t){return Qi([e],t)}));const Yi=Xi;var es=q((function(e,t){return e/t}));const ts=es;var ns=function(){function e(e,t){this.xf=t,this.n=e}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=ee,e.prototype["@@transducer/step"]=function(e,t){return this.n>0?(this.n-=1,e):this.xf["@@transducer/step"](e,t)},e}(),rs=q(Q(["drop"],(function(e){return function(t){return new ns(e,t)}}),(function(e,t){return fi(Math.max(0,e),1/0,t)})));const is=rs;var ss=function(){function e(e,t){this.xf=t,this.n=e,this.i=0}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=ee,e.prototype["@@transducer/step"]=function(e,t){this.i+=1;var n=0===this.n?e:this.xf["@@transducer/step"](e,t);return this.n>=0&&this.i>=this.n?tr(n):n},e}(),as=q(Q(["take"],(function(e){return function(t){return new ss(e,t)}}),(function(e,t){return fi(0,e<0?1/0:e,t)})));const os=as;var cs=function(){function e(e,t){if(e<=0)return t;this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.full&&(e=this.xf["@@transducer/step"](e,this.acc[this.pos])),this.store(t),e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},e}();const us=q(Q([],(function(e){return function(t){return new cs(e,t)}}),(function(e,t){return os(e<t.length?t.length-e:0,t)})));var ls=function(){function e(e,t){this.f=e,this.retained=[],this.xf=t}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=function(e){return this.retained=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.retain(e,t):this.flush(e,t)},e.prototype.flush=function(e,t){return e=Qe(this.xf,e,this.retained),this.retained=[],this.xf["@@transducer/step"](e,t)},e.prototype.retain=function(e,t){return this.retained.push(t),e},e}();const hs=q(Q([],(function(e){return function(t){return new ls(e,t)}}),(function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return fi(0,n+1,t)})));var ds=function(){function e(e,t){this.xf=t,this.pred=e,this.lastValue=void 0,this.seenFirstValue=!1}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=ee,e.prototype["@@transducer/step"]=function(e,t){var n=!1;return this.seenFirstValue?this.pred(this.lastValue,t)&&(n=!0):this.seenFirstValue=!0,this.lastValue=t,n?e:this.xf["@@transducer/step"](e,t)},e}();function fs(e){return function(t){return new ds(e,t)}}const ps=Ve(-1);var ms=q(Q([],fs,(function(e,t){var n=[],r=1,i=t.length;if(0!==i)for(n[0]=t[0];r<i;)e(ps(n),t[r])||(n[n.length]=t[r]),r+=1;return n})));const gs=ms,ys=V(Q([],(function(){return fs(ke)}),gs(ke))),vs=He((function(e,t,n){return ke(e(t),e(n))})),_s=q((function(e,t){return Q([],(function(){return fs(vs(e))}),gs(vs(e)))(t)}));var ws=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=ee,e.prototype["@@transducer/step"]=function(e,t){if(this.f){if(this.f(t))return e;this.f=null}return this.xf["@@transducer/step"](e,t)},e}(),bs=q(Q(["dropWhile"],(function(e){return function(t){return new ws(e,t)}}),(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return fi(n,1/0,t)})));const Es=bs;var ks=q((function(e,t){return e||t}));const Ss=ks;var Ts=q((function(e,t){return pe(e)?function(){return e.apply(this,arguments)||t.apply(this,arguments)}:Fr(Ss)(e,t)}));const Is=Ts,Os=V((function(e){return null!=e&&"function"==typeof e["fantasy-land/empty"]?e["fantasy-land/empty"]():null!=e&&null!=e.constructor&&"function"==typeof e.constructor["fantasy-land/empty"]?e.constructor["fantasy-land/empty"]():null!=e&&"function"==typeof e.empty?e.empty():null!=e&&null!=e.constructor&&"function"==typeof e.constructor.empty?e.constructor.empty():Z(e)?[]:me(e)?"":Ne(e)?{}:se(e)?function(){return arguments}():(t=e,"[object Uint8ClampedArray]"===(n=Object.prototype.toString.call(t))||"[object Int8Array]"===n||"[object Uint8Array]"===n||"[object Int16Array]"===n||"[object Uint16Array]"===n||"[object Int32Array]"===n||"[object Uint32Array]"===n||"[object Float32Array]"===n||"[object Float64Array]"===n||"[object BigInt64Array]"===n||"[object BigUint64Array]"===n?e.constructor.from(""):void 0);var t,n}));var As=q((function(e,t){return is(e>=0?t.length-e:0,t)}));const xs=As,Ps=q((function(e,t){return ke(xs(e.length,t),e)}));var Cs=He((function(e,t,n){return ke(t[e],n[e])}));const Ns=Cs;var Rs=q((function e(t,n){if(!Ne(n)&&!Z(n))return n;var r,i,s,a=n instanceof Array?[]:{};for(i in n)s=typeof(r=t[i]),a[i]="function"===s?r(n[i]):r&&"object"===s?e(r,n[i]):n[i];return a}));const js=Rs;var Ls=function(){function e(e,t){this.xf=t,this.f=e,this.found=!1}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,void 0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.found=!0,e=tr(this.xf["@@transducer/step"](e,t))),e},e}(),Ds=q(Q(["find"],(function(e){return function(t){return new Ls(e,t)}}),(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return t[n];n+=1}})));const Ms=Ds;var $s=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.found=!1}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,-1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.found=!0,e=tr(this.xf["@@transducer/step"](e,this.idx))),e},e}(),Us=q(Q([],(function(e){return function(t){return new $s(e,t)}}),(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return n;n+=1}return-1})));const Fs=Us;var Bs=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.last))},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.last=t),e},e}();const Vs=q(Q([],(function(e){return function(t){return new Bs(e,t)}}),(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return t[n];n-=1}})));var zs=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.lastIdx=-1}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.lastIdx))},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.lastIdx=this.idx),e},e}();const qs=q(Q([],(function(e){return function(t){return new zs(e,t)}}),(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return n;n-=1}return-1}))),Hs=V(qr(!0));var Ks=V((function(e){return K(e.length,(function(t,n){var r=Array.prototype.slice.call(arguments,0);return r[0]=n,r[1]=t,e.apply(this,r)}))}));const Ws=Ks;var Gs=q(di("forEach",(function(e,t){for(var n=t.length,r=0;r<n;)e(t[r]),r+=1;return t})));const Zs=Gs;var Js=q((function(e,t){for(var n=he(t),r=0;r<n.length;){var i=n[r];e(t[i],i,t),r+=1}return t}));const Qs=Js;var Xs=V((function(e){for(var t={},n=0;n<e.length;)t[e[n][0]]=e[n][1],n+=1;return t}));const Ys=Xs,ea=q(di("groupBy",Li((function(e,t){return e.push(t),e}),[])));var ta=q((function(e,t){for(var n=[],r=0,i=t.length;r<i;){for(var s=r+1;s<i&&e(t[s-1],t[s]);)s+=1;n.push(t.slice(r,s)),r=s}return n}));const na=ta;var ra=q((function(e,t){return e>t}));const ia=ra;var sa=q((function(e,t){return e>=t}));const aa=sa,oa=q((function(e,t){if(0===e.length||Cr(t))return!1;for(var n=t,r=0;r<e.length;){if(Cr(n)||!re(e[r],n))return!1;n=n[e[r]],r+=1}return!0}));var ca=q((function(e,t){return oa([e],t)}));const ua=ca;var la=q((function(e,t){return!Cr(t)&&e in t}));const ha=la;var da=function(e,t){switch(arguments.length){case 0:return da;case 1:return function t(n){return 0===arguments.length?t:ve(e,n)};default:return ve(e,t)}};const fa=da,pa=He((function(e,t,n){return K(Math.max(e.length,t.length,n.length),(function(){return e.apply(this,arguments)?t.apply(this,arguments):n.apply(this,arguments)}))})),ma=Qn(1),ga=q(Te),ya=Li((function(e,t){return t}),null),va=q((function(e,t){return"function"!=typeof t.indexOf||Z(t)?Se(t,e,0):t.indexOf(e)})),_a=fi(0,-1),wa=He((function(e,t,n){return Ce((function(t){return ye(e,t,n)}),t)})),ba=He((function(e,t,n){e=e<n.length&&e>=0?e:n.length;var r=Array.prototype.slice.call(n,0);return r.splice(e,0,t),r})),Ea=He((function(e,t,n){return e=e<n.length&&e>=0?e:n.length,[].concat(Array.prototype.slice.call(n,0,e),t,Array.prototype.slice.call(n,e))}));var ka=function(){function e(e,t){this.xf=t,this.f=e,this.set=new zi}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=ee,e.prototype["@@transducer/step"]=function(e,t){return this.set.add(this.f(t))?this.xf["@@transducer/step"](e,t):e},e}(),Sa=q(Q([],(function(e){return function(t){return new ka(e,t)}}),(function(e,t){for(var n,r,i=new zi,s=[],a=0;a<t.length;)n=e(r=t[a]),i.add(n)&&s.push(r),a+=1;return s})));const Ta=Sa,Ia=Ta(wi);var Oa=q((function(e,t){for(var n=new zi,r=0;r<e.length;r+=1)n.add(e[r]);return Ia(Ce(n.has.bind(n),t))}));const Aa=Oa,xa=q(di("intersperse",(function(e,t){for(var n=[],r=0,i=t.length;r<i;)r===i-1?n.push(t[r]):n.push(t[r],e),r+=1;return n}))),Pa="function"==typeof Object.assign?Object.assign:function(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),n=1,r=arguments.length;n<r;){var i=arguments[n];if(null!=i)for(var s in i)re(s,i)&&(t[s]=i[s]);n+=1}return t};var Ca=q((function(e,t){var n={};return n[e]=t,n}));const Na=Ca;var Ra={"@@transducer/init":Array,"@@transducer/step":function(e,t){return e.push(t),e},"@@transducer/result":_i},ja={"@@transducer/init":String,"@@transducer/step":function(e,t){return e+t},"@@transducer/result":_i},La={"@@transducer/init":Object,"@@transducer/step":function(e,t){return Pa(e,Ke(t)?Na(t[0],t[1]):t)},"@@transducer/result":_i};const Da=He((function(e,t,n){var r=t(J(e)?e:function(e){if(J(e))return e;if(Ke(e))return Ra;if("string"==typeof e)return ja;if("object"==typeof e)return La;throw new Error("Cannot create transformer for "+e)}(e));return Qe(r,r["@@transducer/init"](),n)}));var Ma=V((function(e){for(var t=he(e),n=t.length,r=0,i={};r<n;){var s=t[r],a=e[s],o=re(a,i)?i[a]:i[a]=[];o[o.length]=s,r+=1}return i}));const $a=Ma;var Ua=V((function(e){for(var t=he(e),n=t.length,r=0,i={};r<n;){var s=t[r];i[e[s]]=s,r+=1}return i}));const Fa=Ua,Ba=q((function(e,t){return K(e+1,(function(){var n=arguments[e];if(null!=n&&pe(n[t]))return n[t].apply(n,Array.prototype.slice.call(arguments,0,e));throw new TypeError($e(n)+' does not have a method named "'+t+'"')}))})),Va=q((function(e,t){return t instanceof e||null!=t&&(t.constructor===e||"Object"===e.name&&"object"==typeof t)})),za=V((function(e){return null!=e&&ke(e,Os(e))})),qa=V((function(e){return!Cr(e)})),Ha=Ba(1,"join");var Ka=V((function(e){return Pi((function(){return Array.prototype.slice.call(arguments,0)}),e)}));const Wa=Ka;var Ga=V((function(e){var t,n=[];for(t in e)n[n.length]=t;return n}));const Za=Ga,Ja=q((function(e,t){if("function"!=typeof t.lastIndexOf||Z(t)){for(var n=t.length-1;n>=0;){if(ke(t[n],e))return n;n-=1}return-1}return t.lastIndexOf(e)}));function Qa(e){return"[object Number]"===Object.prototype.toString.call(e)}const Xa=V((function(e){return null!=e&&Qa(e.length)?e.length:NaN}));var Ya=q((function(e,t){return function(n){return function(r){return fe((function(e){return t(e,r)}),n(e(r)))}}}));const eo=Ya,to=He((function(e,t,n){return er(e,lr(t),n)}));var no=V((function(e){return eo(Ve(e),to(e))}));const ro=no;var io=q((function(e,t){return e.map((function(e){for(var n,r=t,i=0;i<e.length;){if(null==r)return;n=e[i],r=Be(n)?Ve(n,r):r[n],i+=1}return r}))}));const so=io,ao=q((function(e,t){return so([e],t)[0]}));var oo=V((function(e){return eo(ao(e),Rr(e))}));const co=oo;var uo=V((function(e){return eo(qe(e),Lr(e))}));const lo=uo;var ho=q((function(e,t){return e<t}));const fo=ho;var po=q((function(e,t){return e<=t}));const mo=po;var go=He((function(e,t,n){for(var r=0,i=n.length,s=[],a=[t];r<i;)a=e(a[0],n[r]),s[r]=a[1],r+=1;return[a[0],s]}));const yo=go,vo=He((function(e,t,n){for(var r=n.length-1,i=[],s=[t];r>=0;)s=e(s[0],n[r]),i[r]=s[1],r-=1;return[s[0],i]}));var _o=q((function(e,t){return G((function(n,r){return n[r]=e(t[r],r,t),n}),{},he(t))}));const wo=_o;var bo=q((function(e,t){return t.match(e)||[]}));const Eo=bo;var ko=q((function(e,t){return Be(e)?!Be(t)||t<1?NaN:(e%t+t)%t:NaN}));const So=ko;var To=He((function(e,t,n){var r=e(n);return sr(e(t),r)===r?n:t}));const Io=To,Oo=et(Qn,0),Ao=V((function(e){return Oo(e)/e.length}));var xo=V((function(e){var t=e.length;if(0===t)return NaN;var n=2-t%2,r=(t-n)/2;return Ao(Array.prototype.slice.call(e,0).sort((function(e,t){return e<t?-1:e>t?1:0})).slice(r,r+n))}));const Po=xo;var Co=q((function(e,t){var n={};return z(t.length,(function(){var r=e.apply(this,arguments);return re(r,n)||(n[r]=t.apply(this,arguments)),n[r]}))}));const No=Co,Ro=V((function(e){return Pa.apply(null,[{}].concat(e))}));var jo=He((function(e,t,n){var r,i={};for(r in n=n||{},t=t||{})re(r,t)&&(i[r]=re(r,n)?e(r,t[r],n[r]):t[r]);for(r in n)re(r,n)&&!re(r,i)&&(i[r]=n[r]);return i}));const Lo=jo;var Do=He((function e(t,n,r){return Lo((function(n,r,i){return Ne(r)&&Ne(i)?e(t,r,i):t(n,r,i)}),n,r)}));const Mo=Do,$o=q((function(e,t){return Mo((function(e,t,n){return t}),e,t)})),Uo=q((function(e,t){return Mo((function(e,t,n){return n}),e,t)})),Fo=He((function(e,t,n){return Mo((function(t,n,r){return e(n,r)}),t,n)}));var Bo=q((function(e,t){return Pa({},t,e)}));const Vo=Bo;var zo=q((function(e,t){return Pa({},e,t)}));const qo=zo;var Ho=He((function(e,t,n){return Lo((function(t,n,r){return e(n,r)}),t,n)}));const Ko=Ho;var Wo=q((function(e,t){if(e===t)return e;function n(e,t){if(e<t!=t<e)return t<e?t:e}var r=n(e,t);if(void 0!==r)return r;var i=n(typeof e,typeof t);if(void 0!==i)return i===typeof e?e:t;var s=$e(e),a=n(s,$e(t));return void 0!==a?a===s?e:t:e}));const Go=Wo;var Zo=He((function(e,t,n){var r=e(n);return Go(e(t),r)===r?n:t}));const Jo=Zo;var Qo=He((function e(t,n,r){if(!Ne(r)&&!Z(r))return r;if(0===t.length)return n(r);var i=t[0];if(!re(i,r))return r;if(1===t.length)return function(e,t,n){if(Be(e)&&Z(n)){var r=[].concat(n);return r[e]=t(r[e]),r}var i={};for(var s in n)i[s]=n[s];return i[e]=t(i[e]),i}(i,n,r);var s=e(Array.prototype.slice.call(t,1),n,r[i]);return s===r[i]?r:Pr(i,s,r)}));const Xo=Qo;var Yo=He((function(e,t,n){return Xo([e],t,n)}));const ec=Yo;var tc=q((function(e,t){return e%t}));const nc=tc,rc=He((function(e,t,n){var r=n.length,i=n.slice(),s=e<0?r+e:e,a=t<0?r+t:t,o=i.splice(s,1);return s<0||s>=n.length||a<0||a>=n.length?n:[].concat(i.slice(0,a)).concat(o).concat(i.slice(a,n.length))}));var ic=q((function(e,t){return e*t}));const sc=ic;var ac=q(((e,t)=>n=>e.call(void 0,Uo(t,n))));const oc=ac;var cc=V((function(e){return-e}));const uc=cc,lc=q((function(e,t){return rr(Pe(e),t)}));var hc=V((function(e){return K(e<0?1:e+1,(function(){return Ve(e,arguments)}))}));const dc=hc;var fc=He((function(e,t,n){return e(t(n))}));const pc=fc,mc=q((function(e,t){return"function"==typeof e["fantasy-land/of"]?e["fantasy-land/of"](t):"function"==typeof e.of?e.of(t):[t]}));var gc=q((function(e,t){for(var n={},r={},i=0,s=e.length;i<s;)r[e[i]]=1,i+=1;for(var a in t)r.hasOwnProperty(a)||(n[a]=t[a]);return n}));const yc=gc;var vc=H(4,[],(function(e,t,n,r){return e(t(n),t(r))}));const _c=vc,wc=V((function(e){var t,n=!1;return z(e.length,(function(){return n?t:(n=!0,t=e.apply(this,arguments))}))}));function bc(e,t){if(null==t||!pe(t.then))throw new TypeError("`"+e+"` expected a Promise, received "+Me(t,[]))}var Ec=q((function(e,t){return bc("otherwise",t),t.then(null,e)}));const kc=Ec;var Sc=function(e){return{value:e,map:function(t){return Sc(t(e))}}},Tc=He((function(e,t,n){return e((function(e){return Sc(t(e))}))(n).value}));const Ic=Tc,Oc=q((function(e,t){return[e,t]}));function Ac(e){return q((function(t,n){return z(Math.max(0,t.length-n.length),(function(){return t.apply(this,e(n,arguments))}))}))}const xc=Ac(F),Pc=Ac(Ws(F)),Cc=Wa([Le,De]),Nc=He((function(e,t,n){return ke(ao(t,n),e)}));var Rc=He((function(e,t,n){return Ui(e,ao(t,n))}));const jc=Rc,Lc=He((function(e,t,n){return e(ao(t,n))})),Dc=q((function(e,t){for(var n={},r=0;r<e.length;)e[r]in t&&(n[e[r]]=t[e[r]]),r+=1;return n}));var Mc=q((function(e,t){for(var n={},r=0,i=e.length;r<i;){var s=e[r];n[s]=t[s],r+=1}return n}));const $c=Mc;var Uc=q((function(e,t){var n={};for(var r in t)e(t[r],r,t)&&(n[r]=t[r]);return n}));const Fc=Uc,Bc=q((function(e,t){return F([e],t)})),Vc=et(sc,1),zc=q((function(e,t){return K(t.length,(function(){for(var n=[],r=0;r<t.length;)n.push(t[r].call(this,arguments[r])),r+=1;return e.apply(this,n.concat(Array.prototype.slice.call(arguments,t.length)))}))})),qc=zc(X,[$c,wi]);function Hc(e,t,n){return function(r){return t(n(e(r)))}}var Kc=function(){function e(e,t,n){this.xf=n,this.f=e,this.g=t}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=ee,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,Hc(this.f,this.g,t))},e}();const Wc=He(Q(["fantasy-land/promap","promap"],(function(e,t){return function(n){return new Kc(e,t,n)}}),Hc)),Gc=He((function(e,t,n){return ke(e,qe(t,n))})),Zc=He((function(e,t,n){return Va(e,qe(t,n))}));var Jc=He((function(e,t,n){return Ui(e,qe(t,n))}));const Qc=Jc,Xc=He((function(e,t,n){return e(qe(t,n))}));var Yc=q((function(e,t){return e.map((function(e){return ao([e],t)}))}));const eu=Yc;var tu=q((function(e,t){if(!Qa(e)||!Qa(t))throw new TypeError("Both arguments to range must be numbers");for(var n=[],r=e;r<t;)n.push(r),r+=1;return n}));const nu=tu,ru=He((function(e,t,n){for(var r=n.length-1;r>=0;){if((t=e(n[r],t))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r-=1}return t}));var iu=H(4,[],(function(e,t,n,r){var i=Ye((function(n,r){return e(n,r)?t(n,r):tr(n)}));return Qe(i,n,r)}));const su=iu,au=V(tr);var ou=q((function(e,t){var n,r=Number(t),i=0;if(r<0||isNaN(r))throw new RangeError("n must be a non-negative number");for(n=[];i<r;)n.push(e(i)),i+=1;return n}));const cu=ou;var uu=q((function(e,t){return cu(lr(e),t)}));const lu=uu;var hu=He((function(e,t,n){return n.replace(e,t)}));const du=hu;var fu="@@transducer/init",pu="@@transducer/step",mu=function(){function e(e,t,n){this.xf=n,this.f=e,this.acc=t}return e.prototype[fu]=function(){return this.xf[pu](this.xf[fu](),this.acc)},e.prototype["@@transducer/result"]=ee,e.prototype[pu]=function(e,t){return e["@@transducer/reduced"]?e:(this.acc=this.f(this.acc,t),this.xf[pu](e,this.acc))},e}(),gu=He(Q([],He((function(e,t,n){return new mu(e,t,n)})),(function(e,t,n){for(var r=0,i=n.length,s=[t];r<i;)t=e(t,n[r]),s[r+1]=t,r+=1;return s})));const yu=gu,vu=q((function(e,t){var n="function"==typeof e["fantasy-land/of"]?e["fantasy-land/of"]:"function"==typeof e.of?e.of:e,r={"fantasy-land/of":n};return"function"==typeof t["fantasy-land/traverse"]?t["fantasy-land/traverse"](r,_i):"function"==typeof t.traverse?t.traverse(r,_i):ru((function(e,t){return vr(fe(Bc,e),t)}),n([]),t)}));var _u=He((function(e,t,n){return Ic(e,lr(t),n)}));const wu=_u;var bu=q((function(e,t){return Array.prototype.slice.call(t,0).sort(e)}));const Eu=bu;var ku=q((function(e,t){return Array.prototype.slice.call(t,0).sort((function(t,n){var r=e(t),i=e(n);return r<i?-1:r>i?1:0}))}));const Su=ku;var Tu=q((function(e,t){return Array.prototype.slice.call(t,0).sort((function(t,n){for(var r=0,i=0;0===r&&i<e.length;)r=e[i](t,n),i+=1;return r}))}));const Iu=Tu,Ou=Ba(1,"split");var Au=q((function(e,t){return[fi(0,e,t),fi(e,Xa(t),t)]}));const xu=Au;var Pu=q((function(e,t){if(e<=0)throw new Error("First argument to splitEvery must be a positive integer");for(var n=[],r=0;r<t.length;)n.push(fi(r,r+=e,t));return n}));const Cu=Pu;var Nu=q((function(e,t){for(var n=0,r=t.length,i=[];n<r&&!e(t[n]);)i.push(t[n]),n+=1;return[i,Array.prototype.slice.call(t,n)]}));const Ru=Nu;var ju=H(2,[],(function(e,t){for(var n=[],r=[],i=0;i<t.length;i+=1)e(t[i])||r.push(t[i]),(i<t.length-1&&e(t[i+1])||i===t.length-1)&&r.length>0&&(n.push(r),r=[]);return n}));const Lu=ju;var Du=q((function(e,t){return ke(os(e.length,t),e)}));const Mu=Du;var $u=q((function(e,t){return Number(e)-Number(t)}));const Uu=$u;var Fu=function(e,t,n){var r=n.length,i=n.slice(),s=e<0?r+e:e,a=t<0?r+t:t,o=Math.min(s,a),c=Math.max(s,a);return s<0||s>r||a<0||a>r||s===a?i:i=[].concat(i.slice(0,o)).concat([i[c]]).concat(i.slice(o+1,c)).concat([i[o]]).concat(i.slice(c+1,r))},Bu=He((function(e,t,n){return Z(n)?Fu(e,t,n):me(n)?function(e,t,n){var r=Fu(e,t,n);return Z(r)?r.join(""):r}(e,t,n):function(e,t,n){var r=ri(n),i=Object.getOwnPropertyNames(r);if(i.includes(e)&&i.includes(t)){var s=r[e];r[e]=r[t],r[t]=s}return r}(e,t,n)}));const Vu=Bu,zu=q((function(e,t){return Fe(Hi(e,t),Hi(t,e))})),qu=He((function(e,t,n){return Fe(Wi(e,t,n),Wi(e,n,t))})),Hu=q((function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return fi(n+1,1/0,t)}));var Ku=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=ee,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):tr(e)},e}(),Wu=q(Q(["takeWhile"],(function(e){return function(t){return new Ku(e,t)}}),(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return fi(0,n,t)})));const Gu=Wu;var Zu=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=ee,e.prototype["@@transducer/step"]=function(e,t){return this.f(t),this.xf["@@transducer/step"](e,t)},e}();const Ju=q(Q([],(function(e){return function(t){return new Zu(e,t)}}),(function(e,t){return e(t),t})));var Qu=q((function(e,t){if(n=e,"[object RegExp]"!==Object.prototype.toString.call(n))throw new TypeError("‘test’ requires a value of type RegExp as its first argument; received "+$e(e));var n;return Yr(e).test(t)}));const Xu=Qu;var Yu=q((function(e,t){return bc("andThen",t),t.then(e)}));const el=Yu,tl=Ba(0,"toLowerCase");var nl=V((function(e){var t=[];for(var n in e)re(n,e)&&(t[t.length]=[n,e[n]]);return t}));const rl=nl;var il=V((function(e){var t=[];for(var n in e)t[t.length]=[n,e[n]];return t}));const sl=il,al=Ba(0,"toUpperCase"),ol=K(4,(function(e,t,n,r){return Qe(e("function"==typeof t?Ye(t):t),n,r)}));var cl=V((function(e){for(var t=0,n=[];t<e.length;){for(var r=e[t],i=0;i<r.length;)void 0===n[i]&&(n[i]=[]),n[i].push(r[i]),i+=1;t+=1}return n}));const ul=cl,ll=He((function(e,t,n){var r={"fantasy-land/of":"function"==typeof e["fantasy-land/of"]?e["fantasy-land/of"]:"function"==typeof e.of?e.of:e};return"function"==typeof n["fantasy-land/traverse"]?n["fantasy-land/traverse"](r,t):"function"==typeof n.traverse?n.traverse(r,t):vu(r,fe(t,n))}));var hl="\t\n\v\f\r                　\u2028\u2029\ufeff",dl=V("function"==typeof String.prototype.trim&&!hl.trim()&&"​".trim()?function(e){return e.trim()}:function(e){var t=new RegExp("^["+hl+"]["+hl+"]*"),n=new RegExp("["+hl+"]["+hl+"]*$");return e.replace(t,"").replace(n,"")});const fl=dl;var pl=q((function(e,t){return z(e.length,(function(){try{return e.apply(this,arguments)}catch(e){return t.apply(this,F([e],arguments))}}))}));const ml=pl,gl=V((function(e){return function(){return e(Array.prototype.slice.call(arguments,0))}})),yl=V((function(e){return Mr(1,e)}));var vl=q((function(e,t){return K(e,(function(){for(var n,r=1,i=t,s=0;r<=e&&"function"==typeof i;)n=r===e?arguments.length:s+i.length,i=i.apply(this,Array.prototype.slice.call(arguments,s,n)),r+=1,s=n;return i}))}));const _l=vl,wl=q((function(e,t){for(var n=e(t),r=[];n&&n.length;)r[r.length]=n[0],n=e(n[1]);return r})),bl=q(yi(Ia,F));var El=function(){function e(e,t){this.xf=t,this.pred=e,this.items=[]}return e.prototype["@@transducer/init"]=Y,e.prototype["@@transducer/result"]=ee,e.prototype["@@transducer/step"]=function(e,t){return ye(this.pred,t,this.items)?e:(this.items.push(t),this.xf["@@transducer/step"](e,t))},e}(),kl=q(Q([],(function(e){return function(t){return new El(e,t)}}),(function(e,t){for(var n,r=0,i=t.length,s=[];r<i;)ye(e,n=t[r],s)||(s[s.length]=n),r+=1;return s})));const Sl=kl,Tl=He((function(e,t,n){return Sl(e,F(t,n))})),Il=He((function(e,t,n){return e(n)?n:t(n)})),Ol=Jr(_i),Al=He((function(e,t,n){for(var r=n;!e(r);)r=t(r);return r}));var xl=q((function(e,t){return e in t&&Z(t[e])?X((function(n){return Pr(e,n,t)}),t[e]):[t]}));const Pl=xl;var Cl=V((function(e){var t,n=[];for(t in e)n[n.length]=e[t];return n}));const Nl=Cl;var Rl=function(e){return{value:e,"fantasy-land/map":function(){return this}}},jl=q((function(e,t){return e(Rl)(t).value}));const Ll=jl,Dl=He((function(e,t,n){return e(n)?t(n):n}));var Ml=q((function(e,t){for(var n in e)if(re(n,e)&&!e[n](t[n]))return!1;return!0}));const $l=Ml;var Ul=q((function(e,t){for(var n in e)if(re(n,e)&&e[n](t[n]))return!0;return!1}));const Fl=Ul,Bl=q((function(e,t){return $l(fe(ke,e),t)}));var Vl=q((function(e,t){for(var n=new zi,r=0;r<e.length;r+=1)n.add(e[r]);return De(n.has.bind(n),t)}));const zl=Vl;var ql=q((function(e,t){return Boolean(!e^!t)}));const Hl=ql;var Kl=q((function(e,t){for(var n,r=0,i=e.length,s=t.length,a=[];r<i;){for(n=0;n<s;)a[a.length]=[e[r],t[n]],n+=1;r+=1}return a}));const Wl=Kl;var Gl=q((function(e,t){for(var n=[],r=0,i=Math.min(e.length,t.length);r<i;)n[r]=[e[r],t[r]],r+=1;return n}));const Zl=Gl;var Jl=q((function(e,t){for(var n=0,r=Math.min(e.length,t.length),i={};n<r;)i[e[n]]=t[n],n+=1;return i}));const Ql=Jl;var Xl=He((function(e,t,n){for(var r=[],i=0,s=Math.min(t.length,n.length);i<s;)r[i]=e(t[i],n[i]),i+=1;return r}));const Yl=Xl,eh=V((function(e){return K(e.length,(function(){var t=arguments;return function(){return e.apply(this,t)}}))}));var th;!function(e){e[e.BUY=0]="BUY",e[e.SELL=1]="SELL"}(th||(th={}));class nh{constructor(e){this.Params=e,this.Logger=st({id:e.logger_id}),this.last_balance_data={},this.log_mode="verbose",this.state={price_history:[],last_price:null,r:e.target_ratio},this.Params.alpha=this.Params.alpha||.01}log(e){this.Logger(e)}async balance_portfolio(){let{base_asset:e,quote_asset:t}=this.Params;"verbose"==this.log_mode&&this.log("Balancing...");let n=await this.get_balance_data(),{base_amt:r,quote_amt:i,base_price:s,portfolio_value:a,current_ratio:o,ratio_error:c,target_achieved:u,target_base_amt:l,base_delta:h,trade_type:d,base_market_amt:f}=n;if("verbose"==this.log_mode&&this.log(n),this.Params.adaptive&&this.state.last_price){let e=s-this.state.last_price,t=e=>Math.max(Math.min(1,e),0);this.state.r=t(this.state.r-this.Params.alpha*e),this.Params.target_ratio=this.state.r}if(this.state.last_price=s,this.state.price_history.push(s),u)return"verbose"==this.log_mode&&this.log("Target ratio already achieved. Returning"),{balanced:!1,balance_needed:!1,info:null};{"verbose"==this.log_mode&&(this.log("Target ratio NOT achieved. Continuing."),this.log(`Processing order to ${d} ${f} ${e}`));let t=await this.do_market_trade(d,f),{error:n,info:r}=t;return{balanced:!n,balance_needed:!0,info:r}}}async get_balance_data(){let{target_ratio:e,target_precision:t,quote_asset:n,base_asset:r}=this.Params,i=await this.get_base_balance(r),s=await this.get_quote_balance(n),a=await this.get_base_price(r,n),o=i*a+s,c=i*a/o,u=e-c,l=o*e/a,h=l-i,d={base_amt:i,quote_amt:s,base_price:a,portfolio_value:o,current_ratio:c,ratio_error:u,target_achieved:Math.abs(u)<t,target_ratio:e,target_precision:t,target_base_amt:l,base_delta:h,trade_type:h>=0?th.BUY:th.SELL,base_market_amt:Math.abs(h)};return this.last_balance_data=d,d}set_log_mode(e){"verbose"==this.log_mode&&(this.log(`Setting log mode to ${e}`),this.log_mode=e)}}class rh extends nh{constructor(e){super(e),this.data=e.data,this.current_index=-1,this.portfolio=Object.assign({},e.initial_portfolio),this.initial_portfolio=Object.assign({},e.initial_portfolio),this.rebalances=[],this.slippage=e.slippage,this.fee=e.fee,this.transactions_costs={fees:{base:0,quote:0},slippage:{base:0,quote:0}},this.balance_portfolio_series=[],this.hodl_portfolio_series=[],this.ratio_series=[]}async get_quote_balance(e){return this.portfolio.quote_balance}async get_base_balance(e){return this.portfolio.base_balance}async get_base_price(e,t){return this.data[this.current_index].p}async do_market_trade(e,t){let n=await this.get_base_price("",""),r=this.data[this.current_index];n!=r.p&&(this.log("Sanity check failed! - there is a problem with price indexing"),process.exit(1));let{p:i,t:s}=r;var a,o;switch(e){case th.BUY:a=t*(1-this.fee),o=-t*i*(1+this.slippage),this.transactions_costs.fees.base+=t*this.fee,this.transactions_costs.slippage.quote+=t*i*this.slippage;break;case th.SELL:a=-t,o=t*i*(1-this.fee)*(1-this.slippage),this.transactions_costs.fees.quote+=t*i*this.fee,this.transactions_costs.slippage.quote+=t*i*this.slippage}let c=this.portfolio.base_balance+=a,u=this.portfolio.quote_balance+=o;return this.portfolio={base_balance:c,quote_balance:u},this.rebalances.push({index:this.current_index,p:i,t:s,trade_type:e,base_amt:t,quote_amt:t*i,portfolio:this.get_portfolio_value_and_time(this.portfolio,i,s),hodl_portfolio:this.get_portfolio_value_and_time(this.initial_portfolio,i,s),cummulative_transactions_costs:{raw:Object.assign({},this.transactions_costs),values:this.get_transactions_costs_values(this.transactions_costs,i)}}),{error:!1,info:null}}symbol_generator(e,t){return"BACKTESTER"}async process_data(){this.current_index+=1,await this.balance_portfolio();let{p:e,t}=this.data[this.current_index];this.hodl_portfolio_series.push(this.get_portfolio_value_and_time(this.initial_portfolio,e,t)),this.balance_portfolio_series.push(this.get_portfolio_value_and_time(this.portfolio,e,t)),this.ratio_series.push(this.Params.target_ratio)}get_portfolio_value_and_time(e,t,n){let r=e.base_balance*t+e.quote_balance;return{base_balance:e.base_balance,quote_balance:e.quote_balance,value:r,p:t,t:n}}get_transactions_costs_values(e,t){let{fees:n,slippage:r}=e,i=n.base*t+n.quote,s=r.base*t+r.quote;return{fee_cost:i,slippage_cost:s,total:i+s}}async backtest(){this.log("Starting backtest...");let e=this.data.length;for(var t=0;t<e;t++)await this.process_data(),t%100==0&&this.log(`Progress = ${t}/${e}`);this.log("Done")}}function ih(e){return e.length}function sh(e){let t=0;for(var n=0;n<e.length;n++)t+=window.Math.pow(e[n],2);return Math.pow(t,.5)}function ah(e){let t=0;for(var n=0;n<e.length;n++)t+=e[n];return t}function oh(e){let t=[];for(var n=0;n<e.length;n++)t[n]=Math.abs(e[n]);return t}function ch(e){return ah(e)/ih(e)}function uh(e){return ch(oh(e))}function lh(e){return{max:Math.max.apply(null,e),min:Math.min.apply(null,e),mean:ch(e)}}function hh(e){const t=e.reduce(((e,t)=>e+t.length),0),n=new Float32Array(t);let r=0;return e.forEach((e=>{n.set(e,r),r+=e.length})),n}function dh(){return performance.now()}var fh=st({id:"debug"}),ph={};function mh(e,t){ph[e]=t,fh(`Added :${e}`)}function gh(e){return ph[e]}function yh(e){let t=new ArrayBuffer(8);return new DataView(t).setBigUint64(0,BigInt(e),!1),new Uint8Array(t)}function vh(e){let t=yh(Date.now()),n=new Uint8Array(t.length+e.length);return n.set(t),n.set(e,t.length),n}function _h(){return"undefined"!=typeof window&&void 0!==window.document}function wh(){return"undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node}function bh(){return Number(new Date)}function Eh(e){try{return JSON.parse(e),!0}catch(e){return!1}}let kh=()=>performance.now();var Sh,Th;function Ih(e,t,n){var r=kh();return n=n||200,new Promise(((i,s)=>{let a=setInterval((function(){let n=kh();e()?(i(!1),clearInterval(a)):t&&n-r>=t&&(i(!0),clearInterval(a))}),n)}))}function Oh(e){return new Promise(((t,n)=>{setTimeout((function(){t(Sh.TIMEOUT)}),e)}))}function Ah(e){mh("pre_clean",e);let t=e.split("\n").join("").replace(/  /g,"").replace(",}","}"),n=t.indexOf("{"),r=t.indexOf("[");var i;return i=n<0?r:r<0?n:Math.min(n,r),t=t.slice(i,t.length),fh(`extracting json starting at index ${i}=${t[i]}`),mh("post_clean",t),fh(`Cleaned ${e} to \n\n\n ${t}`),t}async function xh(e,t){try{var n;n=_h()?`${window.origin}/api/openai_davinci`:"https://www.tidyscripts.com/api/openai_davinci";let i=await px(n,{prompt:e,max_tokens:t});mh("api_response",i),fh("Logged the api repsonse"),fh("Cleaning json string");var r=Ah(i.text);return fh(`Got cleaned response: ${r}`),{error:!1,data:JSON.parse(r)}}catch(e){return mh("api_error",e),fh("api_error experienced"),{error:!0,data:"api error"}}}(Th=Sh||(Sh={}))[Th.TIMEOUT=0]="TIMEOUT";const Ph={demographics:{age:35,gender:"Male",ethnicity:"Caucasian",occupation:"Software Engineer"},symptoms:["Fever","Cough","Fatigue"],lab_values:[{lab:"Magnesium",value:1.5},{lab:"Calcium",value:9.2},{lab:"Potassium",value:4},{lab:"Sodium",value:138}],medical_history:["Asthma","Seasonal Allergies"],medications:[{medication:"Albuterol",dose:{value:"2 puffs",frequency:"as needed"}},{medication:"Fluticasone",dose:{value:"1 spray",frequency:"daily"}}],tests:[{test:"Chest X-ray",result:"Negative"}],physical_exam:["Mild wheezing on auscultation"]};function Ch(e){const{demographics:t,symptoms:n,lab_values:r,medical_history:i,medications:s,tests:a,physical_exam:o}=e;return`\n    Given the following patient information:\n    Demographics: ${JSON.stringify(t)}\n    Symptoms: ${JSON.stringify(n)}\n    Lab values: ${JSON.stringify(r)}\n    Medical history: ${JSON.stringify(i)}\n    Medications: ${JSON.stringify(s)}\n    Tests: ${JSON.stringify(a)}\n    Physical exam: ${JSON.stringify(o)}\n\n    Please generate a list of the most likely diagnoses, along with their likelihood and any potential further workup needed to confirm or exclude each diagnosis.\nThe returned value should be a stringified JSON object that is an Array of objects that each have  "diagnosis", "likelihood", "reasoning",  and "suggested_workup" fields. \n    The suggested_workup field should be an array of strings where each string is a single suggested workup, such as "echocardiogram" or "chest x-ray" or "Basic metabolic panel (BMP)".\n    The likelihood field should be a number from 0 to 1 that estimates the probability that this is the diagnosis.\nThe reasoning field provides reasoning for ONLY the diagnosis and NOT for the suggested workup. It should be a string of atleast 5 sentences that directly references the provided information and specific numbers that went into your decision making process, and the logic behind the decision. If you conclude a lab value is high or low please provide a reference range in your explanation.\n    The returned array should have atleast 10 elements that are ranked with the highest likelihood first. \n  `}async function Nh(e){let t=Ch(e);return await xh(t,2048)}async function Rh(e){try{const t=`Given the medical one-liner "${e.one_liner}" and History and Physical "${e.hp}", generate a patient_data object which conforms\nto the following PatientData type definition in typescript:\n\ntype PatientData = {\n  demographics: {\n    age: number,\n    gender?: string,\n    ethnicity?: string,\n    occupation?: string\n  },\n  symptoms: string[],\n  lab_values: {\n    lab : string ,\n    value : any \n  }[],\n  medical_history: string[],\n  medications: {\n    medication : string,\n    dose : { value : string, frequency : string } \n  }[],\n  tests: {\n    test: string,\n    result: string\n  }[],\n  physical_exam: string[]\n}\n\nThe repsonse should be a json string. \nOnly include the optional fields in the response if that information is explicity present in the one_liner or hp\nDo not include any text in the response other than the json string itself \n\n\nEXAMPLE RESPONSE: \n\n{\n  "demographics": {\n    "age": 30,\n    "gender": "Female",\n    "occupation": "Software Engineer"\n  },\n  "symptoms": ["Fever", "Cough", "Fatigue"],\n  "lab_values": [\n    {\n      "lab": "Magnesium",\n      "value": 1.5\n    },\n    {\n      "lab": "Calcium",\n      "value": 9.2\n    },\n    {\n      "lab": "Potassium",\n      "value": 4.0\n    },\n    {\n      "lab": "Sodium",\n      "value": 138\n    }\n  ],\n  "medical_history": ["Asthma", "Seasonal Allergies"],\n  "medications": [\n    {\n      "medication": "Albuterol",\n      "dose": {\n        "value": "2 puffs",\n        "frequency": "as needed"\n      }\n    },\n    {\n      "medication": "Fluticasone",\n      "dose": {\n        "value": "1 spray",\n        "frequency": "daily"\n      }\n    }\n  ],\n  "tests": [\n    {\n      "test": "Chest X-ray",\n      "result": "Negative"\n    }\n  ],\n  "physical_exam": ["Mild wheezing on auscultation"]\n}\n`;return(await xh(t,2048)).data}catch(e){return fh("An error occurred"),mh("generate_error",e),null}}var jh="1111";const Lh=st({id:"medications"});var Dh=[],Mh=[],$h=null;async function Uh(){return await Fh(),Mh}async function Fh(){Mh.length&&$h||(Lh("Downloading medications"),Dh=await px("https://storage.googleapis.com/tidyscripts/medication_data.json",{}),Lh("Parsing medications"),(Mh=Kt(Dh)).map((function(e){try{e.adverse_reactions=Wh(e.adverse_reactions),e.name=e.name.replace("-drug-information","")}catch(t){Lh("error parsing med:"),console.log(e),process.exit()}})),Lh("Building index"),$h=qh(Mh),Lh("Done"))}function Bh(e){return Mh.filter((function(t){return t.name.match(e)}))}function Vh(e){let t=R.keys($h).filter((t=>t.match(e)));return Object.fromEntries(t.map((e=>[e,$h[e]])))}function zh(e,t){if(!e.adverse_reactions)return t;let n=It(e.adverse_reactions);for(var r of n){let{value:n,path:s}=r,a=s[0];for(var i of n)t[i]||(t[i]={}),t[i][a]||(t[i][a]=[]),t[i][a].push(e.name)}return t}function qh(e){let t={};for(var n of e)t=zh(n,t);return t}function Hh(e){let t=e.split("\n\n").filter((e=>e.length>1));var n={};return t.map((function(e){let t=e.split(":"),r=t[0].trim(),i=t.slice(1).join("").replace(/\([\s\S]*?\)/g,"").split(",").map((e=>e.toLowerCase().trim()));n[r]=i})),n}function Kh(e){return e.replace(/\([\s\S]*?\)/g,"").split(",").map((e=>e.toLowerCase().trim()))}function Wh(e){if(!e)return null;let t=new RegExp([">10%:","1% to 10%:","2% to 10%:","Frequency not defined:","Frequency not defined.\n\n","<1%, postmarketing, and/or case reports:","<2%, postmarketing, and/or case reports:","<2%:","<1%:","Postmarketing:","Postmarketing and/or case reports:","Case Reports:"].join("|"),"g"),n=e.match(t);if(!n)return null;let r=e.split(t);var i={};return ct((function(e,t){try{let n=r[e+1];"<1%, postmarketing, and/or case reports:"==t.trim()||"<2%, postmarketing, and/or case reports:"==t.trim()?i[t]=Kh(n):i[t]=Hh(n)}catch(e){i[t]=!1}}),n),i}const Gh="RFC3986",Zh={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)},Jh=(Object.prototype.hasOwnProperty,Array.isArray),Qh=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),Xh=1024;function Yh(e,t){if(Jh(e)){const n=[];for(let r=0;r<e.length;r+=1)n.push(t(e[r]));return n}return t(e)}const ed=Object.prototype.hasOwnProperty,td={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},nd=Array.isArray,rd=Array.prototype.push,id=function(e,t){rd.apply(e,nd(t)?t:[t])},sd=Date.prototype.toISOString,ad={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,n,r,i)=>{if(0===e.length)return e;let s=e;if("symbol"==typeof e?s=Symbol.prototype.toString.call(e):"string"!=typeof e&&(s=String(e)),"iso-8859-1"===n)return escape(s).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));let a="";for(let e=0;e<s.length;e+=Xh){const t=s.length>=Xh?s.slice(e,e+Xh):s,n=[];for(let e=0;e<t.length;++e){let r=t.charCodeAt(e);45===r||46===r||95===r||126===r||r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||"RFC1738"===i&&(40===r||41===r)?n[n.length]=t.charAt(e):r<128?n[n.length]=Qh[r]:r<2048?n[n.length]=Qh[192|r>>6]+Qh[128|63&r]:r<55296||r>=57344?n[n.length]=Qh[224|r>>12]+Qh[128|r>>6&63]+Qh[128|63&r]:(e+=1,r=65536+((1023&r)<<10|1023&t.charCodeAt(e)),n[n.length]=Qh[240|r>>18]+Qh[128|r>>12&63]+Qh[128|r>>6&63]+Qh[128|63&r])}a+=n.join("")}return a},encodeValuesOnly:!1,format:Gh,formatter:Zh[Gh],indices:!1,serializeDate:e=>sd.call(e),skipNulls:!1,strictNullHandling:!1},od={};function cd(e,t,n,r,i,s,a,o,c,u,l,h,d,f,p,m,g,y){let v=e,_=y,w=0,b=!1;for(;void 0!==(_=_.get(od))&&!b;){const t=_.get(e);if(w+=1,void 0!==t){if(t===w)throw new RangeError("Cyclic object value");b=!0}void 0===_.get(od)&&(w=0)}if("function"==typeof u?v=u(t,v):v instanceof Date?v=d?.(v):"comma"===n&&nd(v)&&(v=Yh(v,(function(e){return e instanceof Date?d?.(e):e}))),null===v){if(s)return c&&!m?c(t,ad.encoder,g,"key",f):t;v=""}if("string"==typeof(E=v)||"number"==typeof E||"boolean"==typeof E||"symbol"==typeof E||"bigint"==typeof E||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(v)){if(c){const e=m?t:c(t,ad.encoder,g,"key",f);return[p?.(e)+"="+p?.(c(v,ad.encoder,g,"value",f))]}return[p?.(t)+"="+p?.(String(v))]}var E;const k=[];if(void 0===v)return k;let S;if("comma"===n&&nd(v))m&&c&&(v=Yh(v,c)),S=[{value:v.length>0?v.join(",")||null:void 0}];else if(nd(u))S=u;else{const e=Object.keys(v);S=l?e.sort(l):e}const T=o?String(t).replace(/\./g,"%2E"):String(t),I=r&&nd(v)&&1===v.length?T+"[]":T;if(i&&nd(v)&&0===v.length)return I+"[]";for(let t=0;t<S.length;++t){const _=S[t],b="object"==typeof _&&void 0!==_.value?_.value:v[_];if(a&&null===b)continue;const E=h&&o?_.replace(/\./g,"%2E"):_,T=nd(v)?"function"==typeof n?n(I,E):I:I+(h?"."+E:"["+E+"]");y.set(e,w);const O=new WeakMap;O.set(od,y),id(k,cd(b,T,n,r,i,s,a,o,"comma"===n&&m&&nd(v)?null:c,u,l,h,d,f,p,m,g,O))}return k}const ud="4.72.0";let ld,hd,dd,fd,pd,md,gd,yd,vd,_d=!1,wd=null,bd=null,Ed=null,kd=null;class Sd{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}ld||function(e,t={auto:!1}){if(_d)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(ld)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${ld}'\``);_d=t.auto,ld=e.kind,hd=e.fetch,wd=e.Request,bd=e.Response,Ed=e.Headers,dd=e.FormData,kd=e.Blob,fd=e.File,pd=e.ReadableStream,md=e.getMultipartRequestOptions,gd=e.getDefaultAgent,yd=e.fileFromPath,vd=e.isFsReadStream}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import … from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,r,i,s;try{n=fetch,r=Request,i=Response,s=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:r,Response:i,Headers:s,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new Sd(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0});class Td extends Error{}class Id extends Td{constructor(e,t,n,r){super(`${Id.makeMessage(e,t,n)}`),this.status=e,this.headers=r,this.request_id=r?.["x-request-id"];const i=t;this.error=i,this.code=i?.code,this.param=i?.param,this.type=i?.type}static makeMessage(e,t,n){const r=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,n,r){if(!e)return new Ad({message:n,cause:bf(t)});const i=t?.error;return 400===e?new Pd(e,i,n,r):401===e?new Cd(e,i,n,r):403===e?new Nd(e,i,n,r):404===e?new Rd(e,i,n,r):409===e?new jd(e,i,n,r):422===e?new Ld(e,i,n,r):429===e?new Dd(e,i,n,r):e>=500?new Md(e,i,n,r):new Id(e,i,n,r)}}class Od extends Id{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}}class Ad extends Id{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}}class xd extends Ad{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Pd extends Id{constructor(){super(...arguments),this.status=400}}class Cd extends Id{constructor(){super(...arguments),this.status=401}}class Nd extends Id{constructor(){super(...arguments),this.status=403}}class Rd extends Id{constructor(){super(...arguments),this.status=404}}class jd extends Id{constructor(){super(...arguments),this.status=409}}class Ld extends Id{constructor(){super(...arguments),this.status=422}}class Dd extends Id{constructor(){super(...arguments),this.status=429}}class Md extends Id{}class $d extends Td{constructor(){super("Could not parse response content as the length limit was reached")}}class Ud extends Td{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class Fd{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const n=Fd.NEWLINE_CHARS.has(t[t.length-1]||"");let r=t.split(Fd.NEWLINE_REGEXP);return n&&r.pop(),1!==r.length||n?(this.buffer.length>0&&(r=[this.buffer.join("")+r[0],...r.slice(1)],this.buffer=[]),n||(this.buffer=[r.pop()||""]),r):(this.buffer.push(r[0]),[])}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new Td(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new Td(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new Td("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}Fd.NEWLINE_CHARS=new Set(["\n","\r"]),Fd.NEWLINE_REGEXP=/\r\n|[\n\r]/g;class Bd{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;return new Bd((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const n of async function*(e,t){if(!e.body)throw t.abort(),new Td("Attempted to iterate over a response with no body");const n=new zd,r=new Fd,i=qd(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let r,i=new Uint8Array(t.length+e.length);for(i.set(t),i.set(e,t.length),t=i;-1!==(r=Vd(t));)yield t.slice(0,r),t=t.slice(r)}t.length>0&&(yield t)}(i))for(const t of r.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of r.flush()){const t=n.decode(e);t&&(yield t)}}(e,t))if(!r)if(n.data.startsWith("[DONE]"))r=!0;else if(null===n.event){let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if(e&&e.error)throw new Id(void 0,e.error,void 0,void 0);yield e}else{let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("error"==n.event)throw new Id(void 0,e.error,e.message,void 0);yield{event:n.event,data:e}}r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}static fromReadableStream(e,t){let n=!1;return new Bd((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const t of async function*(){const t=new Fd,n=qd(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())r||t&&(yield JSON.parse(t));r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),r=r=>({next:()=>{if(0===r.length){const r=n.next();e.push(r),t.push(r)}return r.shift()}});return[new Bd((()=>r(e)),this.controller),new Bd((()=>r(t)),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new pd({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:r,done:i}=await t.next();if(i)return e.close();const s=n.encode(JSON.stringify(r)+"\n");e.enqueue(s)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}function Vd(e){for(let t=0;t<e.length-2;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}class zd{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=function(e,t){const n=e.indexOf(":");return-1!==n?[e.substring(0,n),":",e.substring(n+1)]:[e,"",""]}(e);return r.startsWith(" ")&&(r=r.substring(1)),"event"===t?this.event=r:"data"===t&&this.data.push(r),null}}function qd(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const Hd=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,Kd=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&Wd(e),Wd=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function Gd(e,t,n){if(e=await e,Kd(e))return e;if(Hd(e)){const r=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=Wd(r)?[await r.arrayBuffer()]:[r];return new fd(i,t,n)}const r=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(Wd(e))t.push(await e.arrayBuffer());else{if(!Jd(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){return`[${Object.getOwnPropertyNames(e).map((e=>`"${e}"`)).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return Zd(e.name)||Zd(e.filename)||Zd(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n?.type){const e=r[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new fd(r,t,n)}const Zd=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,Jd=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],Qd=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],Xd=async e=>{const t=await Yd(e.body);return md(t,e)},Yd=async e=>{const t=new dd;return await Promise.all(Object.entries(e||{}).map((([e,n])=>ef(t,e,n)))),t},ef=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if((e=>Kd(e)||Hd(e)||vd(e))(n)){const r=await Gd(n);e.append(t,r)}else if(Array.isArray(n))await Promise.all(n.map((n=>ef(e,t+"[]",n))));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map((([n,r])=>ef(e,`${t}[${n}]`,r))))}}};var tf;async function nf(e){const{response:t}=e;if(e.options.stream)return If("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):Bd.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type");if(n?.includes("application/json")||n?.includes("application/vnd.api+json")){const e=await t.json();return If("response",t.status,t.url,t.headers,e),rf(e,t)}const r=await t.text();return If("response",t.status,t.url,t.headers,r),r}function rf(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}class sf extends Promise{constructor(e,t=nf){super((e=>{e(null)})),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new sf(this.responsePromise,(async t=>rf(e(await this.parseResponse(t),t),t.response)))}asResponse(){return this.responsePromise.then((e=>e.response))}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class af{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:r,fetch:i}){this.baseURL=e,this.maxRetries=wf("maxRetries",t),this.timeout=wf("timeout",n),this.httpAgent=r,this.fetch=i??hd}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...mf(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Of()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then((async n=>{const r=n&&Wd(n?.body)?new DataView(await n.body.arrayBuffer()):n?.body instanceof DataView?n.body:n?.body instanceof ArrayBuffer?new DataView(n.body):n&&ArrayBuffer.isView(n?.body)?new DataView(n.body.buffer):n?.body;return{method:e,path:t,...n,body:r}})))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const{method:n,path:r,query:i,headers:s={}}=e,a=ArrayBuffer.isView(e.body)||e.__binaryRequest&&"string"==typeof e.body?e.body:Qd(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(a),c=this.buildURL(r,i);"timeout"in e&&wf("timeout",e.timeout);const u=e.timeout??this.timeout,l=e.httpAgent??this.httpAgent??gd(c),h=u+1e3;return"number"==typeof l?.options?.timeout&&h>(l.options.timeout??0)&&(l.options.timeout=h),this.idempotencyHeader&&"get"!==n&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey),{req:{method:n,...a&&{body:a},headers:this.buildHeaders({options:e,headers:s,contentLength:o,retryCount:t}),...l&&{agent:l},signal:e.signal??null},url:c,timeout:u}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:r}){const i={};n&&(i["content-length"]=n);const s=this.defaultHeaders(e);return Tf(i,s),Tf(i,t),Qd(e.body)&&"node"!==ld&&delete i["content-type"],void 0===Af(s,"x-stainless-retry-count")&&void 0===Af(t,"x-stainless-retry-count")&&(i["x-stainless-retry-count"]=String(r)),this.validateHeaders(i,t),i}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map((e=>[...e]))):{...e}:{}}makeStatusError(e,t,n,r){return Id.generate(e,t,n,r)}request(e,t=null){return new sf(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e,r=n.maxRetries??this.maxRetries;null==t&&(t=r),await this.prepareOptions(n);const{req:i,url:s,timeout:a}=this.buildRequest(n,{retryCount:r-t});if(await this.prepareRequest(i,{url:s,options:n}),If("request",s,n,i.headers),n.signal?.aborted)throw new Od;const o=new AbortController,c=await this.fetchWithTimeout(s,i,a,o).catch(bf);if(c instanceof Error){if(n.signal?.aborted)throw new Od;if(t)return this.retryRequest(n,t);if("AbortError"===c.name)throw new xd;throw new Ad({cause:c})}const u=uf(c.headers);if(!c.ok){if(t&&this.shouldRetry(c))return If(`response (error; retrying, ${t} attempts remaining)`,c.status,s,u),this.retryRequest(n,t,u);const e=await c.text().catch((e=>bf(e).message)),r=gf(e),i=r?void 0:e;throw If(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,s,u,i),this.makeStatusError(c.status,r,i,u)}return{response:c,options:n,controller:o}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new cf(this,n,e)}buildURL(e,t){const n=vf(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return kf(r)||(t={...r,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter((([e,t])=>void 0!==t)).map((([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new Td(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)})).join("&")}async fetchWithTimeout(e,t,n,r){const{signal:i,...s}=t||{};i&&i.addEventListener("abort",(()=>r.abort()));const a=setTimeout((()=>r.abort()),n);return this.getRequestClient().fetch.call(void 0,e,{signal:r.signal,...s}).finally((()=>{clearTimeout(a)}))}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,n){let r;const i=n?.["retry-after-ms"];if(i){const e=parseFloat(i);Number.isNaN(e)||(r=e)}const s=n?.["retry-after"];if(s&&!r){const e=parseFloat(s);r=Number.isNaN(e)?Date.parse(s)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const n=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,n)}return await _f(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${ud}`}}class of{constructor(e,t,n,r){tf.set(this,void 0),function(e,t,n,r,i){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");t.set(e,n)}(this,tf,e),this.options=r,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new Td("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,r]of n)e.url.searchParams.set(t,r);t.query=void 0,t.path=e.url.toString()}return await function(e,t,n,r){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t.get(e)}(this,tf).requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(tf=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class cf extends sf{constructor(e,t,n){super(t,(async t=>new n(e,t.response,await nf(t),t.options)))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}const uf=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),lf={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},hf=e=>"object"==typeof e&&null!==e&&!kf(e)&&Object.keys(e).every((e=>Sf(lf,e))),df=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",ff=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let pf;const mf=()=>pf??(pf=(()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ud,"X-Stainless-OS":ff(Deno.build.os),"X-Stainless-Arch":df(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ud,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ud,"X-Stainless-OS":ff(process.platform),"X-Stainless-Arch":df(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ud,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ud,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),gf=e=>{try{return JSON.parse(e)}catch(e){return}},yf=new RegExp("^(?:[a-z]+:)?//","i"),vf=e=>yf.test(e),_f=e=>new Promise((t=>setTimeout(t,e))),wf=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new Td(`${e} must be an integer`);if(t<0)throw new Td(`${e} must be a positive integer`);return t},bf=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return new Error(JSON.stringify(e))}catch{}return new Error(e)},Ef=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function kf(e){if(!e)return!0;for(const t in e)return!1;return!0}function Sf(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function Tf(e,t){for(const n in t){if(!Sf(t,n))continue;const r=n.toLowerCase();if(!r)continue;const i=t[n];null===i?delete e[r]:void 0!==i&&(e[r]=i)}}function If(e,...t){"undefined"!=typeof process&&"true"===process?.env?.DEBUG&&console.log(`OpenAI:DEBUG:${e}`,...t)}const Of=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),Af=(e,t)=>{const n=t.toLowerCase();if((e=>"function"==typeof e?.get)(e)){const r=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,((e,t,n)=>t+n.toUpperCase()));for(const i of[t,n,t.toUpperCase(),r]){const t=e.get(i);if(t)return t}}for(const[r,i]of Object.entries(e))if(r.toLowerCase()===n)return Array.isArray(i)?(i.length<=1||console.warn(`Received ${i.length} entries for the ${t} header, using the first entry.`),i[0]):i};function xf(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class Pf{constructor(e){this._client=e}}class Cf extends Pf{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class Nf extends Pf{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}}class Rf extends Pf{constructor(){super(...arguments),this.completions=new Nf(this._client)}}Rf.Completions=Nf;class jf extends Pf{create(e,t){return this._client.post("/embeddings",{body:e,...t})}}class Lf extends of{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class Df extends of{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class Mf extends Pf{create(e,t){return this._client.post("/files",Xd({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return hf(e)?this.list({},e):this._client.getAPIList("/files",$f,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t?.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const r=new Set(["processed","error","deleted"]),i=Date.now();let s=await this.retrieve(e);for(;!s.status||!r.has(s.status);)if(await _f(t),s=await this.retrieve(e),Date.now()-i>n)throw new xd({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return s}}class $f extends Df{}Mf.FileObjectsPage=$f;class Uf extends Pf{createVariation(e,t){return this._client.post("/images/variations",Xd({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",Xd({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class Ff extends Pf{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}}class Bf extends Pf{create(e,t){return this._client.post("/audio/transcriptions",Xd({body:e,...t}))}}class Vf extends Pf{create(e,t){return this._client.post("/audio/translations",Xd({body:e,...t}))}}class zf extends Pf{constructor(){super(...arguments),this.transcriptions=new Bf(this._client),this.translations=new Vf(this._client),this.speech=new Ff(this._client)}}zf.Transcriptions=Bf,zf.Translations=Vf,zf.Speech=Ff;class qf extends Pf{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class Hf extends Pf{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Kf,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Kf extends Lf{}Hf.ModelsPage=Kf;class Wf extends Pf{list(e,t={},n){return hf(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Gf,{query:t,...n})}}class Gf extends Df{}Wf.FineTuningJobCheckpointsPage=Gf;class Zf extends Pf{constructor(){super(...arguments),this.checkpoints=new Wf(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return hf(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Jf,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return hf(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Qf,{query:t,...n})}}class Jf extends Df{}class Qf extends Df{}Zf.FineTuningJobsPage=Jf,Zf.FineTuningJobEventsPage=Qf,Zf.Checkpoints=Wf,Zf.FineTuningJobCheckpointsPage=Gf;class Xf extends Pf{constructor(){super(...arguments),this.jobs=new Zf(this._client)}}Xf.Jobs=Zf,Xf.FineTuningJobsPage=Jf,Xf.FineTuningJobEventsPage=Qf;class Yf extends Pf{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return hf(e)?this.list({},e):this._client.getAPIList("/assistants",ep,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class ep extends Df{}function tp(e){return"function"==typeof e.parse}Yf.AssistantsPage=ep;const np=e=>"assistant"===e?.role,rp=e=>"function"===e?.role,ip=e=>"tool"===e?.role;var sp,ap,op,cp,up,lp,hp,dp,fp,pp,mp,gp,yp,vp=function(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n},_p=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class wp{constructor(){sp.add(this),this.controller=new AbortController,ap.set(this,void 0),op.set(this,(()=>{})),cp.set(this,(()=>{})),up.set(this,void 0),lp.set(this,(()=>{})),hp.set(this,(()=>{})),dp.set(this,{}),fp.set(this,!1),pp.set(this,!1),mp.set(this,!1),gp.set(this,!1),vp(this,ap,new Promise(((e,t)=>{vp(this,op,e,"f"),vp(this,cp,t,"f")})),"f"),vp(this,up,new Promise(((e,t)=>{vp(this,lp,e,"f"),vp(this,hp,t,"f")})),"f"),_p(this,ap,"f").catch((()=>{})),_p(this,up,"f").catch((()=>{}))}_run(e){setTimeout((()=>{e().then((()=>{this._emitFinal(),this._emit("end")}),_p(this,sp,"m",yp).bind(this))}),0)}_connected(){this.ended||(_p(this,op,"f").call(this),this._emit("connect"))}get ended(){return _p(this,fp,"f")}get errored(){return _p(this,pp,"f")}get aborted(){return _p(this,mp,"f")}abort(){this.controller.abort()}on(e,t){return(_p(this,dp,"f")[e]||(_p(this,dp,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=_p(this,dp,"f")[e];if(!n)return this;const r=n.findIndex((e=>e.listener===t));return r>=0&&n.splice(r,1),this}once(e,t){return(_p(this,dp,"f")[e]||(_p(this,dp,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{vp(this,gp,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){vp(this,gp,!0,"f"),await _p(this,up,"f")}_emit(e,...t){if(_p(this,fp,"f"))return;"end"===e&&(vp(this,fp,!0,"f"),_p(this,lp,"f").call(this));const n=_p(this,dp,"f")[e];if(n&&(_p(this,dp,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return _p(this,gp,"f")||n?.length||Promise.reject(e),_p(this,cp,"f").call(this,e),_p(this,hp,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];_p(this,gp,"f")||n?.length||Promise.reject(e),_p(this,cp,"f").call(this,e),_p(this,hp,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function bp(e){return"auto-parseable-response-format"===e?.$brand}function Ep(e){return"auto-parseable-tool"===e?.$brand}function kp(e,t){const n=e.choices.map((e=>{if("length"===e.finish_reason)throw new $d;if("content_filter"===e.finish_reason)throw new Ud;return{...e,message:{...e.message,tool_calls:e.message.tool_calls?.map((e=>function(e,t){const n=e.tools?.find((e=>e.function?.name===t.function.name));return{...t,function:{...t.function,parsed_arguments:Ep(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e)))??[],parsed:e.message.content&&!e.message.refusal?Sp(t,e.message.content):null}}}));return{...e,choices:n}}function Sp(e,t){return"json_schema"!==e.response_format?.type?null:"json_schema"===e.response_format?.type?"$parseRaw"in e.response_format?e.response_format.$parseRaw(t):JSON.parse(t):null}function Tp(e,t){if(!e)return!1;const n=e.tools?.find((e=>e.function?.name===t.function.name));return Ep(n)||n?.function.strict||!1}function Ip(e){return!!bp(e.response_format)||(e.tools?.some((e=>Ep(e)||"function"===e.type&&!0===e.function.strict))??!1)}ap=new WeakMap,op=new WeakMap,cp=new WeakMap,up=new WeakMap,lp=new WeakMap,hp=new WeakMap,dp=new WeakMap,fp=new WeakMap,pp=new WeakMap,mp=new WeakMap,gp=new WeakMap,sp=new WeakSet,yp=function(e){if(vp(this,pp,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new Od),e instanceof Od)return vp(this,mp,!0,"f"),this._emit("abort",e);if(e instanceof Td)return this._emit("error",e);if(e instanceof Error){const t=new Td(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Td(String(e)))};var Op,Ap,xp,Pp,Cp,Np,Rp,jp,Lp=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};const Dp=10;class Mp extends wp{constructor(){super(...arguments),Op.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(rp(e)||ip(e))&&e.content)this._emit("functionCallResult",e.content);else if(np(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(np(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new Td("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Lp(this,Op,"m",Ap).call(this)}async finalMessage(){return await this.done(),Lp(this,Op,"m",xp).call(this)}async finalFunctionCall(){return await this.done(),Lp(this,Op,"m",Pp).call(this)}async finalFunctionCallResult(){return await this.done(),Lp(this,Op,"m",Cp).call(this)}async totalUsage(){return await this.done(),Lp(this,Op,"m",Np).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=Lp(this,Op,"m",xp).call(this);t&&this._emit("finalMessage",t);const n=Lp(this,Op,"m",Ap).call(this);n&&this._emit("finalContent",n);const r=Lp(this,Op,"m",Pp).call(this);r&&this._emit("finalFunctionCall",r);const i=Lp(this,Op,"m",Cp).call(this);null!=i&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some((e=>e.usage))&&this._emit("totalUsage",Lp(this,Op,"m",Np).call(this))}async _createChatCompletion(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),Lp(this,Op,"m",Rp).call(this,t);const i=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(kp(i,t))}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){const r="function",{function_call:i="auto",stream:s,...a}=t,o="string"!=typeof i&&i?.name,{maxChatCompletions:c=Dp}=n||{},u={};for(const e of t.functions)u[e.name||e.function.name]=e;const l=t.functions.map((e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description})));for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...a,function_call:i,functions:l,messages:[...this.messages]},n),s=t.choices[0]?.message;if(!s)throw new Td("missing message in ChatCompletion response");if(!s.function_call)return;const{name:c,arguments:h}=s.function_call,d=u[c];if(!d){const e=`Invalid function_call: ${JSON.stringify(c)}. Available options are: ${l.map((e=>JSON.stringify(e.name))).join(", ")}. Please try again`;this._addMessage({role:r,name:c,content:e});continue}if(o&&o!==c){const e=`Invalid function_call: ${JSON.stringify(c)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,name:c,content:e});continue}let f;try{f=tp(d)?await d.parse(h):h}catch(e){this._addMessage({role:r,name:c,content:e instanceof Error?e.message:String(e)});continue}const p=await d.function(f,this),m=Lp(this,Op,"m",jp).call(this,p);if(this._addMessage({role:r,name:c,content:m}),o)return}}async _runTools(e,t,n){const r="tool",{tool_choice:i="auto",stream:s,...a}=t,o="string"!=typeof i&&i?.function?.name,{maxChatCompletions:c=Dp}=n||{},u=t.tools.map((e=>{if(Ep(e)){if(!e.$callback)throw new Td("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e})),l={};for(const e of u)"function"===e.type&&(l[e.function.name||e.function.function.name]=e.function);const h="tools"in t?u.map((e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e)):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...a,tool_choice:i,tools:h,messages:[...this.messages]},n),s=t.choices[0]?.message;if(!s)throw new Td("missing message in ChatCompletion response");if(!s.tool_calls?.length)return;for(const t of s.tool_calls){if("function"!==t.type)continue;const n=t.id,{name:i,arguments:s}=t.function,a=l[i];if(!a){const e=`Invalid tool_call: ${JSON.stringify(i)}. Available options are: ${Object.keys(l).map((e=>JSON.stringify(e))).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:n,content:e});continue}if(o&&o!==i){const e=`Invalid tool_call: ${JSON.stringify(i)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,tool_call_id:n,content:e});continue}let c;try{c=tp(a)?await a.parse(s):s}catch(e){const t=e instanceof Error?e.message:String(e);this._addMessage({role:r,tool_call_id:n,content:t});continue}const u=await a.function(c,this),h=Lp(this,Op,"m",jp).call(this,u);if(this._addMessage({role:r,tool_call_id:n,content:h}),o)return}}}}Op=new WeakSet,Ap=function(){return Lp(this,Op,"m",xp).call(this).content??null},xp=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(np(t)){const{function_call:e,...n}=t,r={...n,content:t.content??null,refusal:t.refusal??null};return e&&(r.function_call=e),r}}throw new Td("stream ended without producing a ChatCompletionMessage with role=assistant")},Pp=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(np(t)&&t?.function_call)return t.function_call;if(np(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},Cp=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(rp(t)&&null!=t.content)return t.content;if(ip(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some((e=>"assistant"===e.role&&e.tool_calls?.some((e=>"function"===e.type&&e.id===t.tool_call_id)))))return t.content}},Np=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Rp=function(e){if(null!=e.n&&e.n>1)throw new Td("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},jp=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class $p extends Mp{static runFunctions(e,t,n){const r=new $p,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,i))),r}static runTools(e,t,n){const r=new $p,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,i))),r}_addMessage(e,t=!0){super._addMessage(e,t),np(e)&&e.content&&this._emit("content",e.content)}}class Up extends Error{}class Fp extends Error{}const Bp=e=>function(e,t=511){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return((e,t)=>{const n=e.length;let r=0;const i=e=>{throw new Up(`${e} at position ${r}`)},s=e=>{throw new Fp(`${e} at position ${r}`)},a=()=>(h(),r>=n&&i("Unexpected end of input"),'"'===e[r]?o():"{"===e[r]?c():"["===e[r]?u():"null"===e.substring(r,r+4)||16&t&&n-r<4&&"null".startsWith(e.substring(r))?(r+=4,null):"true"===e.substring(r,r+4)||32&t&&n-r<4&&"true".startsWith(e.substring(r))?(r+=4,!0):"false"===e.substring(r,r+5)||32&t&&n-r<5&&"false".startsWith(e.substring(r))?(r+=5,!1):"Infinity"===e.substring(r,r+8)||128&t&&n-r<8&&"Infinity".startsWith(e.substring(r))?(r+=8,1/0):"-Infinity"===e.substring(r,r+9)||256&t&&1<n-r&&n-r<9&&"-Infinity".startsWith(e.substring(r))?(r+=9,-1/0):"NaN"===e.substring(r,r+3)||64&t&&n-r<3&&"NaN".startsWith(e.substring(r))?(r+=3,NaN):l()),o=()=>{const a=r;let o=!1;for(r++;r<n&&('"'!==e[r]||o&&"\\"===e[r-1]);)o="\\"===e[r]&&!o,r++;if('"'==e.charAt(r))try{return JSON.parse(e.substring(a,++r-Number(o)))}catch(e){s(String(e))}else if(1&t)try{return JSON.parse(e.substring(a,r-Number(o))+'"')}catch(t){return JSON.parse(e.substring(a,e.lastIndexOf("\\"))+'"')}i("Unterminated string literal")},c=()=>{r++,h();const s={};try{for(;"}"!==e[r];){if(h(),r>=n&&8&t)return s;const i=o();h(),r++;try{const e=a();Object.defineProperty(s,i,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(8&t)return s;throw e}h(),","===e[r]&&r++}}catch(e){if(8&t)return s;i("Expected '}' at end of object")}return r++,s},u=()=>{r++;const n=[];try{for(;"]"!==e[r];)n.push(a()),h(),","===e[r]&&r++}catch(e){if(4&t)return n;i("Expected ']' at end of array")}return r++,n},l=()=>{if(0===r){"-"===e&&2&t&&i("Not sure what '-' is");try{return JSON.parse(e)}catch(n){if(2&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}s(String(n))}}const a=r;for("-"===e[r]&&r++;e[r]&&!",]}".includes(e[r]);)r++;r!=n||2&t||i("Unterminated number literal");try{return JSON.parse(e.substring(a,r))}catch(n){"-"===e.substring(a,r)&&2&t&&i("Not sure what '-' is");try{return JSON.parse(e.substring(a,e.lastIndexOf("e")))}catch(e){s(String(e))}}},h=()=>{for(;r<n&&" \n\r\t".includes(e[r]);)r++};return a()})(e.trim(),t)}(e,509);var Vp,zp,qp,Hp,Kp,Wp,Gp,Zp,Jp,Qp,Xp,Yp,em=function(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n},tm=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class nm extends Mp{constructor(e){super(),Vp.add(this),zp.set(this,void 0),qp.set(this,void 0),Hp.set(this,void 0),em(this,zp,e,"f"),em(this,qp,[],"f")}get currentChatCompletionSnapshot(){return tm(this,Hp,"f")}static fromReadableStream(e){const t=new nm(null);return t._run((()=>t._fromReadableStream(e))),t}static createChatCompletion(e,t,n){const r=new nm(t);return r._run((()=>r._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}async _createChatCompletion(e,t,n){super._createChatCompletion;const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),tm(this,Vp,"m",Kp).call(this);const i=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of i)tm(this,Vp,"m",Gp).call(this,e);if(i.controller.signal?.aborted)throw new Od;return this._addChatCompletion(tm(this,Vp,"m",Qp).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),tm(this,Vp,"m",Kp).call(this),this._connected();const r=Bd.fromReadableStream(e,this.controller);let i;for await(const e of r)i&&i!==e.id&&this._addChatCompletion(tm(this,Vp,"m",Qp).call(this)),tm(this,Vp,"m",Gp).call(this,e),i=e.id;if(r.controller.signal?.aborted)throw new Od;return this._addChatCompletion(tm(this,Vp,"m",Qp).call(this))}[(zp=new WeakMap,qp=new WeakMap,Hp=new WeakMap,Vp=new WeakSet,Kp=function(){this.ended||em(this,Hp,void 0,"f")},Wp=function(e){let t=tm(this,qp,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},tm(this,qp,"f")[e.index]=t,t)},Gp=function(e){if(this.ended)return;const t=tm(this,Vp,"m",Yp).call(this,e);this._emit("chunk",e,t);for(const n of e.choices){const e=t.choices[n.index];null!=n.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",n.delta.content,e.message.content),this._emit("content.delta",{delta:n.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=n.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:n.delta.refusal,snapshot:e.message.refusal}),null!=n.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:n.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=n.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:n.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const r=tm(this,Vp,"m",Wp).call(this,e);e.finish_reason&&(tm(this,Vp,"m",Jp).call(this,e),null!=r.current_tool_call_index&&tm(this,Vp,"m",Zp).call(this,e,r.current_tool_call_index));for(const t of n.delta.tool_calls??[])r.current_tool_call_index!==t.index&&(tm(this,Vp,"m",Jp).call(this,e),null!=r.current_tool_call_index&&tm(this,Vp,"m",Zp).call(this,e,r.current_tool_call_index)),r.current_tool_call_index=t.index;for(const t of n.delta.tool_calls??[]){const n=e.message.tool_calls?.[t.index];n?.type&&"function"===n?.type&&this._emit("tool_calls.function.arguments.delta",{name:n.function?.name,index:t.index,arguments:n.function.arguments,parsed_arguments:n.function.parsed_arguments,arguments_delta:t.function?.arguments??""})}}},Zp=function(e,t){if(tm(this,Vp,"m",Wp).call(this,e).done_tool_calls.has(t))return;const n=e.message.tool_calls?.[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if("function"===n.type){const e=tm(this,zp,"f")?.tools?.find((e=>"function"===e.type&&e.function.name===n.function.name));this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:Ep(e)?e.$parseRaw(n.function.arguments):e?.function.strict?JSON.parse(n.function.arguments):null})}else n.type},Jp=function(e){const t=tm(this,Vp,"m",Wp).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const n=tm(this,Vp,"m",Xp).call(this);this._emit("content.done",{content:e.message.content,parsed:n?n.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Qp=function(){if(this.ended)throw new Td("stream has ended, this shouldn't happen");const e=tm(this,Hp,"f");if(!e)throw new Td("request ended without sending any chunks");return em(this,Hp,void 0,"f"),em(this,qp,[],"f"),function(e,t){const{id:n,choices:r,created:i,model:s,system_fingerprint:a,...o}=e,c={...o,id:n,choices:r.map((({message:t,finish_reason:n,index:r,logprobs:i,...s})=>{if(!n)throw new Td(`missing finish_reason for choice ${r}`);const{content:a=null,function_call:o,tool_calls:c,...u}=t,l=t.role;if(!l)throw new Td(`missing role for choice ${r}`);if(o){const{arguments:e,name:c}=o;if(null==e)throw new Td(`missing function_call.arguments for choice ${r}`);if(!c)throw new Td(`missing function_call.name for choice ${r}`);return{...s,message:{content:a,function_call:{arguments:e,name:c},role:l,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:i}}return c?{...s,index:r,finish_reason:n,logprobs:i,message:{...u,role:l,content:a,refusal:t.refusal??null,tool_calls:c.map(((t,n)=>{const{function:i,type:s,id:a,...o}=t,{arguments:c,name:u,...l}=i||{};if(null==a)throw new Td(`missing choices[${r}].tool_calls[${n}].id\n${rm(e)}`);if(null==s)throw new Td(`missing choices[${r}].tool_calls[${n}].type\n${rm(e)}`);if(null==u)throw new Td(`missing choices[${r}].tool_calls[${n}].function.name\n${rm(e)}`);if(null==c)throw new Td(`missing choices[${r}].tool_calls[${n}].function.arguments\n${rm(e)}`);return{...o,id:a,type:s,function:{...l,name:u,arguments:c}}}))}}:{...s,message:{...u,content:a,role:l,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:i}})),created:i,model:s,object:"chat.completion",...a?{system_fingerprint:a}:{}};return function(e,t){return t&&Ip(t)?kp(e,t):{...e,choices:e.choices.map((e=>({...e,message:{...e.message,parsed:null,tool_calls:e.message.tool_calls??[]}})))}}(c,t)}(e,tm(this,zp,"f"))},Xp=function(){const e=tm(this,zp,"f")?.response_format;return bp(e)?e:null},Yp=function(e){var t,n,r,i;let s=tm(this,Hp,"f");const{choices:a,...o}=e;s?Object.assign(s,o):s=em(this,Hp,{...o,choices:[]},"f");for(const{delta:a,finish_reason:o,index:c,logprobs:u=null,...l}of e.choices){let e=s.choices[c];if(e||(e=s.choices[c]={finish_reason:o,index:c,message:{},logprobs:u,...l}),u)if(e.logprobs){const{content:r,refusal:i,...s}=u;Object.assign(e.logprobs,s),r&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...r)),i&&((n=e.logprobs).refusal??(n.refusal=[]),e.logprobs.refusal.push(...i))}else e.logprobs=Object.assign({},u);if(o&&(e.finish_reason=o,tm(this,zp,"f")&&Ip(tm(this,zp,"f")))){if("length"===o)throw new $d;if("content_filter"===o)throw new Ud}if(Object.assign(e,l),!a)continue;const{content:h,refusal:d,function_call:f,role:p,tool_calls:m,...g}=a;if(Object.assign(e.message,g),d&&(e.message.refusal=(e.message.refusal||"")+d),p&&(e.message.role=p),f&&(e.message.function_call?(f.name&&(e.message.function_call.name=f.name),f.arguments&&((r=e.message.function_call).arguments??(r.arguments=""),e.message.function_call.arguments+=f.arguments)):e.message.function_call=f),h&&(e.message.content=(e.message.content||"")+h,!e.message.refusal&&tm(this,Vp,"m",Xp).call(this)&&(e.message.parsed=Bp(e.message.content))),m){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:r,function:s,...a}of m){const o=(i=e.message.tool_calls)[t]??(i[t]={});Object.assign(o,a),n&&(o.id=n),r&&(o.type=r),s&&(o.function??(o.function={name:s.name??"",arguments:""})),s?.name&&(o.function.name=s.name),s?.arguments&&(o.function.arguments+=s.arguments,Tp(tm(this,zp,"f"),o)&&(o.function.parsed_arguments=Bp(o.function.arguments)))}}}return s},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Bd(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function rm(e){return JSON.stringify(e)}class im extends nm{static fromReadableStream(e){const t=new im(null);return t._run((()=>t._fromReadableStream(e))),t}static runFunctions(e,t,n){const r=new im(null),i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,i))),r}static runTools(e,t,n){const r=new im(t),i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,i))),r}}class sm extends Pf{parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new Td(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new Td(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap((t=>kp(t,e)))}runFunctions(e,t){return e.stream?im.runFunctions(this._client,e,t):$p.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?im.runTools(this._client,e,t):$p.runTools(this._client,e,t)}stream(e,t){return nm.createChatCompletion(this._client,e,t)}}class am extends Pf{constructor(){super(...arguments),this.completions=new sm(this._client)}}!function(e){e.Completions=sm}(am||(am={}));var om,cm,um,lm,hm,dm,fm,pm,mm,gm,ym,vm,_m,wm,bm,Em,km,Sm,Tm,Im,Om,Am,xm,Pm=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},Cm=function(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n};class Nm extends wp{constructor(){super(...arguments),om.add(this),cm.set(this,[]),um.set(this,{}),lm.set(this,{}),hm.set(this,void 0),dm.set(this,void 0),fm.set(this,void 0),pm.set(this,void 0),mm.set(this,void 0),gm.set(this,void 0),ym.set(this,void 0),vm.set(this,void 0),_m.set(this,void 0)}[(cm=new WeakMap,um=new WeakMap,lm=new WeakMap,hm=new WeakMap,dm=new WeakMap,fm=new WeakMap,pm=new WeakMap,mm=new WeakMap,gm=new WeakMap,ym=new WeakMap,vm=new WeakMap,_m=new WeakMap,om=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new Nm;return t._run((()=>t._fromReadableStream(e))),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),this._connected();const r=Bd.fromReadableStream(e,this.controller);for await(const e of r)Pm(this,om,"m",wm).call(this,e);if(r.controller.signal?.aborted)throw new Od;return this._addRun(Pm(this,om,"m",bm).call(this))}toReadableStream(){return new Bd(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,r,i){const s=new Nm;return s._run((()=>s._runToolAssistantStream(e,t,n,r,{...i,headers:{...i?.headers,"X-Stainless-Helper-Method":"stream"}}))),s}async _createToolAssistantStream(e,t,n,r,i){const s=i?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort())));const a={...r,stream:!0},o=await e.submitToolOutputs(t,n,a,{...i,signal:this.controller.signal});this._connected();for await(const e of o)Pm(this,om,"m",wm).call(this,e);if(o.controller.signal?.aborted)throw new Od;return this._addRun(Pm(this,om,"m",bm).call(this))}static createThreadAssistantStream(e,t,n){const r=new Nm;return r._run((()=>r._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}static createAssistantStream(e,t,n,r){const i=new Nm;return i._run((()=>i._runAssistantStream(e,t,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}}))),i}currentEvent(){return Pm(this,ym,"f")}currentRun(){return Pm(this,vm,"f")}currentMessageSnapshot(){return Pm(this,hm,"f")}currentRunStepSnapshot(){return Pm(this,_m,"f")}async finalRunSteps(){return await this.done(),Object.values(Pm(this,um,"f"))}async finalMessages(){return await this.done(),Object.values(Pm(this,lm,"f"))}async finalRun(){if(await this.done(),!Pm(this,dm,"f"))throw Error("Final run was not received.");return Pm(this,dm,"f")}async _createThreadAssistantStream(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort())));const i={...t,stream:!0},s=await e.createAndRun(i,{...n,signal:this.controller.signal});this._connected();for await(const e of s)Pm(this,om,"m",wm).call(this,e);if(s.controller.signal?.aborted)throw new Od;return this._addRun(Pm(this,om,"m",bm).call(this))}async _createAssistantStream(e,t,n,r){const i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",(()=>this.controller.abort())));const s={...n,stream:!0},a=await e.create(t,s,{...r,signal:this.controller.signal});this._connected();for await(const e of a)Pm(this,om,"m",wm).call(this,e);if(a.controller.signal?.aborted)throw new Od;return this._addRun(Pm(this,om,"m",bm).call(this))}static accumulateDelta(e,t){for(const[n,r]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=r;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof r)t+=r;else if("number"==typeof t&&"number"==typeof r)t+=r;else{if(!xf(t)||!xf(r)){if(Array.isArray(t)&&Array.isArray(r)){if(t.every((e=>"string"==typeof e||"number"==typeof e))){t.push(...r);continue}for(const e of r){if(!xf(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const n=e.index;if(null==n)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof n)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${n}`);const r=t[n];null==r?t.push(e):t[n]=this.accumulateDelta(r,e)}continue}throw Error(`Unhandled record type: ${n}, deltaValue: ${r}, accValue: ${t}`)}t=this.accumulateDelta(t,r)}e[n]=t}else e[n]=r;else e[n]=r}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,r){return await this._createAssistantStream(t,e,n,r)}async _runToolAssistantStream(e,t,n,r,i){return await this._createToolAssistantStream(n,e,t,r,i)}}wm=function(e){if(!this.ended)switch(Cm(this,ym,e,"f"),Pm(this,om,"m",Sm).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":Pm(this,om,"m",Am).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Pm(this,om,"m",km).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":Pm(this,om,"m",Em).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},bm=function(){if(this.ended)throw new Td("stream has ended, this shouldn't happen");if(!Pm(this,dm,"f"))throw Error("Final run has not been received");return Pm(this,dm,"f")},Em=function(e){const[t,n]=Pm(this,om,"m",Im).call(this,e,Pm(this,hm,"f"));Cm(this,hm,t,"f"),Pm(this,lm,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,r=t.content[n.index];if(!r||"text"!=r.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,r.text)}if(n.index!=Pm(this,fm,"f")){if(Pm(this,pm,"f"))switch(Pm(this,pm,"f").type){case"text":this._emit("textDone",Pm(this,pm,"f").text,Pm(this,hm,"f"));break;case"image_file":this._emit("imageFileDone",Pm(this,pm,"f").image_file,Pm(this,hm,"f"))}Cm(this,fm,n.index,"f")}Cm(this,pm,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==Pm(this,fm,"f")){const t=e.data.content[Pm(this,fm,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,Pm(this,hm,"f"));break;case"text":this._emit("textDone",t.text,Pm(this,hm,"f"))}}Pm(this,hm,"f")&&this._emit("messageDone",e.data),Cm(this,hm,void 0,"f")}},km=function(e){const t=Pm(this,om,"m",Tm).call(this,e);switch(Cm(this,_m,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==Pm(this,mm,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(Pm(this,gm,"f")&&this._emit("toolCallDone",Pm(this,gm,"f")),Cm(this,mm,e.index,"f"),Cm(this,gm,t.step_details.tool_calls[e.index],"f"),Pm(this,gm,"f")&&this._emit("toolCallCreated",Pm(this,gm,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Cm(this,_m,void 0,"f"),"tool_calls"==e.data.step_details.type&&Pm(this,gm,"f")&&(this._emit("toolCallDone",Pm(this,gm,"f")),Cm(this,gm,void 0,"f")),this._emit("runStepDone",e.data,t)}},Sm=function(e){Pm(this,cm,"f").push(e),this._emit("event",e)},Tm=function(e){switch(e.event){case"thread.run.step.created":return Pm(this,um,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=Pm(this,um,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const r=Nm.accumulateDelta(t,n.delta);Pm(this,um,"f")[e.data.id]=r}return Pm(this,um,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":Pm(this,um,"f")[e.data.id]=e.data}if(Pm(this,um,"f")[e.data.id])return Pm(this,um,"f")[e.data.id];throw new Error("No snapshot available")},Im=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const e of r.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=Pm(this,om,"m",Om).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Om=function(e,t){return Nm.accumulateDelta(t,e)},Am=function(e){switch(Cm(this,vm,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Cm(this,dm,e.data,"f"),Pm(this,gm,"f")&&(this._emit("toolCallDone",Pm(this,gm,"f")),Cm(this,gm,void 0,"f"))}};class Rm extends Pf{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return hf(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,jm,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class jm extends Df{}Rm.MessagesPage=jm;class Lm extends Pf{retrieve(e,t,n,r={},i){return hf(r)?this.retrieve(e,t,n,{},r):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:r,...i,headers:{"OpenAI-Beta":"assistants=v2",...i?.headers}})}list(e,t,n={},r){return hf(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Dm,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class Dm extends Df{}Lm.RunStepsPage=Dm;class Mm extends Pf{constructor(){super(...arguments),this.steps=new Lm(this._client)}create(e,t,n){const{include:r,...i}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:r},body:i,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return hf(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,$m,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}createAndStream(e,t,n){return Nm.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:i,response:s}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...r}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=s.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await _f(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,n){return Nm.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,r){const i=await this.submitToolOutputs(e,t,n,r);return await this.poll(e,i.id,r)}submitToolOutputsStream(e,t,n,r){return Nm.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,r)}}class $m extends Df{}Mm.RunsPage=$m,Mm.Steps=Lm,Mm.RunStepsPage=Dm;class Um extends Pf{constructor(){super(...arguments),this.runs=new Mm(this._client),this.messages=new Rm(this._client)}create(e={},t){return hf(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return Nm.createThreadAssistantStream(e,this._client.beta.threads,t)}}Um.Runs=Mm,Um.RunsPage=$m,Um.Messages=Rm,Um.MessagesPage=jm;class Fm extends Pf{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},n){return hf(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,Bm,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const i=await this.retrieve(e,t,{...n,headers:r}).withResponse(),s=i.data;switch(s.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=i.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await _f(e);break;case"failed":case"completed":return s}}}async upload(e,t,n){const r=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:r.id},n)}async uploadAndPoll(e,t,n){const r=await this.upload(e,t,n);return await this.poll(e,r.id,n)}}class Bm extends Df{}Fm.VectorStoreFilesPage=Bm;class Vm extends Pf{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t);return await this.poll(e,r.id,n)}listFiles(e,t,n={},r){return hf(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Bm,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:i,response:s}=await this.retrieve(e,t,{...n,headers:r}).withResponse();switch(i.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=s.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await _f(e);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},r){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const i=r?.maxConcurrency??5,s=Math.min(i,t.length),a=this._client,o=t.values(),c=[...n],u=Array(s).fill(o).map((async function(e){for(let t of e){const e=await a.files.create({file:t,purpose:"assistants"},r);c.push(e.id)}}));return await(async e=>{const t=await Promise.allSettled(e),n=t.filter((e=>"rejected"===e.status));if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const e of t)"fulfilled"===e.status&&r.push(e.value);return r})(u),await this.createAndPoll(e,{file_ids:c})}}class zm extends Pf{constructor(){super(...arguments),this.files=new Fm(this._client),this.fileBatches=new Vm(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return hf(e)?this.list({},e):this._client.getAPIList("/vector_stores",qm,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class qm extends Df{}zm.VectorStoresPage=qm,zm.Files=Fm,zm.VectorStoreFilesPage=Bm,zm.FileBatches=Vm;class Hm extends Pf{constructor(){super(...arguments),this.vectorStores=new zm(this._client),this.chat=new am(this._client),this.assistants=new Yf(this._client),this.threads=new Um(this._client)}}Hm.VectorStores=zm,Hm.VectorStoresPage=qm,Hm.Assistants=Yf,Hm.AssistantsPage=ep,Hm.Threads=Um;class Km extends Pf{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return hf(e)?this.list({},e):this._client.getAPIList("/batches",Wm,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class Wm extends Df{}Km.BatchesPage=Wm;class Gm extends Pf{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,Xd({body:t,...n}))}}class Zm extends Pf{constructor(){super(...arguments),this.parts=new Gm(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}}Zm.Parts=Gm;class Jm extends af{constructor({baseURL:e=Ef("OPENAI_BASE_URL"),apiKey:t=Ef("OPENAI_API_KEY"),organization:n=Ef("OPENAI_ORG_ID")??null,project:r=Ef("OPENAI_PROJECT_ID")??null,...i}={}){if(void 0===t)throw new Td("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const s={apiKey:t,organization:n,project:r,...i,baseURL:e||"https://api.openai.com/v1"};if(!s.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new Td("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:s.baseURL,timeout:s.timeout??6e5,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new Cf(this),this.chat=new Rf(this),this.embeddings=new jf(this),this.files=new Mf(this),this.images=new Uf(this),this.audio=new zf(this),this.moderations=new qf(this),this.models=new Hf(this),this.fineTuning=new Xf(this),this.beta=new Hm(this),this.batches=new Km(this),this.uploads=new Zm(this),this._options=s,this.apiKey=t,this.organization=n,this.project=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return function(e,t={}){let n=e;const r=function(e=ad){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||ad.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=Gh;if(void 0!==e.format){if(!ed.call(Zh,e.format))throw new TypeError("Unknown format option provided.");n=e.format}const r=Zh[n];let i,s=ad.filter;if(("function"==typeof e.filter||nd(e.filter))&&(s=e.filter),i=e.arrayFormat&&e.arrayFormat in td?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":ad.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const a=void 0===e.allowDots?1==!!e.encodeDotInKeys||ad.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:ad.addQueryPrefix,allowDots:a,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:ad.allowEmptyArrays,arrayFormat:i,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:ad.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?ad.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:ad.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:ad.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:ad.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:ad.encodeValuesOnly,filter:s,format:n,formatter:r,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:ad.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:ad.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:ad.strictNullHandling}}(t);let i,s;"function"==typeof r.filter?(s=r.filter,n=s("",n)):nd(r.filter)&&(s=r.filter,i=s);const a=[];if("object"!=typeof n||null===n)return"";const o=td[r.arrayFormat],c="comma"===o&&r.commaRoundTrip;i||(i=Object.keys(n)),r.sort&&i.sort(r.sort);const u=new WeakMap;for(let e=0;e<i.length;++e){const t=i[e];r.skipNulls&&null===n[t]||id(a,cd(n[t],t,o,c,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,u))}const l=a.join(r.delimiter);let h=!0===r.addQueryPrefix?"?":"";return r.charsetSentinel&&("iso-8859-1"===r.charset?h+="utf8=%26%2310003%3B&":h+="utf8=%E2%9C%93&"),l.length>0?h+l:""}(e,{arrayFormat:"brackets"})}}xm=Jm,Jm.OpenAI=xm,Jm.DEFAULT_TIMEOUT=6e5,Jm.OpenAIError=Td,Jm.APIError=Id,Jm.APIConnectionError=Ad,Jm.APIConnectionTimeoutError=xd,Jm.APIUserAbortError=Od,Jm.NotFoundError=Rd,Jm.ConflictError=jd,Jm.RateLimitError=Dd,Jm.BadRequestError=Pd,Jm.AuthenticationError=Cd,Jm.InternalServerError=Md,Jm.PermissionDeniedError=Nd,Jm.UnprocessableEntityError=Ld,Jm.toFile=Gd,Jm.fileFromPath=yd,Jm.Completions=Cf,Jm.Chat=Rf,Jm.Embeddings=jf,Jm.Files=Mf,Jm.FileObjectsPage=$f,Jm.Images=Uf,Jm.Audio=zf,Jm.Moderations=qf,Jm.Models=Hf,Jm.ModelsPage=Kf,Jm.FineTuning=Xf,Jm.Beta=Hm,Jm.Batches=Km,Jm.BatchesPage=Wm,Jm.Uploads=Zm,new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations"]);const Qm=Jm;function Xm(e,t=Ym){e=e.trim();const n=/```(json)?(.*)```/s.exec(e);return t(n?n[2]:e)}function Ym(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const n=[];let r=!1,i=!1;for(let s of e){if(r)'"'!==s||i?"\n"!==s||i?i="\\"===s&&!i:s="\\n":r=!1;else if('"'===s)r=!0,i=!1;else if("{"===s)n.push("}");else if("["===s)n.push("]");else if("}"===s||"]"===s){if(!n||n[n.length-1]!==s)return null;n.pop()}t+=s}r&&(t+='"');for(let e=n.length-1;e>=0;e-=1)t+=n[e];try{return JSON.parse(t)}catch(e){return null}}var eg=i(409);function tg(e,t){return t?.[e]||eg(e)}function ng(e,t,n){const r={};for(const i in e)Object.hasOwn(e,i)&&(r[t(i,n)]=e[i]);return r}function rg(e){return Array.isArray(e)?[...e]:{...e}}function ig(e,t){const n=rg(e);for(const[e,r]of Object.entries(t)){const[t,...i]=e.split(".").reverse();let s=n;for(const e of i.reverse()){if(void 0===s[e])break;s[e]=rg(s[e]),s=s[e]}void 0!==s[t]&&(s[t]={lc:1,type:"secret",id:[r]})}return n}function sg(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}i(832);class ag{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,sg(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof ag||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},n=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let r=Object.getPrototypeOf(this);r;r=Object.getPrototypeOf(r))Object.assign(e,Reflect.get(r,"lc_aliases",this)),Object.assign(t,Reflect.get(r,"lc_secrets",this)),Object.assign(n,Reflect.get(r,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,r=n;const[i,...s]=e.split(".").reverse();for(const e of s.reverse()){if(!(e in t)||void 0===t[e])return;e in r&&void 0!==r[e]||("object"==typeof t[e]&&null!=t[e]?r[e]={}:Array.isArray(t[e])&&(r[e]=[])),t=t[e],r=r[e]}i in t&&void 0!==t[i]&&(r[i]=r[i]||t[i])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:ng(Object.keys(t).length?ig(n,t):n,tg,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function og(e,t){return"string"==typeof e?"string"==typeof t?e+t:[{type:"text",text:e},...t]:Array.isArray(t)?[...e,...t]:[...e,{type:"text",text:t}]}class cg extends ag{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:""}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}}function ug(e,t){const n={...e};for(const[e,r]of Object.entries(t))if(null==n[e])n[e]=r;else{if(null==r)continue;if(typeof n[e]!=typeof r||Array.isArray(n[e])!==Array.isArray(r))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof n[e])n[e]=n[e]+r;else if(Array.isArray(n[e])||"object"!=typeof n[e])if(Array.isArray(n[e]))n[e]=lg(n[e],r);else{if(n[e]===r)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else n[e]=ug(n[e],r)}return n}function lg(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const n=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=n.findIndex((t=>t.index===e.index));-1!==t?n[t]=ug(n[t],e):n.push(e)}else n.push(e);return n}}}class hg extends cg{}function dg(e){return"function"==typeof e?._getType}class fg extends hg{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new fg({content:og(this.content,e.content),additional_kwargs:ug(this.additional_kwargs,e.additional_kwargs),response_metadata:ug(this.response_metadata,e.response_metadata),tool_call_id:this.tool_call_id})}}class pg extends cg{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let n;if("string"==typeof e)n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{n=e;const t=n.additional_kwargs?.tool_calls,r=n.tool_calls;null!=t&&t.length>0&&(void 0===r||0===r.length)&&console.warn(["New LangChain packages are available that more efficiently handle","tool calling.\n\nPlease upgrade your packages to versions that set","message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(null!=t&&void 0===r){const[e,r]=function(e){const t=[],n=[];for(const r of e)if(r.function){const e=r.function.name;try{const n={name:e||"",args:JSON.parse(r.function.arguments)||{},id:r.id};t.push(n)}catch(t){n.push({name:e,args:r.function.arguments,id:r.id,error:"Malformed args."})}}return[t,n]}(t);n.tool_calls=e??[],n.invalid_tool_calls=r??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch(e){n.tool_calls=[],n.invalid_tool_calls=[]}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),"string"!=typeof n&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls)}static lc_name(){return"AIMessage"}_getType(){return"ai"}}class mg extends hg{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else{const n=[],r=[];for(const t of e.tool_call_chunks){let i={};try{if(i=Ym(t.args??"{}")??{},"object"!=typeof i||Array.isArray(i))throw new Error("Malformed tool call chunk args.");n.push({name:t.name??"",args:i,id:t.id})}catch(e){r.push({name:t.name,args:t.args,id:t.id,error:"Malformed args."})}}t={...e,tool_calls:n,invalid_tool_calls:r}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.tool_call_chunks=t?.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t?.tool_calls??this.tool_calls,this.invalid_tool_calls=t?.invalid_tool_calls??this.invalid_tool_calls}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){const t={content:og(this.content,e.content),additional_kwargs:ug(this.additional_kwargs,e.additional_kwargs),response_metadata:ug(this.response_metadata,e.response_metadata),tool_call_chunks:[]};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const n=lg(this.tool_call_chunks,e.tool_call_chunks);void 0!==n&&n.length>0&&(t.tool_call_chunks=n)}return new mg(t)}}class gg extends cg{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return gg}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}}class yg extends hg{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new yg({content:og(this.content,e.content),additional_kwargs:ug(this.additional_kwargs,e.additional_kwargs),response_metadata:ug(this.response_metadata,e.response_metadata),role:this.role})}}class vg extends hg{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new vg({content:og(this.content,e.content),additional_kwargs:ug(this.additional_kwargs,e.additional_kwargs),response_metadata:ug(this.response_metadata,e.response_metadata),name:this.name??""})}}class _g extends cg{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class wg extends hg{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new wg({content:og(this.content,e.content),additional_kwargs:ug(this.additional_kwargs,e.additional_kwargs),response_metadata:ug(this.response_metadata,e.response_metadata)})}}class bg extends cg{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class Eg extends hg{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new Eg({content:og(this.content,e.content),additional_kwargs:ug(this.additional_kwargs,e.additional_kwargs),response_metadata:ug(this.response_metadata,e.response_metadata)})}}function kg(e){if("string"==typeof e)return new _g(e);if(dg(e))return e;const[t,n]=e;if("human"===t||"user"===t)return new _g({content:n});if("ai"===t||"assistant"===t)return new pg({content:n});if("system"===t)return new bg({content:n});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function Sg(e,t="Human",n="AI"){const r=[];for(const i of e){let e;if("human"===i._getType())e=t;else if("ai"===i._getType())e=n;else if("system"===i._getType())e="System";else if("function"===i._getType())e="Function";else if("tool"===i._getType())e="Tool";else{if("generic"!==i._getType())throw new Error(`Got unsupported message type: ${i._getType()}`);e=i.role}const s=i.name?`${i.name}, `:"";r.push(`${e}: ${s}${i.content}`)}return r.join("\n")}function Tg(e){const t=e._getType();if("human"===t)return new wg({...e});if("ai"===t)return new mg({...e});if("system"===t)return new Eg({...e});if("function"===t)return new vg({...e});if(gg.isInstance(e))return new yg({...e});throw new Error("Unknown message type.")}const Ig="__run";class Og{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new Og({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class Ag extends Og{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new Ag({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}const xg=()=>"undefined"!=typeof Deno;let Pg;async function Cg(){if(void 0===Pg){const e=(()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||xg()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":xg()?"deno":"other":"node",e})();Pg={library:"langchain-js",runtime:e}}return Pg}function Ng(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}var Rg="object"==typeof window?window:{},jg="0123456789abcdef".split(""),Lg=[-2147483648,8388608,32768,128],Dg=[24,16,8,0],Mg=[];function $g(e){e?(Mg[0]=Mg[16]=Mg[1]=Mg[2]=Mg[3]=Mg[4]=Mg[5]=Mg[6]=Mg[7]=Mg[8]=Mg[9]=Mg[10]=Mg[11]=Mg[12]=Mg[13]=Mg[14]=Mg[15]=0,this.blocks=Mg):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}$g.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===Rg.ArrayBuffer&&(e=new Uint8Array(e));for(var n,r,i=0,s=e.length||0,a=this.blocks;i<s;){if(this.hashed&&(this.hashed=!1,a[0]=this.block,a[16]=a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=a[7]=a[8]=a[9]=a[10]=a[11]=a[12]=a[13]=a[14]=a[15]=0),t)for(r=this.start;i<s&&r<64;++i)a[r>>2]|=e[i]<<Dg[3&r++];else for(r=this.start;i<s&&r<64;++i)(n=e.charCodeAt(i))<128?a[r>>2]|=n<<Dg[3&r++]:n<2048?(a[r>>2]|=(192|n>>6)<<Dg[3&r++],a[r>>2]|=(128|63&n)<<Dg[3&r++]):n<55296||n>=57344?(a[r>>2]|=(224|n>>12)<<Dg[3&r++],a[r>>2]|=(128|n>>6&63)<<Dg[3&r++],a[r>>2]|=(128|63&n)<<Dg[3&r++]):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++i)),a[r>>2]|=(240|n>>18)<<Dg[3&r++],a[r>>2]|=(128|n>>12&63)<<Dg[3&r++],a[r>>2]|=(128|n>>6&63)<<Dg[3&r++],a[r>>2]|=(128|63&n)<<Dg[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=a[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},$g.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=Lg[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},$g.prototype.hash=function(){var e,t,n=this.h0,r=this.h1,i=this.h2,s=this.h3,a=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)n=(t=(r=(t=(i=(t=(s=(t=(a=(t=n<<5|n>>>27)+(r&i|~r&s)+a+1518500249+o[e]|0)<<5|a>>>27)+(n&(r=r<<30|r>>>2)|~n&i)+s+1518500249+o[e+1]|0)<<5|s>>>27)+(a&(n=n<<30|n>>>2)|~a&r)+i+1518500249+o[e+2]|0)<<5|i>>>27)+(s&(a=a<<30|a>>>2)|~s&n)+r+1518500249+o[e+3]|0)<<5|r>>>27)+(i&(s=s<<30|s>>>2)|~i&a)+n+1518500249+o[e+4]|0,i=i<<30|i>>>2;for(;e<40;e+=5)n=(t=(r=(t=(i=(t=(s=(t=(a=(t=n<<5|n>>>27)+(r^i^s)+a+1859775393+o[e]|0)<<5|a>>>27)+(n^(r=r<<30|r>>>2)^i)+s+1859775393+o[e+1]|0)<<5|s>>>27)+(a^(n=n<<30|n>>>2)^r)+i+1859775393+o[e+2]|0)<<5|i>>>27)+(s^(a=a<<30|a>>>2)^n)+r+1859775393+o[e+3]|0)<<5|r>>>27)+(i^(s=s<<30|s>>>2)^a)+n+1859775393+o[e+4]|0,i=i<<30|i>>>2;for(;e<60;e+=5)n=(t=(r=(t=(i=(t=(s=(t=(a=(t=n<<5|n>>>27)+(r&i|r&s|i&s)+a-1894007588+o[e]|0)<<5|a>>>27)+(n&(r=r<<30|r>>>2)|n&i|r&i)+s-1894007588+o[e+1]|0)<<5|s>>>27)+(a&(n=n<<30|n>>>2)|a&r|n&r)+i-1894007588+o[e+2]|0)<<5|i>>>27)+(s&(a=a<<30|a>>>2)|s&n|a&n)+r-1894007588+o[e+3]|0)<<5|r>>>27)+(i&(s=s<<30|s>>>2)|i&a|s&a)+n-1894007588+o[e+4]|0,i=i<<30|i>>>2;for(;e<80;e+=5)n=(t=(r=(t=(i=(t=(s=(t=(a=(t=n<<5|n>>>27)+(r^i^s)+a-899497514+o[e]|0)<<5|a>>>27)+(n^(r=r<<30|r>>>2)^i)+s-899497514+o[e+1]|0)<<5|s>>>27)+(a^(n=n<<30|n>>>2)^r)+i-899497514+o[e+2]|0)<<5|i>>>27)+(s^(a=a<<30|a>>>2)^n)+r-899497514+o[e+3]|0)<<5|r>>>27)+(i^(s=s<<30|s>>>2)^a)+n-899497514+o[e+4]|0,i=i<<30|i>>>2;this.h0=this.h0+n|0,this.h1=this.h1+r|0,this.h2=this.h2+i|0,this.h3=this.h3+s|0,this.h4=this.h4+a|0},$g.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,i=this.h4;return jg[e>>28&15]+jg[e>>24&15]+jg[e>>20&15]+jg[e>>16&15]+jg[e>>12&15]+jg[e>>8&15]+jg[e>>4&15]+jg[15&e]+jg[t>>28&15]+jg[t>>24&15]+jg[t>>20&15]+jg[t>>16&15]+jg[t>>12&15]+jg[t>>8&15]+jg[t>>4&15]+jg[15&t]+jg[n>>28&15]+jg[n>>24&15]+jg[n>>20&15]+jg[n>>16&15]+jg[n>>12&15]+jg[n>>8&15]+jg[n>>4&15]+jg[15&n]+jg[r>>28&15]+jg[r>>24&15]+jg[r>>20&15]+jg[r>>16&15]+jg[r>>12&15]+jg[r>>8&15]+jg[r>>4&15]+jg[15&r]+jg[i>>28&15]+jg[i>>24&15]+jg[i>>20&15]+jg[i>>16&15]+jg[i>>12&15]+jg[i>>8&15]+jg[i>>4&15]+jg[15&i]},$g.prototype.toString=$g.prototype.hex,$g.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,i=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24&255,r>>16&255,r>>8&255,255&r,i>>24&255,i>>16&255,i>>8&255,255&i]},$g.prototype.array=$g.prototype.digest,$g.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};const Ug=(...e)=>{return t=e.join("_"),new $g(!0).update(t).hex();var t};class Fg{}const Bg=new Map;class Vg extends Fg{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Ug(e,t))??null)}async update(e,t,n){this.cache.set(Ug(e,t),n)}static global(){return new Vg(Bg)}}class zg extends ag{}class qg extends zg{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new _g(this.value)]}}class Hg extends zg{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Sg(this.messages)}toChatMessages(){return this.messages}}var Kg=i(201),Wg=i(425);const Gg=[400,401,402,403,404,405,406,407,409],Zg=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&Gg.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class Jg{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??Zg;const t=Wg.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>Kg((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}var Qg=i(991),Xg=Object.defineProperty;function Yg(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let n=Array.from({length:e.length},((e,t)=>({start:t,end:t+1})));for(;n.length>1;){let r=null;for(let i=0;i<n.length-1;i++){const s=e.slice(n[i].start,n[i+1].end),a=t.get(s.join(","));null!=a&&(null==r||a<r[0])&&(r=[a,i])}if(null==r)break;{const e=r[1];n[e]={start:n[e].start,end:n[e+1].end},n.splice(e+1,1)}}return n}(e,t).map((n=>t.get(e.slice(n.start,n.end).join(",")))).filter((e=>null!=e))}var ey,ty,ny=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const n=e.bpe_ranks.split("\n").filter(Boolean).reduce(((e,t)=>{const[n,r,...i]=t.split(" "),s=Number.parseInt(r,10);return i.forEach(((t,n)=>e[t]=s+n)),e}),{});for(const[e,t]of Object.entries(n)){const n=Qg.toByteArray(e);this.rankMap.set(n.join(","),t),this.textMap.set(t,n)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce(((e,[t,n])=>(e[n]=this.textEncoder.encode(t),e)),{})}encode(e,t=[],n="all"){const r=new RegExp(this.patStr,"ug"),i=ny.specialTokenRegex(Object.keys(this.specialTokens)),s=[],a=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===n?Object.keys(this.specialTokens).filter((e=>!a.has(e))):n);if(o.size>0){const t=ny.specialTokenRegex([...o]),n=e.match(t);if(null!=n)throw new Error(`The text contains a special token that is not allowed: ${n[0]}`)}let c=0;for(;;){let t=null,n=c;for(;i.lastIndex=n,t=i.exec(e),null!=t&&!a.has(t[0]);)n=t.index+1;const o=t?.index??e.length;for(const t of e.substring(c,o).matchAll(r)){const e=this.textEncoder.encode(t[0]),n=this.rankMap.get(e.join(","));null==n?s.push(...Yg(e,this.rankMap)):s.push(n)}if(null==t)break;let u=this.specialTokens[t[0]];s.push(u),c=t.index+t[0].length}return s}decode(e){const t=[];let n=0;for(let r=0;r<e.length;++r){const i=e[r],s=this.textMap.get(i)??this.inverseSpecialTokens[i];null!=s&&(t.push(s),n+=s.length)}const r=new Uint8Array(n);let i=0;for(const e of t)r.set(e,i),i+=e.length;return this.textDecoder.decode(r)}},ry=ny;ty=e=>new RegExp(e.map((e=>function(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}(e))).join("|"),"g"),((e,t,n)=>{t in e?Xg(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(ry,"symbol"!=typeof(ey="specialTokenRegex")?ey+"":ey,ty);const iy={},sy=new Jg({});var ay,oy;!function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter((e=>"number"!=typeof t[t[e]])),r={};for(const e of n)r[e]=t[e];return e.objectValues(r)},e.objectValues=t=>e.objectKeys(t).map((function(e){return t[e]})),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map((e=>"string"==typeof e?`'${e}'`:e)).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(ay||(ay={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(oy||(oy={}));const cy=ay.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),uy=e=>{switch(typeof e){case"undefined":return cy.undefined;case"string":return cy.string;case"number":return isNaN(e)?cy.nan:cy.number;case"boolean":return cy.boolean;case"function":return cy.function;case"bigint":return cy.bigint;case"symbol":return cy.symbol;case"object":return Array.isArray(e)?cy.array:null===e?cy.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?cy.promise:"undefined"!=typeof Map&&e instanceof Map?cy.map:"undefined"!=typeof Set&&e instanceof Set?cy.set:"undefined"!=typeof Date&&e instanceof Date?cy.date:cy.object;default:return cy.unknown}},ly=ay.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class hy extends Error{constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(e){return e.message},n={_errors:[]},r=e=>{for(const i of e.issues)if("invalid_union"===i.code)i.unionErrors.map(r);else if("invalid_return_type"===i.code)r(i.returnTypeError);else if("invalid_arguments"===i.code)r(i.argumentsError);else if(0===i.path.length)n._errors.push(t(i));else{let e=n,r=0;for(;r<i.path.length;){const n=i.path[r];r===i.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(i))):e[n]=e[n]||{_errors:[]},e=e[n],r++}}};return r(this),n}static assert(e){if(!(e instanceof hy))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,ay.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=(e=>e.message)){const t={},n=[];for(const r of this.issues)r.path.length>0?(t[r.path[0]]=t[r.path[0]]||[],t[r.path[0]].push(e(r))):n.push(e(r));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}hy.create=e=>new hy(e);const dy=(e,t)=>{let n;switch(e.code){case ly.invalid_type:n=e.received===cy.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case ly.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,ay.jsonStringifyReplacer)}`;break;case ly.unrecognized_keys:n=`Unrecognized key(s) in object: ${ay.joinValues(e.keys,", ")}`;break;case ly.invalid_union:n="Invalid input";break;case ly.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${ay.joinValues(e.options)}`;break;case ly.invalid_enum_value:n=`Invalid enum value. Expected ${ay.joinValues(e.options)}, received '${e.received}'`;break;case ly.invalid_arguments:n="Invalid function arguments";break;case ly.invalid_return_type:n="Invalid function return type";break;case ly.invalid_date:n="Invalid date";break;case ly.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:ay.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case ly.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case ly.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case ly.custom:n="Invalid input";break;case ly.invalid_intersection_types:n="Intersection results could not be merged";break;case ly.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case ly.not_finite:n="Number must be finite";break;default:n=t.defaultError,ay.assertNever(e)}return{message:n}};let fy=dy;function py(){return fy}const my=e=>{const{data:t,path:n,errorMaps:r,issueData:i}=e,s=[...n,...i.path||[]],a={...i,path:s};if(void 0!==i.message)return{...i,path:s,message:i.message};let o="";const c=r.filter((e=>!!e)).slice().reverse();for(const e of c)o=e(a,{data:t,defaultError:o}).message;return{...i,path:s,message:o}};function gy(e,t){const n=py(),r=my({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===dy?void 0:dy].filter((e=>!!e))});e.common.issues.push(r)}class yy{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const r of t){if("aborted"===r.status)return vy;"dirty"===r.status&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,r=await e.value;n.push({key:t,value:r})}return yy.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const r of t){const{key:t,value:i}=r;if("aborted"===t.status)return vy;if("aborted"===i.status)return vy;"dirty"===t.status&&e.dirty(),"dirty"===i.status&&e.dirty(),"__proto__"===t.value||void 0===i.value&&!r.alwaysSet||(n[t.value]=i.value)}return{status:e.value,value:n}}}const vy=Object.freeze({status:"aborted"}),_y=e=>({status:"dirty",value:e}),wy=e=>({status:"valid",value:e}),by=e=>"aborted"===e.status,Ey=e=>"dirty"===e.status,ky=e=>"valid"===e.status,Sy=e=>"undefined"!=typeof Promise&&e instanceof Promise;function Ty(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function Iy(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n}var Oy,Ay,xy;"function"==typeof SuppressedError&&SuppressedError,function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(Oy||(Oy={}));class Py{constructor(e,t,n,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=r}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Cy=(e,t)=>{if(ky(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new hy(e.common.issues);return this._error=t,this._error}}};function Ny(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:r,description:i}=e;if(t&&(n||r))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:i}:{errorMap:(t,i)=>{var s,a;const{message:o}=e;return"invalid_enum_value"===t.code?{message:null!=o?o:i.defaultError}:void 0===i.data?{message:null!==(s=null!=o?o:r)&&void 0!==s?s:i.defaultError}:"invalid_type"!==t.code?{message:i.defaultError}:{message:null!==(a=null!=o?o:n)&&void 0!==a?a:i.defaultError}},description:i}}class Ry{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return uy(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:uy(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new yy,ctx:{common:e.parent.common,data:e.data,parsedType:uy(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Sy(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;const r={common:{issues:[],async:null!==(n=null==t?void 0:t.async)&&void 0!==n&&n,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:uy(e)},i=this._parseSync({data:e,path:r.path,parent:r});return Cy(r,i)}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:uy(e)},r=this._parse({data:e,path:n.path,parent:n}),i=await(Sy(r)?r:Promise.resolve(r));return Cy(n,i)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement(((t,r)=>{const i=e(t),s=()=>r.addIssue({code:ly.custom,...n(t)});return"undefined"!=typeof Promise&&i instanceof Promise?i.then((e=>!!e||(s(),!1))):!!i||(s(),!1)}))}refinement(e,t){return this._refinement(((n,r)=>!!e(n)||(r.addIssue("function"==typeof t?t(n,r):t),!1)))}_refinement(e){return new Ov({schema:this,typeName:Uv.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return Av.create(this,this._def)}nullable(){return xv.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return cv.create(this,this._def)}promise(){return Iv.create(this,this._def)}or(e){return hv.create([this,e],this._def)}and(e){return mv.create(this,e,this._def)}transform(e){return new Ov({...Ny(this._def),schema:this,typeName:Uv.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new Pv({...Ny(this._def),innerType:this,defaultValue:t,typeName:Uv.ZodDefault})}brand(){return new jv({typeName:Uv.ZodBranded,type:this,...Ny(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new Cv({...Ny(this._def),innerType:this,catchValue:t,typeName:Uv.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return Lv.create(this,e)}readonly(){return Dv.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const jy=/^c[^\s-]{8,}$/i,Ly=/^[0-9a-z]+$/,Dy=/^[0-9A-HJKMNP-TV-Z]{26}$/,My=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,$y=/^[a-z0-9_-]{21}$/i,Uy=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Fy=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let By;const Vy=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,zy=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,qy=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Hy="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Ky=new RegExp(`^${Hy}$`);function Wy(e){let t="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),t}function Gy(e){let t=`${Hy}T${Wy(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}class Zy extends Ry{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==cy.string){const t=this._getOrReturnCtx(e);return gy(t,{code:ly.invalid_type,expected:cy.string,received:t.parsedType}),vy}const t=new yy;let n;for(const s of this._def.checks)if("min"===s.kind)e.data.length<s.value&&(n=this._getOrReturnCtx(e,n),gy(n,{code:ly.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("max"===s.kind)e.data.length>s.value&&(n=this._getOrReturnCtx(e,n),gy(n,{code:ly.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("length"===s.kind){const r=e.data.length>s.value,i=e.data.length<s.value;(r||i)&&(n=this._getOrReturnCtx(e,n),r?gy(n,{code:ly.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):i&&gy(n,{code:ly.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),t.dirty())}else if("email"===s.kind)Fy.test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{validation:"email",code:ly.invalid_string,message:s.message}),t.dirty());else if("emoji"===s.kind)By||(By=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),By.test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{validation:"emoji",code:ly.invalid_string,message:s.message}),t.dirty());else if("uuid"===s.kind)My.test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{validation:"uuid",code:ly.invalid_string,message:s.message}),t.dirty());else if("nanoid"===s.kind)$y.test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{validation:"nanoid",code:ly.invalid_string,message:s.message}),t.dirty());else if("cuid"===s.kind)jy.test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{validation:"cuid",code:ly.invalid_string,message:s.message}),t.dirty());else if("cuid2"===s.kind)Ly.test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{validation:"cuid2",code:ly.invalid_string,message:s.message}),t.dirty());else if("ulid"===s.kind)Dy.test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{validation:"ulid",code:ly.invalid_string,message:s.message}),t.dirty());else if("url"===s.kind)try{new URL(e.data)}catch(r){n=this._getOrReturnCtx(e,n),gy(n,{validation:"url",code:ly.invalid_string,message:s.message}),t.dirty()}else"regex"===s.kind?(s.regex.lastIndex=0,s.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{validation:"regex",code:ly.invalid_string,message:s.message}),t.dirty())):"trim"===s.kind?e.data=e.data.trim():"includes"===s.kind?e.data.includes(s.value,s.position)||(n=this._getOrReturnCtx(e,n),gy(n,{code:ly.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),t.dirty()):"toLowerCase"===s.kind?e.data=e.data.toLowerCase():"toUpperCase"===s.kind?e.data=e.data.toUpperCase():"startsWith"===s.kind?e.data.startsWith(s.value)||(n=this._getOrReturnCtx(e,n),gy(n,{code:ly.invalid_string,validation:{startsWith:s.value},message:s.message}),t.dirty()):"endsWith"===s.kind?e.data.endsWith(s.value)||(n=this._getOrReturnCtx(e,n),gy(n,{code:ly.invalid_string,validation:{endsWith:s.value},message:s.message}),t.dirty()):"datetime"===s.kind?Gy(s).test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{code:ly.invalid_string,validation:"datetime",message:s.message}),t.dirty()):"date"===s.kind?Ky.test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{code:ly.invalid_string,validation:"date",message:s.message}),t.dirty()):"time"===s.kind?new RegExp(`^${Wy(s)}$`).test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{code:ly.invalid_string,validation:"time",message:s.message}),t.dirty()):"duration"===s.kind?Uy.test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{validation:"duration",code:ly.invalid_string,message:s.message}),t.dirty()):"ip"===s.kind?(r=e.data,("v4"!==(i=s.version)&&i||!Vy.test(r))&&("v6"!==i&&i||!zy.test(r))&&(n=this._getOrReturnCtx(e,n),gy(n,{validation:"ip",code:ly.invalid_string,message:s.message}),t.dirty())):"base64"===s.kind?qy.test(e.data)||(n=this._getOrReturnCtx(e,n),gy(n,{validation:"base64",code:ly.invalid_string,message:s.message}),t.dirty()):ay.assertNever(s);var r,i;return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement((t=>e.test(t)),{validation:t,code:ly.invalid_string,...Oy.errToObj(n)})}_addCheck(e){return new Zy({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...Oy.errToObj(e)})}url(e){return this._addCheck({kind:"url",...Oy.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...Oy.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...Oy.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...Oy.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...Oy.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...Oy.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...Oy.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...Oy.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...Oy.errToObj(e)})}datetime(e){var t,n;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(n=null==e?void 0:e.local)&&void 0!==n&&n,...Oy.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...Oy.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...Oy.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...Oy.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...Oy.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...Oy.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...Oy.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...Oy.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...Oy.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...Oy.errToObj(t)})}nonempty(e){return this.min(1,Oy.errToObj(e))}trim(){return new Zy({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Zy({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Zy({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find((e=>"datetime"===e.kind))}get isDate(){return!!this._def.checks.find((e=>"date"===e.kind))}get isTime(){return!!this._def.checks.find((e=>"time"===e.kind))}get isDuration(){return!!this._def.checks.find((e=>"duration"===e.kind))}get isEmail(){return!!this._def.checks.find((e=>"email"===e.kind))}get isURL(){return!!this._def.checks.find((e=>"url"===e.kind))}get isEmoji(){return!!this._def.checks.find((e=>"emoji"===e.kind))}get isUUID(){return!!this._def.checks.find((e=>"uuid"===e.kind))}get isNANOID(){return!!this._def.checks.find((e=>"nanoid"===e.kind))}get isCUID(){return!!this._def.checks.find((e=>"cuid"===e.kind))}get isCUID2(){return!!this._def.checks.find((e=>"cuid2"===e.kind))}get isULID(){return!!this._def.checks.find((e=>"ulid"===e.kind))}get isIP(){return!!this._def.checks.find((e=>"ip"===e.kind))}get isBase64(){return!!this._def.checks.find((e=>"base64"===e.kind))}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function Jy(e,t){const n=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,i=n>r?n:r;return parseInt(e.toFixed(i).replace(".",""))%parseInt(t.toFixed(i).replace(".",""))/Math.pow(10,i)}Zy.create=e=>{var t;return new Zy({checks:[],typeName:Uv.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...Ny(e)})};class Qy extends Ry{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==cy.number){const t=this._getOrReturnCtx(e);return gy(t,{code:ly.invalid_type,expected:cy.number,received:t.parsedType}),vy}let t;const n=new yy;for(const r of this._def.checks)"int"===r.kind?ay.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),gy(t,{code:ly.invalid_type,expected:"integer",received:"float",message:r.message}),n.dirty()):"min"===r.kind?(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),gy(t,{code:ly.too_small,minimum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty()):"max"===r.kind?(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),gy(t,{code:ly.too_big,maximum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty()):"multipleOf"===r.kind?0!==Jy(e.data,r.value)&&(t=this._getOrReturnCtx(e,t),gy(t,{code:ly.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):"finite"===r.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),gy(t,{code:ly.not_finite,message:r.message}),n.dirty()):ay.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,Oy.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Oy.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Oy.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Oy.toString(t))}setLimit(e,t,n,r){return new Qy({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Oy.toString(r)}]})}_addCheck(e){return new Qy({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:Oy.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:Oy.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:Oy.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:Oy.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:Oy.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Oy.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:Oy.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:Oy.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:Oy.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find((e=>"int"===e.kind||"multipleOf"===e.kind&&ay.isInteger(e.value)))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Qy.create=e=>new Qy({checks:[],typeName:Uv.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...Ny(e)});class Xy extends Ry{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==cy.bigint){const t=this._getOrReturnCtx(e);return gy(t,{code:ly.invalid_type,expected:cy.bigint,received:t.parsedType}),vy}let t;const n=new yy;for(const r of this._def.checks)"min"===r.kind?(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),gy(t,{code:ly.too_small,type:"bigint",minimum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty()):"max"===r.kind?(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),gy(t,{code:ly.too_big,type:"bigint",maximum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty()):"multipleOf"===r.kind?e.data%r.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),gy(t,{code:ly.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):ay.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,Oy.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Oy.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Oy.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Oy.toString(t))}setLimit(e,t,n,r){return new Xy({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Oy.toString(r)}]})}_addCheck(e){return new Xy({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:Oy.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:Oy.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:Oy.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:Oy.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Oy.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}Xy.create=e=>{var t;return new Xy({checks:[],typeName:Uv.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...Ny(e)})};class Yy extends Ry{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==cy.boolean){const t=this._getOrReturnCtx(e);return gy(t,{code:ly.invalid_type,expected:cy.boolean,received:t.parsedType}),vy}return wy(e.data)}}Yy.create=e=>new Yy({typeName:Uv.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...Ny(e)});class ev extends Ry{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==cy.date){const t=this._getOrReturnCtx(e);return gy(t,{code:ly.invalid_type,expected:cy.date,received:t.parsedType}),vy}if(isNaN(e.data.getTime()))return gy(this._getOrReturnCtx(e),{code:ly.invalid_date}),vy;const t=new yy;let n;for(const r of this._def.checks)"min"===r.kind?e.data.getTime()<r.value&&(n=this._getOrReturnCtx(e,n),gy(n,{code:ly.too_small,message:r.message,inclusive:!0,exact:!1,minimum:r.value,type:"date"}),t.dirty()):"max"===r.kind?e.data.getTime()>r.value&&(n=this._getOrReturnCtx(e,n),gy(n,{code:ly.too_big,message:r.message,inclusive:!0,exact:!1,maximum:r.value,type:"date"}),t.dirty()):ay.assertNever(r);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new ev({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:Oy.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:Oy.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}ev.create=e=>new ev({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:Uv.ZodDate,...Ny(e)});class tv extends Ry{_parse(e){if(this._getType(e)!==cy.symbol){const t=this._getOrReturnCtx(e);return gy(t,{code:ly.invalid_type,expected:cy.symbol,received:t.parsedType}),vy}return wy(e.data)}}tv.create=e=>new tv({typeName:Uv.ZodSymbol,...Ny(e)});class nv extends Ry{_parse(e){if(this._getType(e)!==cy.undefined){const t=this._getOrReturnCtx(e);return gy(t,{code:ly.invalid_type,expected:cy.undefined,received:t.parsedType}),vy}return wy(e.data)}}nv.create=e=>new nv({typeName:Uv.ZodUndefined,...Ny(e)});class rv extends Ry{_parse(e){if(this._getType(e)!==cy.null){const t=this._getOrReturnCtx(e);return gy(t,{code:ly.invalid_type,expected:cy.null,received:t.parsedType}),vy}return wy(e.data)}}rv.create=e=>new rv({typeName:Uv.ZodNull,...Ny(e)});class iv extends Ry{constructor(){super(...arguments),this._any=!0}_parse(e){return wy(e.data)}}iv.create=e=>new iv({typeName:Uv.ZodAny,...Ny(e)});class sv extends Ry{constructor(){super(...arguments),this._unknown=!0}_parse(e){return wy(e.data)}}sv.create=e=>new sv({typeName:Uv.ZodUnknown,...Ny(e)});class av extends Ry{_parse(e){const t=this._getOrReturnCtx(e);return gy(t,{code:ly.invalid_type,expected:cy.never,received:t.parsedType}),vy}}av.create=e=>new av({typeName:Uv.ZodNever,...Ny(e)});class ov extends Ry{_parse(e){if(this._getType(e)!==cy.undefined){const t=this._getOrReturnCtx(e);return gy(t,{code:ly.invalid_type,expected:cy.void,received:t.parsedType}),vy}return wy(e.data)}}ov.create=e=>new ov({typeName:Uv.ZodVoid,...Ny(e)});class cv extends Ry{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),r=this._def;if(t.parsedType!==cy.array)return gy(t,{code:ly.invalid_type,expected:cy.array,received:t.parsedType}),vy;if(null!==r.exactLength){const e=t.data.length>r.exactLength.value,i=t.data.length<r.exactLength.value;(e||i)&&(gy(t,{code:e?ly.too_big:ly.too_small,minimum:i?r.exactLength.value:void 0,maximum:e?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty())}if(null!==r.minLength&&t.data.length<r.minLength.value&&(gy(t,{code:ly.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),null!==r.maxLength&&t.data.length>r.maxLength.value&&(gy(t,{code:ly.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map(((e,n)=>r.type._parseAsync(new Py(t,e,t.path,n))))).then((e=>yy.mergeArray(n,e)));const i=[...t.data].map(((e,n)=>r.type._parseSync(new Py(t,e,t.path,n))));return yy.mergeArray(n,i)}get element(){return this._def.type}min(e,t){return new cv({...this._def,minLength:{value:e,message:Oy.toString(t)}})}max(e,t){return new cv({...this._def,maxLength:{value:e,message:Oy.toString(t)}})}length(e,t){return new cv({...this._def,exactLength:{value:e,message:Oy.toString(t)}})}nonempty(e){return this.min(1,e)}}function uv(e){if(e instanceof lv){const t={};for(const n in e.shape){const r=e.shape[n];t[n]=Av.create(uv(r))}return new lv({...e._def,shape:()=>t})}return e instanceof cv?new cv({...e._def,type:uv(e.element)}):e instanceof Av?Av.create(uv(e.unwrap())):e instanceof xv?xv.create(uv(e.unwrap())):e instanceof gv?gv.create(e.items.map((e=>uv(e)))):e}cv.create=(e,t)=>new cv({type:e,minLength:null,maxLength:null,exactLength:null,typeName:Uv.ZodArray,...Ny(t)});class lv extends Ry{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=ay.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==cy.object){const t=this._getOrReturnCtx(e);return gy(t,{code:ly.invalid_type,expected:cy.object,received:t.parsedType}),vy}const{status:t,ctx:n}=this._processInputParams(e),{shape:r,keys:i}=this._getCached(),s=[];if(!(this._def.catchall instanceof av&&"strip"===this._def.unknownKeys))for(const e in n.data)i.includes(e)||s.push(e);const a=[];for(const e of i){const t=r[e],i=n.data[e];a.push({key:{status:"valid",value:e},value:t._parse(new Py(n,i,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof av){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of s)a.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)s.length>0&&(gy(n,{code:ly.unrecognized_keys,keys:s}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of s){const r=n.data[t];a.push({key:{status:"valid",value:t},value:e._parse(new Py(n,r,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then((async()=>{const e=[];for(const t of a){const n=await t.key,r=await t.value;e.push({key:n,value:r,alwaysSet:t.alwaysSet})}return e})).then((e=>yy.mergeObjectSync(t,e))):yy.mergeObjectSync(t,a)}get shape(){return this._def.shape()}strict(e){return Oy.errToObj,new lv({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{var r,i,s,a;const o=null!==(s=null===(i=(r=this._def).errorMap)||void 0===i?void 0:i.call(r,t,n).message)&&void 0!==s?s:n.defaultError;return"unrecognized_keys"===t.code?{message:null!==(a=Oy.errToObj(e).message)&&void 0!==a?a:o}:{message:o}}}:{}})}strip(){return new lv({...this._def,unknownKeys:"strip"})}passthrough(){return new lv({...this._def,unknownKeys:"passthrough"})}extend(e){return new lv({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new lv({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:Uv.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new lv({...this._def,catchall:e})}pick(e){const t={};return ay.objectKeys(e).forEach((n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])})),new lv({...this._def,shape:()=>t})}omit(e){const t={};return ay.objectKeys(this.shape).forEach((n=>{e[n]||(t[n]=this.shape[n])})),new lv({...this._def,shape:()=>t})}deepPartial(){return uv(this)}partial(e){const t={};return ay.objectKeys(this.shape).forEach((n=>{const r=this.shape[n];e&&!e[n]?t[n]=r:t[n]=r.optional()})),new lv({...this._def,shape:()=>t})}required(e){const t={};return ay.objectKeys(this.shape).forEach((n=>{if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof Av;)e=e._def.innerType;t[n]=e}})),new lv({...this._def,shape:()=>t})}keyof(){return kv(ay.objectKeys(this.shape))}}lv.create=(e,t)=>new lv({shape:()=>e,unknownKeys:"strip",catchall:av.create(),typeName:Uv.ZodObject,...Ny(t)}),lv.strictCreate=(e,t)=>new lv({shape:()=>e,unknownKeys:"strict",catchall:av.create(),typeName:Uv.ZodObject,...Ny(t)}),lv.lazycreate=(e,t)=>new lv({shape:e,unknownKeys:"strip",catchall:av.create(),typeName:Uv.ZodObject,...Ny(t)});class hv extends Ry{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map((async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}}))).then((function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map((e=>new hy(e.ctx.common.issues)));return gy(t,{code:ly.invalid_union,unionErrors:n}),vy}));{let e;const r=[];for(const i of n){const n={...t,common:{...t.common,issues:[]},parent:null},s=i._parseSync({data:t.data,path:t.path,parent:n});if("valid"===s.status)return s;"dirty"!==s.status||e||(e={result:s,ctx:n}),n.common.issues.length&&r.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const i=r.map((e=>new hy(e)));return gy(t,{code:ly.invalid_union,unionErrors:i}),vy}}get options(){return this._def.options}}hv.create=(e,t)=>new hv({options:e,typeName:Uv.ZodUnion,...Ny(t)});const dv=e=>e instanceof bv?dv(e.schema):e instanceof Ov?dv(e.innerType()):e instanceof Ev?[e.value]:e instanceof Sv?e.options:e instanceof Tv?ay.objectValues(e.enum):e instanceof Pv?dv(e._def.innerType):e instanceof nv?[void 0]:e instanceof rv?[null]:e instanceof Av?[void 0,...dv(e.unwrap())]:e instanceof xv?[null,...dv(e.unwrap())]:e instanceof jv||e instanceof Dv?dv(e.unwrap()):e instanceof Cv?dv(e._def.innerType):[];class fv extends Ry{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==cy.object)return gy(t,{code:ly.invalid_type,expected:cy.object,received:t.parsedType}),vy;const n=this.discriminator,r=t.data[n],i=this.optionsMap.get(r);return i?t.common.async?i._parseAsync({data:t.data,path:t.path,parent:t}):i._parseSync({data:t.data,path:t.path,parent:t}):(gy(t,{code:ly.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),vy)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const r=new Map;for(const n of t){const t=dv(n.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const i of t){if(r.has(i))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(i)}`);r.set(i,n)}}return new fv({typeName:Uv.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:r,...Ny(n)})}}function pv(e,t){const n=uy(e),r=uy(t);if(e===t)return{valid:!0,data:e};if(n===cy.object&&r===cy.object){const n=ay.objectKeys(t),r=ay.objectKeys(e).filter((e=>-1!==n.indexOf(e))),i={...e,...t};for(const n of r){const r=pv(e[n],t[n]);if(!r.valid)return{valid:!1};i[n]=r.data}return{valid:!0,data:i}}if(n===cy.array&&r===cy.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let r=0;r<e.length;r++){const i=pv(e[r],t[r]);if(!i.valid)return{valid:!1};n.push(i.data)}return{valid:!0,data:n}}return n===cy.date&&r===cy.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}class mv extends Ry{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=(e,r)=>{if(by(e)||by(r))return vy;const i=pv(e.value,r.value);return i.valid?((Ey(e)||Ey(r))&&t.dirty(),{status:t.value,value:i.data}):(gy(n,{code:ly.invalid_intersection_types}),vy)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then((([e,t])=>r(e,t))):r(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}mv.create=(e,t,n)=>new mv({left:e,right:t,typeName:Uv.ZodIntersection,...Ny(n)});class gv extends Ry{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==cy.array)return gy(n,{code:ly.invalid_type,expected:cy.array,received:n.parsedType}),vy;if(n.data.length<this._def.items.length)return gy(n,{code:ly.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),vy;!this._def.rest&&n.data.length>this._def.items.length&&(gy(n,{code:ly.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const r=[...n.data].map(((e,t)=>{const r=this._def.items[t]||this._def.rest;return r?r._parse(new Py(n,e,n.path,t)):null})).filter((e=>!!e));return n.common.async?Promise.all(r).then((e=>yy.mergeArray(t,e))):yy.mergeArray(t,r)}get items(){return this._def.items}rest(e){return new gv({...this._def,rest:e})}}gv.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new gv({items:e,typeName:Uv.ZodTuple,rest:null,...Ny(t)})};class yv extends Ry{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==cy.object)return gy(n,{code:ly.invalid_type,expected:cy.object,received:n.parsedType}),vy;const r=[],i=this._def.keyType,s=this._def.valueType;for(const e in n.data)r.push({key:i._parse(new Py(n,e,n.path,e)),value:s._parse(new Py(n,n.data[e],n.path,e)),alwaysSet:e in n.data});return n.common.async?yy.mergeObjectAsync(t,r):yy.mergeObjectSync(t,r)}get element(){return this._def.valueType}static create(e,t,n){return new yv(t instanceof Ry?{keyType:e,valueType:t,typeName:Uv.ZodRecord,...Ny(n)}:{keyType:Zy.create(),valueType:e,typeName:Uv.ZodRecord,...Ny(t)})}}class vv extends Ry{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==cy.map)return gy(n,{code:ly.invalid_type,expected:cy.map,received:n.parsedType}),vy;const r=this._def.keyType,i=this._def.valueType,s=[...n.data.entries()].map((([e,t],s)=>({key:r._parse(new Py(n,e,n.path,[s,"key"])),value:i._parse(new Py(n,t,n.path,[s,"value"]))})));if(n.common.async){const e=new Map;return Promise.resolve().then((async()=>{for(const n of s){const r=await n.key,i=await n.value;if("aborted"===r.status||"aborted"===i.status)return vy;"dirty"!==r.status&&"dirty"!==i.status||t.dirty(),e.set(r.value,i.value)}return{status:t.value,value:e}}))}{const e=new Map;for(const n of s){const r=n.key,i=n.value;if("aborted"===r.status||"aborted"===i.status)return vy;"dirty"!==r.status&&"dirty"!==i.status||t.dirty(),e.set(r.value,i.value)}return{status:t.value,value:e}}}}vv.create=(e,t,n)=>new vv({valueType:t,keyType:e,typeName:Uv.ZodMap,...Ny(n)});class _v extends Ry{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==cy.set)return gy(n,{code:ly.invalid_type,expected:cy.set,received:n.parsedType}),vy;const r=this._def;null!==r.minSize&&n.data.size<r.minSize.value&&(gy(n,{code:ly.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),t.dirty()),null!==r.maxSize&&n.data.size>r.maxSize.value&&(gy(n,{code:ly.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),t.dirty());const i=this._def.valueType;function s(e){const n=new Set;for(const r of e){if("aborted"===r.status)return vy;"dirty"===r.status&&t.dirty(),n.add(r.value)}return{status:t.value,value:n}}const a=[...n.data.values()].map(((e,t)=>i._parse(new Py(n,e,n.path,t))));return n.common.async?Promise.all(a).then((e=>s(e))):s(a)}min(e,t){return new _v({...this._def,minSize:{value:e,message:Oy.toString(t)}})}max(e,t){return new _v({...this._def,maxSize:{value:e,message:Oy.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}_v.create=(e,t)=>new _v({valueType:e,minSize:null,maxSize:null,typeName:Uv.ZodSet,...Ny(t)});class wv extends Ry{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==cy.function)return gy(t,{code:ly.invalid_type,expected:cy.function,received:t.parsedType}),vy;function n(e,n){return my({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,py(),dy].filter((e=>!!e)),issueData:{code:ly.invalid_arguments,argumentsError:n}})}function r(e,n){return my({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,py(),dy].filter((e=>!!e)),issueData:{code:ly.invalid_return_type,returnTypeError:n}})}const i={errorMap:t.common.contextualErrorMap},s=t.data;if(this._def.returns instanceof Iv){const e=this;return wy((async function(...t){const a=new hy([]),o=await e._def.args.parseAsync(t,i).catch((e=>{throw a.addIssue(n(t,e)),a})),c=await Reflect.apply(s,this,o);return await e._def.returns._def.type.parseAsync(c,i).catch((e=>{throw a.addIssue(r(c,e)),a}))}))}{const e=this;return wy((function(...t){const a=e._def.args.safeParse(t,i);if(!a.success)throw new hy([n(t,a.error)]);const o=Reflect.apply(s,this,a.data),c=e._def.returns.safeParse(o,i);if(!c.success)throw new hy([r(o,c.error)]);return c.data}))}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new wv({...this._def,args:gv.create(e).rest(sv.create())})}returns(e){return new wv({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new wv({args:e||gv.create([]).rest(sv.create()),returns:t||sv.create(),typeName:Uv.ZodFunction,...Ny(n)})}}class bv extends Ry{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}bv.create=(e,t)=>new bv({getter:e,typeName:Uv.ZodLazy,...Ny(t)});class Ev extends Ry{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return gy(t,{received:t.data,code:ly.invalid_literal,expected:this._def.value}),vy}return{status:"valid",value:e.data}}get value(){return this._def.value}}function kv(e,t){return new Sv({values:e,typeName:Uv.ZodEnum,...Ny(t)})}Ev.create=(e,t)=>new Ev({value:e,typeName:Uv.ZodLiteral,...Ny(t)});class Sv extends Ry{constructor(){super(...arguments),Ay.set(this,void 0)}_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return gy(t,{expected:ay.joinValues(n),received:t.parsedType,code:ly.invalid_type}),vy}if(Ty(this,Ay,"f")||Iy(this,Ay,new Set(this._def.values),"f"),!Ty(this,Ay,"f").has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return gy(t,{received:t.data,code:ly.invalid_enum_value,options:n}),vy}return wy(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Sv.create(e,{...this._def,...t})}exclude(e,t=this._def){return Sv.create(this.options.filter((t=>!e.includes(t))),{...this._def,...t})}}Ay=new WeakMap,Sv.create=kv;class Tv extends Ry{constructor(){super(...arguments),xy.set(this,void 0)}_parse(e){const t=ay.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==cy.string&&n.parsedType!==cy.number){const e=ay.objectValues(t);return gy(n,{expected:ay.joinValues(e),received:n.parsedType,code:ly.invalid_type}),vy}if(Ty(this,xy,"f")||Iy(this,xy,new Set(ay.getValidEnumValues(this._def.values)),"f"),!Ty(this,xy,"f").has(e.data)){const e=ay.objectValues(t);return gy(n,{received:n.data,code:ly.invalid_enum_value,options:e}),vy}return wy(e.data)}get enum(){return this._def.values}}xy=new WeakMap,Tv.create=(e,t)=>new Tv({values:e,typeName:Uv.ZodNativeEnum,...Ny(t)});class Iv extends Ry{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==cy.promise&&!1===t.common.async)return gy(t,{code:ly.invalid_type,expected:cy.promise,received:t.parsedType}),vy;const n=t.parsedType===cy.promise?t.data:Promise.resolve(t.data);return wy(n.then((e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap}))))}}Iv.create=(e,t)=>new Iv({type:e,typeName:Uv.ZodPromise,...Ny(t)});class Ov extends Ry{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===Uv.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=this._def.effect||null,i={addIssue:e=>{gy(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(i.addIssue=i.addIssue.bind(i),"preprocess"===r.type){const e=r.transform(n.data,i);if(n.common.async)return Promise.resolve(e).then((async e=>{if("aborted"===t.value)return vy;const r=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===r.status?vy:"dirty"===r.status||"dirty"===t.value?_y(r.value):r}));{if("aborted"===t.value)return vy;const r=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===r.status?vy:"dirty"===r.status||"dirty"===t.value?_y(r.value):r}}if("refinement"===r.type){const e=e=>{const t=r.refinement(e,i);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const r=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===r.status?vy:("dirty"===r.status&&t.dirty(),e(r.value),{status:t.value,value:r.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((n=>"aborted"===n.status?vy:("dirty"===n.status&&t.dirty(),e(n.value).then((()=>({status:t.value,value:n.value}))))))}if("transform"===r.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!ky(e))return e;const s=r.transform(e.value,i);if(s instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:s}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((e=>ky(e)?Promise.resolve(r.transform(e.value,i)).then((e=>({status:t.value,value:e}))):e))}ay.assertNever(r)}}Ov.create=(e,t,n)=>new Ov({schema:e,typeName:Uv.ZodEffects,effect:t,...Ny(n)}),Ov.createWithPreprocess=(e,t,n)=>new Ov({schema:t,effect:{type:"preprocess",transform:e},typeName:Uv.ZodEffects,...Ny(n)});class Av extends Ry{_parse(e){return this._getType(e)===cy.undefined?wy(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Av.create=(e,t)=>new Av({innerType:e,typeName:Uv.ZodOptional,...Ny(t)});class xv extends Ry{_parse(e){return this._getType(e)===cy.null?wy(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}xv.create=(e,t)=>new xv({innerType:e,typeName:Uv.ZodNullable,...Ny(t)});class Pv extends Ry{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===cy.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Pv.create=(e,t)=>new Pv({innerType:e,typeName:Uv.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...Ny(t)});class Cv extends Ry{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Sy(r)?r.then((e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new hy(n.common.issues)},input:n.data})}))):{status:"valid",value:"valid"===r.status?r.value:this._def.catchValue({get error(){return new hy(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}Cv.create=(e,t)=>new Cv({innerType:e,typeName:Uv.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...Ny(t)});class Nv extends Ry{_parse(e){if(this._getType(e)!==cy.nan){const t=this._getOrReturnCtx(e);return gy(t,{code:ly.invalid_type,expected:cy.nan,received:t.parsedType}),vy}return{status:"valid",value:e.data}}}Nv.create=e=>new Nv({typeName:Uv.ZodNaN,...Ny(e)});const Rv=Symbol("zod_brand");class jv extends Ry{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class Lv extends Ry{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?vy:"dirty"===e.status?(t.dirty(),_y(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})();{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?vy:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new Lv({in:e,out:t,typeName:Uv.ZodPipeline})}}class Dv extends Ry{_parse(e){const t=this._def.innerType._parse(e),n=e=>(ky(e)&&(e.value=Object.freeze(e.value)),e);return Sy(t)?t.then((e=>n(e))):n(t)}unwrap(){return this._def.innerType}}function Mv(e,t={},n){return e?iv.create().superRefine(((r,i)=>{var s,a;if(!e(r)){const e="function"==typeof t?t(r):"string"==typeof t?{message:t}:t,o=null===(a=null!==(s=e.fatal)&&void 0!==s?s:n)||void 0===a||a,c="string"==typeof e?{message:e}:e;i.addIssue({code:"custom",...c,fatal:o})}})):iv.create()}Dv.create=(e,t)=>new Dv({innerType:e,typeName:Uv.ZodReadonly,...Ny(t)});const $v={object:lv.lazycreate};var Uv;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(Uv||(Uv={}));const Fv=Zy.create,Bv=Qy.create,Vv=Nv.create,zv=Xy.create,qv=Yy.create,Hv=ev.create,Kv=tv.create,Wv=nv.create,Gv=rv.create,Zv=iv.create,Jv=sv.create,Qv=av.create,Xv=ov.create,Yv=cv.create,e_=lv.create,t_=lv.strictCreate,n_=hv.create,r_=fv.create,i_=mv.create,s_=gv.create,a_=yv.create,o_=vv.create,c_=_v.create,u_=wv.create,l_=bv.create,h_=Ev.create,d_=Sv.create,f_=Tv.create,p_=Iv.create,m_=Ov.create,g_=Av.create,y_=xv.create,v_=Ov.createWithPreprocess,__=Lv.create,w_={string:e=>Zy.create({...e,coerce:!0}),number:e=>Qy.create({...e,coerce:!0}),boolean:e=>Yy.create({...e,coerce:!0}),bigint:e=>Xy.create({...e,coerce:!0}),date:e=>ev.create({...e,coerce:!0})},b_=vy;var E_=Object.freeze({__proto__:null,defaultErrorMap:dy,setErrorMap:function(e){fy=e},getErrorMap:py,makeIssue:my,EMPTY_PATH:[],addIssueToContext:gy,ParseStatus:yy,INVALID:vy,DIRTY:_y,OK:wy,isAborted:by,isDirty:Ey,isValid:ky,isAsync:Sy,get util(){return ay},get objectUtil(){return oy},ZodParsedType:cy,getParsedType:uy,ZodType:Ry,datetimeRegex:Gy,ZodString:Zy,ZodNumber:Qy,ZodBigInt:Xy,ZodBoolean:Yy,ZodDate:ev,ZodSymbol:tv,ZodUndefined:nv,ZodNull:rv,ZodAny:iv,ZodUnknown:sv,ZodNever:av,ZodVoid:ov,ZodArray:cv,ZodObject:lv,ZodUnion:hv,ZodDiscriminatedUnion:fv,ZodIntersection:mv,ZodTuple:gv,ZodRecord:yv,ZodMap:vv,ZodSet:_v,ZodFunction:wv,ZodLazy:bv,ZodLiteral:Ev,ZodEnum:Sv,ZodNativeEnum:Tv,ZodPromise:Iv,ZodEffects:Ov,ZodTransformer:Ov,ZodOptional:Av,ZodNullable:xv,ZodDefault:Pv,ZodCatch:Cv,ZodNaN:Nv,BRAND:Rv,ZodBranded:jv,ZodPipeline:Lv,ZodReadonly:Dv,custom:Mv,Schema:Ry,ZodSchema:Ry,late:$v,get ZodFirstPartyTypeKind(){return Uv},coerce:w_,any:Zv,array:Yv,bigint:zv,boolean:qv,date:Hv,discriminatedUnion:r_,effect:m_,enum:d_,function:u_,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>Mv((t=>t instanceof e),t),intersection:i_,lazy:l_,literal:h_,map:o_,nan:Vv,nativeEnum:f_,never:Qv,null:Gv,nullable:y_,number:Bv,object:e_,oboolean:()=>qv().optional(),onumber:()=>Bv().optional(),optional:g_,ostring:()=>Fv().optional(),pipeline:__,preprocess:v_,promise:p_,record:a_,set:c_,strictObject:t_,string:Fv,symbol:Kv,transformer:m_,tuple:s_,undefined:Wv,union:n_,unknown:Jv,void:Xv,NEVER:b_,ZodIssueCode:ly,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:hy});const k_={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let S_;const T_=new Uint8Array(16);function I_(){if(!S_&&(S_="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!S_))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return S_(T_)}const O_=[];for(let e=0;e<256;++e)O_.push((e+256).toString(16).slice(1));const A_=function(e,t,n){if(k_.randomUUID&&!t&&!e)return k_.randomUUID();const r=(e=e||{}).random||(e.rng||I_)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return function(e,t=0){return O_[e[t+0]]+O_[e[t+1]]+O_[e[t+2]]+O_[e[t+3]]+"-"+O_[e[t+4]]+O_[e[t+5]]+"-"+O_[e[t+6]]+O_[e[t+7]]+"-"+O_[e[t+8]]+O_[e[t+9]]+"-"+O_[e[t+10]]+O_[e[t+11]]+O_[e[t+12]]+O_[e[t+13]]+O_[e[t+14]]+O_[e[t+15]]}(r)};class x_{}class P_ extends x_{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,sg(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"true"!==Ng("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.awaitHandlers=e._awaitHandler??this.awaitHandlers)}copy(){return new this.constructor(this)}toJSON(){return ag.prototype.toJSON.call(this)}toJSONNotImplemented(){return ag.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends P_{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:A_()}),Object.assign(this,e)}}}}var C_=i(749);function N_(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}class R_ extends P_{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){const t=function(e,t,n){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${r}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),n={...e};if(void 0!==n.parent_run_id){const e=this.runMap.get(n.parent_run_id);e&&(this._addChildRun(e,n),e.child_execution_order=Math.max(e.child_execution_order,n.child_execution_order),n.trace_id=e.trace_id,void 0!==e.dotted_order&&(n.dotted_order=[e.dotted_order,t].join(".")))}else n.trace_id=n.id,n.dotted_order=t;this.runMap.set(n.id,n),await(this.onRunCreate?.(n))}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,n,r,i,s,a,o){const c=this._getExecutionOrder(r),u=Date.now(),l=a?{...i,metadata:a}:i,h={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:l??{},tags:s||[]};return await this._startTrace(h),await(this.onLLMStart?.(h)),h}async handleChatModelStart(e,t,n,r,i,s,a,o){const c=this._getExecutionOrder(r),u=Date.now(),l=a?{...i,metadata:a}:i,h={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:l??{},tags:s||[]};return await this._startTrace(h),await(this.onLLMStart?.(h)),h}async handleLLMEnd(e,t){const n=this.runMap.get(t);if(!n||"llm"!==n?.run_type)throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.outputs=e,n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onLLMEnd?.(n)),await this._endTrace(n),n}async handleLLMError(e,t){const n=this.runMap.get(t);if(!n||"llm"!==n?.run_type)throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onLLMError?.(n)),await this._endTrace(n),n}async handleChainStart(e,t,n,r,i,s,a,o){const c=this._getExecutionOrder(r),u=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:a??"chain",child_runs:[],extra:s?{metadata:s}:{},tags:i||[]};return await this._startTrace(l),await(this.onChainStart?.(l)),l}async handleChainEnd(e,t,n,r,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=N_(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),void 0!==i?.inputs&&(s.inputs=N_(i.inputs,"input")),await(this.onChainEnd?.(s)),await this._endTrace(s),s}async handleChainError(e,t,n,r,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),void 0!==i?.inputs&&(s.inputs=N_(i.inputs,"input")),await(this.onChainError?.(s)),await this._endTrace(s),s}async handleToolStart(e,t,n,r,i,s,a){const o=this._getExecutionOrder(r),c=Date.now(),u={id:n,name:a??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:s?{metadata:s}:{},tags:i||[]};return await this._startTrace(u),await(this.onToolStart?.(u)),u}async handleToolEnd(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onToolEnd?.(n)),await this._endTrace(n),n}async handleToolError(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onToolError?.(n)),await this._endTrace(n),n}async handleAgentAction(e,t){const n=this.runMap.get(t);if(!n||"chain"!==n?.run_type)return;const r=n;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(n))}async handleAgentEnd(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(n)))}async handleRetrieverStart(e,t,n,r,i,s,a){const o=this._getExecutionOrder(r),c=Date.now(),u={id:n,name:a??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:s?{metadata:s}:{},tags:i||[]};return await this._startTrace(u),await(this.onRetrieverStart?.(u)),u}async handleRetrieverEnd(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverEnd?.(n)),await this._endTrace(n),n}async handleRetrieverError(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverError?.(n)),await this._endTrace(n),n}async handleText(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(n)))}async handleLLMNewToken(e,t,n,r,i,s){const a=this.runMap.get(n);if(!a||"llm"!==a?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return a.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:s?.chunk}}),await(this.onLLMNewToken?.(a,e,{chunk:s?.chunk})),a}}function j_(e,t){return`${e.open}${t}${e.close}`}function L_(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function D_(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:M_}=C_;class $_ extends R_{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let n=e;for(;n.parent_run_id;){const e=this.runMap.get(n.parent_run_id);if(!e)break;t.push(e),n=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,n)=>{const r=`${e.execution_order}:${e.run_type}:${e.name}`;return t===n.length-1?j_(C_.bold,r):r})).join(" > ");return j_(M_.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${j_(M_.green,"[chain/start]")} [${t}] Entering Chain run with input: ${L_(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${j_(M_.cyan,"[chain/end]")} [${t}] [${D_(e)}] Exiting Chain run with output: ${L_(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${j_(M_.red,"[chain/error]")} [${t}] [${D_(e)}] Chain run errored with error: ${L_(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${j_(M_.green,"[llm/start]")} [${t}] Entering LLM run with input: ${L_(n,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${j_(M_.cyan,"[llm/end]")} [${t}] [${D_(e)}] Exiting LLM run with output: ${L_(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${j_(M_.red,"[llm/error]")} [${t}] [${D_(e)}] LLM run errored with error: ${L_(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${j_(M_.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${j_(M_.cyan,"[tool/end]")} [${t}] [${D_(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${j_(M_.red,"[tool/error]")} [${t}] [${D_(e)}] Tool run errored with error: ${L_(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${j_(M_.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${L_(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${j_(M_.cyan,"[retriever/end]")} [${t}] [${D_(e)}] Exiting Retriever run with output: ${L_(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${j_(M_.red,"[retriever/error]")} [${t}] [${D_(e)}] Retriever run errored with error: ${L_(e.error,"[error]")}`)}onAgentAction(e){const t=e,n=this.getBreadcrumbs(e);console.log(`${j_(M_.blue,"[agent/action]")} [${n}] Agent selected action: ${L_(t.actions[t.actions.length-1],"[action]")}`)}}const U_=[400,401,403,404,405,406,407,408],F_=[409];class B_{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.queue=new Wg.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const n=this.onFailedResponseHook;return this.queue.add((()=>Kg((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response,r=t?.status;if(r){if(U_.includes(+r))throw e;if(F_.includes(+r))return;n&&await n(t)}},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}function V_(e){return"function"==typeof e?._getType}function z_(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}let q_;const H_=()=>"undefined"!=typeof Deno;let K_,W_;function G_(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}const Z_=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,J_=function(e){return"string"==typeof e&&Z_.test(e)};function Q_(e){if(!J_(e))throw new Error(`Invalid UUID: ${e}`)}async function X_(e){const t=await async function(){if(void 0===K_){const e=q_||(q_="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||H_()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":H_()?"deno":"other":"node",q_),t=function(){if(void 0!==W_)return W_;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const n of e){const e=G_(n);void 0!==e&&(t[n]=e)}return W_=t,t}();K_={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:iw,...t}}return K_}(),n=function(){const e=function(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce(((e,[t,n])=>(e[t]=String(n),e)),{}):void 0}catch(e){return}}()||{},t={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[r,i]of Object.entries(e))!r.startsWith("LANGCHAIN_")||"string"!=typeof i||n.includes(r)||r.toLowerCase().includes("key")||r.toLowerCase().includes("secret")||r.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===r?t.revision_id=i:t[r]=i);return t}();return e.map((e=>{const r=e.extra??{},i=r.metadata;return e.extra={...r,runtime:{...t,...r?.runtime},metadata:{...n,...n.revision_id||e.revision_id?{revision_id:e.revision_id??n.revision_id}:{},...i}},e}))}const Y_=async(e,t)=>{const n=await e.text();if(!e.ok)throw new Error(`Failed to ${t}: ${e.status} ${e.statusText} ${n}`)};function ew(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const tw=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise((e=>setTimeout(e,t))),!0}return!1};class nw{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise((t=>{this.items.push([e,t])}))}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");const t=[];for(;t.length<e&&this.items.length;){const e=this.items.shift();if(!e)break;t.push(e)}return[t.map((e=>e[0])),()=>t.forEach((e=>e[1]()))]}}class rw{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new nw}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=rw.getDefaultClientConfig();this.tracingSampleRate=(()=>{const e=G_("LANGCHAIN_TRACING_SAMPLING_RATE");if(void 0===e)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t})(),this.apiUrl=ew(e.apiUrl??t.apiUrl)??"",this.apiKey=ew(e.apiKey??t.apiKey),this.webUrl=ew(e.webUrl??t.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new B_(e.callerOptions??{}),this.batchIngestCaller=new B_({...e.callerOptions??{},onFailedResponseHook:tw}),this.hideInputs=e.hideInputs??t.hideInputs,this.hideOutputs=e.hideOutputs??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){const e=G_("LANGCHAIN_API_KEY");return{apiUrl:G_("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===G_("LANGCHAIN_HIDE_INPUTS"),hideOutputs:"true"===G_("LANGCHAIN_HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(e=>{const t=this.apiUrl.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t})()?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${iw}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const n=t?.toString()??"",r=`${this.apiUrl}${e}?${n}`,i=await this.caller.call(fetch,r,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);return i}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let n=Number(t.get("offset"))||0;const r=Number(t.get("limit"))||100;for(;;){t.set("offset",String(n)),t.set("limit",String(r));const i=`${this.apiUrl}${e}?${t}`,s=await this.caller.call(fetch,i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);const a=await s.json();if(0===a.length)break;if(yield a,a.length<r)break;n+=a.length}}async*_getCursorPaginatedList(e,t=null,n="POST",r="runs"){const i=t?{...t}:{};for(;;){const t=await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(i)}),s=await t.json();if(!s)break;if(!s[r])break;yield s[r];const a=s.cursors;if(!a)break;if(!a.next)break;i.cursor=a.next}}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const n of e)this.sampledPostUuids.has(n.id)&&(t.push(n),this.sampledPostUuids.delete(n.id));return t}{const t=[];for(const n of e)Math.random()<this.tracingSampleRate&&(t.push(n),this.sampledPostUuids.add(n.id));return t}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){const[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length)return void t();try{await this.batchIngestRuns({runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))})}finally{t()}}}async processRunOperation(e,t){const n=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;const r=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)}),n?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),r}async _getServerInfo(){const e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch(e){return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},n=e.project_name;delete e.project_name;const r=this.prepareRunCreateOrUpdateInputs({session_name:n,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void this.processRunOperation({action:"create",item:r}).catch(console.error);const i=await X_([r]),s=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(i[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Y_(s,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let n=e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[],r=t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[];if(n.length>0&&r.length>0){const e=n.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const n of r)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);n=Object.values(e),r=t}const i={post:this._filterForSampling(n),patch:this._filterForSampling(r,!0)};if(!i.post.length&&!i.patch.length)return;if(n=await X_(n),void 0===this.batchEndpointSupported&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(const e of i.post)await this.createRun(e);for(const e of i.patch)void 0!==e.id&&await this.updateRun(e.id,e);return}const s=this.serverInfo?.batch_ingest_config?.size_limit_bytes??20971520,a={post:[],patch:[]};let o=0;for(const e of["post","patch"]){const t=e,n=i[t].reverse();let r=n.pop();for(;void 0!==r;){const e=JSON.stringify(r);o>0&&o+e.length>s&&(await this._postBatchIngestRuns(JSON.stringify(a)),o=0,a.post=[],a.patch=[]),o+=e.length,a[t].push(r),r=n.pop()}}(a.post.length>0||a.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(a))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},n=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Y_(n,"batch create run")}async updateRun(e,t){Q_(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const n={...t,id:e};if(!this._filterForSampling([n],!0).length)return;if(this.autoBatchTracing&&void 0!==n.trace_id&&void 0!==n.dotted_order)return void 0!==t.end_time&&void 0===n.parent_run_id?void await this.processRunOperation({action:"update",item:n},!0):void this.processRunOperation({action:"update",item:n}).catch(console.error);const r={...this.headers,"Content-Type":"application/json"},i=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:r,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Y_(i,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){Q_(e);let n=await this._get(`/runs/${e}`);return t&&n.child_run_ids&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(void 0!==t){let e;e=t.session_id?t.session_id:n?.projectName?(await this.readProject({projectName:n?.projectName})).id:n?.projectId?n?.projectId:(await this.readProject({projectName:G_("LANGCHAIN_PROJECT")||"default"})).id;const r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const n of e)t.push(n);return t}(this.listRuns({id:e.child_run_ids})),n={},r={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in n||(n[e.parent_run_id]=[]),n[e.parent_run_id].push(e),r[e.id]=e}e.child_runs=n[e.id]||[];for(const t in n)t!==e.id&&(r[t].child_runs=n[t]);return e}async*listRuns(e){const{projectId:t,projectName:n,parentRunId:r,traceId:i,referenceExampleId:s,startTime:a,executionOrder:o,isRoot:c,runType:u,error:l,id:h,query:d,filter:f,traceFilter:p,treeFilter:m,limit:g,select:y}=e;let v=[];if(t&&(v=Array.isArray(t)?t:[t]),n){const e=Array.isArray(n)?n:[n],t=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));v.push(...t)}const _={session:v.length?v:null,run_type:u,reference_example:s,query:d,filter:f,trace_filter:p,tree_filter:m,execution_order:o,parent_run:r,start_time:a?a.toISOString():null,error:l,id:h,limit:g,trace:i,select:y||["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:c};let w=0;for await(const e of this._getCursorPaginatedList("/runs/query",_))if(g){if(w>=g)break;if(e.length+w>g){const t=e.slice(0,g-w);yield*t;break}w+=e.length,yield*e}else yield*e}async shareRun(e,{shareId:t}={}){const n={run_id:e,share_token:t||A_()};Q_(e);const r=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await r.json();if(null===i||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){Q_(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Y_(t,"unshare run")}async readRunSharedLink(e){Q_(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await t.json();if(null!==n&&"share_token"in n)return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const n=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)n.append("id",e);Q_(e);const r=await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await r.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),Q_(e);const n=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await n.json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const n={dataset_id:e};Q_(e);const r=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await r.json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async unshareDataset(e){Q_(e);const t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Y_(t,"unshare dataset")}async readSharedDataset(e){Q_(e);const t=await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:r=!1,projectExtra:i=null,referenceDatasetId:s=null}){const a=r?"?upsert=true":"",o=`${this.apiUrl}/sessions${a}`,c=i||{};n&&(c.metadata=n);const u={name:e,extra:c,description:t};null!==s&&(u.reference_dataset_id=s);const l=await this.caller.call(fetch,o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),h=await l.json();if(!l.ok)throw new Error(`Failed to create session ${e}: ${l.status} ${l.statusText}`);return h}async updateProject(e,{name:t=null,description:n=null,metadata:r=null,projectExtra:i=null,endTime:s=null}){const a=`${this.apiUrl}/sessions/${e}`;let o=i;r&&(o={...o||{},metadata:r});const c={name:t,extra:o,description:n,end_time:s?new Date(s).toISOString():null},u=await this.caller.call(fetch,a,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),l=await u.json();if(!u.ok)throw new Error(`Failed to update project ${e}: ${u.status} ${u.statusText}`);return l}async hasProject({projectId:e,projectName:t}){let n="/sessions";const r=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)Q_(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");r.append("name",t)}const i=await this.caller.call(fetch,`${this.apiUrl}${n}?${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const e=await i.json();return!!i.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let r="/sessions";const i=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)Q_(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");i.append("name",t)}void 0!==n&&i.append("include_stats",n.toString());const s=await this._get(r,i);let a;if(Array.isArray(s)){if(0===s.length)throw new Error(`Project[id=${e}, name=${t}] not found`);a=s[0]}else a=s;return a}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/datasets/${n.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:r,referenceDatasetName:i,referenceFree:s}={}){const a=new URLSearchParams;if(void 0!==e)for(const t of e)a.append("id",t);if(void 0!==t&&a.append("name",t),void 0!==n&&a.append("name_contains",n),void 0!==r)a.append("reference_dataset",r);else if(void 0!==i){const e=await this.readDataset({datasetName:i});a.append("reference_dataset",e.id)}void 0!==s&&a.append("reference_free",s.toString());for await(const e of this._getPaginated("/sessions",a))yield*e}async deleteProject({projectId:e,projectName:t}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");n=void 0===e?(await this.readProject({projectName:t})).id:e,Q_(n);const r=await this.caller.call(fetch,`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Y_(r,`delete session ${n} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:r,description:i,dataType:s,name:a}){const o=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),n.forEach((e=>{c.append("input_keys",e)})),r.forEach((e=>{c.append("output_keys",e)})),i&&c.append("description",i),s&&c.append("data_type",s),a&&c.append("name",a);const u=await this.caller.call(fetch,o,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!u.ok){const e=await u.json();if(e.detail&&e.detail.includes("already exists"))throw new Error(`Dataset ${t} already exists`);throw new Error(`Failed to upload CSV: ${u.status} ${u.statusText}`)}return await u.json()}async createDataset(e,{description:t,dataType:n}={}){const r={name:e,description:t};n&&(r.data_type=n);const i=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok){const t=await i.json();if(t.detail&&t.detail.includes("already exists"))throw new Error(`Dataset ${e} already exists`);throw new Error(`Failed to create dataset ${i.status} ${i.statusText}`)}return await i.json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets";const r=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)Q_(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");r.append("name",t)}const i=await this._get(n,r);let s;if(Array.isArray(i)){if(0===i.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);s=i[0]}else s=i;return s}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:r}){let i=e;if(void 0===i&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==i&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");void 0===i&&(i=(await this.readDataset({datasetName:t})).id);const s=new URLSearchParams({from_version:"string"==typeof n?n:n.toISOString(),to_version:"string"==typeof r?r:r.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,s)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const n=await this._getResponse(`/datasets/${e}/openai_ft`);return(await n.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:r,datasetNameContains:i}={}){const s=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==n)for(const e of n)s.append("id",e);void 0!==r&&s.append("name",r),void 0!==i&&s.append("name_contains",i);for await(const e of this._getPaginated("/datasets",s))yield*e}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",r=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(r=(await this.readDataset({datasetName:t})).id),void 0===r)throw new Error("Must provide datasetName or datasetId");Q_(r),n+=`/${r}`;const i=await this.caller.call(fetch,this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to delete ${n}: ${i.status} ${i.statusText}`);await i.json()}async createExample(e,t,{datasetId:n,datasetName:r,createdAt:i,exampleId:s,metadata:a,split:o}){let c=n;if(void 0===c&&void 0===r)throw new Error("Must provide either datasetName or datasetId");if(void 0!==c&&void 0!==r)throw new Error("Must provide either datasetName or datasetId, not both");void 0===c&&(c=(await this.readDataset({datasetName:r})).id);const u=i||new Date,l={dataset_id:c,inputs:e,outputs:t,created_at:u?.toISOString(),id:s,metadata:a,split:o},h=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!h.ok)throw new Error(`Failed to create example: ${h.status} ${h.statusText}`);return await h.json()}async createExamples(e){const{inputs:t,outputs:n,metadata:r,sourceRunIds:i,exampleIds:s,datasetId:a,datasetName:o}=e;let c=a;if(void 0===c&&void 0===o)throw new Error("Must provide either datasetName or datasetId");if(void 0!==c&&void 0!==o)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===c){const e=await this.readDataset({datasetName:o});c=e.id}const u=t.map(((t,a)=>({dataset_id:c,inputs:t,outputs:n?n[a]:void 0,metadata:r?r[a]:void 0,split:e.splits?e.splits[a]:void 0,id:s?s[a]:void 0,source_run_id:i?i[a]:void 0}))),l=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!l.ok)throw new Error(`Failed to create examples: ${l.status} ${l.statusText}`);return await l.json()}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){const r=e.map((e=>V_(e)?z_(e):e)),i=V_(t)?z_(t):t;return this.createExample({input:r},{output:i},n)}async readExample(e){Q_(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:r,splits:i,inlineS3Urls:s,metadata:a}={}){let o;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)o=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");o=(await this.readDataset({datasetName:t})).id}const c=new URLSearchParams({dataset:o}),u=r?"string"==typeof r?r:r?.toISOString():void 0;u&&c.append("as_of",u);const l=s??!0;if(c.append("inline_s3_urls",l.toString()),void 0!==n)for(const e of n)c.append("id",e);if(void 0!==i)for(const e of i)c.append("splits",e);if(void 0!==a){const e=JSON.stringify(a);c.append("metadata",e)}for await(const e of this._getPaginated("/examples",c))yield*e}async deleteExample(e){Q_(e);const t=`/examples/${e}`,n=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to delete ${t}: ${n.status} ${n.statusText}`);await n.json()}async updateExample(e,t){Q_(e);const n=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to update example ${e}: ${n.status} ${n.statusText}`);return await n.json()}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:r,referenceExample:i}={loadChildRuns:!1}){let s;if("string"==typeof e)s=await this.readRun(e,{loadChildRuns:r});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);s=e}null!==s.reference_example_id&&void 0!==s.reference_example_id&&(i=await this.readExample(s.reference_example_id));const a=await t.evaluateRun(s,i);let o=n??{};a.evaluatorInfo&&(o={...o,...a.evaluatorInfo});const c=a.targetRunId??s.id;return await this.createFeedback(c,a.key,{score:a?.score,value:a?.value,comment:a?.comment,correction:a?.correction,sourceInfo:o,feedbackSourceType:"model",sourceRunId:a?.sourceRunId})}async createFeedback(e,t,{score:n,value:r,correction:i,comment:s,sourceInfo:a,feedbackSourceType:o="api",sourceRunId:c,feedbackId:u,feedbackConfig:l,projectId:h,comparativeExperimentId:d}){if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const f={type:o??"api",metadata:a??{}};void 0===c||void 0===f?.metadata||f.metadata.__run||(f.metadata.__run={run_id:c}),void 0!==f?.metadata&&void 0!==f.metadata.__run?.run_id&&Q_(f.metadata.__run.run_id);const p={id:u??A_(),run_id:e,key:t,score:n,value:r,correction:i,comment:s,feedback_source:f,comparative_experiment_id:d,feedbackConfig:l,session_id:h},m=`${this.apiUrl}/feedback`,g=await this.caller.call(fetch,m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(p),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Y_(g,"create feedback"),p}async updateFeedback(e,{score:t,value:n,correction:r,comment:i}){const s={};null!=t&&(s.score=t),null!=n&&(s.value=n),null!=r&&(s.correction=r),null!=i&&(s.comment=i),Q_(e);const a=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Y_(a,"update feedback")}async readFeedback(e){Q_(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){Q_(e);const t=`/feedback/${e}`,n=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to delete ${t}: ${n.status} ${n.statusText}`);await n.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){const r=new URLSearchParams;if(e&&r.append("run",e.join(",")),t)for(const e of t)r.append("key",e);if(n)for(const e of n)r.append("source",e);for await(const e of this._getPaginated("/feedback",r))yield*e}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:r}={}){const i={run_id:e,feedback_key:t,feedback_config:r};n?"string"==typeof n?i.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(i.expires_in=n):i.expires_in={hours:3};const s=await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await s.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:r,description:i,metadata:s,id:a}){if(0===t.length)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!n)throw new Error("A reference dataset is required");const o={id:a,name:e,experiment_ids:t,reference_dataset_id:n,description:i,created_at:(r??new Date)?.toISOString(),extra:{}};s&&(o.extra.metadata=s);const c=await this.caller.call(fetch,`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await c.json()}async*listPresignedFeedbackTokens(e){Q_(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:[e],t}async logEvaluationFeedback(e,t,n){const r=this._selectEvalResults(e);for(const e of r){let r=n||{};e.evaluatorInfo&&(r={...e.evaluatorInfo,...r});let i=null;e.targetRunId?i=e.targetRunId:t&&(i=t.id),await this.createFeedback(i,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:r,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"})}return r}}const iw="0.1.30";class sw extends R_{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:n,client:r}=e;this.projectName=n??Ng("LANGCHAIN_PROJECT")??Ng("LANGCHAIN_SESSION"),this.exampleId=t,this.client=r??new rw({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Cg()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}}let aw;async function ow(e,t){!0===t?await e():(void 0===aw&&(aw=new(0,Wg.default)({autoStart:!0,concurrency:1})),aw.add(e))}"true"===Ng("LANGCHAIN_TRACING_V2")&&"true"!==Ng("LANGCHAIN_CALLBACKS_BACKGROUND")&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join("\n");class cw{setHandler(e){return this.setHandlers([e])}}class uw{constructor(e,t,n,r,i,s,a,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}async handleText(e){await Promise.all(this.handlers.map((t=>ow((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleText: ${e}`)}}),t.awaitHandlers))))}}class lw extends uw{getChild(e){const t=new pw(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>ow((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>ow((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${e}`)}}),t.awaitHandlers))))}}class hw extends uw{async handleLLMNewToken(e,t,n,r,i,s){await Promise.all(this.handlers.map((n=>ow((async()=>{if(!n.ignoreLLM)try{await(n.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,s))}catch(e){console.error(`Error in handler ${n.constructor.name}, handleLLMNewToken: ${e}`)}}),n.awaitHandlers))))}async handleLLMError(e){await Promise.all(this.handlers.map((t=>ow((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`)}}),t.awaitHandlers))))}async handleLLMEnd(e){await Promise.all(this.handlers.map((t=>ow((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`)}}),t.awaitHandlers))))}}class dw extends uw{getChild(e){const t=new pw(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,r,i){await Promise.all(this.handlers.map((t=>ow((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,i))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${e}`)}}),t.awaitHandlers))))}async handleChainEnd(e,t,n,r,i){await Promise.all(this.handlers.map((t=>ow((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,i))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`)}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>ow((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`)}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>ow((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`)}}),t.awaitHandlers))))}}class fw extends uw{getChild(e){const t=new pw(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>ow((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${e}`)}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>ow((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`)}}),t.awaitHandlers))))}}class pw extends cw{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,n=void 0,r=void 0,i=void 0,s=void 0,a=void 0,o=void 0){return Promise.all(t.map((async(t,r)=>{const s=0===r&&n?n:A_();return await Promise.all(this.handlers.map((n=>ow((async()=>{if(!n.ignoreLLM)try{await(n.handleLLMStart?.(e,[t],s,this._parentRunId,i,this.tags,this.metadata,o))}catch(e){console.error(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`)}}),n.awaitHandlers)))),new hw(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,t,n=void 0,r=void 0,i=void 0,s=void 0,a=void 0,o=void 0){return Promise.all(t.map((async(t,r)=>{const s=0===r&&n?n:A_();return await Promise.all(this.handlers.map((n=>ow((async()=>{if(!n.ignoreLLM)try{if(n.handleChatModelStart)await(n.handleChatModelStart?.(e,[t],s,this._parentRunId,i,this.tags,this.metadata,o));else if(n.handleLLMStart){const r=Sg(t);await(n.handleLLMStart?.(e,[r],s,this._parentRunId,i,this.tags,this.metadata,o))}}catch(e){console.error(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`)}}),n.awaitHandlers)))),new hw(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,t,n=A_(),r=void 0,i=void 0,s=void 0,a=void 0){return await Promise.all(this.handlers.map((i=>ow((async()=>{if(!i.ignoreChain)try{await(i.handleChainStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,r,a))}catch(e){console.error(`Error in handler ${i.constructor.name}, handleChainStart: ${e}`)}}),i.awaitHandlers)))),new dw(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,n=A_(),r=void 0,i=void 0,s=void 0,a=void 0){return await Promise.all(this.handlers.map((r=>ow((async()=>{if(!r.ignoreAgent)try{await(r.handleToolStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,a))}catch(e){console.error(`Error in handler ${r.constructor.name}, handleToolStart: ${e}`)}}),r.awaitHandlers)))),new fw(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,n=A_(),r=void 0,i=void 0,s=void 0,a=void 0){return await Promise.all(this.handlers.map((r=>ow((async()=>{if(!r.ignoreRetriever)try{await(r.handleRetrieverStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,a))}catch(e){console.error(`Error in handler ${r.constructor.name}, handleRetrieverStart: ${e}`)}}),r.awaitHandlers)))),new lw(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const n=new pw(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);n.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);n.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);n.addMetadata({[e]:this.metadata[e]},t)}for(const r of e)n.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===r.name))||n.addHandler(r,t);return n}static fromHandlers(e){const t=new this;return t.addHandler(new class extends P_{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:A_()}),Object.assign(this,e)}}),t}static async configure(e,t,n,r,i,s,a){let o;(e||t)&&(Array.isArray(e)||!e?(o=new pw,o.setHandlers(e?.map(mw)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(mw):t?.handlers,!1));const c="true"===Ng("LANGCHAIN_VERBOSE")||a?.verbose,u="true"===Ng("LANGCHAIN_TRACING_V2"),l=u||(Ng("LANGCHAIN_TRACING")??!1);if(c||l){if(o||(o=new pw),c&&!o.handlers.some((e=>e.name===$_.prototype.name))){const e=new $_;o.addHandler(e,!0)}l&&!o.handlers.some((e=>"langchain_tracer"===e.name))&&u&&o.addHandler(await async function(){return new sw}(),!0)}return(n||r)&&o&&(o.addTags(n??[]),o.addTags(r??[],!1)),(i||s)&&o&&(o.addMetadata(i??{}),o.addMetadata(s??{},!1)),o}}function mw(e){return"name"in e?e:P_.fromMethods(e)}const gw=Object.prototype.hasOwnProperty;function yw(e,t){return gw.call(e,t)}function vw(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let n in e)yw(e,n)&&t.push(n);return t}function _w(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function ww(e){let t=0;const n=e.length;let r;for(;t<n;){if(r=e.charCodeAt(t),!(r>=48&&r<=57))return!1;t++}return!0}function bw(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function Ew(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function kw(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(kw(e[t]))return!0}else if("object"==typeof e){const n=vw(e),r=n.length;for(var t=0;t<r;t++)if(kw(e[n[t]]))return!0}return!1}function Sw(e,t){const n=[e];for(const e in t){const r="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==r&&n.push(`${e}: ${r}`)}return n.join("\n")}class Tw extends Error{constructor(e,t,n,r,i){super(Sw(e,{name:t,index:n,operation:r,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=Sw(e,{name:t,index:n,operation:r,tree:i})}}const Iw=Tw,Ow=_w,Aw={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){let r=Pw(n,this.path);r&&(r=_w(r));const i=Cw(n,{op:"remove",path:this.from}).removed;return Cw(n,{op:"add",path:this.path,value:i}),{newDocument:n,removed:r}},copy:function(e,t,n){const r=Pw(n,this.from);return Cw(n,{op:"add",path:this.path,value:_w(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:Dw(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}};var xw={add:function(e,t,n){return ww(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){return{newDocument:n,removed:e.splice(t,1)[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:Aw.move,copy:Aw.copy,test:Aw.test,_get:Aw._get};function Pw(e,t){if(""==t)return e;var n={op:"_get",path:t};return Cw(e,n),n.value}function Cw(e,t,n=!1,r=!0,i=!0,s=0){if(n&&("function"==typeof n?n(t,0,e,t.path):jw(t,0)),""===t.path){let r={newDocument:e};if("add"===t.op)return r.newDocument=t.value,r;if("replace"===t.op)return r.newDocument=t.value,r.removed=e,r;if("move"===t.op||"copy"===t.op)return r.newDocument=Pw(e,t.from),"move"===t.op&&(r.removed=e),r;if("test"===t.op){if(r.test=Dw(e,t.value),!1===r.test)throw new Iw("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return r.newDocument=e,r}if("remove"===t.op)return r.removed=e,r.newDocument=null,r;if("_get"===t.op)return t.value=e,r;if(n)throw new Iw("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,t,e);return r}{r||(e=_w(e));const a=(t.path||"").split("/");let o,c,u,l=e,h=1,d=a.length;for(u="function"==typeof n?n:jw;;){if(c=a[h],c&&-1!=c.indexOf("~")&&(c=Ew(c)),i&&("__proto__"==c||"prototype"==c&&h>0&&"constructor"==a[h-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&void 0===o&&(void 0===l[c]?o=a.slice(0,h).join("/"):h==d-1&&(o=t.path),void 0!==o&&u(t,0,e,o)),h++,Array.isArray(l)){if("-"===c)c=l.length;else{if(n&&!ww(c))throw new Iw("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,t,e);ww(c)&&(c=~~c)}if(h>=d){if(n&&"add"===t.op&&c>l.length)throw new Iw("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,t,e);const r=xw[t.op].call(t,l,c,e);if(!1===r.test)throw new Iw("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return r}}else if(h>=d){const n=Aw[t.op].call(t,l,c,e);if(!1===n.test)throw new Iw("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return n}if(l=l[c],n&&h<d&&(!l||"object"!=typeof l))throw new Iw("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,t,e)}}}function Nw(e,t,n,r=!0,i=!0){if(n&&!Array.isArray(t))throw new Iw("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=_w(e));const s=new Array(t.length);for(let r=0,a=t.length;r<a;r++)s[r]=Cw(e,t[r],n,!0,i,r),e=s[r].newDocument;return s.newDocument=e,s}function Rw(e,t,n){const r=Cw(e,t);if(!1===r.test)throw new Iw("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return r.newDocument}function jw(e,t,n,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new Iw("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(!Aw[e.op])throw new Iw("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n);if("string"!=typeof e.path)throw new Iw("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new Iw('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new Iw("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new Iw("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&kw(e.value))throw new Iw("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n)if("add"==e.op){var i=e.path.split("/").length,s=r.split("/").length;if(i!==s+1&&i!==s)throw new Iw("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new Iw("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if("move"===e.op||"copy"===e.op){var a=Lw([{op:"_get",path:e.from,value:void 0}],n);if(a&&"OPERATION_PATH_UNRESOLVABLE"===a.name)throw new Iw("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}function Lw(e,t,n){try{if(!Array.isArray(e))throw new Iw("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)Nw(_w(t),_w(e),n||!0);else{n=n||jw;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(e){if(e instanceof Iw)return e;throw e}}function Dw(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var n,r,i,s=Array.isArray(e),a=Array.isArray(t);if(s&&a){if((r=e.length)!=t.length)return!1;for(n=r;0!=n--;)if(!Dw(e[n],t[n]))return!1;return!0}if(s!=a)return!1;var o=Object.keys(e);if((r=o.length)!==Object.keys(t).length)return!1;for(n=r;0!=n--;)if(!t.hasOwnProperty(o[n]))return!1;for(n=r;0!=n--;)if(!Dw(e[i=o[n]],t[i]))return!1;return!0}return e!=e&&t!=t}function Mw(e,t,n,r,i){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var s=vw(t),a=vw(e),o=!1,c=a.length-1;c>=0;c--){var u=e[h=a[c]];if(!yw(t,h)||void 0===t[h]&&void 0!==u&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(i&&n.push({op:"test",path:r+"/"+bw(h),value:_w(u)}),n.push({op:"remove",path:r+"/"+bw(h)}),o=!0):(i&&n.push({op:"test",path:r,value:e}),n.push({op:"replace",path:r,value:t}));else{var l=t[h];"object"==typeof u&&null!=u&&"object"==typeof l&&null!=l&&Array.isArray(u)===Array.isArray(l)?Mw(u,l,n,r+"/"+bw(h),i):u!==l&&(i&&n.push({op:"test",path:r+"/"+bw(h),value:_w(u)}),n.push({op:"replace",path:r+"/"+bw(h),value:_w(l)}))}}if(o||s.length!=a.length)for(c=0;c<s.length;c++){var h;yw(e,h=s[c])||void 0===t[h]||n.push({op:"add",path:r+"/"+bw(h),value:_w(t[h])})}}}function $w(e,t,n=!1){var r=[];return Mw(e,t,r,"",n),r}new WeakMap;class Uw extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new Uw({start:e=>function n(){return t.read().then((({done:t,value:r})=>{if(!t)return e.enqueue(r),n();e.close()}))}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new Uw({async pull(t){const{value:n,done:r}=await e.next();r&&t.close(),t.enqueue(n)},async cancel(t){await e.return(t)}})}}function Fw(e,t=2){const n=Array.from({length:t},(()=>[]));return n.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of n)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function Bw(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const n={...e};for(const[e,r]of Object.entries(t))e in n&&!Array.isArray(n[e])?n[e]=Bw(n[e],r):n[e]=r;return n}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class Vw{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise(((n,r)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(n,r):this.firstResult.then((e=>n(void 0)),r)}))}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}class zw{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),n=Nw({},t);return new qw({ops:t,state:n[n.length-1].newDocument})}}class qw extends zw{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),n=Nw(this.state,e.ops);return new qw({ops:t,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){const t=Nw({},e.ops);return new qw({ops:e.ops,state:t[t.length-1].newDocument})}}async function Hw(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=e;return["retriever","llm","prompt"].includes(e.run_type)?n:1!==Object.keys(n).length||""!==n?.input?n.input:void 0}async function Kw(e,t){const{outputs:n}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?n:void 0!==n&&1===Object.keys(n).length&&void 0!==n?.output?n.output:n}class Ww extends R_{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Uw.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(n=n||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(n=n&&t.every((e=>!this.excludeTags?.includes(e)))),n}async*tapOutputIterable(e,t){for await(const n of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new zw({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new zw({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(n.inputs=await Hw(e,this._schemaFormat)),await this.writer.write(new zw({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const n=[];"streaming_events"===this._schemaFormat&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await Hw(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await Kw(e,this._schemaFormat)}),void 0!==e.end_time&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const r=new zw({ops:n});await this.writer.write(r)}finally{if(e.id===this.rootId){const t=new zw({ops:[{op:"replace",path:"/final_output",value:await Kw(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){const r=this.keyMapByRunId[e.id];if(void 0===r)return;let i;var s;void 0!==e.inputs.messages?(s=n?.chunk,i=void 0!==s&&void 0!==s.message?n?.chunk:new mg(t)):i=t;const a=new zw({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${r}/streamed_output/-`,value:i}]});await this.writer.write(a)}}class Gw{getStore(){}run(e,t){return t()}}const Zw=new class{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new Gw}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}};async function Jw(e){return pw.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function Qw(...e){const t={};for(const n of e.filter((e=>!!e)))for(const e of Object.keys(n))if("metadata"===e)t[e]={...t[e],...n[e]};else if("tags"===e){const r=t[e]??[];t[e]=[...new Set(r.concat(n[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...n[e]};else if("callbacks"===e){const e=t.callbacks,r=n.callbacks;if(Array.isArray(r))if(e)if(Array.isArray(e))t.callbacks=e.concat(r);else{const n=e.copy();for(const e of r)n.addHandler(mw(e),!0);t.callbacks=n}else t.callbacks=r;else if(r)if(e)if(Array.isArray(e)){const n=r.copy();for(const t of e)n.addHandler(mw(t),!0);t.callbacks=n}else t.callbacks=new pw(r._parentRunId,{handlers:e.handlers.concat(r.handlers),inheritableHandlers:e.inheritableHandlers.concat(r.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(r.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(r.inheritableTags))),metadata:{...e.metadata,...r.metadata}});else t.callbacks=r}else{const r=e;t[r]=n[r]??t[r]}return t}const Xw=new Set(["string","number","boolean"]);function Yw(e){const t=e??Zw.getInstance().getStore();let n={tags:[],metadata:{},callbacks:void 0,recursionLimit:25,runId:void 0};if(t&&(n={...n,...t}),t?.configurable)for(const e of Object.keys(t.configurable))Xw.has(typeof t.configurable[e])&&!n.metadata?.[e]&&(n.metadata||(n.metadata={}),n.metadata[e]=t.configurable[e]);return n}function eb(e={},{callbacks:t,maxConcurrency:n,recursionLimit:r,runName:i,configurable:s,runId:a}={}){const o=Yw(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==r&&(o.recursionLimit=r),void 0!==n&&(o.maxConcurrency=n),void 0!==i&&(o.runName=i),void 0!==s&&(o.configurable={...o.configurable,...s}),void 0!==a&&delete o.runId,o}class tb extends R_{constructor({config:e,onStart:t,onEnd:n,onError:r}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(1===this.argOnStart.length?await this.argOnStart(e):2===this.argOnStart.length&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(1===this.argOnError.length?await this.argOnError(e):2===this.argOnError.length&&await this.argOnError(e,this.config)):this.argOnEnd&&(1===this.argOnEnd.length?await this.argOnEnd(e):2===this.argOnEnd.length&&await this.argOnEnd(e,this.config)))}}function nb(e){return!!e&&e.lc_runnable}class rb{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let n=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const r=e.tags??[];return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(t)),void 0!==this.includeTags&&(n=n||r.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(n=n&&r.every((e=>!this.excludeTags?.includes(e)))),n}}const ib=Symbol("Let zodToJsonSchema decide on which parser to use"),sb={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",emailStrategy:"format:email",base64Strategy:"contentEncoding:base64"};function ab(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function ob(e,t,n,r,i){e[t]=n,ab(e,t,r,i)}function cb(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(((n,r)=>cb(e,t,n)))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return ub(e,t)}}const ub=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":ob(n,"minimum",r.value,r.message,t);break;case"max":ob(n,"maximum",r.value,r.message,t)}return n},lb={cuid:"^[cC][^\\s-]{8,}$",cuid2:"^[a-z][a-z0-9]*$",ulid:"^[0-9A-HJKMNP-TV-Z]{26}$",email:"^(?!\\.)(?!.*\\.\\.)([a-zA-Z0-9_+-\\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\\-]*\\.)+[a-zA-Z]{2,}$",emoji:"^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",uuid:"^[0-9a-fA-F]{8}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{12}$",ipv4:"^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$",ipv6:"^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$",base64:"^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$",nanoid:"^[a-zA-Z0-9_-]{21}$"};function hb(e,t){const n={type:"string"};function r(e){return"escape"===t.patternStrategy?db(e):e}if(e.checks)for(const i of e.checks)switch(i.kind){case"min":ob(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,i.value):i.value,i.message,t);break;case"max":ob(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,i.value):i.value,i.message,t);break;case"email":switch(t.emailStrategy){case"format:email":fb(n,"email",i.message,t);break;case"format:idn-email":fb(n,"idn-email",i.message,t);break;case"pattern:zod":pb(n,lb.email,i.message,t)}break;case"url":fb(n,"uri",i.message,t);break;case"uuid":fb(n,"uuid",i.message,t);break;case"regex":pb(n,i.regex.source,i.message,t);break;case"cuid":pb(n,lb.cuid,i.message,t);break;case"cuid2":pb(n,lb.cuid2,i.message,t);break;case"startsWith":pb(n,"^"+r(i.value),i.message,t);break;case"endsWith":pb(n,r(i.value)+"$",i.message,t);break;case"datetime":fb(n,"date-time",i.message,t);break;case"date":fb(n,"date",i.message,t);break;case"time":fb(n,"time",i.message,t);break;case"duration":fb(n,"duration",i.message,t);break;case"length":ob(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,i.value):i.value,i.message,t),ob(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,i.value):i.value,i.message,t);break;case"includes":pb(n,r(i.value),i.message,t);break;case"ip":"v6"!==i.version&&fb(n,"ipv4",i.message,t),"v4"!==i.version&&fb(n,"ipv6",i.message,t);break;case"emoji":pb(n,lb.emoji,i.message,t);break;case"ulid":pb(n,lb.ulid,i.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":fb(n,"binary",i.message,t);break;case"contentEncoding:base64":ob(n,"contentEncoding","base64",i.message,t);break;case"pattern:zod":pb(n,lb.base64,i.message,t)}break;case"nanoid":pb(n,lb.nanoid,i.message,t)}return n}const db=e=>Array.from(e).map((e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`)).join(""),fb=(e,t,n,r)=>{e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):ob(e,"format",t,n,r)},pb=(e,t,n,r)=>{e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:t,...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):ob(e,"pattern",t,n,r)};function mb(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===Uv.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((n,r)=>({...n,[r]:_b(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}})),{}),additionalProperties:!1};const n={type:"object",additionalProperties:_b(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===Uv.ZodString&&e.keyType._def.checks?.length){const r=Object.entries(hb(e.keyType._def,t)).reduce(((e,[t,n])=>"type"===t?e:{...e,[t]:n}),{});return{...n,propertyNames:r}}return e.keyType?._def.typeName===Uv.ZodEnum?{...n,propertyNames:{enum:e.keyType._def.values}}:n}const gb={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},yb=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,n)=>_b(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return n.length?{anyOf:n}:void 0};function vb(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:_b(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:_b(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function _b(e,t,n=!1){const r=t.seen.get(e);if(t.override){const i=t.override?.(e,t,r,n);if(i!==ib)return i}if(r&&!n){const e=wb(r,t);if(void 0!==e)return e}const i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);const s=Eb(e,e.typeName,t);return s&&kb(e,t,s),i.jsonSchema=s,s}const wb=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:bb(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,n)=>t.currentPath[n]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},bb=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},Eb=(e,t,n)=>{switch(t){case Uv.ZodString:return hb(e,n);case Uv.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",ab(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?ob(n,"minimum",r.value,r.message,t):ob(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),ob(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?ob(n,"maximum",r.value,r.message,t):ob(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),ob(n,"maximum",r.value,r.message,t));break;case"multipleOf":ob(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case Uv.ZodObject:return function(e,t){const n={type:"object",...Object.entries(e.shape()).reduce(((e,[n,r])=>{if(void 0===r||void 0===r._def)return e;const i=_b(r._def,{...t,currentPath:[...t.currentPath,"properties",n],propertyPath:[...t.currentPath,"properties",n]});return void 0===i?e:{properties:{...e.properties,[n]:i},required:r.isOptional()?e.required:[...e.required,n]}}),{properties:{},required:[]}),additionalProperties:vb(e,t)};return n.required.length||delete n.required,n}(e,n);case Uv.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?ob(n,"minimum",r.value,r.message,t):ob(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),ob(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?ob(n,"maximum",r.value,r.message,t):ob(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),ob(n,"maximum",r.value,r.message,t));break;case"multipleOf":ob(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case Uv.ZodBoolean:return{type:"boolean"};case Uv.ZodDate:return cb(e,n);case Uv.ZodUndefined:return{not:{}};case Uv.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case Uv.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def?.typeName!==Uv.ZodAny&&(n.items=_b(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&ob(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&ob(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(ob(n,"minItems",e.exactLength.value,e.exactLength.message,t),ob(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case Uv.ZodUnion:case Uv.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return yb(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every((e=>e._def.typeName in gb&&(!e._def.checks||!e._def.checks.length)))){const e=n.reduce(((e,t)=>{const n=gb[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e}),[]);return{type:e.length>1?e:e[0]}}if(n.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=n.reduce(((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===n.length){const t=e.filter(((e,t,n)=>n.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:n.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(n.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:n.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return yb(e,t)}(e,n);case Uv.ZodIntersection:return function(e,t){const n=[_b(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),_b(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const i=[];return n.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;i.push(t)}else i.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t})),i.length?{allOf:i,...r}:void 0}(e,n);case Uv.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,n)=>_b(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:_b(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,n)=>_b(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,n);case Uv.ZodRecord:return mb(e,n);case Uv.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case Uv.ZodEnum:return function(e){return{type:"string",enum:e.values}}(e);case Uv.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])).map((e=>t[e])),r=Array.from(new Set(n.map((e=>typeof e))));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case Uv.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:gb[e.innerType._def.typeName],nullable:!0}:{type:[gb[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=_b(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=_b(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case Uv.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return _b(e.innerType._def,t);const n=_b(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case Uv.ZodMap:return function(e,t){return"record"===t.mapStrategy?mb(e,t):{type:"array",maxItems:125,items:{type:"array",items:[_b(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},_b(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case Uv.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:_b(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&ob(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&ob(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case Uv.ZodLazy:return _b(e.getter()._def,n);case Uv.ZodPromise:return function(e,t){return _b(e.type._def,t)}(e,n);case Uv.ZodNaN:case Uv.ZodNever:return{not:{}};case Uv.ZodEffects:return function(e,t){return"input"===t.effectStrategy?_b(e.schema._def,t):{}}(e,n);case Uv.ZodAny:case Uv.ZodUnknown:return{};case Uv.ZodDefault:return function(e,t){return{..._b(e.innerType._def,t),default:e.defaultValue()}}(e,n);case Uv.ZodBranded:return function(e,t){return _b(e.type._def,t)}(e,n);case Uv.ZodReadonly:case Uv.ZodCatch:return((e,t)=>_b(e.innerType._def,t))(e,n);case Uv.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return _b(e.in._def,t);if("output"===t.pipeStrategy)return _b(e.out._def,t);const n=_b(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,_b(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter((e=>void 0!==e))}})(e,n);case Uv.ZodFunction:case Uv.ZodVoid:case Uv.ZodSymbol:default:return}},kb=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),Sb=(e,t)=>{const n=(e=>{const t=(e=>"string"==typeof e?{...sb,name:e}:{...sb,...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map((([e,n])=>[n._def,{def:n._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}})(t),r="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce(((e,[t,r])=>({...e,[t]:_b(r._def,{...n,currentPath:[...n.basePath,n.definitionPath,t]},!0)??{}})),{}):void 0,i="string"==typeof t?t:t?.name,s=_b(e._def,void 0===i?n:{...n,currentPath:[...n.basePath,n.definitionPath,i]},!1)??{},a=void 0===i?r?{...s,[n.definitionPath]:r}:s:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,i].join("/"),[n.definitionPath]:{...r,[i]:s}};return"jsonSchema7"===n.target?a.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===n.target&&(a.$schema="https://json-schema.org/draft/2019-09/schema#"),a};function Tb(e){return nb(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...Sb(e.data.schema),title:e.data.name}}}class Ib{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){const e={};return Object.values(this.nodes).forEach(((t,n)=>{e[t.id]=J_(t.id)?n:t.id})),{nodes:Object.values(this.nodes).map((t=>({id:e[t.id],...Tb(t)}))),edges:this.edges.map((t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]}))}}addNode(e,t){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const n=t||A_(),r={id:n,data:e};return this.nodes[n]=r,r}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter((t=>t.source!==e.id&&t.target!==e.id))}addEdge(e,t,n){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const r={source:e.id,target:t.id,data:n};return this.edges.push(r),r}firstNode(){const e=new Set(this.edges.map((e=>e.target))),t=[];return Object.values(this.nodes).forEach((n=>{e.has(n.id)||t.push(n)})),t[0]}lastNode(){const e=new Set(this.edges.map((e=>e.source))),t=[];return Object.values(this.nodes).forEach((n=>{e.has(n.id)||t.push(n)})),t[0]}extend(e){Object.entries(e.nodes).forEach((([e,t])=>{this.nodes[e]=t})),this.edges=[...this.edges,...e.edges]}trimFirstNode(){const e=this.firstNode();if(e){const t=this.edges.filter((t=>t.source===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}trimLastNode(){const e=this.lastNode();if(e){const t=this.edges.filter((t=>t.target===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}}function Ob(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function Ab(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*xb(e,t){const n=Zw.getInstance();for(;;){const{value:r,done:i}=n.run(e,t.next.bind(t));if(i)break;yield r}}async function*Pb(e,t){const n=Zw.getInstance(),r=t[Symbol.asyncIterator]();for(;;){const{value:i,done:s}=await n.run(e,r.next.bind(t));if(s)break;yield i}}function Cb(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class Nb extends ag{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Rb({bound:this,kwargs:e,config:{}})}map(){return new jb({bound:this})}withRetry(e){return new Lb({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new Rb({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new Ub({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(Yw);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const n=Object.fromEntries(Object.entries(e).filter((([e])=>"runId"!==e)));return Array.from({length:t},((t,r)=>Yw(0===r?e:n)))}return Array.from({length:t},(()=>Yw(e)))}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),i=r[0]?.maxConcurrency??n?.maxConcurrency,s=new Jg({maxConcurrency:i,onFailedAttempt:e=>{throw e}}),a=e.map(((e,t)=>s.call((async()=>{try{return await this.invoke(e,r[t])}catch(e){if(n?.returnExceptions)return e;throw e}}))));return Promise.all(a)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const n=new Vw(this._streamIterator(e,Yw(t)));return await n.setup,Uw.fromAsyncGenerator(n)}_separateRunnableConfigFromCallOptions(e){let t;t=Yw(void 0===e?e:{callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,[t,n]}async _callWithConfig(e,t,n){const r=Yw(n),i=await Jw(r),s=await(i?.handleChainStart(this.toJSON(),Cb(t,"input"),r.runId,r?.runType,void 0,void 0,r?.runName??this.getName()));let a;delete r.runId;try{a=await e.call(this,t,r,s)}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(Cb(a,"output"))),a}async _batchWithConfig(e,t,n,r){const i=this._getOptionsList(n??{},t.length),s=await Promise.all(i.map(Jw)),a=await Promise.all(s.map((async(e,n)=>{const r=await(e?.handleChainStart(this.toJSON(),Cb(t[n],"input"),i[n].runId,i[n].runType,void 0,void 0,i[n].runName??this.getName()));return delete i[n].runId,r})));let o;try{o=await e.call(this,t,i,a,r)}catch(e){throw await Promise.all(a.map((t=>t?.handleChainError(e)))),e}return await Promise.all(a.map((e=>e?.handleChainEnd(Cb(o,"output"))))),o}async*_transformStreamWithConfig(e,t,n){let r,i,s=!0,a=!0;const o=Yw(n),c=await Jw(o);let u;try{const n=await async function(e,t,n,...r){const i=new Vw(t,n),s=await i.setup;return{output:e(i,s,...r),setup:s}}(t.bind(this),async function*(){for await(const t of e){if(s)if(void 0===r)r=t;else try{r=Bw(r,t)}catch{r=void 0,s=!1}yield t}}(),(async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName())),o);delete o.runId,u=n.setup;const l=e=>"log_stream_tracer"===e.name,h=u?.handlers.find(l);let d=n.output;void 0!==h&&void 0!==u&&(d=await h.tapOutputIterable(u.runId,n.output));for await(const e of d)if(yield e,a)if(void 0===i)i=e;else try{i=Bw(i,e)}catch{i=void 0,a=!1}}catch(e){throw await(u?.handleChainError(e,void 0,void 0,void 0,{inputs:Cb(r,"input")})),e}await(u?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:Cb(r,"input")}))}getGraph(e){const t=new Ib,n=t.addNode({name:`${this.getName()}Input`,schema:E_.any()}),r=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:E_.any()});return t.addEdge(n,r),t.addEdge(r,i),t}pipe(e){return new Db({first:this,last:Fb(e)})}pick(e){return this.pipe(new Vb(e))}assign(e){return this.pipe(new Bb(new Mb({steps:e})))}async*transform(e,t){let n;for await(const t of e)n=void 0===n?t:Bw(n,t);yield*this._streamIterator(n,Yw(t))}async*streamLog(e,t,n){const r=new Ww({...n,autoClose:!1,_schemaFormat:"original"}),i=Yw(t);yield*this._streamLog(e,r,i)}async*_streamLog(e,t,n){const{callbacks:r}=n;if(void 0===r)n.callbacks=[t];else if(Array.isArray(r))n.callbacks=r.concat([t]);else{const e=r.copy();e.inheritableHandlers.push(t),n.callbacks=e}const i=this.stream(e,n),s=async function(){try{const e=await i;for await(const n of e){const e=new zw({ops:[{op:"add",path:"/streamed_output/-",value:n}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await s}}async*streamEvents(e,t,n){if("text/event-stream"===t.encoding){const r=await this._streamEvents(e,t,n);yield*function(e){const t=new TextEncoder,n=new ReadableStream({async start(n){for await(const r of e)n.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(r)}\n\n`));n.enqueue(t.encode("event: end\n\n")),n.close()}});return Uw.fromReadableStream(n)}(r)}else yield*this._streamEvents(e,t,n)}async*_streamEvents(e,t,n){if("v1"!==t.version)throw new Error('Only version "v1" of the events schema is currently supported.');let r,i=!1;const s=Yw(t),a=s.tags??[],o=s.metadata??{},c=s.runName??this.getName(),u=new Ww({...n,autoClose:!1,_schemaFormat:"streaming_events"}),l=new rb({...n}),h=this._streamLog(e,u,s);for await(const t of h){if(r=r?r.concat(t):qw.fromRunLogPatch(t),void 0===r.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const t={...r.state},n={run_id:t.id,event:`on_${t.type}_start`,name:c,tags:a,metadata:o,data:{input:e}};l.includeEvent(n,t.type)&&(yield n)}const n=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),s=[...new Set(n)];for(const e of s){let t,n={};const i=r.state.logs[e];if(t=void 0===i.end_time?i.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==i.inputs&&(n.input=i.inputs);else if("end"===t)void 0!==i.inputs&&(n.input=i.inputs),n.output=i.final_output;else if("stream"===t){const e=i.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${i.name}"`);n={chunk:i.streamed_output[0]},i.streamed_output=[]}yield{event:`on_${i.type}_${t}`,name:i.name,run_id:i.id,tags:i.tags,metadata:i.metadata,data:n}}const{state:u}=r;if(u.streamed_output.length>0){const e=u.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${u.name}"`);const t={chunk:u.streamed_output[0]};u.streamed_output=[];const n={event:`on_${u.type}_stream`,run_id:u.id,tags:a,metadata:o,name:c,data:t};l.includeEvent(n,u.type)&&(yield n)}}const d=r?.state;if(void 0!==d){const e={event:`on_${d.type}_end`,name:c,run_id:d.id,tags:a,metadata:o,data:{output:d.final_output}};l.includeEvent(e,d.type)&&(yield e)}}static isRunnable(e){return nb(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new Rb({bound:this,config:{},configFactories:[r=>({callbacks:[new tb({config:r,onStart:e,onEnd:t,onError:n})]})]})}}class Rb extends Nb{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=Qw(this.config,...e);return Qw(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(Yw(t),this.kwargs))}async batch(e,t,n){const r=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig(Yw(e),this.kwargs)))):await this._mergeConfig(Yw(t),this.kwargs);return this.bound.batch(e,r,n)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(Yw(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(Yw(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(Yw(t),this.kwargs))}async*streamEvents(e,t,n){yield*this.bound.streamEvents(e,{...await this._mergeConfig(Yw(t),this.kwargs),version:t.version},n)}static isRunnableBinding(e){return e.bound&&Nb.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:n}){return new Rb({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[r=>({callbacks:[new tb({config:r,onStart:e,onEnd:t,onError:n})]})]})}}class jb extends Nb{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new jb({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,n){return this.bound.batch(e,eb(t,{callbacks:n?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:n}){return new jb({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:n})})}}class Lb extends Rb{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){const r=e>1?`retry:attempt:${e}`:void 0;return eb(t,{callbacks:n?.getChild(r)})}async _invoke(e,t,n){return Kg((r=>super.invoke(e,this._patchConfigForRetry(r,t,n))),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,n,r){const i={};try{await Kg((async s=>{const a=e.map(((e,t)=>t)).filter((e=>void 0===i[e.toString()]||i[e.toString()]instanceof Error)),o=a.map((t=>e[t])),c=a.map((e=>this._patchConfigForRetry(s,t?.[e],n?.[e]))),u=await super.batch(o,c,{...r,returnExceptions:!0});let l;for(let e=0;e<u.length;e+=1){const t=u[e],n=a[e];t instanceof Error&&void 0===l&&(l=t,l.input=o[e]),i[n.toString()]=t}if(l)throw l;return u}),{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==r?.returnExceptions)throw e}return Object.keys(i).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>i[parseInt(e,10)]))}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}}class Db extends Nb{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const n=Yw(t),r=await Jw(n),i=await(r?.handleChainStart(this.toJSON(),Cb(e,"input"),n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;let s,a=e;try{const e=[this.first,...this.middle];for(let t=0;t<e.length;t+=1){const r=e[t];a=await r.invoke(a,eb(n,{callbacks:i?.getChild(`seq:step:${t+1}`)}))}s=await this.last.invoke(a,eb(n,{callbacks:i?.getChild(`seq:step:${this.steps.length}`)}))}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(Cb(s,"output"))),s}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),i=await Promise.all(r.map(Jw)),s=await Promise.all(i.map((async(t,n)=>{const i=await(t?.handleChainStart(this.toJSON(),Cb(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,i})));let a=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e];a=await t.batch(a,s.map(((t,n)=>{const i=t?.getChild(`seq:step:${e+1}`);return eb(r[n],{callbacks:i})})),n)}}catch(e){throw await Promise.all(s.map((t=>t?.handleChainError(e)))),e}return await Promise.all(s.map((e=>e?.handleChainEnd(Cb(a,"output"))))),a}async*_streamIterator(e,t){const n=await Jw(t),{runId:r,...i}=t??{},s=await(n?.handleChainStart(this.toJSON(),Cb(e,"input"),r,void 0,void 0,void 0,i?.runName)),a=[this.first,...this.middle,this.last];let o,c=!0;try{let t=a[0].transform(async function*(){yield e}(),eb(i,{callbacks:s?.getChild("seq:step:1")}));for(let e=1;e<a.length;e+=1){const n=a[e];t=await n.transform(t,eb(i,{callbacks:s?.getChild(`seq:step:${e+1}`)}))}for await(const n of t)if(yield n,c)if(void 0===o)o=n;else try{o=Bw(o,n)}catch(e){o=void 0,c=!1}}catch(e){throw await(s?.handleChainError(e)),e}await(s?.handleChainEnd(Cb(o,"output")))}getGraph(e){const t=new Ib;let n=null;return this.steps.forEach(((r,i)=>{const s=r.getGraph(e);0!==i&&s.trimFirstNode(),i!==this.steps.length-1&&s.trimLastNode(),t.extend(s);const a=s.firstNode();if(!a)throw new Error(`Runnable ${r} has no first node`);n&&t.addEdge(n,a),n=s.lastNode()})),t}pipe(e){return Db.isRunnableSequence(e)?new Db({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new Db({first:this.first,middle:[...this.middle,this.last],last:Fb(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&Nb.isRunnable(e)}static from([e,...t],n){return new Db({first:Fb(e),middle:t.slice(0,-1).map(Fb),last:Fb(t[t.length-1]),name:n})}}class Mb extends Nb{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,n]of Object.entries(e.steps))this.steps[t]=Fb(n)}static from(e){return new Mb({steps:e})}async invoke(e,t){const n=Yw(t),r=await Jw(n),i=await(r?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;const s={};try{await Promise.all(Object.entries(this.steps).map((async([t,r])=>{s[t]=await r.invoke(e,eb(n,{callbacks:i?.getChild(`map:key:${t}`)}))})))}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(s)),s}async*_transform(e,t,n){const r={...this.steps},i=Fw(e,Object.keys(r).length),s=new Map(Object.entries(r).map((([e,r],s)=>{const a=r.transform(i[s],eb(n,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,a.next().then((t=>({key:e,gen:a,result:t})))]})));for(;s.size;){const{key:e,result:t,gen:n}=await Promise.race(s.values());s.delete(e),t.done||(yield{[e]:t.value},s.set(e,n.next().then((t=>({key:e,gen:n,result:t})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=new Vw(this.transform(async function*(){yield e}(),t));return await n.setup,Uw.fromAsyncGenerator(n)}}class $b extends Nb{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new $b({func:e})}async _invoke(e,t,n){return new Promise(((r,i)=>{const s=eb(t,{callbacks:n?.getChild(),recursionLimit:(t?.recursionLimit??25)-1});Zw.getInstance().run(s,(async()=>{try{let n=await this.func(e,{...s,config:s});if(n&&Nb.isRunnable(n)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");n=await n.invoke(e,{...s,recursionLimit:(s.recursionLimit??25)-1})}else if(Ab(n)){let e;for await(const t of Pb(s,n))if(void 0===e)e=t;else try{e=Bw(e,t)}catch(n){e=t}n=e}else if(Ob(n)){let e;for(const t of xb(s,n))if(void 0===e)e=t;else try{e=Bw(e,t)}catch(n){e=t}n=e}r(n)}catch(e){i(e)}}))}))}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,n){let r;for await(const t of e)if(void 0===r)r=t;else try{r=Bw(r,t)}catch(e){r=t}const i=await new Promise(((e,t)=>{Zw.getInstance().run(n,(async()=>{try{const t=await this.func(r,{...n,config:n});e(t)}catch(e){t(e)}}))}));if(i&&Nb.isRunnable(i)){if(0===n?.recursionLimit)throw new Error("Recursion limit reached.");const e=await i.stream(r,eb(n,{callbacks:t?.getChild(),recursionLimit:(n?.recursionLimit??25)-1}));for await(const t of e)yield t}else if(Ab(i))for await(const e of Pb(n,i))yield e;else if(Ob(i))for(const e of xb(n,i))yield e;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=new Vw(this.transform(async function*(){yield e}(),t));return await n.setup,Uw.fromAsyncGenerator(n)}}class Ub extends Nb{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const n=await pw.configure(t?.callbacks,void 0,t?.tags,void 0,t?.metadata),{runId:r,...i}=t??{},s=await(n?.handleChainStart(this.toJSON(),Cb(e,"input"),r,void 0,void 0,void 0,i?.runName));let a;for(const t of this.runnables())try{const n=await t.invoke(e,eb(i,{callbacks:s?.getChild()}));return await(s?.handleChainEnd(Cb(n,"output"))),n}catch(e){void 0===a&&(a=e)}if(void 0===a)throw new Error("No error stored at end of fallback.");throw await(s?.handleChainError(a)),a}async batch(e,t,n){if(n?.returnExceptions)throw new Error("Not implemented.");const r=this._getOptionsList(t??{},e.length),i=await Promise.all(r.map((e=>pw.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)))),s=await Promise.all(i.map((async(t,n)=>{const i=await(t?.handleChainStart(this.toJSON(),Cb(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,i})));let a;for(const t of this.runnables())try{const i=await t.batch(e,s.map(((e,t)=>eb(r[t],{callbacks:e?.getChild()}))),n);return await Promise.all(s.map(((e,t)=>e?.handleChainEnd(Cb(i[t],"output"))))),i}catch(e){void 0===a&&(a=e)}if(!a)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(s.map((e=>e?.handleChainError(a)))),a}}function Fb(e){if("function"==typeof e)return new $b({func:e});if(Nb.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[n,r]of Object.entries(e))t[n]=Fb(r);return new Mb({steps:t})}}class Bb extends Nb{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Mb&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){const r=this.mapper.getStepsKeys(),[i,s]=Fw(e),a=this.mapper.transform(s,eb(n,{callbacks:t?.getChild()})),o=a.next();for await(const e of i){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!r.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of a)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=new Vw(this.transform(async function*(){yield e}(),t));return await n.setup,Uw.fromAsyncGenerator(n)}}class Vb extends Nb{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=new Vw(this.transform(async function*(){yield e}(),t));return await n.setup,Uw.fromAsyncGenerator(n)}}class zb extends Nb{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class qb extends zb{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){super({callbacks:e??t,...n}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof n.cache?this.cache=n.cache:n.cache?this.cache=Vg.global():this.cache=void 0,this.caller=new Jg(n??{})}async getNumTokens(e){if("string"!=typeof e)return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await async function(e){return async function(e){return e in iy||(iy[e]=sy.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then((e=>e.json())).then((e=>new ry(e))).catch((t=>{throw delete iy[e],t}))),await iy[e]}(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":return"o200k_base";default:throw new Error("Unknown model")}}(e))}("modelName"in this?(n=this.modelName,n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}var n;if(this._encoding)try{t=this._encoding.encode(e).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return t}static _convertInputToPromptValue(e){return"string"==typeof e?new qg(e):Array.isArray(e)?new Hg(e.map(kg)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()},r=Object.entries(n).filter((([e,t])=>void 0!==t)),i=r.map((([e,t])=>`${e}:${JSON.stringify(t)}`)).sort().join(",");return i}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class Hb extends qb{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n?.timeout&&!n.signal&&(n.signal=AbortSignal.timeout(n.timeout)),[t,n]}async invoke(e,t){const n=Hb._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===Hb.prototype._streamResponseChunks)yield this.invoke(e,t);else{const n=Hb._convertInputToPromptValue(e).toChatMessages(),[r,i]=this._separateRunnableConfigFromCallOptions(t),s=await pw.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),a={options:i,invocation_params:this?.invocationParams(i),batch_size:1},o=await(s?.handleChatModelStart(this.toJSON(),[n],r.runId,void 0,a,void 0,void 0,r.runName));let c;try{for await(const e of this._streamResponseChunks(n,i,o?.[0]))e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,c=c?c.concat(e):e}catch(e){throw await Promise.all((o??[]).map((t=>t?.handleLLMError(e)))),e}await Promise.all((o??[]).map((e=>e?.handleLLMEnd({generations:[[c]]}))))}}async _generateUncached(e,t,n){const r=e.map((e=>e.map(kg))),i=await pw.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),s={options:t,invocation_params:this?.invocationParams(t),batch_size:1},a=await(i?.handleChatModelStart(this.toJSON(),r,n.runId,void 0,s,void 0,void 0,n.runName)),o=await Promise.allSettled(r.map(((e,n)=>this._generate(e,{...t,promptIndex:n},a?.[n])))),c=[],u=[];await Promise.all(o.map((async(e,t)=>{if("fulfilled"===e.status){const n=e.value;for(const e of n.generations)e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};return 1===n.generations.length&&(n.generations[0].message.response_metadata={...n.llmOutput,...n.generations[0].message.response_metadata}),c[t]=n.generations,u[t]=n.llmOutput,a?.[t]?.handleLLMEnd({generations:[n.generations],llmOutput:n.llmOutput})}return await(a?.[t]?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const l={generations:c,llmOutput:u.length?this._combineLLMOutput?.(...u):void 0};return Object.defineProperty(l,Ig,{value:a?{runIds:a?.map((e=>e.runId))}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:r,handledOptions:i}){const s=e.map((e=>e.map(kg))),a=await pw.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),o={options:r,invocation_params:this?.invocationParams(r),batch_size:1,cached:!0},c=await(a?.handleChatModelStart(this.toJSON(),s,i.runId,void 0,o,void 0,void 0,i.runName)),u=[],l=await Promise.allSettled(s.map((async(e,r)=>{const i=Hb._convertInputToPromptValue(e).toString(),s=await t.lookup(i,n);return null==s&&u.push(r),s}))),h=l.map(((e,t)=>({result:e,runManager:c?.[t]}))).filter((({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status)),d=[];await Promise.all(h.map((async({result:e,runManager:t},n)=>{if("fulfilled"===e.status){const r=e.value;return d[n]=r,r.length&&await(t?.handleLLMNewToken(r[0].text)),t?.handleLLMEnd({generations:[r]})}return await(t?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const f={generations:d,missingPromptIndices:u};return Object.defineProperty(f,Ig,{value:c?{runIds:c?.map((e=>e.runId))}:void 0,configurable:!0}),f}async generate(e,t,n){let r;r=Array.isArray(t)?{stop:t}:t;const i=e.map((e=>e.map(kg))),[s,a]=this._separateRunnableConfigFromCallOptions(r);if(s.callbacks=s.callbacks??n,!this.cache)return this._generateUncached(i,a,s);const{cache:o}=this,c=this._getSerializedCacheKeyParametersForCall(a),{generations:u,missingPromptIndices:l}=await this._generateCached({messages:i,cache:o,llmStringKey:c,parsedOptions:a,handledOptions:s});let h={};if(l.length>0){const e=await this._generateUncached(l.map((e=>i[e])),a,s);await Promise.all(e.generations.map((async(e,t)=>{const n=l[t];u[n]=e;const r=Hb._convertInputToPromptValue(i[n]).toString();return o.update(r,c,e)}))),h=e.llmOutput??{}}return{generations:u,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){const r=e.map((e=>e.toChatMessages()));return this.generate(r,t,n)}async call(e,t,n){return(await this.generate([e.map(kg)],t,n)).generations[0][0].message}async callPrompt(e,t,n){const r=e.toChatMessages();return this.call(r,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const r=new _g(e),i=await this.call([r],t,n);if("string"!=typeof i.content)throw new Error("Cannot use predict when output is not a string.");return i.content}}function Kb(e){return{name:e.name,description:e.description,parameters:Sb(e.schema)}}function Wb(e){return function(e){return void 0!==e&&Array.isArray(e.lc_namespace)}(e)?{type:"function",function:Kb(e)}:e}class Gb extends Nb{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const n=Yw(t);return this.func&&await this.func(e,n),this._callWithConfig((e=>Promise.resolve(e)),e,n)}async*transform(e,t){const n=Yw(t);let r,i=!0;for await(const t of this._transformStreamWithConfig(e,(e=>e),n))if(yield t,i)if(void 0===r)r=t;else try{r=Bw(r,t)}catch{r=void 0,i=!1}this.func&&void 0!==r&&await this.func(r,n)}static assign(e){return new Bb(new Mb({steps:e}))}}class Zb extends Nb{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig((async(e,t)=>this.parseResult([{text:e}],t?.callbacks)),e,{...t,runType:"parser"}):this._callWithConfig((async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks)),e,{...t,runType:"parser"})}}class Jb extends Zb{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}}class Qb extends Error{constructor(e,t,n,r=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=r,r&&(void 0===n||void 0===t))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}}function Xb(e,t){const n=typeof e;if(n!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const n=e.length;if(n!==t.length)return!1;for(let r=0;r<n;r++)if(!Xb(e[r],t[r]))return!1;return!0}if("object"===n){if(!e||!t)return e===t;const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(const r of n)if(!Xb(e[r],t[r]))return!1;return!0}return e===t}"undefined"!=typeof self&&self.location&&"null"!==self.location.origin&&(self.location.origin,self.location.pathname,location.search);class Yb extends Jb{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class eE extends Yb{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,n;for await(const i of e){if("string"!=typeof i&&"string"!=typeof i.content)throw new Error("Cannot handle non-string output.");let e;if(dg(r=i)&&"function"==typeof r.concat){if("string"!=typeof i.content)throw new Error("Cannot handle non-string message output.");e=new Ag({message:i,text:i.content})}else if(dg(i)){if("string"!=typeof i.content)throw new Error("Cannot handle non-string message output.");e=new Ag({message:Tg(i),text:i.content})}else e=new Og({text:i});n=void 0===n?e:n.concat(e);const s=await this.parsePartialResult([n]);null==s||Xb(s,t)||(this.diff?yield this._diff(t,s):yield s,t=s)}var r}}class tE extends Jb{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(E_.object(Object.fromEntries(Object.entries(e).map((([e,t])=>[e,E_.string().describe(t)])))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.\n\n"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.\n\nFor example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}\nwould match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.\nThus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.\n\nYour output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!\n\nHere is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:\n\`\`\`json\n${JSON.stringify(Sb(this.schema))}\n\`\`\`\n`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,((e,t)=>`"${t.replace(/\n/g,"\\n")}"`)).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new Qb(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class nE extends eE{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?$w(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Xm(e[0].text)}async parse(e){return Xm(e,JSON.parse)}getFormatInstructions(){return""}}function rE(e,t){if(void 0===e.function)return;let n;if(t?.partial)try{n=Ym(e.function.arguments??"{}")}catch(e){return}else try{n=JSON.parse(e.function.arguments)}catch(t){throw new Qb([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${t.message}`].join("\n"))}const r={name:e.function.name,args:n};return t?.returnId&&(r.id=e.id),r}function iE(e){if(void 0===e.id)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function sE(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t}}class aE extends Zb{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}async parseResult(e){const t=e[0].message.additional_kwargs.tool_calls;if(!t)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);const n=JSON.parse(JSON.stringify(t)),r=[];for(const e of n){const t=rE(e,{partial:!0});if(void 0!==t){const e={type:t.name,args:t.args,id:t.id};Object.defineProperty(e,"name",{get(){return this.type}}),Object.defineProperty(e,"arguments",{get(){return this.args}}),r.push(e)}}return r}}class oE extends Zb{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.initialParser=new aE(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new Qb(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=(await this.initialParser.parseResult(e)).filter((e=>e.type===this.keyName));let n=t;if(this.returnId||(n=t.map((e=>e.args))),this.returnSingle)return this._validateResult(n[0]);const r=await Promise.all(n.map((e=>this._validateResult(e))));return r}}function cE(e,t){const n=[];for(const[r,i]of Object.entries(e.properties??{}))i.description&&t<2&&n.push(`// ${i.description}`),e.required?.includes(r)?n.push(`${r}: ${uE(i,t)},`):n.push(`${r}?: ${uE(i,t)},`);return n.map((e=>" ".repeat(t)+e)).join("\n")}function uE(e,t){if(function(e){return void 0!==e.anyOf&&Array.isArray(e.anyOf)}(e))return e.anyOf.map((e=>uE(e,t))).join(" | ");switch(e.type){case"string":return e.enum?e.enum.map((e=>`"${e}"`)).join(" | "):"string";case"number":case"integer":return e.enum?e.enum.map((e=>`${e}`)).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",cE(e,t+2),"}"].join("\n");case"array":return e.items?`${uE(e.items,t)}[]`:"any[]";default:return""}}function lE(e){const t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!gg.isInstance(e))throw new Error("Invalid generic chat message");return function(e){return"system"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role}(e);default:throw new Error(`Unknown message type: ${t}`)}}function hE(e){const t=e.tool_calls;if("assistant"===e.role){const n=[],r=[];for(const e of t??[])try{n.push(rE(e,{returnId:!0}))}catch(t){r.push(sE(e,t.message))}return new pg({content:e.content||"",tool_calls:n,invalid_tool_calls:r,additional_kwargs:{function_call:e.function_call,tool_calls:t}})}return new gg(e.content||"",e.role??"unknown")}function dE(e,t){const n=e.role??t,r=e.content??"";let i;if(i=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},"user"===n)return new wg({content:r});if("assistant"===n){const t=[];if(Array.isArray(e.tool_calls))for(const n of e.tool_calls)t.push({name:n.function?.name,args:n.function?.arguments,id:n.id,index:n.index});return new mg({content:r,tool_call_chunks:t,additional_kwargs:i})}return"system"===n?new Eg({content:r}):"function"===n?new vg({content:r,additional_kwargs:i,name:e.name}):"tool"===n?new fg({content:r,additional_kwargs:i,tool_call_id:e.tool_call_id}):new yg({content:r,role:n})}function fE(e){return e.map((e=>{const t={role:lE(e),content:e.content};return null!=e.name&&(t.name=e.name),null!=e.additional_kwargs.function_call&&(t.function_call=e.additional_kwargs.function_call),"ai"===e._getType()&&e.tool_calls?.length?t.tool_calls=e.tool_calls.map(iE):(null!=e.additional_kwargs.tool_calls&&(t.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(t.tool_call_id=e.tool_call_id)),t}))}class pE extends Hb{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??Ng("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??Ng("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.apiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??Ng("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??Ng("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??Ng("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??Ng("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??Ng("OPENAI_ORGANIZATION"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??""}this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}bindTools(e,t){return this.bind({tools:e.map(Wb),...t})}invocationParams(e){var t;return{model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:(t=e?.tools,void 0!==t&&t.every((e=>Array.isArray(e.lc_namespace)))?e?.tools.map(Wb):e?.tools),tool_choice:e?.tool_choice,response_format:e?.response_format,seed:e?.seed,...this.modelKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){const r=fE(e),i={...this.invocationParams(t),messages:r,stream:!0};let s;const a=await this.completionWithRetry(i,t);for await(const e of a){const r=e?.choices[0];if(!r)continue;const{delta:i}=r;if(!i)continue;const a=dE(i,s);s=i.role??s;const o={prompt:t.promptIndex??0,completion:r.index??0};if("string"!=typeof a.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const c={...o};void 0!==r.finish_reason&&(c.finish_reason=r.finish_reason),this.logprobs&&(c.logprobs=r.logprobs);const u=new Ag({message:a,text:a.content,generationInfo:c});yield u,n?.handleLLMNewToken(u.text??"",o,void 0,void 0,void 0,{chunk:u})}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,n){const r={},i=this.invocationParams(t),s=fE(e);if(i.stream){const i=this._streamResponseChunks(e,t,n),s={};for await(const e of i){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};const t=e.generationInfo?.completion??0;void 0===s[t]?s[t]=e:s[t]=s[t].concat(e)}const a=Object.entries(s).sort((([e],[t])=>parseInt(e,10)-parseInt(t,10))).map((([e,t])=>t)),{functions:o,function_call:c}=this.invocationParams(t),u=await this.getEstimatedTokenCountFromPrompt(e,o,c),l=await this.getNumTokensFromGenerations(a);return r.promptTokens=u,r.completionTokens=l,r.totalTokens=u+l,{generations:a,llmOutput:{estimatedTokenUsage:r}}}{const e=await this.completionWithRetry({...i,stream:!1,messages:s},{signal:t?.signal,...t?.options}),{completion_tokens:n,prompt_tokens:a,total_tokens:o}=e?.usage??{};n&&(r.completionTokens=(r.completionTokens??0)+n),a&&(r.promptTokens=(r.promptTokens??0)+a),o&&(r.totalTokens=(r.totalTokens??0)+o);const c=[];for(const t of e?.choices??[]){const e={text:t.message?.content??"",message:hE(t.message??{role:"assistant"})};e.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},c.push(e)}return{generations:c,llmOutput:{tokenUsage:r}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let r=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==n){const e=function(e){const t=["namespace functions {",""];for(const n of e)n.description&&t.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(t.push(`type ${n.name} = (_: {`),t.push(cE(n.parameters,0)),t.push("}) => any;")):t.push(`type ${n.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);r+=await this.getNumTokens(e),r+=9}return t&&e.find((e=>"system"===e._getType()))&&(r-=4),"none"===n?r+=1:"object"==typeof n&&(r+=await this.getNumTokens(n.name)+4),r}async getNumTokensFromGenerations(e){return(await Promise.all(e.map((async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content))))).reduce(((e,t)=>e+t),0)}async getNumTokensFromMessages(e){let t=0,n=0,r=0;"gpt-3.5-turbo-0301"===this.model?(n=4,r=-1):(n=3,r=1);const i=await Promise.all(e.map((async e=>{const i=await this.getNumTokens(e.content),s=await this.getNumTokens(lE(e)),a=void 0!==e.name?r+await this.getNumTokens(e.name):0;let o=i+n+s+a;const c=e;if("function"===c._getType()&&(o-=2),c.additional_kwargs?.function_call&&(o+=3),c?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(c.additional_kwargs.function_call?.name)),c.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(c.additional_kwargs.function_call?.arguments)))}catch(e){console.error("Error parsing function arguments",e,JSON.stringify(c.additional_kwargs.function_call)),o+=await this.getNumTokens(c.additional_kwargs.function_call?.arguments)}return t+=o,o})));return t+=3,{totalCount:t,countPerMessage:i}}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call((async()=>{try{return await this.client.chat.completions.create(e,n)}catch(e){throw function(e){let t;return e.constructor.name===xd.name?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===Od.name?(t=new Error(e.message),t.name="AbortError"):t=e,t}(e)}}))}_getClientOptions(e){if(!this.client){const e=function(e){const{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:i,baseURL:s}=e;if(r&&i&&t)return`${i}/${t}`;if(r){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${t}`}return s}({azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new Jm(t)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce(((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e)),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,r,i,s;var a;let o,c;if(void 0!==(a=e)&&"object"==typeof a.schema?(n=e.schema,r=e.name,i=e.method,s=e.includeRaw):(n=e,r=t?.name,i=t?.method,s=t?.includeRaw),"jsonMode"===i)o=this.bind({response_format:{type:"json_object"}}),c=mE(n)?tE.fromZodSchema(n):new nE;else{let e=r??"extract";if(mE(n)){const t=Sb(n);o=this.bind({tools:[{type:"function",function:{name:e,description:t.description,parameters:t}}],tool_choice:{type:"function",function:{name:e}}}),c=new oE({returnSingle:!0,keyName:e,zodSchema:n})}else{let t;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(t=n,e=n.name):(e=n.title??e,t={name:e,description:n.description??"",parameters:n}),o=this.bind({tools:[{type:"function",function:t}],tool_choice:{type:"function",function:{name:e}}}),c=new oE({returnSingle:!0,keyName:e})}}if(!s)return o.pipe(c);const u=Gb.assign({parsed:(e,t)=>c.invoke(e.raw,t)}),l=Gb.assign({parsed:()=>null}),h=u.withFallbacks({fallbacks:[l]});return Db.from([{raw:o},h])}}function mE(e){return"function"==typeof e?.parse}class gE extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}class yE extends zb{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1})}async invoke(e,t){return this.call(e,Yw(t))}async call(e,t,n){let r;try{r=await this.schema.parseAsync(e)}catch(t){throw new gE("Received tool input did not match expected schema",JSON.stringify(e))}const i=function(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}(t),s=await pw.configure(i.callbacks,this.callbacks,i.tags||n,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),a=await(s?.handleToolStart(this.toJSON(),"string"==typeof r?r:JSON.stringify(r),i.runId,void 0,void 0,void 0,i.runName));let o;delete i.runId;try{o=await this._call(r,a,i)}catch(e){throw await(a?.handleToolError(e)),e}return await(a?.handleToolEnd(o)),o}}class vE extends yE{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:E_.object({input:E_.string().optional()}).transform((e=>e.input))})}call(e,t){return super.call("string"!=typeof e&&e?e:{input:e},t)}}function _E(){return new pE({})}Object.defineProperty(class extends vE{static lc_name(){return"DallEAPIWrapper"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t={apiKey:e?.apiKey??e?.openAIApiKey??Ng("OPENAI_API_KEY"),organization:e?.organization??Ng("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0};this.client=new Jm(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.responseFormat=e?.responseFormat??this.responseFormat,this.user=e?.user}async _call(e){const t=await this.client.images.generate({model:this.model,prompt:e,n:this.n,size:this.size,response_format:this.responseFormat,style:this.style,quality:this.quality,user:this.user});let n="";return"url"===this.responseFormat?[n]=t.data.map((e=>e.url)).filter((e=>"undefined"!==e)):[n]=t.data.map((e=>e.b64_json)).filter((e=>"undefined"!==e)),n}},"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});const wE=st({id:"dgen"});function bE(){return function(){if(_h()){wE("running openai in browser");let e=localStorage.OAAK;if(e)return new Jm({apiKey:e,dangerouslyAllowBrowser:!0});{let e="The OAAK localStorage variable is missing, please set it to proceed";throw window.alert(e),e}}return wE("running openai NOT in browser"),new Jm}()}async function EE(e){wE(`Using prompt: ${e}`),mh("prompt",e),wE("Requesting chat completion");const t=await bE().chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:"You are a helpful assistant."},{role:"user",content:e}]});wE("Accesing chat response...");let n=t.choices[0].message.content;mh("data_str",n),wE(`String= ${n}`),wE("Cleaning string");let r=IE(n);mh("cleaned_str",r),wE("Attempting parse");let i=JSON.parse(r);return mh("data",i),wE('Successfully parsed json data, available from debug.get("data")'),i}async function kE(e){const t=`Given the following text: "${e}", generate  (in JSON format) a random FHIR R4 Patient (with attributes such as name, gender, birthDate, and address) as well as a random set of 10 fhir resources (Observations, DiagnosticReports, DocumentReferences, etc) that match that patient's profile. Do not return anything other than the JSON string\n\n        It is absolutely ESSENTIAL THAT YOU RETURN THE RESULT AS A JSON OBJECT that represents a FHIR bundle and with the first character of output as "{" and the last character as "}". \n\n\n`;return await EE(t)}async function SE(e){try{const t=await kE(e);return wE(`Generated FHIR Patient data: ${JSON.stringify(t,null,2)}`),t}catch(e){console.error("Error generating FHIR data:",e)}}async function TE(e){try{const t=`Generate a set of loinc codes in JSON format (only output the json string, nothing else) which can be used to represent the following free text: ${e} . \n\n        It is absolutely ESSENTIAL THAT YOU RETURN THE RESULT AS A JSON ARRAY OF LOINC OBECTS with the first character of output as "[" and the last character as "]". \n\n  `,n=await EE(t);return wE("Received the following loinc objects"),console.log(n),n}catch(e){console.error("Error:",e)}}function IE(e){return(e=(e=(e=e.replace(/\\n/g,"").replace(/\\"/g,'"')).replace(/\n/g,"")).replace("```json","")).replace("```","")}function OE(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function AE(e,t,n,r,i){e[t]=n,OE(e,t,r,i)}function xE(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(((n,r)=>xE(e,t,n)))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return PE(e,t)}}const PE=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":AE(n,"minimum",r.value,r.message,t);break;case"max":AE(n,"maximum",r.value,r.message,t)}return n};let CE;const NE={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(void 0===CE&&(CE=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),CE),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function RE(e,t){const n={type:"string"};function r(e){return"escape"===t.patternStrategy?jE(e):e}if(e.checks)for(const i of e.checks)switch(i.kind){case"min":AE(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,i.value):i.value,i.message,t);break;case"max":AE(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,i.value):i.value,i.message,t);break;case"email":switch(t.emailStrategy){case"format:email":LE(n,"email",i.message,t);break;case"format:idn-email":LE(n,"idn-email",i.message,t);break;case"pattern:zod":DE(n,NE.email,i.message,t)}break;case"url":LE(n,"uri",i.message,t);break;case"uuid":LE(n,"uuid",i.message,t);break;case"regex":DE(n,i.regex,i.message,t);break;case"cuid":DE(n,NE.cuid,i.message,t);break;case"cuid2":DE(n,NE.cuid2,i.message,t);break;case"startsWith":DE(n,RegExp(`^${r(i.value)}`),i.message,t);break;case"endsWith":DE(n,RegExp(`${r(i.value)}$`),i.message,t);break;case"datetime":LE(n,"date-time",i.message,t);break;case"date":LE(n,"date",i.message,t);break;case"time":LE(n,"time",i.message,t);break;case"duration":LE(n,"duration",i.message,t);break;case"length":AE(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,i.value):i.value,i.message,t),AE(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,i.value):i.value,i.message,t);break;case"includes":DE(n,RegExp(r(i.value)),i.message,t);break;case"ip":"v6"!==i.version&&LE(n,"ipv4",i.message,t),"v4"!==i.version&&LE(n,"ipv6",i.message,t);break;case"emoji":DE(n,NE.emoji,i.message,t);break;case"ulid":DE(n,NE.ulid,i.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":LE(n,"binary",i.message,t);break;case"contentEncoding:base64":AE(n,"contentEncoding","base64",i.message,t);break;case"pattern:zod":DE(n,NE.base64,i.message,t)}break;case"nanoid":DE(n,NE.nanoid,i.message,t)}return n}const jE=e=>Array.from(e).map((e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`)).join(""),LE=(e,t,n,r)=>{e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):AE(e,"format",t,n,r)},DE=(e,t,n,r)=>{e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:ME(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):AE(e,"pattern",ME(t,r),n,r)},ME=(e,t)=>{const n="function"==typeof e?e():e;if(!t.applyRegexFlags||!n.flags)return n.source;const r=n.flags.includes("i"),i=n.flags.includes("m"),s=n.flags.includes("s"),a=r?n.source.toLowerCase():n.source;let o="",c=!1,u=!1,l=!1;for(let e=0;e<a.length;e++)if(c)o+=a[e],c=!1;else{if(r)if(u){if(a[e].match(/[a-z]/)){l?(o+=a[e],o+=`${a[e-2]}-${a[e]}`.toUpperCase(),l=!1):"-"===a[e+1]&&a[e+2]?.match(/[a-z]/)?(o+=a[e],l=!0):o+=`${a[e]}${a[e].toUpperCase()}`;continue}}else if(a[e].match(/[a-z]/)){o+=`[${a[e]}${a[e].toUpperCase()}]`;continue}if(i){if("^"===a[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===a[e]){o+="($|(?=[\r\n]))";continue}}s&&"."===a[e]?o+=u?`${a[e]}\r\n`:`[${a[e]}\r\n]`:(o+=a[e],"\\"===a[e]?c=!0:u&&"]"===a[e]?u=!1:u||"["!==a[e]||(u=!0))}try{new RegExp(o)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return o};function $E(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===Uv.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((n,r)=>({...n,[r]:qE(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}})),{}),additionalProperties:!1};const n={type:"object",additionalProperties:qE(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===Uv.ZodString&&e.keyType._def.checks?.length){const r=Object.entries(RE(e.keyType._def,t)).reduce(((e,[t,n])=>"type"===t?e:{...e,[t]:n}),{});return{...n,propertyNames:r}}return e.keyType?._def.typeName===Uv.ZodEnum?{...n,propertyNames:{enum:e.keyType._def.values}}:n}const UE={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},FE=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,n)=>qE(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return n.length?{anyOf:n}:void 0};function BE(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:qE(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:qE(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}const VE=Symbol("Let zodToJsonSchema decide on which parser to use"),zE={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function qE(e,t,n=!1){const r=t.seen.get(e);if(t.override){const i=t.override?.(e,t,r,n);if(i!==VE)return i}if(r&&!n){const e=HE(r,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}const i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);const s=WE(e,e.typeName,t,n);return s&&GE(e,t,s),i.jsonSchema=s,s}const HE=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":const n=e.path.slice(t.basePath.length+1).join("_");return n!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[n]=e.def),{$ref:[...t.basePath,t.definitionPath,n].join("/")};case"relative":return{$ref:KE(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,n)=>t.currentPath[n]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},KE=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},WE=(e,t,n,r)=>{switch(t){case Uv.ZodString:return RE(e,n);case Uv.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",OE(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?AE(n,"minimum",r.value,r.message,t):AE(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),AE(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?AE(n,"maximum",r.value,r.message,t):AE(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),AE(n,"maximum",r.value,r.message,t));break;case"multipleOf":AE(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case Uv.ZodObject:return function(e,t){const n={type:"object",...Object.entries(e.shape()).reduce(((e,[n,r])=>{if(void 0===r||void 0===r._def)return e;const i=qE(r._def,{...t,currentPath:[...t.currentPath,"properties",n],propertyPath:[...t.currentPath,"properties",n]});return void 0===i?e:{properties:{...e.properties,[n]:i},required:r.isOptional()&&!t.openaiStrictMode?e.required:[...e.required,n]}}),{properties:{},required:[]}),additionalProperties:BE(e,t)};return n.required.length||delete n.required,n}(e,n);case Uv.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?AE(n,"minimum",r.value,r.message,t):AE(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),AE(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?AE(n,"maximum",r.value,r.message,t):AE(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),AE(n,"maximum",r.value,r.message,t));break;case"multipleOf":AE(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case Uv.ZodBoolean:return{type:"boolean"};case Uv.ZodDate:return xE(e,n);case Uv.ZodUndefined:return{not:{}};case Uv.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case Uv.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def?.typeName!==Uv.ZodAny&&(n.items=qE(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&AE(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&AE(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(AE(n,"minItems",e.exactLength.value,e.exactLength.message,t),AE(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case Uv.ZodUnion:case Uv.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return FE(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every((e=>e._def.typeName in UE&&(!e._def.checks||!e._def.checks.length)))){const e=n.reduce(((e,t)=>{const n=UE[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e}),[]);return{type:e.length>1?e:e[0]}}if(n.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=n.reduce(((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===n.length){const t=e.filter(((e,t,n)=>n.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:n.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(n.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:n.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return FE(e,t)}(e,n);case Uv.ZodIntersection:return function(e,t){const n=[qE(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),qE(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const i=[];return n.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;i.push(t)}else i.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t})),i.length?{allOf:i,...r}:void 0}(e,n);case Uv.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,n)=>qE(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:qE(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,n)=>qE(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,n);case Uv.ZodRecord:return $E(e,n);case Uv.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case Uv.ZodEnum:return function(e){return{type:"string",enum:[...e.values]}}(e);case Uv.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])).map((e=>t[e])),r=Array.from(new Set(n.map((e=>typeof e))));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case Uv.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target||"property"===t.nullableStrategy?{type:UE[e.innerType._def.typeName],nullable:!0}:{type:[UE[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=qE(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=qE(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case Uv.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return qE(e.innerType._def,t);const n=qE(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case Uv.ZodMap:return function(e,t){return"record"===t.mapStrategy?$E(e,t):{type:"array",maxItems:125,items:{type:"array",items:[qE(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},qE(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case Uv.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:qE(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&AE(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&AE(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case Uv.ZodLazy:return qE(e.getter()._def,n);case Uv.ZodPromise:return function(e,t){return qE(e.type._def,t)}(e,n);case Uv.ZodNaN:case Uv.ZodNever:return{not:{}};case Uv.ZodEffects:return function(e,t,n){return"input"===t.effectStrategy?qE(e.schema._def,t,n):{}}(e,n,r);case Uv.ZodAny:case Uv.ZodUnknown:return{};case Uv.ZodDefault:return function(e,t){return{...qE(e.innerType._def,t),default:e.defaultValue()}}(e,n);case Uv.ZodBranded:return function(e,t){return qE(e.type._def,t)}(e,n);case Uv.ZodReadonly:case Uv.ZodCatch:return((e,t)=>qE(e.innerType._def,t))(e,n);case Uv.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return qE(e.in._def,t);if("output"===t.pipeStrategy)return qE(e.out._def,t);const n=qE(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,qE(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter((e=>void 0!==e))}})(e,n);case Uv.ZodFunction:case Uv.ZodVoid:case Uv.ZodSymbol:default:return}},GE=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),ZE=e=>"_def"in e?e._def:e,JE=(e,t)=>{const n=(e=>{const t=(e=>"string"==typeof e?{...zE,basePath:["#"],definitions:{},name:e}:{...zE,basePath:["#"],definitions:{},...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map((([e,n])=>[ZE(n),{def:ZE(n),path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}})(t),r="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,i=qE(e._def,void 0===r?n:{...n,currentPath:[...n.basePath,n.definitionPath,r]},!1)??{},s="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==s&&(i.title=s);const a=(()=>{if(function(e){if(!e)return!0;for(const t in e)return!1;return!0}(n.definitions))return;const e={},t=new Set;for(let r=0;r<500;r++){const r=Object.entries(n.definitions).filter((([e])=>!t.has(e)));if(0===r.length)break;for(const[i,s]of r)e[i]=qE(ZE(s),{...n,currentPath:[...n.basePath,n.definitionPath,i]},!0)??{},t.add(i)}return e})(),o=void 0===r?a?{...i,[n.definitionPath]:a}:i:"duplicate-ref"===n.nameStrategy?{...i,...a||n.seenRefs.size?{[n.definitionPath]:{...a,...n.seenRefs.size?{[r]:i}:void 0}}:void 0}:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,r].join("/"),[n.definitionPath]:{...a,[r]:i}};return"jsonSchema7"===n.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===n.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function QE(e,t,n){return function(t,n){const r={...t};return Object.defineProperties(r,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t=>e.parse(JSON.parse(t)),enumerable:!1}}),r}({type:"json_schema",json_schema:{...n,name:t,strict:!0,schema:(r=e,i={name:t},JE(r,{openaiStrictMode:!0,name:i.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"}))}});var r,i}const XE=st({id:"oai"});function YE(){return function(){if(_h()){XE("running openai in browser");let e=localStorage.OAAK;if(e)return new Jm({apiKey:e,dangerouslyAllowBrowser:!0});{let e="The OAAK localStorage variable is missing, please set it to proceed";throw window.alert(e),e}}return XE("running openai NOT in browser"),new Jm}()}async function ek(){}async function tk(){let e=E_.object({name:E_.string(),balance:E_.number()}),t=E_.array(e),n=QE(E_.object({rooms:E_.array(t)}),"zr");return await nk({prompt:"Randomly Generate 3 separate Rooms with 3 unique users per room and return all results as json. Make the user balance in each room add to 1000",zrf:n})}async function nk(e){var t;let n=YE();XE("Generating structured json query"),XE("Requesting chat completion");const r=null===(t=(await n.beta.chat.completions.parse(e)).choices[0])||void 0===t?void 0:t.message;return(null==r?void 0:r.parsed)?(XE("Successfully parsed the message"),r.parsed):(XE("Failed to parse response"),XE(r),null)}async function rk(e,t){try{let n=YE();return(await n.embeddings.create({input:e,model:"text-embedding-3-large",dimensions:t})).data[0].embedding}catch(e){throw console.error("Error fetching embedding:",e),e}}var ik="\n";const sk="{patientInformation}",ak="{supplementaryInformation}";var ok=` \nYou are an expert clinical decision support pharmacist that identifies medications within a patient patientInformationn text and providesextracts the medications along with supplemental data in structured format.  \n\n<patientInformation> \n${sk} \n</patientInformation> \n\nYour json output consists of an array of medication objects. \nEach objects contains the fields: name, medication_class, intended_effects, adverse_effects , interacts_with_medication , interacts_with_class. \nname is the name of the medication. \nmedication_class is the medication's class or pharmacologic category \nintended_effects is a list of the intended effect of the medication. \nadverse_effects is a list of the most common adverse effects of the medication.\ninteracts_with_medication is a short list of the medications which can interact with this medication to create a dangerous effect. \ninteracts_with_class is a short list of the medication classes which can interact with this medication to create a dangerous effect.  \n\nDo not guess or extrapolate. \n`;let ck=E_.object({name:E_.string(),medication_class:E_.string(),intended_effects:E_.array(E_.string()),adverse_effects:E_.array(E_.string()),interacts_with_medication:E_.array(E_.string()),interacts_with_class:E_.array(E_.string())});var uk=QE(E_.object({data:E_.array(ck)}),"medication_extraction"),lk={prompt:ok,rf:uk},hk=`\nYou are an expert clinical decision support pharmacist that provides unique and valuable feedback to the user. \nYou focus on identifying medication adverse effects and interactions that should be noted.\nCarefully consider this patient and supplementary information:\n\n<patientInformation> \n${sk}\n</patientInformation> \n\n<supplementaryInformation> \n${ak}\n</supplementaryInformation> \n\nProvide a list of recommendations for the user in the following format:\n\nThe json output consists of an array of recommendation objects. \nEach object contains the fields: action, data, reasoning, caveat. \naction is one of the following: start, stop, increase, decrease \ndata is the name of the medication \nreasoning is a concise explanation of your thought process \ncaveat is additional information that should be taken into consideration, or an alternative viewpoint \n\nDo not recommend actions that that the user is already taking. \n`,dk=`\nYou are an expert clinical decision support pharmacist that provides unique and valuable feedback to the user. \nYou focus on identifying medication adverse effects and interactions that should be noted.\nCarefully consider this patient and supplementary information:\n\n<patientInformation> \n${sk}\n</patientInformation> \n\nProvide a list of recommendations for the user in the following format:\n\nThe json output consists of an array of recommendation objects. \nEach object contains the fields: action, data, reasoning, caveat. \naction is one of the following: start, stop, increase, decrease \ndata is the name of the medication \nreasoning is a concise explanation of your thought process \ncaveat is additional information that should be taken into consideration, or an alternative viewpoint \n\nDo not recommend actions that that the user is already taking. \n`;let fk=E_.object({action:E_.string(),data:E_.string(),reasoning:E_.string(),caveat:E_.string()});var pk=QE(E_.object({data:E_.array(fk)}),"medication_extraction"),mk={prompt:hk,rf:pk},gk={prompt:dk,rf:pk},yk="\n",vk="esrd_hyperkalemia_losartan",_k="This test case describes a patient with ESRD on HD and HTN that is admitted with hyperkalemia. The plan states to continue losartan however it should be identified that losartan should be held in order to prevent further episodes of hyperkalemia",wk="\n# History and Physical\n\n## Chief Complaint\nHyperkalemia and hypertension\n\n## One-liner\nA 46-year-old male with end-stage renal disease (ESRD) on hemodialysis (HD) presents with hyperkalemia and hypertension.\n\n## History of Present Illness\nThe patient is a 46-year-old male with a known history of end-stage renal disease on thrice-weekly hemodialysis who presents to the emergency department with laboratory-confirmed hyperkalemia. He reports that he missed his last dialysis session three days ago due to transportation issues, and since then, he has experienced intermittent palpitations and mild fatigue but denies any chest pain, shortness of breath, muscle weakness, or sensory changes. The patient also reports poorly controlled blood pressure over the past week despite adherence to his home antihypertensive regimen. He denies any recent dietary indiscretions or changes in liquid intake. No recent episodes of fever, cough, or diarrhea. \n\n## Emergency Department Course\nUpon presentation, the patient's vital signs were as follows: blood pressure 178/96 mmHg, heart rate 88 bpm, respiratory rate 18 breaths/min, temperature 98.4°F, and oxygen saturation 96% on room air. Laboratory tests revealed a serum potassium level of 6.8 mmol/L, elevated blood urea nitrogen (BUN) at 60 mg/dL, and creatinine at 9.5 mg/dL, consistent with ESRD. An EKG showed peaked T waves suggestive of hyperkalemia but no arrhythmias were present. The patient was given calcium gluconate 10% intravenously to stabilize cardiac membranes, insulin with dextrose for shifting potassium intracellularly, and received his scheduled dialysis session to remove excess potassium. Additionally, he was given furosemide to aid in the management of blood pressure and hyperkalemia.\n\n## Medications\n- Amlodipine 10 mg daily\n- Hydrochlorothiazide 25 mg daily\n- Losartan 50 mg daily\n\n## Allergies\nNo known drug allergies\n\n## Past Surgical History\nNone\n\n## Social History\nThe patient is a former smoker, quitting 5 years ago, and denies any illicit drug use. He occasionally consumes alcohol but denies drinking in the past month. He lives alone in an apartment and relies on public transportation.\n\n## Objective Data\n- **Vital Signs:** Blood Pressure: 150/94 mmHg, Heart Rate: 82 bpm, Respiratory Rate: 18 breaths/min, Temperature: 98.4°F, O2 Saturation: 96% on room air.\n- **Physical Exam:**\n  - **General:** The patient appears alert, oriented, and in no acute distress.\n  - **Cardiovascular:** Regular rate and rhythm, no murmurs, rubs, or gallops.\n  - **Respiratory:** Breath sounds clear bilaterally, no wheezes, rales, or rhonchi.\n  - **Abdomen:** Soft, non-tender, nondistended, normal bowel sounds.\n  - **Neurological:** No focal deficits, cranial nerves intact, strength 5/5 in all extremities.\n- **Laboratory Results:**\n  - Potassium: 6.8 mmol/L (decreased post-HD to 4.9 mmol/L)\n  - BUN: 60 mg/dL\n  - Creatinine: 9.5 mg/dL\n- **EKG Findings:** Peaked T waves, no ST-elevation or arrhythmias.\n\n## Assessment and Plan\n\n1. **Hyperkalemia**\n   - **Assessment:** The patient's hyperkalemia is likely due to missed dialysis in the context of ESRD. Initial treatment in the emergency department has been effective in lowering potassium levels.\n   - **Plan:** Continue regular dialysis sessions to manage potassium levels. Monitor potassium post-dialysis. Educate the patient on the importance of adherence to dialysis schedule.\n\n2. **Hypertension**\n   - **Assessment:** Poorly controlled hypertension, likely exacerbated by volume overload due to missed dialysis. \n   - **Plan:** Continue home antihypertensive regimen including amlodipine, hydrochlorothiazide, and losartan\n\n3. **End-Stage Renal Disease**\n   - **Assessment:** Stable ESRD on HD, complications related to missed dialysis.\n   - **Plan:** Optimize dialysis schedule adherence. Consider social work referral for transportation assistance or home dialysis evaluation. Regular follow-ups with nephrology.\n\nThe patient will be admitted for continuous monitoring and further management of hypertension post-dialysis.\n",bk="copd_vap",Ek="This test describes a COPD patient who presents with a COPD exacerbation and is intubated on admission. Several days later he develops pneumonia and is started on ceftriaxone. The correct response should suggest broadening antibiotics to include coverage for ventilaor acquired pneumonia",kk="\n# History and Physical\n\n## Chief Complaint\n**Pneumonia**\n\n## One-Liner\nA 65-year-old male with a history of COPD and hypertension is admitted with respiratory failure, currently on a ventilator due to suspected pneumonia.\n\n## History of Present Illness\nThe patient is a 65-year-old male with a significant medical history of chronic obstructive pulmonary disease (COPD) and hypertension, who was admitted to the hospital one week ago due to acute respiratory failure. Upon admission, the patient was intubated and placed on a mechanical ventilator. Over the past several days, the patient's respiratory status has shown minimal improvement, prompting further investigation. A chest X-ray revealed diffuse bilateral infiltrates suggestive of pneumonia. Given these findings, the decision was made to start the patient on ceftriaxone for suspected bacterial pneumonia. The patient has been febrile intermittently and has noted an increase in respiratory secretions, which are purulent in appearance. Blood cultures were obtained, and sputum samples were sent for gram stain and culture to identify any infectious organisms.\n\n## Emergency Department Course\nOn presentation, the patient's vital signs were significant for hypoxia and tachycardia. Initial labs revealed leukocytosis with a WBC count of 14,000/mm³ and an elevated C-reactive protein. Arterial blood gas showed severe hypoxemia. A chest X-ray demonstrated bilateral interstitial infiltrates. The patient was intubated for respiratory failure and started on ceftriaxone. Continuous monitoring of the patient's condition was conducted, with repeat chest imaging and labs every 48 hours to assess for changes in the clinical picture.\n\n## Medications\n- **Ceftriaxone** 1g IV every 24 hours  \n- **Lisinopril** 10mg PO daily  \n- **Albuterol inhaler** 2 puffs every 4 hours as needed  \n- **Prednisone** 40mg PO daily  \n\n## Allergies\n- **Penicillin** (rash)\n\n## Past Surgical History\n- Appendectomy at age 22  \n- Right total knee replacement 3 years ago  \n\n## Social History\n- Former smoker, quit 10 years ago, 30 pack-year history  \n- No illicit drug use  \n- Alcohol: occasional, 1-2 drinks per month  \n- Lives with spouse in a single-family home  \n\n## Objective Data\n\n### Vital Signs\n- **Temperature:** 100.4°F  \n- **Heart rate:** 98 bpm  \n- **Respiratory rate:** 18 breaths/min (ventilated)  \n- **Blood pressure:** 135/85 mmHg  \n- **Oxygen saturation:** 94% on ventilator settings of FiO2 40%  \n\n### Physical Exam\n- **General:** Sedated and intubated, appearing mildly distressed  \n- **Lungs:** Decreased breath sounds bilaterally, rhonchi present  \n- **Cardiovascular:** Regular rate and rhythm, no murmurs  \n- **Abdomen:** Soft, non-tender, no organomegaly  \n- **Extremities:** No edema  \n\n### Laboratory/Imaging\n- **WBC:** 14,000/mm³  \n- **C-reactive protein:** Elevated  \n- **Chest X-ray:** Bilateral diffuse infiltrates consistent with pneumonia  \n- **Arterial Blood Gas:** pH 7.32, PaCO2 55 mmHg, PaO2 60 mmHg  \n\n## Assessment and Plan\n\n1. **Suspected Bacterial Pneumonia**\n   - **Assessment:** Bilateral infiltrates on chest X-ray and clinical presentation suggest pneumonia, likely bacterial in origin. Purulent respiratory secretions and recent intubation history further support this diagnosis.\n   - **Plan:** Continue ceftriaxone.  \n\n2. **Acute Respiratory Failure**\n   - **Assessment:** Respiratory failure necessitated intubation and mechanical ventilation, likely secondary to pneumonia on a background of COPD.\n   - **Plan:** Continue ventilatory support with daily ABG checks, titrate FiO2 to maintain adequate oxygenation, pulmonary hygiene, and physiotherapy as tolerated.  \n\n3. **COPD Exacerbation**\n   - **Assessment:** Underlying COPD may have been exacerbated by pneumonia, contributing to respiratory failure.\n   - **Plan:** Continue bronchodilator therapy, taper prednisone as patient stabilizes, monitor for signs of improvement in lung function.  \n\n4. **Hypertension**\n   - **Assessment:** Previously well-controlled on lisinopril. Blood pressure within normal limits currently.\n   - **Plan:** Continue lisinopril, monitor blood pressure daily. Adjust anti-hypertensive therapy if necessary.\n",Sk=i(46),Tk={temperature:0};class Ik extends Sk.EventEmitter{constructor(e){super(),this.name=e.name,this.model=e.model,this.logger=st({id:`amie:${e.name}`})}init(){this.log(`Created engine ${this.name} with model ${this.model}`)}log(e){this.logger(e),this.emit("log",{data:e})}async structured_completion(e){let{prompt:t,response_format:n}=e,r=[{role:"user",content:t}],i=this.model,s=Object.assign(Object.assign({},Tk),{messages:r,model:i,response_format:n});this.log("Request to call structured completion"),mh("SC_ARGS",s);let a=await fetch("https://www.tidyscripts.com/api/openai_structured_completion",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});return await a.json()}}const{patient_information_placeholder:Ok,supplementary_information_placeholder:Ak,extraction:xk,evaluation:Pk,evaluation_without_supplementary_data:Ck}=E;class Nk extends Ik{constructor(e){let{supplementary_data:t,verbose:n=!0}=e;!function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}}(e,["supplementary_data","verbose"]),super(e),this.supplementary_data=t,this.verbose=n}async extract_medication_information(e){let t=xk.prompt.replace(Ok,e),n=xk.rf,r=await this.structured_completion({prompt:t,response_format:n});return this.log("Got extraction result"),mh("extraction_result",r),this.verbose&&this.log(r),r}async build_prompt(e){var t;if(this.supplementary_data){this.log("running WITH supplementary data");let n=await this.extract_medication_information(e);t=Pk.prompt.replace(Ok,e).replace(Ak,JSON.stringify(n))}else this.log("running WITHOUT supplementary data"),t=Ck.prompt.replace(Ok,e);return t}async evaluate(e){let t=await this.build_prompt(e),n=Pk.rf,r=await this.structured_completion({prompt:t,response_format:n});return this.log("Got evaluation result"),mh("evaluation_result",r),this.verbose&&this.log(r),r}}const Rk=st({id:"tamie"});function jk(){Rk("init")}async function Lk(){jk();let e=T,t=new Nk({model:"gpt-4o",name:"me-4o-data",supplementary_data:!0}),n=new Nk({model:"gpt-4o",name:"me-4o",supplementary_data:!1}),r=await t.evaluate(e.hp),i=await n.evaluate(e.hp);return{me_4o_data:t,me_4o:n,me_4o_data_result:r,me_4o_result:i}}const Dk=st({id:"amie"});function Mk(){Dk("init")}const $k={methods:{one:{},two:{},three:{},four:{}},model:{one:{},two:{},three:{}},compute:{},hooks:[]},Uk={compute:function(e){const{world:t}=this,n=t.compute;return"string"==typeof e&&n.hasOwnProperty(e)?n[e](this):(e=>"[object Array]"===Object.prototype.toString.call(e))(e)?e.forEach((r=>{t.compute.hasOwnProperty(r)?n[r](this):console.warn("no compute:",e)})):"function"==typeof e?e(this):console.warn("no compute:",e),this}},Fk=Uk,Bk={forEach:function(e){return this.fullPointer.forEach(((t,n)=>{let r=this.update([t]);e(r,n)})),this},map:function(e,t){let n=this.fullPointer.map(((t,n)=>{let r=this.update([t]),i=e(r,n);return void 0===i?this.none():i}));if(0===n.length)return t||this.update([]);if(void 0!==n[0]){if("string"==typeof n[0])return n;if("object"==typeof n[0]&&(null===n[0]||!n[0].isView))return n}let r=[];return n.forEach((e=>{r=r.concat(e.fullPointer)})),this.toView(r)},filter:function(e){let t=this.fullPointer;return t=t.filter(((t,n)=>{let r=this.update([t]);return e(r,n)})),this.update(t)},find:function(e){let t=this.fullPointer.find(((t,n)=>{let r=this.update([t]);return e(r,n)}));return this.update([t])},some:function(e){return this.fullPointer.some(((t,n)=>{let r=this.update([t]);return e(r,n)}))},random:function(e=1){let t=this.fullPointer,n=Math.floor(Math.random()*t.length);return n+e>this.length&&(n=this.length-e,n=n<0?0:n),t=t.slice(n,n+e),this.update(t)}},Vk={termList:function(){return this.methods.one.termList(this.docs)},terms:function(e){let t=this.match(".");return"number"==typeof e?t.eq(e):t},groups:function(e){if(e||0===e)return this.update(this._groups[e]||[]);let t={};return Object.keys(this._groups).forEach((e=>{t[e]=this.update(this._groups[e])})),t},eq:function(e){let t=this.pointer;return t||(t=this.docs.map(((e,t)=>[t]))),t[e]?this.update([t[e]]):this.none()},first:function(){return this.eq(0)},last:function(){let e=this.fullPointer.length-1;return this.eq(e)},firstTerms:function(){return this.match("^.")},lastTerms:function(){return this.match(".$")},slice:function(e,t){let n=this.pointer||this.docs.map(((e,t)=>[t]));return n=n.slice(e,t),this.update(n)},all:function(){return this.update().toView()},fullSentences:function(){let e=this.fullPointer.map((e=>[e[0]]));return this.update(e).toView()},none:function(){return this.update([])},isDoc:function(e){if(!e||!e.isView)return!1;let t=this.fullPointer,n=e.fullPointer;return!t.length!==n.length&&t.every(((e,t)=>!!n[t]&&e[0]===n[t][0]&&e[1]===n[t][1]&&e[2]===n[t][2]))},wordCount:function(){return this.docs.reduce(((e,t)=>e+t.filter((e=>""!==e.text)).length),0)},isFull:function(){let e=this.pointer;if(!e)return!0;if(0===e.length||0!==e[0][0])return!1;let t=0,n=0;return this.document.forEach((e=>t+=e.length)),this.docs.forEach((e=>n+=e.length)),t===n},getNth:function(e){return"number"==typeof e?this.eq(e):"string"==typeof e?this.if(e):this}};Vk.group=Vk.groups,Vk.fullSentence=Vk.fullSentences,Vk.sentence=Vk.fullSentences,Vk.lastTerm=Vk.lastTerms,Vk.firstTerm=Vk.firstTerms;const zk=Vk,qk=Object.assign({},zk,Fk,Bk);qk.get=qk.eq;const Hk=qk;class Kk{constructor(e,t,n={}){[["document",e],["world",$k],["_groups",n],["_cache",null],["viewType","View"]].forEach((e=>{Object.defineProperty(this,e[0],{value:e[1],writable:!0})})),this.ptrs=t}get docs(){let e=this.document;return this.ptrs&&(e=$k.methods.one.getDoc(this.ptrs,this.document)),e}get pointer(){return this.ptrs}get methods(){return this.world.methods}get model(){return this.world.model}get hooks(){return this.world.hooks}get isView(){return!0}get found(){return this.docs.length>0}get length(){return this.docs.length}get fullPointer(){let{docs:e,ptrs:t,document:n}=this,r=t||e.map(((e,t)=>[t]));return r.map((e=>{let[t,r,i,s,a]=e;return r=r||0,i=i||(n[t]||[]).length,n[t]&&n[t][r]&&(s=s||n[t][r].id,n[t][i-1]&&(a=a||n[t][i-1].id)),[t,r,i,s,a]}))}update(e){let t=new Kk(this.document,e);if(this._cache&&e&&e.length>0){let n=[];e.forEach(((e,t)=>{let[r,i,s]=e;(1===e.length||0===i&&this.document[r].length===s)&&(n[t]=this._cache[r])})),n.length>0&&(t._cache=n)}return t.world=this.world,t}toView(e){return new Kk(this.document,e||this.pointer)}fromText(e){const{methods:t}=this;let n=t.one.tokenize.fromString(e,this.world),r=new Kk(n);return r.world=this.world,r.compute(["normal","freeze","lexicon"]),this.world.compute.preTagger&&r.compute("preTagger"),r.compute("unfreeze"),r}clone(){let e=this.document.slice(0);e=e.map((e=>e.map((e=>((e=Object.assign({},e)).tags=new Set(e.tags),e)))));let t=this.update(this.pointer);return t.document=e,t._cache=this._cache,t}}Object.assign(Kk.prototype,Hk);const Wk=Kk,Gk=function(e){return e&&"object"==typeof e&&!Array.isArray(e)};function Zk(e,t){if(Gk(t))for(const n in t)Gk(t[n])?(e[n]||Object.assign(e,{[n]:{}}),Zk(e[n],t[n])):Object.assign(e,{[n]:t[n]});return e}const Jk=function(e,t,n,r){const{methods:i,model:s,compute:a,hooks:o}=t;e.methods&&function(e,t){for(const n in t)e[n]=e[n]||{},Object.assign(e[n],t[n])}(i,e.methods),e.model&&Zk(s,e.model),e.irregulars&&function(e,t){let n=e.two.models||{};Object.keys(t).forEach((e=>{t[e].pastTense&&(n.toPast&&(n.toPast.ex[e]=t[e].pastTense),n.fromPast&&(n.fromPast.ex[t[e].pastTense]=e)),t[e].presentTense&&(n.toPresent&&(n.toPresent.ex[e]=t[e].presentTense),n.fromPresent&&(n.fromPresent.ex[t[e].presentTense]=e)),t[e].gerund&&(n.toGerund&&(n.toGerund.ex[e]=t[e].gerund),n.fromGerund&&(n.fromGerund.ex[t[e].gerund]=e)),t[e].comparative&&(n.toComparative&&(n.toComparative.ex[e]=t[e].comparative),n.fromComparative&&(n.fromComparative.ex[t[e].comparative]=e)),t[e].superlative&&(n.toSuperlative&&(n.toSuperlative.ex[e]=t[e].superlative),n.fromSuperlative&&(n.fromSuperlative.ex[t[e].superlative]=e))}))}(s,e.irregulars),e.compute&&Object.assign(a,e.compute),o&&(t.hooks=o.concat(e.hooks||[])),e.api&&e.api(n),e.lib&&Object.keys(e.lib).forEach((t=>r[t]=e.lib[t])),e.tags&&r.addTags(e.tags),e.words&&r.addWords(e.words),e.frozen&&r.addWords(e.frozen,!0),e.mutate&&e.mutate(t,r)},Qk=function(e){return"[object Array]"===Object.prototype.toString.call(e)},Xk=function(e,t,n){const{methods:r}=n;let i=new t([]);if(i.world=n,"number"==typeof e&&(e=String(e)),!e)return i;if("string"==typeof e)return new t(r.one.tokenize.fromString(e,n));if(s=e,"[object Object]"===Object.prototype.toString.call(s)&&e.isView)return new t(e.document,e.ptrs);var s;if(Qk(e)){if(Qk(e[0])){let n=e.map((e=>e.map((e=>({text:e,normal:e,pre:"",post:" ",tags:new Set})))));return new t(n)}let n=function(e){return e.map((e=>e.terms.map((e=>(Qk(e.tags)&&(e.tags=new Set(e.tags)),e)))))}(e);return new t(n)}return i};let Yk=Object.assign({},$k);const eS=function(e,t){t&&eS.addWords(t);let n=Xk(e,Wk,Yk);return e&&n.compute(Yk.hooks),n};Object.defineProperty(eS,"_world",{value:Yk,writable:!0}),eS.tokenize=function(e,t){const{compute:n}=this._world;t&&eS.addWords(t);let r=Xk(e,Wk,Yk);return n.contractions&&r.compute(["alias","normal","machine","contractions"]),r},eS.plugin=function(e){return Jk(e,this._world,Wk,this),this},eS.extend=eS.plugin,eS.world=function(){return this._world},eS.model=function(){return this._world.model},eS.methods=function(){return this._world.methods},eS.hooks=function(){return this._world.hooks},eS.verbose=function(e){const t="undefined"!=typeof process&&process.env?process.env:self.env||{};return t.DEBUG_TAGS="tagger"===e||!0===e||"",t.DEBUG_MATCH="match"===e||!0===e||"",t.DEBUG_CHUNKS="chunker"===e||!0===e||"",this},eS.version="14.14.4";const tS=eS,nS={cache:function(){return this._cache=this.methods.one.cacheDoc(this.document),this},uncache:function(){return this._cache=null,this}},rS={api:function(e){Object.assign(e.prototype,nS)},compute:{cache:function(e){e._cache=e.methods.one.cacheDoc(e.document)}},methods:{one:{cacheDoc:function(e){let t=e.map((e=>{let t=new Set;return e.forEach((e=>{""!==e.normal&&t.add(e.normal),e.switch&&t.add(`%${e.switch}%`),e.implicit&&t.add(e.implicit),e.machine&&t.add(e.machine),e.root&&t.add(e.root),e.alias&&e.alias.forEach((e=>t.add(e)));let n=Array.from(e.tags);for(let e=0;e<n.length;e+=1)t.add("#"+n[e])})),t}));return t}}}},iS=e=>/^\p{Lu}[\p{Ll}'’]/u.test(e)||/^\p{Lu}$/u.test(e),sS=(e,t,n)=>{if(n.forEach((e=>e.dirty=!0)),e){let r=[t,0].concat(n);Array.prototype.splice.apply(e,r)}return e},aS=function(e){let t=e[e.length-1];!t||/ $/.test(t.post)||/[-–—]/.test(t.post)||(t.post+=" ")},oS=(e,t,n)=>{const r=/[-.?!,;:)–—'"]/g;let i=e[t-1];if(!i)return;let s=i.post;if(r.test(s)){let e=s.match(r).join(""),t=n[n.length-1];t.post=e+t.post,i.post=i.post.replace(r,"")}};let cS=0;const uS=e=>(e=e.length<3?"0"+e:e).length<3?"0"+e:e,lS=function(e){let[t,n]=e.index||[0,0];cS+=1,cS=cS>46655?0:cS,t=t>46655?0:t,n=n>1294?0:n;let r=uS(cS.toString(36));r+=uS(t.toString(36));let i=n.toString(36);return i=i.length<2?"0"+i:i,r+=i,r+=parseInt(36*Math.random(),10).toString(36),e.normal+"|"+r.toUpperCase()},hS=function(e){e.has("@hasContraction")&&"function"==typeof e.contractions&&e.grow("@hasContraction").contractions().expand()},dS=e=>"[object Array]"===Object.prototype.toString.call(e),fS=function(e,t,n){const{document:r,world:i}=t;t.uncache();let s=t.fullPointer,a=t.fullPointer;t.forEach(((o,c)=>{let u=o.fullPointer[0],[l]=u,h=r[l],d=function(e,t){const{methods:n}=t;return"string"==typeof e?n.one.tokenize.fromString(e,t)[0]:"object"==typeof e&&e.isView?e.clone().docs[0]||[]:dS(e)?dS(e[0])?e[0]:e:[]}(e,i);0!==d.length&&(d=function(e){return e.map((e=>(e.id=lS(e),e)))}(d),n?(hS(t.update([u]).firstTerm()),function(e,t,n,r){let[i,s,a]=t;0===s||a===r[i].length?aS(n):(aS(n),aS([e[t[1]]])),function(e,t,n){let r=e[t];if(0!==t||!iS(r.text))return;n[0].text=(e=>e.replace(/^\p{Ll}/u,(e=>e.toUpperCase())))(n[0].text);let i=e[t];i.tags.has("ProperNoun")||i.tags.has("Acronym")||iS(i.text)&&i.text.length>1&&(i.text=(e=>e.replace(/^\p{Lu}/u,(e=>e.toLowerCase())))(i.text))}(e,s,n),sS(e,s,n)}(h,u,d,r)):(hS(t.update([u]).lastTerm()),function(e,t,n,r){let[i,,s]=t,a=(r[i]||[]).length;s<a?(oS(e,s,n),aS(n)):a===s&&(aS(e),oS(e,s,n),r[i+1]&&(n[n.length-1].post+=" ")),sS(e,t[2],n),t[4]=n[n.length-1].id}(h,u,d,r)),r[l]&&r[l][u[1]]&&(u[3]=r[l][u[1]].id),a[c]=u,u[2]+=d.length,s[c]=u)}));let o=t.toView(s);return t.ptrs=a,o.compute(["id","index","freeze","lexicon"]),o.world.compute.preTagger&&o.compute("preTagger"),o.compute("unfreeze"),o},pS={insertAfter:function(e){return fS(e,this,!1)},insertBefore:function(e){return fS(e,this,!0)}};pS.append=pS.insertAfter,pS.prepend=pS.insertBefore,pS.insert=pS.insertAfter;const mS=pS,gS=/\$[0-9a-z]+/g,yS={},vS=e=>e.replace(/^\p{Ll}/u,(e=>e.toUpperCase())),_S=e=>e.replace(/^\p{Lu}/u,(e=>e.toLowerCase()));yS.replaceWith=function(e,t={}){let n=this.fullPointer,r=this;if(this.uncache(),"function"==typeof e)return function(e,t,n){return e.forEach((e=>{let r=t(e);e.replaceWith(r,n)})),e}(r,e,t);let i=r.docs[0];if(!i)return r;let s=t.possessives&&i[i.length-1].tags.has("Possessive"),a=t.case&&(e=>/^\p{Lu}[\p{Ll}'’]/u.test(e)||/^\p{Lu}$/u.test(e))(i[0].text);e=function(e,t){if("string"!=typeof e)return e;let n=t.groups();return e=e.replace(gS,(e=>{let t=e.replace(/\$/,"");return n.hasOwnProperty(t)?n[t].text():e})),e}(e,r);let o=this.update(n);n=n.map((e=>e.slice(0,3)));let c=(o.docs[0]||[]).map((e=>Array.from(e.tags))),u=o.docs[0][0].pre,l=o.docs[0][o.docs[0].length-1].post;if("string"==typeof e&&(e=this.fromText(e).compute("id")),r.insertAfter(e),o.has("@hasContraction")&&r.contractions&&r.grow("@hasContraction+").contractions().expand(),r.delete(o),s){let e=r.docs[0],t=e[e.length-1];t.tags.has("Possessive")||(t.text+="'s",t.normal+="'s",t.tags.add("Possessive"))}if(u&&r.docs[0]&&(r.docs[0][0].pre=u),l&&r.docs[0]){let e=r.docs[0][r.docs[0].length-1];e.post.trim()||(e.post=l)}let h=r.toView(n).compute(["index","freeze","lexicon"]);if(h.world.compute.preTagger&&h.compute("preTagger"),h.compute("unfreeze"),t.tags&&h.terms().forEach(((e,t)=>{e.tagSafe(c[t])})),!h.docs[0]||!h.docs[0][0])return h;if(t.case){let e=a?vS:_S;h.docs[0][0].text=e(h.docs[0][0].text)}return h},yS.replace=function(e,t,n){if(e&&!t)return this.replaceWith(e,n);let r=this.match(e);return r.found?(this.soften(),r.replaceWith(t,n)):this};const wS=yS,bS={remove:function(e){const{indexN:t}=this.methods.one.pointer;this.uncache();let n=this.all(),r=this;e&&(n=this,r=this.match(e));let i=!n.ptrs;r.has("@hasContraction")&&r.contractions&&r.grow("@hasContraction").contractions().expand();let s=n.fullPointer,a=r.fullPointer.reverse(),o=function(e,t){t.forEach((t=>{let[n,r,i]=t,s=i-r;e[n]&&(i===e[n].length&&i>1&&function(e,t){let n=e.length-1,r=e[n],i=e[n-t];i&&r&&(i.post+=r.post,i.post=i.post.replace(/ +([.?!,;:])/,"$1"),i.post=i.post.replace(/[,;:]+([.?!])/,"$1"))}(e[n],s),e[n].splice(r,s))}));for(let t=e.length-1;t>=0;t-=1)if(0===e[t].length&&(e.splice(t,1),t===e.length&&e[t-1])){let n=e[t-1],r=n[n.length-1];r&&(r.post=r.post.trimEnd())}return e}(this.document,a);return s=function(e,t){return e=e.map((e=>{let[n]=e;return t[n]?(t[n].forEach((t=>{let n=t[2]-t[1];e[1]<=t[1]&&e[2]>=t[2]&&(e[2]-=n)})),e):e})),e.forEach(((t,n)=>{if(0===t[1]&&0==t[2])for(let t=n+1;t<e.length;t+=1)e[t][0]-=1,e[t][0]<0&&(e[t][0]=0)})),e=(e=e.filter((e=>e[2]-e[1]>0))).map((e=>(e[3]=null,e[4]=null,e)))}(s,t(a)),n.ptrs=s,n.document=o,n.compute("index"),i&&(n.ptrs=void 0),e?n.toView(s):(this.ptrs=[],n.none())}};bS.delete=bS.remove;const ES=bS,kS={pre:function(e,t){return void 0===e&&this.found?this.docs[0][0].pre:(this.docs.forEach((n=>{let r=n[0];!0===t?r.pre+=e:r.pre=e})),this)},post:function(e,t){if(void 0===e){let e=this.docs[this.docs.length-1];return e[e.length-1].post}return this.docs.forEach((n=>{let r=n[n.length-1];!0===t?r.post+=e:r.post=e})),this},trim:function(){if(!this.found)return this;let e=this.docs,t=e[0][0];t.pre=t.pre.trimStart();let n=e[e.length-1],r=n[n.length-1];return r.post=r.post.trimEnd(),this},hyphenate:function(){return this.docs.forEach((e=>{e.forEach(((t,n)=>{0!==n&&(t.pre=""),e[n+1]&&(t.post="-")}))})),this},dehyphenate:function(){const e=/[-–—]/;return this.docs.forEach((t=>{t.forEach((t=>{e.test(t.post)&&(t.post=" ")}))})),this},toQuotations:function(e,t){return e=e||'"',t=t||'"',this.docs.forEach((n=>{n[0].pre=e+n[0].pre;let r=n[n.length-1];r.post=t+r.post})),this},toParentheses:function(e,t){return e=e||"(",t=t||")",this.docs.forEach((n=>{n[0].pre=e+n[0].pre;let r=n[n.length-1];r.post=t+r.post})),this}};kS.deHyphenate=kS.dehyphenate,kS.toQuotation=kS.toQuotations;const SS=kS,TS={alpha:(e,t)=>e.normal<t.normal?-1:e.normal>t.normal?1:0,length:(e,t)=>{let n=e.normal.trim().length,r=t.normal.trim().length;return n<r?1:n>r?-1:0},wordCount:(e,t)=>e.words<t.words?1:e.words>t.words?-1:0,sequential:(e,t)=>e[0]<t[0]?1:e[0]>t[0]?-1:e[1]>t[1]?1:-1,byFreq:function(e){let t={};return e.forEach((e=>{t[e.normal]=t[e.normal]||0,t[e.normal]+=1})),e.sort(((e,n)=>{let r=t[e.normal],i=t[n.normal];return r<i?1:r>i?-1:0})),e}},IS=new Set(["index","sequence","seq","sequential","chron","chronological"]),OS=new Set(["freq","frequency","topk","repeats"]),AS=new Set(["alpha","alphabetical"]),xS={unique:function(){let e=new Set;return this.filter((t=>{let n=t.text("machine");return!e.has(n)&&(e.add(n),!0)}))},reverse:function(){let e=this.pointer||this.docs.map(((e,t)=>[t]));return e=[].concat(e),e=e.reverse(),this._cache&&(this._cache=this._cache.reverse()),this.update(e)},sort:function(e){let{docs:t,pointer:n}=this;if(this.uncache(),"function"==typeof e)return function(e,t){let n=e.fullPointer;return n=n.sort(((n,r)=>(n=e.update([n]),r=e.update([r]),t(n,r)))),e.ptrs=n,e}(this,e);e=e||"alpha";let r=n||t.map(((e,t)=>[t])),i=t.map(((e,t)=>({index:t,words:e.length,normal:e.map((e=>e.machine||e.normal||"")).join(" "),pointer:r[t]})));return IS.has(e)&&(e="sequential"),AS.has(e)&&(e="alpha"),OS.has(e)?(i=TS.byFreq(i),this.update(i.map((e=>e.pointer)))):"function"==typeof TS[e]?(i=i.sort(TS[e]),this.update(i.map((e=>e.pointer)))):this}},PS=function(e,t){if(e.length>0){let t=e[e.length-1],n=t[t.length-1];!1===/ /.test(n.post)&&(n.post+=" ")}return e.concat(t)},CS={concat:function(e){if("string"==typeof e){let t=this.fromText(e);if(this.found&&this.ptrs){let e=this.fullPointer,n=e[e.length-1][0];this.document.splice(n,0,...t.document)}else this.document=this.document.concat(t.document);return this.all().compute("index")}if("object"==typeof e&&e.isView)return function(e,t){if(e.document===t.document){let n=e.fullPointer.concat(t.fullPointer);return e.toView(n).compute("index")}return t.fullPointer.forEach((t=>{t[0]+=e.document.length})),e.document=PS(e.document,t.docs),e.all()}(this,e);if(t=e,"[object Array]"===Object.prototype.toString.call(t)){let t=PS(this.document,e);return this.document=t,this.all()}var t;return this}},NS=Object.assign({},{toLowerCase:function(){return this.termList().forEach((e=>{e.text=e.text.toLowerCase()})),this},toUpperCase:function(){return this.termList().forEach((e=>{e.text=e.text.toUpperCase()})),this},toTitleCase:function(){return this.termList().forEach((e=>{e.text=e.text.replace(/^ *[a-z\u00C0-\u00FF]/,(e=>e.toUpperCase()))})),this},toCamelCase:function(){return this.docs.forEach((e=>{e.forEach(((t,n)=>{0!==n&&(t.text=t.text.replace(/^ *[a-z\u00C0-\u00FF]/,(e=>e.toUpperCase()))),n!==e.length-1&&(t.post="")}))})),this}},mS,wS,ES,SS,xS,CS,{harden:function(){return this.ptrs=this.fullPointer,this},soften:function(){let e=this.ptrs;return!e||e.length<1||(e=e.map((e=>e.slice(0,3))),this.ptrs=e),this}}),RS={id:function(e){let t=e.docs;for(let e=0;e<t.length;e+=1)for(let n=0;n<t[e].length;n+=1){let r=t[e][n];r.id=r.id||lS(r)}}},jS={api:function(e){Object.assign(e.prototype,NS)},compute:RS},LS=!0,DS={one:{contractions:[{word:"@",out:["at"]},{word:"arent",out:["are","not"]},{word:"alot",out:["a","lot"]},{word:"brb",out:["be","right","back"]},{word:"cannot",out:["can","not"]},{word:"dun",out:["do","not"]},{word:"can't",out:["can","not"]},{word:"shan't",out:["should","not"]},{word:"won't",out:["will","not"]},{word:"that's",out:["that","is"]},{word:"what's",out:["what","is"]},{word:"let's",out:["let","us"]},{word:"dunno",out:["do","not","know"]},{word:"gonna",out:["going","to"]},{word:"gotta",out:["have","got","to"]},{word:"gimme",out:["give","me"]},{word:"outta",out:["out","of"]},{word:"tryna",out:["trying","to"]},{word:"gtg",out:["got","to","go"]},{word:"im",out:["i","am"]},{word:"imma",out:["I","will"]},{word:"imo",out:["in","my","opinion"]},{word:"irl",out:["in","real","life"]},{word:"ive",out:["i","have"]},{word:"rn",out:["right","now"]},{word:"tbh",out:["to","be","honest"]},{word:"wanna",out:["want","to"]},{word:"c'mere",out:["come","here"]},{word:"c'mon",out:["come","on"]},{word:"shoulda",out:["should","have"]},{word:"coulda",out:["coulda","have"]},{word:"woulda",out:["woulda","have"]},{word:"musta",out:["must","have"]},{word:"tis",out:["it","is"]},{word:"twas",out:["it","was"]},{word:"y'know",out:["you","know"]},{word:"ne'er",out:["never"]},{word:"o'er",out:["over"]},{after:"ll",out:["will"]},{after:"ve",out:["have"]},{after:"re",out:["are"]},{after:"m",out:["am"]},{before:"c",out:["ce"]},{before:"m",out:["me"]},{before:"n",out:["ne"]},{before:"qu",out:["que"]},{before:"s",out:["se"]},{before:"t",out:["tu"]},{word:"shouldnt",out:["should","not"]},{word:"couldnt",out:["could","not"]},{word:"wouldnt",out:["would","not"]},{word:"hasnt",out:["has","not"]},{word:"wasnt",out:["was","not"]},{word:"isnt",out:["is","not"]},{word:"cant",out:["can","not"]},{word:"dont",out:["do","not"]},{word:"wont",out:["will","not"]},{word:"howd",out:["how","did"]},{word:"whatd",out:["what","did"]},{word:"whend",out:["when","did"]},{word:"whered",out:["where","did"]}],numberSuffixes:{st:LS,nd:LS,rd:LS,th:LS,am:LS,pm:LS,max:LS,"°":LS,s:LS,e:LS,er:LS,ère:LS,ème:LS}}},MS=function(e,t,n){let[r,i]=t;n&&0!==n.length&&(n=n.map(((e,t)=>(e.implicit=e.text,e.machine=e.text,e.pre="",e.post="",e.text="",e.normal="",e.index=[r,i+t],e))),n[0]&&(n[0].pre=e[r][i].pre,n[n.length-1].post=e[r][i].post,n[0].text=e[r][i].text,n[0].normal=e[r][i].normal),e[r].splice(i,1,...n))},$S=/'/,US=new Set(["what","how","when","where","why"]),FS=new Set(["be","go","start","think","need"]),BS=new Set(["been","gone"]),VS=/'/,zS=/(e|é|aison|sion|tion)$/,qS=/(age|isme|acle|ege|oire)$/,HS=/^([0-9.]{1,4}[a-z]{0,2}) ?[-–—] ?([0-9]{1,4}[a-z]{0,2})$/i,KS=/^([0-9]{1,2}(:[0-9][0-9])?(am|pm)?) ?[-–—] ?([0-9]{1,2}(:[0-9][0-9])?(am|pm)?)$/i,WS=/^[0-9]{3}-[0-9]{4}$/,GS=function(e,t){let n=e[t],r=n.text.match(HS);return null!==r?!0===n.tags.has("PhoneNumber")||WS.test(n.text)?null:[r[1],"to",r[2]]:(r=n.text.match(KS),null!==r?[r[1],"to",r[4]]:null)},ZS=/^([+-]?[0-9][.,0-9]*)([a-z°²³µ/]+)$/,JS=function(e,t,n){const r=n.model.one.numberSuffixes||{};let i=e[t].text.match(ZS);if(null!==i){let e=i[2].toLowerCase().trim();return r.hasOwnProperty(e)?null:[i[1],e]}return null},QS=/'/,XS=/^[0-9][^-–—]*[-–—].*?[0-9]/,YS=function(e,t,n,r){let i=t.update();i.document=[e];let s=n+r;n>0&&(n-=1),e[s]&&(s+=1),i.ptrs=[[0,n,s]]},eT={t:(e,t)=>function(e,t){return"ain't"===e[t].normal||"aint"===e[t].normal?null:[e[t].normal.replace(/n't/,""),"not"]}(e,t),d:(e,t)=>function(e,t){let n=e[t].normal.split($S)[0];if(US.has(n))return[n,"did"];if(e[t+1]){if(BS.has(e[t+1].normal))return[n,"had"];if(FS.has(e[t+1].normal))return[n,"would"]}return null}(e,t)},tT={j:(e,t)=>((e,t)=>["je",e[t].normal.split(VS)[1]])(e,t),l:(e,t)=>((e,t)=>{let n=e[t].normal.split(VS)[1];return n&&n.endsWith("e")?["la",n]:["le",n]})(e,t),d:(e,t)=>((e,t)=>{let n=e[t].normal.split(VS)[1];return n&&zS.test(n)&&!qS.test(n)?["du",n]:n&&n.endsWith("s")?["des",n]:["de",n]})(e,t)},nT=function(e,t,n,r){for(let i=0;i<e.length;i+=1){let s=e[i];if(s.word===t.normal)return s.out;if(null!==r&&r===s.after)return[n].concat(s.out);if(null!==n&&n===s.before&&r&&r.length>2)return s.out.concat(r)}return null},rT=function(e,t){let n=t.fromText(e.join(" "));return n.compute(["id","alias"]),n.docs[0]},iT=function(e,t){for(let n=t+1;n<5&&e[n];n+=1)if("been"===e[n].normal)return["there","has"];return["there","is"]},sT={model:DS,compute:{contractions:e=>{let{world:t,document:n}=e;const{model:r,methods:i}=t;let s=r.one.contractions||[];n.forEach(((r,a)=>{for(let o=r.length-1;o>=0;o-=1){let c=null,u=null;if(!0===QS.test(r[o].normal)){let e=r[o].normal.split(QS);c=e[0],u=e[1]}let l=nT(s,r[o],c,u);!l&&eT.hasOwnProperty(u)&&(l=eT[u](r,o,t)),!l&&tT.hasOwnProperty(c)&&(l=tT[c](r,o)),"there"===c&&"s"===u&&(l=iT(r,o)),l?(l=rT(l,e),MS(n,[a,o],l),YS(n[a],e,o,l.length)):XS.test(r[o].normal)?(l=GS(r,o),l&&(l=rT(l,e),MS(n,[a,o],l),i.one.setTag(l,"NumberRange",t),l[2]&&l[2].tags.has("Time")&&i.one.setTag([l[0]],"Time",t,null,"time-range"),YS(n[a],e,o,l.length))):(l=JS(r,o,t),l&&(l=rT(l,e),MS(n,[a,o],l),i.one.setTag([l[1]],"Unit",t,null,"contraction-unit")))}}))}},hooks:["contractions"]},aT=function(e){const t=e.world,{model:n,methods:r}=e.world,i=r.one.setTag,{frozenLex:s}=n.one,a=n.one._multiCache||{};e.docs.forEach((e=>{for(let n=0;n<e.length;n+=1){let r=e[n],o=r.machine||r.normal;if(void 0!==a[o]&&e[n+1])for(let r=n+a[o]-1;r>n;r-=1){let a=e.slice(n,r+1),o=a.map((e=>e.machine||e.normal)).join(" ");!0!==s.hasOwnProperty(o)||(i(a,s[o],t,!1,"1-frozen-multi-lexicon"),a.forEach((e=>e.frozen=!0)))}void 0!==s[o]&&s.hasOwnProperty(o)&&(i([r],s[o],t,!1,"1-freeze-lexicon"),r.frozen=!0)}}))},oT={frozen:aT,freeze:aT,unfreeze:function(e){return e.docs.forEach((e=>{e.forEach((e=>{delete e.frozen}))})),e}},cT=e=>"[34m"+e+"[0m",uT=e=>"[3m[2m"+e+"[0m",lT=function(e){e.docs.forEach((e=>{console.log(cT("\n  ┌─────────")),e.forEach((e=>{let t=`  ${uT("│")}  `,n=e.implicit||e.text||"-";!0===e.frozen?t+=`${cT(n)} ❄️`:t+=uT(n),console.log(t)}))}))},hT={compute:oT,mutate:e=>{const t=e.methods.one;t.termMethods.isFrozen=e=>!0===e.frozen,t.debug.freeze=lT,t.debug.frozen=lT},api:function(e){e.prototype.freeze=function(){return this.docs.forEach((e=>{e.forEach((e=>{e.frozen=!0}))})),this},e.prototype.unfreeze=function(){this.compute("unfreeze")},e.prototype.isFrozen=function(){return this.match("@isFrozen+")}},hooks:["freeze"]},dT=function(e,t,n){const{model:r,methods:i}=n,s=i.one.setTag,a=r.one._multiCache||{},{lexicon:o}=r.one||{};let c=e[t],u=c.machine||c.normal;if(void 0!==a[u]&&e[t+1]){for(let r=t+a[u]-1;r>t;r-=1){let i=e.slice(t,r+1);if(i.length<=1)return!1;let a=i.map((e=>e.machine||e.normal)).join(" ");if(!0===o.hasOwnProperty(a)){let e=o[a];return s(i,e,n,!1,"1-multi-lexicon"),!e||2!==e.length||"PhrasalVerb"!==e[0]&&"PhrasalVerb"!==e[1]||s([i[1]],"Particle",n,!1,"1-phrasal-particle"),!0}}return!1}return null},fT=/^(under|over|mis|re|un|dis|semi|pre|post)-?/,pT=new Set(["Verb","Infinitive","PastTense","Gerund","PresentTense","Adjective","Participle"]),mT=function(e,t,n){const{model:r,methods:i}=n,s=i.one.setTag,{lexicon:a}=r.one;let o=e[t],c=o.machine||o.normal;if(void 0!==a[c]&&a.hasOwnProperty(c))return s([o],a[c],n,!1,"1-lexicon"),!0;if(o.alias){let e=o.alias.find((e=>a.hasOwnProperty(e)));if(e)return s([o],a[e],n,!1,"1-lexicon-alias"),!0}if(!0===fT.test(c)){let e=c.replace(fT,"");if(a.hasOwnProperty(e)&&e.length>3&&pT.has(a[e]))return s([o],a[e],n,!1,"1-lexicon-prefix"),!0}return null},gT={lexicon:function(e){const t=e.world;e.docs.forEach((e=>{for(let n=0;n<e.length;n+=1)if(0===e[n].tags.size){let r=null;r=r||dT(e,n,t),r=r||mT(e,n,t)}}))}},yT={addWords:function(e,t=!1){const n=this.world(),{methods:r,model:i}=n;if(!e)return;if(Object.keys(e).forEach((t=>{"string"==typeof e[t]&&e[t].startsWith("#")&&(e[t]=e[t].replace(/^#/,""))})),!0===t){let{lex:t,_multi:s}=r.one.expandLexicon(e,n);return Object.assign(i.one._multiCache,s),void Object.assign(i.one.frozenLex,t)}if(r.two.expandLexicon){let{lex:t,_multi:s}=r.two.expandLexicon(e,n);Object.assign(i.one.lexicon,t),Object.assign(i.one._multiCache,s)}let{lex:s,_multi:a}=r.one.expandLexicon(e,n);Object.assign(i.one.lexicon,s),Object.assign(i.one._multiCache,a)}},vT={model:{one:{lexicon:{},_multiCache:{},frozenLex:{}}},methods:{one:{expandLexicon:function(e){let t={},n={};return Object.keys(e).forEach((r=>{let i=e[r],s=(r=(r=r.toLowerCase().trim()).replace(/'s\b/,"")).split(/ /);s.length>1&&(void 0===n[s[0]]||s.length>n[s[0]])&&(n[s[0]]=s.length),t[r]=t[r]||i})),delete t[""],delete t.null,delete t[" "],{lex:t,_multi:n}}}},compute:gT,lib:yT,hooks:["lexicon"]},_T=function(e,t){let n=[{}],r=[null],i=[0],s=[],a=0;e.forEach((function(e){let i=0,s=function(e,t){const{methods:n,model:r}=t;return n.one.tokenize.splitTerms(e,r).map((e=>n.one.tokenize.splitWhitespace(e,r))).map((e=>e.text.toLowerCase()))}(e,t);for(let e=0;e<s.length;e++){let t=s[e];n[i]&&n[i].hasOwnProperty(t)?i=n[i][t]:(a++,n[i][t]=a,n[a]={},i=a,r[a]=null)}r[i]=[s.length]}));for(let e in n[0])a=n[0][e],i[a]=0,s.push(a);for(;s.length;){let e=s.shift(),t=Object.keys(n[e]);for(let o=0;o<t.length;o+=1){let c=t[o],u=n[e][c];for(s.push(u),a=i[e];a>0&&!n[a].hasOwnProperty(c);)a=i[a];if(n.hasOwnProperty(a)){let e=n[a][c];i[u]=e,r[e]&&(r[u]=r[u]||[],r[u]=r[u].concat(r[e]))}else i[u]=0}}return{goNext:n,endAs:r,failTo:i}},wT=function(e,t,n){let r=0,i=[];for(let s=0;s<e.length;s++){let a=e[s][n.form]||e[s].normal;for(;r>0&&(void 0===t.goNext[r]||!t.goNext[r].hasOwnProperty(a));)r=t.failTo[r]||0;if(t.goNext[r].hasOwnProperty(a)&&(r=t.goNext[r][a],t.endAs[r])){let n=t.endAs[r];for(let t=0;t<n.length;t++){let r=n[t],a=e[s-r+1],[o,c]=a.index;i.push([o,c,c+r,a.id])}}}return i},bT=function(e,t){for(let n=0;n<e.length;n+=1)if(!0===t.has(e[n]))return!1;return!0},ET=(e,t)=>{for(let n=e.length-1;n>=0;n-=1)if(e[n]!==t)return e.slice(0,n+1);return e},kT={buildTrie:function(e){return function(e){return e.goNext=e.goNext.map((e=>{if(0!==Object.keys(e).length)return e})),e.goNext=ET(e.goNext,void 0),e.failTo=ET(e.failTo,0),e.endAs=ET(e.endAs,null),e}(_T(e,this.world()))}};kT.compile=kT.buildTrie;const ST={api:function(e){e.prototype.lookup=function(e,t={}){if(!e)return this.none();var n;"string"==typeof e&&(e=[e]);let r=function(e,t,n){let r=[];n.form=n.form||"normal";let i=e.docs;if(!t.goNext||!t.goNext[0])return console.error("Compromise invalid lookup trie"),e.none();let s=Object.keys(t.goNext[0]);for(let a=0;a<i.length;a++){if(e._cache&&e._cache[a]&&!0===bT(s,e._cache[a]))continue;let o=i[a],c=wT(o,t,n);c.length>0&&(r=r.concat(c))}return e.update(r)}(this,(n=e,"[object Object]"===Object.prototype.toString.call(n)?e:_T(e,this.world)),t);return r=r.settle(),r}},lib:kT},TT=function(e,t){return t?(e.forEach((e=>{let n=e[0];t[n]&&(e[0]=t[n][0],e[1]+=t[n][1],e[2]+=t[n][1])})),e):e},IT=function(e,t){let{ptrs:n,byGroup:r}=e;return n=TT(n,t),Object.keys(r).forEach((e=>{r[e]=TT(r[e],t)})),{ptrs:n,byGroup:r}},OT=function(e,t,n){const r=n.methods.one;return"number"==typeof e&&(e=String(e)),"string"==typeof e&&(e=r.killUnicode(e,n),e=r.parseMatch(e,t,n)),e},AT=e=>"[object Object]"===Object.prototype.toString.call(e),xT=e=>e&&AT(e)&&!0===e.isView,PT=e=>e&&AT(e)&&!0===e.isNet,CT={matchOne:function(e,t,n){const r=this.methods.one;if(xT(e))return this.intersection(e).eq(0);if(PT(e))return this.sweep(e,{tagger:!1,matchOne:!0}).view;let i={regs:e=OT(e,n,this.world),group:t,justOne:!0},s=r.match(this.docs,i,this._cache),{ptrs:a,byGroup:o}=IT(s,this.fullPointer),c=this.toView(a);return c._groups=o,c},match:function(e,t,n){const r=this.methods.one;if(xT(e))return this.intersection(e);if(PT(e))return this.sweep(e,{tagger:!1}).view.settle();let i={regs:e=OT(e,n,this.world),group:t},s=r.match(this.docs,i,this._cache),{ptrs:a,byGroup:o}=IT(s,this.fullPointer),c=this.toView(a);return c._groups=o,c},has:function(e,t,n){const r=this.methods.one;if(xT(e))return this.intersection(e).fullPointer.length>0;if(PT(e))return this.sweep(e,{tagger:!1}).view.found;let i={regs:e=OT(e,n,this.world),group:t,justOne:!0};return r.match(this.docs,i,this._cache).ptrs.length>0},if:function(e,t,n){const r=this.methods.one;if(xT(e))return this.filter((t=>t.intersection(e).found));if(PT(e)){let t=this.sweep(e,{tagger:!1}).view.settle();return this.if(t)}let i={regs:e=OT(e,n,this.world),group:t,justOne:!0},s=this.fullPointer,a=this._cache||[];s=s.filter(((e,t)=>{let n=this.update([e]);return r.match(n.docs,i,a[t]).ptrs.length>0}));let o=this.update(s);return this._cache&&(o._cache=s.map((e=>a[e[0]]))),o},ifNo:function(e,t,n){const{methods:r}=this,i=r.one;if(xT(e))return this.filter((t=>!t.intersection(e).found));if(PT(e)){let t=this.sweep(e,{tagger:!1}).view.settle();return this.ifNo(t)}e=OT(e,n,this.world);let s=this._cache||[],a=this.filter(((n,r)=>{let a={regs:e,group:t,justOne:!0};return 0===i.match(n.docs,a,s[r]).ptrs.length}));return this._cache&&(a._cache=a.ptrs.map((e=>s[e[0]]))),a}},NT={before:function(e,t,n){const{indexN:r}=this.methods.one.pointer;let i=[],s=r(this.fullPointer);Object.keys(s).forEach((e=>{let t=s[e].sort(((e,t)=>e[1]>t[1]?1:-1))[0];t[1]>0&&i.push([t[0],0,t[1]])}));let a=this.toView(i);return e?a.match(e,t,n):a},after:function(e,t,n){const{indexN:r}=this.methods.one.pointer;let i=[],s=r(this.fullPointer),a=this.document;Object.keys(s).forEach((e=>{let t=s[e].sort(((e,t)=>e[1]>t[1]?-1:1))[0],[n,,r]=t;r<a[n].length&&i.push([n,r,a[n].length])}));let o=this.toView(i);return e?o.match(e,t,n):o},growLeft:function(e,t,n){"string"==typeof e&&(e=this.world.methods.one.parseMatch(e,n,this.world)),e[e.length-1].end=!0;let r=this.fullPointer;return this.forEach(((n,i)=>{let s=n.before(e,t);if(s.found){let e=s.terms();r[i][1]-=e.length,r[i][3]=e.docs[0][0].id}})),this.update(r)},growRight:function(e,t,n){"string"==typeof e&&(e=this.world.methods.one.parseMatch(e,n,this.world)),e[0].start=!0;let r=this.fullPointer;return this.forEach(((n,i)=>{let s=n.after(e,t);if(s.found){let e=s.terms();r[i][2]+=e.length,r[i][4]=null}})),this.update(r)},grow:function(e,t,n){return this.growRight(e,t,n).growLeft(e,t,n)}},RT=function(e,t){return[e[0],e[1],t[2]]},jT=(e,t,n)=>{return"string"==typeof e||(r=e,"[object Array]"===Object.prototype.toString.call(r))?t.match(e,n):e||t.none();var r},LT=function(e,t){let[n,r,i]=e;return t.document[n]&&t.document[n][r]&&(e[3]=e[3]||t.document[n][r].id,t.document[n][i-1]&&(e[4]=e[4]||t.document[n][i-1].id)),e},DT={splitOn:function(e,t){const{splitAll:n}=this.methods.one.pointer;let r=jT(e,this,t).fullPointer,i=n(this.fullPointer,r),s=[];return i.forEach((e=>{s.push(e.passthrough),s.push(e.before),s.push(e.match),s.push(e.after)})),s=s.filter((e=>e)),s=s.map((e=>LT(e,this))),this.update(s)},splitBefore:function(e,t){const{splitAll:n}=this.methods.one.pointer;let r=jT(e,this,t).fullPointer,i=n(this.fullPointer,r);for(let e=0;e<i.length;e+=1)!i[e].after&&i[e+1]&&i[e+1].before&&i[e].match&&i[e].match[0]===i[e+1].before[0]&&(i[e].after=i[e+1].before,delete i[e+1].before);let s=[];return i.forEach((e=>{s.push(e.passthrough),s.push(e.before),e.match&&e.after?s.push(RT(e.match,e.after)):s.push(e.match)})),s=s.filter((e=>e)),s=s.map((e=>LT(e,this))),this.update(s)},splitAfter:function(e,t){const{splitAll:n}=this.methods.one.pointer;let r=jT(e,this,t).fullPointer,i=n(this.fullPointer,r),s=[];return i.forEach((e=>{s.push(e.passthrough),e.before&&e.match?s.push(RT(e.before,e.match)):(s.push(e.before),s.push(e.match)),s.push(e.after)})),s=s.filter((e=>e)),s=s.map((e=>LT(e,this))),this.update(s)}};DT.split=DT.splitAfter;const MT=DT,$T=function(e,t){return!(!e||!t)&&e[0]===t[0]&&e[2]===t[1]},UT=function(e,t,n){const r=e.world,i=r.methods.one.parseMatch;n=n||"^.";let s=i(t=t||".$",{},r),a=i(n,{},r);s[s.length-1].end=!0,a[0].start=!0;let o=e.fullPointer,c=[o[0]];for(let t=1;t<o.length;t+=1){let n=c[c.length-1],r=o[t],i=e.update([n]),u=e.update([r]);$T(n,r)&&i.has(s)&&u.has(a)?c[c.length-1]=[n[0],n[1],r[2],n[3],r[4]]:c.push(r)}return e.update(c)},FT={joinIf:function(e,t){return UT(this,e,t)},join:function(){return UT(this)}},BT=Object.assign({},CT,NT,MT,FT);BT.lookBehind=BT.before,BT.lookBefore=BT.before,BT.lookAhead=BT.after,BT.lookAfter=BT.after,BT.notIf=BT.ifNo;const VT=/(?:^|\s)([![^]*(?:<[^<]*>)?\/.*?[^\\/]\/[?\]+*$~]*)(?:\s|$)/,zT=/([!~[^]*(?:<[^<]*>)?\([^)]+[^\\)]\)[?\]+*$~]*)(?:\s|$)/,qT=/ /g,HT=e=>/^[![^]*(<[^<]*>)?\//.test(e)&&/\/[?\]+*$~]*$/.test(e),KT=function(e){return(e=e.map((e=>e.trim()))).filter((e=>e))},WT=/\{([0-9]+)?(, *[0-9]*)?\}/,GT=/&&/,ZT=new RegExp(/^<\s*(\S+)\s*>/),JT=e=>e.charAt(0).toUpperCase()+e.substring(1),QT=e=>e.charAt(e.length-1),XT=e=>e.charAt(0),YT=e=>e.substring(1),eI=e=>e.substring(0,e.length-1),tI=function(e){return e=YT(e),eI(e)},nI=function(e,t){let n={};for(let r=0;r<2;r+=1){if("$"===QT(e)&&(n.end=!0,e=eI(e)),"^"===XT(e)&&(n.start=!0,e=YT(e)),"?"===QT(e)&&(n.optional=!0,e=eI(e)),("["===XT(e)||"]"===QT(e))&&(n.group=null,"["===XT(e)&&(n.groupStart=!0),"]"===QT(e)&&(n.groupEnd=!0),e=(e=e.replace(/^\[/,"")).replace(/\]$/,""),"<"===XT(e))){const t=ZT.exec(e);t.length>=2&&(n.group=t[1],e=e.replace(t[0],""))}if("+"===QT(e)&&(n.greedy=!0,e=eI(e)),"*"!==e&&"*"===QT(e)&&"\\*"!==e&&(n.greedy=!0,e=eI(e)),"!"===XT(e)&&(n.negative=!0,e=YT(e)),"~"===XT(e)&&"~"===QT(e)&&e.length>2&&(e=tI(e),n.fuzzy=!0,n.min=t.fuzzy||.85,!1===/\(/.test(e)))return n.word=e,n;if("/"===XT(e)&&"/"===QT(e))return e=tI(e),t.caseSensitive&&(n.use="text"),n.regex=new RegExp(e),n;if(!0===WT.test(e)&&(e=e.replace(WT,((e,t,r)=>(void 0===r?(n.min=Number(t),n.max=Number(t)):(r=r.replace(/, */,""),void 0===t?(n.min=0,n.max=Number(r)):(n.min=Number(t),n.max=Number(r||999))),n.greedy=!0,n.min||(n.optional=!0),"")))),"("===XT(e)&&")"===QT(e)){GT.test(e)?(n.choices=e.split(GT),n.operator="and"):(n.choices=e.split("|"),n.operator="or"),n.choices[0]=YT(n.choices[0]);let r=n.choices.length-1;n.choices[r]=eI(n.choices[r]),n.choices=n.choices.map((e=>e.trim())),n.choices=n.choices.filter((e=>e)),n.choices=n.choices.map((e=>e.split(/ /g).map((e=>nI(e,t))))),e=""}if("{"===XT(e)&&"}"===QT(e)){if(e=tI(e),n.root=e,/\//.test(e)){let e=n.root.split(/\//);n.root=e[0],n.pos=e[1],"adj"===n.pos&&(n.pos="Adjective"),n.pos=n.pos.charAt(0).toUpperCase()+n.pos.substr(1).toLowerCase(),void 0!==e[2]&&(n.sense=e[2])}return n}if("<"===XT(e)&&">"===QT(e))return e=tI(e),n.chunk=JT(e),n.greedy=!0,n;if("%"===XT(e)&&"%"===QT(e))return e=tI(e),n.switch=e,n}return"#"===XT(e)?(n.tag=YT(e),n.tag=JT(n.tag),n):"@"===XT(e)?(n.method=YT(e),n):"."===e?(n.anything=!0,n):"*"===e?(n.anything=!0,n.greedy=!0,n.optional=!0,n):(e&&(e=(e=e.replace("\\*","*")).replace("\\.","."),t.caseSensitive?n.use="text":e=e.toLowerCase(),n.word=e),n)},rI=nI,iI=/[a-z0-9][-–—][a-z]/i,sI=function(e,t){let{all:n}=t.methods.two.transform.verb||{},r=e.root;return n?n(r,t.model):[]},aI=function(e,t){let{all:n}=t.methods.two.transform.noun||{};return n?n(e.root,t.model):[e.root]},oI=function(e,t){let{all:n}=t.methods.two.transform.adjective||{};return n?n(e.root,t.model):[e.root]},cI=function(e,t){for(let n of t)if(e.has(n))return!0;return!1},uI=function(e,t){for(let n=0;n<e.length;n+=1){let r=e[n];if(!0!==r.optional&&!0!==r.negative&&!0!==r.fuzzy){if(void 0!==r.word&&!1===t.has(r.word))return!0;if(void 0!==r.tag&&!1===t.has("#"+r.tag))return!0;if(r.fastOr&&!1===cI(r.fastOr,t))return!1}}return!1},lI=/([\u0022\uFF02\u0027\u201C\u2018\u201F\u201B\u201E\u2E42\u201A\u00AB\u2039\u2035\u2036\u2037\u301D\u0060\u301F])/,hI=/([\u0022\uFF02\u0027\u201D\u2019\u00BB\u203A\u2032\u2033\u2034\u301E\u00B4])/,dI=/^[-–—]$/,fI=/ [-–—]{1,3} /,pI=(e,t)=>-1!==e.post.indexOf(t),mI={hasQuote:e=>lI.test(e.pre)||hI.test(e.post),hasComma:e=>pI(e,","),hasPeriod:e=>!0===pI(e,".")&&!1===pI(e,"..."),hasExclamation:e=>pI(e,"!"),hasQuestionMark:e=>pI(e,"?")||pI(e,"¿"),hasEllipses:e=>pI(e,"..")||pI(e,"…"),hasSemicolon:e=>pI(e,";"),hasColon:e=>pI(e,":"),hasSlash:e=>/\//.test(e.text),hasHyphen:e=>dI.test(e.post)||dI.test(e.pre),hasDash:e=>fI.test(e.post)||fI.test(e.pre),hasContraction:e=>Boolean(e.implicit),isAcronym:e=>e.tags.has("Acronym"),isKnown:e=>e.tags.size>0,isTitleCase:e=>/^\p{Lu}[a-z'\u00C0-\u00FF]/u.test(e.text),isUpperCase:e=>/^\p{Lu}+$/u.test(e.text)};mI.hasQuotation=mI.hasQuote;const gI=mI;let yI=function(){};yI=function(e,t,n,r){let i=function(e,t,n,r){if(!0===t.anything)return!0;if(!0===t.start&&0!==n)return!1;if(!0===t.end&&n!==r-1)return!1;if(void 0!==t.id&&t.id===e.id)return!0;if(void 0!==t.word){if(t.use)return t.word===e[t.use];if(null!==e.machine&&e.machine===t.word)return!0;if(void 0!==e.alias&&e.alias.hasOwnProperty(t.word))return!0;if(!0===t.fuzzy){if(t.word===e.root)return!0;if(function(e,t,n=3){if(e===t)return 1;if(e.length<n||t.length<n)return 0;const r=function(e,t){let n=e.length,r=t.length;if(0===n)return r;if(0===r)return n;let i=(r>n?r:n)+1;if(Math.abs(n-r)>(i||100))return i||100;let s,a,o,c,u,l,h=[];for(let e=0;e<i;e++)h[e]=[e],h[e].length=i;for(let e=0;e<i;e++)h[0][e]=e;for(let i=1;i<=n;++i)for(a=e[i-1],s=1;s<=r;++s){if(i===s&&h[i][s]>4)return n;o=t[s-1],c=a===o?0:1,u=h[i-1][s]+1,(l=h[i][s-1]+1)<u&&(u=l),(l=h[i-1][s-1]+c)<u&&(u=l);let r=i>1&&s>1&&a===t[s-2]&&e[i-2]===o&&(l=h[i-2][s-2]+c)<u;h[i][s]=r?l:u}return h[n][r]}(e,t);let i=Math.max(e.length,t.length);return 1-(0===i?0:r/i)}(t.word,e.normal)>=t.min)return!0}return!(!e.alias||!e.alias.some((e=>e===t.word)))||t.word===e.text||t.word===e.normal}if(void 0!==t.tag)return!0===e.tags.has(t.tag);if(void 0!==t.method)return"function"==typeof gI[t.method]&&!0===gI[t.method](e);if(void 0!==t.pre)return e.pre&&e.pre.includes(t.pre);if(void 0!==t.post)return e.post&&e.post.includes(t.post);if(void 0!==t.regex){let n=e.normal;return t.use&&(n=e[t.use]),t.regex.test(n)}if(void 0!==t.chunk)return e.chunk===t.chunk;if(void 0!==t.switch)return e.switch===t.switch;if(void 0!==t.machine)return e.normal===t.machine||e.machine===t.machine||e.root===t.machine;if(void 0!==t.sense)return e.sense===t.sense;if(void 0!==t.fastOr){if(t.pos&&!e.tags.has(t.pos))return null;let n=e.root||e.implicit||e.machine||e.normal;return t.fastOr.has(n)||t.fastOr.has(e.text)}return void 0!==t.choices&&("and"===t.operator?t.choices.every((t=>yI(e,t,n,r))):t.choices.some((t=>yI(e,t,n,r))))}(e,t,n,r);return!0===t.negative?!i:i};const vI=yI,_I=function(e,t){if(!0===e.end&&!0===e.greedy&&t.start_i+t.t<t.phrase_length-1){let n=Object.assign({},e,{end:!1});if(!0===vI(t.terms[t.t],n,t.start_i+t.t,t.phrase_length))return!0}return!1},wI=function(e,t){return e.groups[e.inGroup]||(e.groups[e.inGroup]={start:t,length:0}),e.groups[e.inGroup]},bI=function(e){let{regs:t}=e,n=t[e.r],r=function(e,t){let n=e.t;if(!t)return e.terms.length;for(;n<e.terms.length;n+=1)if(!0===vI(e.terms[n],t,e.start_i+n,e.phrase_length))return n;return null}(e,t[e.r+1]);return null===r||0===r||void 0!==n.min&&r-e.t<n.min?null:void 0!==n.max&&r-e.t>n.max?(e.t=e.t+n.max,!0):(!0===e.hasGroup&&(wI(e,e.t).length=r-e.t),e.t=r,!0)},EI=function(e,t=0){let n=e.regs[e.r],r=!1;for(let s=0;s<n.choices.length;s+=1){let a=n.choices[s];if(i=a,"[object Array]"!==Object.prototype.toString.call(i))return!1;if(r=a.every(((n,r)=>{let i=0,s=e.t+r+t+i;if(void 0===e.terms[s])return!1;let a=vI(e.terms[s],n,s+e.start_i,e.phrase_length);if(!0===a&&!0===n.greedy)for(let t=1;t<e.terms.length;t+=1){let r=e.terms[s+t];if(r){if(!0!==vI(r,n,e.start_i+t,e.phrase_length))break;i+=1}}return t+=i,a})),r){t+=a.length;break}}var i;return r&&!0===n.greedy?EI(e,t):t},kI=function(e){const{regs:t}=e;let n=t[e.r],r=EI(e);if(r){if(!0===n.negative)return null;if(!0===e.hasGroup&&(wI(e,e.t).length+=r),!0===n.end){let t=e.phrase_length;if(e.t+e.start_i+r!==t)return null}return e.t+=r,!0}return!!n.optional||null},SI=function(e){const{regs:t}=e;let n=t[e.r],r=function(e){let t=0;return!0===e.regs[e.r].choices.every((n=>{let r=n.every(((t,n)=>{let r=e.t+n;return void 0!==e.terms[r]&&vI(e.terms[r],t,r,e.phrase_length)}));return!0===r&&n.length>t&&(t=n.length),r}))&&t}(e);if(r){if(!0===n.negative)return null;if(!0===e.hasGroup&&(wI(e,e.t).length+=r),!0===n.end){let t=e.phrase_length-1;if(e.t+e.start_i!==t)return null}return e.t+=r,!0}return!!n.optional||null},TI=function(e){const{regs:t}=e;let n=t[e.r],r=Object.assign({},n);if(r.negative=!1,vI(e.terms[e.t],r,e.start_i+e.t,e.phrase_length))return!1;if(n.optional){let n=t[e.r+1];n&&(vI(e.terms[e.t],n,e.start_i+e.t,e.phrase_length)?e.r+=1:n.optional&&t[e.r+2]&&vI(e.terms[e.t],t[e.r+2],e.start_i+e.t,e.phrase_length)&&(e.r+=2))}return n.greedy?function(e,t,n){let r=0;for(let i=e.t;i<e.terms.length;i+=1){let s=vI(e.terms[i],t,e.start_i+e.t,e.phrase_length);if(s)break;if(n&&(s=vI(e.terms[i],n,e.start_i+e.t,e.phrase_length),s))break;if(r+=1,void 0!==t.max&&r===t.max)break}return!(0===r||t.min&&t.min>r||(e.t+=r,0))}(e,r,t[e.r+1]):(e.t+=1,!0)},II=function(e){const{regs:t}=e;let n=t[e.r],r=e.terms[e.t],i=e.t;return!!(n.optional&&t[e.r+1]&&n.negative)||(n.optional&&t[e.r+1]&&function(e){const{regs:t}=e;let n=t[e.r],r=e.terms[e.t],i=vI(r,t[e.r+1],e.start_i+e.t,e.phrase_length);if(n.negative||i){let n=e.terms[e.t+1];n&&vI(n,t[e.r+1],e.start_i+e.t,e.phrase_length)||(e.r+=1)}}(e),r.implicit&&e.terms[e.t+1]&&function(e){let t=e.terms[e.t],n=e.regs[e.r];if(t.implicit&&e.terms[e.t+1]){if(!e.terms[e.t+1].implicit)return;n.word===t.normal&&(e.t+=1),"hasContraction"===n.method&&(e.t+=1)}}(e),e.t+=1,!0===n.end&&e.t!==e.terms.length&&!0!==n.greedy?null:!0!==n.greedy||function(e){const{regs:t,phrase_length:n}=e;let r=t[e.r];return e.t=function(e,t){let n=Object.assign({},e.regs[e.r],{start:!1,end:!1}),r=e.t;for(;e.t<e.terms.length;e.t+=1){if(t&&vI(e.terms[e.t],t,e.start_i+e.t,e.phrase_length))return e.t;let i=e.t-r+1;if(void 0!==n.max&&i===n.max)return e.t;if(!1===vI(e.terms[e.t],n,e.start_i+e.t,e.phrase_length))return void 0!==n.min&&i<n.min?null:e.t}return e.t}(e,t[e.r+1]),null===e.t||r.min&&r.min>e.t?null:!0!==r.end||e.start_i+e.t===n||null}(e)?(!0===e.hasGroup&&function(e,t){let n=e.regs[e.r];const r=wI(e,t);e.t>1&&n.greedy?r.length+=e.t-t:r.length++}(e,i),!0):null)},OI=function(e,t,n,r){if(0===e.length||0===t.length)return null;let i={t:0,terms:e,r:0,regs:t,groups:{},start_i:n,phrase_length:r,inGroup:null};for(;i.r<t.length;i.r+=1){let e=t[i.r];if(i.hasGroup=Boolean(e.group),!0===i.hasGroup?i.inGroup=e.group:i.inGroup=null,!i.terms[i.t]){if(!1===t.slice(i.r).some((e=>!e.optional)))break;return null}if(!0!==e.anything||!0!==e.greedy){if(void 0===e.choices||"or"!==e.operator){if(void 0===e.choices||"and"!==e.operator)if(!0!==e.anything){if(!0!==_I(e,i)){if(e.negative){if(!TI(i))return null}else if(!0!==vI(i.terms[i.t],e,i.start_i+i.t,i.phrase_length)){if(!0!==e.optional)return null}else if(!II(i))return null}else if(!II(i))return null}else{if(e.negative&&e.anything)return null;if(!II(i))return null}else if(!SI(i))return null}else if(!kI(i))return null}else if(!bI(i))return null}let s=[null,n,i.t+n];if(s[1]===s[2])return null;let a={};return Object.keys(i.groups).forEach((e=>{let t=i.groups[e],r=n+t.start;a[e]=[null,r,r+t.length]})),{pointer:s,groups:a}},AI=function(e,t){return e.pointer[0]=t,Object.keys(e.groups).forEach((n=>{e.groups[n][0]=t})),e},xI=function(e,t,n){let r=OI(e,t,0,e.length);return r?(r=AI(r,n),r):null},PI={api:function(e){Object.assign(e.prototype,BT)},methods:{one:{termMethods:gI,parseMatch:function(e,t,n){if(null==e||""===e)return[];t=t||{},"number"==typeof e&&(e=String(e));let r=function(e){let t=e.split(VT),n=[];t.forEach((e=>{HT(e)?n.push(e):n=n.concat(e.split(zT))})),n=KT(n);let r=[];return n.forEach((e=>{(e=>/^[![^]*(<[^<]*>)?\(/.test(e)&&/\)[?\]+*$~]*$/.test(e))(e)||HT(e)?r.push(e):r=r.concat(e.split(qT))})),r=KT(r),r}(e);return r=r.map((e=>rI(e,t))),r=function(e,t){let n=t.model.one.prefixes;for(let t=e.length-1;t>=0;t-=1){let r=e[t];if(r.word&&iI.test(r.word)){let i=r.word.split(/[-–—]/g);if(n.hasOwnProperty(i[0]))continue;i=i.filter((e=>e)).reverse(),e.splice(t,1),i.forEach((n=>{let i=Object.assign({},r);i.word=n,e.splice(t,0,i)}))}}return e}(r,n),r=function(e,t){return e=e.map((e=>{if(e.root)if(t.methods.two&&t.methods.two.transform){let n=[];e.pos?"Verb"===e.pos?n=n.concat(sI(e,t)):"Noun"===e.pos?n=n.concat(aI(e,t)):"Adjective"===e.pos&&(n=n.concat(oI(e,t))):(n=n.concat(sI(e,t)),n=n.concat(aI(e,t)),n=n.concat(oI(e,t))),n=n.filter((e=>e)),n.length>0&&(e.operator="or",e.fastOr=new Set(n))}else e.machine=e.root,delete e.id,delete e.root;return e})),e}(r,n),i=function(e){let t=0,n=null;for(let r=0;r<e.length;r++){const i=e[r];!0===i.groupStart&&(n=i.group,null===n&&(n=String(t),t+=1)),null!==n&&(i.group=n),!0===i.groupEnd&&(n=null)}return e}(i=r),i=function(e){return e.map((e=>(e.fuzzy&&e.choices&&e.choices.forEach((t=>{1===t.length&&t[0].word&&(t[0].fuzzy=!0,t[0].min=e.min)})),e)))}(i=i.map((e=>{if(void 0!==e.choices){if("or"!==e.operator)return e;if(!0===e.fuzzy)return e;!0===e.choices.every((e=>{if(1!==e.length)return!1;let t=e[0];return!0!==t.fuzzy&&!t.start&&!t.end&&void 0!==t.word&&!0!==t.negative&&!0!==t.optional&&!0!==t.method}))&&(e.fastOr=new Set,e.choices.forEach((t=>{e.fastOr.add(t[0].word)})),delete e.choices)}return e}))),r=i,r;var i},match:function(e,t,n){n=n||[];let{regs:r,group:i,justOne:s}=t,a=[];if(!r||0===r.length)return{ptrs:[],byGroup:{}};const o=r.filter((e=>!0!==e.optional&&!0!==e.negative)).length;e:for(let t=0;t<e.length;t+=1){let i=e[t];if(!n[t]||!uI(r,n[t]))if(!0!==r[0].start)for(let e=0;e<i.length;e+=1){let n=i.slice(e);if(n.length<o)break;let c=OI(n,r,e,i.length);if(c){if(c=AI(c,t),a.push(c),!0===s)break e;let n=c.pointer[2];Math.abs(n-1)>e&&(e=Math.abs(n-1))}}else{let e=xI(i,r,t);e&&a.push(e)}}return!0===r[r.length-1].end&&(a=a.filter((t=>{let n=t.pointer[0];return e[n].length===t.pointer[2]}))),t.notIf&&(a=function(e,t,n){return e=e.filter((e=>{let[r,i,s]=e.pointer,a=n[r].slice(i,s);for(let e=0;e<a.length;e+=1){let n=a.slice(e);if(null!==OI(n,t,e,a.length))return!1}return!0})),e}(a,t.notIf,e)),a=function(e,t){let n=[],r={};return 0===e.length||("number"==typeof t&&(t=String(t)),t?e.forEach((e=>{e.groups[t]&&n.push(e.groups[t])})):e.forEach((e=>{n.push(e.pointer),Object.keys(e.groups).forEach((t=>{r[t]=r[t]||[],r[t].push(e.groups[t])}))}))),{ptrs:n,byGroup:r}}(a,i),a.ptrs.forEach((t=>{let[n,r,i]=t;t[3]=e[n][r].id,t[4]=e[n][i-1].id})),a}}},lib:{parseMatch:function(e,t){const n=this.world();let r=n.methods.one.killUnicode;return r&&(e=r(e,n)),n.methods.one.parseMatch(e,t,n)}}},CI=/^\../,NI=/^#./,RI={html:function(e){let{starts:t,ends:n}=function(e,t){let n={},r={};return Object.keys(t).forEach((i=>{let s=t[i],a=function(e){let t="",n="</span>";return e=(e=>(e=(e=(e=(e=e.replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/"/g,"&quot;")).replace(/'/g,"&apos;"))(e),CI.test(e)?t=`<span class="${e.replace(/^\./,"")}"`:NI.test(e)?t=`<span id="${e.replace(/^#/,"")}"`:(t=`<${e}`,n=`</${e}>`),t+=">",{start:t,end:n}}(i);"string"==typeof s&&(s=e.match(s)),s.docs.forEach((e=>{if(e.every((e=>e.implicit)))return;let t=e[0].id;n[t]=n[t]||[],n[t].push(a.start);let i=e[e.length-1].id;r[i]=r[i]||[],r[i].push(a.end)}))})),{starts:n,ends:r}}(this,e),r="";return this.docs.forEach((e=>{for(let i=0;i<e.length;i+=1){let s=e[i];t.hasOwnProperty(s.id)&&(r+=t[s.id].join("")),r+=s.pre||"",r+=s.text||"",n.hasOwnProperty(s.id)&&(r+=n[s.id].join("")),r+=s.post||""}})),r}},jI=/[,:;)\]*.?~!\u0022\uFF02\u201D\u2019\u00BB\u203A\u2032\u2033\u2034\u301E\u00B4—-]+$/,LI=/^[(['"*~\uFF02\u201C\u2018\u201F\u201B\u201E\u2E42\u201A\u00AB\u2039\u2035\u2036\u2037\u301D\u0060\u301F]+/,DI=/[,:;)('"\u201D\]]/,MI=/^[-–—]$/,$I=/ /,UI=function(e,t,n=!0){let r="";return e.forEach((e=>{let n=e.pre||"",i=e.post||"";"some"===t.punctuation&&(n=n.replace(LI,""),MI.test(i)&&(i=" "),i=i.replace(DI,""),i=i.replace(/\?!+/,"?"),i=i.replace(/!+/,"!"),i=i.replace(/\?+/,"?"),i=i.replace(/\.{2,}/,""),e.tags.has("Abbreviation")&&(i=i.replace(/\./,""))),"some"===t.whitespace&&(n=n.replace(/\s/,""),i=i.replace(/\s+/," ")),t.keepPunct||(n=n.replace(LI,""),i="-"===i?" ":i.replace(jI,""));let s=e[t.form||"text"]||e.normal||"";"implicit"===t.form&&(s=e.implicit||e.text),"root"===t.form&&e.implicit&&(s=e.root||e.implicit||e.normal),"machine"!==t.form&&"implicit"!==t.form&&"root"!==t.form||!e.implicit||i&&$I.test(i)||(i+=" "),r+=n+s+i})),!1===n&&(r=r.trim()),!0===t.lowerCase&&(r=r.toLowerCase()),r},FI={text:{form:"text"},normal:{whitespace:"some",punctuation:"some",case:"some",unicode:"some",form:"normal"},machine:{keepSpace:!1,whitespace:"some",punctuation:"some",case:"none",unicode:"some",form:"machine"},root:{keepSpace:!1,whitespace:"some",punctuation:"some",case:"some",unicode:"some",form:"root"},implicit:{form:"implicit"}};FI.clean=FI.normal,FI.reduced=FI.root;const BI=FI;let VI=[],zI=0;for(;zI<64;)VI[zI]=0|4294967296*Math.sin(++zI%Math.PI);const qI=function(e){let t,n,r,i=[t=1732584193,n=4023233417,~t,~n],s=[],a=decodeURI(encodeURI(e))+"",o=a.length;for(e=--o/4+2|15,s[--e]=8*o;~o;)s[o>>2]|=a.charCodeAt(o)<<8*o--;for(zI=a=0;zI<e;zI+=16){for(o=i;a<64;o=[r=o[3],t+((r=o[0]+[t&n|~t&r,r&t|~r&n,t^n^r,n^(t|~r)][o=a>>4]+VI[a]+~~s[zI|15&[a,5*a+1,3*a+5,7*a][o]])<<(o=[7,12,17,22,5,9,14,20,4,11,16,23,6,10,15,21][4*o+a++%4])|r>>>-o),t,n])t=0|o[1],n=o[2];for(a=4;a;)i[--a]+=o[a]}for(e="";a<32;)e+=(i[a>>3]>>4*(1^a++)&15).toString(16);return e},HI={text:!0,terms:!0};let KI={case:"none",unicode:"some",form:"machine",punctuation:"some"};const WI=function(e,t){return Object.assign({},e,t)},GI={text:e=>UI(e,{keepPunct:!0},!1),normal:e=>UI(e,WI(BI.normal,{keepPunct:!0}),!1),implicit:e=>UI(e,WI(BI.implicit,{keepPunct:!0}),!1),machine:e=>UI(e,KI,!1),root:e=>UI(e,WI(KI,{form:"root"}),!1),hash:e=>qI(UI(e,{keepPunct:!0},!1)),offset:e=>{let t=GI.text(e).length;return{index:e[0].offset.index,start:e[0].offset.start,length:t}},terms:e=>e.map((e=>{let t=Object.assign({},e);return t.tags=Array.from(e.tags),t})),confidence:(e,t,n)=>t.eq(n).confidence(),syllables:(e,t,n)=>t.eq(n).syllables(),sentence:(e,t,n)=>t.eq(n).fullSentence().text(),dirty:e=>e.some((e=>!0===e.dirty))};GI.sentences=GI.sentence,GI.clean=GI.normal,GI.reduced=GI.root;const ZI={json:function(e){let t=function(e,t){return"string"==typeof(t=t||{})&&(t={}),(t=Object.assign({},HI,t)).offset&&e.compute("offset"),e.docs.map(((n,r)=>{let i={};return Object.keys(t).forEach((s=>{t[s]&&GI[s]&&(i[s]=GI[s](n,e,r))})),i}))}(this,e);return"number"==typeof e?t[e]:t}};ZI.data=ZI.json;const JI=ZI,QI=function(e){let t=e.pre||"",n=e.post||"";return t+e.text+n},XI=function(e,t){let n=function(e,t){let n={};return Object.keys(t).forEach((r=>{e.match(r).fullPointer.forEach((e=>{n[e[3]]={fn:t[r],end:e[2]}}))})),n}(e,t),r="";return e.docs.forEach(((t,i)=>{for(let s=0;s<t.length;s+=1){let a=t[s];if(n.hasOwnProperty(a.id)){let{fn:o,end:c}=n[a.id],u=e.update([[i,s,c]]);r+=t[s].pre||"",r+=o(u),s=c-1,r+=t[s].post||""}else r+=QI(a)}})),r},YI={debug:function(e){let t=this.methods.one.debug||{};return e&&t.hasOwnProperty(e)?(t[e](this),this):"undefined"!=typeof window&&window.document?(t.clientSide(this),this):(t.tags(this),this)},out:function(e){if(t=e,"[object Object]"===Object.prototype.toString.call(t))return XI(this,e);var t;if("text"===e)return this.text();if("normal"===e)return this.text("normal");if("root"===e)return this.text("root");if("machine"===e||"reduced"===e)return this.text("machine");if("hash"===e||"md5"===e)return qI(this.text());if("json"===e)return this.json();if("offset"===e||"offsets"===e)return this.compute("offset"),this.json({offset:!0});if("array"===e){let e=this.docs.map((e=>e.reduce(((e,t)=>e+t.pre+t.text+t.post),"").trim()));return e.filter((e=>e))}if("freq"===e||"frequency"===e||"topk"===e)return function(e){let t={};e.forEach((e=>{t[e]=t[e]||0,t[e]+=1}));let n=Object.keys(t).map((e=>({normal:e,count:t[e]})));return n.sort(((e,t)=>e.count>t.count?-1:0))}(this.json({normal:!0}).map((e=>e.normal)));if("terms"===e){let e=[];return this.docs.forEach((t=>{let n=t.map((e=>e.text));n=n.filter((e=>e)),e=e.concat(n)})),e}return"tags"===e?this.docs.map((e=>e.reduce(((e,t)=>(e[t.implicit||t.normal]=Array.from(t.tags),e)),{}))):"debug"===e?this.debug():this.text()},wrap:function(e){return XI(this,e)}},eO=YI,tO={text:function(e){let t={};var n;if(e&&"string"==typeof e&&BI.hasOwnProperty(e)?t=Object.assign({},BI[e]):e&&(n=e,"[object Object]"===Object.prototype.toString.call(n))&&(t=Object.assign({},e)),void 0!==t.keepSpace||this.isFull()||(t.keepSpace=!1),void 0===t.keepEndPunct&&this.pointer){let e=this.pointer[0];e&&e[1]?t.keepEndPunct=!1:t.keepEndPunct=!0}return void 0===t.keepPunct&&(t.keepPunct=!0),void 0===t.keepSpace&&(t.keepSpace=!0),function(e,t){let n="";if(!e||!e[0]||!e[0][0])return n;for(let r=0;r<e.length;r+=1)n+=UI(e[r],t,!0);if(t.keepSpace||(n=n.trim()),!1===t.keepEndPunct){e[0][0].tags.has("Emoticon")||(n=n.replace(LI,""));let t=e[e.length-1];t[t.length-1].tags.has("Emoticon")||(n=n.replace(jI,"")),n.endsWith("'")&&!n.endsWith("s'")&&(n=n.replace(/'/,""))}return!0===t.cleanWhitespace&&(n=n.trim()),n}(this.docs,t)}},nO=Object.assign({},eO,tO,JI,RI),rO="[0m",iO={green:e=>"[32m"+e+rO,red:e=>"[31m"+e+rO,blue:e=>"[34m"+e+rO,magenta:e=>"[35m"+e+rO,cyan:e=>"[36m"+e+rO,yellow:e=>"[33m"+e+rO,black:e=>"[30m"+e+rO,dim:e=>"[2m"+e+rO,i:e=>"[3m"+e+rO},sO=iO,aO={api:function(e){Object.assign(e.prototype,nO)},methods:{one:{hash:qI,debug:{tags:function(e){let{docs:t,model:n}=e;0===t.length&&console.log(sO.blue("\n     ──────")),t.forEach((t=>{console.log(sO.blue("\n  ┌─────────")),t.forEach((t=>{let r=[...t.tags||[]],i=t.text||"-";t.sense&&(i=`{${t.normal}/${t.sense}}`),t.implicit&&(i="["+t.implicit+"]"),i=sO.yellow(i);let s="'"+i+"'";if(t.reference){let n=e.update([t.reference]).text("normal");s+=` - ${sO.dim(sO.i("["+n+"]"))}`}s=s.padEnd(18);let a=sO.blue("  │ ")+sO.i(s)+"  - "+function(e,t){return t.one.tagSet&&(e=e.map((e=>{if(!t.one.tagSet.hasOwnProperty(e))return e;const n=t.one.tagSet[e].color||"blue";return sO[n](e)}))),e.join(", ")}(r,n);console.log(a)}))})),console.log("\n")},clientSide:function(e){console.log("%c -=-=- ","background-color:#6699cc;"),e.forEach((e=>{console.groupCollapsed(e.text());let t=e.docs[0].map((e=>{let t=e.text||"-";return e.implicit&&(t="["+e.implicit+"]"),{text:t,tags:"["+Array.from(e.tags).join(", ")+"]"}}));console.table(t,["text","tags"]),console.groupEnd()}))},chunks:function(e){let{docs:t}=e;console.log(""),t.forEach((e=>{let t=[];e.forEach((e=>{"Noun"===e.chunk?t.push(sO.blue(e.implicit||e.normal)):"Verb"===e.chunk?t.push(sO.green(e.implicit||e.normal)):"Adjective"===e.chunk?t.push(sO.yellow(e.implicit||e.normal)):"Pivot"===e.chunk?t.push(sO.red(e.implicit||e.normal)):t.push(e.implicit||e.normal)})),console.log(t.join(" "),"\n")})),console.log("\n")},highlight:function(e){if(!e.found)return;let t={};e.fullPointer.forEach((e=>{t[e[0]]=t[e[0]]||[],t[e[0]].push(e)})),Object.keys(t).forEach((n=>{let r=e.update([[Number(n)]]).text();e.update(t[n]).json({offset:!0}).forEach(((e,t)=>{r=function(e,t,n){let r=((e,t,n)=>{let r=9*n,i=t.start+r,s=i+t.length;return[e.substring(0,i),e.substring(i,s),e.substring(s,e.length)]})(e,t,n);return`${r[0]}${sO.blue(r[1])}${r[2]}`}(r,e.offset,t)})),console.log(r)})),console.log("\n")}}}}},oO=function(e,t){if(e[0]!==t[0])return!1;let[,n,r]=e,[,i,s]=t;return n<=i&&r>i||i<=n&&s>n},cO=function(e){let t={};return e.forEach((e=>{t[e[0]]=t[e[0]]||[],t[e[0]].push(e)})),t},uO=function(e,t){let n=cO(t),r=[];return e.forEach((e=>{let[t]=e,i=n[t]||[];if(i=i.filter((t=>function(e,t){return e[1]<=t[1]&&t[2]<=e[2]}(e,t))),0===i.length)return void r.push({passthrough:e});i=i.sort(((e,t)=>e[1]-t[1]));let s=e;i.forEach(((e,t)=>{let n=function(e,t){let[n,r]=e,i=t[1],s=t[2],a={};if(r<i){let t=i<e[2]?i:e[2];a.before=[n,r,t]}return a.match=t,e[2]>s&&(a.after=[n,s,e[2]]),a}(s,e);i[t+1]?(r.push({before:n.before,match:n.match}),n.after&&(s=n.after)):r.push(n)}))})),r},lO={one:{termList:function(e){let t=[];for(let n=0;n<e.length;n+=1)for(let r=0;r<e[n].length;r+=1)t.push(e[n][r]);return t},getDoc:function(e,t){let n=[];return e.forEach(((r,i)=>{if(!r)return;let[s,a,o,c,u]=r,l=t[s]||[];if(void 0===a&&(a=0),void 0===o&&(o=l.length),!c||l[a]&&l[a].id===c)l=l.slice(a,o);else{let n=function(e,t,n){for(let r=0;r<20;r+=1){if(t[n-r]){let i=t[n-r].findIndex((t=>t.id===e));if(-1!==i)return[n-r,i]}if(t[n+r]){let i=t[n+r].findIndex((t=>t.id===e));if(-1!==i)return[n+r,i]}}return null}(c,t,s);if(null!==n){let r=o-a;l=t[n[0]].slice(n[1],n[1]+r);let s=l[0]?l[0].id:null;e[i]=[n[0],n[1],n[1]+r,s]}}0!==l.length&&a!==o&&(u&&l[l.length-1].id!==u&&(l=function(e,t){let[n,r,,,i]=e,s=t[n],a=s.findIndex((e=>e.id===i));return-1===a?(e[2]=t[n].length,e[4]=s.length?s[s.length-1].id:null):e[2]=a,t[n].slice(r,e[2]+1)}(r,t)),n.push(l))})),n=n.filter((e=>e.length>0)),n},pointer:{indexN:cO,splitAll:uO}}},hO=function(e,t){let n=e.concat(t),r=cO(n),i=[];return n.forEach((e=>{let[t]=e;if(1===r[t].length)return void i.push(e);let n=r[t].filter((t=>oO(e,t)));n.push(e);let s=function(e){let t=e[0][1],n=e[0][2];return e.forEach((e=>{e[1]<t&&(t=e[1]),e[2]>n&&(n=e[2])})),[e[0][0],t,n]}(n);i.push(s)})),i=function(e){let t={};for(let n=0;n<e.length;n+=1)t[e[n].join(",")]=e[n];return Object.values(t)}(i),i},dO=function(e,t){let n=[];return uO(e,t).forEach((e=>{e.passthrough&&n.push(e.passthrough),e.before&&n.push(e.before),e.after&&n.push(e.after)})),n},fO=(e,t)=>{return"string"==typeof e||(n=e,"[object Array]"===Object.prototype.toString.call(n))?t.match(e):e||t.none();var n},pO=function(e,t){return e.map((e=>{let[n,r]=e;return t[n]&&t[n][r]&&(e[3]=t[n][r].id),e}))},mO={union:function(e){e=fO(e,this);let t=hO(this.fullPointer,e.fullPointer);return t=pO(t,this.document),this.toView(t)}};mO.and=mO.union,mO.intersection=function(e){e=fO(e,this);let t=function(e,t){let n=cO(t),r=[];return e.forEach((e=>{let t=n[e[0]]||[];t=t.filter((t=>oO(e,t))),0!==t.length&&t.forEach((t=>{let n=function(e,t){let n=e[1]<t[1]?t[1]:e[1],r=e[2]>t[2]?t[2]:e[2];return n<r?[e[0],n,r]:null}(e,t);n&&r.push(n)}))})),r}(this.fullPointer,e.fullPointer);return t=pO(t,this.document),this.toView(t)},mO.not=function(e){e=fO(e,this);let t=dO(this.fullPointer,e.fullPointer);return t=pO(t,this.document),this.toView(t)},mO.difference=mO.not,mO.complement=function(){let e=this.all(),t=dO(e.fullPointer,this.fullPointer);return t=pO(t,this.document),this.toView(t)},mO.settle=function(){let e=this.fullPointer;return e.forEach((t=>{e=hO(e,[t])})),e=pO(e,this.document),this.update(e)};const gO={methods:lO,api:function(e){Object.assign(e.prototype,mO)}},yO=function(e){return!0===e.optional||!0===e.negative?null:e.tag?"#"+e.tag:e.word?e.word:e.switch?`%${e.switch}%`:null},vO={lib:{buildNet:function(e){let t=this.methods().one.buildNet(e,this.world());return t.isNet=!0,t}},api:function(e){e.prototype.sweep=function(e,t={}){const{world:n,docs:r}=this,{methods:i}=n;let s=i.one.bulkMatch(r,e,this.methods,t);!1!==t.tagger&&i.one.bulkTagger(s,r,this.world),s=s.map((e=>{let t=e.pointer,n=r[t[0]][t[1]],i=t[2]-t[1];return n.index&&(e.pointer=[n.index[0],n.index[1],t[1]+i]),e}));let a=s.map((e=>e.pointer));return s=s.map((e=>(e.view=this.update([e.pointer]),delete e.regs,delete e.needs,delete e.pointer,delete e._expanded,e))),{view:this.update(a),found:s}}},methods:{one:{buildNet:function(e,t){e=function(e,t){const n=t.methods.one.parseMatch;return e.forEach((e=>{e.regs=n(e.match,{},t),"string"==typeof e.ifNo&&(e.ifNo=[e.ifNo]),e.notIf&&(e.notIf=n(e.notIf,{},t)),e.needs=function(e){let t=[];return e.forEach((e=>{t.push(yO(e)),"and"===e.operator&&e.choices&&e.choices.forEach((e=>{e.forEach((e=>{t.push(yO(e))}))}))})),t.filter((e=>e))}(e.regs);let{wants:r,count:i}=function(e){let t=[],n=0;return e.forEach((e=>{"or"!==e.operator||e.optional||e.negative||(e.fastOr&&Array.from(e.fastOr).forEach((e=>{t.push(e)})),e.choices&&e.choices.forEach((e=>{e.forEach((e=>{let n=yO(e);n&&t.push(n)}))})),n+=1)})),{wants:t,count:n}}(e.regs);e.wants=r,e.minWant=i,e.minWords=e.regs.filter((e=>!e.optional)).length})),e}(e,t);let n={};e.forEach((e=>{e.needs.forEach((t=>{n[t]=Array.isArray(n[t])?n[t]:[],n[t].push(e)})),e.wants.forEach((t=>{n[t]=Array.isArray(n[t])?n[t]:[],n[t].push(e)}))})),Object.keys(n).forEach((e=>{let t={};n[e]=n[e].filter((e=>"boolean"!=typeof t[e.match]&&(t[e.match]=!0,!0)))}));let r=e.filter((e=>0===e.needs.length&&0===e.wants.length));return{hooks:n,always:r}},bulkMatch:function(e,t,n,r={}){let i=n.one.cacheDoc(e),s=(a=i,o=t.hooks,a.map(((e,t)=>{let n=[];Object.keys(o).forEach((e=>{a[t].has(e)&&(n=n.concat(o[e]))}));let r={};return n=n.filter((e=>"boolean"!=typeof r[e.match]&&(r[e.match]=!0,!0))),n})));var a,o;return s=function(e,t){return e.map(((e,n)=>{let r=t[n];return(e=(e=e.filter((e=>e.needs.every((e=>r.has(e)))))).filter((e=>void 0===e.ifNo||!0!==e.ifNo.some((e=>r.has(e)))))).filter((e=>0===e.wants.length||e.wants.filter((e=>r.has(e))).length>=e.minWant))}))}(s,i),t.always.length>0&&(s=s.map((e=>e.concat(t.always)))),s=function(e,t){return e.map(((e,n)=>{let r=t[n].length;return e.filter((e=>r>=e.minWords))}))}(s,e),function(e,t,n,r,i){let s=[];for(let n=0;n<e.length;n+=1)for(let a=0;a<e[n].length;a+=1){let o=e[n][a],c=r.one.match([t[n]],o);if(c.ptrs.length>0&&(c.ptrs.forEach((e=>{e[0]=n;let t=Object.assign({},o,{pointer:e});void 0!==o.unTag&&(t.unTag=o.unTag),s.push(t)})),!0===i.matchOne))return[s[0]]}return s}(s,e,0,n,r)},bulkTagger:function(e,t,n){const{model:r,methods:i}=n,{getDoc:s,setTag:a,unTag:o}=i.one,c=i.two.looksPlural;return 0===e.length?e:(("undefined"!=typeof process&&process.env?process.env:self.env||{}).DEBUG_TAGS&&console.log(`\n\n  [32m→ ${e.length} post-tagger:[0m`),e.map((e=>{if(!e.tag&&!e.chunk&&!e.unTag)return;let i=e.reason||e.match,u=s([e.pointer],t)[0];if(!0===e.safe){if(!1===function(e,t,n){let r=n.one.tagSet;if(!r.hasOwnProperty(t))return!0;let i=r[t].not||[];for(let t=0;t<e.length;t+=1){let n=e[t];for(let e=0;e<i.length;e+=1)if(!0===n.tags.has(i[e]))return!1}return!0}(u,e.tag,r))return;if("-"===u[u.length-1].post)return}if(void 0!==e.tag){if(a(u,e.tag,n,e.safe,`[post] '${i}'`),"Noun"===e.tag&&c){let t=u[u.length-1];c(t.text)?a([t],"Plural",n,e.safe,"quick-plural"):a([t],"Singular",n,e.safe,"quick-singular")}!0===e.freeze&&u.forEach((e=>e.frozen=!0))}void 0!==e.unTag&&o(u,e.unTag,n,e.safe,i),e.chunk&&u.forEach((t=>t.chunk=e.chunk))})))}}}},_O=/ /,wO=function(e,t){"Noun"===t&&(e.chunk=t),"Verb"===t&&(e.chunk=t)},bO=function(e,t,n,r){if(!0===e.tags.has(t))return null;if("."===t)return null;!0===e.frozen&&(r=!0);let i=n[t];if(i){if(i.not&&i.not.length>0)for(let t=0;t<i.not.length;t+=1){if(!0===r&&e.tags.has(i.not[t]))return null;e.tags.delete(i.not[t])}if(i.parents&&i.parents.length>0)for(let t=0;t<i.parents.length;t+=1)e.tags.add(i.parents[t]),wO(e,i.parents[t])}return e.tags.add(t),e.dirty=!0,wO(e,t),!0},EO=function(e,t,n={},r,i){const s=n.model.one.tagSet||{};if(!t)return;const a="undefined"!=typeof process&&process.env?process.env:self.env||{};var o;if(a&&a.DEBUG_TAGS&&((e,t,n="")=>{let r=e.map((e=>e.text||"["+e.implicit+"]")).join(" ");"string"!=typeof t&&t.length>2&&(t=t.slice(0,2).join(", #")+" +"),t="string"!=typeof t?t.join(", #"):t,console.log(` ${(e=>"[33m[3m"+e+"[0m")(r).padEnd(24)} [32m→[0m #${t.padEnd(22)}  ${(e=>"[3m"+e+"[0m")(n)}`)})(e,t,i),1!=(o=t,"[object Array]"===Object.prototype.toString.call(o)))if("string"==typeof t)if(t=t.trim(),_O.test(t))!function(e,t,n,r){let i=t.split(_O);e.forEach(((e,t)=>{let s=i[t];s&&(s=s.replace(/^#/,""),bO(e,s,n,r))}))}(e,t,s,r);else{t=t.replace(/^#/,"");for(let n=0;n<e.length;n+=1)bO(e[n],t,s,r)}else console.warn(`compromise: Invalid tag '${t}'`);else t.forEach((t=>EO(e,t,n,r)))},kO=EO,SO=function(e){return e.children=e.children||[],e._cache=e._cache||{},e.props=e.props||{},e._cache.parents=e._cache.parents||[],e._cache.children=e._cache.children||[],e},TO=/^ *(#|\/\/)/,IO=function(e){let t=e.trim().split(/->/),n=[];t.forEach((e=>{n=n.concat(function(e){if(!(e=e.trim()))return null;if(/^\[/.test(e)&&/\]$/.test(e)){let t=(e=(e=e.replace(/^\[/,"")).replace(/\]$/,"")).split(/,/);return t=t.map((e=>e.trim())).filter((e=>e)),t=t.map((e=>SO({id:e}))),t}return[SO({id:e})]}(e))})),n=n.filter((e=>e));let r=n[0];for(let e=1;e<n.length;e+=1)r.children.push(n[e]),r=n[e];return n[0]},OO=(e,t)=>{let n=[],r=[e];for(;r.length>0;){let e=r.pop();n.push(e),e.children&&e.children.forEach((n=>{t&&t(e,n),r.push(n)}))}return n},AO=e=>"[object Array]"===Object.prototype.toString.call(e),xO=e=>(e=e||"").trim(),PO=function(e,t){let n="-> ";t&&(n="[2m→ [0m");let r="";return OO(e).forEach(((e,i)=>{let s=e.id||"";if(t&&(s=(e=>"[31m"+e+"[0m")(s)),0===i&&!e.id)return;let a=e._cache.parents.length;r+="    ".repeat(a)+n+s+"\n"})),r},CO=function(e){let t=OO(e);t.forEach((e=>{delete(e=Object.assign({},e)).children}));let n=t[0];return n&&!n.id&&0===Object.keys(n.props).length&&t.shift(),t},NO={text:PO,txt:PO,array:CO,flat:CO},RO=function(e,t){return"nested"===t||"json"===t?e:"debug"===t?(console.log(PO(e,!0)),null):NO.hasOwnProperty(t)?NO[t](e):e},jO=e=>{OO(e,((e,t)=>{e.id&&(e._cache.parents=e._cache.parents||[],t._cache.parents=e._cache.parents.concat([e.id]))}))},LO=/\//;class DO{constructor(e={}){Object.defineProperty(this,"json",{enumerable:!1,value:e,writable:!0})}get children(){return this.json.children}get id(){return this.json.id}get found(){return this.json.id||this.json.children.length>0}props(e={}){let t=this.json.props||{};return"string"==typeof e&&(t[e]=!0),this.json.props=Object.assign(t,e),this}get(e){if(e=xO(e),!LO.test(e)){let t=this.json.children.find((t=>t.id===e));return new DO(t)}let t=((e,t)=>{let n=(e=>"string"!=typeof e?e:(e=e.replace(/^\//,"")).split(/\//))(t=t||"");for(let t=0;t<n.length;t+=1){let r=e.children.find((e=>e.id===n[t]));if(!r)return null;e=r}return e})(this.json,e)||SO({});return new DO(t)}add(e,t={}){if(AO(e))return e.forEach((e=>this.add(xO(e),t))),this;e=xO(e);let n=SO({id:e,props:t});return this.json.children.push(n),new DO(n)}remove(e){return e=xO(e),this.json.children=this.json.children.filter((t=>t.id!==e)),this}nodes(){return OO(this.json).map((e=>(delete(e=Object.assign({},e)).children,e)))}cache(){return(e=>{let t=OO(e,((e,t)=>{e.id&&(e._cache.parents=e._cache.parents||[],e._cache.children=e._cache.children||[],t._cache.parents=e._cache.parents.concat([e.id]))})),n={};t.forEach((e=>{e.id&&(n[e.id]=e)})),t.forEach((e=>{e._cache.parents.forEach((t=>{n.hasOwnProperty(t)&&n[t]._cache.children.push(e.id)}))})),e._cache.children=Object.keys(n)})(this.json),this}list(){return OO(this.json)}fillDown(){var e;return e=this.json,OO(e,((e,t)=>{t.props=((e,t)=>(Object.keys(t).forEach((n=>{if(t[n]instanceof Set){let r=e[n]||new Set;e[n]=new Set([...r,...t[n]])}else if((e=>e&&"object"==typeof e&&!Array.isArray(e))(t[n])){let r=e[n]||{};e[n]=Object.assign({},t[n],r)}else AO(t[n])?e[n]=t[n].concat(e[n]||[]):void 0===e[n]&&(e[n]=t[n])})),e))(t.props,e.props)})),this}depth(){jO(this.json);let e=OO(this.json),t=e.length>1?1:0;return e.forEach((e=>{if(0===e._cache.parents.length)return;let n=e._cache.parents.length+1;n>t&&(t=n)})),t}out(e){return jO(this.json),RO(this.json,e)}debug(){return jO(this.json),RO(this.json,"debug"),this}}const MO=function(e){let t=function(e=[]){return"string"==typeof e?function(e){let t=e.split(/\r?\n/),n=[];t.forEach((e=>{if(!e.trim()||TO.test(e))return;let t=(e=>{const t=/^( {2}|\t)/;let n=0;for(;t.test(e);)e=e.replace(t,""),n+=1;return n})(e);n.push({indent:t,node:IO(e)})}));let r=function(e){let t={children:[]};return e.forEach(((n,r)=>{0===n.indent?t.children=t.children.concat(n.node):e[r-1]&&function(e,t){let n=e[t].indent;for(;t>=0;t-=1)if(e[t].indent<n)return e[t];return e[0]}(e,r).node.children.push(n.node)})),t}(n);return r=SO(r),r}(e):AO(e)?function(e){let t={};e.forEach((e=>{t[e.id]=e}));let n=SO({});return e.forEach((e=>{if((e=SO(e)).parent)if(t.hasOwnProperty(e.parent)){let n=t[e.parent];delete e.parent,n.children.push(e)}else console.warn(`[Grad] - missing node '${e.parent}'`);else n.children.push(e)})),n}(e):(OO(t=e).forEach(SO),t);var t}(e);return new DO(t)};MO.prototype.plugin=function(e){e(this)};const $O={Noun:"blue",Verb:"green",Negative:"green",Date:"red",Value:"red",Adjective:"magenta",Preposition:"cyan",Conjunction:"cyan",Determiner:"cyan",Hyphenated:"cyan",Adverb:"cyan"},UO=function(e){if($O.hasOwnProperty(e.id))return $O[e.id];if($O.hasOwnProperty(e.is))return $O[e.is];let t=e._cache.parents.find((e=>$O[e]));return $O[t]},FO=function(e){return e?"string"==typeof e?[e]:e:[]},BO={one:{setTag:kO,unTag:function(e,t,n){t=t.trim().replace(/^#/,"");for(let r=0;r<e.length;r+=1){let i=e[r];if(!0===i.frozen)continue;if("*"===t){i.tags.clear();continue}let s=n[t];if(s&&s.children.length>0)for(let e=0;e<s.children.length;e+=1)i.tags.delete(s.children[e]);i.tags.delete(t)}},addTags:function(e,t){Object.keys(t).length>0&&(e=function(e){return Object.keys(e).forEach((t=>{e[t]=Object.assign({},e[t]),e[t].novel=!0})),e}(e)),e=function(e,t){return e=function(e,t){return Object.keys(e).forEach((n=>{e[n].isA&&(e[n].is=e[n].isA),e[n].notA&&(e[n].not=e[n].notA),e[n].is&&"string"==typeof e[n].is&&(t.hasOwnProperty(e[n].is)||e.hasOwnProperty(e[n].is)||(e[e[n].is]={})),e[n].not&&"string"==typeof e[n].not&&!e.hasOwnProperty(e[n].not)&&(t.hasOwnProperty(e[n].not)||e.hasOwnProperty(e[n].not)||(e[e[n].not]={}))})),e}(e,t),Object.keys(e).forEach((t=>{e[t].children=FO(e[t].children),e[t].not=FO(e[t].not)})),Object.keys(e).forEach((t=>{(e[t].not||[]).forEach((n=>{e[n]&&e[n].not&&e[n].not.push(t)}))})),e}(e,t);const n=function(e){const t=Object.keys(e).map((t=>{let n=e[t];const r={not:new Set(n.not),also:n.also,is:n.is,novel:n.novel};return{id:t,parent:n.is,props:r,children:[]}}));return MO(t).cache().fillDown().out("array")}(Object.assign({},t,e));return function(e){const t={};return e.forEach((e=>{let{not:n,also:r,is:i,novel:s}=e.props,a=e._cache.parents;r&&(a=a.concat(r)),t[e.id]={is:i,not:n,novel:s,also:r,parents:a,children:e._cache.children,color:UO(e)}})),Object.keys(t).forEach((e=>{let n=new Set(t[e].not);t[e].not.forEach((e=>{t[e]&&t[e].children.forEach((e=>n.add(e)))})),t[e].not=Array.from(n)})),t}(n)},canBe:function(e,t,n){if(!n.hasOwnProperty(t))return!0;let r=n[t].not||[];for(let t=0;t<r.length;t+=1)if(e.tags.has(r[t]))return!1;return!0}}},VO=function(e){return"[object Array]"===Object.prototype.toString.call(e)},zO={tag:function(e,t="",n){if(!this.found||!e)return this;let r=this.termList();if(0===r.length)return this;const{methods:i,verbose:s,world:a}=this;return!0===s&&console.log(" +  ",e,t||""),VO(e)?e.forEach((e=>i.one.setTag(r,e,a,n,t))):i.one.setTag(r,e,a,n,t),this.uncache(),this},tagSafe:function(e,t=""){return this.tag(e,t,!0)},unTag:function(e,t){if(!this.found||!e)return this;let n=this.termList();if(0===n.length)return this;const{methods:r,verbose:i,model:s}=this;!0===i&&console.log(" -  ",e,t||"");let a=s.one.tagSet;return VO(e)?e.forEach((e=>r.one.unTag(n,e,a))):r.one.unTag(n,e,a),this.uncache(),this},canBe:function(e){e=e.replace(/^#/,"");let t=this.model.one.tagSet,n=this.methods.one.canBe,r=[];this.document.forEach(((i,s)=>{i.forEach(((i,a)=>{n(i,e,t)||r.push([s,a,a+1])}))}));let i=this.update(r);return this.difference(i)}},qO=zO,HO=new Set(["Auxiliary","Possessive"]),KO={model:{one:{tagSet:{}}},compute:{tagRank:function(e){const{document:t,world:n}=e,r=n.model.one.tagSet;t.forEach((e=>{e.forEach((e=>{let t=Array.from(e.tags);e.tagRank=function(e,t){return e=e.sort(((e,n)=>{if(HO.has(e)||!t.hasOwnProperty(n))return 1;if(HO.has(n)||!t.hasOwnProperty(e))return-1;let r=t[e].children||[],i=r.length;return r=t[n].children||[],i-r.length})),e}(t,r)}))}))}},methods:BO,api:function(e){Object.assign(e.prototype,qO)},lib:{addTags:function(e){const{model:t,methods:n}=this.world(),r=t.one.tagSet;let i=(0,n.one.addTags)(e,r);return t.one.tagSet=i,this}}},WO=/([.!?\u203D\u2E18\u203C\u2047-\u2049\u3002]+\s)/g,GO=/^[.!?\u203D\u2E18\u203C\u2047-\u2049\u3002]+\s$/,ZO=/((?:\r?\n|\r)+)/,JO=/[a-z0-9\u00C0-\u00FF\u00a9\u00ae\u2000-\u3300\ud000-\udfff]/i,QO=/\S/,XO={'"':'"',"＂":"＂","“":"”","‟":"”","„":"”","⹂":"”","‚":"’","«":"»","‹":"›","‵":"′","‶":"″","‷":"‴","〝":"〞","〟":"〞"},YO=RegExp("["+Object.keys(XO).join("")+"]","g"),eA=RegExp("["+Object.values(XO).join("")+"]","g"),tA=function(e){if(!e)return!1;let t=e.match(eA);return null!==t&&1===t.length},nA=/\(/g,rA=/\)/g,iA=/\S/,sA=/^\s+/,aA=function(e,t){let n=e.split(/[-–—]/);if(n.length<=1)return!1;const{prefixes:r,suffixes:i}=t.one;return!(1===n[0].length&&/[a-z]/i.test(n[0])||r.hasOwnProperty(n[0])||(n[1]=n[1].trim().replace(/[.?!]$/,""),i.hasOwnProperty(n[1])||!0!==/^([a-z\u00C0-\u00FF`"'/]+)[-–—]([a-z0-9\u00C0-\u00FF].*)/i.test(e)&&!0!==/^[('"]?([0-9]{1,4})[-–—]([a-z\u00C0-\u00FF`"'/-]+[)'"]?$)/i.test(e)))},oA=function(e){let t=[];const n=e.split(/[-–—]/);let r="-",i=e.match(/[-–—]/);i&&i[0]&&(r=i);for(let e=0;e<n.length;e++)e===n.length-1?t.push(n[e]):t.push(n[e]+r);return t},cA=/\p{L} ?\/ ?\p{L}+$/u,uA=/\S/,lA=/^[!?.]+$/,hA=/(\S+)/;let dA=[".","?","!",":",";","-","–","—","--","...","(",")","[","]",'"',"'","`","«","»","*","•"];dA=dA.reduce(((e,t)=>(e[t]=!0,e)),{});const fA=/\p{Letter}/u,pA=/[\p{Number}\p{Currency_Symbol}]/u,mA=/^[a-z]\.([a-z]\.)+/i,gA=/[sn]['’]$/,yA=/([A-Z]\.)+[A-Z]?,?$/,vA=/^[A-Z]\.,?$/,_A=/[A-Z]{2,}('s|,)?$/,wA=/([a-z]\.)+[a-z]\.?$/,bA=function(e,t){const n=t.methods.one.killUnicode;let r=e.text||"";r=function(e){let t=e=(e=(e=e||"").toLowerCase()).trim();return e=(e=(e=e.replace(/[,;.!?]+$/,"")).replace(/\u2026/g,"...")).replace(/\u2013/g,"-"),!1===/^[:;]/.test(e)&&(e=(e=(e=e.replace(/\.{3,}$/g,"")).replace(/[",.!:;?)]+$/g,"")).replace(/^['"(]+/g,"")),""===(e=(e=e.replace(/[\u200B-\u200D\uFEFF]/g,"")).trim())&&(e=t),e.replace(/([0-9]),([0-9])/g,"$1$2")}(r),r=n(r,t),r=function(e){return function(e){return!0===yA.test(e)||!0===wA.test(e)||!0===vA.test(e)||!0===_A.test(e)}(e)&&(e=e.replace(/\./g,"")),e}(r),e.normal=r},EA=/[ .][A-Z]\.? *$/i,kA=/(?:\u2026|\.{2,}) *$/,SA=/\p{L}/u,TA=/\. *$/,IA=/^[A-Z]\. $/,OA={one:{killUnicode:function(e,t){const n=t.model.one.unicode||{};let r=(e=e||"").split("");return r.forEach(((e,t)=>{n[e]&&(r[t]=n[e])})),r.join("")},tokenize:{splitSentences:function(e,t){if(e=e||"",!(e=String(e))||"string"!=typeof e||!1===iA.test(e))return[];let n=function(e){let t=[],n=e.split(ZO);for(let e=0;e<n.length;e++){let r=n[e].split(WO);for(let e=0;e<r.length;e++)r[e+1]&&!0===GO.test(r[e+1])&&(r[e]+=r[e+1],r[e+1]=""),""!==r[e]&&t.push(r[e])}return t}(e=e.replace(" "," ")),r=function(e){let t=[];for(let n=0;n<e.length;n++){let r=e[n];if(void 0!==r&&""!==r){if(!1===QO.test(r)||!1===JO.test(r)){if(t[t.length-1]){t[t.length-1]+=r;continue}if(e[n+1]){e[n+1]=r+e[n+1];continue}}t.push(r)}}return t}(n);if(r=function(e,t){const n=t.methods.one.tokenize.isSentence,r=t.model.one.abbreviations||new Set;let i=[];for(let t=0;t<e.length;t++){let s=e[t];e[t+1]&&!1===n(s,r)?e[t+1]=s+(e[t+1]||""):s&&s.length>0&&(i.push(s),e[t]="")}return i}(r,t),r=function(e){let t=[];for(let n=0;n<e.length;n+=1){let r=e[n].match(YO);if(null!==r&&1===r.length){if(tA(e[n+1])&&e[n+1].length<280){e[n]+=e[n+1],t.push(e[n]),e[n+1]="",n+=1;continue}if(tA(e[n+2])){let r=e[n+1]+e[n+2];if(r.length<280){e[n]+=r,t.push(e[n]),e[n+1]="",e[n+2]="",n+=2;continue}}}t.push(e[n])}return t}(r),r=function(e){let t=[];for(let n=0;n<e.length;n+=1){let r=e[n].match(nA);null!==r&&1===r.length&&e[n+1]&&e[n+1].length<250&&null!==e[n+1].match(rA)&&1===r.length&&!nA.test(e[n+1])?(e[n]+=e[n+1],t.push(e[n]),e[n+1]="",n+=1):t.push(e[n])}return t}(r),0===r.length)return[e];for(let e=1;e<r.length;e+=1){let t=r[e].match(sA);null!==t&&(r[e-1]+=t[0],r[e]=r[e].replace(sA,""))}return r},isSentence:function(e,t){if(!1===SA.test(e))return!1;if(!0===EA.test(e))return!1;if(3===e.length&&IA.test(e))return!1;if(!0===kA.test(e))return!1;let n=e.replace(/[.!?\u203D\u2E18\u203C\u2047-\u2049] *$/,"").split(" "),r=n[n.length-1].toLowerCase();return!0!==t.hasOwnProperty(r)||!0!==TA.test(e)},splitTerms:function(e,t){let n=[],r=[];if("number"==typeof(e=e||"")&&(e=String(e)),function(e){return"[object Array]"===Object.prototype.toString.call(e)}(e))return e;const i=e.split(hA);for(let e=0;e<i.length;e++)!0!==aA(i[e],t)?r.push(i[e]):r=r.concat(oA(i[e]));let s="";for(let e=0;e<r.length;e++){let t=r[e];!0===uA.test(t)&&!1===dA.hasOwnProperty(t)&&!1===lA.test(t)?(n.length>0?(n[n.length-1]+=s,n.push(t)):n.push(s+t),s=""):s+=t}return s&&(0===n.length&&(n[0]=""),n[n.length-1]+=s),n=function(e){for(let t=1;t<e.length-1;t++)cA.test(e[t])&&(e[t-1]+=e[t]+e[t+1],e[t]=null,e[t+1]=null);return e}(n),n=function(e){const t=/^[0-9]{1,4}(:[0-9][0-9])?([a-z]{1,2})? ?[-–—] ?$/,n=/^[0-9]{1,4}([a-z]{1,2})? ?$/;for(let r=0;r<e.length-1;r+=1)e[r+1]&&t.test(e[r])&&n.test(e[r+1])&&(e[r]=e[r]+e[r+1],e[r+1]=null);return e}(n),n=n.filter((e=>e)),n},splitWhitespace:(e,t)=>{let{str:n,pre:r,post:i}=function(e,t){let{prePunctuation:n,postPunctuation:r,emoticons:i}=t.one,s=e,a="",o="",c=Array.from(e);if(i.hasOwnProperty(e.trim()))return{str:e.trim(),pre:a,post:" "};let u=c.length;for(let e=0;e<u;e+=1){let e=c[0];if(!0!==n[e]){if(("+"===e||"-"===e)&&pA.test(c[1]))break;if("'"===e&&3===e.length&&pA.test(c[1]))break;if(fA.test(e)||pA.test(e))break;a+=c.shift()}}u=c.length;for(let e=0;e<u;e+=1){let e=c[c.length-1];if(!0!==r[e]){if(fA.test(e)||pA.test(e))break;"."===e&&!0===mA.test(s)||"'"===e&&!0===gA.test(s)||(o=c.pop()+o)}}return""===(e=c.join(""))&&(s=s.replace(/ *$/,(e=>(o=e||"",""))),e=s,a=""),{str:e,pre:a,post:o}}(e,t);return{text:n,pre:r,post:i,tags:new Set}},fromString:function(e,t){const{methods:n,model:r}=t,{splitSentences:i,splitTerms:s,splitWhitespace:a}=n.one.tokenize;return e=i(e=e||"",t).map((e=>{let n=s(e,r);return n=n.map((e=>a(e,r))),n.forEach((e=>{bA(e,t)})),n})),e}}}};let AA={},xA={};[[["approx","apt","bc","cyn","eg","esp","est","etc","ex","exp","prob","pron","gal","min","pseud","fig","jd","lat","lng","vol","fm","def","misc","plz","ea","ps","sec","pt","pref","pl","pp","qt","fr","sq","nee","ss","tel","temp","vet","ver","fem","masc","eng","adj","vb","rb","inf","situ","vivo","vitro","wr"]],[["dl","ml","gal","qt","pt","tbl","tsp","tbsp","km","dm","cm","mm","mi","td","hr","hrs","kg","hg","dg","cg","mg","µg","lb","oz","sq ft","hz","mps","mph","kmph","kb","mb","tb","lx","lm","fl oz","yb"],"Unit"],[["ad","al","arc","ba","bl","ca","cca","col","corp","ft","fy","ie","lit","ma","md","pd","tce"],"Noun"],[["adj","adm","adv","asst","atty","bldg","brig","capt","cmdr","comdr","cpl","det","dr","esq","gen","gov","hon","jr","llb","lt","maj","messrs","mlle","mme","mr","mrs","ms","mstr","phd","prof","pvt","rep","reps","res","rev","sen","sens","sfc","sgt","sir","sr","supt","surg"],"Honorific"],[["jan","feb","mar","apr","jun","jul","aug","sep","sept","oct","nov","dec"],"Month"],[["dept","univ","assn","bros","inc","ltd","co"],"Organization"],[["rd","st","dist","mt","ave","blvd","cl","cres","hwy","ariz","cal","calif","colo","conn","fla","fl","ga","ida","ia","kan","kans","minn","neb","nebr","okla","penna","penn","pa","dak","tenn","tex","ut","vt","va","wis","wisc","wy","wyo","usafa","alta","ont","que","sask"],"Place"]].forEach((e=>{e[0].forEach((t=>{AA[t]=!0,xA[t]="Abbreviation",void 0!==e[1]&&(xA[t]=[xA[t],e[1]])}))}));const PA=["anti","bi","co","contra","de","extra","infra","inter","intra","macro","micro","mis","mono","multi","peri","pre","pro","proto","pseudo","re","sub","supra","trans","tri","un","out","ex"].reduce(((e,t)=>(e[t]=!0,e)),{});let CA={"!":"¡","?":"¿Ɂ",'"':'“”"❝❞',"'":"‘‛❛❜’","-":"—–",a:"ªÀÁÂÃÄÅàáâãäåĀāĂăĄąǍǎǞǟǠǡǺǻȀȁȂȃȦȧȺΆΑΔΛάαλАаѦѧӐӑӒӓƛæ",b:"ßþƀƁƂƃƄƅɃΒβϐϦБВЪЬвъьѢѣҌҍ",c:"¢©ÇçĆćĈĉĊċČčƆƇƈȻȼͻͼϲϹϽϾСсєҀҁҪҫ",d:"ÐĎďĐđƉƊȡƋƌ",e:"ÈÉÊËèéêëĒēĔĕĖėĘęĚěƐȄȅȆȇȨȩɆɇΈΕΞΣέεξϵЀЁЕеѐёҼҽҾҿӖӗễ",f:"ƑƒϜϝӺӻҒғſ",g:"ĜĝĞğĠġĢģƓǤǥǦǧǴǵ",h:"ĤĥĦħƕǶȞȟΉΗЂЊЋНнђћҢңҤҥҺһӉӊ",I:"ÌÍÎÏ",i:"ìíîïĨĩĪīĬĭĮįİıƖƗȈȉȊȋΊΐΪίιϊІЇіїi̇",j:"ĴĵǰȷɈɉϳЈј",k:"ĶķĸƘƙǨǩΚκЌЖКжкќҚқҜҝҞҟҠҡ",l:"ĹĺĻļĽľĿŀŁłƚƪǀǏǐȴȽΙӀӏ",m:"ΜϺϻМмӍӎ",n:"ÑñŃńŅņŇňŉŊŋƝƞǸǹȠȵΝΠήηϞЍИЙЛПийлпѝҊҋӅӆӢӣӤӥπ",o:"ÒÓÔÕÖØðòóôõöøŌōŎŏŐőƟƠơǑǒǪǫǬǭǾǿȌȍȎȏȪȫȬȭȮȯȰȱΌΘΟθοσόϕϘϙϬϴОФоѲѳӦӧӨөӪӫ",p:"ƤΡρϷϸϼРрҎҏÞ",q:"Ɋɋ",r:"ŔŕŖŗŘřƦȐȑȒȓɌɍЃГЯгяѓҐґ",s:"ŚśŜŝŞşŠšƧƨȘșȿЅѕ",t:"ŢţŤťŦŧƫƬƭƮȚțȶȾΓΤτϮТт",u:"ÙÚÛÜùúûüŨũŪūŬŭŮůŰűŲųƯưƱƲǓǔǕǖǗǘǙǚǛǜȔȕȖȗɄΰυϋύ",v:"νѴѵѶѷ",w:"ŴŵƜωώϖϢϣШЩшщѡѿ",x:"×ΧχϗϰХхҲҳӼӽӾӿ",y:"ÝýÿŶŷŸƳƴȲȳɎɏΎΥΫγψϒϓϔЎУучўѰѱҮүҰұӮӯӰӱӲӳ",z:"ŹźŻżŽžƵƶȤȥɀΖ"},NA={};Object.keys(CA).forEach((function(e){CA[e].split("").forEach((function(t){NA[t]=e}))}));const RA=/\//,jA=/[a-z]\.[a-z]/i,LA=/[0-9]/,DA=function(e,t){let n=e.normal||e.text||e.machine;const r=t.model.one.aliases;if(r.hasOwnProperty(n)&&(e.alias=e.alias||[],e.alias.push(r[n])),RA.test(n)&&!jA.test(n)&&!LA.test(n)){let t=n.split(RA);t.length<=3&&t.forEach((t=>{""!==(t=t.trim())&&(e.alias=e.alias||[],e.alias.push(t))}))}return e},MA=/^\p{Letter}+-\p{Letter}+$/u,$A=function(e){let t=e.implicit||e.normal||e.text;t=t.replace(/['’]s$/,""),t=t.replace(/s['’]$/,"s"),t=t.replace(/([aeiou][ktrp])in'$/,"$1ing"),MA.test(t)&&(t=t.replace(/-/g,"")),t=t.replace(/^[#@]/,""),t!==e.normal&&(e.machine=t)},UA=function(e,t){let n=e.docs;for(let r=0;r<n.length;r+=1)for(let i=0;i<n[r].length;i+=1)t(n[r][i],e.world)},FA={alias:e=>UA(e,DA),machine:e=>UA(e,$A),normal:e=>UA(e,bA),freq:function(e){let t=e.docs,n={};for(let e=0;e<t.length;e+=1)for(let r=0;r<t[e].length;r+=1){let i=t[e][r],s=i.machine||i.normal;n[s]=n[s]||0,n[s]+=1}for(let e=0;e<t.length;e+=1)for(let r=0;r<t[e].length;r+=1){let i=t[e][r],s=i.machine||i.normal;i.freq=n[s]}},offset:function(e){let t=0,n=0,r=e.document;for(let e=0;e<r.length;e+=1)for(let i=0;i<r[e].length;i+=1){let s=r[e][i];s.offset={index:n,start:t+s.pre.length,length:s.text.length},t+=s.pre.length+s.text.length+s.post.length,n+=1}},index:function(e){let t=e.document;for(let e=0;e<t.length;e+=1)for(let n=0;n<t[e].length;n+=1)t[e][n].index=[e,n]},wordCount:function(e){let t=0,n=e.docs;for(let e=0;e<n.length;e+=1)for(let r=0;r<n[e].length;r+=1)""!==n[e][r].normal&&(t+=1,n[e][r].wordCount=t)}},BA={compute:FA,methods:OA,model:{one:{aliases:{"&":"and","@":"at","%":"percent",plz:"please",bein:"being"},abbreviations:AA,prefixes:PA,suffixes:{like:!0,ish:!0,less:!0,able:!0,elect:!0,type:!0,designate:!0},prePunctuation:{"#":!0,"@":!0,_:!0,"°":!0,"​":!0,"‌":!0,"‍":!0,"\ufeff":!0},postPunctuation:{"%":!0,_:!0,"°":!0,"​":!0,"‌":!0,"‍":!0,"\ufeff":!0},lexicon:xA,unicode:NA,emoticons:{"<3":!0,"</3":!0,"<\\3":!0,":^P":!0,":^p":!0,":^O":!0,":^3":!0}}},hooks:["alias","machine","index","id"]},VA={typeahead:function(e){const t=e.model.one.typeahead,n=e.docs;if(0===n.length||0===Object.keys(t).length)return;let r=n[n.length-1]||[],i=r[r.length-1];if(!i.post&&t.hasOwnProperty(i.normal)){let n=t[i.normal];i.implicit=n,i.machine=n,i.typeahead=!0,e.compute.preTagger&&e.last().unTag("*").compute(["lexicon","preTagger"])}}},zA=function(){const e=this.docs;if(0===e.length)return this;let t=e[e.length-1]||[],n=t[t.length-1];return!0===n.typeahead&&n.machine&&(n.text=n.machine,n.normal=n.machine),this},qA={safe:!0,min:3},HA={typeahead:function(e=[],t={}){let n=this.model();var r;t=Object.assign({},qA,t),r=e,"[object Object]"===Object.prototype.toString.call(r)&&(Object.assign(n.one.lexicon,e),e=Object.keys(e));let i=function(e,t,n){let r={},i=[],s=n.prefixes||{};return e.forEach((e=>{let a=(e=e.toLowerCase().trim()).length;t.max&&a>t.max&&(a=t.max);for(let o=t.min;o<a;o+=1){let a=e.substring(0,o);t.safe&&n.model.one.lexicon.hasOwnProperty(a)||(!0!==s.hasOwnProperty(a)&&!0!==r.hasOwnProperty(a)?r[a]=e:i.push(a))}})),r=Object.assign({},s,r),i.forEach((e=>{delete r[e]})),r}(e,t,this.world());return Object.keys(i).forEach((e=>{n.one.typeahead.hasOwnProperty(e)?delete n.one.typeahead[e]:n.one.typeahead[e]=i[e]})),this}},KA={model:{one:{typeahead:{}}},api:function(e){e.prototype.autoFill=zA},lib:HA,compute:VA,hooks:["typeahead"]};tS.extend(jS),tS.extend(aO),tS.extend(PI),tS.extend(gO),tS.extend(KO),tS.plugin(sT),tS.extend(BA),tS.extend(hT),tS.plugin(rS),tS.extend(ST),tS.extend(KA),tS.extend(vT),tS.extend(vO);const WA=tS;function GA(e){return WA(e).json()}function ZA(e){return WA(e).fullSentences().out("array")}async function JA(e){const t=(new TextEncoder).encode(e);return QA(await crypto.subtle.digest("SHA-256",t))}function QA(e){return Array.from(new Uint8Array(e)).map((e=>e.toString(16).padStart(2,"0"))).join("")}function XA(e,t,n){return Uint8Array.from([144+e,t,n])}function YA(e,t,n){return Uint8Array.from([128+e,t,n])}function ex(e,t,n){return Uint8Array.from([176+e,t,n])}function tx(e){return e.toISOString()}function nx(){return tx(new Date)}function rx(e){return tx(e).split("T")[0].replace(/-/g,"_")}function ix(){return rx(new Date)}function sx(e){return Number(e)}function ax(){return sx(new Date)}function ox(e,t){return e.getTime()==t.getTime()}function cx(e){return new Date(e.getTime())}function ux(e){return e.toString().split(" ").slice(0,4).join(" ").replace(" ","_")}function lx(e,t){let n=cx(e);switch(t){case"year":n.setMonth(0);case"month":n.setDate(1);case"day":n.setHours(0);case"hour":n.setMinutes(0);case"minute":n.setSeconds(0);case"second":n.setMilliseconds(0);case"millisecond":break;default:return n}return n}function hx(e,t,n){let r=cx(e);switch(n){case"year":r.setFullYear(r.getFullYear()+t);break;case"month":r.setMonth(r.getMonth()+t);break;case"day":r.setDate(r.getDate()+t);break;case"hour":r.setHours(r.getHours()+t);break;case"minute":r.setMinutes(r.getMinutes()+t);break;case"second":r.setSeconds(r.getSeconds()+t);break;case"millisecond":r.setMilliseconds(r.getMilliseconds()+t);break;default:return r}return r}var dx={"1sec":1e3,"5sec":5e3,"10sec":1e4,"30sec":3e4,"1min":6e4,"2min":12e4,"5min":3e5,"10min":6e5,"30min":18e5,"1hr":36e5,"1day":864e5};const fx=st({id:"common"});async function px(e,t){let n=`${e}?${new URLSearchParams(t)}`;return fx(`Querying with url= ${n}`),(await fetch(n,{method:"GET",cache:"no-cache",headers:{"Content-Type":"application/json"},redirect:"follow"})).json()}})();var a=t;for(var o in s)a[o]=s[o];s.__esModule&&Object.defineProperty(a,"__esModule",{value:!0})}},i={};function s(e){var t=i[e];if(void 0!==t)return t.exports;var n=i[e]={exports:{}};return r[e](n,n.exports,s),n.exports}s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};(()=>{s.r(a),s.d(a,{apis:()=>A,common:()=>N,components:()=>x,cryptocurrency:()=>g,umd:()=>C,util:()=>f});var e={};s.r(e),s.d(e,{_speak:()=>Z,chunk_strategy:()=>J,default_rate:()=>W,finished_speaking:()=>F,finished_utterance:()=>U,get_voice:()=>z,get_voice_by_name:()=>q,get_voices:()=>V,is_speaking:()=>B,set_chunk_strategy:()=>Q,set_default_rate:()=>G,speak:()=>X,speech_que:()=>$,tts:()=>M,voices_ready:()=>H,wait_until_voices_ready:()=>K});var t={};s.r(t),s.d(t,{get_recognition_object:()=>Y});var r={};s.r(r),s.d(r,{audio_context:()=>re,error:()=>pe,input_ready:()=>me,m2f:()=>ee,note_obj_to_midi:()=>ae,note_to_freq:()=>ue,note_to_midi:()=>ce,note_to_note_obj:()=>oe,play_note:()=>le,play_notes:()=>he,play_notes_delay:()=>de,proceed:()=>ge,success:()=>fe,tone:()=>se});var i={};s.r(i),s.d(i,{audio_primitives:()=>ve,connect:()=>we,disconnect:()=>be});var o={};s.r(o),s.d(o,{_recorder:()=>Se,get_current_data:()=>Pe,get_recorder_object:()=>Te,get_recorder_state:()=>Ce,is_supported:()=>ke,pause_recording:()=>Ae,resume_recording:()=>xe,start_recording:()=>Ie,stop_recording:()=>Oe});var c={};s.r(c),s.d(c,{audio_detector:()=>$e,detection_threshold:()=>De,listeners:()=>Le,media_recorder:()=>o,mic:()=>i,set_detection_threshold:()=>Me,start_power:()=>je,stop:()=>Ue});var u={};s.r(u),s.d(u,{dot_join:()=>qe,full_name:()=>He,get:()=>We,get_header:()=>Ze,get_keys:()=>Ge,get_t:()=>Qe,set_storage_header:()=>ze,store:()=>Ke,store_t:()=>Je});var l={};s.r(l),s.d(l,{RecognitionState:()=>Xe,ap:()=>c,initialize_recognition:()=>nt,pause_recognition:()=>rt,recognition:()=>et,recognition_state:()=>tt,set_default_tts_rate:()=>ut,set_default_voice_from_name_preference_list:()=>lt,set_default_voice_uri:()=>ct,speak:()=>dt,speak_with_rate:()=>ft,speak_with_voice:()=>ht,sr:()=>t,start_recognition:()=>st,start_recognition_and_detection:()=>ot,stop_recognition:()=>it,stop_recognition_and_detection:()=>at,tts:()=>e});var h={};s.r(h),s.d(h,{WebSocketMaker:()=>mt});var d={};s.r(d),s.d(d,{set_value_by_id:()=>gt});var f={};s.r(f),s.d(f,{add_css:()=>Tt,add_script:()=>kt,alert:()=>vt,audio_processing:()=>c,define:()=>Et,dom:()=>d,inject_script:()=>St,is_chrome:()=>_t,is_mobile:()=>wt,sounds:()=>r,speech_recognition:()=>t,tts:()=>e,uuid:()=>bt,voice_interface:()=>l,ws:()=>h});var p={};s.r(p),s.d(p,{basic_spot_kine_socket:()=>At,basic_spot_trade_socket:()=>Pt,spot_kline_socket:()=>Ot,spot_trade_socket:()=>xt});var m={};s.r(m),s.d(m,{buy_beep:()=>Rt,sell_beep:()=>jt,set_sound_options:()=>Nt,sound_options:()=>Ct,trade_beeper:()=>Lt});var g={};s.r(g),s.d(g,{binance_listener:()=>m,binance_ws:()=>p});var y={};s.r(y),s.d(y,{load_key_handlers:()=>Mt});var v={};s.r(v),s.d(v,{keys:()=>qt,keys_to_notes_1:()=>Ht,load_sound_key_handler:()=>Wt,sound_key_handler:()=>Kt});var _={};s.r(_),s.d(_,{get_openai:()=>Yt,get_openai_tts_response:()=>nn,openai_davinci_prompt:()=>sn,proxied_chat_completion:()=>an,sendAudioBlobToOpenAI:()=>on,speak:()=>en,text_to_audio:()=>tn,tts_response:()=>rn});var w={};s.r(w),s.d(w,{encode_json_to_uint8:()=>un,get_datagram_writer:()=>ln,get_json_writer:()=>dn,init:()=>cn,write_json_datagram:()=>hn});var b={};s.r(b),s.d(b,{FacebookAuthProvider:()=>Bs,GithubAuthProvider:()=>zs,GoogleAuthProvider:()=>Vs,addDoc:()=>Mp,collection:()=>Yf,doc:()=>ep,getDoc:()=>jp,getFirestore:()=>rp,get_auth:()=>Bp,get_firestore_db:()=>Vp,initialize_app:()=>Fp,initialize_firebase_auth_firestore:()=>zp,log_out:()=>qp,setDoc:()=>Dp,signInWithRedirect:()=>Ca});var E={};s.r(E),s.d(E,{get_midi_writer:()=>Hp});var k={};s.r(k),s.d(k,{webtransport:()=>E});var S={};s.r(S),s.d(S,{log_motion:()=>Qp,log_orientation:()=>Xp,motion_handler:()=>rm,motion_subscribers:()=>Zp,orientation_handler:()=>im,orientation_subscribers:()=>Jp,start_device_motion:()=>sm,start_device_orientation:()=>am,stop_device_motion:()=>om,stop_device_orientation:()=>cm,subscribe_to_motion:()=>Yp,subscribe_to_orientation:()=>em,unsubscribe_motion_id:()=>tm,unsubscribe_orientation_id:()=>nm});var T={};s.r(T),s.d(T,{CACHE_CHECK_INTERVAL:()=>gm,GET_DB:()=>bm,LOCAL_DB_HANDLE_CACHE:()=>mm,START_CACHE_CHECK:()=>Tm,STOP_CACHE_CHECK:()=>Im,cache_check_interval_id:()=>km,default_db_header:()=>vm,default_store_name:()=>ym,deleteDB:()=>Om,do_cache_check:()=>Sm,exportDBString:()=>Am,importFromJson:()=>xm,log:()=>fm,set_cache_check_interval:()=>Em});var I={};s.r(I),s.d(I,{load_bokeh_scripts:()=>Nm,point_plt:()=>Rm});var O={};s.r(O),s.d(O,{SoundEventDetector:()=>Ym,a1:()=>eg,a2:()=>tg,analyser:()=>Mm,ctx:()=>Lm,data_array:()=>Jm,decode_audio_array_buffer:()=>Hm,decode_audio_blob:()=>Km,get_audio_context:()=>Fm,get_audio_stream:()=>zm,get_sampling_rate:()=>qm,get_sound_event_detector:()=>rg,initialize_microphone:()=>Xm,mic_callbacks:()=>Wm,mic_initialized:()=>Qm,plot_data:()=>ig,register_mic_callback:()=>Gm,remove_mic_callbacks:()=>Vm,run_mic_callbacks:()=>Zm,shutdown:()=>Bm,sound_event_detector:()=>$m,stream:()=>Dm,test_diff:()=>ng});var A={};s.r(A),s.d(A,{bind_sounds_to_keys:()=>v,bokeh:()=>I,db:()=>T,firebase:()=>b,key_presses:()=>y,local_storage:()=>u,midi:()=>k,openai:()=>_,sensor:()=>S,web_audio:()=>O,webtransport:()=>w});var x={};s.r(x);var P={};s.r(P),s.d(P,{adjust_tts_rate:()=>_g,click_input:()=>og,configure_tts:()=>wg,default_monitoring_interval:()=>bg,enter_input:()=>cg,finish_stream_handler:()=>mg,initialize_voice_system:()=>Eg,initialize_voice_system_with_tts:()=>kg,input_area:()=>sg,monitor_responses:()=>gg,new_text_handler:()=>dg,set_input:()=>ag,speak:()=>pg,speech_text_handler:()=>fg,start_speech_recognition_and_link_to_input:()=>ug,stop_monitoring:()=>vg,voice_preference_order:()=>yg});var C={};s.r(C),s.d(C,{chatgpt:()=>P});var N=s(78);let{asnc:R,fp:j,logger:L}=N,D=L.get_logger({id:"tts"});var M=function(){return window.speechSynthesis},$=[];async function U(){await R.wait_until((()=>!M().speaking),1/0,200)}async function F(){await R.wait_until((()=>!M().speaking&&$.length<1),1/0,200)}function B(){return M().speaking||$.length>0}function V(){return M().getVoices()}function z(e){let t=M().getVoices().filter((t=>t.voiceURI==e));return t.length>0?t[0]:null}function q(e){let t=M().getVoices().filter((t=>t.name==e));return t.length>0?t[0]:null}function H(){try{return M().getVoices().length>0}catch(e){return!1}}async function K(){await N.asnc.wait_until(H,3e3,200),D("voices_ready")}var W=1;function G(e){W=e,D("Default rate set to: "+e)}async function Z(e){let{voiceURI:t,rate:n=W,text:r}=e;if(M().speaking)console.log("Scheduling speech for later."),$.push(e);else{var i=new window.SpeechSynthesisUtterance(r);if(t){let e=z(t);e&&(i.voice=e)}i.rate=n,M().speak(i),await U();let e=$.shift();e?Z(e):console.log("done with speech que")}}var J="sentences";function Q(e){D(`Set chunk strategy: ${e}`),J=e}function X(e){let{voiceURI:t,rate:n=W,text:r}=e;D("Request to speak  =:> "+r),D("With voice =:> "+t);var i=null;"sentences"==J?(D("splitting text by sentences"),i=r.split(".")):(D("splitting text by words"),i=j.map(j.partition(j.split(r," "),20),j.joiner(" "))),i.forEach((function(t){let n=j.clone(e);n.text=t,Z(n)}))}function Y(e={}){let{result_dispatch:t="tidyscripts_web_speech_recognition_result"}=e,{continuous:n=!0,interimResults:r=!1,onStart:i=(()=>{console.log("Recognition started")}),onSoundStart:s=(()=>{console.log("Sound started...")}),onSoundEnd:a=(()=>{console.log("Sound ended...")}),onSpeechStart:o=(()=>{console.log("Speech started...")}),onSpeechEnd:c=(()=>{console.log("Speech ended...")}),onResult:u=function(e){let n=e.results[e.resultIndex][0].transcript;console.log("Recognition result: "+n),window.dispatchEvent(new CustomEvent(t,{detail:n}))},onError:l=(e=>{console.log("Recognition error: "),console.log(e)}),onEnd:h=(()=>{console.log("Recognition ended")}),lang:d="en-US"}=e,f=new window.webkitSpeechRecognition;return f.onresult=u,f.onerror=l,f.onend=h,f.continuous=n,f.interimResults=r,f.onstart=i,f.onsoundstart=s,f.onsoundend=a,f.onspeechstart=o,f.onspeechend=c,f}var ee={12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:27.5,22:29.135,23:30.868,24:32.703,25:34.648,26:36.708,27:38.891,28:41.203,29:43.654,30:46.249,31:48.999,32:51.913,33:55,34:58.27,35:61.735,36:65.406,37:69.296,38:73.416,39:77.782,40:82.407,41:87.307,42:92.499,43:97.999,44:103.826,45:110,46:116.541,47:123.471,48:130.813,49:138.591,50:146.832,51:155.564,52:164.814,53:174.614,54:184.997,55:195.998,56:207.652,57:220,58:233.082,59:246.942,60:261.626,61:277.183,62:293.665,63:311.127,64:329.628,65:349.228,66:369.994,67:391.995,68:415.305,69:440,70:466.164,71:493.883,72:523.251,73:554.365,74:587.33,75:622.254,76:659.255,77:698.457,78:739.989,79:783.991,80:830.609,81:880,82:932.328,83:987.767,84:1046.502,85:1108.731,86:1174.659,87:1244.508,88:1318.51,89:1396.913,90:1479.978,91:1567.982,92:1661.219,93:1760,94:1864.655,95:1975.533,96:2093.005,97:2217.461,98:2349.318,99:2489.016,100:2637.021,101:2793.826,102:2959.956,103:3135.964,104:3322.438,105:3520,106:3729.31,107:3951.066,108:4186.009,109:4434.922,110:4698.637,111:4978.032,112:5274.042,113:5587.652,114:5919.912,115:6271.928,116:6644.876,117:7040,118:7458.62,119:7902.133,120:8372.019,121:8869.845,122:9397.273,123:9956.064,124:10548.083,125:11175.305,126:11839.823,127:12543.855};let{fp:te,asnc:ne}=N;var re=null,ie=function(){if(re)return re;{let e=window.AudioContext||window.webkitAudioContext;return re=new e}};async function se(e){let{type:t="sine",duration:n=600,gain:r=.5,delay:i,freq:s}=e,a=ie();var o=a.createOscillator();o.frequency.value=s,o.type=t;var c=a.createGain();if(i){var u=a.createDelay();u.delayTime.value=i,c.connect(u),u.connect(a.destination)}c.gain.value=r,o.connect(c),c.connect(a.destination),o.start(0),await ne.wait(n),o.stop()}function ae(e){let{num:t,mod:n,octave:r}=e,i=function(e){return te.nth([0,0,2,4,5,7,9,11,12],e)}(t)+12*r;return n&&(i+="#"==n?1:-1),i}function oe(e){let t=e.split(".");var n=0,r=null,i=null;return t.length>1&&(n=Number(t[1])),t[0].length>1?(r=t[0][0],i=Number(t[0][1])):i=Number(t[0][0]),{num:i,mod:r,octave:n}}function ce(e){return ae(oe(e))}function ue(e){return ee[ce(e)]}async function le(e,t,n){console.log(te.format("note | n= {}, dur={}, k={}",[e,t,n]));let r=n?ce(n):60,i=ce(e),s=ee[String(r+i)],a=t||500;try{await se({freq:s,duration:a})}catch(e){console.log("Error playing. You likely played a note outside of currently supported range"),console.log(e),console.log("freq + duration:"),console.log({freq:s,duration:a})}}async function he(e,t,n){e.map((e=>le(e,t,n)))}async function de(e,t,n,r){for(var i of e)le(i,n,r),await ne.wait(t)}function fe(){he(["1","3"],400,"3.5")}function pe(){he(["1","b5"],200,"3.5")}function me(){de(["1","3"],100,100,"3.5")}function ge(){he(["5.-1"],100,"3.5")}const ye=N.logger.get_logger({id:"mic"});var ve={context:null,source:null,processor:null,stream:null,mic_sample_rate:null},_e=function(e,t){return function(n){var r,i,s,a,o;ve.stream=n,ve.context=new window.AudioContext,ve.source=null===(r=ve.context)||void 0===r?void 0:r.createMediaStreamSource(n),ve.processor=null===(i=ve.context)||void 0===i?void 0:i.createScriptProcessor(1024,1,1),null===(s=ve.source)||void 0===s||s.connect(ve.processor),null===(a=ve.processor)||void 0===a||a.connect(null===(o=ve.context)||void 0===o?void 0:o.destination),ve.processor.onaudioprocess=function(n){let r=e(n.inputBuffer.getChannelData(0));const i=new window.CustomEvent(t,{detail:r});window.dispatchEvent(i)};let c=n.getAudioTracks()[0].getSettings().sampleRate;ve.mic_sample_rate=c,ye(`Determined sample rate of mic : ${ve.mic_sample_rate}`)}};function we(e,t){let n=t||"tidyscripts_web_mic";window.navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(_e(e,n))}function be(){let e=ve.context;e&&e.close(),ve={context:null,source:null,processor:null,stream:null,mic_sample_rate:null}}const Ee=N.logger.get_logger({id:"media_recorder"});function ke(){return!!window.navigator.mediaDevices}var Se=null;async function Te(){if(Se)return Se;if(!ke())return void Ee("NOT SUPPORTED");let e=await navigator.mediaDevices.getUserMedia({audio:!0});return Se=new MediaRecorder(e)}async function Ie(e,t){let n=await Te();n.addEventListener("dataavailable",(async function(t){e(await t.data)})),n.start(t),Ee("Recording started")}async function Oe(){(await Te()).stop(),Ee("Recording stopped")}async function Ae(){(await Te()).pause(),Ee("Recording paused")}async function xe(){(await Te()).resume(),Ee("Recording resumed")}async function Pe(){return(await Te()).requestData()}async function Ce(){return(await Te()).state}let{dsp:Ne,performance:Re}=N.util;function je(){we((e=>Ne.power(e)),"tidyscripts_web_mic")}var Le=[],De=1e3;function Me(e){De=e}function $e(e,t){je(),t&&Me(t);var n=0,r=Re.ms();let i=t=>{let i=t.detail;if(0==n)return void(n=i);let s=i/n*100;Re.ms()-r>600&&s>De&&e(),n=i};window.addEventListener("tidyscripts_web_mic",i),Le.push(["tidyscripts_web_mic",i])}function Ue(){for(var e of(be(),Le))window.removeEventListener(e[0],e[1]);Le=[]}let{fp:Fe}=N,Be=function(){return window.localStorage};var Ve="tidyscripts";function ze(e){Ve=e}function qe(e){return e.join(".")}function He(e){return qe([Ve,e])}function Ke(e,t){Be()[He(t)]=JSON.stringify(e)}function We(e){let t=Be()[He(e)];return t?JSON.parse(t):null}function Ge(){return Object.keys(Be())}function Ze(e){let t=Ge();return Fe.filter(t,(t=>t.startsWith(e)))}function Je(e,t){Ke({timestamp:Number(new Date),data:e},t)}function Qe(e){return We(e)}var Xe,Ye=N.logger.get_logger({id:"voice_interface"}),et=null;!function(e){e.NULL="NULL",e.STOPPED="STOPPED",e.PAUSED="PAUSED",e.LISTENING="LISTENING",e.STOPPING="STOPPING"}(Xe||(Xe={}));var tt=Xe.NULL;function nt(e){it();let t=(e=e||{}).onEnd;e.onEnd=function(){tt==Xe.STOPPING?(Ye("Recognition stopped"),tt=Xe.STOPPED):(tt=Xe.PAUSED,Ye("Recognition paused")),t&&t()},et=Y(e),tt=Xe.PAUSED,$e(st)}function rt(){et&&(et.abort(),tt=Xe.PAUSED)}function it(){et&&(Ye("Stopping recognition"),tt=Xe.STOPPING,et.abort(),et=null,Ue())}async function st(){tt!=Xe.LISTENING&&(B()&&Ye("Wont start recognition while tts active"),et?et.start():(nt(),Ye("Recognition initialized without args")),tt=Xe.LISTENING)}function at(){let e=De;return rt(),Me(1/0),e}function ot(e){st(),Me(e)}function ct(e){Ke("default_voice_uri",e)}function ut(e){G(e)}function lt(e){for(var t of e){let e=q(t);if(e)return ct(e.voiceURI),void Ye(`Set default voice to: ${e.name}`)}Ye("Unable to set default voice to any matching name in provided list")}async function ht(e,t,n){if(et){let r=at();X({text:e,voiceURI:t,rate:n}),await F(),ot(r)}else X({text:e,voiceURI:t,rate:n}),await F()}async function dt(e){ht(e,We("default_voice_uri"),W)}async function ft(e,t){ht(e,We("default_voice_uri"),t)}let pt=N.logger.get_logger({id:"ws"});function mt(e){var{url:t,handler:n,open:r,error:i,close:s}=e;r=r||(()=>{pt(`ws to ${t} opened`)}),s=s||(()=>{pt(`ws to ${t} closed`)}),i=i||(e=>{pt(`ws to ${t} errored: ${JSON.stringify(e)}`)});let a=new WebSocket(t);return a.onopen=r,a.onclose=s,a.onerror=i,a.onmessage=e=>{n(e.data)},a}function gt(e,t){document.getElementById(e).value=t}let yt=N.logger.get_logger({id:"wutil"});function vt(e){yt("Alerting web page!"),window.alert(e)}function _t(){return/Chrome/.test(window.navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}function wt(){return/Mobi/.test(window.navigator.userAgent)}function bt(){var e=new Uint32Array(4);window.crypto.getRandomValues(e);var t=-1;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(n){t++;var r=e[t>>3]>>t%8*4&15;return("x"==n?r:3&r|8).toString(16)}))}async function Et(e,t){window[t]=await e,yt(`Defined ${t} on the window object :)`)}function kt(e){return new Promise(((t,n)=>{const r=window.document.createElement("script");r.setAttribute("src",e),r.addEventListener("load",t),r.addEventListener("error",n),document.body.appendChild(r)}))}function St(e){return new Promise(((t,n)=>{const r=window.document.createElement("script");r.setAttribute("src",e.src);let i=e.attributes;if(i){let e=Object.keys(i);for(let t of e)r.setAttribute(t,i[t])}r.addEventListener("load",t),r.addEventListener("error",n),document.body.appendChild(r)}))}function Tt(e){return new Promise(((t,n)=>{var r=document.createElement("link");r.rel="stylesheet",r.type="text/css",r.href=e,r.media="all",r.addEventListener("load",t),r.addEventListener("error",n),document.getElementsByTagName("head")[0].appendChild(r)}))}let It=N.logger.get_logger({id:"bws"});function Ot(e,t){let{sym:n,handler:r,error:i,close:s,open:a}=e;n=n.toLowerCase();let o=`wss://stream.binance.com:9443/ws/${n}@kline_${t=t||"1m"}`;return It("Using url for spot kline socket: "+o),mt({url:o,handler:r,error:i,close:s,open:a})}function At(e,t){return Ot({sym:e,handler:t=t||(e=>{console.log(JSON.parse(e))})})}function xt(e){let{sym:t,handler:n,error:r,close:i,open:s}=e;t=t.toLowerCase();let a=`wss://stream.binance.com:9443/ws/${t}@aggTrade`;return It("Using url for spot trade socket: "+a),mt({url:a,handler:n,error:r,close:i,open:s})}function Pt(e,t){return xt({sym:e,handler:t=t||(e=>{console.log(JSON.parse(e))})})}var Ct={freq:{buy:620,sell:580},duration:{buy:30,sell:30}};function Nt(e){Ct=e}function Rt(e){se({freq:Ct.freq.buy,gain:e,duration:Ct.duration.buy})}function jt(e){se({freq:Ct.freq.sell,gain:e,duration:Ct.duration.sell})}function Lt(e){return Pt(e,(function(e){let t=JSON.parse(e),{m:n,p:r,q:i}=t,s=Number(i),a=s>1?1:s;console.log(t),n?jt(a):Rt(a)}))}let Dt=N.logger.get_logger({id:"key_presses"});function Mt(e){window.onkeypress=function(t){Dt("Keypress!");let n=t.key;console.log(n),e[n]&&e[n]()}}N.fp,N.util.debug;let $t=N.logger.get_logger({id:"key_sounds"}),Ut=N.fp,Ft=N.util.debug;var Bt=["q","w","e","r","t","y","u","i","o","p","["],Vt=["a","s","d","f","g","h","j","k","l",";"],zt=["z","x","c","v","b","n","m",","],qt={hi:Bt,mid:Vt,lo:zt};function Ht(e){let t=zt.concat(Vt).concat(Bt),n=0,r={};for(var i of Ut.enumerate(t)){i[0]%7==0&&(n+=1);let e=i[0]%7+1,t=Ut.format("{}.{}",[e,n]);r[i[1]]=t}return r}function Kt(e,t=30,n="1.4"){let r={};for(var i of Ut.dict_to_list(e)){let e=i[0],s=i[1];r[e]=function(){$t(String(s)),le(String(s),t,n)}}return r}function Wt(e=30,t="1.4"){let n=Kt(Ht(),e,t);Mt(n),Ft.add("km",n)}let{get_json_from_url:Gt}=N,{OpenAI:Zt}=N.apis;var Jt=null;const Qt=N.logger.get_logger({id:"open_ai_web"}),Xt=N.util.debug;function Yt(){if(Jt)return Qt("OpenAI already initialized"),Jt;{Qt("Initializing open api in browser");let e=localStorage.OAAK;if(e)return Jt=new Zt({apiKey:e,dangerouslyAllowBrowser:!0}),Qt("Complete"),Jt;{let e='Unable to find API key; please make sure api key is under "OAAK" in local storage';return Qt(e),window.alert(e),1}}}async function en(e){Qt(`Request to speak ${e}`);let t=await tn(e);return Qt("Retrieved audio data from openai"),Qt("Playing audio and returning data"),t.audio_element.play(),t}async function tn(e){let t=await rn(e),n=await t.blob(),r=URL.createObjectURL(n);return{audio_element:new Audio(r),blob:n}}async function nn(e){let t=Yt();return await t.audio.speech.create({model:"tts-1",voice:"alloy",input:e})}async function rn(e){let t=Yt();return await t.audio.speech.create(e)}async function sn(e,t){return await Gt("https://www.tidyscripts.com/api/openai_davinci",{prompt:e,max_tokens:t})}async function an(e){let t="/api/open_ai_chat_2";e.response_format&&(Qt("Detected request for structured completion"),t="/api/openai_structured_completion",Qt(`Switching URL to ${t}`),Xt.add("chat_completion_args",e));let n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});Xt.add("fetch_response",n);let r=await n.json();return Xt.add("response",r),r}async function on(e){Yt();let t=localStorage.OAAK;const n=new FormData;n.append("file",e,"audio.webm"),n.append("model","whisper-1");try{const e=await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${t}`},body:n});if(!e.ok)throw new Error(`API request failed with status ${e.status}`);const r=await e.json();return Qt(`Transcription: ${r.text}`),r.text}catch(e){console.error("Error while sending audio to OpenAI:",e)}}function cn(e){return new WebTransport(e)}function un(e){return(new TextEncoder).encode(JSON.stringify(e))}function ln(e){let t=cn(e);return{writer:t.datagrams.writable.getWriter(),transport:t}}async function hn(e,t){let n=un(t);await e.write(n)}function dn(e){let{writer:t,transport:n}=ln(e);return t.write_json=async function(e){await t.write(un(e))},t}const fn=function(e){const t=[];let n=0;for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=63&i|128):55296==(64512&i)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(i=65536+((1023&i)<<10)+(1023&e.charCodeAt(++r)),t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=63&i|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=63&i|128)}return t},pn={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let t=0;t<e.length;t+=3){const i=e[t],s=t+1<e.length,a=s?e[t+1]:0,o=t+2<e.length,c=o?e[t+2]:0,u=i>>2,l=(3&i)<<4|a>>4;let h=(15&a)<<2|c>>6,d=63&c;o||(d=64,s||(h=64)),r.push(n[u],n[l],n[h],n[d])}return r.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(fn(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){const i=e[n++];if(i<128)t[r++]=String.fromCharCode(i);else if(i>191&&i<224){const s=e[n++];t[r++]=String.fromCharCode((31&i)<<6|63&s)}else if(i>239&&i<365){const s=((7&i)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536;t[r++]=String.fromCharCode(55296+(s>>10)),t[r++]=String.fromCharCode(56320+(1023&s))}else{const s=e[n++],a=e[n++];t[r++]=String.fromCharCode((15&i)<<12|(63&s)<<6|63&a)}}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const n=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let t=0;t<e.length;){const i=n[e.charAt(t++)],s=t<e.length?n[e.charAt(t)]:0;++t;const a=t<e.length?n[e.charAt(t)]:64;++t;const o=t<e.length?n[e.charAt(t)]:64;if(++t,null==i||null==s||null==a||null==o)throw new mn;const c=i<<2|s>>4;if(r.push(c),64!==a){const e=s<<4&240|a>>2;if(r.push(e),64!==o){const e=a<<6&192|o;r.push(e)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class mn extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const gn=function(e){return function(e){const t=fn(e);return pn.encodeByteArray(t,!0)}(e).replace(/\./g,"")},yn=function(e){try{return pn.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null},vn=()=>{try{return function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==s.g)return s.g;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__||(()=>{if("undefined"==typeof process||void 0===process.env)return;const e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0})()||(()=>{if("undefined"==typeof document)return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}const t=e&&yn(e[1]);return t&&JSON.parse(t)})()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}},_n=e=>{var t,n;return null===(n=null===(t=vn())||void 0===t?void 0:t.emulatorHosts)||void 0===n?void 0:n[e]},wn=e=>{const t=_n(e);if(!t)return;const n=t.lastIndexOf(":");if(n<=0||n+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);const r=parseInt(t.substring(n+1),10);return"["===t[0]?[t.substring(1,n-1),r]:[t.substring(0,n),r]},bn=()=>{var e;return null===(e=vn())||void 0===e?void 0:e.config},En=e=>{var t;return null===(t=vn())||void 0===t?void 0:t[`_${e}`]};class kn{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}wrapCallback(e){return(t,n)=>{t?this.reject(t):this.resolve(n),"function"==typeof e&&(this.promise.catch((()=>{})),1===e.length?e(t):e(t,n))}}}function Sn(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}class Tn extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,Tn.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,In.prototype.create)}}class In{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){const n=t[0]||{},r=`${this.service}/${e}`,i=this.errors[e],s=i?function(e,t){return e.replace(On,((e,n)=>{const r=t[n];return null!=r?String(r):`<${n}?>`}))}(i,n):"Error",a=`${this.serviceName}: ${s} (${r}).`;return new Tn(r,a,n)}}const On=/\{\$([^}]+)}/g;function An(e,t){if(e===t)return!0;const n=Object.keys(e),r=Object.keys(t);for(const i of n){if(!r.includes(i))return!1;const n=e[i],s=t[i];if(xn(n)&&xn(s)){if(!An(n,s))return!1}else if(n!==s)return!1}for(const e of r)if(!n.includes(e))return!1;return!0}function xn(e){return null!==e&&"object"==typeof e}function Pn(e){const t=[];for(const[n,r]of Object.entries(e))Array.isArray(r)?r.forEach((e=>{t.push(encodeURIComponent(n)+"="+encodeURIComponent(e))})):t.push(encodeURIComponent(n)+"="+encodeURIComponent(r));return t.length?"&"+t.join("&"):""}function Cn(e){const t={};return e.replace(/^\?/,"").split("&").forEach((e=>{if(e){const[n,r]=e.split("=");t[decodeURIComponent(n)]=decodeURIComponent(r)}})),t}function Nn(e){const t=e.indexOf("?");if(!t)return"";const n=e.indexOf("#",t);return e.substring(t,n>0?n:void 0)}class Rn{constructor(e,t){this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=t,this.task.then((()=>{e(this)})).catch((e=>{this.error(e)}))}next(e){this.forEachObserver((t=>{t.next(e)}))}error(e){this.forEachObserver((t=>{t.error(e)})),this.close(e)}complete(){this.forEachObserver((e=>{e.complete()})),this.close()}subscribe(e,t,n){let r;if(void 0===e&&void 0===t&&void 0===n)throw new Error("Missing Observer.");r=function(e,t){if("object"!=typeof e||null===e)return!1;for(const t of["next","error","complete"])if(t in e&&"function"==typeof e[t])return!0;return!1}(e)?e:{next:e,error:t,complete:n},void 0===r.next&&(r.next=jn),void 0===r.error&&(r.error=jn),void 0===r.complete&&(r.complete=jn);const i=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then((()=>{try{this.finalError?r.error(this.finalError):r.complete()}catch(e){}})),this.observers.push(r),i}unsubscribeOne(e){void 0!==this.observers&&void 0!==this.observers[e]&&(delete this.observers[e],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))}forEachObserver(e){if(!this.finalized)for(let t=0;t<this.observers.length;t++)this.sendOne(t,e)}sendOne(e,t){this.task.then((()=>{if(void 0!==this.observers&&void 0!==this.observers[e])try{t(this.observers[e])}catch(e){"undefined"!=typeof console&&console.error&&console.error(e)}}))}close(e){this.finalized||(this.finalized=!0,void 0!==e&&(this.finalError=e),this.task.then((()=>{this.observers=void 0,this.onNoObservers=void 0})))}}function jn(){}function Ln(e){return e&&e._delegate?e._delegate:e}class Dn{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const Mn="[DEFAULT]";class $n{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const n=new kn;if(this.instancesDeferred.set(t,n),this.isInitialized(t)||this.shouldAutoInitialize())try{const e=this.getOrInitializeService({instanceIdentifier:t});e&&n.resolve(e)}catch(e){}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const n=this.normalizeInstanceIdentifier(null==e?void 0:e.identifier),r=null!==(t=null==e?void 0:e.optional)&&void 0!==t&&t;if(!this.isInitialized(n)&&!this.shouldAutoInitialize()){if(r)return null;throw Error(`Service ${this.name} is not available`)}try{return this.getOrInitializeService({instanceIdentifier:n})}catch(e){if(r)return null;throw e}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()){if(function(e){return"EAGER"===e.instantiationMode}(e))try{this.getOrInitializeService({instanceIdentifier:Mn})}catch(e){}for(const[t,n]of this.instancesDeferred.entries()){const r=this.normalizeInstanceIdentifier(t);try{const e=this.getOrInitializeService({instanceIdentifier:r});n.resolve(e)}catch(e){}}}}clearInstance(e=Mn){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter((e=>"INTERNAL"in e)).map((e=>e.INTERNAL.delete())),...e.filter((e=>"_delete"in e)).map((e=>e._delete()))])}isComponentSet(){return null!=this.component}isInitialized(e=Mn){return this.instances.has(e)}getOptions(e=Mn){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,n=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(n))throw Error(`${this.name}(${n}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const r=this.getOrInitializeService({instanceIdentifier:n,options:t});for(const[e,t]of this.instancesDeferred.entries())n===this.normalizeInstanceIdentifier(e)&&t.resolve(r);return r}onInit(e,t){var n;const r=this.normalizeInstanceIdentifier(t),i=null!==(n=this.onInitCallbacks.get(r))&&void 0!==n?n:new Set;i.add(e),this.onInitCallbacks.set(r,i);const s=this.instances.get(r);return s&&e(s,r),()=>{i.delete(e)}}invokeOnInitCallbacks(e,t){const n=this.onInitCallbacks.get(t);if(n)for(const r of n)try{r(e,t)}catch(e){}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let n=this.instances.get(e);if(!n&&this.component&&(n=this.component.instanceFactory(this.container,{instanceIdentifier:(r=e,r===Mn?void 0:r),options:t}),this.instances.set(e,n),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(n,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,n)}catch(e){}var r;return n||null}normalizeInstanceIdentifier(e=Mn){return this.component?this.component.multipleInstances?e:Mn:e}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}}class Un{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new $n(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}const Fn=[];var Bn;!function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(Bn||(Bn={}));const Vn={debug:Bn.DEBUG,verbose:Bn.VERBOSE,info:Bn.INFO,warn:Bn.WARN,error:Bn.ERROR,silent:Bn.SILENT},zn=Bn.INFO,qn={[Bn.DEBUG]:"log",[Bn.VERBOSE]:"log",[Bn.INFO]:"info",[Bn.WARN]:"warn",[Bn.ERROR]:"error"},Hn=(e,t,...n)=>{if(t<e.logLevel)return;const r=(new Date).toISOString(),i=qn[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)};class Kn{constructor(e){this.name=e,this._logLevel=zn,this._logHandler=Hn,this._userLogHandler=null,Fn.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in Bn))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?Vn[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,Bn.DEBUG,...e),this._logHandler(this,Bn.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,Bn.VERBOSE,...e),this._logHandler(this,Bn.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,Bn.INFO,...e),this._logHandler(this,Bn.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,Bn.WARN,...e),this._logHandler(this,Bn.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,Bn.ERROR,...e),this._logHandler(this,Bn.ERROR,...e)}}const Wn=(e,t)=>t.some((t=>e instanceof t));let Gn,Zn;const Jn=new WeakMap,Qn=new WeakMap,Xn=new WeakMap,Yn=new WeakMap,er=new WeakMap;let tr={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return Qn.get(e);if("objectStoreNames"===t)return e.objectStoreNames||Xn.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return nr(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function nr(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",s)},i=()=>{t(nr(e.result)),r()},s=()=>{n(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",s)}));return t.then((t=>{t instanceof IDBCursor&&Jn.set(t,e)})).catch((()=>{})),er.set(t,e),t}(e);if(Yn.has(e))return Yn.get(e);const t=function(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(Zn||(Zn=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(rr(this),e),nr(Jn.get(this))}:function(...e){return nr(t.apply(rr(this),e))}:function(e,...n){const r=t.call(rr(this),e,...n);return Xn.set(r,e.sort?e.sort():[e]),nr(r)}:(e instanceof IDBTransaction&&function(e){if(Qn.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",s),e.removeEventListener("abort",s)},i=()=>{t(),r()},s=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",s),e.addEventListener("abort",s)}));Qn.set(e,t)}(e),Wn(e,Gn||(Gn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,tr):e);var t}(e);return t!==e&&(Yn.set(e,t),er.set(t,e)),t}const rr=e=>er.get(e),ir=["get","getKey","getAll","getAllKeys","count"],sr=["put","add","delete","clear"],ar=new Map;function or(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(ar.get(t))return ar.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=sr.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!i&&!ir.includes(n))return;const s=async function(e,...t){const s=this.transaction(e,i?"readwrite":"readonly");let a=s.store;return r&&(a=a.index(t.shift())),(await Promise.all([a[n](...t),i&&s.done]))[0]};return ar.set(t,s),s}var cr;cr=tr,tr={...cr,get:(e,t,n)=>or(e,t)||cr.get(e,t,n),has:(e,t)=>!!or(e,t)||cr.has(e,t)};class ur{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map((e=>{if(function(e){const t=e.getComponent();return"VERSION"===(null==t?void 0:t.type)}(e)){const t=e.getImmediate();return`${t.library}/${t.version}`}return null})).filter((e=>e)).join(" ")}}const lr="@firebase/app",hr="0.10.7",dr=new Kn("@firebase/app"),fr="@firebase/app-compat",pr="@firebase/analytics-compat",mr="@firebase/analytics",gr="@firebase/app-check-compat",yr="@firebase/app-check",vr="@firebase/auth",_r="@firebase/auth-compat",wr="@firebase/database",br="@firebase/database-compat",Er="@firebase/functions",kr="@firebase/functions-compat",Sr="@firebase/installations",Tr="@firebase/installations-compat",Ir="@firebase/messaging",Or="@firebase/messaging-compat",Ar="@firebase/performance",xr="@firebase/performance-compat",Pr="@firebase/remote-config",Cr="@firebase/remote-config-compat",Nr="@firebase/storage",Rr="@firebase/storage-compat",jr="@firebase/firestore",Lr="@firebase/vertexai-preview",Dr="@firebase/firestore-compat",Mr="firebase",$r="[DEFAULT]",Ur={[lr]:"fire-core",[fr]:"fire-core-compat",[mr]:"fire-analytics",[pr]:"fire-analytics-compat",[yr]:"fire-app-check",[gr]:"fire-app-check-compat",[vr]:"fire-auth",[_r]:"fire-auth-compat",[wr]:"fire-rtdb",[br]:"fire-rtdb-compat",[Er]:"fire-fn",[kr]:"fire-fn-compat",[Sr]:"fire-iid",[Tr]:"fire-iid-compat",[Ir]:"fire-fcm",[Or]:"fire-fcm-compat",[Ar]:"fire-perf",[xr]:"fire-perf-compat",[Pr]:"fire-rc",[Cr]:"fire-rc-compat",[Nr]:"fire-gcs",[Rr]:"fire-gcs-compat",[jr]:"fire-fst",[Dr]:"fire-fst-compat",[Lr]:"fire-vertex","fire-js":"fire-js",[Mr]:"fire-js-all"},Fr=new Map,Br=new Map,Vr=new Map;function zr(e,t){try{e.container.addComponent(t)}catch(n){dr.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,n)}}function qr(e){const t=e.name;if(Vr.has(t))return dr.debug(`There were multiple attempts to register component ${t}.`),!1;Vr.set(t,e);for(const t of Fr.values())zr(t,e);for(const t of Br.values())zr(t,e);return!0}function Hr(e,t){const n=e.container.getProvider("heartbeat").getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}function Kr(e){return void 0!==e.settings}const Wr=new In("app","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."});class Gr{constructor(e,t,n){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=n,this.container.addComponent(new Dn("app",(()=>this),"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw Wr.create("app-deleted",{appName:this._name})}}const Zr="10.12.4";function Jr(e,t={}){let n=e;"object"!=typeof t&&(t={name:t});const r=Object.assign({name:$r,automaticDataCollectionEnabled:!1},t),i=r.name;if("string"!=typeof i||!i)throw Wr.create("bad-app-name",{appName:String(i)});if(n||(n=bn()),!n)throw Wr.create("no-options");const s=Fr.get(i);if(s){if(An(n,s.options)&&An(r,s.config))return s;throw Wr.create("duplicate-app",{appName:i})}const a=new Un(i);for(const e of Vr.values())a.addComponent(e);const o=new Gr(n,r,a);return Fr.set(i,o),o}function Qr(e=$r){const t=Fr.get(e);if(!t&&e===$r&&bn())return Jr();if(!t)throw Wr.create("no-app",{appName:e});return t}function Xr(e,t,n){var r;let i=null!==(r=Ur[e])&&void 0!==r?r:e;n&&(i+=`-${n}`);const s=i.match(/\s|\//),a=t.match(/\s|\//);if(s||a){const e=[`Unable to register library "${i}" with version "${t}":`];return s&&e.push(`library name "${i}" contains illegal characters (whitespace or "/")`),s&&a&&e.push("and"),a&&e.push(`version name "${t}" contains illegal characters (whitespace or "/")`),void dr.warn(e.join(" "))}qr(new Dn(`${i}-version`,(()=>({library:i,version:t})),"VERSION"))}const Yr="firebase-heartbeat-database",ei=1,ti="firebase-heartbeat-store";let ni=null;function ri(){return ni||(ni=function(e,t,{blocked:n,upgrade:r,blocking:i,terminated:s}={}){const a=indexedDB.open(e,t),o=nr(a);return r&&a.addEventListener("upgradeneeded",(e=>{r(nr(a.result),e.oldVersion,e.newVersion,nr(a.transaction),e)})),n&&a.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),o.then((e=>{s&&e.addEventListener("close",(()=>s())),i&&e.addEventListener("versionchange",(e=>i(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),o}(Yr,ei,{upgrade:(e,t)=>{if(0===t)try{e.createObjectStore(ti)}catch(e){console.warn(e)}}}).catch((e=>{throw Wr.create("idb-open",{originalErrorMessage:e.message})}))),ni}async function ii(e,t){try{const n=(await ri()).transaction(ti,"readwrite"),r=n.objectStore(ti);await r.put(t,si(e)),await n.done}catch(e){if(e instanceof Tn)dr.warn(e.message);else{const t=Wr.create("idb-set",{originalErrorMessage:null==e?void 0:e.message});dr.warn(t.message)}}}function si(e){return`${e.name}!${e.options.appId}`}class ai{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new ci(t),this._heartbeatsCachePromise=this._storage.read().then((e=>(this._heartbeatsCache=e,e)))}async triggerHeartbeat(){var e,t;const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=oi();if((null!=(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||(this._heartbeatsCache=await this._heartbeatsCachePromise,null!=(null===(t=this._heartbeatsCache)||void 0===t?void 0:t.heartbeats)))&&this._heartbeatsCache.lastSentHeartbeatDate!==r&&!this._heartbeatsCache.heartbeats.some((e=>e.date===r)))return this._heartbeatsCache.heartbeats.push({date:r,agent:n}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter((e=>{const t=new Date(e.date).valueOf();return Date.now()-t<=2592e6})),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){var e;if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,null==(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||0===this._heartbeatsCache.heartbeats.length)return"";const t=oi(),{heartbeatsToSend:n,unsentEntries:r}=function(e,t=1024){const n=[];let r=e.slice();for(const i of e){const e=n.find((e=>e.agent===i.agent));if(e){if(e.dates.push(i.date),ui(n)>t){e.dates.pop();break}}else if(n.push({agent:i.agent,dates:[i.date]}),ui(n)>t){n.pop();break}r=r.slice(1)}return{heartbeatsToSend:n,unsentEntries:r}}(this._heartbeatsCache.heartbeats),i=gn(JSON.stringify({version:2,heartbeats:n}));return this._heartbeatsCache.lastSentHeartbeatDate=t,r.length>0?(this._heartbeatsCache.heartbeats=r,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),i}}function oi(){return(new Date).toISOString().substring(0,10)}class ci{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!function(){try{return"object"==typeof indexedDB}catch(e){return!1}}()&&new Promise(((e,t)=>{try{let n=!0;const r="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(r);i.onsuccess=()=>{i.result.close(),n||self.indexedDB.deleteDatabase(r),e(!0)},i.onupgradeneeded=()=>{n=!1},i.onerror=()=>{var e;t((null===(e=i.error)||void 0===e?void 0:e.message)||"")}}catch(e){t(e)}})).then((()=>!0)).catch((()=>!1))}async read(){if(await this._canUseIndexedDBPromise){const e=await async function(e){try{const t=(await ri()).transaction(ti),n=await t.objectStore(ti).get(si(e));return await t.done,n}catch(e){if(e instanceof Tn)dr.warn(e.message);else{const t=Wr.create("idb-get",{originalErrorMessage:null==e?void 0:e.message});dr.warn(t.message)}}}(this.app);return(null==e?void 0:e.heartbeats)?e:{heartbeats:[]}}return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return ii(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:e.heartbeats})}}async add(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return ii(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...e.heartbeats]})}}}function ui(e){return gn(JSON.stringify({version:2,heartbeats:e})).length}function li(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}qr(new Dn("platform-logger",(e=>new ur(e)),"PRIVATE")),qr(new Dn("heartbeat",(e=>new ai(e)),"PRIVATE")),Xr(lr,hr,""),Xr(lr,hr,"esm2017"),Xr("fire-js",""),Xr("firebase","10.12.4","app"),Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;const hi=function(){return{"dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}},di=new In("auth","Firebase",{"dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}),fi=new Kn("@firebase/auth");function pi(e,...t){fi.logLevel<=Bn.ERROR&&fi.error(`Auth (${Zr}): ${e}`,...t)}function mi(e,...t){throw _i(e,...t)}function gi(e,...t){return _i(e,...t)}function yi(e,t,n){const r=Object.assign(Object.assign({},hi()),{[t]:n});return new In("auth","Firebase",r).create(t,{appName:e.name})}function vi(e){return yi(e,"operation-not-supported-in-this-environment","Operations that alter the current user are not supported in conjunction with FirebaseServerApp")}function _i(e,...t){if("string"!=typeof e){const n=t[0],r=[...t.slice(1)];return r[0]&&(r[0].appName=e.name),e._errorFactory.create(n,...r)}return di.create(e,...t)}function wi(e,t,...n){if(!e)throw _i(t,...n)}function bi(e){const t="INTERNAL ASSERTION FAILED: "+e;throw pi(t),new Error(t)}function Ei(e,t){e||bi(t)}function ki(){var e;return"undefined"!=typeof self&&(null===(e=self.location)||void 0===e?void 0:e.href)||""}function Si(){var e;return"undefined"!=typeof self&&(null===(e=self.location)||void 0===e?void 0:e.protocol)||null}class Ti{constructor(e,t){this.shortDelay=e,this.longDelay=t,Ei(t>e,"Short delay should be less than long delay!"),this.isMobile="undefined"!=typeof window&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(Sn())||"object"==typeof navigator&&"ReactNative"===navigator.product}get(){return"undefined"!=typeof navigator&&navigator&&"onLine"in navigator&&"boolean"==typeof navigator.onLine&&("http:"===Si()||"https:"===Si()||function(){const e="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0;return"object"==typeof e&&void 0!==e.id}()||"connection"in navigator)&&!navigator.onLine?Math.min(5e3,this.shortDelay):this.isMobile?this.longDelay:this.shortDelay}}function Ii(e,t){Ei(e.emulator,"Emulator should always be set here");const{url:n}=e.emulator;return t?`${n}${t.startsWith("/")?t.slice(1):t}`:n}class Oi{static initialize(e,t,n){this.fetchImpl=e,t&&(this.headersImpl=t),n&&(this.responseImpl=n)}static fetch(){return this.fetchImpl?this.fetchImpl:"undefined"!=typeof self&&"fetch"in self?self.fetch:"undefined"!=typeof globalThis&&globalThis.fetch?globalThis.fetch:"undefined"!=typeof fetch?fetch:void bi("Could not find fetch implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static headers(){return this.headersImpl?this.headersImpl:"undefined"!=typeof self&&"Headers"in self?self.Headers:"undefined"!=typeof globalThis&&globalThis.Headers?globalThis.Headers:"undefined"!=typeof Headers?Headers:void bi("Could not find Headers implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static response(){return this.responseImpl?this.responseImpl:"undefined"!=typeof self&&"Response"in self?self.Response:"undefined"!=typeof globalThis&&globalThis.Response?globalThis.Response:"undefined"!=typeof Response?Response:void bi("Could not find Response implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}}const Ai={CREDENTIAL_MISMATCH:"custom-token-mismatch",MISSING_CUSTOM_TOKEN:"internal-error",INVALID_IDENTIFIER:"invalid-email",MISSING_CONTINUE_URI:"internal-error",INVALID_PASSWORD:"wrong-password",MISSING_PASSWORD:"missing-password",INVALID_LOGIN_CREDENTIALS:"invalid-credential",EMAIL_EXISTS:"email-already-in-use",PASSWORD_LOGIN_DISABLED:"operation-not-allowed",INVALID_IDP_RESPONSE:"invalid-credential",INVALID_PENDING_TOKEN:"invalid-credential",FEDERATED_USER_ID_ALREADY_LINKED:"credential-already-in-use",MISSING_REQ_TYPE:"internal-error",EMAIL_NOT_FOUND:"user-not-found",RESET_PASSWORD_EXCEED_LIMIT:"too-many-requests",EXPIRED_OOB_CODE:"expired-action-code",INVALID_OOB_CODE:"invalid-action-code",MISSING_OOB_CODE:"internal-error",CREDENTIAL_TOO_OLD_LOGIN_AGAIN:"requires-recent-login",INVALID_ID_TOKEN:"invalid-user-token",TOKEN_EXPIRED:"user-token-expired",USER_NOT_FOUND:"user-token-expired",TOO_MANY_ATTEMPTS_TRY_LATER:"too-many-requests",PASSWORD_DOES_NOT_MEET_REQUIREMENTS:"password-does-not-meet-requirements",INVALID_CODE:"invalid-verification-code",INVALID_SESSION_INFO:"invalid-verification-id",INVALID_TEMPORARY_PROOF:"invalid-credential",MISSING_SESSION_INFO:"missing-verification-id",SESSION_EXPIRED:"code-expired",MISSING_ANDROID_PACKAGE_NAME:"missing-android-pkg-name",UNAUTHORIZED_DOMAIN:"unauthorized-continue-uri",INVALID_OAUTH_CLIENT_ID:"invalid-oauth-client-id",ADMIN_ONLY_OPERATION:"admin-restricted-operation",INVALID_MFA_PENDING_CREDENTIAL:"invalid-multi-factor-session",MFA_ENROLLMENT_NOT_FOUND:"multi-factor-info-not-found",MISSING_MFA_ENROLLMENT_ID:"missing-multi-factor-info",MISSING_MFA_PENDING_CREDENTIAL:"missing-multi-factor-session",SECOND_FACTOR_EXISTS:"second-factor-already-in-use",SECOND_FACTOR_LIMIT_EXCEEDED:"maximum-second-factor-count-exceeded",BLOCKING_FUNCTION_ERROR_RESPONSE:"internal-error",RECAPTCHA_NOT_ENABLED:"recaptcha-not-enabled",MISSING_RECAPTCHA_TOKEN:"missing-recaptcha-token",INVALID_RECAPTCHA_TOKEN:"invalid-recaptcha-token",INVALID_RECAPTCHA_ACTION:"invalid-recaptcha-action",MISSING_CLIENT_TYPE:"missing-client-type",MISSING_RECAPTCHA_VERSION:"missing-recaptcha-version",INVALID_RECAPTCHA_VERSION:"invalid-recaptcha-version",INVALID_REQ_TYPE:"invalid-req-type"},xi=new Ti(3e4,6e4);function Pi(e,t){return e.tenantId&&!t.tenantId?Object.assign(Object.assign({},t),{tenantId:e.tenantId}):t}async function Ci(e,t,n,r,i={}){return Ni(e,i,(async()=>{let i={},s={};r&&("GET"===t?s=r:i={body:JSON.stringify(r)});const a=Pn(Object.assign({key:e.config.apiKey},s)).slice(1),o=await e._getAdditionalHeaders();return o["Content-Type"]="application/json",e.languageCode&&(o["X-Firebase-Locale"]=e.languageCode),Oi.fetch()(ji(e,e.config.apiHost,n,a),Object.assign({method:t,headers:o,referrerPolicy:"no-referrer"},i))}))}async function Ni(e,t,n){e._canInitEmulator=!1;const r=Object.assign(Object.assign({},Ai),t);try{const t=new Di(e),i=await Promise.race([n(),t.promise]);t.clearNetworkTimeout();const s=await i.json();if("needConfirmation"in s)throw Mi(e,"account-exists-with-different-credential",s);if(i.ok&&!("errorMessage"in s))return s;{const t=i.ok?s.errorMessage:s.error.message,[n,a]=t.split(" : ");if("FEDERATED_USER_ID_ALREADY_LINKED"===n)throw Mi(e,"credential-already-in-use",s);if("EMAIL_EXISTS"===n)throw Mi(e,"email-already-in-use",s);if("USER_DISABLED"===n)throw Mi(e,"user-disabled",s);const o=r[n]||n.toLowerCase().replace(/[_\s]+/g,"-");if(a)throw yi(e,o,a);mi(e,o)}}catch(t){if(t instanceof Tn)throw t;mi(e,"network-request-failed",{message:String(t)})}}async function Ri(e,t,n,r,i={}){const s=await Ci(e,t,n,r,i);return"mfaPendingCredential"in s&&mi(e,"multi-factor-auth-required",{_serverResponse:s}),s}function ji(e,t,n,r){const i=`${t}${n}?${r}`;return e.config.emulator?Ii(e.config,i):`${e.config.apiScheme}://${i}`}function Li(e){switch(e){case"ENFORCE":return"ENFORCE";case"AUDIT":return"AUDIT";case"OFF":return"OFF";default:return"ENFORCEMENT_STATE_UNSPECIFIED"}}class Di{constructor(e){this.auth=e,this.timer=null,this.promise=new Promise(((e,t)=>{this.timer=setTimeout((()=>t(gi(this.auth,"network-request-failed"))),xi.get())}))}clearNetworkTimeout(){clearTimeout(this.timer)}}function Mi(e,t,n){const r={appName:e.name};n.email&&(r.email=n.email),n.phoneNumber&&(r.phoneNumber=n.phoneNumber);const i=gi(e,t,r);return i.customData._tokenResponse=n,i}function $i(e){return void 0!==e&&void 0!==e.enterprise}class Ui{constructor(e){if(this.siteKey="",this.recaptchaEnforcementState=[],void 0===e.recaptchaKey)throw new Error("recaptchaKey undefined");this.siteKey=e.recaptchaKey.split("/")[3],this.recaptchaEnforcementState=e.recaptchaEnforcementState}getProviderEnforcementState(e){if(!this.recaptchaEnforcementState||0===this.recaptchaEnforcementState.length)return null;for(const t of this.recaptchaEnforcementState)if(t.provider&&t.provider===e)return Li(t.enforcementState);return null}isProviderEnabled(e){return"ENFORCE"===this.getProviderEnforcementState(e)||"AUDIT"===this.getProviderEnforcementState(e)}}async function Fi(e,t){return Ci(e,"POST","/v1/accounts:lookup",t)}function Bi(e){if(e)try{const t=new Date(Number(e));if(!isNaN(t.getTime()))return t.toUTCString()}catch(e){}}function Vi(e){return 1e3*Number(e)}function zi(e){const[t,n,r]=e.split(".");if(void 0===t||void 0===n||void 0===r)return pi("JWT malformed, contained fewer than 3 sections"),null;try{const e=yn(n);return e?JSON.parse(e):(pi("Failed to decode base64 JWT payload"),null)}catch(e){return pi("Caught error parsing JWT payload as JSON",null==e?void 0:e.toString()),null}}function qi(e){const t=zi(e);return wi(t,"internal-error"),wi(void 0!==t.exp,"internal-error"),wi(void 0!==t.iat,"internal-error"),Number(t.exp)-Number(t.iat)}async function Hi(e,t,n=!1){if(n)return t;try{return await t}catch(t){throw t instanceof Tn&&function({code:e}){return"auth/user-disabled"===e||"auth/user-token-expired"===e}(t)&&e.auth.currentUser===e&&await e.auth.signOut(),t}}class Ki{constructor(e){this.user=e,this.isRunning=!1,this.timerId=null,this.errorBackoff=3e4}_start(){this.isRunning||(this.isRunning=!0,this.schedule())}_stop(){this.isRunning&&(this.isRunning=!1,null!==this.timerId&&clearTimeout(this.timerId))}getInterval(e){var t;if(e){const e=this.errorBackoff;return this.errorBackoff=Math.min(2*this.errorBackoff,96e4),e}{this.errorBackoff=3e4;const e=(null!==(t=this.user.stsTokenManager.expirationTime)&&void 0!==t?t:0)-Date.now()-3e5;return Math.max(0,e)}}schedule(e=!1){if(!this.isRunning)return;const t=this.getInterval(e);this.timerId=setTimeout((async()=>{await this.iteration()}),t)}async iteration(){try{await this.user.getIdToken(!0)}catch(e){return void("auth/network-request-failed"===(null==e?void 0:e.code)&&this.schedule(!0))}this.schedule()}}class Wi{constructor(e,t){this.createdAt=e,this.lastLoginAt=t,this._initializeTime()}_initializeTime(){this.lastSignInTime=Bi(this.lastLoginAt),this.creationTime=Bi(this.createdAt)}_copy(e){this.createdAt=e.createdAt,this.lastLoginAt=e.lastLoginAt,this._initializeTime()}toJSON(){return{createdAt:this.createdAt,lastLoginAt:this.lastLoginAt}}}async function Gi(e){var t;const n=e.auth,r=await e.getIdToken(),i=await Hi(e,Fi(n,{idToken:r}));wi(null==i?void 0:i.users.length,n,"internal-error");const s=i.users[0];e._notifyReloadListener(s);const a=(null===(t=s.providerUserInfo)||void 0===t?void 0:t.length)?Zi(s.providerUserInfo):[],o=(c=e.providerData,u=a,[...c.filter((e=>!u.some((t=>t.providerId===e.providerId)))),...u]);var c,u;const l=e.isAnonymous,h=!(e.email&&s.passwordHash||(null==o?void 0:o.length)),d=!!l&&h,f={uid:s.localId,displayName:s.displayName||null,photoURL:s.photoUrl||null,email:s.email||null,emailVerified:s.emailVerified||!1,phoneNumber:s.phoneNumber||null,tenantId:s.tenantId||null,providerData:o,metadata:new Wi(s.createdAt,s.lastLoginAt),isAnonymous:d};Object.assign(e,f)}function Zi(e){return e.map((e=>{var{providerId:t}=e,n=li(e,["providerId"]);return{providerId:t,uid:n.rawId||"",displayName:n.displayName||null,email:n.email||null,phoneNumber:n.phoneNumber||null,photoURL:n.photoUrl||null}}))}class Ji{constructor(){this.refreshToken=null,this.accessToken=null,this.expirationTime=null}get isExpired(){return!this.expirationTime||Date.now()>this.expirationTime-3e4}updateFromServerResponse(e){wi(e.idToken,"internal-error"),wi(void 0!==e.idToken,"internal-error"),wi(void 0!==e.refreshToken,"internal-error");const t="expiresIn"in e&&void 0!==e.expiresIn?Number(e.expiresIn):qi(e.idToken);this.updateTokensAndExpiration(e.idToken,e.refreshToken,t)}updateFromIdToken(e){wi(0!==e.length,"internal-error");const t=qi(e);this.updateTokensAndExpiration(e,null,t)}async getToken(e,t=!1){return t||!this.accessToken||this.isExpired?(wi(this.refreshToken,e,"user-token-expired"),this.refreshToken?(await this.refresh(e,this.refreshToken),this.accessToken):null):this.accessToken}clearRefreshToken(){this.refreshToken=null}async refresh(e,t){const{accessToken:n,refreshToken:r,expiresIn:i}=await async function(e,t){const n=await Ni(e,{},(async()=>{const n=Pn({grant_type:"refresh_token",refresh_token:t}).slice(1),{tokenApiHost:r,apiKey:i}=e.config,s=ji(e,r,"/v1/token",`key=${i}`),a=await e._getAdditionalHeaders();return a["Content-Type"]="application/x-www-form-urlencoded",Oi.fetch()(s,{method:"POST",headers:a,body:n})}));return{accessToken:n.access_token,expiresIn:n.expires_in,refreshToken:n.refresh_token}}(e,t);this.updateTokensAndExpiration(n,r,Number(i))}updateTokensAndExpiration(e,t,n){this.refreshToken=t||null,this.accessToken=e||null,this.expirationTime=Date.now()+1e3*n}static fromJSON(e,t){const{refreshToken:n,accessToken:r,expirationTime:i}=t,s=new Ji;return n&&(wi("string"==typeof n,"internal-error",{appName:e}),s.refreshToken=n),r&&(wi("string"==typeof r,"internal-error",{appName:e}),s.accessToken=r),i&&(wi("number"==typeof i,"internal-error",{appName:e}),s.expirationTime=i),s}toJSON(){return{refreshToken:this.refreshToken,accessToken:this.accessToken,expirationTime:this.expirationTime}}_assign(e){this.accessToken=e.accessToken,this.refreshToken=e.refreshToken,this.expirationTime=e.expirationTime}_clone(){return Object.assign(new Ji,this.toJSON())}_performRefresh(){return bi("not implemented")}}function Qi(e,t){wi("string"==typeof e||void 0===e,"internal-error",{appName:t})}class Xi{constructor(e){var{uid:t,auth:n,stsTokenManager:r}=e,i=li(e,["uid","auth","stsTokenManager"]);this.providerId="firebase",this.proactiveRefresh=new Ki(this),this.reloadUserInfo=null,this.reloadListener=null,this.uid=t,this.auth=n,this.stsTokenManager=r,this.accessToken=r.accessToken,this.displayName=i.displayName||null,this.email=i.email||null,this.emailVerified=i.emailVerified||!1,this.phoneNumber=i.phoneNumber||null,this.photoURL=i.photoURL||null,this.isAnonymous=i.isAnonymous||!1,this.tenantId=i.tenantId||null,this.providerData=i.providerData?[...i.providerData]:[],this.metadata=new Wi(i.createdAt||void 0,i.lastLoginAt||void 0)}async getIdToken(e){const t=await Hi(this,this.stsTokenManager.getToken(this.auth,e));return wi(t,this.auth,"internal-error"),this.accessToken!==t&&(this.accessToken=t,await this.auth._persistUserIfCurrent(this),this.auth._notifyListenersIfCurrent(this)),t}getIdTokenResult(e){return async function(e,t=!1){const n=Ln(e),r=await n.getIdToken(t),i=zi(r);wi(i&&i.exp&&i.auth_time&&i.iat,n.auth,"internal-error");const s="object"==typeof i.firebase?i.firebase:void 0,a=null==s?void 0:s.sign_in_provider;return{claims:i,token:r,authTime:Bi(Vi(i.auth_time)),issuedAtTime:Bi(Vi(i.iat)),expirationTime:Bi(Vi(i.exp)),signInProvider:a||null,signInSecondFactor:(null==s?void 0:s.sign_in_second_factor)||null}}(this,e)}reload(){return async function(e){const t=Ln(e);await Gi(t),await t.auth._persistUserIfCurrent(t),t.auth._notifyListenersIfCurrent(t)}(this)}_assign(e){this!==e&&(wi(this.uid===e.uid,this.auth,"internal-error"),this.displayName=e.displayName,this.photoURL=e.photoURL,this.email=e.email,this.emailVerified=e.emailVerified,this.phoneNumber=e.phoneNumber,this.isAnonymous=e.isAnonymous,this.tenantId=e.tenantId,this.providerData=e.providerData.map((e=>Object.assign({},e))),this.metadata._copy(e.metadata),this.stsTokenManager._assign(e.stsTokenManager))}_clone(e){const t=new Xi(Object.assign(Object.assign({},this),{auth:e,stsTokenManager:this.stsTokenManager._clone()}));return t.metadata._copy(this.metadata),t}_onReload(e){wi(!this.reloadListener,this.auth,"internal-error"),this.reloadListener=e,this.reloadUserInfo&&(this._notifyReloadListener(this.reloadUserInfo),this.reloadUserInfo=null)}_notifyReloadListener(e){this.reloadListener?this.reloadListener(e):this.reloadUserInfo=e}_startProactiveRefresh(){this.proactiveRefresh._start()}_stopProactiveRefresh(){this.proactiveRefresh._stop()}async _updateTokensIfNecessary(e,t=!1){let n=!1;e.idToken&&e.idToken!==this.stsTokenManager.accessToken&&(this.stsTokenManager.updateFromServerResponse(e),n=!0),t&&await Gi(this),await this.auth._persistUserIfCurrent(this),n&&this.auth._notifyListenersIfCurrent(this)}async delete(){if(Kr(this.auth.app))return Promise.reject(vi(this.auth));const e=await this.getIdToken();return await Hi(this,async function(e,t){return Ci(e,"POST","/v1/accounts:delete",t)}(this.auth,{idToken:e})),this.stsTokenManager.clearRefreshToken(),this.auth.signOut()}toJSON(){return Object.assign(Object.assign({uid:this.uid,email:this.email||void 0,emailVerified:this.emailVerified,displayName:this.displayName||void 0,isAnonymous:this.isAnonymous,photoURL:this.photoURL||void 0,phoneNumber:this.phoneNumber||void 0,tenantId:this.tenantId||void 0,providerData:this.providerData.map((e=>Object.assign({},e))),stsTokenManager:this.stsTokenManager.toJSON(),_redirectEventId:this._redirectEventId},this.metadata.toJSON()),{apiKey:this.auth.config.apiKey,appName:this.auth.name})}get refreshToken(){return this.stsTokenManager.refreshToken||""}static _fromJSON(e,t){var n,r,i,s,a,o,c,u;const l=null!==(n=t.displayName)&&void 0!==n?n:void 0,h=null!==(r=t.email)&&void 0!==r?r:void 0,d=null!==(i=t.phoneNumber)&&void 0!==i?i:void 0,f=null!==(s=t.photoURL)&&void 0!==s?s:void 0,p=null!==(a=t.tenantId)&&void 0!==a?a:void 0,m=null!==(o=t._redirectEventId)&&void 0!==o?o:void 0,g=null!==(c=t.createdAt)&&void 0!==c?c:void 0,y=null!==(u=t.lastLoginAt)&&void 0!==u?u:void 0,{uid:v,emailVerified:_,isAnonymous:w,providerData:b,stsTokenManager:E}=t;wi(v&&E,e,"internal-error");const k=Ji.fromJSON(this.name,E);wi("string"==typeof v,e,"internal-error"),Qi(l,e.name),Qi(h,e.name),wi("boolean"==typeof _,e,"internal-error"),wi("boolean"==typeof w,e,"internal-error"),Qi(d,e.name),Qi(f,e.name),Qi(p,e.name),Qi(m,e.name),Qi(g,e.name),Qi(y,e.name);const S=new Xi({uid:v,auth:e,email:h,emailVerified:_,displayName:l,isAnonymous:w,photoURL:f,phoneNumber:d,tenantId:p,stsTokenManager:k,createdAt:g,lastLoginAt:y});return b&&Array.isArray(b)&&(S.providerData=b.map((e=>Object.assign({},e)))),m&&(S._redirectEventId=m),S}static async _fromIdTokenResponse(e,t,n=!1){const r=new Ji;r.updateFromServerResponse(t);const i=new Xi({uid:t.localId,auth:e,stsTokenManager:r,isAnonymous:n});return await Gi(i),i}static async _fromGetAccountInfoResponse(e,t,n){const r=t.users[0];wi(void 0!==r.localId,"internal-error");const i=void 0!==r.providerUserInfo?Zi(r.providerUserInfo):[],s=!(r.email&&r.passwordHash||(null==i?void 0:i.length)),a=new Ji;a.updateFromIdToken(n);const o=new Xi({uid:r.localId,auth:e,stsTokenManager:a,isAnonymous:s}),c={uid:r.localId,displayName:r.displayName||null,photoURL:r.photoUrl||null,email:r.email||null,emailVerified:r.emailVerified||!1,phoneNumber:r.phoneNumber||null,tenantId:r.tenantId||null,providerData:i,metadata:new Wi(r.createdAt,r.lastLoginAt),isAnonymous:!(r.email&&r.passwordHash||(null==i?void 0:i.length))};return Object.assign(o,c),o}}const Yi=new Map;function es(e){Ei(e instanceof Function,"Expected a class definition");let t=Yi.get(e);return t?(Ei(t instanceof e,"Instance stored in cache mismatched with class"),t):(t=new e,Yi.set(e,t),t)}class ts{constructor(){this.type="NONE",this.storage={}}async _isAvailable(){return!0}async _set(e,t){this.storage[e]=t}async _get(e){const t=this.storage[e];return void 0===t?null:t}async _remove(e){delete this.storage[e]}_addListener(e,t){}_removeListener(e,t){}}ts.type="NONE";const ns=ts;function rs(e,t,n){return`firebase:${e}:${t}:${n}`}class is{constructor(e,t,n){this.persistence=e,this.auth=t,this.userKey=n;const{config:r,name:i}=this.auth;this.fullUserKey=rs(this.userKey,r.apiKey,i),this.fullPersistenceKey=rs("persistence",r.apiKey,i),this.boundEventHandler=t._onStorageEvent.bind(t),this.persistence._addListener(this.fullUserKey,this.boundEventHandler)}setCurrentUser(e){return this.persistence._set(this.fullUserKey,e.toJSON())}async getCurrentUser(){const e=await this.persistence._get(this.fullUserKey);return e?Xi._fromJSON(this.auth,e):null}removeCurrentUser(){return this.persistence._remove(this.fullUserKey)}savePersistenceForRedirect(){return this.persistence._set(this.fullPersistenceKey,this.persistence.type)}async setPersistence(e){if(this.persistence===e)return;const t=await this.getCurrentUser();return await this.removeCurrentUser(),this.persistence=e,t?this.setCurrentUser(t):void 0}delete(){this.persistence._removeListener(this.fullUserKey,this.boundEventHandler)}static async create(e,t,n="authUser"){if(!t.length)return new is(es(ns),e,n);const r=(await Promise.all(t.map((async e=>{if(await e._isAvailable())return e})))).filter((e=>e));let i=r[0]||es(ns);const s=rs(n,e.config.apiKey,e.name);let a=null;for(const n of t)try{const t=await n._get(s);if(t){const r=Xi._fromJSON(e,t);n!==i&&(a=r),i=n;break}}catch(e){}const o=r.filter((e=>e._shouldAllowMigration));return i._shouldAllowMigration&&o.length?(i=o[0],a&&await i._set(s,a.toJSON()),await Promise.all(t.map((async e=>{if(e!==i)try{await e._remove(s)}catch(e){}}))),new is(i,e,n)):new is(i,e,n)}}function ss(e){const t=e.toLowerCase();if(t.includes("opera/")||t.includes("opr/")||t.includes("opios/"))return"Opera";if(us(t))return"IEMobile";if(t.includes("msie")||t.includes("trident/"))return"IE";if(t.includes("edge/"))return"Edge";if(as(t))return"Firefox";if(t.includes("silk/"))return"Silk";if(hs(t))return"Blackberry";if(ds(t))return"Webos";if(os(t))return"Safari";if((t.includes("chrome/")||cs(t))&&!t.includes("edge/"))return"Chrome";if(ls(t))return"Android";{const t=/([a-zA-Z\d\.]+)\/[a-zA-Z\d\.]*$/,n=e.match(t);if(2===(null==n?void 0:n.length))return n[1]}return"Other"}function as(e=Sn()){return/firefox\//i.test(e)}function os(e=Sn()){const t=e.toLowerCase();return t.includes("safari/")&&!t.includes("chrome/")&&!t.includes("crios/")&&!t.includes("android")}function cs(e=Sn()){return/crios\//i.test(e)}function us(e=Sn()){return/iemobile/i.test(e)}function ls(e=Sn()){return/android/i.test(e)}function hs(e=Sn()){return/blackberry/i.test(e)}function ds(e=Sn()){return/webos/i.test(e)}function fs(e=Sn()){return/iphone|ipad|ipod/i.test(e)||/macintosh/i.test(e)&&/mobile/i.test(e)}function ps(e=Sn()){return fs(e)||ls(e)||ds(e)||hs(e)||/windows phone/i.test(e)||us(e)}function ms(e,t=[]){let n;switch(e){case"Browser":n=ss(Sn());break;case"Worker":n=`${ss(Sn())}-${e}`;break;default:n=e}const r=t.length?t.join(","):"FirebaseCore-web";return`${n}/JsCore/${Zr}/${r}`}class gs{constructor(e){this.auth=e,this.queue=[]}pushCallback(e,t){const n=t=>new Promise(((n,r)=>{try{n(e(t))}catch(e){r(e)}}));n.onAbort=t,this.queue.push(n);const r=this.queue.length-1;return()=>{this.queue[r]=()=>Promise.resolve()}}async runMiddleware(e){if(this.auth.currentUser===e)return;const t=[];try{for(const n of this.queue)await n(e),n.onAbort&&t.push(n.onAbort)}catch(e){t.reverse();for(const n of t)try{n()}catch(e){}throw this.auth._errorFactory.create("login-blocked",{originalMessage:null==e?void 0:e.message})}}}class ys{constructor(e){var t,n,r,i;const s=e.customStrengthOptions;this.customStrengthOptions={},this.customStrengthOptions.minPasswordLength=null!==(t=s.minPasswordLength)&&void 0!==t?t:6,s.maxPasswordLength&&(this.customStrengthOptions.maxPasswordLength=s.maxPasswordLength),void 0!==s.containsLowercaseCharacter&&(this.customStrengthOptions.containsLowercaseLetter=s.containsLowercaseCharacter),void 0!==s.containsUppercaseCharacter&&(this.customStrengthOptions.containsUppercaseLetter=s.containsUppercaseCharacter),void 0!==s.containsNumericCharacter&&(this.customStrengthOptions.containsNumericCharacter=s.containsNumericCharacter),void 0!==s.containsNonAlphanumericCharacter&&(this.customStrengthOptions.containsNonAlphanumericCharacter=s.containsNonAlphanumericCharacter),this.enforcementState=e.enforcementState,"ENFORCEMENT_STATE_UNSPECIFIED"===this.enforcementState&&(this.enforcementState="OFF"),this.allowedNonAlphanumericCharacters=null!==(r=null===(n=e.allowedNonAlphanumericCharacters)||void 0===n?void 0:n.join(""))&&void 0!==r?r:"",this.forceUpgradeOnSignin=null!==(i=e.forceUpgradeOnSignin)&&void 0!==i&&i,this.schemaVersion=e.schemaVersion}validatePassword(e){var t,n,r,i,s,a;const o={isValid:!0,passwordPolicy:this};return this.validatePasswordLengthOptions(e,o),this.validatePasswordCharacterOptions(e,o),o.isValid&&(o.isValid=null===(t=o.meetsMinPasswordLength)||void 0===t||t),o.isValid&&(o.isValid=null===(n=o.meetsMaxPasswordLength)||void 0===n||n),o.isValid&&(o.isValid=null===(r=o.containsLowercaseLetter)||void 0===r||r),o.isValid&&(o.isValid=null===(i=o.containsUppercaseLetter)||void 0===i||i),o.isValid&&(o.isValid=null===(s=o.containsNumericCharacter)||void 0===s||s),o.isValid&&(o.isValid=null===(a=o.containsNonAlphanumericCharacter)||void 0===a||a),o}validatePasswordLengthOptions(e,t){const n=this.customStrengthOptions.minPasswordLength,r=this.customStrengthOptions.maxPasswordLength;n&&(t.meetsMinPasswordLength=e.length>=n),r&&(t.meetsMaxPasswordLength=e.length<=r)}validatePasswordCharacterOptions(e,t){let n;this.updatePasswordCharacterOptionsStatuses(t,!1,!1,!1,!1);for(let r=0;r<e.length;r++)n=e.charAt(r),this.updatePasswordCharacterOptionsStatuses(t,n>="a"&&n<="z",n>="A"&&n<="Z",n>="0"&&n<="9",this.allowedNonAlphanumericCharacters.includes(n))}updatePasswordCharacterOptionsStatuses(e,t,n,r,i){this.customStrengthOptions.containsLowercaseLetter&&(e.containsLowercaseLetter||(e.containsLowercaseLetter=t)),this.customStrengthOptions.containsUppercaseLetter&&(e.containsUppercaseLetter||(e.containsUppercaseLetter=n)),this.customStrengthOptions.containsNumericCharacter&&(e.containsNumericCharacter||(e.containsNumericCharacter=r)),this.customStrengthOptions.containsNonAlphanumericCharacter&&(e.containsNonAlphanumericCharacter||(e.containsNonAlphanumericCharacter=i))}}class vs{constructor(e,t,n,r){this.app=e,this.heartbeatServiceProvider=t,this.appCheckServiceProvider=n,this.config=r,this.currentUser=null,this.emulatorConfig=null,this.operations=Promise.resolve(),this.authStateSubscription=new ws(this),this.idTokenSubscription=new ws(this),this.beforeStateQueue=new gs(this),this.redirectUser=null,this.isProactiveRefreshEnabled=!1,this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION=1,this._canInitEmulator=!0,this._isInitialized=!1,this._deleted=!1,this._initializationPromise=null,this._popupRedirectResolver=null,this._errorFactory=di,this._agentRecaptchaConfig=null,this._tenantRecaptchaConfigs={},this._projectPasswordPolicy=null,this._tenantPasswordPolicies={},this.lastNotifiedUid=void 0,this.languageCode=null,this.tenantId=null,this.settings={appVerificationDisabledForTesting:!1},this.frameworks=[],this.name=e.name,this.clientVersion=r.sdkClientVersion}_initializeWithPersistence(e,t){return t&&(this._popupRedirectResolver=es(t)),this._initializationPromise=this.queue((async()=>{var n,r;if(!this._deleted&&(this.persistenceManager=await is.create(this,e),!this._deleted)){if(null===(n=this._popupRedirectResolver)||void 0===n?void 0:n._shouldInitProactively)try{await this._popupRedirectResolver._initialize(this)}catch(e){}await this.initializeCurrentUser(t),this.lastNotifiedUid=(null===(r=this.currentUser)||void 0===r?void 0:r.uid)||null,this._deleted||(this._isInitialized=!0)}})),this._initializationPromise}async _onStorageEvent(){if(this._deleted)return;const e=await this.assertedPersistence.getCurrentUser();return this.currentUser||e?this.currentUser&&e&&this.currentUser.uid===e.uid?(this._currentUser._assign(e),void await this.currentUser.getIdToken()):void await this._updateCurrentUser(e,!0):void 0}async initializeCurrentUserFromIdToken(e){try{const t=await Fi(this,{idToken:e}),n=await Xi._fromGetAccountInfoResponse(this,t,e);await this.directlySetCurrentUser(n)}catch(e){console.warn("FirebaseServerApp could not login user with provided authIdToken: ",e),await this.directlySetCurrentUser(null)}}async initializeCurrentUser(e){var t;if(Kr(this.app)){const e=this.app.settings.authIdToken;return e?new Promise((t=>{setTimeout((()=>this.initializeCurrentUserFromIdToken(e).then(t,t)))})):this.directlySetCurrentUser(null)}const n=await this.assertedPersistence.getCurrentUser();let r=n,i=!1;if(e&&this.config.authDomain){await this.getOrInitRedirectPersistenceManager();const n=null===(t=this.redirectUser)||void 0===t?void 0:t._redirectEventId,s=null==r?void 0:r._redirectEventId,a=await this.tryRedirectSignIn(e);n&&n!==s||!(null==a?void 0:a.user)||(r=a.user,i=!0)}if(!r)return this.directlySetCurrentUser(null);if(!r._redirectEventId){if(i)try{await this.beforeStateQueue.runMiddleware(r)}catch(e){r=n,this._popupRedirectResolver._overrideRedirectResult(this,(()=>Promise.reject(e)))}return r?this.reloadAndSetCurrentUserOrClear(r):this.directlySetCurrentUser(null)}return wi(this._popupRedirectResolver,this,"argument-error"),await this.getOrInitRedirectPersistenceManager(),this.redirectUser&&this.redirectUser._redirectEventId===r._redirectEventId?this.directlySetCurrentUser(r):this.reloadAndSetCurrentUserOrClear(r)}async tryRedirectSignIn(e){let t=null;try{t=await this._popupRedirectResolver._completeRedirectFn(this,e,!0)}catch(e){await this._setRedirectUser(null)}return t}async reloadAndSetCurrentUserOrClear(e){try{await Gi(e)}catch(e){if("auth/network-request-failed"!==(null==e?void 0:e.code))return this.directlySetCurrentUser(null)}return this.directlySetCurrentUser(e)}useDeviceLanguage(){this.languageCode=function(){if("undefined"==typeof navigator)return null;const e=navigator;return e.languages&&e.languages[0]||e.language||null}()}async _delete(){this._deleted=!0}async updateCurrentUser(e){if(Kr(this.app))return Promise.reject(vi(this));const t=e?Ln(e):null;return t&&wi(t.auth.config.apiKey===this.config.apiKey,this,"invalid-user-token"),this._updateCurrentUser(t&&t._clone(this))}async _updateCurrentUser(e,t=!1){if(!this._deleted)return e&&wi(this.tenantId===e.tenantId,this,"tenant-id-mismatch"),t||await this.beforeStateQueue.runMiddleware(e),this.queue((async()=>{await this.directlySetCurrentUser(e),this.notifyAuthListeners()}))}async signOut(){return Kr(this.app)?Promise.reject(vi(this)):(await this.beforeStateQueue.runMiddleware(null),(this.redirectPersistenceManager||this._popupRedirectResolver)&&await this._setRedirectUser(null),this._updateCurrentUser(null,!0))}setPersistence(e){return Kr(this.app)?Promise.reject(vi(this)):this.queue((async()=>{await this.assertedPersistence.setPersistence(es(e))}))}_getRecaptchaConfig(){return null==this.tenantId?this._agentRecaptchaConfig:this._tenantRecaptchaConfigs[this.tenantId]}async validatePassword(e){this._getPasswordPolicyInternal()||await this._updatePasswordPolicy();const t=this._getPasswordPolicyInternal();return t.schemaVersion!==this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION?Promise.reject(this._errorFactory.create("unsupported-password-policy-schema-version",{})):t.validatePassword(e)}_getPasswordPolicyInternal(){return null===this.tenantId?this._projectPasswordPolicy:this._tenantPasswordPolicies[this.tenantId]}async _updatePasswordPolicy(){const e=await async function(e,t={}){return Ci(e,"GET","/v2/passwordPolicy",Pi(e,t))}(this),t=new ys(e);null===this.tenantId?this._projectPasswordPolicy=t:this._tenantPasswordPolicies[this.tenantId]=t}_getPersistence(){return this.assertedPersistence.persistence.type}_updateErrorMap(e){this._errorFactory=new In("auth","Firebase",e())}onAuthStateChanged(e,t,n){return this.registerStateListener(this.authStateSubscription,e,t,n)}beforeAuthStateChanged(e,t){return this.beforeStateQueue.pushCallback(e,t)}onIdTokenChanged(e,t,n){return this.registerStateListener(this.idTokenSubscription,e,t,n)}authStateReady(){return new Promise(((e,t)=>{if(this.currentUser)e();else{const n=this.onAuthStateChanged((()=>{n(),e()}),t)}}))}async revokeAccessToken(e){if(this.currentUser){const t={providerId:"apple.com",tokenType:"ACCESS_TOKEN",token:e,idToken:await this.currentUser.getIdToken()};null!=this.tenantId&&(t.tenantId=this.tenantId),await async function(e,t){return Ci(e,"POST","/v2/accounts:revokeToken",Pi(e,t))}(this,t)}}toJSON(){var e;return{apiKey:this.config.apiKey,authDomain:this.config.authDomain,appName:this.name,currentUser:null===(e=this._currentUser)||void 0===e?void 0:e.toJSON()}}async _setRedirectUser(e,t){const n=await this.getOrInitRedirectPersistenceManager(t);return null===e?n.removeCurrentUser():n.setCurrentUser(e)}async getOrInitRedirectPersistenceManager(e){if(!this.redirectPersistenceManager){const t=e&&es(e)||this._popupRedirectResolver;wi(t,this,"argument-error"),this.redirectPersistenceManager=await is.create(this,[es(t._redirectPersistence)],"redirectUser"),this.redirectUser=await this.redirectPersistenceManager.getCurrentUser()}return this.redirectPersistenceManager}async _redirectUserForId(e){var t,n;return this._isInitialized&&await this.queue((async()=>{})),(null===(t=this._currentUser)||void 0===t?void 0:t._redirectEventId)===e?this._currentUser:(null===(n=this.redirectUser)||void 0===n?void 0:n._redirectEventId)===e?this.redirectUser:null}async _persistUserIfCurrent(e){if(e===this.currentUser)return this.queue((async()=>this.directlySetCurrentUser(e)))}_notifyListenersIfCurrent(e){e===this.currentUser&&this.notifyAuthListeners()}_key(){return`${this.config.authDomain}:${this.config.apiKey}:${this.name}`}_startProactiveRefresh(){this.isProactiveRefreshEnabled=!0,this.currentUser&&this._currentUser._startProactiveRefresh()}_stopProactiveRefresh(){this.isProactiveRefreshEnabled=!1,this.currentUser&&this._currentUser._stopProactiveRefresh()}get _currentUser(){return this.currentUser}notifyAuthListeners(){var e,t;if(!this._isInitialized)return;this.idTokenSubscription.next(this.currentUser);const n=null!==(t=null===(e=this.currentUser)||void 0===e?void 0:e.uid)&&void 0!==t?t:null;this.lastNotifiedUid!==n&&(this.lastNotifiedUid=n,this.authStateSubscription.next(this.currentUser))}registerStateListener(e,t,n,r){if(this._deleted)return()=>{};const i="function"==typeof t?t:t.next.bind(t);let s=!1;const a=this._isInitialized?Promise.resolve():this._initializationPromise;if(wi(a,this,"internal-error"),a.then((()=>{s||i(this.currentUser)})),"function"==typeof t){const i=e.addObserver(t,n,r);return()=>{s=!0,i()}}{const n=e.addObserver(t);return()=>{s=!0,n()}}}async directlySetCurrentUser(e){this.currentUser&&this.currentUser!==e&&this._currentUser._stopProactiveRefresh(),e&&this.isProactiveRefreshEnabled&&e._startProactiveRefresh(),this.currentUser=e,e?await this.assertedPersistence.setCurrentUser(e):await this.assertedPersistence.removeCurrentUser()}queue(e){return this.operations=this.operations.then(e,e),this.operations}get assertedPersistence(){return wi(this.persistenceManager,this,"internal-error"),this.persistenceManager}_logFramework(e){e&&!this.frameworks.includes(e)&&(this.frameworks.push(e),this.frameworks.sort(),this.clientVersion=ms(this.config.clientPlatform,this._getFrameworks()))}_getFrameworks(){return this.frameworks}async _getAdditionalHeaders(){var e;const t={"X-Client-Version":this.clientVersion};this.app.options.appId&&(t["X-Firebase-gmpid"]=this.app.options.appId);const n=await(null===(e=this.heartbeatServiceProvider.getImmediate({optional:!0}))||void 0===e?void 0:e.getHeartbeatsHeader());n&&(t["X-Firebase-Client"]=n);const r=await this._getAppCheckToken();return r&&(t["X-Firebase-AppCheck"]=r),t}async _getAppCheckToken(){var e;const t=await(null===(e=this.appCheckServiceProvider.getImmediate({optional:!0}))||void 0===e?void 0:e.getToken());return(null==t?void 0:t.error)&&function(e,...t){fi.logLevel<=Bn.WARN&&fi.warn(`Auth (${Zr}): ${e}`,...t)}(`Error while retrieving App Check token: ${t.error}`),null==t?void 0:t.token}}function _s(e){return Ln(e)}class ws{constructor(e){this.auth=e,this.observer=null,this.addObserver=function(e,t){const n=new Rn(e,void 0);return n.subscribe.bind(n)}((e=>this.observer=e))}get next(){return wi(this.observer,this.auth,"internal-error"),this.observer.next.bind(this.observer)}}let bs={async loadJS(){throw new Error("Unable to load external scripts")},recaptchaV2Script:"",recaptchaEnterpriseScript:"",gapiScript:""};function Es(e){return bs.loadJS(e)}function ks(e){return`__${e}${Math.floor(1e6*Math.random())}`}class Ss{constructor(e){this.type="recaptcha-enterprise",this.auth=_s(e)}async verify(e="verify",t=!1){function n(t,n,r){const i=window.grecaptcha;$i(i)?i.enterprise.ready((()=>{i.enterprise.execute(t,{action:e}).then((e=>{n(e)})).catch((()=>{n("NO_RECAPTCHA")}))})):r(Error("No reCAPTCHA enterprise script loaded."))}return new Promise(((e,r)=>{(async function(e){if(!t){if(null==e.tenantId&&null!=e._agentRecaptchaConfig)return e._agentRecaptchaConfig.siteKey;if(null!=e.tenantId&&void 0!==e._tenantRecaptchaConfigs[e.tenantId])return e._tenantRecaptchaConfigs[e.tenantId].siteKey}return new Promise((async(t,n)=>{(async function(e,t){return Ci(e,"GET","/v2/recaptchaConfig",Pi(e,{clientType:"CLIENT_TYPE_WEB",version:"RECAPTCHA_ENTERPRISE"}))})(e).then((r=>{if(void 0!==r.recaptchaKey){const n=new Ui(r);return null==e.tenantId?e._agentRecaptchaConfig=n:e._tenantRecaptchaConfigs[e.tenantId]=n,t(n.siteKey)}n(new Error("recaptcha Enterprise site key undefined"))})).catch((e=>{n(e)}))}))})(this.auth).then((i=>{if(!t&&$i(window.grecaptcha))n(i,e,r);else{if("undefined"==typeof window)return void r(new Error("RecaptchaVerifier is only supported in browser"));let t=bs.recaptchaEnterpriseScript;0!==t.length&&(t+=i),Es(t).then((()=>{n(i,e,r)})).catch((e=>{r(e)}))}})).catch((e=>{r(e)}))}))}}async function Ts(e,t,n,r=!1){const i=new Ss(e);let s;try{s=await i.verify(n)}catch(e){s=await i.verify(n,!0)}const a=Object.assign({},t);return r?Object.assign(a,{captchaResp:s}):Object.assign(a,{captchaResponse:s}),Object.assign(a,{clientType:"CLIENT_TYPE_WEB"}),Object.assign(a,{recaptchaVersion:"RECAPTCHA_ENTERPRISE"}),a}async function Is(e,t,n,r){var i;if(null===(i=e._getRecaptchaConfig())||void 0===i?void 0:i.isProviderEnabled("EMAIL_PASSWORD_PROVIDER")){const i=await Ts(e,t,n,"getOobCode"===n);return r(e,i)}return r(e,t).catch((async i=>{if("auth/missing-recaptcha-token"===i.code){console.log(`${n} is protected by reCAPTCHA Enterprise for this project. Automatically triggering the reCAPTCHA flow and restarting the flow.`);const i=await Ts(e,t,n,"getOobCode"===n);return r(e,i)}return Promise.reject(i)}))}function Os(e){const t=e.indexOf(":");return t<0?"":e.substr(0,t+1)}function As(e){if(!e)return null;const t=Number(e);return isNaN(t)?null:t}class xs{constructor(e,t){this.providerId=e,this.signInMethod=t}toJSON(){return bi("not implemented")}_getIdTokenResponse(e){return bi("not implemented")}_linkToIdToken(e,t){return bi("not implemented")}_getReauthenticationResolver(e){return bi("not implemented")}}async function Ps(e,t){return Ci(e,"POST","/v1/accounts:signUp",t)}async function Cs(e,t){return Ri(e,"POST","/v1/accounts:signInWithPassword",Pi(e,t))}class Ns extends xs{constructor(e,t,n,r=null){super("password",n),this._email=e,this._password=t,this._tenantId=r}static _fromEmailAndPassword(e,t){return new Ns(e,t,"password")}static _fromEmailAndCode(e,t,n=null){return new Ns(e,t,"emailLink",n)}toJSON(){return{email:this._email,password:this._password,signInMethod:this.signInMethod,tenantId:this._tenantId}}static fromJSON(e){const t="string"==typeof e?JSON.parse(e):e;if((null==t?void 0:t.email)&&(null==t?void 0:t.password)){if("password"===t.signInMethod)return this._fromEmailAndPassword(t.email,t.password);if("emailLink"===t.signInMethod)return this._fromEmailAndCode(t.email,t.password,t.tenantId)}return null}async _getIdTokenResponse(e){switch(this.signInMethod){case"password":return Is(e,{returnSecureToken:!0,email:this._email,password:this._password,clientType:"CLIENT_TYPE_WEB"},"signInWithPassword",Cs);case"emailLink":return async function(e,t){return Ri(e,"POST","/v1/accounts:signInWithEmailLink",Pi(e,t))}(e,{email:this._email,oobCode:this._password});default:mi(e,"internal-error")}}async _linkToIdToken(e,t){switch(this.signInMethod){case"password":return Is(e,{idToken:t,returnSecureToken:!0,email:this._email,password:this._password,clientType:"CLIENT_TYPE_WEB"},"signUpPassword",Ps);case"emailLink":return async function(e,t){return Ri(e,"POST","/v1/accounts:signInWithEmailLink",Pi(e,t))}(e,{idToken:t,email:this._email,oobCode:this._password});default:mi(e,"internal-error")}}_getReauthenticationResolver(e){return this._getIdTokenResponse(e)}}async function Rs(e,t){return Ri(e,"POST","/v1/accounts:signInWithIdp",Pi(e,t))}class js extends xs{constructor(){super(...arguments),this.pendingToken=null}static _fromParams(e){const t=new js(e.providerId,e.signInMethod);return e.idToken||e.accessToken?(e.idToken&&(t.idToken=e.idToken),e.accessToken&&(t.accessToken=e.accessToken),e.nonce&&!e.pendingToken&&(t.nonce=e.nonce),e.pendingToken&&(t.pendingToken=e.pendingToken)):e.oauthToken&&e.oauthTokenSecret?(t.accessToken=e.oauthToken,t.secret=e.oauthTokenSecret):mi("argument-error"),t}toJSON(){return{idToken:this.idToken,accessToken:this.accessToken,secret:this.secret,nonce:this.nonce,pendingToken:this.pendingToken,providerId:this.providerId,signInMethod:this.signInMethod}}static fromJSON(e){const t="string"==typeof e?JSON.parse(e):e,{providerId:n,signInMethod:r}=t,i=li(t,["providerId","signInMethod"]);if(!n||!r)return null;const s=new js(n,r);return s.idToken=i.idToken||void 0,s.accessToken=i.accessToken||void 0,s.secret=i.secret,s.nonce=i.nonce,s.pendingToken=i.pendingToken||null,s}_getIdTokenResponse(e){return Rs(e,this.buildRequest())}_linkToIdToken(e,t){const n=this.buildRequest();return n.idToken=t,Rs(e,n)}_getReauthenticationResolver(e){const t=this.buildRequest();return t.autoCreate=!1,Rs(e,t)}buildRequest(){const e={requestUri:"http://localhost",returnSecureToken:!0};if(this.pendingToken)e.pendingToken=this.pendingToken;else{const t={};this.idToken&&(t.id_token=this.idToken),this.accessToken&&(t.access_token=this.accessToken),this.secret&&(t.oauth_token_secret=this.secret),t.providerId=this.providerId,this.nonce&&!this.pendingToken&&(t.nonce=this.nonce),e.postBody=Pn(t)}return e}}const Ls={USER_NOT_FOUND:"user-not-found"};class Ds extends xs{constructor(e){super("phone","phone"),this.params=e}static _fromVerification(e,t){return new Ds({verificationId:e,verificationCode:t})}static _fromTokenResponse(e,t){return new Ds({phoneNumber:e,temporaryProof:t})}_getIdTokenResponse(e){return async function(e,t){return Ri(e,"POST","/v1/accounts:signInWithPhoneNumber",Pi(e,t))}(e,this._makeVerificationRequest())}_linkToIdToken(e,t){return async function(e,t){const n=await Ri(e,"POST","/v1/accounts:signInWithPhoneNumber",Pi(e,t));if(n.temporaryProof)throw Mi(e,"account-exists-with-different-credential",n);return n}(e,Object.assign({idToken:t},this._makeVerificationRequest()))}_getReauthenticationResolver(e){return async function(e,t){return Ri(e,"POST","/v1/accounts:signInWithPhoneNumber",Pi(e,Object.assign(Object.assign({},t),{operation:"REAUTH"})),Ls)}(e,this._makeVerificationRequest())}_makeVerificationRequest(){const{temporaryProof:e,phoneNumber:t,verificationId:n,verificationCode:r}=this.params;return e&&t?{temporaryProof:e,phoneNumber:t}:{sessionInfo:n,code:r}}toJSON(){const e={providerId:this.providerId};return this.params.phoneNumber&&(e.phoneNumber=this.params.phoneNumber),this.params.temporaryProof&&(e.temporaryProof=this.params.temporaryProof),this.params.verificationCode&&(e.verificationCode=this.params.verificationCode),this.params.verificationId&&(e.verificationId=this.params.verificationId),e}static fromJSON(e){"string"==typeof e&&(e=JSON.parse(e));const{verificationId:t,verificationCode:n,phoneNumber:r,temporaryProof:i}=e;return n||t||r||i?new Ds({verificationId:t,verificationCode:n,phoneNumber:r,temporaryProof:i}):null}}class Ms{constructor(e){var t,n,r,i,s,a;const o=Cn(Nn(e)),c=null!==(t=o.apiKey)&&void 0!==t?t:null,u=null!==(n=o.oobCode)&&void 0!==n?n:null,l=function(e){switch(e){case"recoverEmail":return"RECOVER_EMAIL";case"resetPassword":return"PASSWORD_RESET";case"signIn":return"EMAIL_SIGNIN";case"verifyEmail":return"VERIFY_EMAIL";case"verifyAndChangeEmail":return"VERIFY_AND_CHANGE_EMAIL";case"revertSecondFactorAddition":return"REVERT_SECOND_FACTOR_ADDITION";default:return null}}(null!==(r=o.mode)&&void 0!==r?r:null);wi(c&&u&&l,"argument-error"),this.apiKey=c,this.operation=l,this.code=u,this.continueUrl=null!==(i=o.continueUrl)&&void 0!==i?i:null,this.languageCode=null!==(s=o.languageCode)&&void 0!==s?s:null,this.tenantId=null!==(a=o.tenantId)&&void 0!==a?a:null}static parseLink(e){const t=function(e){const t=Cn(Nn(e)).link,n=t?Cn(Nn(t)).deep_link_id:null,r=Cn(Nn(e)).deep_link_id;return(r?Cn(Nn(r)).link:null)||r||n||t||e}(e);try{return new Ms(t)}catch(e){return null}}}class $s{constructor(){this.providerId=$s.PROVIDER_ID}static credential(e,t){return Ns._fromEmailAndPassword(e,t)}static credentialWithLink(e,t){const n=Ms.parseLink(t);return wi(n,"argument-error"),Ns._fromEmailAndCode(e,n.code,n.tenantId)}}$s.PROVIDER_ID="password",$s.EMAIL_PASSWORD_SIGN_IN_METHOD="password",$s.EMAIL_LINK_SIGN_IN_METHOD="emailLink";class Us{constructor(e){this.providerId=e,this.defaultLanguageCode=null,this.customParameters={}}setDefaultLanguage(e){this.defaultLanguageCode=e}setCustomParameters(e){return this.customParameters=e,this}getCustomParameters(){return this.customParameters}}class Fs extends Us{constructor(){super(...arguments),this.scopes=[]}addScope(e){return this.scopes.includes(e)||this.scopes.push(e),this}getScopes(){return[...this.scopes]}}class Bs extends Fs{constructor(){super("facebook.com")}static credential(e){return js._fromParams({providerId:Bs.PROVIDER_ID,signInMethod:Bs.FACEBOOK_SIGN_IN_METHOD,accessToken:e})}static credentialFromResult(e){return Bs.credentialFromTaggedObject(e)}static credentialFromError(e){return Bs.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e||!("oauthAccessToken"in e))return null;if(!e.oauthAccessToken)return null;try{return Bs.credential(e.oauthAccessToken)}catch(e){return null}}}Bs.FACEBOOK_SIGN_IN_METHOD="facebook.com",Bs.PROVIDER_ID="facebook.com";class Vs extends Fs{constructor(){super("google.com"),this.addScope("profile")}static credential(e,t){return js._fromParams({providerId:Vs.PROVIDER_ID,signInMethod:Vs.GOOGLE_SIGN_IN_METHOD,idToken:e,accessToken:t})}static credentialFromResult(e){return Vs.credentialFromTaggedObject(e)}static credentialFromError(e){return Vs.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;const{oauthIdToken:t,oauthAccessToken:n}=e;if(!t&&!n)return null;try{return Vs.credential(t,n)}catch(e){return null}}}Vs.GOOGLE_SIGN_IN_METHOD="google.com",Vs.PROVIDER_ID="google.com";class zs extends Fs{constructor(){super("github.com")}static credential(e){return js._fromParams({providerId:zs.PROVIDER_ID,signInMethod:zs.GITHUB_SIGN_IN_METHOD,accessToken:e})}static credentialFromResult(e){return zs.credentialFromTaggedObject(e)}static credentialFromError(e){return zs.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e||!("oauthAccessToken"in e))return null;if(!e.oauthAccessToken)return null;try{return zs.credential(e.oauthAccessToken)}catch(e){return null}}}zs.GITHUB_SIGN_IN_METHOD="github.com",zs.PROVIDER_ID="github.com";class qs extends Fs{constructor(){super("twitter.com")}static credential(e,t){return js._fromParams({providerId:qs.PROVIDER_ID,signInMethod:qs.TWITTER_SIGN_IN_METHOD,oauthToken:e,oauthTokenSecret:t})}static credentialFromResult(e){return qs.credentialFromTaggedObject(e)}static credentialFromError(e){return qs.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;const{oauthAccessToken:t,oauthTokenSecret:n}=e;if(!t||!n)return null;try{return qs.credential(t,n)}catch(e){return null}}}qs.TWITTER_SIGN_IN_METHOD="twitter.com",qs.PROVIDER_ID="twitter.com";class Hs{constructor(e){this.user=e.user,this.providerId=e.providerId,this._tokenResponse=e._tokenResponse,this.operationType=e.operationType}static async _fromIdTokenResponse(e,t,n,r=!1){const i=await Xi._fromIdTokenResponse(e,n,r),s=Ks(n);return new Hs({user:i,providerId:s,_tokenResponse:n,operationType:t})}static async _forOperation(e,t,n){await e._updateTokensIfNecessary(n,!0);const r=Ks(n);return new Hs({user:e,providerId:r,_tokenResponse:n,operationType:t})}}function Ks(e){return e.providerId?e.providerId:"phoneNumber"in e?"phone":null}class Ws extends Tn{constructor(e,t,n,r){var i;super(t.code,t.message),this.operationType=n,this.user=r,Object.setPrototypeOf(this,Ws.prototype),this.customData={appName:e.name,tenantId:null!==(i=e.tenantId)&&void 0!==i?i:void 0,_serverResponse:t.customData._serverResponse,operationType:n}}static _fromErrorAndOperation(e,t,n,r){return new Ws(e,t,n,r)}}function Gs(e,t,n,r){return("reauthenticate"===t?n._getReauthenticationResolver(e):n._getIdTokenResponse(e)).catch((n=>{if("auth/multi-factor-auth-required"===n.code)throw Ws._fromErrorAndOperation(e,n,t,r);throw n}))}new WeakMap;const Zs="__sak";class Js{constructor(e,t){this.storageRetriever=e,this.type=t}_isAvailable(){try{return this.storage?(this.storage.setItem(Zs,"1"),this.storage.removeItem(Zs),Promise.resolve(!0)):Promise.resolve(!1)}catch(e){return Promise.resolve(!1)}}_set(e,t){return this.storage.setItem(e,JSON.stringify(t)),Promise.resolve()}_get(e){const t=this.storage.getItem(e);return Promise.resolve(t?JSON.parse(t):null)}_remove(e){return this.storage.removeItem(e),Promise.resolve()}get storage(){return this.storageRetriever()}}class Qs extends Js{constructor(){super((()=>window.localStorage),"LOCAL"),this.boundEventHandler=(e,t)=>this.onStorageEvent(e,t),this.listeners={},this.localCache={},this.pollTimer=null,this.safariLocalStorageNotSynced=function(){const e=Sn();return os(e)||fs(e)}()&&function(){try{return!(!window||window===window.top)}catch(e){return!1}}(),this.fallbackToPolling=ps(),this._shouldAllowMigration=!0}forAllChangedKeys(e){for(const t of Object.keys(this.listeners)){const n=this.storage.getItem(t),r=this.localCache[t];n!==r&&e(t,r,n)}}onStorageEvent(e,t=!1){if(!e.key)return void this.forAllChangedKeys(((e,t,n)=>{this.notifyListeners(e,n)}));const n=e.key;if(t?this.detachListener():this.stopPolling(),this.safariLocalStorageNotSynced){const r=this.storage.getItem(n);if(e.newValue!==r)null!==e.newValue?this.storage.setItem(n,e.newValue):this.storage.removeItem(n);else if(this.localCache[n]===e.newValue&&!t)return}const r=()=>{const e=this.storage.getItem(n);(t||this.localCache[n]!==e)&&this.notifyListeners(n,e)},i=this.storage.getItem(n);!function(){const e=Sn();return e.indexOf("MSIE ")>=0||e.indexOf("Trident/")>=0}()||10!==document.documentMode||i===e.newValue||e.newValue===e.oldValue?r():setTimeout(r,10)}notifyListeners(e,t){this.localCache[e]=t;const n=this.listeners[e];if(n)for(const e of Array.from(n))e(t?JSON.parse(t):t)}startPolling(){this.stopPolling(),this.pollTimer=setInterval((()=>{this.forAllChangedKeys(((e,t,n)=>{this.onStorageEvent(new StorageEvent("storage",{key:e,oldValue:t,newValue:n}),!0)}))}),1e3)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}attachListener(){window.addEventListener("storage",this.boundEventHandler)}detachListener(){window.removeEventListener("storage",this.boundEventHandler)}_addListener(e,t){0===Object.keys(this.listeners).length&&(this.fallbackToPolling?this.startPolling():this.attachListener()),this.listeners[e]||(this.listeners[e]=new Set,this.localCache[e]=this.storage.getItem(e)),this.listeners[e].add(t)}_removeListener(e,t){this.listeners[e]&&(this.listeners[e].delete(t),0===this.listeners[e].size&&delete this.listeners[e]),0===Object.keys(this.listeners).length&&(this.detachListener(),this.stopPolling())}async _set(e,t){await super._set(e,t),this.localCache[e]=JSON.stringify(t)}async _get(e){const t=await super._get(e);return this.localCache[e]=JSON.stringify(t),t}async _remove(e){await super._remove(e),delete this.localCache[e]}}Qs.type="LOCAL";const Xs=Qs;class Ys extends Js{constructor(){super((()=>window.sessionStorage),"SESSION")}_addListener(e,t){}_removeListener(e,t){}}Ys.type="SESSION";const ea=Ys;class ta{constructor(e){this.eventTarget=e,this.handlersMap={},this.boundEventHandler=this.handleEvent.bind(this)}static _getInstance(e){const t=this.receivers.find((t=>t.isListeningto(e)));if(t)return t;const n=new ta(e);return this.receivers.push(n),n}isListeningto(e){return this.eventTarget===e}async handleEvent(e){const t=e,{eventId:n,eventType:r,data:i}=t.data,s=this.handlersMap[r];if(!(null==s?void 0:s.size))return;t.ports[0].postMessage({status:"ack",eventId:n,eventType:r});const a=Array.from(s).map((async e=>e(t.origin,i))),o=await function(e){return Promise.all(e.map((async e=>{try{return{fulfilled:!0,value:await e}}catch(e){return{fulfilled:!1,reason:e}}})))}(a);t.ports[0].postMessage({status:"done",eventId:n,eventType:r,response:o})}_subscribe(e,t){0===Object.keys(this.handlersMap).length&&this.eventTarget.addEventListener("message",this.boundEventHandler),this.handlersMap[e]||(this.handlersMap[e]=new Set),this.handlersMap[e].add(t)}_unsubscribe(e,t){this.handlersMap[e]&&t&&this.handlersMap[e].delete(t),t&&0!==this.handlersMap[e].size||delete this.handlersMap[e],0===Object.keys(this.handlersMap).length&&this.eventTarget.removeEventListener("message",this.boundEventHandler)}}function na(e="",t=10){let n="";for(let e=0;e<t;e++)n+=Math.floor(10*Math.random());return e+n}ta.receivers=[];class ra{constructor(e){this.target=e,this.handlers=new Set}removeMessageHandler(e){e.messageChannel&&(e.messageChannel.port1.removeEventListener("message",e.onMessage),e.messageChannel.port1.close()),this.handlers.delete(e)}async _send(e,t,n=50){const r="undefined"!=typeof MessageChannel?new MessageChannel:null;if(!r)throw new Error("connection_unavailable");let i,s;return new Promise(((a,o)=>{const c=na("",20);r.port1.start();const u=setTimeout((()=>{o(new Error("unsupported_event"))}),n);s={messageChannel:r,onMessage(e){const t=e;if(t.data.eventId===c)switch(t.data.status){case"ack":clearTimeout(u),i=setTimeout((()=>{o(new Error("timeout"))}),3e3);break;case"done":clearTimeout(i),a(t.data.response);break;default:clearTimeout(u),clearTimeout(i),o(new Error("invalid_response"))}}},this.handlers.add(s),r.port1.addEventListener("message",s.onMessage),this.target.postMessage({eventType:e,eventId:c,data:t},[r.port2])})).finally((()=>{s&&this.removeMessageHandler(s)}))}}function ia(){return window}function sa(){return void 0!==ia().WorkerGlobalScope&&"function"==typeof ia().importScripts}const aa="firebaseLocalStorageDb",oa="firebaseLocalStorage",ca="fbase_key";class ua{constructor(e){this.request=e}toPromise(){return new Promise(((e,t)=>{this.request.addEventListener("success",(()=>{e(this.request.result)})),this.request.addEventListener("error",(()=>{t(this.request.error)}))}))}}function la(e,t){return e.transaction([oa],t?"readwrite":"readonly").objectStore(oa)}function ha(){const e=indexedDB.open(aa,1);return new Promise(((t,n)=>{e.addEventListener("error",(()=>{n(e.error)})),e.addEventListener("upgradeneeded",(()=>{const t=e.result;try{t.createObjectStore(oa,{keyPath:ca})}catch(e){n(e)}})),e.addEventListener("success",(async()=>{const n=e.result;n.objectStoreNames.contains(oa)?t(n):(n.close(),await function(){const e=indexedDB.deleteDatabase(aa);return new ua(e).toPromise()}(),t(await ha()))}))}))}async function da(e,t,n){const r=la(e,!0).put({[ca]:t,value:n});return new ua(r).toPromise()}function fa(e,t){const n=la(e,!0).delete(t);return new ua(n).toPromise()}class pa{constructor(){this.type="LOCAL",this._shouldAllowMigration=!0,this.listeners={},this.localCache={},this.pollTimer=null,this.pendingWrites=0,this.receiver=null,this.sender=null,this.serviceWorkerReceiverAvailable=!1,this.activeServiceWorker=null,this._workerInitializationPromise=this.initializeServiceWorkerMessaging().then((()=>{}),(()=>{}))}async _openDb(){return this.db||(this.db=await ha()),this.db}async _withRetries(e){let t=0;for(;;)try{const t=await this._openDb();return await e(t)}catch(e){if(t++>3)throw e;this.db&&(this.db.close(),this.db=void 0)}}async initializeServiceWorkerMessaging(){return sa()?this.initializeReceiver():this.initializeSender()}async initializeReceiver(){this.receiver=ta._getInstance(sa()?self:null),this.receiver._subscribe("keyChanged",(async(e,t)=>({keyProcessed:(await this._poll()).includes(t.key)}))),this.receiver._subscribe("ping",(async(e,t)=>["keyChanged"]))}async initializeSender(){var e,t;if(this.activeServiceWorker=await async function(){if(!(null===navigator||void 0===navigator?void 0:navigator.serviceWorker))return null;try{return(await navigator.serviceWorker.ready).active}catch(e){return null}}(),!this.activeServiceWorker)return;this.sender=new ra(this.activeServiceWorker);const n=await this.sender._send("ping",{},800);n&&(null===(e=n[0])||void 0===e?void 0:e.fulfilled)&&(null===(t=n[0])||void 0===t?void 0:t.value.includes("keyChanged"))&&(this.serviceWorkerReceiverAvailable=!0)}async notifyServiceWorker(e){var t;if(this.sender&&this.activeServiceWorker&&((null===(t=null===navigator||void 0===navigator?void 0:navigator.serviceWorker)||void 0===t?void 0:t.controller)||null)===this.activeServiceWorker)try{await this.sender._send("keyChanged",{key:e},this.serviceWorkerReceiverAvailable?800:50)}catch(t){}}async _isAvailable(){try{if(!indexedDB)return!1;const e=await ha();return await da(e,Zs,"1"),await fa(e,Zs),!0}catch(e){}return!1}async _withPendingWrite(e){this.pendingWrites++;try{await e()}finally{this.pendingWrites--}}async _set(e,t){return this._withPendingWrite((async()=>(await this._withRetries((n=>da(n,e,t))),this.localCache[e]=t,this.notifyServiceWorker(e))))}async _get(e){const t=await this._withRetries((t=>async function(e,t){const n=la(e,!1).get(t),r=await new ua(n).toPromise();return void 0===r?null:r.value}(t,e)));return this.localCache[e]=t,t}async _remove(e){return this._withPendingWrite((async()=>(await this._withRetries((t=>fa(t,e))),delete this.localCache[e],this.notifyServiceWorker(e))))}async _poll(){const e=await this._withRetries((e=>{const t=la(e,!1).getAll();return new ua(t).toPromise()}));if(!e)return[];if(0!==this.pendingWrites)return[];const t=[],n=new Set;if(0!==e.length)for(const{fbase_key:r,value:i}of e)n.add(r),JSON.stringify(this.localCache[r])!==JSON.stringify(i)&&(this.notifyListeners(r,i),t.push(r));for(const e of Object.keys(this.localCache))this.localCache[e]&&!n.has(e)&&(this.notifyListeners(e,null),t.push(e));return t}notifyListeners(e,t){this.localCache[e]=t;const n=this.listeners[e];if(n)for(const e of Array.from(n))e(t)}startPolling(){this.stopPolling(),this.pollTimer=setInterval((async()=>this._poll()),800)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}_addListener(e,t){0===Object.keys(this.listeners).length&&this.startPolling(),this.listeners[e]||(this.listeners[e]=new Set,this._get(e)),this.listeners[e].add(t)}_removeListener(e,t){this.listeners[e]&&(this.listeners[e].delete(t),0===this.listeners[e].size&&delete this.listeners[e]),0===Object.keys(this.listeners).length&&this.stopPolling()}}pa.type="LOCAL";const ma=pa;ks("rcb"),new Ti(3e4,6e4);class ga{constructor(e){this.providerId=ga.PROVIDER_ID,this.auth=_s(e)}verifyPhoneNumber(e,t){return async function(e,t,n){var r;const i=await n.verify();try{let s;if(wi("string"==typeof i,e,"argument-error"),wi("recaptcha"===n.type,e,"argument-error"),s="string"==typeof t?{phoneNumber:t}:t,"session"in s){const t=s.session;if("phoneNumber"in s){wi("enroll"===t.type,e,"internal-error");const n=await function(e,t){return Ci(e,"POST","/v2/accounts/mfaEnrollment:start",Pi(e,t))}(e,{idToken:t.credential,phoneEnrollmentInfo:{phoneNumber:s.phoneNumber,recaptchaToken:i}});return n.phoneSessionInfo.sessionInfo}{wi("signin"===t.type,e,"internal-error");const n=(null===(r=s.multiFactorHint)||void 0===r?void 0:r.uid)||s.multiFactorUid;wi(n,e,"missing-multi-factor-info");const a=await function(e,t){return Ci(e,"POST","/v2/accounts/mfaSignIn:start",Pi(e,t))}(e,{mfaPendingCredential:t.credential,mfaEnrollmentId:n,phoneSignInInfo:{recaptchaToken:i}});return a.phoneResponseInfo.sessionInfo}}{const{sessionInfo:t}=await async function(e,t){return Ci(e,"POST","/v1/accounts:sendVerificationCode",Pi(e,t))}(e,{phoneNumber:s.phoneNumber,recaptchaToken:i});return t}}finally{n._reset()}}(this.auth,e,Ln(t))}static credential(e,t){return Ds._fromVerification(e,t)}static credentialFromResult(e){const t=e;return ga.credentialFromTaggedObject(t)}static credentialFromError(e){return ga.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;const{phoneNumber:t,temporaryProof:n}=e;return t&&n?Ds._fromTokenResponse(t,n):null}}function ya(e,t){return t?es(t):(wi(e._popupRedirectResolver,e,"argument-error"),e._popupRedirectResolver)}ga.PROVIDER_ID="phone",ga.PHONE_SIGN_IN_METHOD="phone";class va extends xs{constructor(e){super("custom","custom"),this.params=e}_getIdTokenResponse(e){return Rs(e,this._buildIdpRequest())}_linkToIdToken(e,t){return Rs(e,this._buildIdpRequest(t))}_getReauthenticationResolver(e){return Rs(e,this._buildIdpRequest())}_buildIdpRequest(e){const t={requestUri:this.params.requestUri,sessionId:this.params.sessionId,postBody:this.params.postBody,tenantId:this.params.tenantId,pendingToken:this.params.pendingToken,returnSecureToken:!0,returnIdpCredential:!0};return e&&(t.idToken=e),t}}function _a(e){return async function(e,t,n=!1){if(Kr(e.app))return Promise.reject(vi(e));const r="signIn",i=await Gs(e,r,t),s=await Hs._fromIdTokenResponse(e,r,i);return n||await e._updateCurrentUser(s.user),s}(e.auth,new va(e),e.bypassAuthState)}function wa(e){const{auth:t,user:n}=e;return wi(n,t,"internal-error"),async function(e,t,n=!1){const{auth:r}=e;if(Kr(r.app))return Promise.reject(vi(r));const i="reauthenticate";try{const s=await Hi(e,Gs(r,i,t,e),n);wi(s.idToken,r,"internal-error");const a=zi(s.idToken);wi(a,r,"internal-error");const{sub:o}=a;return wi(e.uid===o,r,"user-mismatch"),Hs._forOperation(e,i,s)}catch(e){throw"auth/user-not-found"===(null==e?void 0:e.code)&&mi(r,"user-mismatch"),e}}(n,new va(e),e.bypassAuthState)}async function ba(e){const{auth:t,user:n}=e;return wi(n,t,"internal-error"),async function(e,t,n=!1){const r=await Hi(e,t._linkToIdToken(e.auth,await e.getIdToken()),n);return Hs._forOperation(e,"link",r)}(n,new va(e),e.bypassAuthState)}class Ea{constructor(e,t,n,r,i=!1){this.auth=e,this.resolver=n,this.user=r,this.bypassAuthState=i,this.pendingPromise=null,this.eventManager=null,this.filter=Array.isArray(t)?t:[t]}execute(){return new Promise((async(e,t)=>{this.pendingPromise={resolve:e,reject:t};try{this.eventManager=await this.resolver._initialize(this.auth),await this.onExecution(),this.eventManager.registerConsumer(this)}catch(e){this.reject(e)}}))}async onAuthEvent(e){const{urlResponse:t,sessionId:n,postBody:r,tenantId:i,error:s,type:a}=e;if(s)return void this.reject(s);const o={auth:this.auth,requestUri:t,sessionId:n,tenantId:i||void 0,postBody:r||void 0,user:this.user,bypassAuthState:this.bypassAuthState};try{this.resolve(await this.getIdpTask(a)(o))}catch(e){this.reject(e)}}onError(e){this.reject(e)}getIdpTask(e){switch(e){case"signInViaPopup":case"signInViaRedirect":return _a;case"linkViaPopup":case"linkViaRedirect":return ba;case"reauthViaPopup":case"reauthViaRedirect":return wa;default:mi(this.auth,"internal-error")}}resolve(e){Ei(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.resolve(e),this.unregisterAndCleanUp()}reject(e){Ei(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.reject(e),this.unregisterAndCleanUp()}unregisterAndCleanUp(){this.eventManager&&this.eventManager.unregisterConsumer(this),this.pendingPromise=null,this.cleanUp()}}const ka=new Ti(2e3,1e4);class Sa extends Ea{constructor(e,t,n,r,i){super(e,t,r,i),this.provider=n,this.authWindow=null,this.pollId=null,Sa.currentPopupAction&&Sa.currentPopupAction.cancel(),Sa.currentPopupAction=this}async executeNotNull(){const e=await this.execute();return wi(e,this.auth,"internal-error"),e}async onExecution(){Ei(1===this.filter.length,"Popup operations only handle one event");const e=na();this.authWindow=await this.resolver._openPopup(this.auth,this.provider,this.filter[0],e),this.authWindow.associatedEvent=e,this.resolver._originValidation(this.auth).catch((e=>{this.reject(e)})),this.resolver._isIframeWebStorageSupported(this.auth,(e=>{e||this.reject(gi(this.auth,"web-storage-unsupported"))})),this.pollUserCancellation()}get eventId(){var e;return(null===(e=this.authWindow)||void 0===e?void 0:e.associatedEvent)||null}cancel(){this.reject(gi(this.auth,"cancelled-popup-request"))}cleanUp(){this.authWindow&&this.authWindow.close(),this.pollId&&window.clearTimeout(this.pollId),this.authWindow=null,this.pollId=null,Sa.currentPopupAction=null}pollUserCancellation(){const e=()=>{var t,n;(null===(n=null===(t=this.authWindow)||void 0===t?void 0:t.window)||void 0===n?void 0:n.closed)?this.pollId=window.setTimeout((()=>{this.pollId=null,this.reject(gi(this.auth,"popup-closed-by-user"))}),8e3):this.pollId=window.setTimeout(e,ka.get())};e()}}Sa.currentPopupAction=null;const Ta="pendingRedirect",Ia=new Map;class Oa extends Ea{constructor(e,t,n=!1){super(e,["signInViaRedirect","linkViaRedirect","reauthViaRedirect","unknown"],t,void 0,n),this.eventId=null}async execute(){let e=Ia.get(this.auth._key());if(!e){try{const t=await async function(e,t){const n=Pa(t),r=xa(e);if(!await r._isAvailable())return!1;const i="true"===await r._get(n);return await r._remove(n),i}(this.resolver,this.auth)?await super.execute():null;e=()=>Promise.resolve(t)}catch(t){e=()=>Promise.reject(t)}Ia.set(this.auth._key(),e)}return this.bypassAuthState||Ia.set(this.auth._key(),(()=>Promise.resolve(null))),e()}async onAuthEvent(e){if("signInViaRedirect"===e.type)return super.onAuthEvent(e);if("unknown"!==e.type){if(e.eventId){const t=await this.auth._redirectUserForId(e.eventId);if(t)return this.user=t,super.onAuthEvent(e);this.resolve(null)}}else this.resolve(null)}async onExecution(){}cleanUp(){}}function Aa(e,t){Ia.set(e._key(),t)}function xa(e){return es(e._redirectPersistence)}function Pa(e){return rs(Ta,e.config.apiKey,e.name)}function Ca(e,t,n){return async function(e,t,n){if(Kr(e.app))return Promise.reject(vi(e));const r=_s(e);(function(e,t,n){if(!(t instanceof n))throw n.name!==t.constructor.name&&mi(e,"argument-error"),yi(e,"argument-error",`Type of ${t.constructor.name} does not match expected instance.Did you pass a reference from a different Auth SDK?`)})(e,t,Us),await r._initializationPromise;const i=ya(r,n);return await async function(e,t){return xa(e)._set(Pa(t),"true")}(i,r),i._openRedirect(r,t,"signInViaRedirect")}(e,t,n)}async function Na(e,t,n=!1){if(Kr(e.app))return Promise.reject(vi(e));const r=_s(e),i=ya(r,t),s=new Oa(r,i,n),a=await s.execute();return a&&!n&&(delete a.user._redirectEventId,await r._persistUserIfCurrent(a.user),await r._setRedirectUser(null,t)),a}class Ra{constructor(e){this.auth=e,this.cachedEventUids=new Set,this.consumers=new Set,this.queuedRedirectEvent=null,this.hasHandledPotentialRedirect=!1,this.lastProcessedEventTime=Date.now()}registerConsumer(e){this.consumers.add(e),this.queuedRedirectEvent&&this.isEventForConsumer(this.queuedRedirectEvent,e)&&(this.sendToConsumer(this.queuedRedirectEvent,e),this.saveEventToCache(this.queuedRedirectEvent),this.queuedRedirectEvent=null)}unregisterConsumer(e){this.consumers.delete(e)}onEvent(e){if(this.hasEventBeenHandled(e))return!1;let t=!1;return this.consumers.forEach((n=>{this.isEventForConsumer(e,n)&&(t=!0,this.sendToConsumer(e,n),this.saveEventToCache(e))})),this.hasHandledPotentialRedirect||!function(e){switch(e.type){case"signInViaRedirect":case"linkViaRedirect":case"reauthViaRedirect":return!0;case"unknown":return La(e);default:return!1}}(e)||(this.hasHandledPotentialRedirect=!0,t||(this.queuedRedirectEvent=e,t=!0)),t}sendToConsumer(e,t){var n;if(e.error&&!La(e)){const r=(null===(n=e.error.code)||void 0===n?void 0:n.split("auth/")[1])||"internal-error";t.onError(gi(this.auth,r))}else t.onAuthEvent(e)}isEventForConsumer(e,t){const n=null===t.eventId||!!e.eventId&&e.eventId===t.eventId;return t.filter.includes(e.type)&&n}hasEventBeenHandled(e){return Date.now()-this.lastProcessedEventTime>=6e5&&this.cachedEventUids.clear(),this.cachedEventUids.has(ja(e))}saveEventToCache(e){this.cachedEventUids.add(ja(e)),this.lastProcessedEventTime=Date.now()}}function ja(e){return[e.type,e.eventId,e.sessionId,e.tenantId].filter((e=>e)).join("-")}function La({type:e,error:t}){return"unknown"===e&&"auth/no-auth-event"===(null==t?void 0:t.code)}const Da=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,Ma=/^https?/;function $a(e){const t=ki(),{protocol:n,hostname:r}=new URL(t);if(e.startsWith("chrome-extension://")){const i=new URL(e);return""===i.hostname&&""===r?"chrome-extension:"===n&&e.replace("chrome-extension://","")===t.replace("chrome-extension://",""):"chrome-extension:"===n&&i.hostname===r}if(!Ma.test(n))return!1;if(Da.test(e))return r===e;const i=e.replace(/\./g,"\\.");return new RegExp("^(.+\\."+i+"|"+i+")$","i").test(r)}const Ua=new Ti(3e4,6e4);function Fa(){const e=ia().___jsl;if(null==e?void 0:e.H)for(const t of Object.keys(e.H))if(e.H[t].r=e.H[t].r||[],e.H[t].L=e.H[t].L||[],e.H[t].r=[...e.H[t].L],e.CP)for(let t=0;t<e.CP.length;t++)e.CP[t]=null}let Ba=null;const Va=new Ti(5e3,15e3),za={style:{position:"absolute",top:"-100px",width:"1px",height:"1px"},"aria-hidden":"true",tabindex:"-1"},qa=new Map([["identitytoolkit.googleapis.com","p"],["staging-identitytoolkit.sandbox.googleapis.com","s"],["test-identitytoolkit.sandbox.googleapis.com","t"]]);function Ha(e){const t=e.config;wi(t.authDomain,e,"auth-domain-config-required");const n=t.emulator?Ii(t,"emulator/auth/iframe"):`https://${e.config.authDomain}/__/auth/iframe`,r={apiKey:t.apiKey,appName:e.name,v:Zr},i=qa.get(e.config.apiHost);i&&(r.eid=i);const s=e._getFrameworks();return s.length&&(r.fw=s.join(",")),`${n}?${Pn(r).slice(1)}`}const Ka={location:"yes",resizable:"yes",statusbar:"yes",toolbar:"no"};class Wa{constructor(e){this.window=e,this.associatedEvent=null}close(){if(this.window)try{this.window.close()}catch(e){}}}const Ga=encodeURIComponent("fac");async function Za(e,t,n,r,i,s){wi(e.config.authDomain,e,"auth-domain-config-required"),wi(e.config.apiKey,e,"invalid-api-key");const a={apiKey:e.config.apiKey,appName:e.name,authType:n,redirectUrl:r,v:Zr,eventId:i};if(t instanceof Us){t.setDefaultLanguage(e.languageCode),a.providerId=t.providerId||"",function(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}(t.getCustomParameters())||(a.customParameters=JSON.stringify(t.getCustomParameters()));for(const[e,t]of Object.entries(s||{}))a[e]=t}if(t instanceof Fs){const e=t.getScopes().filter((e=>""!==e));e.length>0&&(a.scopes=e.join(","))}e.tenantId&&(a.tid=e.tenantId);const o=a;for(const e of Object.keys(o))void 0===o[e]&&delete o[e];const c=await e._getAppCheckToken(),u=c?`#${Ga}=${encodeURIComponent(c)}`:"";return`${function({config:e}){return e.emulator?Ii(e,"emulator/auth/handler"):`https://${e.authDomain}/__/auth/handler`}(e)}?${Pn(o).slice(1)}${u}`}const Ja="webStorageSupport",Qa=class{constructor(){this.eventManagers={},this.iframes={},this.originValidationPromises={},this._redirectPersistence=ea,this._completeRedirectFn=Na,this._overrideRedirectResult=Aa}async _openPopup(e,t,n,r){var i;return Ei(null===(i=this.eventManagers[e._key()])||void 0===i?void 0:i.manager,"_initialize() not called before _openPopup()"),function(e,t,n,r=500,i=600){const s=Math.max((window.screen.availHeight-i)/2,0).toString(),a=Math.max((window.screen.availWidth-r)/2,0).toString();let o="";const c=Object.assign(Object.assign({},Ka),{width:r.toString(),height:i.toString(),top:s,left:a}),u=Sn().toLowerCase();n&&(o=cs(u)?"_blank":n),as(u)&&(t=t||"http://localhost",c.scrollbars="yes");const l=Object.entries(c).reduce(((e,[t,n])=>`${e}${t}=${n},`),"");if(function(e=Sn()){var t;return fs(e)&&!!(null===(t=window.navigator)||void 0===t?void 0:t.standalone)}(u)&&"_self"!==o)return function(e,t){const n=document.createElement("a");n.href=e,n.target=t;const r=document.createEvent("MouseEvent");r.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,1,null),n.dispatchEvent(r)}(t||"",o),new Wa(null);const h=window.open(t||"",o,l);wi(h,e,"popup-blocked");try{h.focus()}catch(e){}return new Wa(h)}(e,await Za(e,t,n,ki(),r),na())}async _openRedirect(e,t,n,r){return await this._originValidation(e),i=await Za(e,t,n,ki(),r),ia().location.href=i,new Promise((()=>{}));var i}_initialize(e){const t=e._key();if(this.eventManagers[t]){const{manager:e,promise:n}=this.eventManagers[t];return e?Promise.resolve(e):(Ei(n,"If manager is not set, promise should be"),n)}const n=this.initAndGetManager(e);return this.eventManagers[t]={promise:n},n.catch((()=>{delete this.eventManagers[t]})),n}async initAndGetManager(e){const t=await async function(e){const t=await function(e){return Ba=Ba||function(e){return new Promise(((t,n)=>{var r,i,s;function a(){Fa(),gapi.load("gapi.iframes",{callback:()=>{t(gapi.iframes.getContext())},ontimeout:()=>{Fa(),n(gi(e,"network-request-failed"))},timeout:Ua.get()})}if(null===(i=null===(r=ia().gapi)||void 0===r?void 0:r.iframes)||void 0===i?void 0:i.Iframe)t(gapi.iframes.getContext());else{if(!(null===(s=ia().gapi)||void 0===s?void 0:s.load)){const t=ks("iframefcb");return ia()[t]=()=>{gapi.load?a():n(gi(e,"network-request-failed"))},Es(`${bs.gapiScript}?onload=${t}`).catch((e=>n(e)))}a()}})).catch((e=>{throw Ba=null,e}))}(e),Ba}(e),n=ia().gapi;return wi(n,e,"internal-error"),t.open({where:document.body,url:Ha(e),messageHandlersFilter:n.iframes.CROSS_ORIGIN_IFRAMES_FILTER,attributes:za,dontclear:!0},(t=>new Promise((async(n,r)=>{await t.restyle({setHideOnLeave:!1});const i=gi(e,"network-request-failed"),s=ia().setTimeout((()=>{r(i)}),Va.get());function a(){ia().clearTimeout(s),n(t)}t.ping(a).then(a,(()=>{r(i)}))}))))}(e),n=new Ra(e);return t.register("authEvent",(t=>(wi(null==t?void 0:t.authEvent,e,"invalid-auth-event"),{status:n.onEvent(t.authEvent)?"ACK":"ERROR"})),gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER),this.eventManagers[e._key()]={manager:n},this.iframes[e._key()]=t,n}_isIframeWebStorageSupported(e,t){this.iframes[e._key()].send(Ja,{type:Ja},(n=>{var r;const i=null===(r=null==n?void 0:n[0])||void 0===r?void 0:r[Ja];void 0!==i&&t(!!i),mi(e,"internal-error")}),gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER)}_originValidation(e){const t=e._key();return this.originValidationPromises[t]||(this.originValidationPromises[t]=async function(e){if(e.config.emulator)return;const{authorizedDomains:t}=await async function(e,t={}){return Ci(e,"GET","/v1/projects",t)}(e);for(const n of t)try{if($a(n))return}catch(e){}mi(e,"unauthorized-domain")}(e)),this.originValidationPromises[t]}get _shouldInitProactively(){return ps()||os()||fs()}};var Xa="@firebase/auth",Ya="1.7.5";class eo{constructor(e){this.auth=e,this.internalListeners=new Map}getUid(){var e;return this.assertAuthConfigured(),(null===(e=this.auth.currentUser)||void 0===e?void 0:e.uid)||null}async getToken(e){return this.assertAuthConfigured(),await this.auth._initializationPromise,this.auth.currentUser?{accessToken:await this.auth.currentUser.getIdToken(e)}:null}addAuthTokenListener(e){if(this.assertAuthConfigured(),this.internalListeners.has(e))return;const t=this.auth.onIdTokenChanged((t=>{e((null==t?void 0:t.stsTokenManager.accessToken)||null)}));this.internalListeners.set(e,t),this.updateProactiveRefresh()}removeAuthTokenListener(e){this.assertAuthConfigured();const t=this.internalListeners.get(e);t&&(this.internalListeners.delete(e),t(),this.updateProactiveRefresh())}assertAuthConfigured(){wi(this.auth._initializationPromise,"dependent-sdk-initialized-before-auth")}updateProactiveRefresh(){this.internalListeners.size>0?this.auth._startProactiveRefresh():this.auth._stopProactiveRefresh()}}const to=En("authIdTokenMaxAge")||300;let no=null;const ro=e=>async t=>{const n=t&&await t.getIdTokenResult(),r=n&&((new Date).getTime()-Date.parse(n.issuedAtTime))/1e3;if(r&&r>to)return;const i=null==n?void 0:n.token;no!==i&&(no=i,await fetch(e,{method:i?"POST":"DELETE",headers:i?{Authorization:`Bearer ${i}`}:{}}))};var io,so;io={loadJS:e=>new Promise(((t,n)=>{const r=document.createElement("script");var i,s;r.setAttribute("src",e),r.onload=t,r.onerror=e=>{const t=gi("internal-error");t.customData=e,n(t)},r.type="text/javascript",r.charset="UTF-8",(null!==(s=null===(i=document.getElementsByTagName("head"))||void 0===i?void 0:i[0])&&void 0!==s?s:document).appendChild(r)})),gapiScript:"https://apis.google.com/js/api.js",recaptchaV2Script:"https://www.google.com/recaptcha/api.js",recaptchaEnterpriseScript:"https://www.google.com/recaptcha/enterprise.js?render="},bs=io,so="Browser",qr(new Dn("auth",((e,{options:t})=>{const n=e.getProvider("app").getImmediate(),r=e.getProvider("heartbeat"),i=e.getProvider("app-check-internal"),{apiKey:s,authDomain:a}=n.options;wi(s&&!s.includes(":"),"invalid-api-key",{appName:n.name});const o={apiKey:s,authDomain:a,clientPlatform:so,apiHost:"identitytoolkit.googleapis.com",tokenApiHost:"securetoken.googleapis.com",apiScheme:"https",sdkClientVersion:ms(so)},c=new vs(n,r,i,o);return function(e,t){const n=(null==t?void 0:t.persistence)||[],r=(Array.isArray(n)?n:[n]).map(es);(null==t?void 0:t.errorMap)&&e._updateErrorMap(t.errorMap),e._initializeWithPersistence(r,null==t?void 0:t.popupRedirectResolver)}(c,t),c}),"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback(((e,t,n)=>{e.getProvider("auth-internal").initialize()}))),qr(new Dn("auth-internal",(e=>{return t=_s(e.getProvider("auth").getImmediate()),new eo(t);var t}),"PRIVATE").setInstantiationMode("EXPLICIT")),Xr(Xa,Ya,function(e){switch(e){case"Node":return"node";case"ReactNative":return"rn";case"Worker":return"webworker";case"Cordova":return"cordova";case"WebExtension":return"web-extension";default:return}}(so)),Xr(Xa,Ya,"esm2017");var ao,oo,co="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},uo={};(function(){var e;function t(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}function n(e,t,n){n||(n=0);var r=Array(16);if("string"==typeof t)for(var i=0;16>i;++i)r[i]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(i=0;16>i;++i)r[i]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1],i=e.g[2];var s=e.g[3],a=t+(s^n&(i^s))+r[0]+3614090360&4294967295;a=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=n+(a<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[1]+3905402710&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[2]+606105819&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[3]+3250441966&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[4]+4118548399&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[5]+1200080426&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[6]+2821735955&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[7]+4249261313&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[8]+1770035416&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[9]+2336552879&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[10]+4294925233&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[11]+2304563134&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[12]+1804603682&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[13]+4254626195&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[14]+2792965006&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[15]+1236535329&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^s&(n^i))+r[1]+4129170786&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[6]+3225465664&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[11]+643717713&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[0]+3921069994&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[5]+3593408605&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[10]+38016083&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[15]+3634488961&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[4]+3889429448&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[9]+568446438&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[14]+3275163606&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[3]+4107603335&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[8]+1163531501&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[13]+2850285829&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[2]+4243563512&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[7]+1735328473&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[12]+2368359562&4294967295)<<20&4294967295|a>>>12))+((a=t+(n^i^s)+r[5]+4294588738&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[8]+2272392833&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[11]+1839030562&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[14]+4259657740&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[1]+2763975236&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[4]+1272893353&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[7]+4139469664&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[10]+3200236656&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[13]+681279174&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[0]+3936430074&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[3]+3572445317&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[6]+76029189&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[9]+3654602809&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[12]+3873151461&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[15]+530742520&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[2]+3299628645&4294967295)<<23&4294967295|a>>>9))+((a=t+(i^(n|~s))+r[0]+4096336452&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[7]+1126891415&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[14]+2878612391&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[5]+4237533241&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[12]+1700485571&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[3]+2399980690&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[10]+4293915773&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[1]+2240044497&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[8]+1873313359&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[15]+4264355552&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[6]+2734768916&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[13]+1309151649&4294967295)<<21&4294967295|a>>>11))+((s=(t=n+((a=t+(i^(n|~s))+r[4]+4149444226&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[11]+3174756917&4294967295)<<10&4294967295|a>>>22))^((i=s+((a=i+(t^(s|~n))+r[2]+718787259&4294967295)<<15&4294967295|a>>>17))|~t))+r[9]+3951481745&4294967295,e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(i+(a<<21&4294967295|a>>>11))&4294967295,e.g[2]=e.g[2]+i&4294967295,e.g[3]=e.g[3]+s&4294967295}function r(e,t){this.h=t;for(var n=[],r=!0,i=e.length-1;0<=i;i--){var s=0|e[i];r&&s==t||(n[i]=s,r=!1)}this.g=n}!function(e,t){function n(){}n.prototype=t.prototype,e.D=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.C=function(e,n,r){for(var i=Array(arguments.length-2),s=2;s<arguments.length;s++)i[s-2]=arguments[s];return t.prototype[n].apply(e,i)}}(t,(function(){this.blockSize=-1})),t.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0},t.prototype.u=function(e,t){void 0===t&&(t=e.length);for(var r=t-this.blockSize,i=this.B,s=this.h,a=0;a<t;){if(0==s)for(;a<=r;)n(this,e,a),a+=this.blockSize;if("string"==typeof e){for(;a<t;)if(i[s++]=e.charCodeAt(a++),s==this.blockSize){n(this,i),s=0;break}}else for(;a<t;)if(i[s++]=e[a++],s==this.blockSize){n(this,i),s=0;break}}this.h=s,this.o+=t},t.prototype.v=function(){var e=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;var n=8*this.o;for(t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.u(e),e=Array(16),t=n=0;4>t;++t)for(var r=0;32>r;r+=8)e[n++]=this.g[t]>>>r&255;return e};var i={};function s(e){return-128<=e&&128>e?function(e,t){var n=i;return Object.prototype.hasOwnProperty.call(n,e)?n[e]:n[e]=function(e){return new r([0|e],0>e?-1:0)}(e)}(e):new r([0|e],0>e?-1:0)}function a(e){if(isNaN(e)||!isFinite(e))return o;if(0>e)return d(a(-e));for(var t=[],n=1,i=0;e>=n;i++)t[i]=e/n|0,n*=4294967296;return new r(t,0)}var o=s(0),c=s(1),u=s(16777216);function l(e){if(0!=e.h)return!1;for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return!1;return!0}function h(e){return-1==e.h}function d(e){for(var t=e.g.length,n=[],i=0;i<t;i++)n[i]=~e.g[i];return new r(n,~e.h).add(c)}function f(e,t){return e.add(d(t))}function p(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function m(e,t){this.g=e,this.h=t}function g(e,t){if(l(t))throw Error("division by zero");if(l(e))return new m(o,o);if(h(e))return t=g(d(e),t),new m(d(t.g),d(t.h));if(h(t))return t=g(e,d(t)),new m(d(t.g),t.h);if(30<e.g.length){if(h(e)||h(t))throw Error("slowDivide_ only works with positive integers.");for(var n=c,r=t;0>=r.l(e);)n=y(n),r=y(r);var i=v(n,1),s=v(r,1);for(r=v(r,2),n=v(n,2);!l(r);){var u=s.add(r);0>=u.l(e)&&(i=i.add(n),s=u),r=v(r,1),n=v(n,1)}return t=f(e,i.j(t)),new m(i,t)}for(i=o;0<=e.l(t);){for(n=Math.max(1,Math.floor(e.m()/t.m())),r=48>=(r=Math.ceil(Math.log(n)/Math.LN2))?1:Math.pow(2,r-48),u=(s=a(n)).j(t);h(u)||0<u.l(e);)u=(s=a(n-=r)).j(t);l(s)&&(s=c),i=i.add(s),e=f(e,u)}return new m(i,e)}function y(e){for(var t=e.g.length+1,n=[],i=0;i<t;i++)n[i]=e.i(i)<<1|e.i(i-1)>>>31;return new r(n,e.h)}function v(e,t){var n=t>>5;t%=32;for(var i=e.g.length-n,s=[],a=0;a<i;a++)s[a]=0<t?e.i(a+n)>>>t|e.i(a+n+1)<<32-t:e.i(a+n);return new r(s,e.h)}(e=r.prototype).m=function(){if(h(this))return-d(this).m();for(var e=0,t=1,n=0;n<this.g.length;n++){var r=this.i(n);e+=(0<=r?r:4294967296+r)*t,t*=4294967296}return e},e.toString=function(e){if(2>(e=e||10)||36<e)throw Error("radix out of range: "+e);if(l(this))return"0";if(h(this))return"-"+d(this).toString(e);for(var t=a(Math.pow(e,6)),n=this,r="";;){var i=g(n,t).g,s=((0<(n=f(n,i.j(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(l(n=i))return s+r;for(;6>s.length;)s="0"+s;r=s+r}},e.i=function(e){return 0>e?0:e<this.g.length?this.g[e]:this.h},e.l=function(e){return h(e=f(this,e))?-1:l(e)?0:1},e.abs=function(){return h(this)?d(this):this},e.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],i=0,s=0;s<=t;s++){var a=i+(65535&this.i(s))+(65535&e.i(s)),o=(a>>>16)+(this.i(s)>>>16)+(e.i(s)>>>16);i=o>>>16,a&=65535,o&=65535,n[s]=o<<16|a}return new r(n,-2147483648&n[n.length-1]?-1:0)},e.j=function(e){if(l(this)||l(e))return o;if(h(this))return h(e)?d(this).j(d(e)):d(d(this).j(e));if(h(e))return d(this.j(d(e)));if(0>this.l(u)&&0>e.l(u))return a(this.m()*e.m());for(var t=this.g.length+e.g.length,n=[],i=0;i<2*t;i++)n[i]=0;for(i=0;i<this.g.length;i++)for(var s=0;s<e.g.length;s++){var c=this.i(i)>>>16,f=65535&this.i(i),m=e.i(s)>>>16,g=65535&e.i(s);n[2*i+2*s]+=f*g,p(n,2*i+2*s),n[2*i+2*s+1]+=c*g,p(n,2*i+2*s+1),n[2*i+2*s+1]+=f*m,p(n,2*i+2*s+1),n[2*i+2*s+2]+=c*m,p(n,2*i+2*s+2)}for(i=0;i<t;i++)n[i]=n[2*i+1]<<16|n[2*i];for(i=t;i<2*t;i++)n[i]=0;return new r(n,0)},e.A=function(e){return g(this,e).h},e.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],i=0;i<t;i++)n[i]=this.i(i)&e.i(i);return new r(n,this.h&e.h)},e.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],i=0;i<t;i++)n[i]=this.i(i)|e.i(i);return new r(n,this.h|e.h)},e.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],i=0;i<t;i++)n[i]=this.i(i)^e.i(i);return new r(n,this.h^e.h)},t.prototype.digest=t.prototype.v,t.prototype.reset=t.prototype.s,t.prototype.update=t.prototype.u,oo=uo.Md5=t,r.prototype.add=r.prototype.add,r.prototype.multiply=r.prototype.j,r.prototype.modulo=r.prototype.A,r.prototype.compare=r.prototype.l,r.prototype.toNumber=r.prototype.m,r.prototype.toString=r.prototype.toString,r.prototype.getBits=r.prototype.i,r.fromNumber=a,r.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if(2>(n=n||10)||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return d(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=a(Math.pow(n,8)),i=o,s=0;s<t.length;s+=8){var c=Math.min(8,t.length-s),u=parseInt(t.substring(s,s+c),n);8>c?(c=a(Math.pow(n,c)),i=i.j(c).add(a(u))):i=(i=i.j(r)).add(a(u))}return i},ao=uo.Integer=r}).apply(void 0!==co?co:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});var lo,ho,fo,po,mo,go,yo,vo,_o,wo="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},bo={};(function(){var e,t="function"==typeof Object.defineProperties?Object.defineProperty:function(e,t,n){return e==Array.prototype||e==Object.prototype||(e[t]=n.value),e},n=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof wo&&wo];for(var t=0;t<e.length;++t){var n=e[t];if(n&&n.Math==Math)return n}throw Error("Cannot find global object")}(this);!function(e,r){if(r)e:{var i=n;e=e.split(".");for(var s=0;s<e.length-1;s++){var a=e[s];if(!(a in i))break e;i=i[a]}(r=r(s=i[e=e[e.length-1]]))!=s&&null!=r&&t(i,e,{configurable:!0,writable:!0,value:r})}}("Array.prototype.values",(function(e){return e||function(){return function(e,t){e instanceof String&&(e+="");var n=0,r=!1,i={next:function(){if(!r&&n<e.length){var i=n++;return{value:t(0,e[i]),done:!1}}return r=!0,{done:!0,value:void 0}}};return i[Symbol.iterator]=function(){return i},i}(this,(function(e,t){return t}))}}));var r=r||{},i=this||self;function s(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function a(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}function o(e,t,n){return e.call.apply(e.bind,arguments)}function c(e,t,n){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),e.apply(t,n)}}return function(){return e.apply(t,arguments)}}function u(e,t,n){return(u=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?o:c).apply(null,arguments)}function l(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function h(e,t){function n(){}n.prototype=t.prototype,e.aa=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.Qb=function(e,n,r){for(var i=Array(arguments.length-2),s=2;s<arguments.length;s++)i[s-2]=arguments[s];return t.prototype[n].apply(e,i)}}function d(e){const t=e.length;if(0<t){const n=Array(t);for(let r=0;r<t;r++)n[r]=e[r];return n}return[]}function f(e,t){for(let t=1;t<arguments.length;t++){const n=arguments[t];if(s(n)){const t=e.length||0,r=n.length||0;e.length=t+r;for(let i=0;i<r;i++)e[t+i]=n[i]}else e.push(n)}}function p(e){return/^[\s\xa0]*$/.test(e)}function m(){var e=i.navigator;return e&&(e=e.userAgent)?e:""}function g(e){return g[" "](e),e}g[" "]=function(){};var y=!(-1==m().indexOf("Gecko")||-1!=m().toLowerCase().indexOf("webkit")&&-1==m().indexOf("Edge")||-1!=m().indexOf("Trident")||-1!=m().indexOf("MSIE")||-1!=m().indexOf("Edge"));function v(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function _(e){const t={};for(const n in e)t[n]=e[n];return t}const w="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function b(e,t){let n,r;for(let t=1;t<arguments.length;t++){for(n in r=arguments[t],r)e[n]=r[n];for(let t=0;t<w.length;t++)n=w[t],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function E(e){var t=1;e=e.split(":");const n=[];for(;0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}function k(e){i.setTimeout((()=>{throw e}),0)}function S(){var e=x;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}var T=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}((()=>new I),(e=>e.reset()));class I{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let O,A=!1,x=new class{constructor(){this.h=this.g=null}add(e,t){const n=T.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},P=()=>{const e=i.Promise.resolve(void 0);O=()=>{e.then(C)}};var C=()=>{for(var e;e=S();){try{e.h.call(e.g)}catch(e){k(e)}var t=T;t.j(e),100>t.h&&(t.h++,e.next=t.g,t.g=e)}A=!1};function N(){this.s=this.s,this.C=this.C}function R(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}N.prototype.s=!1,N.prototype.ma=function(){this.s||(this.s=!0,this.N())},N.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()},R.prototype.h=function(){this.defaultPrevented=!0};var j=function(){if(!i.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{const e=()=>{};i.addEventListener("test",e,t),i.removeEventListener("test",e,t)}catch(e){}return e}();function L(e,t){if(R.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(y){e:{try{g(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:D[e.pointerType]||"",this.state=e.state,this.i=e,e.defaultPrevented&&L.aa.h.call(this)}}h(L,R);var D={2:"touch",3:"pen",4:"mouse"};L.prototype.h=function(){L.aa.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var M="closure_listenable_"+(1e6*Math.random()|0),$=0;function U(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ha=i,this.key=++$,this.da=this.fa=!1}function F(e){e.da=!0,e.listener=null,e.proxy=null,e.src=null,e.ha=null}function B(e){this.src=e,this.g={},this.h=0}function V(e,t){var n=t.type;if(n in e.g){var r,i=e.g[n],s=Array.prototype.indexOf.call(i,t,void 0);(r=0<=s)&&Array.prototype.splice.call(i,s,1),r&&(F(t),0==e.g[n].length&&(delete e.g[n],e.h--))}}function z(e,t,n,r){for(var i=0;i<e.length;++i){var s=e[i];if(!s.da&&s.listener==t&&s.capture==!!n&&s.ha==r)return i}return-1}B.prototype.add=function(e,t,n,r,i){var s=e.toString();(e=this.g[s])||(e=this.g[s]=[],this.h++);var a=z(e,t,r,i);return-1<a?(t=e[a],n||(t.fa=!1)):((t=new U(t,this.src,s,!!r,i)).fa=n,e.push(t)),t};var q="closure_lm_"+(1e6*Math.random()|0),H={};function K(e,t,n,r,i){if(r&&r.once)return G(e,t,n,r,i);if(Array.isArray(t)){for(var s=0;s<t.length;s++)K(e,t[s],n,r,i);return null}return n=te(n),e&&e[M]?e.K(t,n,a(r)?!!r.capture:!!r,i):W(e,t,n,!1,r,i)}function W(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");var o=a(i)?!!i.capture:!!i,c=Y(e);if(c||(e[q]=c=new B(e)),(n=c.add(t,n,r,o,s)).proxy)return n;if(r=function(){const e=X;return function t(n){return e.call(t.src,t.listener,n)}}(),n.proxy=r,r.src=e,r.listener=n,e.addEventListener)j||(i=o),void 0===i&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(Q(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function G(e,t,n,r,i){if(Array.isArray(t)){for(var s=0;s<t.length;s++)G(e,t[s],n,r,i);return null}return n=te(n),e&&e[M]?e.L(t,n,a(r)?!!r.capture:!!r,i):W(e,t,n,!0,r,i)}function Z(e,t,n,r,i){if(Array.isArray(t))for(var s=0;s<t.length;s++)Z(e,t[s],n,r,i);else r=a(r)?!!r.capture:!!r,n=te(n),e&&e[M]?(e=e.i,(t=String(t).toString())in e.g&&-1<(n=z(s=e.g[t],n,r,i))&&(F(s[n]),Array.prototype.splice.call(s,n,1),0==s.length&&(delete e.g[t],e.h--))):e&&(e=Y(e))&&(t=e.g[t.toString()],e=-1,t&&(e=z(t,n,r,i)),(n=-1<e?t[e]:null)&&J(n))}function J(e){if("number"!=typeof e&&e&&!e.da){var t=e.src;if(t&&t[M])V(t.i,e);else{var n=e.type,r=e.proxy;t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(Q(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=Y(t))?(V(n,e),0==n.h&&(n.src=null,t[q]=null)):F(e)}}}function Q(e){return e in H?H[e]:H[e]="on"+e}function X(e,t){if(e.da)e=!0;else{t=new L(t,this);var n=e.listener,r=e.ha||e.src;e.fa&&J(e),e=n.call(r,t)}return e}function Y(e){return(e=e[q])instanceof B?e:null}var ee="__closure_events_fn_"+(1e9*Math.random()>>>0);function te(e){return"function"==typeof e?e:(e[ee]||(e[ee]=function(t){return e.handleEvent(t)}),e[ee])}function ne(){N.call(this),this.i=new B(this),this.M=this,this.F=null}function re(e,t){var n,r=e.F;if(r)for(n=[];r;r=r.F)n.push(r);if(e=e.M,r=t.type||t,"string"==typeof t)t=new R(t,e);else if(t instanceof R)t.target=t.target||e;else{var i=t;b(t=new R(r,e),i)}if(i=!0,n)for(var s=n.length-1;0<=s;s--){var a=t.g=n[s];i=ie(a,r,!0,t)&&i}if(i=ie(a=t.g=e,r,!0,t)&&i,i=ie(a,r,!1,t)&&i,n)for(s=0;s<n.length;s++)i=ie(a=t.g=n[s],r,!1,t)&&i}function ie(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var a=t[s];if(a&&!a.da&&a.capture==n){var o=a.listener,c=a.ha||a.src;a.fa&&V(e.i,a),i=!1!==o.call(c,r)&&i}}return i&&!r.defaultPrevented}function se(e,t,n){if("function"==typeof e)n&&(e=u(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=u(e.handleEvent,e)}return 2147483647<Number(t)?-1:i.setTimeout(e,t||0)}function ae(e){e.g=se((()=>{e.g=null,e.i&&(e.i=!1,ae(e))}),e.l);const t=e.h;e.h=null,e.m.apply(null,t)}h(ne,N),ne.prototype[M]=!0,ne.prototype.removeEventListener=function(e,t,n,r){Z(this,e,t,n,r)},ne.prototype.N=function(){if(ne.aa.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)F(n[r]);delete t.g[e],t.h--}}this.F=null},ne.prototype.K=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},ne.prototype.L=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};class oe extends N{constructor(e,t){super(),this.m=e,this.l=t,this.h=null,this.i=!1,this.g=null}j(e){this.h=arguments,this.g?this.i=!0:ae(this)}N(){super.N(),this.g&&(i.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ce(e){N.call(this),this.h=e,this.g={}}h(ce,N);var ue=[];function le(e){v(e.g,(function(e,t){this.g.hasOwnProperty(t)&&J(e)}),e),e.g={}}ce.prototype.N=function(){ce.aa.N.call(this),le(this)},ce.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var he=i.JSON.stringify,de=i.JSON.parse,fe=class{stringify(e){return i.JSON.stringify(e,void 0)}parse(e){return i.JSON.parse(e,void 0)}};function pe(){}function me(e){return e.h||(e.h=e.i())}function ge(){}pe.prototype.h=null;var ye={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function ve(){R.call(this,"d")}function _e(){R.call(this,"c")}h(ve,R),h(_e,R);var we={},be=null;function Ee(){return be=be||new ne}function ke(e){R.call(this,we.La,e)}function Se(e){const t=Ee();re(t,new ke(t))}function Te(e,t){R.call(this,we.STAT_EVENT,e),this.stat=t}function Ie(e){const t=Ee();re(t,new Te(t,e))}function Oe(e,t){R.call(this,we.Ma,e),this.size=t}function Ae(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return i.setTimeout((function(){e()}),t)}function xe(){this.g=!0}function Pe(e,t,n,r){e.info((function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(2>r.length)){var i=r[1];if(Array.isArray(i)&&!(1>i.length)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var a=1;a<i.length;a++)i[a]=""}}}return he(n)}catch(e){return t}}(e,n)+(r?" "+r:"")}))}we.La="serverreachability",h(ke,R),we.STAT_EVENT="statevent",h(Te,R),we.Ma="timingevent",h(Oe,R),xe.prototype.xa=function(){this.g=!1},xe.prototype.info=function(){};var Ce,Ne={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},Re={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"};function je(){}function Le(e,t,n,r){this.j=e,this.i=t,this.l=n,this.R=r||1,this.U=new ce(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new De}function De(){this.i=null,this.g="",this.h=!1}h(je,pe),je.prototype.g=function(){return new XMLHttpRequest},je.prototype.i=function(){return{}},Ce=new je;var Me={},$e={};function Ue(e,t,n){e.L=1,e.v=ht(at(t)),e.m=n,e.P=!0,Fe(e,null)}function Fe(e,t){e.F=Date.now(),ze(e),e.A=at(e.v);var n=e.A,r=e.R;Array.isArray(r)||(r=[String(r)]),Tt(n.i,"t",r),e.C=0,n=e.j.J,e.h=new De,e.g=fn(e.j,n?t:null,!e.m),0<e.O&&(e.M=new oe(u(e.Y,e,e.g),e.O)),t=e.U,n=e.g,r=e.ca;var i="readystatechange";Array.isArray(i)||(i&&(ue[0]=i.toString()),i=ue);for(var s=0;s<i.length;s++){var a=K(n,i[s],r||t.handleEvent,!1,t.h||t);if(!a)break;t.g[a.key]=a}t=e.H?_(e.H):{},e.m?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ea(e.A,e.u,e.m,t)):(e.u="GET",e.g.ea(e.A,e.u,null,t)),Se(),function(e,t,n,r,i,s){e.info((function(){if(e.g)if(s)for(var a="",o=s.split("&"),c=0;c<o.length;c++){var u=o[c].split("=");if(1<u.length){var l=u[0];u=u[1];var h=l.split("_");a=2<=h.length&&"type"==h[1]?a+(l+"=")+u+"&":a+(l+"=redacted&")}}else a=null;else a=s;return"XMLHTTP REQ ("+r+") [attempt "+i+"]: "+t+"\n"+n+"\n"+a}))}(e.i,e.u,e.A,e.l,e.R,e.m)}function Be(e){return!!e.g&&"GET"==e.u&&2!=e.L&&e.j.Ca}function Ve(e,t){var n=e.C,r=t.indexOf("\n",n);return-1==r?$e:(n=Number(t.substring(n,r)),isNaN(n)?Me:(r+=1)+n>t.length?$e:(t=t.slice(r,r+n),e.C=r+n,t))}function ze(e){e.S=Date.now()+e.I,qe(e,e.I)}function qe(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=Ae(u(e.ba,e),t)}function He(e){e.B&&(i.clearTimeout(e.B),e.B=null)}function Ke(e){0==e.j.G||e.J||cn(e.j,e)}function We(e){He(e);var t=e.M;t&&"function"==typeof t.ma&&t.ma(),e.M=null,le(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.ma())}function Ge(e,t){try{var n=e.j;if(0!=n.G&&(n.g==e||Ye(n.h,e)))if(!e.K&&Ye(n.h,e)&&3==n.G){try{var r=n.Da.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;on(n),Jt(n)}rn(n),Ie(18)}}else n.za=i[1],0<n.za-n.T&&37500>i[2]&&n.F&&0==n.v&&!n.C&&(n.C=Ae(u(n.Za,n),6e3));if(1>=Xe(n.h)&&n.ca){try{n.ca()}catch(e){}n.ca=void 0}}else ln(n,11)}else if((e.K||n.g==e)&&on(n),!p(t))for(i=n.Da.g.parse(t),t=0;t<i.length;t++){let u=i[t];if(n.T=u[0],u=u[1],2==n.G)if("c"==u[0]){n.K=u[1],n.ia=u[2];const t=u[3];null!=t&&(n.la=t,n.j.info("VER="+n.la));const i=u[4];null!=i&&(n.Aa=i,n.j.info("SVER="+n.Aa));const l=u[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.L=r,n.j.info("backChannelRequestTimeoutMs_="+r)),r=n;const h=e.g;if(h){const e=h.g?h.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(e){var s=r.h;s.g||-1==e.indexOf("spdy")&&-1==e.indexOf("quic")&&-1==e.indexOf("h2")||(s.j=s.l,s.g=new Set,s.h&&(et(s,s.h),s.h=null))}if(r.D){const e=h.g?h.g.getResponseHeader("X-HTTP-Session-Id"):null;e&&(r.ya=e,lt(r.I,r.D,e))}}n.G=3,n.l&&n.l.ua(),n.ba&&(n.R=Date.now()-e.F,n.j.info("Handshake RTT: "+n.R+"ms"));var a=e;if((r=n).qa=dn(r,r.J?r.ia:null,r.W),a.K){tt(r.h,a);var o=a,c=r.L;c&&(o.I=c),o.B&&(He(o),ze(o)),r.g=a}else nn(r);0<n.i.length&&Xt(n)}else"stop"!=u[0]&&"close"!=u[0]||ln(n,7);else 3==n.G&&("stop"==u[0]||"close"==u[0]?"stop"==u[0]?ln(n,7):Zt(n):"noop"!=u[0]&&n.l&&n.l.ta(u),n.v=0)}Se()}catch(e){}}Le.prototype.ca=function(e){e=e.target;const t=this.M;t&&3==Ht(e)?t.j():this.Y(e)},Le.prototype.Y=function(e){try{if(e==this.g)e:{const d=Ht(this.g);var t=this.g.Ba();if(this.g.Z(),!(3>d)&&(3!=d||this.g&&(this.h.h||this.g.oa()||Kt(this.g)))){this.J||4!=d||7==t||Se(),He(this);var n=this.g.Z();this.X=n;t:if(Be(this)){var r=Kt(this.g);e="";var s=r.length,a=4==Ht(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){We(this),Ke(this);var o="";break t}this.h.i=new i.TextDecoder}for(t=0;t<s;t++)this.h.h=!0,e+=this.h.i.decode(r[t],{stream:!(a&&t==s-1)});r.length=0,this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.oa();if(this.o=200==n,function(e,t,n,r,i,s,a){e.info((function(){return"XMLHTTP RESP ("+r+") [ attempt "+i+"]: "+t+"\n"+n+"\n"+s+" "+a}))}(this.i,this.u,this.A,this.l,this.R,d,n),this.o){if(this.T&&!this.K){t:{if(this.g){var c,u=this.g;if((c=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!p(c)){var l=c;break t}}l=null}if(!(n=l)){this.o=!1,this.s=3,Ie(12),We(this),Ke(this);break e}Pe(this.i,this.l,n,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Ge(this,n)}if(this.P){let e;for(n=!0;!this.J&&this.C<o.length;){if(e=Ve(this,o),e==$e){4==d&&(this.s=4,Ie(14),n=!1),Pe(this.i,this.l,null,"[Incomplete Response]");break}if(e==Me){this.s=4,Ie(15),Pe(this.i,this.l,o,"[Invalid Chunk]"),n=!1;break}Pe(this.i,this.l,e,null),Ge(this,e)}if(Be(this)&&0!=this.C&&(this.h.g=this.h.g.slice(this.C),this.C=0),4!=d||0!=o.length||this.h.h||(this.s=1,Ie(16),n=!1),this.o=this.o&&n,n){if(0<o.length&&!this.W){this.W=!0;var h=this.j;h.g==this&&h.ba&&!h.M&&(h.j.info("Great, no buffering proxy detected. Bytes received: "+o.length),sn(h),h.M=!0,Ie(11))}}else Pe(this.i,this.l,o,"[Invalid Chunked Response]"),We(this),Ke(this)}else Pe(this.i,this.l,o,null),Ge(this,o);4==d&&We(this),this.o&&!this.J&&(4==d?cn(this.j,this):(this.o=!1,ze(this)))}else(function(e){const t={};e=(e.g&&2<=Ht(e)&&e.g.getAllResponseHeaders()||"").split("\r\n");for(let r=0;r<e.length;r++){if(p(e[r]))continue;var n=E(e[r]);const i=n[0];if("string"!=typeof(n=n[1]))continue;n=n.trim();const s=t[i]||[];t[i]=s,s.push(n)}!function(e,t){for(const n in e)t.call(void 0,e[n],n,e)}(t,(function(e){return e.join(", ")}))})(this.g),400==n&&0<o.indexOf("Unknown SID")?(this.s=3,Ie(12)):(this.s=0,Ie(13)),We(this),Ke(this)}}}catch(e){}},Le.prototype.cancel=function(){this.J=!0,We(this)},Le.prototype.ba=function(){this.B=null;const e=Date.now();0<=e-this.S?(function(e,t){e.info((function(){return"TIMEOUT: "+t}))}(this.i,this.A),2!=this.L&&(Se(),Ie(17)),We(this),this.s=2,Ke(this)):qe(this,this.S-e)};var Ze=class{constructor(e,t){this.g=e,this.map=t}};function Je(e){this.l=e||10,e=i.PerformanceNavigationTiming?0<(e=i.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(i.chrome&&i.chrome.loadTimes&&i.chrome.loadTimes()&&i.chrome.loadTimes().wasFetchedViaSpdy),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Qe(e){return!!e.h||!!e.g&&e.g.size>=e.j}function Xe(e){return e.h?1:e.g?e.g.size:0}function Ye(e,t){return e.h?e.h==t:!!e.g&&e.g.has(t)}function et(e,t){e.g?e.g.add(t):e.h=t}function tt(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function nt(e){if(null!=e.h)return e.i.concat(e.h.D);if(null!=e.g&&0!==e.g.size){let t=e.i;for(const n of e.g.values())t=t.concat(n.D);return t}return d(e.i)}function rt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(s(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.na&&"function"==typeof e.na)return e.na();if(!e.V||"function"!=typeof e.V){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(s(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.V&&"function"==typeof e.V)return e.V();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(s(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),i=r.length,a=0;a<i;a++)t.call(void 0,r[a],n&&n[a],e)}Je.prototype.cancel=function(){if(this.i=nt(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var it=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function st(e){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,e instanceof st){this.h=e.h,ot(this,e.j),this.o=e.o,this.g=e.g,ct(this,e.s),this.l=e.l;var t=e.i,n=new bt;n.i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),ut(this,n),this.m=e.m}else e&&(t=String(e).match(it))?(this.h=!1,ot(this,t[1]||"",!0),this.o=dt(t[2]||""),this.g=dt(t[3]||"",!0),ct(this,t[4]),this.l=dt(t[5]||"",!0),ut(this,t[6]||"",!0),this.m=dt(t[7]||"")):(this.h=!1,this.i=new bt(null,this.h))}function at(e){return new st(e)}function ot(e,t,n){e.j=n?dt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function ct(e,t){if(t){if(t=Number(t),isNaN(t)||0>t)throw Error("Bad port number "+t);e.s=t}else e.s=null}function ut(e,t,n){t instanceof bt?(e.i=t,function(e,t){t&&!e.j&&(Et(e),e.i=null,e.g.forEach((function(e,t){var n=t.toLowerCase();t!=n&&(kt(this,t),Tt(this,n,e))}),e)),e.j=t}(e.i,e.h)):(n||(t=ft(t,_t)),e.i=new bt(t,e.h))}function lt(e,t,n){e.i.set(t,n)}function ht(e){return lt(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function dt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function ft(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,pt),n&&(e=e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e):null}function pt(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}st.prototype.toString=function(){var e=[],t=this.j;t&&e.push(ft(t,gt,!0),":");var n=this.g;return(n||"file"==t)&&(e.push("//"),(t=this.o)&&e.push(ft(t,gt,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.s)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(ft(n,"/"==n.charAt(0)?vt:yt,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.m)&&e.push("#",ft(n,wt)),e.join("")};var mt,gt=/[#\/\?@]/g,yt=/[#\?:]/g,vt=/[#\?]/g,_t=/[#\?@]/g,wt=/#/g;function bt(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function Et(e){e.g||(e.g=new Map,e.h=0,e.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r=e[n].indexOf("="),i=null;if(0<=r){var s=e[n].substring(0,r);i=e[n].substring(r+1)}else s=e[n];t(s,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(e.i,(function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)})))}function kt(e,t){Et(e),t=It(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function St(e,t){return Et(e),t=It(e,t),e.g.has(t)}function Tt(e,t,n){kt(e,t),0<n.length&&(e.i=null,e.g.set(It(e,t),d(n)),e.h+=n.length)}function It(e,t){return t=String(t),e.j&&(t=t.toLowerCase()),t}function Ot(e,t,n,r,i){try{i&&(i.onload=null,i.onerror=null,i.onabort=null,i.ontimeout=null),r(n)}catch(e){}}function At(){this.g=new fe}function xt(e,t,n){const r=n||"";try{rt(e,(function(e,n){let i=e;a(e)&&(i=he(e)),t.push(r+n+"="+encodeURIComponent(i))}))}catch(e){throw t.push(r+"type="+encodeURIComponent("_badmap")),e}}function Pt(e){this.l=e.Ub||null,this.j=e.eb||!1}function Ct(e,t){ne.call(this),this.D=e,this.o=t,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}function Nt(e){e.j.read().then(e.Pa.bind(e)).catch(e.ga.bind(e))}function Rt(e){e.readyState=4,e.l=null,e.j=null,e.v=null,jt(e)}function jt(e){e.onreadystatechange&&e.onreadystatechange.call(e)}function Lt(e){let t="";return v(e,(function(e,n){t+=n,t+=":",t+=e,t+="\r\n"})),t}function Dt(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=Lt(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):lt(e,t,n))}function Mt(e){ne.call(this),this.headers=new Map,this.o=e||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}(e=bt.prototype).add=function(e,t){Et(this),this.i=null,e=It(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},e.forEach=function(e,t){Et(this),this.g.forEach((function(n,r){n.forEach((function(n){e.call(t,n,r,this)}),this)}),this)},e.na=function(){Et(this);const e=Array.from(this.g.values()),t=Array.from(this.g.keys()),n=[];for(let r=0;r<t.length;r++){const i=e[r];for(let e=0;e<i.length;e++)n.push(t[r])}return n},e.V=function(e){Et(this);let t=[];if("string"==typeof e)St(this,e)&&(t=t.concat(this.g.get(It(this,e))));else{e=Array.from(this.g.values());for(let n=0;n<e.length;n++)t=t.concat(e[n])}return t},e.set=function(e,t){return Et(this),this.i=null,St(this,e=It(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},e.get=function(e,t){return e&&0<(e=this.V(e)).length?String(e[0]):t},e.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++){var r=t[n];const s=encodeURIComponent(String(r)),a=this.V(r);for(r=0;r<a.length;r++){var i=s;""!==a[r]&&(i+="="+encodeURIComponent(String(a[r]))),e.push(i)}}return this.i=e.join("&")},h(Pt,pe),Pt.prototype.g=function(){return new Ct(this.l,this.j)},Pt.prototype.i=(mt={},function(){return mt}),h(Ct,ne),(e=Ct.prototype).open=function(e,t){if(0!=this.readyState)throw this.abort(),Error("Error reopening a connection");this.B=e,this.A=t,this.readyState=1,jt(this)},e.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.u,method:this.B,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||i).fetch(new Request(this.A,t)).then(this.Sa.bind(this),this.ga.bind(this))},e.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Rt(this)),this.readyState=0},e.Sa=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,jt(this)),this.g&&(this.readyState=3,jt(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(void 0!==i.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;Nt(this)}else e.text().then(this.Ra.bind(this),this.ga.bind(this))},e.Pa=function(e){if(this.g){if(this.o&&e.value)this.response.push(e.value);else if(!this.o){var t=e.value?e.value:new Uint8Array(0);(t=this.v.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)}e.done?Rt(this):jt(this),3==this.readyState&&Nt(this)}},e.Ra=function(e){this.g&&(this.response=this.responseText=e,Rt(this))},e.Qa=function(e){this.g&&(this.response=e,Rt(this))},e.ga=function(){this.g&&Rt(this)},e.setRequestHeader=function(e,t){this.u.append(e,t)},e.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},e.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(Ct.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}}),h(Mt,ne);var $t=/^https?$/i,Ut=["POST","PUT"];function Ft(e,t){e.h=!1,e.g&&(e.j=!0,e.g.abort(),e.j=!1),e.l=t,e.m=5,Bt(e),zt(e)}function Bt(e){e.A||(e.A=!0,re(e,"complete"),re(e,"error"))}function Vt(e){if(e.h&&void 0!==r&&(!e.v[1]||4!=Ht(e)||2!=e.Z()))if(e.u&&4==Ht(e))se(e.Ea,0,e);else if(re(e,"readystatechange"),4==Ht(e)){e.h=!1;try{const r=e.Z();e:switch(r){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var t=!0;break e;default:t=!1}var n;if(!(n=t)){var s;if(s=0===r){var a=String(e.D).match(it)[1]||null;!a&&i.self&&i.self.location&&(a=i.self.location.protocol.slice(0,-1)),s=!$t.test(a?a.toLowerCase():"")}n=s}if(n)re(e,"complete"),re(e,"success");else{e.m=6;try{var o=2<Ht(e)?e.g.statusText:""}catch(e){o=""}e.l=o+" ["+e.Z()+"]",Bt(e)}}finally{zt(e)}}}function zt(e,t){if(e.g){qt(e);const n=e.g,r=e.v[0]?()=>{}:null;e.g=null,e.v=null,t||re(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function qt(e){e.I&&(i.clearTimeout(e.I),e.I=null)}function Ht(e){return e.g?e.g.readyState:0}function Kt(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.H){case"":case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function Wt(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Gt(e){this.Aa=0,this.i=[],this.j=new xe,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=Wt("failFast",!1,e),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=Wt("baseRetryDelayMs",5e3,e),this.cb=Wt("retryDelaySeedMs",1e4,e),this.Wa=Wt("forwardChannelMaxRetries",2,e),this.wa=Wt("forwardChannelRequestTimeoutMs",2e4,e),this.pa=e&&e.xmlHttpFactory||void 0,this.Xa=e&&e.Tb||void 0,this.Ca=e&&e.useFetchStreams||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.h=new Je(e&&e.concurrentRequestLimit),this.Da=new At,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=e&&e.Rb||!1,e&&e.xa&&this.j.xa(),e&&e.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&e&&e.detectBufferingProxy||!1,this.ja=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.ja=e.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}function Zt(e){if(Qt(e),3==e.G){var t=e.U++,n=at(e.I);if(lt(n,"SID",e.K),lt(n,"RID",t),lt(n,"TYPE","terminate"),en(e,n),(t=new Le(e,e.j,t)).L=2,t.v=ht(at(n)),n=!1,i.navigator&&i.navigator.sendBeacon)try{n=i.navigator.sendBeacon(t.v.toString(),"")}catch(e){}!n&&i.Image&&((new Image).src=t.v,n=!0),n||(t.g=fn(t.j,null),t.g.ea(t.v)),t.F=Date.now(),ze(t)}hn(e)}function Jt(e){e.g&&(sn(e),e.g.cancel(),e.g=null)}function Qt(e){Jt(e),e.u&&(i.clearTimeout(e.u),e.u=null),on(e),e.h.cancel(),e.s&&("number"==typeof e.s&&i.clearTimeout(e.s),e.s=null)}function Xt(e){if(!Qe(e.h)&&!e.s){e.s=!0;var t=e.Ga;O||P(),A||(O(),A=!0),x.add(t,e),e.B=0}}function Yt(e,t){var n;n=t?t.l:e.U++;const r=at(e.I);lt(r,"SID",e.K),lt(r,"RID",n),lt(r,"AID",e.T),en(e,r),e.m&&e.o&&Dt(r,e.m,e.o),n=new Le(e,e.j,n,e.B+1),null===e.m&&(n.H=e.o),t&&(e.i=t.D.concat(e.i)),t=tn(e,n,1e3),n.I=Math.round(.5*e.wa)+Math.round(.5*e.wa*Math.random()),et(e.h,n),Ue(n,r,t)}function en(e,t){e.H&&v(e.H,(function(e,n){lt(t,n,e)})),e.l&&rt({},(function(e,n){lt(t,n,e)}))}function tn(e,t,n){n=Math.min(e.i.length,n);var r=e.l?u(e.l.Na,e.l,e):null;e:{var i=e.i;let t=-1;for(;;){const s=["count="+n];-1==t?0<n?(t=i[0].g,s.push("ofs="+t)):t=0:s.push("ofs="+t);let a=!0;for(let o=0;o<n;o++){let n=i[o].g;const c=i[o].map;if(n-=t,0>n)t=Math.max(0,i[o].g-100),a=!1;else try{xt(c,s,"req"+n+"_")}catch(e){r&&r(c)}}if(a){r=s.join("&");break e}}}return e=e.i.splice(0,n),t.D=e,r}function nn(e){if(!e.g&&!e.u){e.Y=1;var t=e.Fa;O||P(),A||(O(),A=!0),x.add(t,e),e.v=0}}function rn(e){return!(e.g||e.u||3<=e.v||(e.Y++,e.u=Ae(u(e.Fa,e),un(e,e.v)),e.v++,0))}function sn(e){null!=e.A&&(i.clearTimeout(e.A),e.A=null)}function an(e){e.g=new Le(e,e.j,"rpc",e.Y),null===e.m&&(e.g.H=e.o),e.g.O=0;var t=at(e.qa);lt(t,"RID","rpc"),lt(t,"SID",e.K),lt(t,"AID",e.T),lt(t,"CI",e.F?"0":"1"),!e.F&&e.ja&&lt(t,"TO",e.ja),lt(t,"TYPE","xmlhttp"),en(e,t),e.m&&e.o&&Dt(t,e.m,e.o),e.L&&(e.g.I=e.L);var n=e.g;e=e.ia,n.L=1,n.v=ht(at(t)),n.m=null,n.P=!0,Fe(n,e)}function on(e){null!=e.C&&(i.clearTimeout(e.C),e.C=null)}function cn(e,t){var n=null;if(e.g==t){on(e),sn(e),e.g=null;var r=2}else{if(!Ye(e.h,t))return;n=t.D,tt(e.h,t),r=1}if(0!=e.G)if(t.o)if(1==r){n=t.m?t.m.length:0,t=Date.now()-t.F;var i=e.B;re(r=Ee(),new Oe(r,n)),Xt(e)}else nn(e);else if(3==(i=t.s)||0==i&&0<t.X||!(1==r&&function(e,t){return!(Xe(e.h)>=e.h.j-(e.s?1:0)||(e.s?(e.i=t.D.concat(e.i),0):1==e.G||2==e.G||e.B>=(e.Va?0:e.Wa)||(e.s=Ae(u(e.Ga,e,t),un(e,e.B)),e.B++,0)))}(e,t)||2==r&&rn(e)))switch(n&&0<n.length&&(t=e.h,t.i=t.i.concat(n)),i){case 1:ln(e,5);break;case 4:ln(e,10);break;case 3:ln(e,6);break;default:ln(e,2)}}function un(e,t){let n=e.Ta+Math.floor(Math.random()*e.cb);return e.isActive()||(n*=2),n*t}function ln(e,t){if(e.j.info("Error code "+t),2==t){var n=u(e.fb,e),r=e.Xa;const t=!r;r=new st(r||"//www.google.com/images/cleardot.gif"),i.location&&"http"==i.location.protocol||ot(r,"https"),ht(r),t?function(e,t){const n=new xe;if(i.Image){const r=new Image;r.onload=l(Ot,n,"TestLoadImage: loaded",!0,t,r),r.onerror=l(Ot,n,"TestLoadImage: error",!1,t,r),r.onabort=l(Ot,n,"TestLoadImage: abort",!1,t,r),r.ontimeout=l(Ot,n,"TestLoadImage: timeout",!1,t,r),i.setTimeout((function(){r.ontimeout&&r.ontimeout()}),1e4),r.src=e}else t(!1)}(r.toString(),n):function(e,t){new xe;const n=new AbortController,r=setTimeout((()=>{n.abort(),Ot(0,0,!1,t)}),1e4);fetch(e,{signal:n.signal}).then((e=>{clearTimeout(r),e.ok?Ot(0,0,!0,t):Ot(0,0,!1,t)})).catch((()=>{clearTimeout(r),Ot(0,0,!1,t)}))}(r.toString(),n)}else Ie(2);e.G=0,e.l&&e.l.sa(t),hn(e),Qt(e)}function hn(e){if(e.G=0,e.ka=[],e.l){const t=nt(e.h);0==t.length&&0==e.i.length||(f(e.ka,t),f(e.ka,e.i),e.h.i.length=0,d(e.i),e.i.length=0),e.l.ra()}}function dn(e,t,n){var r=n instanceof st?at(n):new st(n);if(""!=r.g)t&&(r.g=t+"."+r.g),ct(r,r.s);else{var s=i.location;r=s.protocol,t=t?t+"."+s.hostname:s.hostname,s=+s.port;var a=new st(null);r&&ot(a,r),t&&(a.g=t),s&&ct(a,s),n&&(a.l=n),r=a}return n=e.D,t=e.ya,n&&t&&lt(r,n,t),lt(r,"VER",e.la),en(e,r),r}function fn(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=e.Ca&&!e.pa?new Mt(new Pt({eb:n})):new Mt(e.pa)).Ha(e.J),t}function pn(){}function mn(){}function gn(e,t){ne.call(this),this.g=new Gt(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.o=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.va&&(e?e["X-WebChannel-Client-Profile"]=t.va:e={"X-WebChannel-Client-Profile":t.va}),this.g.S=e,(e=t&&t.Sb)&&!p(e)&&(this.g.m=e),this.v=t&&t.supportsCrossDomainXhr||!1,this.u=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!p(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&t in(e=this.h)&&delete e[t]),this.j=new _n(this)}function yn(e){ve.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function vn(){_e.call(this),this.status=1}function _n(e){this.g=e}(e=Mt.prototype).Ha=function(e){this.J=e},e.ea=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+e);t=t?t.toUpperCase():"GET",this.D=e,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():Ce.g(),this.v=this.o?me(this.o):me(Ce),this.g.onreadystatechange=u(this.Ea,this);try{this.B=!0,this.g.open(t,String(e),!0),this.B=!1}catch(e){return void Ft(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const e of r.keys())n.set(e,r.get(e))}r=Array.from(n.keys()).find((e=>"content-type"==e.toLowerCase())),s=i.FormData&&e instanceof i.FormData,!(0<=Array.prototype.indexOf.call(Ut,t,void 0))||r||s||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[e,t]of n)this.g.setRequestHeader(e,t);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{qt(this),this.u=!0,this.g.send(e),this.u=!1}catch(e){Ft(this,e)}},e.abort=function(e){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=e||7,re(this,"complete"),re(this,"abort"),zt(this))},e.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),zt(this,!0)),Mt.aa.N.call(this)},e.Ea=function(){this.s||(this.B||this.u||this.j?Vt(this):this.bb())},e.bb=function(){Vt(this)},e.isActive=function(){return!!this.g},e.Z=function(){try{return 2<Ht(this)?this.g.status:-1}catch(e){return-1}},e.oa=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},e.Oa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),de(t)}},e.Ba=function(){return this.m},e.Ka=function(){return"string"==typeof this.l?this.l:String(this.l)},(e=Gt.prototype).la=8,e.G=1,e.connect=function(e,t,n,r){Ie(0),this.W=e,this.H=t||{},n&&void 0!==r&&(this.H.OSID=n,this.H.OAID=r),this.F=this.X,this.I=dn(this,null,this.W),Xt(this)},e.Ga=function(e){if(this.s)if(this.s=null,1==this.G){if(!e){this.U=Math.floor(1e5*Math.random()),e=this.U++;const i=new Le(this,this.j,e);let s=this.o;if(this.S&&(s?(s=_(s),b(s,this.S)):s=this.S),null!==this.m||this.O||(i.H=s,s=null),this.P)e:{for(var t=0,n=0;n<this.i.length;n++){var r=this.i[n];if(void 0===(r="__data__"in r.map&&"string"==typeof(r=r.map.__data__)?r.length:void 0))break;if(4096<(t+=r)){t=n;break e}if(4096===t||n===this.i.length-1){t=n+1;break e}}t=1e3}else t=1e3;t=tn(this,i,t),lt(n=at(this.I),"RID",e),lt(n,"CVER",22),this.D&&lt(n,"X-HTTP-Session-Id",this.D),en(this,n),s&&(this.O?t="headers="+encodeURIComponent(String(Lt(s)))+"&"+t:this.m&&Dt(n,this.m,s)),et(this.h,i),this.Ua&&lt(n,"TYPE","init"),this.P?(lt(n,"$req",t),lt(n,"SID","null"),i.T=!0,Ue(i,n,null)):Ue(i,n,t),this.G=2}}else 3==this.G&&(e?Yt(this,e):0==this.i.length||Qe(this.h)||Yt(this))},e.Fa=function(){if(this.u=null,an(this),this.ba&&!(this.M||null==this.g||0>=this.R)){var e=2*this.R;this.j.info("BP detection timer enabled: "+e),this.A=Ae(u(this.ab,this),e)}},e.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,Ie(10),Jt(this),an(this))},e.Za=function(){null!=this.C&&(this.C=null,Jt(this),rn(this),Ie(19))},e.fb=function(e){e?(this.j.info("Successfully pinged google.com"),Ie(2)):(this.j.info("Failed to ping google.com"),Ie(1))},e.isActive=function(){return!!this.l&&this.l.isActive(this)},(e=pn.prototype).ua=function(){},e.ta=function(){},e.sa=function(){},e.ra=function(){},e.isActive=function(){return!0},e.Na=function(){},mn.prototype.g=function(e,t){return new gn(e,t)},h(gn,ne),gn.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},gn.prototype.close=function(){Zt(this.g)},gn.prototype.o=function(e){var t=this.g;if("string"==typeof e){var n={};n.__data__=e,e=n}else this.u&&((n={}).__data__=he(e),e=n);t.i.push(new Ze(t.Ya++,e)),3==t.G&&Xt(t)},gn.prototype.N=function(){this.g.l=null,delete this.j,Zt(this.g),delete this.g,gn.aa.N.call(this)},h(yn,ve),h(vn,_e),h(_n,pn),_n.prototype.ua=function(){re(this.g,"a")},_n.prototype.ta=function(e){re(this.g,new yn(e))},_n.prototype.sa=function(e){re(this.g,new vn)},_n.prototype.ra=function(){re(this.g,"b")},mn.prototype.createWebChannel=mn.prototype.g,gn.prototype.send=gn.prototype.o,gn.prototype.open=gn.prototype.m,gn.prototype.close=gn.prototype.close,_o=bo.createWebChannelTransport=function(){return new mn},vo=bo.getStatEventTarget=function(){return Ee()},yo=bo.Event=we,go=bo.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Ne.NO_ERROR=0,Ne.TIMEOUT=8,Ne.HTTP_ERROR=6,mo=bo.ErrorCode=Ne,Re.COMPLETE="complete",po=bo.EventType=Re,ge.EventType=ye,ye.OPEN="a",ye.CLOSE="b",ye.ERROR="c",ye.MESSAGE="d",ne.prototype.listen=ne.prototype.K,fo=bo.WebChannel=ge,ho=bo.FetchXmlHttpFactory=Pt,Mt.prototype.listenOnce=Mt.prototype.L,Mt.prototype.getLastError=Mt.prototype.Ka,Mt.prototype.getLastErrorCode=Mt.prototype.Ba,Mt.prototype.getStatus=Mt.prototype.Z,Mt.prototype.getResponseJson=Mt.prototype.Oa,Mt.prototype.getResponseText=Mt.prototype.oa,Mt.prototype.send=Mt.prototype.ea,Mt.prototype.setWithCredentials=Mt.prototype.Ha,lo=bo.XhrIo=Mt}).apply(void 0!==wo?wo:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});const Eo="@firebase/firestore";class ko{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}ko.UNAUTHENTICATED=new ko(null),ko.GOOGLE_CREDENTIALS=new ko("google-credentials-uid"),ko.FIRST_PARTY=new ko("first-party-uid"),ko.MOCK_USER=new ko("mock-user");let So="10.12.3";const To=new Kn("@firebase/firestore");function Io(){return To.logLevel}function Oo(e,...t){if(To.logLevel<=Bn.DEBUG){const n=t.map(Po);To.debug(`Firestore (${So}): ${e}`,...n)}}function Ao(e,...t){if(To.logLevel<=Bn.ERROR){const n=t.map(Po);To.error(`Firestore (${So}): ${e}`,...n)}}function xo(e,...t){if(To.logLevel<=Bn.WARN){const n=t.map(Po);To.warn(`Firestore (${So}): ${e}`,...n)}}function Po(e){if("string"==typeof e)return e;try{return function(e){return JSON.stringify(e)}(e)}catch(t){return e}}function Co(e="Unexpected state"){const t=`FIRESTORE (${So}) INTERNAL ASSERTION FAILED: `+e;throw Ao(t),new Error(t)}function No(e,t){e||Co()}function Ro(e,t){return e}const jo={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Lo extends Tn{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Do{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class Mo{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class $o{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(ko.UNAUTHENTICATED)))}shutdown(){}}class Uo{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class Fo{constructor(e){this.t=e,this.currentUser=ko.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let i=new Do;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Do,e.enqueueRetryable((()=>r(this.currentUser)))};const s=()=>{const t=i;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},a=e=>{Oo("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),s()};this.t.onInit((e=>a(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?a(e):(Oo("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Do)}}),0),s()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(Oo("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(No("string"==typeof t.accessToken),new Mo(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return No(null===e||"string"==typeof e),new ko(e)}}class Bo{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=ko.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class Vo{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new Bo(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable((()=>t(ko.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class zo{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class qo{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){const n=e=>{null!=e.error&&Oo("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.R;return this.R=e.token,Oo("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{Oo("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.A.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.A.getImmediate({optional:!0});e?r(e):Oo("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(No("string"==typeof e.token),this.R=e.token,new zo(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function Ho(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}class Ko{static newId(){const e=62*Math.floor(256/62);let t="";for(;t.length<20;){const n=Ho(40);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function Wo(e,t){return e<t?-1:e>t?1:0}function Go(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}class Zo{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new Lo(jo.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new Lo(jo.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new Lo(jo.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new Lo(jo.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return Zo.fromMillis(Date.now())}static fromDate(e){return Zo.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new Zo(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Wo(this.nanoseconds,e.nanoseconds):Wo(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Jo{constructor(e){this.timestamp=e}static fromTimestamp(e){return new Jo(e)}static min(){return new Jo(new Zo(0,0))}static max(){return new Jo(new Zo(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class Qo{constructor(e,t,n){void 0===t?t=0:t>e.length&&Co(),void 0===n?n=e.length-t:n>e.length-t&&Co(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===Qo.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof Qo?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),i=t.get(r);if(n<i)return-1;if(n>i)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class Xo extends Qo{construct(e,t,n){return new Xo(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new Lo(jo.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new Xo(t)}static emptyPath(){return new Xo([])}}const Yo=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class ec extends Qo{construct(e,t,n){return new ec(e,t,n)}static isValidIdentifier(e){return Yo.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),ec.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new ec(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const i=()=>{if(0===n.length)throw new Lo(jo.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let s=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new Lo(jo.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new Lo(jo.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(s=!s,r++):"."!==t||s?(n+=t,r++):(i(),r++)}if(i(),s)throw new Lo(jo.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new ec(t)}static emptyPath(){return new ec([])}}class tc{constructor(e){this.path=e}static fromPath(e){return new tc(Xo.fromString(e))}static fromName(e){return new tc(Xo.fromString(e).popFirst(5))}static empty(){return new tc(Xo.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===Xo.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return Xo.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new tc(new Xo(e.slice()))}}function nc(e){return new rc(e.readTime,e.key,-1)}class rc{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new rc(Jo.min(),tc.empty(),-1)}static max(){return new rc(Jo.max(),tc.empty(),-1)}}function ic(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=tc.comparator(e.documentKey,t.documentKey),0!==n?n:Wo(e.largestBatchId,t.largestBatchId))}const sc="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ac{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function oc(e){if(e.code!==jo.FAILED_PRECONDITION||e.message!==sc)throw e;Oo("LocalStore","Unexpectedly lost primary lease")}class cc{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&Co(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new cc(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof cc?t:cc.resolve(t)}catch(e){return cc.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):cc.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):cc.reject(t)}static resolve(e){return new cc(((t,n)=>{t(e)}))}static reject(e){return new cc(((t,n)=>{n(e)}))}static waitFor(e){return new cc(((t,n)=>{let r=0,i=0,s=!1;e.forEach((e=>{++r,e.next((()=>{++i,s&&i===r&&t()}),(e=>n(e)))})),s=!0,i===r&&t()}))}static or(e){let t=cc.resolve(!1);for(const n of e)t=t.next((e=>e?cc.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new cc(((n,r)=>{const i=e.length,s=new Array(i);let a=0;for(let o=0;o<i;o++){const c=o;t(e[c]).next((e=>{s[c]=e,++a,a===i&&n(s)}),(e=>r(e)))}}))}static doWhile(e,t){return new cc(((n,r)=>{const i=()=>{!0===e()?t().next((()=>{i()}),r):n()};i()}))}}function uc(e){return"IndexedDbTransactionError"===e.name}class lc{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ie(e),this.se=e=>t.writeSequenceNumber(e))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.se&&this.se(e),e}}function hc(e){return null==e}function dc(e){return 0===e&&1/e==-1/0}function fc(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function pc(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function mc(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}lc.oe=-1;class gc{constructor(e,t){this.comparator=e,this.root=t||vc.EMPTY}insert(e,t){return new gc(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,vc.BLACK,null,null))}remove(e){return new gc(this.comparator,this.root.remove(e,this.comparator).copy(null,null,vc.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new yc(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new yc(this.root,e,this.comparator,!1)}getReverseIterator(){return new yc(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new yc(this.root,e,this.comparator,!0)}}class yc{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class vc{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:vc.RED,this.left=null!=r?r:vc.EMPTY,this.right=null!=i?i:vc.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new vc(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return vc.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return vc.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,vc.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,vc.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Co();if(this.right.isRed())throw Co();const e=this.left.check();if(e!==this.right.check())throw Co();return e+(this.isRed()?0:1)}}vc.EMPTY=null,vc.RED=!0,vc.BLACK=!1,vc.EMPTY=new class{constructor(){this.size=0}get key(){throw Co()}get value(){throw Co()}get color(){throw Co()}get left(){throw Co()}get right(){throw Co()}copy(e,t,n,r,i){return this}insert(e,t,n){return new vc(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class _c{constructor(e){this.comparator=e,this.data=new gc(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new wc(this.data.getIterator())}getIteratorFrom(e){return new wc(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof _c))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new _c(this.comparator);return t.data=e,t}}class wc{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}class bc{constructor(e){this.fields=e,e.sort(ec.comparator)}static empty(){return new bc([])}unionWith(e){let t=new _c(ec.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new bc(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Go(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class Ec extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class kc{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new Ec("Invalid base64 string: "+e):e}}(e);return new kc(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new kc(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Wo(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}kc.EMPTY_BYTE_STRING=new kc("");const Sc=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Tc(e){if(No(!!e),"string"==typeof e){let t=0;const n=Sc.exec(e);if(No(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:Ic(e.seconds),nanos:Ic(e.nanos)}}function Ic(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Oc(e){return"string"==typeof e?kc.fromBase64String(e):kc.fromUint8Array(e)}function Ac(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function xc(e){const t=e.mapValue.fields.__previous_value__;return Ac(t)?xc(t):t}function Pc(e){const t=Tc(e.mapValue.fields.__local_write_time__.timestampValue);return new Zo(t.seconds,t.nanos)}class Cc{constructor(e,t,n,r,i,s,a,o,c){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=c}}class Nc{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Nc("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Nc&&e.projectId===this.projectId&&e.database===this.database}}const Rc={mapValue:{fields:{__type__:{stringValue:"__max__"}}}};function jc(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Ac(e)?4:Wc(e)?9007199254740991:10:Co()}function Lc(e,t){if(e===t)return!0;const n=jc(e);if(n!==jc(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Pc(e).isEqual(Pc(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=Tc(e.timestampValue),r=Tc(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return Oc(e.bytesValue).isEqual(Oc(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return Ic(e.geoPointValue.latitude)===Ic(t.geoPointValue.latitude)&&Ic(e.geoPointValue.longitude)===Ic(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Ic(e.integerValue)===Ic(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=Ic(e.doubleValue),r=Ic(t.doubleValue);return n===r?dc(n)===dc(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return Go(e.arrayValue.values||[],t.arrayValue.values||[],Lc);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(fc(n)!==fc(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!Lc(n[e],r[e])))return!1;return!0}(e,t);default:return Co()}}function Dc(e,t){return void 0!==(e.values||[]).find((e=>Lc(e,t)))}function Mc(e,t){if(e===t)return 0;const n=jc(e),r=jc(t);if(n!==r)return Wo(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return Wo(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=Ic(e.integerValue||e.doubleValue),r=Ic(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return $c(e.timestampValue,t.timestampValue);case 4:return $c(Pc(e),Pc(t));case 5:return Wo(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Oc(e),r=Oc(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){const t=Wo(n[e],r[e]);if(0!==t)return t}return Wo(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=Wo(Ic(e.latitude),Ic(t.latitude));return 0!==n?n:Wo(Ic(e.longitude),Ic(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){const t=Mc(n[e],r[e]);if(t)return t}return Wo(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Rc.mapValue&&t===Rc.mapValue)return 0;if(e===Rc.mapValue)return 1;if(t===Rc.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){const t=Wo(r[e],s[e]);if(0!==t)return t;const a=Mc(n[r[e]],i[s[e]]);if(0!==a)return a}return Wo(r.length,s.length)}(e.mapValue,t.mapValue);default:throw Co()}}function $c(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Wo(e,t);const n=Tc(e),r=Tc(t),i=Wo(n.seconds,r.seconds);return 0!==i?i:Wo(n.nanos,r.nanos)}function Uc(e){return Fc(e)}function Fc(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Tc(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function(e){return Oc(e).toBase64()}(e.bytesValue):"referenceValue"in e?function(e){return tc.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=Fc(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const i of t)r?r=!1:n+=",",n+=`${i}:${Fc(e.fields[i])}`;return n+"}"}(e.mapValue):Co()}function Bc(e){return!!e&&"integerValue"in e}function Vc(e){return!!e&&"arrayValue"in e}function zc(e){return!!e&&"nullValue"in e}function qc(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Hc(e){return!!e&&"mapValue"in e}function Kc(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return pc(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=Kc(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=Kc(e.arrayValue.values[n]);return t}return Object.assign({},e)}function Wc(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}class Gc{constructor(e){this.value=e}static empty(){return new Gc({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Hc(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Kc(t)}setAll(e){let t=ec.emptyPath(),n={},r=[];e.forEach(((e,i)=>{if(!t.isImmediateParentOf(i)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=Kc(e):r.push(i.lastSegment())}));const i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){const t=this.field(e.popLast());Hc(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Lc(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];Hc(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){pc(t,((t,n)=>e[t]=n));for(const t of n)delete e[t]}clone(){return new Gc(Kc(this.value))}}function Zc(e){const t=[];return pc(e.fields,((e,n)=>{const r=new ec([e]);if(Hc(n)){const e=Zc(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new bc(t)}class Jc{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new Jc(e,0,Jo.min(),Jo.min(),Jo.min(),Gc.empty(),0)}static newFoundDocument(e,t,n,r){return new Jc(e,1,t,Jo.min(),n,r,0)}static newNoDocument(e,t){return new Jc(e,2,t,Jo.min(),Jo.min(),Gc.empty(),0)}static newUnknownDocument(e,t){return new Jc(e,3,t,Jo.min(),Jo.min(),Gc.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(Jo.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Gc.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Gc.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Jo.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Jc&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Jc(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Qc{constructor(e,t){this.position=e,this.inclusive=t}}function Xc(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){const s=t[i],a=e.position[i];if(r=s.field.isKeyField()?tc.comparator(tc.fromName(a.referenceValue),n.key):Mc(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function Yc(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!Lc(e.position[n],t.position[n]))return!1;return!0}class eu{constructor(e,t="asc"){this.field=e,this.dir=t}}function tu(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class nu{}class ru extends nu{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new lu(e,t,n):"array-contains"===t?new pu(e,n):"in"===t?new mu(e,n):"not-in"===t?new gu(e,n):"array-contains-any"===t?new yu(e,n):new ru(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new hu(e,n):new du(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Mc(t,this.value)):null!==t&&jc(this.value)===jc(t)&&this.matchesComparison(Mc(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return Co()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class iu extends nu{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new iu(e,t)}matches(e){return su(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.ae||(this.ae=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function su(e){return"and"===e.op}function au(e){return function(e){for(const t of e.filters)if(t instanceof iu)return!1;return!0}(e)&&su(e)}function ou(e){if(e instanceof ru)return e.field.canonicalString()+e.op.toString()+Uc(e.value);if(au(e))return e.filters.map((e=>ou(e))).join(",");{const t=e.filters.map((e=>ou(e))).join(",");return`${e.op}(${t})`}}function cu(e,t){return e instanceof ru?function(e,t){return t instanceof ru&&e.op===t.op&&e.field.isEqual(t.field)&&Lc(e.value,t.value)}(e,t):e instanceof iu?function(e,t){return t instanceof iu&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,r)=>e&&cu(n,t.filters[r])),!0)}(e,t):void Co()}function uu(e){return e instanceof ru?function(e){return`${e.field.canonicalString()} ${e.op} ${Uc(e.value)}`}(e):e instanceof iu?function(e){return e.op.toString()+" {"+e.getFilters().map(uu).join(" ,")+"}"}(e):"Filter"}class lu extends ru{constructor(e,t,n){super(e,t,n),this.key=tc.fromName(n.referenceValue)}matches(e){const t=tc.comparator(e.key,this.key);return this.matchesComparison(t)}}class hu extends ru{constructor(e,t){super(e,"in",t),this.keys=fu(0,t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class du extends ru{constructor(e,t){super(e,"not-in",t),this.keys=fu(0,t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function fu(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>tc.fromName(e.referenceValue)))}class pu extends ru{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Vc(t)&&Dc(t.arrayValue,this.value)}}class mu extends ru{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&Dc(this.value.arrayValue,t)}}class gu extends ru{constructor(e,t){super(e,"not-in",t)}matches(e){if(Dc(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!Dc(this.value.arrayValue,t)}}class yu extends ru{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Vc(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>Dc(this.value.arrayValue,e)))}}class vu{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.ue=null}}function _u(e,t=null,n=[],r=[],i=null,s=null,a=null){return new vu(e,t,n,r,i,s,a)}function wu(e){const t=Ro(e);if(null===t.ue){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>ou(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),hc(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>Uc(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>Uc(e))).join(",")),t.ue=e}return t.ue}function bu(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!tu(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!cu(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Yc(e.startAt,t.startAt)&&Yc(e.endAt,t.endAt)}function Eu(e){return tc.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}class ku{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function Su(e){return new ku(e)}function Tu(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Iu(e){const t=Ro(e);if(null===t.ce){t.ce=[];const e=new Set;for(const n of t.explicitOrderBy)t.ce.push(n),e.add(n.field.canonicalString());const n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc",r=function(e){let t=new _c(ec.comparator);return e.filters.forEach((e=>{e.getFlattenedFilters().forEach((e=>{e.isInequality()&&(t=t.add(e.field))}))})),t}(t);r.forEach((r=>{e.has(r.canonicalString())||r.isKeyField()||t.ce.push(new eu(r,n))})),e.has(ec.keyField().canonicalString())||t.ce.push(new eu(ec.keyField(),n))}return t.ce}function Ou(e){const t=Ro(e);return t.le||(t.le=function(e,t){if("F"===e.limitType)return _u(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map((e=>{const t="desc"===e.dir?"asc":"desc";return new eu(e.field,t)}));const n=e.endAt?new Qc(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new Qc(e.startAt.position,e.startAt.inclusive):null;return _u(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}(t,Iu(e))),t.le}function Au(e,t,n){return new ku(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function xu(e,t){return bu(Ou(e),Ou(t))&&e.limitType===t.limitType}function Pu(e){return`${wu(Ou(e))}|lt:${e.limitType}`}function Cu(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>uu(e))).join(", ")}]`),hc(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>Uc(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>Uc(e))).join(",")),`Target(${t})`}(Ou(e))}; limitType=${e.limitType})`}function Nu(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):tc.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of Iu(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=Xc(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,Iu(e),t)||e.endAt&&!function(e,t,n){const r=Xc(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,Iu(e),t))}(e,t)}function Ru(e){return(t,n)=>{let r=!1;for(const i of Iu(e)){const e=ju(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}function ju(e,t,n){const r=e.field.isKeyField()?tc.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?Mc(r,i):Co()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return Co()}}class Lu{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){pc(this.inner,((t,n)=>{for(const[t,r]of n)e(t,r)}))}isEmpty(){return mc(this.inner)}size(){return this.innerSize}}const Du=new gc(tc.comparator);function Mu(){return Du}const $u=new gc(tc.comparator);function Uu(...e){let t=$u;for(const n of e)t=t.insert(n.key,n);return t}function Fu(e){let t=$u;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function Bu(){return zu()}function Vu(){return zu()}function zu(){return new Lu((e=>e.toString()),((e,t)=>e.isEqual(t)))}const qu=new gc(tc.comparator),Hu=new _c(tc.comparator);function Ku(...e){let t=Hu;for(const n of e)t=t.add(n);return t}const Wu=new _c(Wo);function Gu(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:dc(t)?"-0":t}}function Zu(e){return{integerValue:""+e}}class Ju{constructor(){this._=void 0}}function Qu(e,t,n){return e instanceof el?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&Ac(t)&&(t=xc(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof tl?nl(e,t):e instanceof rl?il(e,t):function(e,t){const n=Yu(e,t),r=al(n)+al(e.Pe);return Bc(n)&&Bc(e.Pe)?Zu(r):Gu(e.serializer,r)}(e,t)}function Xu(e,t,n){return e instanceof tl?nl(e,t):e instanceof rl?il(e,t):n}function Yu(e,t){return e instanceof sl?function(e){return Bc(e)||function(e){return!!e&&"doubleValue"in e}(e)}(t)?t:{integerValue:0}:null}class el extends Ju{}class tl extends Ju{constructor(e){super(),this.elements=e}}function nl(e,t){const n=ol(t);for(const t of e.elements)n.some((e=>Lc(e,t)))||n.push(t);return{arrayValue:{values:n}}}class rl extends Ju{constructor(e){super(),this.elements=e}}function il(e,t){let n=ol(t);for(const t of e.elements)n=n.filter((e=>!Lc(e,t)));return{arrayValue:{values:n}}}class sl extends Ju{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function al(e){return Ic(e.integerValue||e.doubleValue)}function ol(e){return Vc(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class cl{constructor(e,t){this.version=e,this.transformResults=t}}class ul{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new ul}static exists(e){return new ul(void 0,e)}static updateTime(e){return new ul(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function ll(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class hl{}function dl(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new El(e.key,ul.none()):new yl(e.key,e.data,ul.none());{const n=e.data,r=Gc.empty();let i=new _c(ec.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new vl(e.key,r,new bc(i.toArray()),ul.none())}}function fl(e,t,n){e instanceof yl?function(e,t,n){const r=e.value.clone(),i=wl(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof vl?function(e,t,n){if(!ll(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=wl(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(_l(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function pl(e,t,n,r){return e instanceof yl?function(e,t,n,r){if(!ll(e.precondition,t))return n;const i=e.value.clone(),s=bl(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof vl?function(e,t,n,r){if(!ll(e.precondition,t))return n;const i=bl(e.fieldTransforms,r,t),s=t.data;return s.setAll(_l(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return ll(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function ml(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),i=Yu(r.transform,e||null);null!=i&&(null===n&&(n=Gc.empty()),n.set(r.field,i))}return n||null}function gl(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&Go(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof tl&&t instanceof tl||e instanceof rl&&t instanceof rl?Go(e.elements,t.elements,Lc):e instanceof sl&&t instanceof sl?Lc(e.Pe,t.Pe):e instanceof el&&t instanceof el}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class yl extends hl{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class vl extends hl{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function _l(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function wl(e,t,n){const r=new Map;No(e.length===n.length);for(let i=0;i<n.length;i++){const s=e[i],a=s.transform,o=t.data.field(s.field);r.set(s.field,Xu(a,o,n[i]))}return r}function bl(e,t,n){const r=new Map;for(const i of e){const e=i.transform,s=n.data.field(i.field);r.set(i.field,Qu(e,s,t))}return r}class El extends hl{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class kl extends hl{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Sl{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];r.key.isEqual(e.key)&&fl(r,e,n[t])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=pl(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=pl(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Vu();return this.mutations.forEach((r=>{const i=e.get(r.key),s=i.overlayedDocument;let a=this.applyToLocalView(s,i.mutatedFields);a=t.has(r.key)?null:a;const o=dl(s,a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument(Jo.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),Ku())}isEqual(e){return this.batchId===e.batchId&&Go(this.mutations,e.mutations,((e,t)=>gl(e,t)))&&Go(this.baseMutations,e.baseMutations,((e,t)=>gl(e,t)))}}class Tl{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){No(e.mutations.length===n.length);let r=qu;const i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new Tl(e,t,n,r)}}class Il{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Ol{constructor(e,t){this.count=e,this.unchangedNames=t}}var Al,xl;function Pl(e){if(void 0===e)return Ao("GRPC error has no .code"),jo.UNKNOWN;switch(e){case Al.OK:return jo.OK;case Al.CANCELLED:return jo.CANCELLED;case Al.UNKNOWN:return jo.UNKNOWN;case Al.DEADLINE_EXCEEDED:return jo.DEADLINE_EXCEEDED;case Al.RESOURCE_EXHAUSTED:return jo.RESOURCE_EXHAUSTED;case Al.INTERNAL:return jo.INTERNAL;case Al.UNAVAILABLE:return jo.UNAVAILABLE;case Al.UNAUTHENTICATED:return jo.UNAUTHENTICATED;case Al.INVALID_ARGUMENT:return jo.INVALID_ARGUMENT;case Al.NOT_FOUND:return jo.NOT_FOUND;case Al.ALREADY_EXISTS:return jo.ALREADY_EXISTS;case Al.PERMISSION_DENIED:return jo.PERMISSION_DENIED;case Al.FAILED_PRECONDITION:return jo.FAILED_PRECONDITION;case Al.ABORTED:return jo.ABORTED;case Al.OUT_OF_RANGE:return jo.OUT_OF_RANGE;case Al.UNIMPLEMENTED:return jo.UNIMPLEMENTED;case Al.DATA_LOSS:return jo.DATA_LOSS;default:return Co()}}(xl=Al||(Al={}))[xl.OK=0]="OK",xl[xl.CANCELLED=1]="CANCELLED",xl[xl.UNKNOWN=2]="UNKNOWN",xl[xl.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",xl[xl.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",xl[xl.NOT_FOUND=5]="NOT_FOUND",xl[xl.ALREADY_EXISTS=6]="ALREADY_EXISTS",xl[xl.PERMISSION_DENIED=7]="PERMISSION_DENIED",xl[xl.UNAUTHENTICATED=16]="UNAUTHENTICATED",xl[xl.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",xl[xl.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",xl[xl.ABORTED=10]="ABORTED",xl[xl.OUT_OF_RANGE=11]="OUT_OF_RANGE",xl[xl.UNIMPLEMENTED=12]="UNIMPLEMENTED",xl[xl.INTERNAL=13]="INTERNAL",xl[xl.UNAVAILABLE=14]="UNAVAILABLE",xl[xl.DATA_LOSS=15]="DATA_LOSS";const Cl=new ao([4294967295,4294967295],0);function Nl(e){const t=(new TextEncoder).encode(e),n=new oo;return n.update(t),new Uint8Array(n.digest())}function Rl(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new ao([n,r],0),new ao([i,s],0)]}class jl{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new Ll(`Invalid padding: ${t}`);if(n<0)throw new Ll(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new Ll(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Ll(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=ao.fromNumber(this.Ie)}Ee(e,t,n){let r=e.add(t.multiply(ao.fromNumber(n)));return 1===r.compare(Cl)&&(r=new ao([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Te).toNumber()}de(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ie)return!1;const t=Nl(e),[n,r]=Rl(t);for(let e=0;e<this.hashCount;e++){const t=this.Ee(n,r,e);if(!this.de(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,i=new Uint8Array(Math.ceil(e/8)),s=new jl(i,r,t);return n.forEach((e=>s.insert(e))),s}insert(e){if(0===this.Ie)return;const t=Nl(e),[n,r]=Rl(t);for(let e=0;e<this.hashCount;e++){const t=this.Ee(n,r,e);this.Ae(t)}}Ae(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class Ll extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Dl{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Ml.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Dl(Jo.min(),r,new gc(Wo),Mu(),Ku())}}class Ml{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Ml(n,t,Ku(),Ku(),Ku())}}class $l{constructor(e,t,n,r){this.Re=e,this.removedTargetIds=t,this.key=n,this.Ve=r}}class Ul{constructor(e,t){this.targetId=e,this.me=t}}class Fl{constructor(e,t,n=kc.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Bl{constructor(){this.fe=0,this.ge=ql(),this.pe=kc.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return 0!==this.fe}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}Ce(){let e=Ku(),t=Ku(),n=Ku();return this.ge.forEach(((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:Co()}})),new Ml(this.pe,this.ye,e,t,n)}ve(){this.we=!1,this.ge=ql()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,No(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}}class Vl{constructor(e){this.Le=e,this.Be=new Map,this.ke=Mu(),this.qe=zl(),this.Qe=new gc(Wo)}Ke(e){for(const t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(const t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,(t=>{const n=this.Ge(t);switch(e.state){case 0:this.ze(t)&&n.De(e.resumeToken);break;case 1:n.Oe(),n.Se||n.ve(),n.De(e.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(n.Ne(),n.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),n.De(e.resumeToken));break;default:Co()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach(((e,n)=>{this.ze(n)&&t(n)}))}He(e){const t=e.targetId,n=e.me.count,r=this.Je(t);if(r){const i=r.target;if(Eu(i))if(0===n){const e=new tc(i.path);this.Ue(t,e,Jc.newNoDocument(e,Jo.min()))}else No(1===n);else{const r=this.Ye(t);if(r!==n){const n=this.Ze(e),i=n?this.Xe(n,e,r):1;if(0!==i){this.je(t);const e=2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,e)}}}}}Ze(e){const t=e.me.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:i=0}=t;let s,a;try{s=Oc(n).toUint8Array()}catch(e){if(e instanceof Ec)return xo("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{a=new jl(s,r,i)}catch(e){return xo(e instanceof Ll?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===a.Ie?null:a}Xe(e,t,n){return t.me.count===n-this.nt(e,t.targetId)?0:2}nt(e,t){const n=this.Le.getRemoteKeysForTarget(t);let r=0;return n.forEach((n=>{const i=this.Le.tt(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(s)||(this.Ue(t,n,null),r++)})),r}rt(e){const t=new Map;this.Be.forEach(((n,r)=>{const i=this.Je(r);if(i){if(n.current&&Eu(i.target)){const t=new tc(i.target.path);null!==this.ke.get(t)||this.it(r,t)||this.Ue(r,t,Jc.newNoDocument(t,e))}n.be&&(t.set(r,n.Ce()),n.ve())}}));let n=Ku();this.qe.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.Je(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.ke.forEach(((t,n)=>n.setReadTime(e)));const r=new Dl(e,t,this.Qe,this.ke,n);return this.ke=Mu(),this.qe=zl(),this.Qe=new gc(Wo),r}$e(e,t){if(!this.ze(e))return;const n=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,n),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,n){if(!this.ze(e))return;const r=this.Ge(e);this.it(e,t)?r.Fe(t,1):r.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),n&&(this.ke=this.ke.insert(t,n))}removeTarget(e){this.Be.delete(e)}Ye(e){const t=this.Ge(e).Ce();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new Bl,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new _c(Wo),this.qe=this.qe.insert(e,t)),t}ze(e){const t=null!==this.Je(e);return t||Oo("WatchChangeAggregator","Detected inactive target",e),t}Je(e){const t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new Bl),this.Le.getRemoteKeysForTarget(e).forEach((t=>{this.Ue(e,t,null)}))}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function zl(){return new gc(tc.comparator)}function ql(){return new gc(tc.comparator)}const Hl={asc:"ASCENDING",desc:"DESCENDING"},Kl={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Wl={and:"AND",or:"OR"};class Gl{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function Zl(e,t){return e.useProto3Json||hc(t)?t:{value:t}}function Jl(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Ql(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function Xl(e,t){return Jl(e,t.toTimestamp())}function Yl(e){return No(!!e),Jo.fromTimestamp(function(e){const t=Tc(e);return new Zo(t.seconds,t.nanos)}(e))}function eh(e,t){return th(e,t).canonicalString()}function th(e,t){const n=function(e){return new Xo(["projects",e.projectId,"databases",e.database])}(e).child("documents");return void 0===t?n:n.child(t)}function nh(e){const t=Xo.fromString(e);return No(wh(t)),t}function rh(e,t){return eh(e.databaseId,t.path)}function ih(e,t){const n=nh(t);if(n.get(1)!==e.databaseId.projectId)throw new Lo(jo.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new Lo(jo.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new tc(oh(n))}function sh(e,t){return eh(e.databaseId,t)}function ah(e){return new Xo(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function oh(e){return No(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function ch(e,t,n){return{name:rh(e,t),fields:n.value.mapValue.fields}}function uh(e,t){return{documents:[sh(e,t.path)]}}function lh(e,t){const n={structuredQuery:{}},r=t.path;let i;null!==t.collectionGroup?(i=r,n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=sh(e,i);const s=function(e){if(0!==e.length)return vh(iu.create(e,"and"))}(t.filters);s&&(n.structuredQuery.where=s);const a=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:gh(e.field),direction:fh(e.dir)}}(e)))}(t.orderBy);a&&(n.structuredQuery.orderBy=a);const o=Zl(e,t.limit);return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt=function(e){return{before:e.inclusive,values:e.position}}(t.startAt)),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),{_t:n,parent:i}}function hh(e){let t=function(e){const t=nh(e);return 4===t.length?Xo.emptyPath():oh(t)}(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let i=null;if(r>0){No(1===r);const e=n.from[0];e.allDescendants?i=e.collectionId:t=t.child(e.collectionId)}let s=[];n.where&&(s=function(e){const t=dh(e);return t instanceof iu&&au(t)?t.getFilters():[t]}(n.where));let a=[];n.orderBy&&(a=function(e){return e.map((e=>function(e){return new eu(yh(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)))}(n.orderBy));let o=null;n.limit&&(o=function(e){let t;return t="object"==typeof e?e.value:e,hc(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function(e){const t=!!e.before,n=e.values||[];return new Qc(n,t)}(n.startAt));let u=null;return n.endAt&&(u=function(e){const t=!e.before,n=e.values||[];return new Qc(n,t)}(n.endAt)),function(e,t,n,r,i,s,a,o){return new ku(e,t,n,r,i,"F",a,o)}(t,i,a,s,o,0,c,u)}function dh(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=yh(e.unaryFilter.field);return ru.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=yh(e.unaryFilter.field);return ru.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=yh(e.unaryFilter.field);return ru.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=yh(e.unaryFilter.field);return ru.create(i,"!=",{nullValue:"NULL_VALUE"});default:return Co()}}(e):void 0!==e.fieldFilter?function(e){return ru.create(yh(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Co()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return iu.create(e.compositeFilter.filters.map((e=>dh(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return Co()}}(e.compositeFilter.op))}(e):Co()}function fh(e){return Hl[e]}function ph(e){return Kl[e]}function mh(e){return Wl[e]}function gh(e){return{fieldPath:e.canonicalString()}}function yh(e){return ec.fromServerFormat(e.fieldPath)}function vh(e){return e instanceof ru?function(e){if("=="===e.op){if(qc(e.value))return{unaryFilter:{field:gh(e.field),op:"IS_NAN"}};if(zc(e.value))return{unaryFilter:{field:gh(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(qc(e.value))return{unaryFilter:{field:gh(e.field),op:"IS_NOT_NAN"}};if(zc(e.value))return{unaryFilter:{field:gh(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:gh(e.field),op:ph(e.op),value:e.value}}}(e):e instanceof iu?function(e){const t=e.getFilters().map((e=>vh(e)));return 1===t.length?t[0]:{compositeFilter:{op:mh(e.op),filters:t}}}(e):Co()}function _h(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function wh(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class bh{constructor(e,t,n,r,i=Jo.min(),s=Jo.min(),a=kc.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new bh(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new bh(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new bh(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new bh(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Eh{constructor(e){this.ct=e}}function kh(e){const t=hh({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Au(t,t.limit,"L"):t}class Sh{constructor(){}Pt(e,t){this.It(e,t),t.Tt()}It(e,t){if("nullValue"in e)this.Et(t,5);else if("booleanValue"in e)this.Et(t,10),t.dt(e.booleanValue?1:0);else if("integerValue"in e)this.Et(t,15),t.dt(Ic(e.integerValue));else if("doubleValue"in e){const n=Ic(e.doubleValue);isNaN(n)?this.Et(t,13):(this.Et(t,15),dc(n)?t.dt(0):t.dt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.Et(t,20),"string"==typeof n&&(n=Tc(n)),t.At(`${n.seconds||""}`),t.dt(n.nanos||0)}else if("stringValue"in e)this.Rt(e.stringValue,t),this.Vt(t);else if("bytesValue"in e)this.Et(t,30),t.ft(Oc(e.bytesValue)),this.Vt(t);else if("referenceValue"in e)this.gt(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.Et(t,45),t.dt(n.latitude||0),t.dt(n.longitude||0)}else"mapValue"in e?Wc(e)?this.Et(t,Number.MAX_SAFE_INTEGER):(this.yt(e.mapValue,t),this.Vt(t)):"arrayValue"in e?(this.wt(e.arrayValue,t),this.Vt(t)):Co()}Rt(e,t){this.Et(t,25),this.St(e,t)}St(e,t){t.At(e)}yt(e,t){const n=e.fields||{};this.Et(t,55);for(const e of Object.keys(n))this.Rt(e,t),this.It(n[e],t)}wt(e,t){const n=e.values||[];this.Et(t,50);for(const e of n)this.It(e,t)}gt(e,t){this.Et(t,37),tc.fromName(e).path.forEach((e=>{this.Et(t,60),this.St(e,t)}))}Et(e,t){e.dt(t)}Vt(e){e.dt(2)}}Sh.bt=new Sh;class Th{constructor(){this._n=new Ih}addToCollectionParentIndex(e,t){return this._n.add(t),cc.resolve()}getCollectionParents(e,t){return cc.resolve(this._n.getEntries(t))}addFieldIndex(e,t){return cc.resolve()}deleteFieldIndex(e,t){return cc.resolve()}deleteAllFieldIndexes(e){return cc.resolve()}createTargetIndexes(e,t){return cc.resolve()}getDocumentsMatchingTarget(e,t){return cc.resolve(null)}getIndexType(e,t){return cc.resolve(0)}getFieldIndexes(e,t){return cc.resolve([])}getNextCollectionGroupToUpdate(e){return cc.resolve(null)}getMinOffset(e,t){return cc.resolve(rc.min())}getMinOffsetFromCollectionGroup(e,t){return cc.resolve(rc.min())}updateCollectionGroup(e,t,n){return cc.resolve()}updateIndexEntries(e,t){return cc.resolve()}}class Ih{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new _c(Xo.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new _c(Xo.comparator)).toArray()}}new Uint8Array(0);class Oh{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Oh(e,Oh.DEFAULT_COLLECTION_PERCENTILE,Oh.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}Oh.DEFAULT_COLLECTION_PERCENTILE=10,Oh.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Oh.DEFAULT=new Oh(41943040,Oh.DEFAULT_COLLECTION_PERCENTILE,Oh.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Oh.DISABLED=new Oh(-1,0,0);class Ah{constructor(e){this.On=e}next(){return this.On+=2,this.On}static Nn(){return new Ah(0)}static Ln(){return new Ah(-1)}}class xh{constructor(){this.changes=new Lu((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Jc.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?cc.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Ph{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Ch{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&pl(n.mutation,e,bc.empty(),Zo.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,Ku()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=Ku()){const r=Bu();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=Uu();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=Bu();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,Ku())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let i=Mu();const s=zu(),a=zu();return t.forEach(((e,t)=>{const a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof vl)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),pl(a.mutation,t,a.mutation.getFieldMask(),Zo.now())):s.set(t.key,bc.empty())})),this.recalculateAndSaveOverlays(e,i).next((e=>(e.forEach(((e,t)=>s.set(e,t))),t.forEach(((e,t)=>{var n;return a.set(e,new Ph(t,null!==(n=s.get(e))&&void 0!==n?n:null))})),a)))}recalculateAndSaveOverlays(e,t){const n=zu();let r=new gc(((e,t)=>e-t)),i=Ku();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const i of e)i.keys().forEach((e=>{const s=t.get(e);if(null===s)return;let a=n.get(e)||bc.empty();a=i.applyToLocalView(s,a),n.set(e,a);const o=(r.get(i.batchId)||Ku()).add(e);r=r.insert(i.batchId,o)}))})).next((()=>{const s=[],a=r.getReverseIterator();for(;a.hasNext();){const r=a.getNext(),o=r.key,c=r.value,u=Vu();c.forEach((e=>{if(!i.has(e)){const r=dl(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}})),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return cc.waitFor(s)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n,r){return function(e){return tc.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):function(e){return null!==e.collectionGroup}(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((i=>{const s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):cc.resolve(Bu());let a=-1,o=i;return s.next((t=>cc.forEach(t,((t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?cc.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{o=o.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,i))).next((()=>this.computeViews(e,o,t,Ku()))).next((e=>({batchId:a,changes:Fu(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new tc(t)).next((e=>{let t=Uu();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){const i=t.collectionGroup;let s=Uu();return this.indexManager.getCollectionParents(e,i).next((a=>cc.forEach(a,(a=>{const o=function(e,t){return new ku(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,a.child(i));return this.getDocumentsMatchingCollectionQuery(e,o,n,r).next((e=>{e.forEach(((e,t)=>{s=s.insert(e,t)}))}))})).next((()=>s))))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r)))).next((e=>{i.forEach(((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,Jc.newInvalidDocument(r)))}));let n=Uu();return e.forEach(((e,r)=>{const s=i.get(e);void 0!==s&&pl(s.mutation,r,bc.empty(),Zo.now()),Nu(t,r)&&(n=n.insert(e,r))})),n}))}}class Nh{constructor(e){this.serializer=e,this.cr=new Map,this.lr=new Map}getBundleMetadata(e,t){return cc.resolve(this.cr.get(t))}saveBundleMetadata(e,t){return this.cr.set(t.id,function(e){return{id:e.id,version:e.version,createTime:Yl(e.createTime)}}(t)),cc.resolve()}getNamedQuery(e,t){return cc.resolve(this.lr.get(t))}saveNamedQuery(e,t){return this.lr.set(t.name,function(e){return{name:e.name,query:kh(e.bundledQuery),readTime:Yl(e.readTime)}}(t)),cc.resolve()}}class Rh{constructor(){this.overlays=new gc(tc.comparator),this.hr=new Map}getOverlay(e,t){return cc.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Bu();return cc.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.ht(e,t,r)})),cc.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.hr.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.hr.delete(n)),cc.resolve()}getOverlaysForCollection(e,t,n){const r=Bu(),i=t.length+1,s=new tc(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){const e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return cc.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new gc(((e,t)=>e-t));const s=this.overlays.getIterator();for(;s.hasNext();){const e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=Bu(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const a=Bu(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach(((e,t)=>a.set(e,t))),!(a.size()>=r)););return cc.resolve(a)}ht(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.hr.get(r.largestBatchId).delete(n.key);this.hr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Il(t,n));let i=this.hr.get(t);void 0===i&&(i=Ku(),this.hr.set(t,i)),this.hr.set(t,i.add(n.key))}}class jh{constructor(){this.Pr=new _c(Lh.Ir),this.Tr=new _c(Lh.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(e,t){const n=new Lh(e,t);this.Pr=this.Pr.add(n),this.Tr=this.Tr.add(n)}dr(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.Ar(new Lh(e,t))}Rr(e,t){e.forEach((e=>this.removeReference(e,t)))}Vr(e){const t=new tc(new Xo([])),n=new Lh(t,e),r=new Lh(t,e+1),i=[];return this.Tr.forEachInRange([n,r],(e=>{this.Ar(e),i.push(e.key)})),i}mr(){this.Pr.forEach((e=>this.Ar(e)))}Ar(e){this.Pr=this.Pr.delete(e),this.Tr=this.Tr.delete(e)}gr(e){const t=new tc(new Xo([])),n=new Lh(t,e),r=new Lh(t,e+1);let i=Ku();return this.Tr.forEachInRange([n,r],(e=>{i=i.add(e.key)})),i}containsKey(e){const t=new Lh(e,0),n=this.Pr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Lh{constructor(e,t){this.key=e,this.pr=t}static Ir(e,t){return tc.comparator(e.key,t.key)||Wo(e.pr,t.pr)}static Er(e,t){return Wo(e.pr,t.pr)||tc.comparator(e.key,t.key)}}class Dh{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.yr=1,this.wr=new _c(Lh.Ir)}checkEmpty(e){return cc.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const i=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const s=new Sl(i,t,n,r);this.mutationQueue.push(s);for(const t of r)this.wr=this.wr.add(new Lh(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return cc.resolve(s)}lookupMutationBatch(e,t){return cc.resolve(this.Sr(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.br(n),i=r<0?0:r;return cc.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)}getHighestUnacknowledgedBatchId(){return cc.resolve(0===this.mutationQueue.length?-1:this.yr-1)}getAllMutationBatches(e){return cc.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Lh(t,0),r=new Lh(t,Number.POSITIVE_INFINITY),i=[];return this.wr.forEachInRange([n,r],(e=>{const t=this.Sr(e.pr);i.push(t)})),cc.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new _c(Wo);return t.forEach((e=>{const t=new Lh(e,0),r=new Lh(e,Number.POSITIVE_INFINITY);this.wr.forEachInRange([t,r],(e=>{n=n.add(e.pr)}))})),cc.resolve(this.Dr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let i=n;tc.isDocumentKey(i)||(i=i.child(""));const s=new Lh(new tc(i),0);let a=new _c(Wo);return this.wr.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.pr)),!0)}),s),cc.resolve(this.Dr(a))}Dr(e){const t=[];return e.forEach((e=>{const n=this.Sr(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){No(0===this.Cr(t.batchId,"removed")),this.mutationQueue.shift();let n=this.wr;return cc.forEach(t.mutations,(r=>{const i=new Lh(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.wr=n}))}Mn(e){}containsKey(e,t){const n=new Lh(t,0),r=this.wr.firstAfterOrEqual(n);return cc.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,cc.resolve()}Cr(e,t){return this.br(e)}br(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Sr(e){const t=this.br(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Mh{constructor(e){this.vr=e,this.docs=new gc(tc.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.vr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return cc.resolve(n?n.document.mutableCopy():Jc.newInvalidDocument(t))}getEntries(e,t){let n=Mu();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Jc.newInvalidDocument(e))})),cc.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=Mu();const s=t.path,a=new tc(s.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){const{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||ic(nc(a),n)<=0||(r.has(a.key)||Nu(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return cc.resolve(i)}getAllFromCollectionGroup(e,t,n,r){Co()}Fr(e,t){return cc.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new $h(this)}getSize(e){return cc.resolve(this.size)}}class $h extends xh{constructor(e){super(),this.ar=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.ar.addEntry(e,r)):this.ar.removeEntry(n)})),cc.waitFor(t)}getFromCache(e,t){return this.ar.getEntry(e,t)}getAllFromCache(e,t){return this.ar.getEntries(e,t)}}class Uh{constructor(e){this.persistence=e,this.Mr=new Lu((e=>wu(e)),bu),this.lastRemoteSnapshotVersion=Jo.min(),this.highestTargetId=0,this.Or=0,this.Nr=new jh,this.targetCount=0,this.Lr=Ah.Nn()}forEachTarget(e,t){return this.Mr.forEach(((e,n)=>t(n))),cc.resolve()}getLastRemoteSnapshotVersion(e){return cc.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return cc.resolve(this.Or)}allocateTargetId(e){return this.highestTargetId=this.Lr.next(),cc.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Or&&(this.Or=t),cc.resolve()}qn(e){this.Mr.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Lr=new Ah(t),this.highestTargetId=t),e.sequenceNumber>this.Or&&(this.Or=e.sequenceNumber)}addTargetData(e,t){return this.qn(t),this.targetCount+=1,cc.resolve()}updateTargetData(e,t){return this.qn(t),cc.resolve()}removeTargetData(e,t){return this.Mr.delete(t.target),this.Nr.Vr(t.targetId),this.targetCount-=1,cc.resolve()}removeTargets(e,t,n){let r=0;const i=[];return this.Mr.forEach(((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.Mr.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)})),cc.waitFor(i).next((()=>r))}getTargetCount(e){return cc.resolve(this.targetCount)}getTargetData(e,t){const n=this.Mr.get(t)||null;return cc.resolve(n)}addMatchingKeys(e,t,n){return this.Nr.dr(t,n),cc.resolve()}removeMatchingKeys(e,t,n){this.Nr.Rr(t,n);const r=this.persistence.referenceDelegate,i=[];return r&&t.forEach((t=>{i.push(r.markPotentiallyOrphaned(e,t))})),cc.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Nr.Vr(t),cc.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Nr.gr(t);return cc.resolve(n)}containsKey(e,t){return cc.resolve(this.Nr.containsKey(t))}}class Fh{constructor(e,t){this.Br={},this.overlays={},this.kr=new lc(0),this.qr=!1,this.qr=!0,this.referenceDelegate=e(this),this.Qr=new Uh(this),this.indexManager=new Th,this.remoteDocumentCache=function(e){return new Mh(e)}((e=>this.referenceDelegate.Kr(e))),this.serializer=new Eh(t),this.$r=new Nh(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Rh,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Br[e.toKey()];return n||(n=new Dh(t,this.referenceDelegate),this.Br[e.toKey()]=n),n}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(e,t,n){Oo("MemoryPersistence","Starting transaction:",e);const r=new Bh(this.kr.next());return this.referenceDelegate.Ur(),n(r).next((e=>this.referenceDelegate.Wr(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Gr(e,t){return cc.or(Object.values(this.Br).map((n=>()=>n.containsKey(e,t))))}}class Bh extends ac{constructor(e){super(),this.currentSequenceNumber=e}}class Vh{constructor(e){this.persistence=e,this.zr=new jh,this.jr=null}static Hr(e){return new Vh(e)}get Jr(){if(this.jr)return this.jr;throw Co()}addReference(e,t,n){return this.zr.addReference(n,t),this.Jr.delete(n.toString()),cc.resolve()}removeReference(e,t,n){return this.zr.removeReference(n,t),this.Jr.add(n.toString()),cc.resolve()}markPotentiallyOrphaned(e,t){return this.Jr.add(t.toString()),cc.resolve()}removeTarget(e,t){this.zr.Vr(t.targetId).forEach((e=>this.Jr.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Jr.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Ur(){this.jr=new Set}Wr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return cc.forEach(this.Jr,(n=>{const r=tc.fromPath(n);return this.Yr(e,r).next((e=>{e||t.removeEntry(r,Jo.min())}))})).next((()=>(this.jr=null,t.apply(e))))}updateLimboDocument(e,t){return this.Yr(e,t).next((e=>{e?this.Jr.delete(t.toString()):this.Jr.add(t.toString())}))}Kr(e){return 0}Yr(e,t){return cc.or([()=>cc.resolve(this.zr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gr(e,t)])}}class zh{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.qi=n,this.Qi=r}static Ki(e,t){let n=Ku(),r=Ku();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new zh(e,t.fromCache,n,r)}}class qh{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class Hh{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=!function(){var e;const t=null===(e=vn())||void 0===e?void 0:e.forceEnvironment;if("node"===t)return!0;if("browser"===t)return!1;try{return"[object process]"===Object.prototype.toString.call(s.g.process)}catch(e){return!1}}()&&navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")?8:function(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}(Sn())>0?6:4}initialize(e,t){this.zi=e,this.indexManager=t,this.$i=!0}getDocumentsMatchingQuery(e,t,n,r){const i={result:null};return this.ji(e,t).next((e=>{i.result=e})).next((()=>{if(!i.result)return this.Hi(e,t,r,n).next((e=>{i.result=e}))})).next((()=>{if(i.result)return;const n=new qh;return this.Ji(e,t,n).next((r=>{if(i.result=r,this.Ui)return this.Yi(e,t,n,r.size)}))})).next((()=>i.result))}Yi(e,t,n,r){return n.documentReadCount<this.Wi?(Io()<=Bn.DEBUG&&Oo("QueryEngine","SDK will not create cache indexes for query:",Cu(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),cc.resolve()):(Io()<=Bn.DEBUG&&Oo("QueryEngine","Query:",Cu(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Gi*r?(Io()<=Bn.DEBUG&&Oo("QueryEngine","The SDK decides to create cache indexes for query:",Cu(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,Ou(t))):cc.resolve())}ji(e,t){if(Tu(t))return cc.resolve(null);let n=Ou(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=Au(t,null,"F"),n=Ou(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const i=Ku(...r);return this.zi.getDocuments(e,i).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{const s=this.Zi(t,r);return this.Xi(t,s,i,n.readTime)?this.ji(e,Au(t,null,"F")):this.es(e,s,t,n)}))))})))))}Hi(e,t,n,r){return Tu(t)||r.isEqual(Jo.min())?cc.resolve(null):this.zi.getDocuments(e,n).next((i=>{const s=this.Zi(t,i);return this.Xi(t,s,n,r)?cc.resolve(null):(Io()<=Bn.DEBUG&&Oo("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),Cu(t)),this.es(e,s,t,function(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,i=Jo.fromTimestamp(1e9===r?new Zo(n+1,0):new Zo(n,r));return new rc(i,tc.empty(),-1)}(r)).next((e=>e)))}))}Zi(e,t){let n=new _c(Ru(e));return t.forEach(((t,r)=>{Nu(e,r)&&(n=n.add(r))})),n}Xi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}Ji(e,t,n){return Io()<=Bn.DEBUG&&Oo("QueryEngine","Using full collection scan to execute query:",Cu(t)),this.zi.getDocumentsMatchingQuery(e,t,rc.min(),n)}es(e,t,n,r){return this.zi.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class Kh{constructor(e,t,n,r){this.persistence=e,this.ts=t,this.serializer=r,this.ns=new gc(Wo),this.rs=new Lu((e=>wu(e)),bu),this.ss=new Map,this.os=e.getRemoteDocumentCache(),this.Qr=e.getTargetCache(),this.$r=e.getBundleCache(),this._s(n)}_s(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Ch(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.ns)))}}async function Wh(e,t){const n=Ro(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((i=>(r=i,n._s(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const i=[],s=[];let a=Ku();for(const e of r){i.push(e.batchId);for(const t of e.mutations)a=a.add(t.key)}for(const e of t){s.push(e.batchId);for(const t of e.mutations)a=a.add(t.key)}return n.localDocuments.getDocuments(e,a).next((e=>({us:e,removedBatchIds:i,addedBatchIds:s})))}))}))}function Gh(e){const t=Ro(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Qr.getLastRemoteSnapshotVersion(e)))}function Zh(e,t){const n=Ro(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}async function Jh(e,t,n){const r=Ro(e),i=r.ns.get(t),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,(e=>r.persistence.referenceDelegate.removeTarget(e,i)))}catch(e){if(!uc(e))throw e;Oo("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.ns=r.ns.remove(t),r.rs.delete(i.target)}function Qh(e,t,n){const r=Ro(e);let i=Jo.min(),s=Ku();return r.persistence.runTransaction("Execute query","readwrite",(e=>function(e,t,n){const r=Ro(e),i=r.rs.get(n);return void 0!==i?cc.resolve(r.ns.get(i)):r.Qr.getTargetData(t,n)}(r,e,Ou(t)).next((t=>{if(t)return i=t.lastLimboFreeSnapshotVersion,r.Qr.getMatchingKeysForTargetId(e,t.targetId).next((e=>{s=e}))})).next((()=>r.ts.getDocumentsMatchingQuery(e,t,n?i:Jo.min(),n?s:Ku()))).next((e=>(function(e,t,n){let r=e.ss.get(t)||Jo.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.ss.set(t,r)}(r,function(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}(t),e),{documents:e,hs:s})))))}class Xh{constructor(){this.activeTargetIds=Wu}As(e){this.activeTargetIds=this.activeTargetIds.add(e)}Rs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}ds(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Yh{constructor(){this.no=new Xh,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.no.As(e),this.ro[e]||"not-current"}updateQueryState(e,t,n){this.ro[e]=t}removeLocalQueryTarget(e){this.no.Rs(e)}isLocalQueryTarget(e){return this.no.activeTargetIds.has(e)}clearQueryState(e){delete this.ro[e]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(e){return this.no.activeTargetIds.has(e)}start(){return this.no=new Xh,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class ed{io(e){}shutdown(){}}class td{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(e){this.uo.push(e)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){Oo("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.uo)e(0)}ao(){Oo("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.uo)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let nd=null;function rd(){return null===nd?nd=268435456+Math.round(2147483648*Math.random()):nd++,"0x"+nd.toString(16)}const id={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class sd{constructor(e){this.lo=e.lo,this.ho=e.ho}Po(e){this.Io=e}To(e){this.Eo=e}Ao(e){this.Ro=e}onMessage(e){this.Vo=e}close(){this.ho()}send(e){this.lo(e)}mo(){this.Io()}fo(){this.Eo()}po(e){this.Ro(e)}yo(e){this.Vo(e)}}const ad="WebChannelConnection";class od extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.wo=t+"://"+e.host,this.So=`projects/${n}/databases/${r}`,this.bo="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get Do(){return!1}Co(e,t,n,r,i){const s=rd(),a=this.vo(e,t.toUriEncodedString());Oo("RestConnection",`Sending RPC '${e}' ${s}:`,a,n);const o={"google-cloud-resource-prefix":this.So,"x-goog-request-params":this.bo};return this.Fo(o,r,i),this.Mo(e,a,o,n).then((t=>(Oo("RestConnection",`Received RPC '${e}' ${s}: `,t),t)),(t=>{throw xo("RestConnection",`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t}))}xo(e,t,n,r,i,s){return this.Co(e,t,n,r,i)}Fo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+So,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}vo(e,t){const n=id[e];return`${this.wo}/v1/${t}:${n}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Mo(e,t,n,r){const i=rd();return new Promise(((s,a)=>{const o=new lo;o.setWithCredentials(!0),o.listenOnce(po.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case mo.NO_ERROR:const t=o.getResponseJson();Oo(ad,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case mo.TIMEOUT:Oo(ad,`RPC '${e}' ${i} timed out`),a(new Lo(jo.DEADLINE_EXCEEDED,"Request time out"));break;case mo.HTTP_ERROR:const n=o.getStatus();if(Oo(ad,`RPC '${e}' ${i} failed with status:`,n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(jo).indexOf(t)>=0?t:jo.UNKNOWN}(t.status);a(new Lo(e,t.message))}else a(new Lo(jo.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new Lo(jo.UNAVAILABLE,"Connection failed."));break;default:Co()}}finally{Oo(ad,`RPC '${e}' ${i} completed.`)}}));const c=JSON.stringify(r);Oo(ad,`RPC '${e}' ${i} sending request:`,r),o.send(t,"POST",c,n,15)}))}Oo(e,t,n){const r=rd(),i=[this.wo,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=_o(),a=vo(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;void 0!==c&&(o.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(o.xmlHttpFactory=new ho({})),this.Fo(o.initMessageHeaders,t,n),o.encodeInitMessageHeaders=!0;const u=i.join("");Oo(ad,`Creating RPC '${e}' stream ${r}: ${u}`,o);const l=s.createWebChannel(u,o);let h=!1,d=!1;const f=new sd({lo:t=>{d?Oo(ad,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(h||(Oo(ad,`Opening RPC '${e}' stream ${r} transport.`),l.open(),h=!0),Oo(ad,`RPC '${e}' stream ${r} sending:`,t),l.send(t))},ho:()=>l.close()}),p=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return p(l,fo.EventType.OPEN,(()=>{d||(Oo(ad,`RPC '${e}' stream ${r} transport opened.`),f.mo())})),p(l,fo.EventType.CLOSE,(()=>{d||(d=!0,Oo(ad,`RPC '${e}' stream ${r} transport closed`),f.po())})),p(l,fo.EventType.ERROR,(t=>{d||(d=!0,xo(ad,`RPC '${e}' stream ${r} transport errored:`,t),f.po(new Lo(jo.UNAVAILABLE,"The operation could not be completed")))})),p(l,fo.EventType.MESSAGE,(t=>{var n;if(!d){const i=t.data[0];No(!!i);const s=i,a=s.error||(null===(n=s[0])||void 0===n?void 0:n.error);if(a){Oo(ad,`RPC '${e}' stream ${r} received error:`,a);const t=a.status;let n=function(e){const t=Al[e];if(void 0!==t)return Pl(t)}(t),i=a.message;void 0===n&&(n=jo.INTERNAL,i="Unknown error status: "+t+" with message "+a.message),d=!0,f.po(new Lo(n,i)),l.close()}else Oo(ad,`RPC '${e}' stream ${r} received:`,i),f.yo(i)}})),p(a,yo.STAT_EVENT,(t=>{t.stat===go.PROXY?Oo(ad,`RPC '${e}' stream ${r} detected buffering proxy`):t.stat===go.NOPROXY&&Oo(ad,`RPC '${e}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{f.fo()}),0),f}}function cd(){return"undefined"!=typeof document?document:null}function ud(e){return new Gl(e,!0)}class ld{constructor(e,t,n=1e3,r=1.5,i=6e4){this.oi=e,this.timerId=t,this.No=n,this.Lo=r,this.Bo=i,this.ko=0,this.qo=null,this.Qo=Date.now(),this.reset()}reset(){this.ko=0}Ko(){this.ko=this.Bo}$o(e){this.cancel();const t=Math.floor(this.ko+this.Uo()),n=Math.max(0,Date.now()-this.Qo),r=Math.max(0,t-n);r>0&&Oo("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.ko} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.qo=this.oi.enqueueAfterDelay(this.timerId,r,(()=>(this.Qo=Date.now(),e()))),this.ko*=this.Lo,this.ko<this.No&&(this.ko=this.No),this.ko>this.Bo&&(this.ko=this.Bo)}Wo(){null!==this.qo&&(this.qo.skipDelay(),this.qo=null)}cancel(){null!==this.qo&&(this.qo.cancel(),this.qo=null)}Uo(){return(Math.random()-.5)*this.ko}}class hd{constructor(e,t,n,r,i,s,a,o){this.oi=e,this.Go=n,this.zo=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.jo=0,this.Ho=null,this.Jo=null,this.stream=null,this.Yo=new ld(e,t)}Zo(){return 1===this.state||5===this.state||this.Xo()}Xo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.e_()}async stop(){this.Zo()&&await this.close(0)}t_(){this.state=0,this.Yo.reset()}n_(){this.Xo()&&null===this.Ho&&(this.Ho=this.oi.enqueueAfterDelay(this.Go,6e4,(()=>this.r_())))}i_(e){this.s_(),this.stream.send(e)}async r_(){if(this.Xo())return this.close(0)}s_(){this.Ho&&(this.Ho.cancel(),this.Ho=null)}o_(){this.Jo&&(this.Jo.cancel(),this.Jo=null)}async close(e,t){this.s_(),this.o_(),this.Yo.cancel(),this.jo++,4!==e?this.Yo.reset():t&&t.code===jo.RESOURCE_EXHAUSTED?(Ao(t.toString()),Ao("Using maximum backoff delay to prevent overloading the backend."),this.Yo.Ko()):t&&t.code===jo.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.__(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Ao(t)}__(){}auth(){this.state=1;const e=this.a_(this.jo),t=this.jo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.jo===t&&this.u_(e,n)}),(t=>{e((()=>{const e=new Lo(jo.UNKNOWN,"Fetching auth token failed: "+t.message);return this.c_(e)}))}))}u_(e,t){const n=this.a_(this.jo);this.stream=this.l_(e,t),this.stream.Po((()=>{n((()=>this.listener.Po()))})),this.stream.To((()=>{n((()=>(this.state=2,this.Jo=this.oi.enqueueAfterDelay(this.zo,1e4,(()=>(this.Xo()&&(this.state=3),Promise.resolve()))),this.listener.To())))})),this.stream.Ao((e=>{n((()=>this.c_(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}e_(){this.state=5,this.Yo.$o((async()=>{this.state=0,this.start()}))}c_(e){return Oo("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}a_(e){return t=>{this.oi.enqueueAndForget((()=>this.jo===e?t():(Oo("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class dd extends hd{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}l_(e,t){return this.connection.Oo("Listen",e,t)}onMessage(e){this.Yo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:Co()}(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],s=function(e,t){return e.useProto3Json?(No(void 0===t||"string"==typeof t),kc.fromBase64String(t||"")):(No(void 0===t||t instanceof Buffer||t instanceof Uint8Array),kc.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),a=t.targetChange.cause,o=a&&function(e){const t=void 0===e.code?jo.UNKNOWN:Pl(e.code);return new Lo(t,e.message||"")}(a);n=new Fl(r,i,s,o||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const i=ih(e,r.document.name),s=Yl(r.document.updateTime),a=r.document.createTime?Yl(r.document.createTime):Jo.min(),o=new Gc({mapValue:{fields:r.document.fields}}),c=Jc.newFoundDocument(i,s,a,o),u=r.targetIds||[],l=r.removedTargetIds||[];n=new $l(u,l,c.key,c)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const i=ih(e,r.document),s=r.readTime?Yl(r.readTime):Jo.min(),a=Jc.newNoDocument(i,s),o=r.removedTargetIds||[];n=new $l([],o,a.key,a)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const i=ih(e,r.document),s=r.removedTargetIds||[];n=new $l([],s,i,null)}else{if(!("filter"in t))return Co();{t.filter;const e=t.filter;e.targetId;const{count:r=0,unchangedNames:i}=e,s=new Ol(r,i),a=e.targetId;n=new Ul(a,s)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return Jo.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?Jo.min():t.readTime?Yl(t.readTime):Jo.min()}(e);return this.listener.h_(t,n)}P_(e){const t={};t.database=ah(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=Eu(r)?{documents:uh(e,r)}:{query:lh(e,r)._t},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=Ql(e,t.resumeToken);const r=Zl(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(Jo.min())>0){n.readTime=Jl(e,t.snapshotVersion.toTimestamp());const r=Zl(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);const n=function(e,t){const n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Co()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.i_(t)}I_(e){const t={};t.database=ah(this.serializer),t.removeTarget=e,this.i_(t)}}class fd extends hd{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i,this.T_=!1}get E_(){return this.T_}start(){this.T_=!1,this.lastStreamToken=void 0,super.start()}__(){this.T_&&this.d_([])}l_(e,t){return this.connection.Oo("Write",e,t)}onMessage(e){if(No(!!e.streamToken),this.lastStreamToken=e.streamToken,this.T_){this.Yo.reset();const t=function(e,t){return e&&e.length>0?(No(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?Yl(e.updateTime):Yl(t);return n.isEqual(Jo.min())&&(n=Yl(t)),new cl(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=Yl(e.commitTime);return this.listener.A_(n,t)}return No(!e.writeResults||0===e.writeResults.length),this.T_=!0,this.listener.R_()}V_(){const e={};e.database=ah(this.serializer),this.i_(e)}d_(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>function(e,t){let n;if(t instanceof yl)n={update:ch(e,t.key,t.value)};else if(t instanceof El)n={delete:rh(e,t.key)};else if(t instanceof vl)n={update:ch(e,t.key,t.data),updateMask:_h(t.fieldMask)};else{if(!(t instanceof kl))return Co();n={verify:rh(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof el)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof tl)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof rl)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof sl)return{fieldPath:t.field.canonicalString(),increment:n.Pe};throw Co()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:Xl(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:Co()}(e,t.precondition)),n}(this.serializer,e)))};this.i_(t)}}class pd extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.m_=!1}f_(){if(this.m_)throw new Lo(jo.FAILED_PRECONDITION,"The client has already been terminated.")}Co(e,t,n,r){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,s])=>this.connection.Co(e,th(t,n),r,i,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===jo.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Lo(jo.UNKNOWN,e.toString())}))}xo(e,t,n,r,i){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,a])=>this.connection.xo(e,th(t,n),r,s,a,i))).catch((e=>{throw"FirebaseError"===e.name?(e.code===jo.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Lo(jo.UNKNOWN,e.toString())}))}terminate(){this.m_=!0,this.connection.terminate()}}class md{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.g_=0,this.p_=null,this.y_=!0}w_(){0===this.g_&&(this.S_("Unknown"),this.p_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.p_=null,this.b_("Backend didn't respond within 10 seconds."),this.S_("Offline"),Promise.resolve()))))}D_(e){"Online"===this.state?this.S_("Unknown"):(this.g_++,this.g_>=1&&(this.C_(),this.b_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.S_("Offline")))}set(e){this.C_(),this.g_=0,"Online"===e&&(this.y_=!1),this.S_(e)}S_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}b_(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.y_?(Ao(t),this.y_=!1):Oo("OnlineStateTracker",t)}C_(){null!==this.p_&&(this.p_.cancel(),this.p_=null)}}class gd{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.v_=[],this.F_=new Map,this.M_=new Set,this.x_=[],this.O_=i,this.O_.io((e=>{n.enqueueAndForget((async()=>{Td(this)&&(Oo("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=Ro(e);t.M_.add(4),await vd(t),t.N_.set("Unknown"),t.M_.delete(4),await yd(t)}(this))}))})),this.N_=new md(n,r)}}async function yd(e){if(Td(e))for(const t of e.x_)await t(!0)}async function vd(e){for(const t of e.x_)await t(!1)}function _d(e,t){const n=Ro(e);n.F_.has(t.targetId)||(n.F_.set(t.targetId,t),Sd(n)?kd(n):zd(n).Xo()&&bd(n,t))}function wd(e,t){const n=Ro(e),r=zd(n);n.F_.delete(t),r.Xo()&&Ed(n,t),0===n.F_.size&&(r.Xo()?r.n_():Td(n)&&n.N_.set("Unknown"))}function bd(e,t){if(e.L_.xe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(Jo.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}zd(e).P_(t)}function Ed(e,t){e.L_.xe(t),zd(e).I_(t)}function kd(e){e.L_=new Vl({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>e.F_.get(t)||null,tt:()=>e.datastore.serializer.databaseId}),zd(e).start(),e.N_.w_()}function Sd(e){return Td(e)&&!zd(e).Zo()&&e.F_.size>0}function Td(e){return 0===Ro(e).M_.size}function Id(e){e.L_=void 0}async function Od(e){e.N_.set("Online")}async function Ad(e){e.F_.forEach(((t,n)=>{bd(e,t)}))}async function xd(e,t){Id(e),Sd(e)?(e.N_.D_(t),kd(e)):e.N_.set("Unknown")}async function Pd(e,t,n){if(e.N_.set("Online"),t instanceof Fl&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.F_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.F_.delete(r),e.L_.removeTarget(r))}(e,t)}catch(n){Oo("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Cd(e,n)}else if(t instanceof $l?e.L_.Ke(t):t instanceof Ul?e.L_.He(t):e.L_.We(t),!n.isEqual(Jo.min()))try{const t=await Gh(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.L_.rt(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const i=e.F_.get(r);i&&e.F_.set(r,i.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach(((t,n)=>{const r=e.F_.get(t);if(!r)return;e.F_.set(t,r.withResumeToken(kc.EMPTY_BYTE_STRING,r.snapshotVersion)),Ed(e,t);const i=new bh(r.target,t,n,r.sequenceNumber);bd(e,i)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){Oo("RemoteStore","Failed to raise snapshot:",t),await Cd(e,t)}}async function Cd(e,t,n){if(!uc(t))throw t;e.M_.add(1),await vd(e),e.N_.set("Offline"),n||(n=()=>Gh(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{Oo("RemoteStore","Retrying IndexedDB access"),await n(),e.M_.delete(1),await yd(e)}))}function Nd(e,t){return t().catch((n=>Cd(e,n,t)))}async function Rd(e){const t=Ro(e),n=qd(t);let r=t.v_.length>0?t.v_[t.v_.length-1].batchId:-1;for(;jd(t);)try{const e=await Zh(t.localStore,r);if(null===e){0===t.v_.length&&n.n_();break}r=e.batchId,Ld(t,e)}catch(e){await Cd(t,e)}Dd(t)&&Md(t)}function jd(e){return Td(e)&&e.v_.length<10}function Ld(e,t){e.v_.push(t);const n=qd(e);n.Xo()&&n.E_&&n.d_(t.mutations)}function Dd(e){return Td(e)&&!qd(e).Zo()&&e.v_.length>0}function Md(e){qd(e).start()}async function $d(e){qd(e).V_()}async function Ud(e){const t=qd(e);for(const n of e.v_)t.d_(n.mutations)}async function Fd(e,t,n){const r=e.v_.shift(),i=Tl.from(r,t,n);await Nd(e,(()=>e.remoteSyncer.applySuccessfulWrite(i))),await Rd(e)}async function Bd(e,t){t&&qd(e).E_&&await async function(e,t){if(function(e){return function(e){switch(e){default:return Co();case jo.CANCELLED:case jo.UNKNOWN:case jo.DEADLINE_EXCEEDED:case jo.RESOURCE_EXHAUSTED:case jo.INTERNAL:case jo.UNAVAILABLE:case jo.UNAUTHENTICATED:return!1;case jo.INVALID_ARGUMENT:case jo.NOT_FOUND:case jo.ALREADY_EXISTS:case jo.PERMISSION_DENIED:case jo.FAILED_PRECONDITION:case jo.ABORTED:case jo.OUT_OF_RANGE:case jo.UNIMPLEMENTED:case jo.DATA_LOSS:return!0}}(e)&&e!==jo.ABORTED}(t.code)){const n=e.v_.shift();qd(e).t_(),await Nd(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await Rd(e)}}(e,t),Dd(e)&&Md(e)}async function Vd(e,t){const n=Ro(e);n.asyncQueue.verifyOperationInProgress(),Oo("RemoteStore","RemoteStore received new credentials");const r=Td(n);n.M_.add(3),await vd(n),r&&n.N_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.M_.delete(3),await yd(n)}function zd(e){return e.B_||(e.B_=function(e,t,n){const r=Ro(e);return r.f_(),new dd(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Po:Od.bind(null,e),To:Ad.bind(null,e),Ao:xd.bind(null,e),h_:Pd.bind(null,e)}),e.x_.push((async t=>{t?(e.B_.t_(),Sd(e)?kd(e):e.N_.set("Unknown")):(await e.B_.stop(),Id(e))}))),e.B_}function qd(e){return e.k_||(e.k_=function(e,t,n){const r=Ro(e);return r.f_(),new fd(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Po:()=>Promise.resolve(),To:$d.bind(null,e),Ao:Bd.bind(null,e),R_:Ud.bind(null,e),A_:Fd.bind(null,e)}),e.x_.push((async t=>{t?(e.k_.t_(),await Rd(e)):(await e.k_.stop(),e.v_.length>0&&(Oo("RemoteStore",`Stopping write stream with ${e.v_.length} pending writes`),e.v_=[]))}))),e.k_}class Hd{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Do,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){const s=Date.now()+n,a=new Hd(e,t,s,r,i);return a.start(n),a}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Lo(jo.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Kd(e,t){if(Ao("AsyncQueue",`${t}: ${e}`),uc(e))return new Lo(jo.UNAVAILABLE,`${t}: ${e}`);throw e}class Wd{constructor(e){this.comparator=e?(t,n)=>e(t,n)||tc.comparator(t.key,n.key):(e,t)=>tc.comparator(e.key,t.key),this.keyedMap=Uu(),this.sortedSet=new gc(this.comparator)}static emptySet(e){return new Wd(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Wd))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new Wd;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Gd{constructor(){this.q_=new gc(tc.comparator)}track(e){const t=e.doc.key,n=this.q_.get(t);n?0!==e.type&&3===n.type?this.q_=this.q_.insert(t,e):3===e.type&&1!==n.type?this.q_=this.q_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.q_=this.q_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.q_=this.q_.remove(t):1===e.type&&2===n.type?this.q_=this.q_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):Co():this.q_=this.q_.insert(t,e)}Q_(){const e=[];return this.q_.inorderTraversal(((t,n)=>{e.push(n)})),e}}class Zd{constructor(e,t,n,r,i,s,a,o,c){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=c}static fromInitialDocuments(e,t,n,r,i){const s=[];return t.forEach((e=>{s.push({type:0,doc:e})})),new Zd(e,t,Wd.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&xu(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class Jd{constructor(){this.K_=void 0,this.U_=[]}W_(){return this.U_.some((e=>e.G_()))}}class Qd{constructor(){this.queries=new Lu((e=>Pu(e)),xu),this.onlineState="Unknown",this.z_=new Set}}function Xd(e,t){const n=Ro(e);let r=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.U_)t.H_(e)&&(r=!0);i.K_=e}}r&&ef(n)}function Yd(e,t,n){const r=Ro(e),i=r.queries.get(t);if(i)for(const e of i.U_)e.onError(n);r.queries.delete(t)}function ef(e){e.z_.forEach((e=>{e.next()}))}var tf,nf;(nf=tf||(tf={})).J_="default",nf.Cache="cache";class rf{constructor(e,t,n){this.query=e,this.Y_=t,this.Z_=!1,this.X_=null,this.onlineState="Unknown",this.options=n||{}}H_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new Zd(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Z_?this.ea(e)&&(this.Y_.next(e),t=!0):this.ta(e,this.onlineState)&&(this.na(e),t=!0),this.X_=e,t}onError(e){this.Y_.error(e)}j_(e){this.onlineState=e;let t=!1;return this.X_&&!this.Z_&&this.ta(this.X_,e)&&(this.na(this.X_),t=!0),t}ta(e,t){if(!e.fromCache)return!0;if(!this.G_())return!0;const n="Offline"!==t;return(!this.options.ra||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}ea(e){if(e.docChanges.length>0)return!0;const t=this.X_&&this.X_.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}na(e){e=Zd.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Z_=!0,this.Y_.next(e)}G_(){return this.options.source!==tf.Cache}}class sf{constructor(e){this.key=e}}class af{constructor(e){this.key=e}}class of{constructor(e,t){this.query=e,this.la=t,this.ha=null,this.hasCachedResults=!1,this.current=!1,this.Pa=Ku(),this.mutatedKeys=Ku(),this.Ia=Ru(e),this.Ta=new Wd(this.Ia)}get Ea(){return this.la}da(e,t){const n=t?t.Aa:new Gd,r=t?t.Ta:this.Ta;let i=t?t.mutatedKeys:this.mutatedKeys,s=r,a=!1;const o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,c="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const u=r.get(e),l=Nu(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;u&&l?u.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Ra(u,l)||(n.track({type:2,doc:l}),f=!0,(o&&this.Ia(l,o)>0||c&&this.Ia(l,c)<0)&&(a=!0)):!u&&l?(n.track({type:0,doc:l}),f=!0):u&&!l&&(n.track({type:1,doc:u}),f=!0,(o||c)&&(a=!0)),f&&(l?(s=s.add(l),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))})),null!==this.query.limit)for(;s.size>this.query.limit;){const e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{Ta:s,Aa:n,Xi:a,mutatedKeys:i}}Ra(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){const i=this.Ta;this.Ta=e.Ta,this.mutatedKeys=e.mutatedKeys;const s=e.Aa.Q_();s.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Co()}};return n(e)-n(t)}(e.type,t.type)||this.Ia(e.doc,t.doc))),this.Va(n),r=null!=r&&r;const a=t&&!r?this.ma():[],o=0===this.Pa.size&&this.current&&!r?1:0,c=o!==this.ha;return this.ha=o,0!==s.length||c?{snapshot:new Zd(this.query,e.Ta,i,s,e.mutatedKeys,0===o,c,!1,!!n&&n.resumeToken.approximateByteSize()>0),fa:a}:{fa:a}}j_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ta:this.Ta,Aa:new Gd,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{fa:[]}}ga(e){return!this.la.has(e)&&!!this.Ta.has(e)&&!this.Ta.get(e).hasLocalMutations}Va(e){e&&(e.addedDocuments.forEach((e=>this.la=this.la.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.la=this.la.delete(e))),this.current=e.current)}ma(){if(!this.current)return[];const e=this.Pa;this.Pa=Ku(),this.Ta.forEach((e=>{this.ga(e.key)&&(this.Pa=this.Pa.add(e.key))}));const t=[];return e.forEach((e=>{this.Pa.has(e)||t.push(new af(e))})),this.Pa.forEach((n=>{e.has(n)||t.push(new sf(n))})),t}pa(e){this.la=e.hs,this.Pa=Ku();const t=this.da(e.documents);return this.applyChanges(t,!0)}ya(){return Zd.fromInitialDocuments(this.query,this.Ta,this.mutatedKeys,0===this.ha,this.hasCachedResults)}}class cf{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class uf{constructor(e){this.key=e,this.wa=!1}}class lf{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Sa={},this.ba=new Lu((e=>Pu(e)),xu),this.Da=new Map,this.Ca=new Set,this.va=new gc(tc.comparator),this.Fa=new Map,this.Ma=new jh,this.xa={},this.Oa=new Map,this.Na=Ah.Ln(),this.onlineState="Unknown",this.La=void 0}get isPrimaryClient(){return!0===this.La}}async function hf(e,t,n=!0){const r=Cf(e);let i;const s=r.ba.get(t);return s?(r.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.ya()):i=await ff(r,t,n,!0),i}async function df(e,t){const n=Cf(e);await ff(n,t,!0,!1)}async function ff(e,t,n,r){const i=await function(e,t){const n=Ro(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Qr.getTargetData(e,t).next((i=>i?(r=i,cc.resolve(r)):n.Qr.allocateTargetId(e).next((i=>(r=new bh(t,i,"TargetPurposeListen",e.currentSequenceNumber),n.Qr.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.ns.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.ns=n.ns.insert(e.targetId,e),n.rs.set(t,e.targetId)),e}))}(e.localStore,Ou(t)),s=i.targetId,a=n?e.sharedClientState.addLocalQueryTarget(s):"not-current";let o;return r&&(o=await async function(e,t,n,r,i){e.Ba=(t,n,r)=>async function(e,t,n,r){let i=t.view.da(n);i.Xi&&(i=await Qh(e.localStore,t.query,!1).then((({documents:e})=>t.view.da(e,i))));const s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return Tf(e,t.targetId,o.fa),o.snapshot}(e,t,n,r);const s=await Qh(e.localStore,t,!0),a=new of(t,s.hs),o=a.da(s.documents),c=Ml.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,c);Tf(e,n,u.fa);const l=new cf(t,n,a);return e.ba.set(t,l),e.Da.has(n)?e.Da.get(n).push(t):e.Da.set(n,[t]),u.snapshot}(e,t,s,"current"===a,i.resumeToken)),e.isPrimaryClient&&n&&_d(e.remoteStore,i),o}async function pf(e,t,n){const r=Ro(e),i=r.ba.get(t),s=r.Da.get(i.targetId);if(s.length>1)return r.Da.set(i.targetId,s.filter((e=>!xu(e,t)))),void r.ba.delete(t);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||await Jh(r.localStore,i.targetId,!1).then((()=>{r.sharedClientState.clearQueryState(i.targetId),n&&wd(r.remoteStore,i.targetId),kf(r,i.targetId)})).catch(oc)):(kf(r,i.targetId),await Jh(r.localStore,i.targetId,!0))}async function mf(e,t){const n=Ro(e),r=n.ba.get(t),i=n.Da.get(r.targetId);n.isPrimaryClient&&1===i.length&&(n.sharedClientState.removeLocalQueryTarget(r.targetId),wd(n.remoteStore,r.targetId))}async function gf(e,t){const n=Ro(e);try{const e=await function(e,t){const n=Ro(e),r=t.snapshotVersion;let i=n.ns;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const s=n.os.newChangeBuffer({trackRemovals:!0});i=n.ns;const a=[];t.targetChanges.forEach(((s,o)=>{const c=i.get(o);if(!c)return;a.push(n.Qr.removeMatchingKeys(e,s.removedDocuments,o).next((()=>n.Qr.addMatchingKeys(e,s.addedDocuments,o))));let u=c.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(o)?u=u.withResumeToken(kc.EMPTY_BYTE_STRING,Jo.min()).withLastLimboFreeSnapshotVersion(Jo.min()):s.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(s.resumeToken,r)),i=i.insert(o,u),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,s)&&a.push(n.Qr.updateTargetData(e,u))}));let o=Mu(),c=Ku();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&a.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),a.push(function(e,t,n){let r=Ku(),i=Ku();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=Mu();return n.forEach(((n,s)=>{const a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(Jo.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):Oo("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)})),{cs:r,ls:i}}))}(e,s,t.documentUpdates).next((e=>{o=e.cs,c=e.ls}))),!r.isEqual(Jo.min())){const t=n.Qr.getLastRemoteSnapshotVersion(e).next((t=>n.Qr.setTargetsMetadata(e,e.currentSequenceNumber,r)));a.push(t)}return cc.waitFor(a).next((()=>s.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,o,c))).next((()=>o))})).then((e=>(n.ns=i,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.Fa.get(t);r&&(No(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.wa=!0:e.modifiedDocuments.size>0?No(r.wa):e.removedDocuments.size>0&&(No(r.wa),r.wa=!1))})),await Af(n,e,t)}catch(e){await oc(e)}}function yf(e,t,n){const r=Ro(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.ba.forEach(((n,r)=>{const i=r.view.j_(t);i.snapshot&&e.push(i.snapshot)})),function(e,t){const n=Ro(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const e of n.U_)e.j_(t)&&(r=!0)})),r&&ef(n)}(r.eventManager,t),e.length&&r.Sa.h_(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function vf(e,t,n){const r=Ro(e);r.sharedClientState.updateQueryState(t,"rejected",n);const i=r.Fa.get(t),s=i&&i.key;if(s){let e=new gc(tc.comparator);e=e.insert(s,Jc.newNoDocument(s,Jo.min()));const n=Ku().add(s),i=new Dl(Jo.min(),new Map,new gc(Wo),e,n);await gf(r,i),r.va=r.va.remove(s),r.Fa.delete(t),Of(r)}else await Jh(r.localStore,t,!1).then((()=>kf(r,t,n))).catch(oc)}async function _f(e,t){const n=Ro(e),r=t.batch.batchId;try{const e=await function(e,t){const n=Ro(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),i=n.os.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const i=n.batch,s=i.keys();let a=cc.resolve();return s.forEach((e=>{a=a.next((()=>r.getEntry(t,e))).next((t=>{const s=n.docVersions.get(e);No(null!==s),t.version.compareTo(s)<0&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),a.next((()=>e.mutationQueue.removeMutationBatch(t,i)))}(n,e,t,i).next((()=>i.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Ku();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);Ef(n,r,null),bf(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Af(n,e)}catch(e){await oc(e)}}async function wf(e,t,n){const r=Ro(e);try{const e=await function(e,t){const n=Ro(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(No(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);Ef(r,t,n),bf(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Af(r,e)}catch(n){await oc(n)}}function bf(e,t){(e.Oa.get(t)||[]).forEach((e=>{e.resolve()})),e.Oa.delete(t)}function Ef(e,t,n){const r=Ro(e);let i=r.xa[r.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),r.xa[r.currentUser.toKey()]=i}}function kf(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.Da.get(t))e.ba.delete(r),n&&e.Sa.ka(r,n);e.Da.delete(t),e.isPrimaryClient&&e.Ma.Vr(t).forEach((t=>{e.Ma.containsKey(t)||Sf(e,t)}))}function Sf(e,t){e.Ca.delete(t.path.canonicalString());const n=e.va.get(t);null!==n&&(wd(e.remoteStore,n),e.va=e.va.remove(t),e.Fa.delete(n),Of(e))}function Tf(e,t,n){for(const r of n)r instanceof sf?(e.Ma.addReference(r.key,t),If(e,r)):r instanceof af?(Oo("SyncEngine","Document no longer in limbo: "+r.key),e.Ma.removeReference(r.key,t),e.Ma.containsKey(r.key)||Sf(e,r.key)):Co()}function If(e,t){const n=t.key,r=n.path.canonicalString();e.va.get(n)||e.Ca.has(r)||(Oo("SyncEngine","New document in limbo: "+n),e.Ca.add(r),Of(e))}function Of(e){for(;e.Ca.size>0&&e.va.size<e.maxConcurrentLimboResolutions;){const t=e.Ca.values().next().value;e.Ca.delete(t);const n=new tc(Xo.fromString(t)),r=e.Na.next();e.Fa.set(r,new uf(n)),e.va=e.va.insert(n,r),_d(e.remoteStore,new bh(Ou(Su(n.path)),r,"TargetPurposeLimboResolution",lc.oe))}}async function Af(e,t,n){const r=Ro(e),i=[],s=[],a=[];r.ba.isEmpty()||(r.ba.forEach(((e,o)=>{a.push(r.Ba(o,t,n).then((e=>{var t;if((e||n)&&r.isPrimaryClient){const i=e?!e.fromCache:null===(t=null==n?void 0:n.targetChanges.get(o.targetId))||void 0===t?void 0:t.current;r.sharedClientState.updateQueryState(o.targetId,i?"current":"not-current")}if(e){i.push(e);const t=zh.Ki(o.targetId,e);s.push(t)}})))})),await Promise.all(a),r.Sa.h_(i),await async function(e,t){const n=Ro(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>cc.forEach(t,(t=>cc.forEach(t.qi,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>cc.forEach(t.Qi,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!uc(e))throw e;Oo("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.ns.get(t),r=e.snapshotVersion,i=e.withLastLimboFreeSnapshotVersion(r);n.ns=n.ns.insert(t,i)}}}(r.localStore,s))}async function xf(e,t){const n=Ro(e);if(!n.currentUser.isEqual(t)){Oo("SyncEngine","User change. New user:",t.toKey());const e=await Wh(n.localStore,t);n.currentUser=t,function(e,t){e.Oa.forEach((e=>{e.forEach((e=>{e.reject(new Lo(jo.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.Oa.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await Af(n,e.us)}}function Pf(e,t){const n=Ro(e),r=n.Fa.get(t);if(r&&r.wa)return Ku().add(r.key);{let e=Ku();const r=n.Da.get(t);if(!r)return e;for(const t of r){const r=n.ba.get(t);e=e.unionWith(r.view.Ea)}return e}}function Cf(e){const t=Ro(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=gf.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Pf.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=vf.bind(null,t),t.Sa.h_=Xd.bind(null,t.eventManager),t.Sa.ka=Yd.bind(null,t.eventManager),t}function Nf(e){const t=Ro(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=_f.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=wf.bind(null,t),t}class Rf{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=ud(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return function(e,t,n,r){return new Kh(e,t,n,r)}(this.persistence,new Hh,e.initialUser,this.serializer)}createPersistence(e){return new Fh(Vh.Hr,this.serializer)}createSharedClientState(e){return new Yh}async terminate(){var e,t;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(t=this.indexBackfillerScheduler)||void 0===t||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class jf{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>yf(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=xf.bind(null,this.syncEngine),await async function(e,t){const n=Ro(e);t?(n.M_.delete(2),await yd(n)):t||(n.M_.add(2),await vd(n),n.N_.set("Unknown"))}(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Qd}createDatastore(e){const t=ud(e.databaseInfo.databaseId),n=function(e){return new od(e)}(e.databaseInfo);return function(e,t,n,r){return new pd(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return function(e,t,n,r,i){return new gd(e,t,n,r,i)}(this.localStore,this.datastore,e.asyncQueue,(e=>yf(this.syncEngine,e,0)),td.D()?new td:new ed)}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){const o=new lf(e,t,n,r,i,s);return a&&(o.La=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e;await async function(e){const t=Ro(e);Oo("RemoteStore","RemoteStore shutting down."),t.M_.add(5),await vd(t),t.O_.shutdown(),t.N_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate()}}class Lf{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ka(this.observer.next,e)}error(e){this.observer.error?this.Ka(this.observer.error,e):Ao("Uncaught Error in snapshot listener:",e.toString())}$a(){this.muted=!0}Ka(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Df{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=ko.UNAUTHENTICATED,this.clientId=Ko.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{Oo("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(Oo("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Lo(jo.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new Do;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=Kd(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function Mf(e,t){e.asyncQueue.verifyOperationInProgress(),Oo("FirestoreClient","Initializing OfflineComponentProvider");const n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await Wh(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e._offlineComponents=t}async function $f(e,t){e.asyncQueue.verifyOperationInProgress();const n=await async function(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){Oo("FirestoreClient","Using user provided OfflineComponentProvider");try{await Mf(e,e._uninitializedComponentsProvider._offline)}catch(t){const n=t;if(!function(e){return"FirebaseError"===e.name?e.code===jo.FAILED_PRECONDITION||e.code===jo.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}(n))throw n;xo("Error using user provided cache. Falling back to memory cache: "+n),await Mf(e,new Rf)}}else Oo("FirestoreClient","Using default OfflineComponentProvider"),await Mf(e,new Rf);return e._offlineComponents}(e);Oo("FirestoreClient","Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener((e=>Vd(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Vd(t.remoteStore,n))),e._onlineComponents=t}async function Uf(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(Oo("FirestoreClient","Using user provided OnlineComponentProvider"),await $f(e,e._uninitializedComponentsProvider._online)):(Oo("FirestoreClient","Using default OnlineComponentProvider"),await $f(e,new jf))),e._onlineComponents}async function Ff(e){const t=await Uf(e),n=t.eventManager;return n.onListen=hf.bind(null,t.syncEngine),n.onUnlisten=pf.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=df.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=mf.bind(null,t.syncEngine),n}function Bf(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const Vf=new Map;function zf(e,t,n){if(!n)throw new Lo(jo.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function qf(e){if(!tc.isDocumentKey(e))throw new Lo(jo.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Hf(e){if(tc.isDocumentKey(e))throw new Lo(jo.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Kf(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":Co()}function Wf(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new Lo(jo.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Kf(e);throw new Lo(jo.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}class Gf{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new Lo(jo.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Lo(jo.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,n,r){if(!0===t&&!0===r)throw new Lo(jo.INVALID_ARGUMENT,"experimentalForceLongPolling and experimentalAutoDetectLongPolling cannot be used together.")})(0,e.experimentalForceLongPolling,0,e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Bf(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new Lo(jo.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new Lo(jo.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new Lo(jo.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(e,t){return e.timeoutSeconds===t.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Zf{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Gf({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new Lo(jo.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new Lo(jo.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Gf(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new $o;switch(e.type){case"firstParty":return new Vo(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new Lo(jo.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Vf.get(e);t&&(Oo("ComponentProvider","Removing Datastore"),Vf.delete(e),t.terminate())}(this),Promise.resolve()}}class Jf{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Jf(this.firestore,e,this._query)}}class Qf{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Xf(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Qf(this.firestore,e,this._key)}}class Xf extends Jf{constructor(e,t,n){super(e,t,Su(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Qf(this.firestore,null,new tc(e))}withConverter(e){return new Xf(this.firestore,e,this._path)}}function Yf(e,t,...n){if(e=Ln(e),zf("collection","path",t),e instanceof Zf){const r=Xo.fromString(t,...n);return Hf(r),new Xf(e,null,r)}{if(!(e instanceof Qf||e instanceof Xf))throw new Lo(jo.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(Xo.fromString(t,...n));return Hf(r),new Xf(e.firestore,null,r)}}function ep(e,t,...n){if(e=Ln(e),1===arguments.length&&(t=Ko.newId()),zf("doc","path",t),e instanceof Zf){const r=Xo.fromString(t,...n);return qf(r),new Qf(e,null,new tc(r))}{if(!(e instanceof Qf||e instanceof Xf))throw new Lo(jo.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(Xo.fromString(t,...n));return qf(r),new Qf(e.firestore,e instanceof Xf?e.converter:null,new tc(r))}}class tp{constructor(){this.iu=Promise.resolve(),this.su=[],this.ou=!1,this._u=[],this.au=null,this.uu=!1,this.cu=!1,this.lu=[],this.Yo=new ld(this,"async_queue_retry"),this.hu=()=>{const e=cd();e&&Oo("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Yo.Wo()};const e=cd();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.hu)}get isShuttingDown(){return this.ou}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Pu(),this.Iu(e)}enterRestrictedMode(e){if(!this.ou){this.ou=!0,this.cu=e||!1;const t=cd();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.hu)}}enqueue(e){if(this.Pu(),this.ou)return new Promise((()=>{}));const t=new Do;return this.Iu((()=>this.ou&&this.cu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.su.push(e),this.Tu())))}async Tu(){if(0!==this.su.length){try{await this.su[0](),this.su.shift(),this.Yo.reset()}catch(e){if(!uc(e))throw e;Oo("AsyncQueue","Operation failed with retryable error: "+e)}this.su.length>0&&this.Yo.$o((()=>this.Tu()))}}Iu(e){const t=this.iu.then((()=>(this.uu=!0,e().catch((e=>{this.au=e,this.uu=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw Ao("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.uu=!1,e))))));return this.iu=t,t}enqueueAfterDelay(e,t,n){this.Pu(),this.lu.indexOf(e)>-1&&(t=0);const r=Hd.createAndSchedule(this,e,t,n,(e=>this.Eu(e)));return this._u.push(r),r}Pu(){this.au&&Co()}verifyOperationInProgress(){}async du(){let e;do{e=this.iu,await e}while(e!==this.iu)}Au(e){for(const t of this._u)if(t.timerId===e)return!0;return!1}Ru(e){return this.du().then((()=>{this._u.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this._u)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.du()}))}Vu(e){this.lu.push(e)}Eu(e){const t=this._u.indexOf(e);this._u.splice(t,1)}}class np extends Zf{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new tp,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||sp(this),this._firestoreClient.terminate()}}function rp(e,t){const n="string"==typeof e?e:t||"(default)",r=Hr("object"==typeof e?e:Qr(),"firestore").getImmediate({identifier:n});if(!r._initialized){const e=wn("firestore");e&&function(e,t,n,r={}){var i;const s=(e=Wf(e,Zf))._getSettings(),a=`${t}:${n}`;if("firestore.googleapis.com"!==s.host&&s.host!==a&&xo("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=ko.MOCK_USER;else{t=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const n=t||"demo-project",r=e.iat||0,i=e.sub||e.user_id;if(!i)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const s=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:i,user_id:i,firebase:{sign_in_provider:"custom",identities:{}}},e);return[gn(JSON.stringify({alg:"none",type:"JWT"})),gn(JSON.stringify(s)),""].join(".")}(r.mockUserToken,null===(i=e._app)||void 0===i?void 0:i.options.projectId);const s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new Lo(jo.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new ko(s)}e._authCredentials=new Uo(new Mo(t,n))}}(r,...e)}return r}function ip(e){return e._firestoreClient||sp(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function sp(e){var t,n,r;const i=e._freezeSettings(),s=function(e,t,n,r){return new Cc(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,Bf(r.experimentalLongPollingOptions),r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,i);e._firestoreClient=new Df(e._authCredentials,e._appCheckCredentials,e._queue,s),(null===(n=i.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=i.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}class ap{constructor(e){this._byteString=e}static fromBase64String(e){try{return new ap(kc.fromBase64String(e))}catch(e){throw new Lo(jo.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new ap(kc.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class op{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new Lo(jo.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ec(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class cp{constructor(e){this._methodName=e}}class up{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new Lo(jo.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new Lo(jo.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Wo(this._lat,e._lat)||Wo(this._long,e._long)}}const lp=/^__.*__$/;class hp{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new vl(e,this.data,this.fieldMask,t,this.fieldTransforms):new yl(e,this.data,t,this.fieldTransforms)}}function dp(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Co()}}class fp{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.mu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get fu(){return this.settings.fu}gu(e){return new fp(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}pu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.gu({path:n,yu:!1});return r.wu(e),r}Su(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.gu({path:n,yu:!1});return r.mu(),r}bu(e){return this.gu({path:void 0,yu:!0})}Du(e){return Sp(e,this.settings.methodName,this.settings.Cu||!1,this.path,this.settings.vu)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}mu(){if(this.path)for(let e=0;e<this.path.length;e++)this.wu(this.path.get(e))}wu(e){if(0===e.length)throw this.Du("Document fields must not be empty");if(dp(this.fu)&&lp.test(e))throw this.Du('Document fields cannot begin and end with "__"')}}class pp{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||ud(e)}Fu(e,t,n,r=!1){return new fp({fu:e,methodName:t,vu:n,path:ec.emptyPath(),yu:!1,Cu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function mp(e){const t=e._freezeSettings(),n=ud(e._databaseId);return new pp(e._databaseId,!!t.ignoreUndefinedProperties,n)}function gp(e,t,n,r,i,s={}){const a=e.Fu(s.merge||s.mergeFields?2:0,t,n,i);wp("Data must be an object, but it was:",a,r);const o=vp(r,a);let c,u;if(s.merge)c=new bc(a.fieldMask),u=a.fieldTransforms;else if(s.mergeFields){const e=[];for(const r of s.mergeFields){const i=bp(t,r,n);if(!a.contains(i))throw new Lo(jo.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);Tp(e,i)||e.push(i)}c=new bc(e),u=a.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,u=a.fieldTransforms;return new hp(new Gc(o),c,u)}function yp(e,t){if(_p(e=Ln(e)))return wp("Unsupported field value:",t,e),vp(e,t);if(e instanceof cp)return function(e,t){if(!dp(t.fu))throw t.Du(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Du(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.yu&&4!==t.fu)throw t.Du("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const i of e){let e=yp(i,t.bu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=Ln(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return function(e,t){return function(e){return"number"==typeof e&&Number.isInteger(e)&&!dc(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}(t)?Zu(t):Gu(e,t)}(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=Zo.fromDate(e);return{timestampValue:Jl(t.serializer,n)}}if(e instanceof Zo){const n=new Zo(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:Jl(t.serializer,n)}}if(e instanceof up)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof ap)return{bytesValue:Ql(t.serializer,e._byteString)};if(e instanceof Qf){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Du(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:eh(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.Du(`Unsupported field value: ${Kf(e)}`)}(e,t)}function vp(e,t){const n={};return mc(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):pc(e,((e,r)=>{const i=yp(r,t.pu(e));null!=i&&(n[e]=i)})),{mapValue:{fields:n}}}function _p(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof Zo||e instanceof up||e instanceof ap||e instanceof Qf||e instanceof cp)}function wp(e,t,n){if(!_p(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=Kf(n);throw"an object"===r?t.Du(e+" a custom object"):t.Du(e+" "+r)}}function bp(e,t,n){if((t=Ln(t))instanceof op)return t._internalPath;if("string"==typeof t)return kp(e,t);throw Sp("Field path arguments must be of type string or ",e,!1,void 0,n)}const Ep=new RegExp("[~\\*/\\[\\]]");function kp(e,t,n){if(t.search(Ep)>=0)throw Sp(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new op(...t.split("."))._internalPath}catch(r){throw Sp(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function Sp(e,t,n,r,i){const s=r&&!r.isEmpty(),a=void 0!==i;let o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let c="";return(s||a)&&(c+=" (found",s&&(c+=` in field ${r}`),a&&(c+=` in document ${i}`),c+=")"),new Lo(jo.INVALID_ARGUMENT,o+e+c)}function Tp(e,t){return e.some((e=>e.isEqual(t)))}class Ip{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new Qf(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new Op(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Ap("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Op extends Ip{data(){return super.data()}}function Ap(e,t){return"string"==typeof t?kp(e,t):t instanceof op?t._internalPath:t._delegate._internalPath}class xp{convertValue(e,t="none"){switch(jc(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Ic(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Oc(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw Co()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return pc(e,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new up(Ic(e.latitude),Ic(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=xc(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Pc(e));default:return null}}convertTimestamp(e){const t=Tc(e);return new Zo(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=Xo.fromString(e);No(wh(n));const r=new Nc(n.get(1),n.get(3)),i=new tc(n.popFirst(5));return r.isEqual(t)||Ao(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function Pp(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class Cp{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Np extends Ip{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Rp(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Ap("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Rp extends Np{data(e={}){return super.data(e)}}function jp(e){e=Wf(e,Qf);const t=Wf(e.firestore,np);return function(e,t,n={}){const r=new Do;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,i){const s=new Lf({next:s=>{t.enqueueAndForget((()=>async function(e,t){const n=Ro(e),r=t.query;let i=3;const s=n.queries.get(r);if(s){const e=s.U_.indexOf(t);e>=0&&(s.U_.splice(e,1),0===s.U_.length?i=t.G_()?0:1:!s.W_()&&t.G_()&&(i=2))}switch(i){case 0:return n.queries.delete(r),n.onUnlisten(r,!0);case 1:return n.queries.delete(r),n.onUnlisten(r,!1);case 2:return n.onLastRemoteStoreUnlisten(r);default:return}}(e,a)));const o=s.docs.has(n);!o&&s.fromCache?i.reject(new Lo(jo.UNAVAILABLE,"Failed to get document because the client is offline.")):o&&s.fromCache&&r&&"server"===r.source?i.reject(new Lo(jo.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(s)},error:e=>i.reject(e)}),a=new rf(Su(n.path),s,{includeMetadataChanges:!0,ra:!0});return async function(e,t){const n=Ro(e);let r=3;const i=t.query;let s=n.queries.get(i);s?!s.W_()&&t.G_()&&(r=2):(s=new Jd,r=t.G_()?0:1);try{switch(r){case 0:s.K_=await n.onListen(i,!0);break;case 1:s.K_=await n.onListen(i,!1);break;case 2:await n.onFirstRemoteStoreListen(i)}}catch(e){const n=Kd(e,`Initialization of query '${Cu(t.query)}' failed`);return void t.onError(n)}n.queries.set(i,s),s.U_.push(t),t.j_(n.onlineState),s.K_&&t.H_(s.K_)&&ef(n)}(e,a)}(await Ff(e),e.asyncQueue,t,n,r))),r.promise}(ip(t),e._key).then((n=>function(e,t,n){const r=n.docs.get(t._key),i=new Lp(e);return new Np(e,i,t._key,r,new Cp(n.hasPendingWrites,n.fromCache),t.converter)}(t,e,n)))}class Lp extends xp{constructor(e){super(),this.firestore=e}convertBytes(e){return new ap(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Qf(this.firestore,null,t)}}function Dp(e,t,n){e=Wf(e,Qf);const r=Wf(e.firestore,np),i=Pp(e.converter,t,n);return $p(r,[gp(mp(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,ul.none())])}function Mp(e,t){const n=Wf(e.firestore,np),r=ep(e),i=Pp(e.converter,t);return $p(n,[gp(mp(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,ul.exists(!1))]).then((()=>r))}function $p(e,t){return function(e,t){const n=new Do;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=Nf(e);try{const e=await function(e,t){const n=Ro(e),r=Zo.now(),i=t.reduce(((e,t)=>e.add(t.key)),Ku());let s,a;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let o=Mu(),c=Ku();return n.os.getEntries(e,i).next((e=>{o=e,o.forEach(((e,t)=>{t.isValidDocument()||(c=c.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,o))).next((i=>{s=i;const a=[];for(const e of t){const t=ml(e,s.get(e.key).overlayedDocument);null!=t&&a.push(new vl(e.key,t,Zc(t.value.mapValue),ul.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,a,t)})).next((t=>{a=t;const r=t.applyToLocalDocumentSet(s,c);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:a.batchId,changes:Fu(s)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.xa[e.currentUser.toKey()];r||(r=new gc(Wo)),r=r.insert(t,n),e.xa[e.currentUser.toKey()]=r}(r,e.batchId,n),await Af(r,e.changes),await Rd(r.remoteStore)}catch(e){const t=Kd(e,"Failed to persist write");n.reject(t)}}(await function(e){return Uf(e).then((e=>e.syncEngine))}(e),t,n))),n.promise}(ip(e),t)}new WeakMap,function(e,t=!0){!function(e){So=e}(Zr),qr(new Dn("firestore",((e,{instanceIdentifier:n,options:r})=>{const i=e.getProvider("app").getImmediate(),s=new np(new Fo(e.getProvider("auth-internal")),new qo(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new Lo(jo.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Nc(e.options.projectId,t)}(i,n),i);return r=Object.assign({useFetchStreams:t},r),s._setSettings(r),s}),"PUBLIC").setMultipleInstances(!0)),Xr(Eo,"4.6.4",e),Xr(Eo,"4.6.4","esm2017")}();const Up=N.logger.get_logger({id:"firebase"});function Fp(e){return Jr(e)}function Bp(e){return function(e=Qr()){const t=Hr(e,"auth");if(t.isInitialized())return t.getImmediate();const n=function(e,t){const n=Hr(e,"auth");if(n.isInitialized()){const e=n.getImmediate();if(An(n.getOptions(),null!=t?t:{}))return e;mi(e,"already-initialized")}return n.initialize({options:t})}(e,{popupRedirectResolver:Qa,persistence:[ma,Xs,ea]}),r=En("authTokenSyncURL");if(r&&"boolean"==typeof isSecureContext&&isSecureContext){const e=new URL(r,location.origin);if(location.origin===e.origin){const t=ro(e.toString());!function(e,t,n){Ln(e).beforeAuthStateChanged(t,n)}(n,t,(()=>t(n.currentUser))),function(e,n,r,i){Ln(e).onIdTokenChanged((e=>t(e)),void 0,void 0)}(n)}}const i=_n("auth");return i&&function(e,t,n){const r=_s(e);wi(r._canInitEmulator,r,"emulator-config-failed"),wi(/^https?:\/\//.test(t),r,"invalid-emulator-scheme");const i=Os(t),{host:s,port:a}=function(e){const t=Os(e),n=/(\/\/)?([^?#/]+)/.exec(e.substr(t.length));if(!n)return{host:"",port:null};const r=n[2].split("@").pop()||"",i=/^(\[[^\]]+\])(:|$)/.exec(r);if(i){const e=i[1];return{host:e,port:As(r.substr(e.length+1))}}{const[e,t]=r.split(":");return{host:e,port:As(t)}}}(t),o=null===a?"":`:${a}`;r.config.emulator={url:`${i}//${s}${o}/`},r.settings.appVerificationDisabledForTesting=!0,r.emulatorConfig=Object.freeze({host:s,port:a,protocol:i.replace(":",""),options:Object.freeze({disableWarnings:!1})}),function(){function e(){const e=document.createElement("p"),t=e.style;e.innerText="Running in emulator mode. Do not use with production credentials.",t.position="fixed",t.width="100%",t.backgroundColor="#ffffff",t.border=".1em solid #000000",t.color="#b50000",t.bottom="0px",t.left="0px",t.margin="0px",t.zIndex="10000",t.textAlign="center",e.classList.add("firebase-emulator-warning"),document.body.appendChild(e)}"undefined"!=typeof console&&"function"==typeof console.info&&console.info("WARNING: You are using the Auth Emulator, which is intended for local testing only.  Do not use with production credentials."),"undefined"!=typeof window&&"undefined"!=typeof document&&("loading"===document.readyState?window.addEventListener("DOMContentLoaded",e):e())}()}(n,`http://${i}`),n}(e)}function Vp(e){return rp(e)}function zp(e){let t=Fp(e);return{app:t,auth:Bp(t),db:Vp(t)}}function qp(e){(function(e){return Ln(e).signOut()})(e).then((()=>{Up("User signed out")})).catch((e=>{Up("Signout error")}))}function Hp(e){let t=ln(e);return t.note_on=function(e,n,r){let i=N.midi_encoder.note_on(e,n,r);t.write(i)},t.note_off=function(e,n,r){let i=Uint8Array.from([128+e,n,r]);t.write(i)},t.control_change=function(e,n,r){let i=N.midi_encoder.control_change(e,n,r);t.write(i)},t}const Kp=N.logger.get_logger({id:"sensors"});var Wp=!1,Gp=!1,Zp={},Jp={};function Qp(e){let t="default.motion.logger";Yp(t,(function(e){let{acceleration:t,rotationRate:n}=e,{x:r,y:i,z:s}=t,{alpha:a,beta:o,gamma:c}=n;Kp(`x,y,z,alpha,beta,gamma=${r},${i},${s},${a},${o},${c}`)})),window.setTimeout((function(){tm(t)}),1e3*e)}function Xp(e){let t="default.orientation.logger";em(t,(function(e){let{alpha:t,beta:n,gamma:r}=e;Kp(`alpha,beta,gamma=${t},${n},${r}`)})),window.setTimeout((function(){nm(t)}),1e3*e)}function Yp(e,t){sm(),Zp[e]&&Kp(`WARNING! motion subscription id ${e} has already been used`),Zp[e]=t}function em(e,t){am(),Jp[e]&&Kp(`WARNING! orientation subscription id ${e} has already been used`),Jp[e]=t}function tm(e){delete Zp[e],Kp(`Unsubscribed motion id: ${e}`),N.fp.is_empty_array(N.fp.keys(Zp))&&(Kp("No more motion subscribers; so listener will be detached"),om())}function nm(e){delete Jp[e],Kp(`Unsubscribed orientation id: ${e}`),N.fp.is_empty_array(N.fp.keys(Jp))&&(Kp("No more orientation subscribers; so listener will be detached"),cm())}function rm(e){N.fp.values(Zp).map((t=>t(e)))}function im(e){N.fp.values(Jp).map((t=>t(e)))}function sm(){Wp||(window.addEventListener("devicemotion",rm),Kp("Started listening to device motion (registered handler"),Wp=!0)}function am(){Gp||(window.addEventListener("deviceorientation",im),Kp("Started listening to device orientation (registered handler"),Gp=!0)}function om(){window.removeEventListener("devicemotion",rm),Wp=!1,Kp("Unregistered device motion handler")}function cm(){window.removeEventListener("deviceorientation",im),Gp=!1,Kp("Unregistered device orientation handler")}const um=N.logger.get_logger({id:"idbmod"});class lm{constructor(e="keyval-store",t="keyval"){this.storeName=t,this._db=null,this._dbp=new Promise(((n,r)=>{let i=this;const s=indexedDB.open(e,1);s.onerror=()=>r(s.error),s.onsuccess=function(){n(s.result),i._db=s.result},s.onupgradeneeded=()=>{um(`creating store: ${e},  ${t}`),s.result.createObjectStore(t)}}))}_withIDBStore(e,t){return this._dbp.then((n=>new Promise(((r,i)=>{const s=n.transaction(this.storeName,e);s.oncomplete=()=>r(),s.onabort=s.onerror=()=>i(s.error),t(s.objectStore(this.storeName))}))))}get_db(){return this._db}}let hm;function dm(){return hm||(hm=new lm),hm}const fm=N.logger.get_logger({id:"db"}),pm=N.dates,mm={};var gm=5e3;const ym="main_store",vm="TIDYSCRIPTS_WEB_";var _m=null,wm=!1;function bm(e,t=!0){if(wm||(fm("initializing TTL"),wm=!0,_m=bm("TTL")),mm[e])return t&&fm(`getting db from local cache: ${e}`),mm[e];var n=new lm(vm+e,ym);function r(e,t){return function(e,t,n=dm()){return n._withIDBStore("readwrite",(n=>{n.put(t,e)}))}(e,t,n)}let i={store:n,set:r,get:function(e){return function(e,t=dm()){let n;return t._withIDBStore("readonly",(t=>{n=t.get(e)})).then((()=>n.result))}(e,n)},del:function(e){return function(e,t=dm()){return t._withIDBStore("readwrite",(t=>{t.delete(e)}))}(e,n)},keys:function(){return function(e=dm()){const t=[];return e._withIDBStore("readonly",(e=>{(e.openKeyCursor||e.openCursor).call(e).onsuccess=function(){this.result&&(t.push(this.result.key),this.result.continue())}})).then((()=>t))}(n)},clear:function(){return function(e=dm()){return e._withIDBStore("readwrite",(e=>{e.clear()}))}(n)},set_with_ttl:async function(t){let{id:n,ttl_ms:i,value:s}=t,a=i+pm.ms_now();fm(`In db "${e}" setting "${n}" with ttl_ms ${i}, expiration = ${a}`),await r(n,s),await _m.set(a,{db_id:e,del_id:n}),fm("done setting with ttl \\(^.^)/")},get_db_store:function(){return n},ready:function(){return n._dbp}};return mm[e]=i,t&&fm(`getting db: ${e}`),i}function Em(e){gm=e,fm("Updated cache check interval to "+e+" ms")}var km=null;async function Sm(){let e=await _m.keys(),t=e.length,n=e.filter((e=>e<pm.ms_now())),r=n.length,i=[];for(var s of n){let{db_id:e,del_id:t}=await _m.get(s),n=bm(e,!1);await n.del(t),await _m.del(s),i.push({db_id:e,del_id:t})}fm(`CacheCheck |> ${r}/${t} expired:`),r>0&&fm(i)}function Tm(e){km&&(fm("Already checking, will clear old interval."),Im()),Em(e),km=setInterval(Sm,gm)}function Im(){clearInterval(km),fm("Stopped cache check")}function Om(e){return window.indexedDB.deleteDatabase(vm+e)}async function Am(e){let t=bm(e).get_db_store()._db;return await(n=t,new Promise(((e,t)=>{const r={};if(0===n.objectStoreNames.length)e(JSON.stringify(r));else{const i=n.transaction(n.objectStoreNames,"readonly");i.addEventListener("error",t);for(const t of n.objectStoreNames){const s=[];i.objectStore(t).openCursor().addEventListener("success",(i=>{const a=i.target.result;a?(s.push([a.key,a.value]),a.continue()):(r[t]=s,n.objectStoreNames.length===Object.keys(r).length&&e(JSON.stringify(r)))}))}}})));var n}async function xm(e,t){let n=bm(e);await n.ready();let r=n.get_db_store()._db;return await(i=r,s=t,new Promise(((e,t)=>{const n=i.transaction(i.objectStoreNames,"readwrite");n.addEventListener("error",t);var r=JSON.parse(s);for(const t of i.objectStoreNames){let i=0;for(const s of r[t]){let[a,o]=s;n.objectStore(t).add(o,a).addEventListener("success",(()=>{i++,i===r[t].length&&(delete r[t],0===Object.keys(r).length&&e("ok"))}))}}})));var i,s}const Pm=N.logger.get_logger({id:"bokeh"});var Cm=!1;async function Nm(){if(window.Bokeh)return void Pm("Bokeh is already loaded! Skipping load for now...");if(Cm)return void Pm("Bokeh is already loading! Skipping load for now...");Cm=!0;let e="3.0.0",t=[`https://cdn.bokeh.org/bokeh/release/bokeh-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-widgets-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-tables-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-api-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-gl-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-mathjax-${e}.min.js`];for(var n of(Pm("Loading scripts"),t))Pm(`Loading ${n}`),await St({src:n,attributes:{crossorigin:"anonymous"}});Pm("Done")}function Rm(){const e=new Bokeh.ColumnDataSource({data:{x:[0],y:[0]}});let t={width:300,height:100};t.y_range=new Bokeh.Range1d({start:-1,end:1}),t.x_range=new Bokeh.Range1d({start:-1,end:1});const n=new Bokeh.Plot(t),r=new Bokeh.LinearAxis({axis_line_color:null}),i=new Bokeh.LinearAxis({axis_line_color:null});n.add_layout(r,"below"),n.add_layout(i,"left");const s=new Bokeh.Grid({ticker:r.ticker,dimension:0}),a=new Bokeh.Grid({ticker:i.ticker,dimension:1});n.add_layout(s),n.add_layout(a);const o=new Bokeh.Line({x:{field:"x"},y:{field:"y"},line_color:"#666699",line_width:2});return n.add_glyph(o,e),{plot:n,source:e}}const jm=N.util.dsp;N.util.debug;var Lm=null,Dm=null,Mm=null,$m=null;const Um=N.logger.get_logger({id:"web_audio"});async function Fm(){return Lm||(Lm=new window.AudioContext,Dm=await window.navigator.mediaDevices.getUserMedia({audio:!0}),Lm)}async function Bm(){return Lm?(Um("Shutting down audio context"),await Lm.close(),Vm(),Um("Done"),null):void Um("no ctx is active")}function Vm(){Um("Removing mic_callbacks"),Wm={}}async function zm(){return Dm||(await Fm(),await window.navigator.mediaDevices.getUserMedia({audio:!0}))}async function qm(){return(await zm()).getAudioTracks()[0].getSettings().sampleRate}async function Hm(e){let t=await Fm();return await t.decodeAudioData(e)}async function Km(e){return await Hm(await e.arrayBuffer())}var Wm={};function Gm(e,t){Wm[e]=t}function Zm(e){Object.keys(Wm).length>0&&N.fp.apply_function_dictionary_to_object(Wm,e)}var Jm,Qm=!1;async function Xm(){if(Qm)return Um("mic already initialized");let e=await Fm(),t=await zm(),n=e.createMediaStreamSource(t);(Mm=e.createAnalyser()).fftSize=2048,Jm=new Float32Array(Mm.frequencyBinCount),n.connect(Mm),Qm=!0,function e(){requestAnimationFrame(e),Mm.getFloatTimeDomainData(Jm),Zm(Jm)}()}var Ym,eg=new Float32Array(1024),tg=new Float32Array(1024);async function ng(e){Um(`testing diff with ${e} ms`),Mm.getFloatTimeDomainData(eg),window.setTimeout((function(){Mm.getFloatTimeDomainData(tg);let e=JSON.stringify(eg)==JSON.stringify(tg);Um(`Equality = ${e}`)}),e)}async function rg(e){if(await Xm(),$m)return Um("sound event detector already initialized"),$m;let t={threshold:.2,margin:600,audio_buffer_size:Jm.length,register_fn:Gm},n=Object.assign(t,e);return $m=new Ym(n),await $m.init(),$m}async function ig(e,t){await Nm();const n=N.fp.range(0,e.length),r=Array.from(e),i=new Bokeh.ColumnDataSource({data:{x:n,y:r}}),s=new Bokeh.Plot({width:300,height:100}),a=new Bokeh.LinearAxis({axis_line_color:null}),o=new Bokeh.LinearAxis({axis_line_color:null});s.add_layout(a,"below"),s.add_layout(o,"left");const c=new Bokeh.Grid({ticker:a.ticker,dimension:0}),u=new Bokeh.Grid({ticker:o.ticker,dimension:1});s.add_layout(c),s.add_layout(u);const l=new Bokeh.Line({x:{field:"x"},y:{field:"y"},line_color:"#666699",line_width:2});s.add_glyph(l,i),Bokeh.Plotting.show(s,document.getElementById(t))}function sg(){return document.querySelector("textarea")}function ag(e){sg().value=e}function og(){sg().parentElement.querySelector("button").click()}function cg(e){ag(e),og()}function ug(){window.addEventListener("tidyscripts_web_speech_recognition_result",(function(e){cg(e.detail)})),nt()}"undefined"!=typeof window&&(Ym=class extends window.EventTarget{constructor(e){super();let{threshold:t,margin:n,register_fn:r,audio_buffer_size:i}=e;this.threshold=t,this.margin=n,this.register_fn=r,this.log=N.logger.get_logger({id:"snd_evt"}),this.sampling_rate=48e3,this.audio_buffer_size=i,this.tmp_buffer=[],this.tmp_buffer_max_length=10,this.recording_event=!1,this.event_start_time=0,this.time_of_last_detection=performance.now(),this.media_recorder=null}async init(){let e=this;this.register_fn("SED",(function(t){e.handle_data(t)})),this.log("Linked sound event detector to audio source"),this.sampling_rate=await qm(),this.log(`Got sampling rate ${this.sampling_rate}`);let t=this.num_buffers_to_cover_margin();this.log(`Created tmp buffer of size ${t}`),this.tmp_buffer_max_length=t,this.tmp_buffer=N.fp.range(0,t).map((e=>new Float32Array(this.audio_buffer_size)));let n=await zm();this.media_recorder=new window.MediaRecorder(n),this.log("Initialized media recorder")}handle_data(e){this.tmp_buffer.shift(),this.tmp_buffer.push(e),this.analyze_tmp_buffer()}analyze_tmp_buffer(){let e=this.tmp_buffer,t=N.fp.all_true(e.map((e=>jm.mean_abs(e)>this.threshold)));if(this.recording_event){if(t)return void(this.time_of_last_detection=performance.now());let n=N.fp.all_true(e.map((e=>jm.mean_abs(e)<this.threshold))),r=performance.now()-this.time_of_last_detection>this.margin;n&&r&&(this.log("Detected quiet while recording event..."),this.recording_event=!1,this.media_recorder.stop(),this.log("Stopped recording"))}else if(t){let e=this;this.media_recorder.ondataavailable=function(t){let n=t.data,r=new window.CustomEvent("sound_event_ended",{detail:n});e.dispatchEvent(r)},this.media_recorder.start(),this.log("Detected event start"),this.time_since_last_detection=performance.now();let t=new window.Event("sound_event_started");this.dispatchEvent(t),this.recording_event=!0,this.event_start_time=N.util.unix_timestamp_ms()}}samples_to_ms(e){return 1e3*e/this.sampling_rate}ms_to_samples(e){return e*this.sampling_rate/1e3}num_buffers_to_cover_margin(){let e=this.ms_to_samples(this.margin);return Math.ceil(e/this.audio_buffer_size)}});var lg=null,hg="";function dg(e){console.log("new text:"+e)}function fg(e){dt(e)}function pg(e){dt(e)}function mg(){console.log("finished stream"),nt()}function gg(e,t){let n=e;lg=window.setInterval((function(){let e=document.querySelector(".result-streaming");if(e){let n=e.innerText,r=n.replace(hg,"");t?fg(r):dg(r),hg=n}else if(""==hg);else{let e=N.fp.last(Array.from(document.querySelectorAll("div.markdown"))).innerText.replace(hg,"");t?fg(e):dg(e),hg="",mg()}}),n)}var yg=["Google UK English Female","Google UK English Male","Google UK English","Karen","Rishi"];function vg(){window.clearInterval(lg)}function _g(e){ut(e)}async function wg(){await K(),ut(1.3),lt(yg)}var bg=2e3;async function Eg(){ug(),await wg(),gg(bg,!1)}async function kg(){ug(),await wg(),gg(bg,!0)}})();var o=t;for(var c in a)o[c]=a[c];a.__esModule&&Object.defineProperty(o,"__esModule",{value:!0})}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,n),s.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};return(()=>{"use strict";n.r(r);var e=n(515);window.tsw=e})(),r})()));