/*! For license information please see tidyscripts_web_umd.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.tidyscripts_web=t():e.tidyscripts_web=t()}(this,(()=>(()=>{var e={515:(e,t,n)=>{var r={78:(e,t)=>{var n={749:(e,t,n)=>{e=n.nmd(e);const r=(e=0)=>t=>`[${38+e};5;${t}m`,i=(e=0)=>(t,n,r)=>`[${38+e};2;${t};${n};${r}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(const[n,r]of Object.entries(t)){for(const[n,i]of Object.entries(r))t[n]={open:`[${i[0]}m`,close:`[${i[1]}m`},r[n]=t[n],e.set(i[0],i[1]);Object.defineProperty(t,n,{value:r,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="[39m",t.bgColor.close="[49m",t.color.ansi256=r(),t.color.ansi16m=i(),t.bgColor.ansi256=r(10),t.bgColor.ansi16m=i(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,n)=>e===t&&t===n?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(n/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:n}=t.groups;3===n.length&&(n=n.split("").map((e=>e+e)).join(""));const r=Number.parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},991:(e,t)=>{t.byteLength=function(e){var t=o(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,s=o(e),a=s[0],c=s[1],u=new i(function(e,t,n){return 3*(t+n)/4-n}(0,a,c)),l=0,h=c>0?a-4:a;for(n=0;n<h;n+=4)t=r[e.charCodeAt(n)]<<18|r[e.charCodeAt(n+1)]<<12|r[e.charCodeAt(n+2)]<<6|r[e.charCodeAt(n+3)],u[l++]=t>>16&255,u[l++]=t>>8&255,u[l++]=255&t;return 2===c&&(t=r[e.charCodeAt(n)]<<2|r[e.charCodeAt(n+1)]>>4,u[l++]=255&t),1===c&&(t=r[e.charCodeAt(n)]<<10|r[e.charCodeAt(n+1)]<<4|r[e.charCodeAt(n+2)]>>2,u[l++]=t>>8&255,u[l++]=255&t),u},t.fromByteArray=function(e){for(var t,r=e.length,i=r%3,s=[],a=16383,o=0,u=r-i;o<u;o+=a)s.push(c(e,o,o+a>u?u:o+a));return 1===i?(t=e[r-1],s.push(n[t>>2]+n[t<<4&63]+"==")):2===i&&(t=(e[r-2]<<8)+e[r-1],s.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"=")),s.join("")};for(var n=[],r=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0;a<64;++a)n[a]=s[a],r[s.charCodeAt(a)]=a;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function c(e,t,r){for(var i,s,a=[],o=t;o<r;o+=3)i=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),a.push(n[(s=i)>>18&63]+n[s>>12&63]+n[s>>6&63]+n[63&s]);return a.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},832:e=>{const t=/[\p{Lu}]/u,n=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,i=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,a=new RegExp("^"+s.source),o=new RegExp(s.source+i.source,"gu"),c=new RegExp("\\d+"+i.source,"gu"),u=(e,i)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(i={pascalCase:!1,preserveConsecutiveUppercase:!1,...i},0===(e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim()).length)return"";const s=!1===i.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(i.locale),u=!1===i.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(i.locale);return 1===e.length?i.pascalCase?u(e):s(e):(e!==s(e)&&(e=((e,r,i)=>{let s=!1,a=!1,o=!1;for(let c=0;c<e.length;c++){const u=e[c];s&&t.test(u)?(e=e.slice(0,c)+"-"+e.slice(c),s=!1,o=a,a=!0,c++):a&&o&&n.test(u)?(e=e.slice(0,c-1)+"-"+e.slice(c-1),o=a,a=!1,s=!0):(s=r(u)===u&&i(u)!==u,o=a,a=i(u)===u&&r(u)!==u)}return e})(e,s,u)),e=e.replace(a,""),e=i.preserveConsecutiveUppercase?((e,t)=>(r.lastIndex=0,e.replace(r,(e=>t(e)))))(e,s):s(e),i.pascalCase&&(e=u(e.charAt(0))+e.slice(1)),((e,t)=>(o.lastIndex=0,c.lastIndex=0,e.replace(o,((e,n)=>t(n))).replace(c,(e=>t(e)))))(e,u))};e.exports=u,e.exports.default=u},409:e=>{e.exports=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},985:e=>{var t=Object.prototype.hasOwnProperty,n="~";function r(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,r,s,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new i(r,s||e,a),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,i=[];if(0===this._eventsCount)return i;for(r in e=this._events)t.call(e,r)&&i.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,s=r.length,a=new Array(s);i<s;i++)a[i]=r[i].fn;return a},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,i,s,a){var o=n?n+e:e;if(!this._events[o])return!1;var c,u,l=this._events[o],h=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),h){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,i),!0;case 5:return l.fn.call(l.context,t,r,i,s),!0;case 6:return l.fn.call(l.context,t,r,i,s,a),!0}for(u=1,c=new Array(h-1);u<h;u++)c[u-1]=arguments[u];l.fn.apply(l.context,c)}else{var d,f=l.length;for(u=0;u<f;u++)switch(l[u].once&&this.removeListener(e,l[u].fn,void 0,!0),h){case 1:l[u].fn.call(l[u].context);break;case 2:l[u].fn.call(l[u].context,t);break;case 3:l[u].fn.call(l[u].context,t,r);break;case 4:l[u].fn.call(l[u].context,t,r,i);break;default:if(!c)for(d=1,c=new Array(h-1);d<h;d++)c[d-1]=arguments[d];l[u].fn.apply(l[u].context,c)}}return!0},o.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,i){var s=n?n+e:e;if(!this._events[s])return this;if(!t)return a(this,s),this;var o=this._events[s];if(o.fn)o.fn!==t||i&&!o.once||r&&o.context!==r||a(this,s);else{for(var c=0,u=[],l=o.length;c<l;c++)(o[c].fn!==t||i&&!o[c].once||r&&o[c].context!==r)&&u.push(o[c]);u.length?this._events[s]=1===u.length?u[0]:u:a(this,s)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o},425:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(985),i=n(856),s=n(147),a=()=>{},o=new i.TimeoutError;t.default=class extends r{constructor(e){var t,n,r,i;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=a,this._resolveIdle=a,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:s.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==n?n:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(i=null===(r=e.interval)||void 0===r?void 0:r.toString())&&void 0!==i?i:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=a,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=a,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((n,r)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const s=void 0===this._timeout&&void 0===t.timeout?e():i.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&r(o)}));n(await s)}catch(e){r(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},657:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n){let r=0,i=e.length;for(;i>0;){const s=i/2|0;let a=r+s;n(e[a],t)<=0?(r=++a,i-=s+1):i=s}return r}},147:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(657);t.default=class{constructor(){this._queue=[]}enqueue(e,t){const n={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(n);const i=r.default(this._queue,n,((e,t)=>t.priority-e.priority));this._queue.splice(i,0,n)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}}},201:(e,t,n)=>{const r=n(364),i=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class s extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const a=(e,t)=>new Promise(((n,a)=>{t={onFailedAttempt:()=>{},retries:10,...t};const o=r.operation(t);o.attempt((async r=>{try{n(await e(r))}catch(e){if(!(e instanceof Error))return void a(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof s)o.stop(),a(e.originalError);else if(e instanceof TypeError&&(c=e.message,!i.includes(c)))o.stop(),a(e);else{((e,t,n)=>{const r=n.retries-(t-1);e.attemptNumber=t,e.retriesLeft=r})(e,r,t);try{await t.onFailedAttempt(e)}catch(e){return void a(e)}o.retry(e)||a(o.mainError())}}var c}))}));e.exports=a,e.exports.default=a,e.exports.AbortError=s},856:(e,t,n)=>{const r=n(70);class i extends Error{constructor(e){super(e),this.name="TimeoutError"}}const s=(e,t,n)=>new Promise(((s,a)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void s(e);const o=setTimeout((()=>{if("function"==typeof n){try{s(n())}catch(e){a(e)}return}const r=n instanceof Error?n:new i("string"==typeof n?n:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),a(r)}),t);r(e.then(s,a),(()=>{clearTimeout(o)}))}));e.exports=s,e.exports.default=s,e.exports.TimeoutError=i},70:e=>{e.exports=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))))},364:(e,t,n)=>{e.exports=n(386)},386:(e,t,n)=>{var r=n(884);t.operation=function(e){var n=t.timeouts(e);return new r(n,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var n in e)t[n]=e[n];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],i=0;i<t.retries;i++)r.push(this.createTimeout(i,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(i,t)),r.sort((function(e,t){return e-t})),r},t.createTimeout=function(e,t){var n=t.randomize?Math.random()+1:1,r=Math.round(n*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(r,t.maxTimeout)},t.wrap=function(e,n,r){if(n instanceof Array&&(r=n,n=null),!r)for(var i in r=[],e)"function"==typeof e[i]&&r.push(i);for(var s=0;s<r.length;s++){var a=r[s],o=e[a];e[a]=function(r){var i=t.operation(n),s=Array.prototype.slice.call(arguments,1),a=s.pop();s.push((function(e){i.retry(e)||(e&&(arguments[0]=i.mainError()),a.apply(this,arguments))})),i.attempt((function(){r.apply(e,s)}))}.bind(e,o),e[a].options=n}}},884:e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(void 0===n){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1)}var r=this;return this._timer=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),n),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){n._operationTimeoutCb()}),n._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,n=0,r=0;r<this._errors.length;r++){var i=this._errors[r],s=i.message,a=(e[s]||0)+1;e[s]=a,a>=n&&(t=i,n=a)}return t}}},r={};function i(e){var t=r[e];if(void 0!==t)return t.exports;var s=r[e]={id:e,loaded:!1,exports:{}};return n[e](s,s.exports,i),s.loaded=!0,s.exports}i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.nmd=e=>(e.paths=[],e.children||(e.children=[]),e);var s={};(()=>{i.r(s),i.d(s,{R:()=>n,apis:()=>w,asnc:()=>f,dates:()=>E,fp:()=>t,get_json_from_url:()=>Zw,logger:()=>e,midi_encoder:()=>b,trading:()=>o,util:()=>d});var e={};i.r(e),i.d(e,{get_logger:()=>$e,suppress:()=>Me,unsuppress:()=>Ue});var t={};i.r(t),i.d(t,{add:()=>pn,adder:()=>vn,all_false:()=>yt,all_true:()=>mt,any_false:()=>vt,any_is_array:()=>Ht,any_true:()=>gt,apply_function_dictionary_to_object:()=>kn,async_apply_function_dictionary_to_object:()=>Sn,clone:()=>St,clone_array:()=>ot,concat:()=>Nt,concat_accross_index:()=>kt,dict_to_list:()=>it,diff:()=>En,divide:()=>yn,divider:()=>wn,enumerate:()=>Et,enumermap:()=>Pt,equals:()=>In,filter:()=>Bt,filter_key:()=>Vt,filter_key_equals:()=>qt,first:()=>ct,flat_once:()=>Kt,format:()=>fn,fourth:()=>ht,get:()=>Ze,getter:()=>Xe,im_arr_rm:()=>Ot,im_push:()=>At,indexer:()=>pt,invert_dictionary:()=>at,is_array:()=>nn,is_empty:()=>$t,is_empty_array:()=>Ut,is_empty_map:()=>tt,is_empty_string:()=>on,is_map:()=>an,is_null:()=>Yt,is_object:()=>sn,is_something:()=>tn,is_string:()=>rn,is_undefined:()=>en,is_zero:()=>Dt,join:()=>ln,joiner:()=>hn,keys:()=>ze,last:()=>dt,len:()=>Mt,list_to_dict:()=>Qt,make_debouncer:()=>Tn,map:()=>bt,map_get:()=>Rt,map_indexed:()=>Ve,map_items:()=>rt,map_over_dic_values:()=>st,map_prop:()=>It,map_prop_reduce:()=>Tt,map_set:()=>jt,map_set_im:()=>Lt,merge_dictionaries:()=>Ge,merge_dictionary:()=>We,multiplier:()=>bn,multiply:()=>gn,nchars:()=>un,not_empty:()=>Ft,nth:()=>ft,partition:()=>Ct,range:()=>wt,recursive_flat:()=>Wt,recursive_flat_remove_empty:()=>Gt,remove_empty:()=>zt,repeat:()=>_t,second:()=>ut,set:()=>Je,set_im:()=>Qe,setter:()=>Ye,setter_im:()=>et,shallow_copy:()=>qe,sort_by_prop:()=>xt,split:()=>dn,substring:()=>cn,subtract:()=>mn,subtractor:()=>_n,third:()=>lt,update_at:()=>nt,values:()=>Ke,values_cloned:()=>He,zip:()=>Jt,zip2:()=>Zt,zip_map:()=>Xt});var n={};i.r(n),i.d(n,{F:()=>An,T:()=>On,__:()=>xn,add:()=>Cn,addIndex:()=>C,addIndexRight:()=>Pn,adjust:()=>Rn,all:()=>Dn,allPass:()=>Fn,always:()=>Bn,and:()=>Vn,andThen:()=>Sc,any:()=>zn,anyPass:()=>Kn,ap:()=>Gn,aperture:()=>Jn,append:()=>Qn,apply:()=>Xn,applySpec:()=>nr,applyTo:()=>rr,ascend:()=>ir,assoc:()=>lr,assocPath:()=>cr,binary:()=>dr,bind:()=>Ce,both:()=>mr,call:()=>gr,chain:()=>Ir,clamp:()=>kr,clone:()=>Cr,collectBy:()=>Pr,comparator:()=>Nr,complement:()=>jr,compose:()=>Br,composeWith:()=>Kr,concat:()=>be,cond:()=>Wr,construct:()=>Jr,constructN:()=>Zr,converge:()=>Qr,count:()=>Xr,countBy:()=>ni,curry:()=>Gr,curryN:()=>x,dec:()=>ri,defaultTo:()=>ii,descend:()=>si,difference:()=>ui,differenceWith:()=>hi,dissoc:()=>gi,dissocPath:()=>pi,divide:()=>yi,drop:()=>_i,dropLast:()=>Ii,dropLastWhile:()=>ki,dropRepeats:()=>Pi,dropRepeatsBy:()=>Ri,dropRepeatsWith:()=>Ci,dropWhile:()=>Di,either:()=>Ui,empty:()=>$i,endsWith:()=>Bi,eqBy:()=>Ni,eqProps:()=>qi,equals:()=>ae,evolve:()=>Hi,filter:()=>ye,find:()=>Gi,findIndex:()=>Qi,findLast:()=>Yi,findLastIndex:()=>ts,flatten:()=>ns,flip:()=>rs,forEach:()=>ss,forEachObjIndexed:()=>os,fromPairs:()=>cs,groupBy:()=>us,groupWith:()=>hs,gt:()=>ds,gte:()=>fs,has:()=>gs,hasIn:()=>vs,hasPath:()=>ps,head:()=>Vr,identical:()=>ws,identity:()=>zr,ifElse:()=>bs,inc:()=>Es,includes:()=>Is,indexBy:()=>Ts,indexOf:()=>ks,init:()=>Ss,innerJoin:()=>As,insert:()=>Os,insertAll:()=>xs,intersection:()=>Ls,intersperse:()=>Ds,into:()=>qs,invert:()=>Hs,invertObj:()=>Ws,invoker:()=>Gs,is:()=>Zs,isEmpty:()=>Js,isNil:()=>ar,isNotNil:()=>Qs,join:()=>Xs,juxt:()=>Ys,keys:()=>Z,keysIn:()=>ta,last:()=>Oi,lastIndexOf:()=>na,length:()=>ia,lens:()=>aa,lensIndex:()=>ca,lensPath:()=>ha,lensProp:()=>da,lift:()=>pr,liftN:()=>fr,lt:()=>fa,lte:()=>pa,map:()=>Q,mapAccum:()=>ga,mapAccumRight:()=>ya,mapObjIndexed:()=>_a,match:()=>ba,mathMod:()=>Ea,max:()=>Mn,maxBy:()=>Ia,mean:()=>ka,median:()=>Aa,memoizeWith:()=>xa,mergeAll:()=>Ca,mergeDeepLeft:()=>Ra,mergeDeepRight:()=>ja,mergeDeepWith:()=>La,mergeDeepWithKey:()=>Na,mergeLeft:()=>Da,mergeRight:()=>Ma,mergeWith:()=>Ua,mergeWithKey:()=>Pa,min:()=>$a,minBy:()=>Fa,modify:()=>za,modifyPath:()=>Va,modulo:()=>Ha,move:()=>Ka,multiply:()=>Wa,nAry:()=>hr,negate:()=>Ja,none:()=>Qa,not:()=>Rr,nth:()=>Ie,nthArg:()=>Xa,o:()=>Ya,objOf:()=>$s,of:()=>eo,omit:()=>no,on:()=>ro,once:()=>io,or:()=>Mi,otherwise:()=>ao,over:()=>uo,pair:()=>lo,partial:()=>fo,partialObject:()=>Za,partialRight:()=>po,partition:()=>mo,path:()=>la,pathEq:()=>go,pathOr:()=>yo,pathSatisfies:()=>vo,paths:()=>ua,pick:()=>_o,pickAll:()=>bo,pickBy:()=>Io,pipe:()=>$r,pipeWith:()=>Hr,pluck:()=>Un,prepend:()=>To,product:()=>ko,project:()=>Ao,promap:()=>Co,prop:()=>Te,propEq:()=>Po,propIs:()=>No,propOr:()=>Ro,propSatisfies:()=>jo,props:()=>Lo,range:()=>Do,reduce:()=>je,reduceBy:()=>ti,reduceRight:()=>Mo,reduceWhile:()=>Uo,reduced:()=>$o,reject:()=>ve,remove:()=>di,repeat:()=>qo,replace:()=>Ho,reverse:()=>Fr,scan:()=>Jo,sequence:()=>Qo,set:()=>Yo,slice:()=>Mr,sort:()=>ec,sortBy:()=>tc,sortWith:()=>rc,split:()=>ic,splitAt:()=>ac,splitEvery:()=>oc,splitWhen:()=>uc,splitWhenever:()=>hc,startsWith:()=>dc,subtract:()=>fc,sum:()=>Ta,swap:()=>mc,symmetricDifference:()=>gc,symmetricDifferenceWith:()=>yc,tail:()=>Ur,take:()=>bi,takeLast:()=>Fi,takeLastWhile:()=>vc,takeWhile:()=>bc,tap:()=>Ic,test:()=>kc,thunkify:()=>Iu,times:()=>Bo,toLower:()=>Ac,toPairs:()=>xc,toPairsIn:()=>Pc,toString:()=>we,toUpper:()=>Nc,transduce:()=>Rc,transpose:()=>Lc,traverse:()=>Dc,trim:()=>$c,tryCatch:()=>Fc,type:()=>re,unapply:()=>Bc,unary:()=>Vc,uncurryN:()=>zc,unfold:()=>Hc,union:()=>Kc,unionWith:()=>Jc,uniq:()=>Rs,uniqBy:()=>Ns,uniqWith:()=>Zc,unless:()=>Qc,unnest:()=>Xc,until:()=>Yc,unwind:()=>tu,update:()=>oa,useWith:()=>So,values:()=>er,valuesIn:()=>ru,view:()=>au,when:()=>ou,where:()=>uu,whereAny:()=>hu,whereEq:()=>du,without:()=>pu,xor:()=>mu,xprod:()=>gu,zip:()=>vu,zipObj:()=>wu,zipWith:()=>Eu});var r={};i.r(r),i.d(r,{MarketTradeType:()=>Tu,PortfolioBalancer:()=>ku});var a={};i.r(a),i.d(a,{BacktestBalancer:()=>Su});var o={};i.r(o),i.d(o,{backtest_balancer:()=>a,portfolio_balancer_lib:()=>r});var c={};i.r(c),i.d(c,{abs:()=>Cu,flat_float32_array:()=>ju,length:()=>Au,mean:()=>Pu,mean_abs:()=>Nu,min_max_mean:()=>Ru,power:()=>Ou,sum:()=>xu});var u={};i.r(u),i.d(u,{ms:()=>Lu});var l={};i.r(l),i.d(l,{add:()=>Mu,db:()=>Du,get:()=>Uu,log:()=>$u});var h={};i.r(h),i.d(h,{prepend_timestamp_as_bytes:()=>Bu,timestampToByteArray:()=>Fu});var d={};i.r(d),i.d(d,{bytes:()=>h,debug:()=>l,dsp:()=>c,is_browser:()=>Vu,is_json_string:()=>Hu,is_node:()=>qu,performance:()=>u,unix_timestamp_ms:()=>zu});var f={};i.r(f),i.d(f,{status:()=>Wu,wait:()=>Ju,wait_until:()=>Zu});var p={};i.r(p),i.d(p,{ai_cds:()=>tl,ask_ai:()=>Xu,clean_json_string:()=>Qu,example_patient:()=>Yu,generate_patient_data:()=>nl,generate_prompt:()=>el});var m={};i.r(m),i.d(m,{code:()=>rl});var g={};i.r(g),i.d(g,{build_index:()=>fl,get_medications:()=>cl,index:()=>ol,init:()=>ul,medications:()=>al,parse_ar_text:()=>gl,parse_subsection_1:()=>pl,parse_subsection_2:()=>ml,raw_medications:()=>sl,search_for_medication:()=>ll,search_for_side_effect:()=>hl});var y={};i.r(y),i.d(y,{APIConnectionError:()=>Dl,APIConnectionTimeoutError:()=>Ml,APIError:()=>jl,APIUserAbortError:()=>Ll,AuthenticationError:()=>$l,BadRequestError:()=>Ul,ConflictError:()=>Vl,InternalServerError:()=>Hl,NotFoundError:()=>Bl,OpenAIError:()=>Rl,PermissionDeniedError:()=>Fl,RateLimitError:()=>zl,UnprocessableEntityError:()=>ql});var v={};i.r(v),i.d(v,{JsonPatchError:()=>$v,_areEquals:()=>Zv,applyOperation:()=>zv,applyPatch:()=>Hv,applyReducer:()=>Kv,deepClone:()=>Fv,getValueByPointer:()=>qv,validate:()=>Gv,validator:()=>Wv});var _={};i.r(_),i.d(_,{get_chat_model:()=>Nw});var w={};i.r(w),i.d(w,{OpenAI:()=>lp,aidx:()=>p,langchain:()=>_,loinc:()=>m,medications:()=>g});var b={};i.r(b),i.d(b,{control_change:()=>Lw,note_off:()=>jw,note_on:()=>Rw});var E={};function I(e,t){var n;t=t||[];var r=(e=e||[]).length,i=t.length,s=[];for(n=0;n<r;)s[s.length]=e[n],n+=1;for(n=0;n<i;)s[s.length]=t[n],n+=1;return s}function T(e){return null!=e&&"object"==typeof e&&!0===e["@@functional/placeholder"]}function k(e){return function t(n){return 0===arguments.length||T(n)?t:e.apply(this,arguments)}}function S(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,n){return t.apply(this,arguments)};case 3:return function(e,n,r){return t.apply(this,arguments)};case 4:return function(e,n,r,i){return t.apply(this,arguments)};case 5:return function(e,n,r,i,s){return t.apply(this,arguments)};case 6:return function(e,n,r,i,s,a){return t.apply(this,arguments)};case 7:return function(e,n,r,i,s,a,o){return t.apply(this,arguments)};case 8:return function(e,n,r,i,s,a,o,c){return t.apply(this,arguments)};case 9:return function(e,n,r,i,s,a,o,c,u){return t.apply(this,arguments)};case 10:return function(e,n,r,i,s,a,o,c,u,l){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}}function A(e){return function t(n,r){switch(arguments.length){case 0:return t;case 1:return T(n)?t:k((function(t){return e(n,t)}));default:return T(n)&&T(r)?t:T(n)?k((function(t){return e(t,r)})):T(r)?k((function(t){return e(n,t)})):e(n,r)}}}function O(e,t,n){return function(){for(var r=[],i=0,s=e,a=0,o=!1;a<t.length||i<arguments.length;){var c;a<t.length&&(!T(t[a])||i>=arguments.length)?c=t[a]:(c=arguments[i],i+=1),r[a]=c,T(c)?o=!0:s-=1,a+=1}return!o&&s<=0?n.apply(this,r):S(Math.max(0,s),O(e,r,n))}}i.r(E),i.d(E,{copy_date:()=>qw,dates_eq:()=>Vw,day_string:()=>zw,iso_day_filename:()=>$w,iso_now:()=>Mw,ms_now:()=>Bw,round_date:()=>Hw,shift_date:()=>Kw,times_in_ms:()=>Ww,to_iso:()=>Dw,to_iso_day_filename:()=>Uw,to_ms:()=>Fw});const x=A((function(e,t){return 1===e?k(t):S(e,O(e,[],t))})),C=k((function(e){return x(e.length,(function(){var t=0,n=arguments[0],r=arguments[arguments.length-1],i=Array.prototype.slice.call(arguments,0);return i[0]=function(){var e=n.apply(this,I(arguments,[t,r]));return t+=1,e},e.apply(this,i)}))}));function P(e,t,n){for(var r=0,i=n.length;r<i;)t=e(t,n[r]),r+=1;return t}const N=Array.isArray||function(e){return null!=e&&e.length>=0&&"[object Array]"===Object.prototype.toString.call(e)};function j(e){return null!=e&&"function"==typeof e["@@transducer/step"]}function L(e,t,n){return function(){if(0===arguments.length)return n();var r=arguments[arguments.length-1];if(!N(r)){for(var i=0;i<e.length;){if("function"==typeof r[e[i]])return r[e[i]].apply(r,Array.prototype.slice.call(arguments,0,-1));i+=1}if(j(r))return t.apply(null,Array.prototype.slice.call(arguments,0,-1))(r)}return n.apply(this,arguments)}}function D(e,t){for(var n=0,r=t.length,i=Array(r);n<r;)i[n]=e(t[n]),n+=1;return i}const M=function(){return this.xf["@@transducer/init"]()},U=function(e){return this.xf["@@transducer/result"](e)};var $=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=U,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},e}();const F=function(e){return function(t){return new $(e,t)}};function B(e,t){return Object.prototype.hasOwnProperty.call(t,e)}var V=Object.prototype.toString;const q=function(){return"[object Arguments]"===V.call(arguments)?function(e){return"[object Arguments]"===V.call(e)}:function(e){return B("callee",e)}}();var z=!{toString:null}.propertyIsEnumerable("toString"),H=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],K=function(){return arguments.propertyIsEnumerable("length")}(),W=function(e,t){for(var n=0;n<e.length;){if(e[n]===t)return!0;n+=1}return!1},G="function"!=typeof Object.keys||K?k((function(e){if(Object(e)!==e)return[];var t,n,r=[],i=K&&q(e);for(t in e)!B(t,e)||i&&"length"===t||(r[r.length]=t);if(z)for(n=H.length-1;n>=0;)B(t=H[n],e)&&!W(r,t)&&(r[r.length]=t),n-=1;return r})):k((function(e){return Object(e)!==e?[]:Object.keys(e)}));const Z=G;var J=A(L(["fantasy-land/map","map"],F,(function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return x(t.length,(function(){return e.call(this,t.apply(this,arguments))}));case"[object Object]":return P((function(n,r){return n[r]=e(t[r]),n}),{},Z(t));default:return D(e,t)}})));const Q=J;function X(e){var t=Object.prototype.toString.call(e);return"[object Function]"===t||"[object AsyncFunction]"===t||"[object GeneratorFunction]"===t||"[object AsyncGeneratorFunction]"===t}function Y(e){return"[object String]"===Object.prototype.toString.call(e)}function ee(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n}function te(e,t,n){for(var r=0,i=n.length;r<i;){if(e(t,n[r]))return!0;r+=1}return!1}const ne="function"==typeof Object.is?Object.is:function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t},re=k((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)}));function ie(e,t,n,r){var i=ee(e);function s(e,t){return se(e,t,n.slice(),r.slice())}return!te((function(e,t){return!te(s,t,e)}),ee(t),i)}function se(e,t,n,r){if(ne(e,t))return!0;var i=re(e);if(i!==re(t))return!1;if("function"==typeof e["fantasy-land/equals"]||"function"==typeof t["fantasy-land/equals"])return"function"==typeof e["fantasy-land/equals"]&&e["fantasy-land/equals"](t)&&"function"==typeof t["fantasy-land/equals"]&&t["fantasy-land/equals"](e);if("function"==typeof e.equals||"function"==typeof t.equals)return"function"==typeof e.equals&&e.equals(t)&&"function"==typeof t.equals&&t.equals(e);switch(i){case"Arguments":case"Array":case"Object":if("function"==typeof e.constructor&&"Promise"===function(e){var t=String(e).match(/^function (\w*)/);return null==t?"":t[1]}(e.constructor))return e===t;break;case"Boolean":case"Number":case"String":if(typeof e!=typeof t||!ne(e.valueOf(),t.valueOf()))return!1;break;case"Date":if(!ne(e.valueOf(),t.valueOf()))return!1;break;case"Error":return e.name===t.name&&e.message===t.message;case"RegExp":if(e.source!==t.source||e.global!==t.global||e.ignoreCase!==t.ignoreCase||e.multiline!==t.multiline||e.sticky!==t.sticky||e.unicode!==t.unicode)return!1}for(var s=n.length-1;s>=0;){if(n[s]===e)return r[s]===t;s-=1}switch(i){case"Map":return e.size===t.size&&ie(e.entries(),t.entries(),n.concat([e]),r.concat([t]));case"Set":return e.size===t.size&&ie(e.values(),t.values(),n.concat([e]),r.concat([t]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var a=Z(e);if(a.length!==Z(t).length)return!1;var o=n.concat([e]),c=r.concat([t]);for(s=a.length-1;s>=0;){var u=a[s];if(!B(u,t)||!se(t[u],e[u],o,c))return!1;s-=1}return!0}const ae=A((function(e,t){return se(e,t,[],[])}));function oe(e,t,n){var r,i;if("function"==typeof e.indexOf)switch(typeof t){case"number":if(0===t){for(r=1/t;n<e.length;){if(0===(i=e[n])&&1/i===r)return n;n+=1}return-1}if(t!=t){for(;n<e.length;){if("number"==typeof(i=e[n])&&i!=i)return n;n+=1}return-1}return e.indexOf(t,n);case"string":case"boolean":case"function":case"undefined":return e.indexOf(t,n);case"object":if(null===t)return e.indexOf(t,n)}for(;n<e.length;){if(ae(e[n],t))return n;n+=1}return-1}function ce(e,t){return oe(t,e,0)>=0}function ue(e){return'"'+e.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0").replace(/"/g,'\\"')+'"'}var le=function(e){return(e<10?"0":"")+e};const he="function"==typeof Date.prototype.toISOString?function(e){return e.toISOString()}:function(e){return e.getUTCFullYear()+"-"+le(e.getUTCMonth()+1)+"-"+le(e.getUTCDate())+"T"+le(e.getUTCHours())+":"+le(e.getUTCMinutes())+":"+le(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"};function de(e){return function(){return!e.apply(this,arguments)}}function fe(e,t){for(var n=0,r=t.length,i=[];n<r;)e(t[n])&&(i[i.length]=t[n]),n+=1;return i}function pe(e){return"[object Object]"===Object.prototype.toString.call(e)}var me=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=U,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):e},e}(),ge=A(L(["fantasy-land/filter","filter"],(function(e){return function(t){return new me(e,t)}}),(function(e,t){return pe(t)?P((function(n,r){return e(t[r])&&(n[r]=t[r]),n}),{},Z(t)):fe(e,t)})));const ye=ge,ve=A((function(e,t){return ye(de(e),t)}));function _e(e,t){var n=function(n){var r=t.concat([e]);return ce(n,r)?"<Circular>":_e(n,r)},r=function(e,t){return D((function(t){return ue(t)+": "+n(e[t])}),t.slice().sort())};switch(Object.prototype.toString.call(e)){case"[object Arguments]":return"(function() { return arguments; }("+D(n,e).join(", ")+"))";case"[object Array]":return"["+D(n,e).concat(r(e,ve((function(e){return/^\d+$/.test(e)}),Z(e)))).join(", ")+"]";case"[object Boolean]":return"object"==typeof e?"new Boolean("+n(e.valueOf())+")":e.toString();case"[object Date]":return"new Date("+(isNaN(e.valueOf())?n(NaN):ue(he(e)))+")";case"[object Map]":return"new Map("+n(Array.from(e))+")";case"[object Null]":return"null";case"[object Number]":return"object"==typeof e?"new Number("+n(e.valueOf())+")":1/e==-1/0?"-0":e.toString(10);case"[object Set]":return"new Set("+n(Array.from(e).sort())+")";case"[object String]":return"object"==typeof e?"new String("+n(e.valueOf())+")":ue(e);case"[object Undefined]":return"undefined";default:if("function"==typeof e.toString){var i=e.toString();if("[object Object]"!==i)return i}return"{"+r(e,Z(e)).join(", ")+"}"}}const we=k((function(e){return _e(e,[])})),be=A((function(e,t){if(N(e)){if(N(t))return e.concat(t);throw new TypeError(we(t)+" is not an array")}if(Y(e)){if(Y(t))return e+t;throw new TypeError(we(t)+" is not a string")}if(null!=e&&X(e["fantasy-land/concat"]))return e["fantasy-land/concat"](t);if(null!=e&&X(e.concat))return e.concat(t);throw new TypeError(we(e)+' does not have a method named "concat" or "fantasy-land/concat"')})),Ee=Number.isInteger||function(e){return(0|e)===e},Ie=A((function(e,t){var n=e<0?t.length+e:e;return Y(t)?t.charAt(n):t[n]})),Te=A((function(e,t){if(null!=t)return Ee(e)?Ie(e,t):t[e]}));function ke(e){return function t(n,r,i){switch(arguments.length){case 0:return t;case 1:return T(n)?t:A((function(t,r){return e(n,t,r)}));case 2:return T(n)&&T(r)?t:T(n)?A((function(t,n){return e(t,r,n)})):T(r)?A((function(t,r){return e(n,t,r)})):k((function(t){return e(n,r,t)}));default:return T(n)&&T(r)&&T(i)?t:T(n)&&T(r)?A((function(t,n){return e(t,n,i)})):T(n)&&T(i)?A((function(t,n){return e(t,r,n)})):T(r)&&T(i)?A((function(t,r){return e(n,t,r)})):T(n)?k((function(t){return e(t,r,i)})):T(r)?k((function(t){return e(n,t,i)})):T(i)?k((function(t){return e(n,r,t)})):e(n,r,i)}}}const Se=k((function(e){return!!N(e)||!!e&&"object"==typeof e&&!Y(e)&&(0===e.length||e.length>0&&e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1))}));var Ae="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";function Oe(e,t,n){return function(r,i,s){if(Se(s))return e(r,i,s);if(null==s)return i;if("function"==typeof s["fantasy-land/reduce"])return t(r,i,s,"fantasy-land/reduce");if(null!=s[Ae])return n(r,i,s[Ae]());if("function"==typeof s.next)return n(r,i,s);if("function"==typeof s.reduce)return t(r,i,s,"reduce");throw new TypeError("reduce: list must be array or iterable")}}function xe(e,t,n){for(var r=0,i=n.length;r<i;){if((t=e["@@transducer/step"](t,n[r]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r+=1}return e["@@transducer/result"](t)}const Ce=A((function(e,t){return S(e.length,(function(){return e.apply(t,arguments)}))})),Pe=Oe(xe,(function(e,t,n,r){return e["@@transducer/result"](n[r](Ce(e["@@transducer/step"],e),t))}),(function(e,t,n){for(var r=n.next();!r.done;){if((t=e["@@transducer/step"](t,r.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r=n.next()}return e["@@transducer/result"](t)}));var Ne=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},e}();function Re(e){return new Ne(e)}const je=ke((function(e,t,n){return Pe("function"==typeof e?Re(e):e,t,n)})),Le=$e({id:"log"});var De={};function Me(e,t){De[e]=!0,Le(`Suppressing ${e}, reason=${t||"none_given"}`)}function Ue(e){De[e]=!1,Le(`Unsuppressing ${e}`)}function $e(e){let{id:t}=e;return function(e){De[t]||("[object Object]"==e.toString()?(console.log(`[${t}]:: > `),console.log(e)):console.log(`[${t}]:: ${e}`))}}const Fe=$e({id:"fp"}),Be=C(Q);function Ve(e,t){return Be(((t,n)=>e(n,t)),t)}function qe(e){return nn(e)?ot(e):an(e)?St(e):e}function ze(e){return Object.keys(e)}function He(e){let t=ze(e),n=St(e);return $t(t)?[]:bt(t,(e=>n[e]))}function Ke(e){let t=ze(e);return $t(t)?[]:bt(t,(t=>e[t]))}function We(e,t){return Object.assign(St(e),t)}function Ge(e){return e.reduce(We,{})}function Ze(e,t){return e[t]}function Je(e,t,n){return e[t]=n,e}function Qe(e,t,n){let r=St(e);return r[t]=n,r}function Xe(e){return function(t){return t[e]}}function Ye(e,t){return function(n){return Je(n,e,t)}}function et(e,t){return function(n){return Je(n,e,t)}}function tt(e){return an(e)&&Dt(Mt(ze(e)))}function nt(e,t,n){for(var r=e,i=0;i<t.length-1;i++)r=r[i];let s=dt(t);return r[s]=n(r[s]),St(e)}function rt(e){return Zt(ze(e),Ke(e))}var it=rt;function st(e,t){let n=bt(Ke(e),t);return Xt(ze(e),n)}function at(e,t=[]){let n=Z(e),r=[];for(var i of n){let n=e[i];if(an(n))at(n,be(t,[i])).map((e=>r.push(e)));else{let e=be(t,[i]);r.push({value:n,path:e})}}return r}function ot(e){return JSON.parse(JSON.stringify(e))}function ct(e){return e[0]}function ut(e){return e[1]}function lt(e){return e[2]}function ht(e){return e[3]}function dt(e){return e[e.length-1]}function ft(e,t){return e[t]}function pt(e){return function(t){return ft(t,e)}}function mt(e){return e.reduce(((e,t)=>e&&t))}function gt(e){return!$t(e)&&e.reduce(((e,t)=>e||t))}function yt(e){return!gt(e)}function vt(e){return!mt(e)}function _t(e,t){let n=[];for(var r of wt(t))n.push(qe(e));return n}function wt(e,t=null){if(t){for(var n=Array(t-e).fill(0),r=0;r<n.length;r++)n[r]=r+e;return n}for(n=Array(e).fill(0),r=0;r<n.length;r++)n[r]=r;return n}function bt(e,t){return e.map(t)}function Et(e){return Ve(((e,t)=>[e,t]),e)}function It(e,t){return Q(Te(e))(t)}function Tt(e,t,n,r){return je(t,n,It(e,r))}function kt(e){let t=[],n=e[0].length,r=e.length;for(var i=0;i<n;i++){for(var s=new Array,a=0;a<r;a++)s.push(e[a][i]);t.push(s)}return t}function St(e){return JSON.parse(JSON.stringify(e))}function At(e,t){let n=St(e);return n.push(t),n}function Ot(e,t){return St(e).filter((e=>!(e==t)))}function xt(e){var t=1;return"-"===e[0]&&(t=-1,e=e.substr(1)),function(n,r){return(n[e]<r[e]?-1:n[e]>r[e]?1:0)*t}}function Ct(e,t){let n=Math.ceil(e.length/t),r=Array(n).fill(null).map((e=>new Array)),i=0;for(var s=0;s<e.length;s++)s%t==0&&0!=s&&(i+=1),r[i].push(e[s]);return r}function Pt(e,t){let n=[];for(var[r,i]of Et(e))n.push(t(r,i));return n}function Nt(e,t){return e.concat(t)}function Rt(e,t){return bt(e,Xe(t))}function jt(e,t,n){return bt(e,Ye(t,n))}function Lt(e,t,n){return bt(e,et(t,n))}function Dt(e){return 0==e}function Mt(e){return e.length}function Ut(e){return nn(e)&&Dt(Mt(e))}function $t(e){return Yt(e)||en(e)||Ut(e)||on(e)||tt(e)}function Ft(e){return!$t(e)}function Bt(e,t){return e.filter(t)}function Vt(e,t,n){return Bt(e,(e=>n(Ze(e,t))))}function qt(e,t,n){return Vt(e,t,(e=>e==n))}function zt(e){return Bt(e,Ft)}function Ht(e){return gt(bt(e,nn))}function Kt(e){return e.flat()}function Wt(e){return Ht(e)?Wt(Kt(e)):e}function Gt(e){return zt(Wt(e))}function Zt(e,t){let n=[];for(var r=0;r<e.length;r++)n.push([e[r],t[r]]);return n}var Jt=Zt;function Qt(e){let t={};for(var[n,r]of e)t[n]=r;return t}function Xt(e,t){return Qt(Jt(e,t))}function Yt(e){return null==e}function en(e){return null==e}function tn(e){return!(Yt(e)||en(e))}function nn(e){return tn(e)&&e.constructor==Array}function rn(e){return tn(e)&&e.constructor==String}function sn(e){return tn(e)&&e.constructor==Object}function an(e){return tn(e)&&sn(e)&&!nn(e)}function on(e){return""==e}function cn(e,t,n){return e.substring(t,n)}function un(e,t){return cn(e,0,t)}function ln(e,t){return e.join(t)}function hn(e){return function(t){return ln(t,e)}}function dn(e,t){return e.split(t)}function fn(e,t){let n=ot(t),r=n.shift(),i=e;for(;r;)i=i.replace("{}",String(r)),r=n.shift();return i}function pn(e,t){return e+t}function mn(e,t){return e-t}function gn(e,t){return e*t}function yn(e,t){return e/t}function vn(e){return function(t){return t+e}}function _n(e){return function(t){return t-e}}function wn(e){return function(t){return t/e}}function bn(e){return function(t){return t*e}}function En(e){let t=[];for(var n=1;n<e.length;n++)t.push(e[n]-e[n-1]);return t}function In(e,t){return e==t}function Tn(e,t){var n={attempt_ref:null};return r=>{n.attempt_ref&&clearTimeout(n.attempt_ref),n.attempt_ref=setTimeout((function(){t(r)}),e)}}function kn(e,t){let n={},r=[];return Z(e).map((i=>{try{n[i]=e[i](t)}catch(e){r.push(e),n[i]=null}})),r.length&&(Fe("Error while applying function to dictionary"),Fe(r),Fe(n)),n}async function Sn(e,t){let n={},r=[],i=Z(e).map((async i=>{try{n[i]=await e[i](t)}catch(e){r.push(e),n[i]=null}}));return await Promise.all(i),r.length&&(Fe("Error while applying function to dictionary"),Fe(r),Fe(n)),n}const An=function(){return!1},On=function(){return!0},xn={"@@functional/placeholder":!0},Cn=A((function(e,t){return Number(e)+Number(t)})),Pn=k((function(e){return x(e.length,(function(){var t=arguments[0],n=arguments[arguments.length-1],r=n.length-1,i=Array.prototype.slice.call(arguments,0);return i[0]=function(){var e=t.apply(this,I(arguments,[r,n]));return r-=1,e},e.apply(this,i)}))}));var Nn=ke((function(e,t,n){var r=n.length;if(e>=r||e<-r)return n;var i=(r+e)%r,s=I(n);return s[i]=t(n[i]),s}));const Rn=Nn;function jn(e){return e&&e["@@transducer/reduced"]?e:{"@@transducer/value":e,"@@transducer/reduced":!0}}var Ln=function(){function e(e,t){this.xf=t,this.f=e,this.all=!0}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=function(e){return this.all&&(e=this.xf["@@transducer/step"](e,!0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)||(this.all=!1,e=jn(this.xf["@@transducer/step"](e,!1))),e},e}();const Dn=A(L(["all"],(function(e){return function(t){return new Ln(e,t)}}),(function(e,t){for(var n=0;n<t.length;){if(!e(t[n]))return!1;n+=1}return!0}))),Mn=A((function(e,t){if(e===t)return t;function n(e,t){if(e>t!=t>e)return t>e?t:e}var r=n(e,t);if(void 0!==r)return r;var i=n(typeof e,typeof t);if(void 0!==i)return i===typeof e?e:t;var s=we(e),a=n(s,we(t));return void 0!==a&&a===s?e:t})),Un=A((function(e,t){return Q(Te(e),t)}));var $n=k((function(e){return x(je(Mn,0,Un("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(!e[t].apply(this,arguments))return!1;t+=1}return!0}))}));const Fn=$n,Bn=k((function(e){return function(){return e}})),Vn=A((function(e,t){return e&&t}));var qn=function(){function e(e,t){this.xf=t,this.f=e,this.any=!1}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=function(e){return this.any||(e=this.xf["@@transducer/step"](e,!1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.any=!0,e=jn(this.xf["@@transducer/step"](e,!0))),e},e}();const zn=A(L(["any"],(function(e){return function(t){return new qn(e,t)}}),(function(e,t){for(var n=0;n<t.length;){if(e(t[n]))return!0;n+=1}return!1})));var Hn=k((function(e){return x(je(Mn,0,Un("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(e[t].apply(this,arguments))return!0;t+=1}return!1}))}));const Kn=Hn,Wn=Oe(P,(function(e,t,n,r){return n[r](e,t)}),(function(e,t,n){for(var r=n.next();!r.done;)t=e(t,r.value),r=n.next();return t})),Gn=A((function(e,t){return"function"==typeof t["fantasy-land/ap"]?t["fantasy-land/ap"](e):"function"==typeof e.ap?e.ap(t):"function"==typeof e?function(n){return e(n)(t(n))}:Wn((function(e,n){return I(e,Q(n,t))}),[],e)}));var Zn=function(){function e(e,t){this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.store(t),this.full?this.xf["@@transducer/step"](e,this.getCopy()):e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},e.prototype.getCopy=function(){return I(Array.prototype.slice.call(this.acc,this.pos),Array.prototype.slice.call(this.acc,0,this.pos))},e}();const Jn=A(L([],(function(e){return function(t){return new Zn(e,t)}}),(function(e,t){for(var n=0,r=t.length-(e-1),i=new Array(r>=0?r:0);n<r;)i[n]=Array.prototype.slice.call(t,n,n+e),n+=1;return i}))),Qn=A((function(e,t){return I(t,[e])})),Xn=A((function(e,t){return e.apply(this,t)}));var Yn=k((function(e){for(var t=Z(e),n=t.length,r=[],i=0;i<n;)r[i]=e[t[i]],i+=1;return r}));const er=Yn;function tr(e,t){return N(t)?t.map(e):Z(t).reduce((function(n,r){return n[r]=e(t[r]),n}),{})}const nr=k((function e(t){return t=tr((function(t){return"function"==typeof t?t:e(t)}),t),x(je(Mn,0,Un("length",er(t))),(function(){var e=arguments;return tr((function(t){return Xn(t,e)}),t)}))})),rr=A((function(e,t){return t(e)})),ir=ke((function(e,t,n){var r=e(t),i=e(n);return r<i?-1:r>i?1:0}));function sr(e,t,n){if(Ee(e)&&N(n)){var r=[].concat(n);return r[e]=t,r}var i={};for(var s in n)i[s]=n[s];return i[e]=t,i}const ar=k((function(e){return null==e}));var or=ke((function e(t,n,r){if(0===t.length)return n;var i=t[0];if(t.length>1){var s=!ar(r)&&B(i,r)&&"object"==typeof r[i]?r[i]:Ee(t[1])?[]:{};n=e(Array.prototype.slice.call(t,1),n,s)}return sr(i,n,r)}));const cr=or;var ur=ke((function(e,t,n){return cr([e],t,n)}));const lr=ur,hr=A((function(e,t){switch(e){case 0:return function(){return t.call(this)};case 1:return function(e){return t.call(this,e)};case 2:return function(e,n){return t.call(this,e,n)};case 3:return function(e,n,r){return t.call(this,e,n,r)};case 4:return function(e,n,r,i){return t.call(this,e,n,r,i)};case 5:return function(e,n,r,i,s){return t.call(this,e,n,r,i,s)};case 6:return function(e,n,r,i,s,a){return t.call(this,e,n,r,i,s,a)};case 7:return function(e,n,r,i,s,a,o){return t.call(this,e,n,r,i,s,a,o)};case 8:return function(e,n,r,i,s,a,o,c){return t.call(this,e,n,r,i,s,a,o,c)};case 9:return function(e,n,r,i,s,a,o,c,u){return t.call(this,e,n,r,i,s,a,o,c,u)};case 10:return function(e,n,r,i,s,a,o,c,u,l){return t.call(this,e,n,r,i,s,a,o,c,u,l)};default:throw new Error("First argument to nAry must be a non-negative integer no greater than ten")}})),dr=k((function(e){return hr(2,e)})),fr=A((function(e,t){var n=x(e,t);return x(e,(function(){return P(Gn,Q(n,arguments[0]),Array.prototype.slice.call(arguments,1))}))})),pr=k((function(e){return fr(e.length,e)})),mr=A((function(e,t){return X(e)?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:pr(Vn)(e,t)})),gr=k((function(e){return e.apply(this,Array.prototype.slice.call(arguments,1))}));function yr(e){return function t(n){for(var r,i,s,a=[],o=0,c=n.length;o<c;){if(Se(n[o]))for(s=0,i=(r=e?t(n[o]):n[o]).length;s<i;)a[a.length]=r[s],s+=1;else a[a.length]=n[o];o+=1}return a}}var vr="@@transducer/init",_r="@@transducer/step",wr="@@transducer/result",br=function(){function e(e){this.xf=e}return e.prototype[vr]=M,e.prototype[wr]=U,e.prototype[_r]=function(e,t){var n=this.xf[_r](e,t);return n["@@transducer/reduced"]?{"@@transducer/value":n,"@@transducer/reduced":!0}:n},e}(),Er=function(){function e(e){this.xf=new br(e)}return e.prototype[vr]=M,e.prototype[wr]=U,e.prototype[_r]=function(e,t){return Se(t)?Pe(this.xf,e,t):xe(this.xf,e,[t])},e}();const Ir=A(L(["fantasy-land/chain","chain"],(function(e){return function(t){return F(e)(function(e){return new Er(e)}(t))}}),(function(e,t){return"function"==typeof t?function(n){return e(t(n))(n)}:yr(!1)(Q(e,t))})));var Tr=ke((function(e,t,n){if(e>t)throw new Error("min must not be greater than max in clamp(min, max, value)");return n<e?e:n>t?t:n}));const kr=Tr;function Sr(e){return new RegExp(e.source,e.flags?e.flags:(e.global?"g":"")+(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.sticky?"y":"")+(e.unicode?"u":"")+(e.dotAll?"s":""))}function Ar(e,t,n){if(n||(n=new Or),i=typeof(r=e),null==r||"object"!=i&&"function"!=i)return e;var r,i,s=function(r){var i=n.get(e);if(i)return i;for(var s in n.set(e,r),e)Object.prototype.hasOwnProperty.call(e,s)&&(r[s]=t?Ar(e[s],!0,n):e[s]);return r};switch(re(e)){case"Object":return s(Object.create(Object.getPrototypeOf(e)));case"Array":return s([]);case"Date":return new Date(e.valueOf());case"RegExp":return Sr(e);case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":return e.slice();default:return e}}var Or=function(){function e(){this.map={},this.length=0}return e.prototype.set=function(e,t){const n=this.hash(e);let r=this.map[n];r||(this.map[n]=r=[]),r.push([e,t]),this.length+=1},e.prototype.hash=function(e){let t=[];for(var n in e)t.push(Object.prototype.toString.call(e[n]));return t.join()},e.prototype.get=function(e){if(this.length<=180){for(const t in this.map){const n=this.map[t];for(let t=0;t<n.length;t+=1){const r=n[t];if(r[0]===e)return r[1]}}return}const t=this.hash(e),n=this.map[t];if(n)for(let t=0;t<n.length;t+=1){const r=n[t];if(r[0]===e)return r[1]}},e}(),xr=k((function(e){return null!=e&&"function"==typeof e.clone?e.clone():Ar(e,!0)}));const Cr=xr,Pr=A((function(e,t){var n=Wn((function(t,n){var r=e(n);return void 0===t[r]&&(t[r]=[]),t[r].push(n),t}),{},t),r=[];for(var i in n)r.push(n[i]);return r})),Nr=k((function(e){return function(t,n){return e(t,n)?-1:e(n,t)?1:0}})),Rr=k((function(e){return!e})),jr=pr(Rr);function Lr(e,t){return function(){return t.call(this,e.apply(this,arguments))}}function Dr(e,t){return function(){var n=arguments.length;if(0===n)return t();var r=arguments[n-1];return N(r)||"function"!=typeof r[e]?t.apply(this,arguments):r[e].apply(r,Array.prototype.slice.call(arguments,0,n-1))}}const Mr=ke(Dr("slice",(function(e,t,n){return Array.prototype.slice.call(n,e,t)}))),Ur=k(Dr("tail",Mr(1,1/0)));function $r(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return S(arguments[0].length,je(Lr,arguments[0],Ur(arguments)))}const Fr=k((function(e){return Y(e)?e.split("").reverse().join(""):Array.prototype.slice.call(e,0).reverse()}));function Br(){if(0===arguments.length)throw new Error("compose requires at least one argument");return $r.apply(this,Fr(arguments))}const Vr=Ie(0);function qr(e){return e}const zr=k(qr),Hr=A((function(e,t){if(t.length<=0)return zr;var n=Vr(t),r=Ur(t);return S(n.length,(function(){return Wn((function(t,n){return e.call(this,n,t)}),n.apply(this,arguments),r)}))})),Kr=A((function(e,t){return Hr.apply(this,[e,Fr(t)])})),Wr=k((function(e){return S(je(Mn,0,Q((function(e){return e[0].length}),e)),(function(){for(var t=0;t<e.length;){if(e[t][0].apply(this,arguments))return e[t][1].apply(this,arguments);t+=1}}))})),Gr=k((function(e){return x(e.length,e)})),Zr=A((function(e,t){if(e>10)throw new Error("Constructor with greater than ten arguments");return 0===e?function(){return new t}:Gr(hr(e,(function(n,r,i,s,a,o,c,u,l,h){switch(e){case 1:return new t(n);case 2:return new t(n,r);case 3:return new t(n,r,i);case 4:return new t(n,r,i,s);case 5:return new t(n,r,i,s,a);case 6:return new t(n,r,i,s,a,o);case 7:return new t(n,r,i,s,a,o,c);case 8:return new t(n,r,i,s,a,o,c,u);case 9:return new t(n,r,i,s,a,o,c,u,l);case 10:return new t(n,r,i,s,a,o,c,u,l,h)}})))})),Jr=k((function(e){return Zr(e.length,e)})),Qr=A((function(e,t){return x(je(Mn,0,Un("length",t)),(function(){var n=arguments,r=this;return e.apply(r,D((function(e){return e.apply(r,n)}),t))}))})),Xr=Gr((function(e,t){return Wn((function(t,n){return e(n)?t+1:t}),0,t)}));var Yr=function(){function e(e,t,n,r){this.valueFn=e,this.valueAcc=t,this.keyFn=n,this.xf=r,this.inputs={}}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=function(e){var t;for(t in this.inputs)if(B(t,this.inputs)&&(e=this.xf["@@transducer/step"](e,this.inputs[t]))["@@transducer/reduced"]){e=e["@@transducer/value"];break}return this.inputs=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){var n=this.keyFn(t);return this.inputs[n]=this.inputs[n]||[n,Ar(this.valueAcc,!1)],this.inputs[n][1]=this.valueFn(this.inputs[n][1],t),e},e}(),ei=O(4,[],L([],(function(e,t,n){return function(r){return new Yr(e,t,n,r)}}),(function(e,t,n,r){var i=Re((function(r,i){var s=n(i),a=e(B(s,r)?r[s]:Ar(t,!1),i);return a&&a["@@transducer/reduced"]?jn(r):(r[s]=a,r)}));return Pe(i,{},r)})));const ti=ei,ni=ti((function(e,t){return e+1}),0),ri=Cn(-1),ii=A((function(e,t){return null==t||t!=t?e:t})),si=ke((function(e,t,n){var r=e(t),i=e(n);return r>i?-1:r<i?1:0}));function ai(e,t,n){var r,i=typeof e;switch(i){case"string":case"number":return 0===e&&1/e==-1/0?!!n._items["-0"]||(t&&(n._items["-0"]=!0),!1):null!==n._nativeSet?t?(r=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===r):n._nativeSet.has(e):i in n._items?e in n._items[i]||(t&&(n._items[i][e]=!0),!1):(t&&(n._items[i]={},n._items[i][e]=!0),!1);case"boolean":if(i in n._items){var s=e?1:0;return!!n._items[i][s]||(t&&(n._items[i][s]=!0),!1)}return t&&(n._items[i]=e?[!1,!0]:[!0,!1]),!1;case"function":return null!==n._nativeSet?t?(r=n._nativeSet.size,n._nativeSet.add(e),n._nativeSet.size===r):n._nativeSet.has(e):i in n._items?!!ce(e,n._items[i])||(t&&n._items[i].push(e),!1):(t&&(n._items[i]=[e]),!1);case"undefined":return!!n._items[i]||(t&&(n._items[i]=!0),!1);case"object":if(null===e)return!!n._items.null||(t&&(n._items.null=!0),!1);default:return(i=Object.prototype.toString.call(e))in n._items?!!ce(e,n._items[i])||(t&&n._items[i].push(e),!1):(t&&(n._items[i]=[e]),!1)}}const oi=function(){function e(){this._nativeSet="function"==typeof Set?new Set:null,this._items={}}return e.prototype.add=function(e){return!ai(e,!0,this)},e.prototype.has=function(e){return ai(e,!1,this)},e}();var ci=A((function(e,t){for(var n=[],r=0,i=e.length,s=t.length,a=new oi,o=0;o<s;o+=1)a.add(t[o]);for(;r<i;)a.add(e[r])&&(n[n.length]=e[r]),r+=1;return n}));const ui=ci;var li=ke((function(e,t,n){for(var r=[],i=0,s=t.length;i<s;)te(e,t[i],n)||te(e,t[i],r)||r.push(t[i]),i+=1;return r}));const hi=li,di=ke((function(e,t,n){var r=Array.prototype.slice.call(n,0);return r.splice(e,t),r}));var fi=A((function e(t,n){if(null==n)return n;switch(t.length){case 0:return n;case 1:return function(e,t){if(null==t)return t;if(Ee(e)&&N(t))return di(e,1,t);var n={};for(var r in t)n[r]=t[r];return delete n[e],n}(t[0],n);default:var r=t[0],i=Array.prototype.slice.call(t,1);return null==n[r]?function(e,t){if(Ee(e)&&N(t))return[].concat(t);var n={};for(var r in t)n[r]=t[r];return n}(r,n):lr(r,e(i,n[r]),n)}}));const pi=fi;var mi=A((function(e,t){return pi([e],t)}));const gi=mi,yi=A((function(e,t){return e/t}));var vi=function(){function e(e,t){this.xf=t,this.n=e}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=U,e.prototype["@@transducer/step"]=function(e,t){return this.n>0?(this.n-=1,e):this.xf["@@transducer/step"](e,t)},e}();const _i=A(L(["drop"],(function(e){return function(t){return new vi(e,t)}}),(function(e,t){return Mr(Math.max(0,e),1/0,t)})));var wi=function(){function e(e,t){this.xf=t,this.n=e,this.i=0}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=U,e.prototype["@@transducer/step"]=function(e,t){this.i+=1;var n=0===this.n?e:this.xf["@@transducer/step"](e,t);return this.n>=0&&this.i>=this.n?jn(n):n},e}();const bi=A(L(["take"],(function(e){return function(t){return new wi(e,t)}}),(function(e,t){return Mr(0,e<0?1/0:e,t)})));var Ei=function(){function e(e,t){if(e<=0)return t;this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.full&&(e=this.xf["@@transducer/step"](e,this.acc[this.pos])),this.store(t),e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},e}();const Ii=A(L([],(function(e){return function(t){return new Ei(e,t)}}),(function(e,t){return bi(e<t.length?t.length-e:0,t)})));var Ti=function(){function e(e,t){this.f=e,this.retained=[],this.xf=t}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=function(e){return this.retained=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.retain(e,t):this.flush(e,t)},e.prototype.flush=function(e,t){return e=Pe(this.xf,e,this.retained),this.retained=[],this.xf["@@transducer/step"](e,t)},e.prototype.retain=function(e,t){return this.retained.push(t),e},e}();const ki=A(L([],(function(e){return function(t){return new Ti(e,t)}}),(function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return Mr(0,n+1,t)})));var Si=function(){function e(e,t){this.xf=t,this.pred=e,this.lastValue=void 0,this.seenFirstValue=!1}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=U,e.prototype["@@transducer/step"]=function(e,t){var n=!1;return this.seenFirstValue?this.pred(this.lastValue,t)&&(n=!0):this.seenFirstValue=!0,this.lastValue=t,n?e:this.xf["@@transducer/step"](e,t)},e}();function Ai(e){return function(t){return new Si(e,t)}}const Oi=Ie(-1);var xi=A(L([],Ai,(function(e,t){var n=[],r=1,i=t.length;if(0!==i)for(n[0]=t[0];r<i;)e(Oi(n),t[r])||(n[n.length]=t[r]),r+=1;return n})));const Ci=xi,Pi=k(L([],(function(){return Ai(ae)}),Ci(ae))),Ni=ke((function(e,t,n){return ae(e(t),e(n))})),Ri=A((function(e,t){return L([],(function(){return Ai(Ni(e))}),Ci(Ni(e)))(t)}));var ji=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=U,e.prototype["@@transducer/step"]=function(e,t){if(this.f){if(this.f(t))return e;this.f=null}return this.xf["@@transducer/step"](e,t)},e}(),Li=A(L(["dropWhile"],(function(e){return function(t){return new ji(e,t)}}),(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return Mr(n,1/0,t)})));const Di=Li,Mi=A((function(e,t){return e||t})),Ui=A((function(e,t){return X(e)?function(){return e.apply(this,arguments)||t.apply(this,arguments)}:pr(Mi)(e,t)})),$i=k((function(e){return null!=e&&"function"==typeof e["fantasy-land/empty"]?e["fantasy-land/empty"]():null!=e&&null!=e.constructor&&"function"==typeof e.constructor["fantasy-land/empty"]?e.constructor["fantasy-land/empty"]():null!=e&&"function"==typeof e.empty?e.empty():null!=e&&null!=e.constructor&&"function"==typeof e.constructor.empty?e.constructor.empty():N(e)?[]:Y(e)?"":pe(e)?{}:q(e)?function(){return arguments}():(t=e,"[object Uint8ClampedArray]"===(n=Object.prototype.toString.call(t))||"[object Int8Array]"===n||"[object Uint8Array]"===n||"[object Int16Array]"===n||"[object Uint16Array]"===n||"[object Int32Array]"===n||"[object Uint32Array]"===n||"[object Float32Array]"===n||"[object Float64Array]"===n||"[object BigInt64Array]"===n||"[object BigUint64Array]"===n?e.constructor.from(""):void 0);var t,n})),Fi=A((function(e,t){return _i(e>=0?t.length-e:0,t)})),Bi=A((function(e,t){return ae(Fi(e.length,t),e)}));var Vi=ke((function(e,t,n){return ae(t[e],n[e])}));const qi=Vi;var zi=A((function e(t,n){if(!pe(n)&&!N(n))return n;var r,i,s,a=n instanceof Array?[]:{};for(i in n)s=typeof(r=t[i]),a[i]="function"===s?r(n[i]):r&&"object"===s?e(r,n[i]):n[i];return a}));const Hi=zi;var Ki=function(){function e(e,t){this.xf=t,this.f=e,this.found=!1}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,void 0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.found=!0,e=jn(this.xf["@@transducer/step"](e,t))),e},e}(),Wi=A(L(["find"],(function(e){return function(t){return new Ki(e,t)}}),(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return t[n];n+=1}})));const Gi=Wi;var Zi=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.found=!1}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,-1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.found=!0,e=jn(this.xf["@@transducer/step"](e,this.idx))),e},e}(),Ji=A(L([],(function(e){return function(t){return new Zi(e,t)}}),(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return n;n+=1}return-1})));const Qi=Ji;var Xi=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.last))},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.last=t),e},e}();const Yi=A(L([],(function(e){return function(t){return new Xi(e,t)}}),(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return t[n];n-=1}})));var es=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.lastIdx=-1}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.lastIdx))},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.lastIdx=this.idx),e},e}();const ts=A(L([],(function(e){return function(t){return new es(e,t)}}),(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return n;n-=1}return-1}))),ns=k(yr(!0)),rs=k((function(e){return x(e.length,(function(t,n){var r=Array.prototype.slice.call(arguments,0);return r[0]=n,r[1]=t,e.apply(this,r)}))}));var is=A(Dr("forEach",(function(e,t){for(var n=t.length,r=0;r<n;)e(t[r]),r+=1;return t})));const ss=is;var as=A((function(e,t){for(var n=Z(t),r=0;r<n.length;){var i=n[r];e(t[i],i,t),r+=1}return t}));const os=as,cs=k((function(e){for(var t={},n=0;n<e.length;)t[e[n][0]]=e[n][1],n+=1;return t})),us=A(Dr("groupBy",ti((function(e,t){return e.push(t),e}),[])));var ls=A((function(e,t){for(var n=[],r=0,i=t.length;r<i;){for(var s=r+1;s<i&&e(t[s-1],t[s]);)s+=1;n.push(t.slice(r,s)),r=s}return n}));const hs=ls,ds=A((function(e,t){return e>t})),fs=A((function(e,t){return e>=t})),ps=A((function(e,t){if(0===e.length||ar(t))return!1;for(var n=t,r=0;r<e.length;){if(ar(n)||!B(e[r],n))return!1;n=n[e[r]],r+=1}return!0}));var ms=A((function(e,t){return ps([e],t)}));const gs=ms;var ys=A((function(e,t){return!ar(t)&&e in t}));const vs=ys;var _s=function(e,t){switch(arguments.length){case 0:return _s;case 1:return function t(n){return 0===arguments.length?t:ne(e,n)};default:return ne(e,t)}};const ws=_s,bs=ke((function(e,t,n){return x(Math.max(e.length,t.length,n.length),(function(){return e.apply(this,arguments)?t.apply(this,arguments):n.apply(this,arguments)}))})),Es=Cn(1),Is=A(ce),Ts=ti((function(e,t){return t}),null),ks=A((function(e,t){return"function"!=typeof t.indexOf||N(t)?oe(t,e,0):t.indexOf(e)})),Ss=Mr(0,-1),As=ke((function(e,t,n){return fe((function(t){return te(e,t,n)}),t)})),Os=ke((function(e,t,n){e=e<n.length&&e>=0?e:n.length;var r=Array.prototype.slice.call(n,0);return r.splice(e,0,t),r})),xs=ke((function(e,t,n){return e=e<n.length&&e>=0?e:n.length,[].concat(Array.prototype.slice.call(n,0,e),t,Array.prototype.slice.call(n,e))}));var Cs=function(){function e(e,t){this.xf=t,this.f=e,this.set=new oi}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=U,e.prototype["@@transducer/step"]=function(e,t){return this.set.add(this.f(t))?this.xf["@@transducer/step"](e,t):e},e}(),Ps=A(L([],(function(e){return function(t){return new Cs(e,t)}}),(function(e,t){for(var n,r,i=new oi,s=[],a=0;a<t.length;)n=e(r=t[a]),i.add(n)&&s.push(r),a+=1;return s})));const Ns=Ps,Rs=Ns(zr);var js=A((function(e,t){for(var n=new oi,r=0;r<e.length;r+=1)n.add(e[r]);return Rs(fe(n.has.bind(n),t))}));const Ls=js,Ds=A(Dr("intersperse",(function(e,t){for(var n=[],r=0,i=t.length;r<i;)r===i-1?n.push(t[r]):n.push(t[r],e),r+=1;return n}))),Ms="function"==typeof Object.assign?Object.assign:function(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),n=1,r=arguments.length;n<r;){var i=arguments[n];if(null!=i)for(var s in i)B(s,i)&&(t[s]=i[s]);n+=1}return t};var Us=A((function(e,t){var n={};return n[e]=t,n}));const $s=Us;var Fs={"@@transducer/init":Array,"@@transducer/step":function(e,t){return e.push(t),e},"@@transducer/result":qr},Bs={"@@transducer/init":String,"@@transducer/step":function(e,t){return e+t},"@@transducer/result":qr},Vs={"@@transducer/init":Object,"@@transducer/step":function(e,t){return Ms(e,Se(t)?$s(t[0],t[1]):t)},"@@transducer/result":qr};const qs=ke((function(e,t,n){var r=t(j(e)?e:function(e){if(j(e))return e;if(Se(e))return Fs;if("string"==typeof e)return Bs;if("object"==typeof e)return Vs;throw new Error("Cannot create transformer for "+e)}(e));return Pe(r,r["@@transducer/init"](),n)}));var zs=k((function(e){for(var t=Z(e),n=t.length,r=0,i={};r<n;){var s=t[r],a=e[s],o=B(a,i)?i[a]:i[a]=[];o[o.length]=s,r+=1}return i}));const Hs=zs;var Ks=k((function(e){for(var t=Z(e),n=t.length,r=0,i={};r<n;){var s=t[r];i[e[s]]=s,r+=1}return i}));const Ws=Ks,Gs=A((function(e,t){return x(e+1,(function(){var n=arguments[e];if(null!=n&&X(n[t]))return n[t].apply(n,Array.prototype.slice.call(arguments,0,e));throw new TypeError(we(n)+' does not have a method named "'+t+'"')}))})),Zs=A((function(e,t){return t instanceof e||null!=t&&(t.constructor===e||"Object"===e.name&&"object"==typeof t)})),Js=k((function(e){return null!=e&&ae(e,$i(e))})),Qs=k((function(e){return!ar(e)})),Xs=Gs(1,"join"),Ys=k((function(e){return Qr((function(){return Array.prototype.slice.call(arguments,0)}),e)}));var ea=k((function(e){var t,n=[];for(t in e)n[n.length]=t;return n}));const ta=ea,na=A((function(e,t){if("function"!=typeof t.lastIndexOf||N(t)){for(var n=t.length-1;n>=0;){if(ae(t[n],e))return n;n-=1}return-1}return t.lastIndexOf(e)}));function ra(e){return"[object Number]"===Object.prototype.toString.call(e)}const ia=k((function(e){return null!=e&&ra(e.length)?e.length:NaN}));var sa=A((function(e,t){return function(n){return function(r){return Q((function(e){return t(e,r)}),n(e(r)))}}}));const aa=sa,oa=ke((function(e,t,n){return Rn(e,Bn(t),n)})),ca=k((function(e){return aa(Ie(e),oa(e))})),ua=A((function(e,t){return e.map((function(e){for(var n,r=t,i=0;i<e.length;){if(null==r)return;n=e[i],r=Ee(n)?Ie(n,r):r[n],i+=1}return r}))})),la=A((function(e,t){return ua([e],t)[0]})),ha=k((function(e){return aa(la(e),cr(e))})),da=k((function(e){return aa(Te(e),lr(e))})),fa=A((function(e,t){return e<t})),pa=A((function(e,t){return e<=t}));var ma=ke((function(e,t,n){for(var r=0,i=n.length,s=[],a=[t];r<i;)a=e(a[0],n[r]),s[r]=a[1],r+=1;return[a[0],s]}));const ga=ma,ya=ke((function(e,t,n){for(var r=n.length-1,i=[],s=[t];r>=0;)s=e(s[0],n[r]),i[r]=s[1],r-=1;return[s[0],i]}));var va=A((function(e,t){return P((function(n,r){return n[r]=e(t[r],r,t),n}),{},Z(t))}));const _a=va;var wa=A((function(e,t){return t.match(e)||[]}));const ba=wa,Ea=A((function(e,t){return Ee(e)?!Ee(t)||t<1?NaN:(e%t+t)%t:NaN})),Ia=ke((function(e,t,n){var r=e(n);return Mn(e(t),r)===r?n:t})),Ta=je(Cn,0),ka=k((function(e){return Ta(e)/e.length}));var Sa=k((function(e){var t=e.length;if(0===t)return NaN;var n=2-t%2,r=(t-n)/2;return ka(Array.prototype.slice.call(e,0).sort((function(e,t){return e<t?-1:e>t?1:0})).slice(r,r+n))}));const Aa=Sa;var Oa=A((function(e,t){var n={};return S(t.length,(function(){var r=e.apply(this,arguments);return B(r,n)||(n[r]=t.apply(this,arguments)),n[r]}))}));const xa=Oa,Ca=k((function(e){return Ms.apply(null,[{}].concat(e))})),Pa=ke((function(e,t,n){var r,i={};for(r in n=n||{},t=t||{})B(r,t)&&(i[r]=B(r,n)?e(r,t[r],n[r]):t[r]);for(r in n)B(r,n)&&!B(r,i)&&(i[r]=n[r]);return i})),Na=ke((function e(t,n,r){return Pa((function(n,r,i){return pe(r)&&pe(i)?e(t,r,i):t(n,r,i)}),n,r)})),Ra=A((function(e,t){return Na((function(e,t,n){return t}),e,t)})),ja=A((function(e,t){return Na((function(e,t,n){return n}),e,t)})),La=ke((function(e,t,n){return Na((function(t,n,r){return e(n,r)}),t,n)})),Da=A((function(e,t){return Ms({},t,e)})),Ma=A((function(e,t){return Ms({},e,t)})),Ua=ke((function(e,t,n){return Pa((function(t,n,r){return e(n,r)}),t,n)})),$a=A((function(e,t){if(e===t)return e;function n(e,t){if(e<t!=t<e)return t<e?t:e}var r=n(e,t);if(void 0!==r)return r;var i=n(typeof e,typeof t);if(void 0!==i)return i===typeof e?e:t;var s=we(e),a=n(s,we(t));return void 0!==a?a===s?e:t:e})),Fa=ke((function(e,t,n){var r=e(n);return $a(e(t),r)===r?n:t}));var Ba=ke((function e(t,n,r){if(!pe(r)&&!N(r))return r;if(0===t.length)return n(r);var i=t[0];if(!B(i,r))return r;if(1===t.length)return function(e,t,n){if(Ee(e)&&N(n)){var r=[].concat(n);return r[e]=t(r[e]),r}var i={};for(var s in n)i[s]=n[s];return i[e]=t(i[e]),i}(i,n,r);var s=e(Array.prototype.slice.call(t,1),n,r[i]);return s===r[i]?r:sr(i,s,r)}));const Va=Ba;var qa=ke((function(e,t,n){return Va([e],t,n)}));const za=qa,Ha=A((function(e,t){return e%t})),Ka=ke((function(e,t,n){var r=n.length,i=n.slice(),s=e<0?r+e:e,a=t<0?r+t:t,o=i.splice(s,1);return s<0||s>=n.length||a<0||a>=n.length?n:[].concat(i.slice(0,a)).concat(o).concat(i.slice(a,n.length))})),Wa=A((function(e,t){return e*t}));var Ga=A(((e,t)=>n=>e.call(void 0,ja(t,n))));const Za=Ga,Ja=k((function(e){return-e})),Qa=A((function(e,t){return Dn(de(e),t)})),Xa=k((function(e){return x(e<0?1:e+1,(function(){return Ie(e,arguments)}))})),Ya=ke((function(e,t,n){return e(t(n))})),eo=A((function(e,t){return"function"==typeof e["fantasy-land/of"]?e["fantasy-land/of"](t):"function"==typeof e.of?e.of(t):[t]}));var to=A((function(e,t){for(var n={},r={},i=0,s=e.length;i<s;)r[e[i]]=1,i+=1;for(var a in t)r.hasOwnProperty(a)||(n[a]=t[a]);return n}));const no=to,ro=O(4,[],(function(e,t,n,r){return e(t(n),t(r))})),io=k((function(e){var t,n=!1;return S(e.length,(function(){return n?t:(n=!0,t=e.apply(this,arguments))}))}));function so(e,t){if(null==t||!X(t.then))throw new TypeError("`"+e+"` expected a Promise, received "+_e(t,[]))}const ao=A((function(e,t){return so("otherwise",t),t.then(null,e)}));var oo=function(e){return{value:e,map:function(t){return oo(t(e))}}},co=ke((function(e,t,n){return e((function(e){return oo(t(e))}))(n).value}));const uo=co,lo=A((function(e,t){return[e,t]}));function ho(e){return A((function(t,n){return S(Math.max(0,t.length-n.length),(function(){return t.apply(this,e(n,arguments))}))}))}const fo=ho(I),po=ho(rs(I)),mo=Ys([ye,ve]),go=ke((function(e,t,n){return ae(la(t,n),e)})),yo=ke((function(e,t,n){return ii(e,la(t,n))})),vo=ke((function(e,t,n){return e(la(t,n))})),_o=A((function(e,t){for(var n={},r=0;r<e.length;)e[r]in t&&(n[e[r]]=t[e[r]]),r+=1;return n}));var wo=A((function(e,t){for(var n={},r=0,i=e.length;r<i;){var s=e[r];n[s]=t[s],r+=1}return n}));const bo=wo;var Eo=A((function(e,t){var n={};for(var r in t)e(t[r],r,t)&&(n[r]=t[r]);return n}));const Io=Eo,To=A((function(e,t){return I([e],t)})),ko=je(Wa,1),So=A((function(e,t){return x(t.length,(function(){for(var n=[],r=0;r<t.length;)n.push(t[r].call(this,arguments[r])),r+=1;return e.apply(this,n.concat(Array.prototype.slice.call(arguments,t.length)))}))})),Ao=So(D,[bo,zr]);function Oo(e,t,n){return function(r){return t(n(e(r)))}}var xo=function(){function e(e,t,n){this.xf=n,this.f=e,this.g=t}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=U,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,Oo(this.f,this.g,t))},e}();const Co=ke(L(["fantasy-land/promap","promap"],(function(e,t){return function(n){return new xo(e,t,n)}}),Oo)),Po=ke((function(e,t,n){return ae(e,Te(t,n))})),No=ke((function(e,t,n){return Zs(e,Te(t,n))})),Ro=ke((function(e,t,n){return ii(e,Te(t,n))})),jo=ke((function(e,t,n){return e(Te(t,n))})),Lo=A((function(e,t){return e.map((function(e){return la([e],t)}))})),Do=A((function(e,t){if(!ra(e)||!ra(t))throw new TypeError("Both arguments to range must be numbers");for(var n=[],r=e;r<t;)n.push(r),r+=1;return n})),Mo=ke((function(e,t,n){for(var r=n.length-1;r>=0;){if((t=e(n[r],t))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r-=1}return t})),Uo=O(4,[],(function(e,t,n,r){var i=Re((function(n,r){return e(n,r)?t(n,r):jn(n)}));return Pe(i,n,r)})),$o=k(jn);var Fo=A((function(e,t){var n,r=Number(t),i=0;if(r<0||isNaN(r))throw new RangeError("n must be a non-negative number");for(n=[];i<r;)n.push(e(i)),i+=1;return n}));const Bo=Fo;var Vo=A((function(e,t){return Bo(Bn(e),t)}));const qo=Vo;var zo=ke((function(e,t,n){return n.replace(e,t)}));const Ho=zo;var Ko="@@transducer/init",Wo="@@transducer/step",Go=function(){function e(e,t,n){this.xf=n,this.f=e,this.acc=t}return e.prototype[Ko]=function(){return this.xf[Wo](this.xf[Ko](),this.acc)},e.prototype["@@transducer/result"]=U,e.prototype[Wo]=function(e,t){return e["@@transducer/reduced"]?e:(this.acc=this.f(this.acc,t),this.xf[Wo](e,this.acc))},e}(),Zo=ke(L([],ke((function(e,t,n){return new Go(e,t,n)})),(function(e,t,n){for(var r=0,i=n.length,s=[t];r<i;)t=e(t,n[r]),s[r+1]=t,r+=1;return s})));const Jo=Zo,Qo=A((function(e,t){var n="function"==typeof e["fantasy-land/of"]?e["fantasy-land/of"]:"function"==typeof e.of?e.of:e,r={"fantasy-land/of":n};return"function"==typeof t["fantasy-land/traverse"]?t["fantasy-land/traverse"](r,qr):"function"==typeof t.traverse?t.traverse(r,qr):Mo((function(e,t){return Gn(Q(To,e),t)}),n([]),t)}));var Xo=ke((function(e,t,n){return uo(e,Bn(t),n)}));const Yo=Xo,ec=A((function(e,t){return Array.prototype.slice.call(t,0).sort(e)})),tc=A((function(e,t){return Array.prototype.slice.call(t,0).sort((function(t,n){var r=e(t),i=e(n);return r<i?-1:r>i?1:0}))}));var nc=A((function(e,t){return Array.prototype.slice.call(t,0).sort((function(t,n){for(var r=0,i=0;0===r&&i<e.length;)r=e[i](t,n),i+=1;return r}))}));const rc=nc,ic=Gs(1,"split");var sc=A((function(e,t){return[Mr(0,e,t),Mr(e,ia(t),t)]}));const ac=sc,oc=A((function(e,t){if(e<=0)throw new Error("First argument to splitEvery must be a positive integer");for(var n=[],r=0;r<t.length;)n.push(Mr(r,r+=e,t));return n}));var cc=A((function(e,t){for(var n=0,r=t.length,i=[];n<r&&!e(t[n]);)i.push(t[n]),n+=1;return[i,Array.prototype.slice.call(t,n)]}));const uc=cc;var lc=O(2,[],(function(e,t){for(var n=[],r=[],i=0;i<t.length;i+=1)e(t[i])||r.push(t[i]),(i<t.length-1&&e(t[i+1])||i===t.length-1)&&r.length>0&&(n.push(r),r=[]);return n}));const hc=lc,dc=A((function(e,t){return ae(bi(e.length,t),e)})),fc=A((function(e,t){return Number(e)-Number(t)}));var pc=function(e,t,n){var r=n.length,i=n.slice(),s=e<0?r+e:e,a=t<0?r+t:t,o=Math.min(s,a),c=Math.max(s,a);return s<0||s>r||a<0||a>r||s===a?i:i=[].concat(i.slice(0,o)).concat([i[c]]).concat(i.slice(o+1,c)).concat([i[o]]).concat(i.slice(c+1,r))};const mc=ke((function(e,t,n){return N(n)?pc(e,t,n):Y(n)?function(e,t,n){var r=pc(e,t,n);return N(r)?r.join(""):r}(e,t,n):function(e,t,n){var r=Cr(n),i=Object.getOwnPropertyNames(r);if(i.includes(e)&&i.includes(t)){var s=r[e];r[e]=r[t],r[t]=s}return r}(e,t,n)})),gc=A((function(e,t){return be(ui(e,t),ui(t,e))})),yc=ke((function(e,t,n){return be(hi(e,t,n),hi(e,n,t))})),vc=A((function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return Mr(n+1,1/0,t)}));var _c=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=U,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):jn(e)},e}(),wc=A(L(["takeWhile"],(function(e){return function(t){return new _c(e,t)}}),(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return Mr(0,n,t)})));const bc=wc;var Ec=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=U,e.prototype["@@transducer/step"]=function(e,t){return this.f(t),this.xf["@@transducer/step"](e,t)},e}();const Ic=A(L([],(function(e){return function(t){return new Ec(e,t)}}),(function(e,t){return e(t),t})));var Tc=A((function(e,t){if(n=e,"[object RegExp]"!==Object.prototype.toString.call(n))throw new TypeError("‘test’ requires a value of type RegExp as its first argument; received "+we(e));var n;return Sr(e).test(t)}));const kc=Tc,Sc=A((function(e,t){return so("andThen",t),t.then(e)})),Ac=Gs(0,"toLowerCase");var Oc=k((function(e){var t=[];for(var n in e)B(n,e)&&(t[t.length]=[n,e[n]]);return t}));const xc=Oc;var Cc=k((function(e){var t=[];for(var n in e)t[t.length]=[n,e[n]];return t}));const Pc=Cc,Nc=Gs(0,"toUpperCase"),Rc=x(4,(function(e,t,n,r){return Pe(e("function"==typeof t?Re(t):t),n,r)}));var jc=k((function(e){for(var t=0,n=[];t<e.length;){for(var r=e[t],i=0;i<r.length;)void 0===n[i]&&(n[i]=[]),n[i].push(r[i]),i+=1;t+=1}return n}));const Lc=jc,Dc=ke((function(e,t,n){var r={"fantasy-land/of":"function"==typeof e["fantasy-land/of"]?e["fantasy-land/of"]:"function"==typeof e.of?e.of:e};return"function"==typeof n["fantasy-land/traverse"]?n["fantasy-land/traverse"](r,t):"function"==typeof n.traverse?n.traverse(r,t):Qo(r,Q(t,n))}));var Mc="\t\n\v\f\r                　\u2028\u2029\ufeff",Uc=k("function"==typeof String.prototype.trim&&!Mc.trim()&&"​".trim()?function(e){return e.trim()}:function(e){var t=new RegExp("^["+Mc+"]["+Mc+"]*"),n=new RegExp("["+Mc+"]["+Mc+"]*$");return e.replace(t,"").replace(n,"")});const $c=Uc,Fc=A((function(e,t){return S(e.length,(function(){try{return e.apply(this,arguments)}catch(e){return t.apply(this,I([e],arguments))}}))})),Bc=k((function(e){return function(){return e(Array.prototype.slice.call(arguments,0))}})),Vc=k((function(e){return hr(1,e)}));var qc=A((function(e,t){return x(e,(function(){for(var n,r=1,i=t,s=0;r<=e&&"function"==typeof i;)n=r===e?arguments.length:s+i.length,i=i.apply(this,Array.prototype.slice.call(arguments,s,n)),r+=1,s=n;return i}))}));const zc=qc,Hc=A((function(e,t){for(var n=e(t),r=[];n&&n.length;)r[r.length]=n[0],n=e(n[1]);return r})),Kc=A(Br(Rs,I));var Wc=function(){function e(e,t){this.xf=t,this.pred=e,this.items=[]}return e.prototype["@@transducer/init"]=M,e.prototype["@@transducer/result"]=U,e.prototype["@@transducer/step"]=function(e,t){return te(this.pred,t,this.items)?e:(this.items.push(t),this.xf["@@transducer/step"](e,t))},e}(),Gc=A(L([],(function(e){return function(t){return new Wc(e,t)}}),(function(e,t){for(var n,r=0,i=t.length,s=[];r<i;)te(e,n=t[r],s)||(s[s.length]=n),r+=1;return s})));const Zc=Gc,Jc=ke((function(e,t,n){return Zc(e,I(t,n))})),Qc=ke((function(e,t,n){return e(n)?n:t(n)})),Xc=Ir(qr),Yc=ke((function(e,t,n){for(var r=n;!e(r);)r=t(r);return r}));var eu=A((function(e,t){return e in t&&N(t[e])?D((function(n){return sr(e,n,t)}),t[e]):[t]}));const tu=eu;var nu=k((function(e){var t,n=[];for(t in e)n[n.length]=e[t];return n}));const ru=nu;var iu=function(e){return{value:e,"fantasy-land/map":function(){return this}}},su=A((function(e,t){return e(iu)(t).value}));const au=su,ou=ke((function(e,t,n){return e(n)?t(n):n}));var cu=A((function(e,t){for(var n in e)if(B(n,e)&&!e[n](t[n]))return!1;return!0}));const uu=cu;var lu=A((function(e,t){for(var n in e)if(B(n,e)&&e[n](t[n]))return!0;return!1}));const hu=lu,du=A((function(e,t){return uu(Q(ae,e),t)}));var fu=A((function(e,t){for(var n=new oi,r=0;r<e.length;r+=1)n.add(e[r]);return ve(n.has.bind(n),t)}));const pu=fu,mu=A((function(e,t){return Boolean(!e^!t)})),gu=A((function(e,t){for(var n,r=0,i=e.length,s=t.length,a=[];r<i;){for(n=0;n<s;)a[a.length]=[e[r],t[n]],n+=1;r+=1}return a}));var yu=A((function(e,t){for(var n=[],r=0,i=Math.min(e.length,t.length);r<i;)n[r]=[e[r],t[r]],r+=1;return n}));const vu=yu;var _u=A((function(e,t){for(var n=0,r=Math.min(e.length,t.length),i={};n<r;)i[e[n]]=t[n],n+=1;return i}));const wu=_u;var bu=ke((function(e,t,n){for(var r=[],i=0,s=Math.min(t.length,n.length);i<s;)r[i]=e(t[i],n[i]),i+=1;return r}));const Eu=bu,Iu=k((function(e){return x(e.length,(function(){var t=arguments;return function(){return e.apply(this,t)}}))}));var Tu;!function(e){e[e.BUY=0]="BUY",e[e.SELL=1]="SELL"}(Tu||(Tu={}));class ku{constructor(e){this.Params=e,this.Logger=$e({id:e.logger_id}),this.last_balance_data={},this.log_mode="verbose",this.state={price_history:[],last_price:null,r:e.target_ratio},this.Params.alpha=this.Params.alpha||.01}log(e){this.Logger(e)}async balance_portfolio(){let{base_asset:e,quote_asset:t}=this.Params;"verbose"==this.log_mode&&this.log("Balancing...");let n=await this.get_balance_data(),{base_amt:r,quote_amt:i,base_price:s,portfolio_value:a,current_ratio:o,ratio_error:c,target_achieved:u,target_base_amt:l,base_delta:h,trade_type:d,base_market_amt:f}=n;if("verbose"==this.log_mode&&this.log(n),this.Params.adaptive&&this.state.last_price){let e=s-this.state.last_price,t=e=>Math.max(Math.min(1,e),0);this.state.r=t(this.state.r-this.Params.alpha*e),this.Params.target_ratio=this.state.r}if(this.state.last_price=s,this.state.price_history.push(s),u)return"verbose"==this.log_mode&&this.log("Target ratio already achieved. Returning"),{balanced:!1,balance_needed:!1,info:null};{"verbose"==this.log_mode&&(this.log("Target ratio NOT achieved. Continuing."),this.log(`Processing order to ${d} ${f} ${e}`));let t=await this.do_market_trade(d,f),{error:n,info:r}=t;return{balanced:!n,balance_needed:!0,info:r}}}async get_balance_data(){let{target_ratio:e,target_precision:t,quote_asset:n,base_asset:r}=this.Params,i=await this.get_base_balance(r),s=await this.get_quote_balance(n),a=await this.get_base_price(r,n),o=i*a+s,c=i*a/o,u=e-c,l=o*e/a,h=l-i,d={base_amt:i,quote_amt:s,base_price:a,portfolio_value:o,current_ratio:c,ratio_error:u,target_achieved:Math.abs(u)<t,target_ratio:e,target_precision:t,target_base_amt:l,base_delta:h,trade_type:h>=0?Tu.BUY:Tu.SELL,base_market_amt:Math.abs(h)};return this.last_balance_data=d,d}set_log_mode(e){"verbose"==this.log_mode&&(this.log(`Setting log mode to ${e}`),this.log_mode=e)}}class Su extends ku{constructor(e){super(e),this.data=e.data,this.current_index=-1,this.portfolio=Object.assign({},e.initial_portfolio),this.initial_portfolio=Object.assign({},e.initial_portfolio),this.rebalances=[],this.slippage=e.slippage,this.fee=e.fee,this.transactions_costs={fees:{base:0,quote:0},slippage:{base:0,quote:0}},this.balance_portfolio_series=[],this.hodl_portfolio_series=[],this.ratio_series=[]}async get_quote_balance(e){return this.portfolio.quote_balance}async get_base_balance(e){return this.portfolio.base_balance}async get_base_price(e,t){return this.data[this.current_index].p}async do_market_trade(e,t){let n=await this.get_base_price("",""),r=this.data[this.current_index];n!=r.p&&(this.log("Sanity check failed! - there is a problem with price indexing"),process.exit(1));let{p:i,t:s}=r;var a,o;switch(e){case Tu.BUY:a=t*(1-this.fee),o=-t*i*(1+this.slippage),this.transactions_costs.fees.base+=t*this.fee,this.transactions_costs.slippage.quote+=t*i*this.slippage;break;case Tu.SELL:a=-t,o=t*i*(1-this.fee)*(1-this.slippage),this.transactions_costs.fees.quote+=t*i*this.fee,this.transactions_costs.slippage.quote+=t*i*this.slippage}let c=this.portfolio.base_balance+=a,u=this.portfolio.quote_balance+=o;return this.portfolio={base_balance:c,quote_balance:u},this.rebalances.push({index:this.current_index,p:i,t:s,trade_type:e,base_amt:t,quote_amt:t*i,portfolio:this.get_portfolio_value_and_time(this.portfolio,i,s),hodl_portfolio:this.get_portfolio_value_and_time(this.initial_portfolio,i,s),cummulative_transactions_costs:{raw:Object.assign({},this.transactions_costs),values:this.get_transactions_costs_values(this.transactions_costs,i)}}),{error:!1,info:null}}symbol_generator(e,t){return"BACKTESTER"}async process_data(){this.current_index+=1,await this.balance_portfolio();let{p:e,t}=this.data[this.current_index];this.hodl_portfolio_series.push(this.get_portfolio_value_and_time(this.initial_portfolio,e,t)),this.balance_portfolio_series.push(this.get_portfolio_value_and_time(this.portfolio,e,t)),this.ratio_series.push(this.Params.target_ratio)}get_portfolio_value_and_time(e,t,n){let r=e.base_balance*t+e.quote_balance;return{base_balance:e.base_balance,quote_balance:e.quote_balance,value:r,p:t,t:n}}get_transactions_costs_values(e,t){let{fees:n,slippage:r}=e,i=n.base*t+n.quote,s=r.base*t+r.quote;return{fee_cost:i,slippage_cost:s,total:i+s}}async backtest(){this.log("Starting backtest...");let e=this.data.length;for(var t=0;t<e;t++)await this.process_data(),t%100==0&&this.log(`Progress = ${t}/${e}`);this.log("Done")}}function Au(e){return e.length}function Ou(e){let t=0;for(var n=0;n<e.length;n++)t+=window.Math.pow(e[n],2);return Math.pow(t,.5)}function xu(e){let t=0;for(var n=0;n<e.length;n++)t+=e[n];return t}function Cu(e){let t=[];for(var n=0;n<e.length;n++)t[n]=Math.abs(e[n]);return t}function Pu(e){return xu(e)/Au(e)}function Nu(e){return Pu(Cu(e))}function Ru(e){return{max:Math.max.apply(null,e),min:Math.min.apply(null,e),mean:Pu(e)}}function ju(e){const t=e.reduce(((e,t)=>e+t.length),0),n=new Float32Array(t);let r=0;return e.forEach((e=>{n.set(e,r),r+=e.length})),n}function Lu(){return performance.now()}var Du={};function Mu(e,t){Du[e]=t}function Uu(e){return Du[e]}var $u=$e({id:"debug"});function Fu(e){let t=new ArrayBuffer(8);return new DataView(t).setBigUint64(0,BigInt(e),!1),new Uint8Array(t)}function Bu(e){let t=Fu(Date.now()),n=new Uint8Array(t.length+e.length);return n.set(t),n.set(e,t.length),n}function Vu(){return"undefined"!=typeof window&&void 0!==window.document}function qu(){return"undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node}function zu(){return Number(new Date)}function Hu(e){try{return JSON.parse(e),!0}catch(e){return!1}}let Ku=()=>performance.now();var Wu,Gu;function Zu(e,t,n){var r=Ku();return n=n||200,new Promise(((i,s)=>{let a=setInterval((function(){let n=Ku();e()?(i(!1),clearInterval(a)):t&&n-r>=t&&(i(!0),clearInterval(a))}),n)}))}function Ju(e){return new Promise(((t,n)=>{setTimeout((function(){t(Wu.TIMEOUT)}),e)}))}function Qu(e){Mu("pre_clean",e);let t=e.split("\n").join("").replace(/  /g,"").replace(",}","}"),n=t.indexOf("{"),r=t.indexOf("[");var i;return i=n<0?r:r<0?n:Math.min(n,r),t=t.slice(i,t.length),$u(`extracting json starting at index ${i}=${t[i]}`),Mu("post_clean",t),$u(`Cleaned ${e} to \n\n\n ${t}`),t}async function Xu(e,t){try{var n;n=Vu()?`${window.origin}/api/openai_davinci`:"https://www.tidyscripts.com/api/openai_davinci";let i=await Zw(n,{prompt:e,max_tokens:t});Mu("api_response",i),$u("Logged the api repsonse"),$u("Cleaning json string");var r=Qu(i.text);return $u(`Got cleaned response: ${r}`),{error:!1,data:JSON.parse(r)}}catch(e){return Mu("api_error",e),$u("api_error experienced"),{error:!0,data:"api error"}}}(Gu=Wu||(Wu={}))[Gu.TIMEOUT=0]="TIMEOUT";const Yu={demographics:{age:35,gender:"Male",ethnicity:"Caucasian",occupation:"Software Engineer"},symptoms:["Fever","Cough","Fatigue"],lab_values:[{lab:"Magnesium",value:1.5},{lab:"Calcium",value:9.2},{lab:"Potassium",value:4},{lab:"Sodium",value:138}],medical_history:["Asthma","Seasonal Allergies"],medications:[{medication:"Albuterol",dose:{value:"2 puffs",frequency:"as needed"}},{medication:"Fluticasone",dose:{value:"1 spray",frequency:"daily"}}],tests:[{test:"Chest X-ray",result:"Negative"}],physical_exam:["Mild wheezing on auscultation"]};function el(e){const{demographics:t,symptoms:n,lab_values:r,medical_history:i,medications:s,tests:a,physical_exam:o}=e;return`\n    Given the following patient information:\n    Demographics: ${JSON.stringify(t)}\n    Symptoms: ${JSON.stringify(n)}\n    Lab values: ${JSON.stringify(r)}\n    Medical history: ${JSON.stringify(i)}\n    Medications: ${JSON.stringify(s)}\n    Tests: ${JSON.stringify(a)}\n    Physical exam: ${JSON.stringify(o)}\n\n    Please generate a list of the most likely diagnoses, along with their likelihood and any potential further workup needed to confirm or exclude each diagnosis.\nThe returned value should be a stringified JSON object that is an Array of objects that each have  "diagnosis", "likelihood", "reasoning",  and "suggested_workup" fields. \n    The suggested_workup field should be an array of strings where each string is a single suggested workup, such as "echocardiogram" or "chest x-ray" or "Basic metabolic panel (BMP)".\n    The likelihood field should be a number from 0 to 1 that estimates the probability that this is the diagnosis.\nThe reasoning field provides reasoning for ONLY the diagnosis and NOT for the suggested workup. It should be a string of atleast 5 sentences that directly references the provided information and specific numbers that went into your decision making process, and the logic behind the decision. If you conclude a lab value is high or low please provide a reference range in your explanation.\n    The returned array should have atleast 10 elements that are ranked with the highest likelihood first. \n  `}async function tl(e){let t=el(e);return await Xu(t,2048)}async function nl(e){try{const t=`Given the medical one-liner "${e.one_liner}" and History and Physical "${e.hp}", generate a patient_data object which conforms\nto the following PatientData type definition in typescript:\n\ntype PatientData = {\n  demographics: {\n    age: number,\n    gender?: string,\n    ethnicity?: string,\n    occupation?: string\n  },\n  symptoms: string[],\n  lab_values: {\n    lab : string ,\n    value : any \n  }[],\n  medical_history: string[],\n  medications: {\n    medication : string,\n    dose : { value : string, frequency : string } \n  }[],\n  tests: {\n    test: string,\n    result: string\n  }[],\n  physical_exam: string[]\n}\n\nThe repsonse should be a json string. \nOnly include the optional fields in the response if that information is explicity present in the one_liner or hp\nDo not include any text in the response other than the json string itself \n\n\nEXAMPLE RESPONSE: \n\n{\n  "demographics": {\n    "age": 30,\n    "gender": "Female",\n    "occupation": "Software Engineer"\n  },\n  "symptoms": ["Fever", "Cough", "Fatigue"],\n  "lab_values": [\n    {\n      "lab": "Magnesium",\n      "value": 1.5\n    },\n    {\n      "lab": "Calcium",\n      "value": 9.2\n    },\n    {\n      "lab": "Potassium",\n      "value": 4.0\n    },\n    {\n      "lab": "Sodium",\n      "value": 138\n    }\n  ],\n  "medical_history": ["Asthma", "Seasonal Allergies"],\n  "medications": [\n    {\n      "medication": "Albuterol",\n      "dose": {\n        "value": "2 puffs",\n        "frequency": "as needed"\n      }\n    },\n    {\n      "medication": "Fluticasone",\n      "dose": {\n        "value": "1 spray",\n        "frequency": "daily"\n      }\n    }\n  ],\n  "tests": [\n    {\n      "test": "Chest X-ray",\n      "result": "Negative"\n    }\n  ],\n  "physical_exam": ["Mild wheezing on auscultation"]\n}\n`;return(await Xu(t,2048)).data}catch(e){return $u("An error occurred"),Mu("generate_error",e),null}}var rl="1111";const il=$e({id:"medications"});var sl=[],al=[],ol=null;async function cl(){return await ul(),al}async function ul(){al.length&&ol||(il("Downloading medications"),sl=await Zw("https://storage.googleapis.com/tidyscripts/medication_data.json",{}),il("Parsing medications"),(al=St(sl)).map((function(e){try{e.adverse_reactions=gl(e.adverse_reactions),e.name=e.name.replace("-drug-information","")}catch(t){il("error parsing med:"),console.log(e),process.exit()}})),il("Building index"),ol=fl(al),il("Done"))}function ll(e){return al.filter((function(t){return t.name.match(e)}))}function hl(e){let t=R.keys(ol).filter((t=>t.match(e)));return Object.fromEntries(t.map((e=>[e,ol[e]])))}function dl(e,t){if(!e.adverse_reactions)return t;let n=at(e.adverse_reactions);for(var r of n){let{value:n,path:s}=r,a=s[0];for(var i of n)t[i]||(t[i]={}),t[i][a]||(t[i][a]=[]),t[i][a].push(e.name)}return t}function fl(e){let t={};for(var n of e)t=dl(n,t);return t}function pl(e){let t=e.split("\n\n").filter((e=>e.length>1));var n={};return t.map((function(e){let t=e.split(":"),r=t[0].trim(),i=t.slice(1).join("").replace(/\([\s\S]*?\)/g,"").split(",").map((e=>e.toLowerCase().trim()));n[r]=i})),n}function ml(e){return e.replace(/\([\s\S]*?\)/g,"").split(",").map((e=>e.toLowerCase().trim()))}function gl(e){if(!e)return null;let t=new RegExp([">10%:","1% to 10%:","2% to 10%:","Frequency not defined:","Frequency not defined.\n\n","<1%, postmarketing, and/or case reports:","<2%, postmarketing, and/or case reports:","<2%:","<1%:","Postmarketing:","Postmarketing and/or case reports:","Case Reports:"].join("|"),"g"),n=e.match(t);if(!n)return null;let r=e.split(t);var i={};return Ve((function(e,t){try{let n=r[e+1];"<1%, postmarketing, and/or case reports:"==t.trim()||"<2%, postmarketing, and/or case reports:"==t.trim()?i[t]=ml(n):i[t]=pl(n)}catch(e){i[t]=!1}}),n),i}const yl="4.49.1";let vl,_l,wl,bl,El,Il,Tl,kl,Sl,Al=!1,Ol=null,xl=null,Cl=null,Pl=null;class Nl{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}vl||function(e,t={auto:!1}){if(Al)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(vl)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${vl}'\``);Al=t.auto,vl=e.kind,_l=e.fetch,Ol=e.Request,xl=e.Response,Cl=e.Headers,wl=e.FormData,Pl=e.Blob,bl=e.File,El=e.ReadableStream,Il=e.getMultipartRequestOptions,Tl=e.getDefaultAgent,kl=e.fileFromPath,Sl=e.isFsReadStream}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import … from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,r,i,s;try{n=fetch,r=Request,i=Response,s=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:r,Response:i,Headers:s,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new Nl(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0});class Rl extends Error{}class jl extends Rl{constructor(e,t,n,r){super(`${jl.makeMessage(e,t,n)}`),this.status=e,this.headers=r,this.request_id=r?.["x-request-id"];const i=t;this.error=i,this.code=i?.code,this.param=i?.param,this.type=i?.type}static makeMessage(e,t,n){const r=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,n,r){if(!e)return new Dl({cause:kh(t)});const i=t?.error;return 400===e?new Ul(e,i,n,r):401===e?new $l(e,i,n,r):403===e?new Fl(e,i,n,r):404===e?new Bl(e,i,n,r):409===e?new Vl(e,i,n,r):422===e?new ql(e,i,n,r):429===e?new zl(e,i,n,r):e>=500?new Hl(e,i,n,r):new jl(e,i,n,r)}}class Ll extends jl{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}}class Dl extends jl{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}}class Ml extends Dl{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Ul extends jl{constructor(){super(...arguments),this.status=400}}class $l extends jl{constructor(){super(...arguments),this.status=401}}class Fl extends jl{constructor(){super(...arguments),this.status=403}}class Bl extends jl{constructor(){super(...arguments),this.status=404}}class Vl extends jl{constructor(){super(...arguments),this.status=409}}class ql extends jl{constructor(){super(...arguments),this.status=422}}class zl extends jl{constructor(){super(...arguments),this.status=429}}class Hl extends jl{}class Kl{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;return new Kl((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const n of async function*(e,t){if(!e.body)throw t.abort(),new Rl("Attempted to iterate over a response with no body");const n=new Gl,r=new Zl,i=Jl(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let r,i=new Uint8Array(t.length+e.length);for(i.set(t),i.set(e,t.length),t=i;-1!==(r=Wl(t));)yield t.slice(0,r),t=t.slice(r)}t.length>0&&(yield t)}(i))for(const t of r.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of r.flush()){const t=n.decode(e);t&&(yield t)}}(e,t))if(!r)if(n.data.startsWith("[DONE]"))r=!0;else if(null===n.event){let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if(e&&e.error)throw new jl(void 0,e.error,void 0,void 0);yield e}else{let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("error"==n.event)throw new jl(void 0,e.error,e.message,void 0);yield{event:n.event,data:e}}r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}static fromReadableStream(e,t){let n=!1;return new Kl((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const t of async function*(){const t=new Zl,n=Jl(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())r||t&&(yield JSON.parse(t));r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),r=r=>({next:()=>{if(0===r.length){const r=n.next();e.push(r),t.push(r)}return r.shift()}});return[new Kl((()=>r(e)),this.controller),new Kl((()=>r(t)),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new El({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:r,done:i}=await t.next();if(i)return e.close();const s=n.encode(JSON.stringify(r)+"\n");e.enqueue(s)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}function Wl(e){for(let t=0;t<e.length-2;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}class Gl{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=function(e,t){const n=e.indexOf(":");return-1!==n?[e.substring(0,n),":",e.substring(n+1)]:[e,"",""]}(e);return r.startsWith(" ")&&(r=r.substring(1)),"event"===t?this.event=r:"data"===t&&this.data.push(r),null}}class Zl{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const n=Zl.NEWLINE_CHARS.has(t[t.length-1]||"");let r=t.split(Zl.NEWLINE_REGEXP);return n&&r.pop(),1!==r.length||n?(this.buffer.length>0&&(r=[this.buffer.join("")+r[0],...r.slice(1)],this.buffer=[]),n||(this.buffer=[r.pop()||""]),r):(this.buffer.push(r[0]),[])}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new Rl(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new Rl(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new Rl("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}function Jl(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}Zl.NEWLINE_CHARS=new Set(["\n","\r"]),Zl.NEWLINE_REGEXP=/\r\n|[\n\r]/g;const Ql=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,Xl=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&Yl(e),Yl=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function eh(e,t,n){if(e=await e,n??(n=Xl(e)?{lastModified:e.lastModified,type:e.type}:{}),Ql(e)){const r=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new bl([r],t,n)}const r=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(Yl(e))t.push(await e.arrayBuffer());else{if(!nh(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){return`[${Object.getOwnPropertyNames(e).map((e=>`"${e}"`)).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return th(e.name)||th(e.filename)||th(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n.type){const e=r[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new bl(r,t,n)}const th=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,nh=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],rh=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],ih=async e=>{const t=await sh(e.body);return Il(t,e)},sh=async e=>{const t=new wl;return await Promise.all(Object.entries(e||{}).map((([e,n])=>ah(t,e,n)))),t},ah=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if((e=>Xl(e)||Ql(e)||Sl(e))(n)){const r=await eh(n);e.append(t,r)}else if(Array.isArray(n))await Promise.all(n.map((n=>ah(e,t+"[]",n))));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map((([n,r])=>ah(e,`${t}[${n}]`,r))))}}};var oh;async function ch(e){const{response:t}=e;if(e.options.stream)return Ch("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):Kl.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type");if(n?.includes("application/json")||n?.includes("application/vnd.api+json")){const e=await t.json();return Ch("response",t.status,t.url,t.headers,e),e}const r=await t.text();return Ch("response",t.status,t.url,t.headers,r),r}class uh extends Promise{constructor(e,t=ch){super((e=>{e(null)})),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new uh(this.responsePromise,(async t=>e(await this.parseResponse(t))))}asResponse(){return this.responsePromise.then((e=>e.response))}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class lh{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:r,fetch:i}){this.baseURL=e,this.maxRetries=Th("maxRetries",t),this.timeout=Th("timeout",n),this.httpAgent=r,this.fetch=i??_l}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),..._h(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Ph()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then((n=>({method:e,path:t,...n}))))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e).length.toString()}return null}buildRequest(e){const{method:t,path:n,query:r,headers:i={}}=e,s=rh(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,a=this.calculateContentLength(s),o=this.buildURL(n,r);"timeout"in e&&Th("timeout",e.timeout);const c=e.timeout??this.timeout,u=e.httpAgent??this.httpAgent??Tl(o),l=c+1e3;return"number"==typeof u?.options?.timeout&&l>(u.options.timeout??0)&&(u.options.timeout=l),this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey),{req:{method:t,...s&&{body:s},headers:this.buildHeaders({options:e,headers:i,contentLength:a}),...u&&{agent:u},signal:e.signal??null},url:o,timeout:c}}buildHeaders({options:e,headers:t,contentLength:n}){const r={};return n&&(r["content-length"]=n),xh(r,this.defaultHeaders(e)),xh(r,t),rh(e.body)&&"node"!==vl&&delete r["content-type"],this.validateHeaders(r,t),r}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map((e=>[...e]))):{...e}:{}}makeStatusError(e,t,n,r){return jl.generate(e,t,n,r)}request(e,t=null){return new uh(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e;null==t&&(t=n.maxRetries??this.maxRetries),await this.prepareOptions(n);const{req:r,url:i,timeout:s}=this.buildRequest(n);if(await this.prepareRequest(r,{url:i,options:n}),Ch("request",i,n,r.headers),n.signal?.aborted)throw new Ll;const a=new AbortController,o=await this.fetchWithTimeout(i,r,s,a).catch(kh);if(o instanceof Error){if(n.signal?.aborted)throw new Ll;if(t)return this.retryRequest(n,t);if("AbortError"===o.name)throw new Ml;throw new Dl({cause:o})}const c=fh(o.headers);if(!o.ok){if(t&&this.shouldRetry(o))return Ch(`response (error; retrying, ${t} attempts remaining)`,o.status,i,c),this.retryRequest(n,t,c);const e=await o.text().catch((e=>kh(e).message)),r=wh(e),s=r?void 0:e;throw Ch(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,o.status,i,c,s),this.makeStatusError(o.status,r,s,c)}return{response:o,options:n,controller:a}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new dh(this,n,e)}buildURL(e,t){const n=Eh(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return Ah(r)||(t={...r,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter((([e,t])=>void 0!==t)).map((([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new Rl(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)})).join("&")}async fetchWithTimeout(e,t,n,r){const{signal:i,...s}=t||{};i&&i.addEventListener("abort",(()=>r.abort()));const a=setTimeout((()=>r.abort()),n);return this.getRequestClient().fetch.call(void 0,e,{signal:r.signal,...s}).finally((()=>{clearTimeout(a)}))}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,n){let r;const i=n?.["retry-after-ms"];if(i){const e=parseFloat(i);Number.isNaN(e)||(r=e)}const s=n?.["retry-after"];if(s&&!r){const e=parseFloat(s);r=Number.isNaN(e)?Date.parse(s)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const n=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,n)}return await Ih(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${yl}`}}class hh{constructor(e,t,n,r){oh.set(this,void 0),function(e,t,n,r,i){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");t.set(e,n)}(this,oh,e),this.options=r,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new Rl("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,r]of n)e.url.searchParams.set(t,r);t.query=void 0,t.path=e.url.toString()}return await function(e,t,n,r){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t.get(e)}(this,oh).requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(oh=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class dh extends uh{constructor(e,t,n){super(t,(async t=>new n(e,t.response,await ch(t),t.options)))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}const fh=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),ph={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryResponse:!0,__streamClass:!0},mh=e=>"object"==typeof e&&null!==e&&!Ah(e)&&Object.keys(e).every((e=>Oh(ph,e))),gh=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",yh=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let vh;const _h=()=>vh??(vh=(()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":yl,"X-Stainless-OS":yh(Deno.build.os),"X-Stainless-Arch":gh(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":yl,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":yl,"X-Stainless-OS":yh(process.platform),"X-Stainless-Arch":gh(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":yl,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":yl,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),wh=e=>{try{return JSON.parse(e)}catch(e){return}},bh=new RegExp("^(?:[a-z]+:)?//","i"),Eh=e=>bh.test(e),Ih=e=>new Promise((t=>setTimeout(t,e))),Th=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new Rl(`${e} must be an integer`);if(t<0)throw new Rl(`${e} must be a positive integer`);return t},kh=e=>e instanceof Error?e:new Error(e),Sh=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function Ah(e){if(!e)return!0;for(const t in e)return!1;return!0}function Oh(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function xh(e,t){for(const n in t){if(!Oh(t,n))continue;const r=n.toLowerCase();if(!r)continue;const i=t[n];null===i?delete e[r]:void 0!==i&&(e[r]=i)}}function Ch(e,...t){"undefined"!=typeof process&&"true"===process?.env?.DEBUG&&console.log(`OpenAI:DEBUG:${e}`,...t)}const Ph=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}));function Nh(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class Rh extends hh{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class jh extends hh{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class Lh{constructor(e){this._client=e}}class Dh extends Lh{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}Dh||(Dh={});class Mh extends Lh{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}}Mh||(Mh={});class Uh extends Lh{constructor(){super(...arguments),this.completions=new Mh(this._client)}}!function(e){e.Completions=Mh}(Uh||(Uh={}));class $h extends Lh{create(e,t){return this._client.post("/embeddings",{body:e,...t})}}$h||($h={});class Fh extends Lh{create(e,t){return this._client.post("/files",ih({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return mh(e)?this.list({},e):this._client.getAPIList("/files",Bh,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t?.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const r=new Set(["processed","error","deleted"]),i=Date.now();let s=await this.retrieve(e);for(;!s.status||!r.has(s.status);)if(await Ih(t),s=await this.retrieve(e),Date.now()-i>n)throw new Ml({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return s}}class Bh extends Rh{}!function(e){e.FileObjectsPage=Bh}(Fh||(Fh={}));class Vh extends Lh{createVariation(e,t){return this._client.post("/images/variations",ih({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",ih({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}Vh||(Vh={});class qh extends Lh{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}}qh||(qh={});class zh extends Lh{create(e,t){return this._client.post("/audio/transcriptions",ih({body:e,...t}))}}zh||(zh={});class Hh extends Lh{create(e,t){return this._client.post("/audio/translations",ih({body:e,...t}))}}Hh||(Hh={});class Kh extends Lh{constructor(){super(...arguments),this.transcriptions=new zh(this._client),this.translations=new Hh(this._client),this.speech=new qh(this._client)}}!function(e){e.Transcriptions=zh,e.Translations=Hh,e.Speech=qh}(Kh||(Kh={}));class Wh extends Lh{create(e,t){return this._client.post("/moderations",{body:e,...t})}}Wh||(Wh={});class Gh extends Lh{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Zh,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Zh extends Rh{}!function(e){e.ModelsPage=Zh}(Gh||(Gh={}));class Jh extends Lh{list(e,t={},n){return mh(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Qh,{query:t,...n})}}class Qh extends jh{}!function(e){e.FineTuningJobCheckpointsPage=Qh}(Jh||(Jh={}));class Xh extends Lh{constructor(){super(...arguments),this.checkpoints=new Jh(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return mh(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Yh,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return mh(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,ed,{query:t,...n})}}class Yh extends jh{}class ed extends jh{}!function(e){e.FineTuningJobsPage=Yh,e.FineTuningJobEventsPage=ed,e.Checkpoints=Jh,e.FineTuningJobCheckpointsPage=Qh}(Xh||(Xh={}));class td extends Lh{constructor(){super(...arguments),this.jobs=new Xh(this._client)}}!function(e){e.Jobs=Xh,e.FineTuningJobsPage=Yh,e.FineTuningJobEventsPage=ed}(td||(td={}));class nd extends Lh{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return mh(e)?this.list({},e):this._client.getAPIList("/assistants",rd,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class rd extends jh{}function id(e){return"function"==typeof e.parse}!function(e){e.AssistantsPage=rd}(nd||(nd={}));const sd=e=>"assistant"===e?.role,ad=e=>"function"===e?.role,od=e=>"tool"===e?.role;var cd,ud,ld,hd,dd,fd,pd,md,gd,yd,vd,_d,wd,bd,Ed,Id,Td,kd,Sd,Ad,Od=function(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n},xd=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};const Cd=10;class Pd{constructor(){cd.add(this),this.controller=new AbortController,ud.set(this,void 0),ld.set(this,(()=>{})),hd.set(this,(()=>{})),dd.set(this,void 0),fd.set(this,(()=>{})),pd.set(this,(()=>{})),md.set(this,{}),this._chatCompletions=[],this.messages=[],gd.set(this,!1),yd.set(this,!1),vd.set(this,!1),_d.set(this,!1),kd.set(this,(e=>{if(Od(this,yd,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new Ll),e instanceof Ll)return Od(this,vd,!0,"f"),this._emit("abort",e);if(e instanceof Rl)return this._emit("error",e);if(e instanceof Error){const t=new Rl(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Rl(String(e)))})),Od(this,ud,new Promise(((e,t)=>{Od(this,ld,e,"f"),Od(this,hd,t,"f")})),"f"),Od(this,dd,new Promise(((e,t)=>{Od(this,fd,e,"f"),Od(this,pd,t,"f")})),"f"),xd(this,ud,"f").catch((()=>{})),xd(this,dd,"f").catch((()=>{}))}_run(e){setTimeout((()=>{e().then((()=>{this._emitFinal(),this._emit("end")}),xd(this,kd,"f"))}),0)}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(ad(e)||od(e))&&e.content)this._emit("functionCallResult",e.content);else if(sd(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(sd(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}_connected(){this.ended||(xd(this,ld,"f").call(this),this._emit("connect"))}get ended(){return xd(this,gd,"f")}get errored(){return xd(this,yd,"f")}get aborted(){return xd(this,vd,"f")}abort(){this.controller.abort()}on(e,t){return(xd(this,md,"f")[e]||(xd(this,md,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=xd(this,md,"f")[e];if(!n)return this;const r=n.findIndex((e=>e.listener===t));return r>=0&&n.splice(r,1),this}once(e,t){return(xd(this,md,"f")[e]||(xd(this,md,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{Od(this,_d,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){Od(this,_d,!0,"f"),await xd(this,dd,"f")}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new Rl("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),xd(this,cd,"m",wd).call(this)}async finalMessage(){return await this.done(),xd(this,cd,"m",bd).call(this)}async finalFunctionCall(){return await this.done(),xd(this,cd,"m",Ed).call(this)}async finalFunctionCallResult(){return await this.done(),xd(this,cd,"m",Id).call(this)}async totalUsage(){return await this.done(),xd(this,cd,"m",Td).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emit(e,...t){if(xd(this,gd,"f"))return;"end"===e&&(Od(this,gd,!0,"f"),xd(this,fd,"f").call(this));const n=xd(this,md,"f")[e];if(n&&(xd(this,md,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return xd(this,_d,"f")||n?.length||Promise.reject(e),xd(this,hd,"f").call(this,e),xd(this,pd,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];xd(this,_d,"f")||n?.length||Promise.reject(e),xd(this,hd,"f").call(this,e),xd(this,pd,"f").call(this,e),this._emit("end")}}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=xd(this,cd,"m",bd).call(this);t&&this._emit("finalMessage",t);const n=xd(this,cd,"m",wd).call(this);n&&this._emit("finalContent",n);const r=xd(this,cd,"m",Ed).call(this);r&&this._emit("finalFunctionCall",r);const i=xd(this,cd,"m",Id).call(this);null!=i&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some((e=>e.usage))&&this._emit("totalUsage",xd(this,cd,"m",Td).call(this))}async _createChatCompletion(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),xd(this,cd,"m",Sd).call(this,t);const i=await e.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(i)}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){const r="function",{function_call:i="auto",stream:s,...a}=t,o="string"!=typeof i&&i?.name,{maxChatCompletions:c=Cd}=n||{},u={};for(const e of t.functions)u[e.name||e.function.name]=e;const l=t.functions.map((e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description})));for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...a,function_call:i,functions:l,messages:[...this.messages]},n),s=t.choices[0]?.message;if(!s)throw new Rl("missing message in ChatCompletion response");if(!s.function_call)return;const{name:c,arguments:h}=s.function_call,d=u[c];if(!d){const e=`Invalid function_call: ${JSON.stringify(c)}. Available options are: ${l.map((e=>JSON.stringify(e.name))).join(", ")}. Please try again`;this._addMessage({role:r,name:c,content:e});continue}if(o&&o!==c){const e=`Invalid function_call: ${JSON.stringify(c)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,name:c,content:e});continue}let f;try{f=id(d)?await d.parse(h):h}catch(e){this._addMessage({role:r,name:c,content:e instanceof Error?e.message:String(e)});continue}const p=await d.function(f,this),m=xd(this,cd,"m",Ad).call(this,p);if(this._addMessage({role:r,name:c,content:m}),o)return}}async _runTools(e,t,n){const r="tool",{tool_choice:i="auto",stream:s,...a}=t,o="string"!=typeof i&&i?.function?.name,{maxChatCompletions:c=Cd}=n||{},u={};for(const e of t.tools)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);const l="tools"in t?t.tools.map((e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description}}:e)):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...a,tool_choice:i,tools:l,messages:[...this.messages]},n),s=t.choices[0]?.message;if(!s)throw new Rl("missing message in ChatCompletion response");if(!s.tool_calls)return;for(const t of s.tool_calls){if("function"!==t.type)continue;const n=t.id,{name:i,arguments:s}=t.function,a=u[i];if(!a){const e=`Invalid tool_call: ${JSON.stringify(i)}. Available options are: ${l.map((e=>JSON.stringify(e.function.name))).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:n,content:e});continue}if(o&&o!==i){const e=`Invalid tool_call: ${JSON.stringify(i)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,tool_call_id:n,content:e});continue}let c;try{c=id(a)?await a.parse(s):s}catch(e){const t=e instanceof Error?e.message:String(e);this._addMessage({role:r,tool_call_id:n,content:t});continue}const h=await a.function(c,this),d=xd(this,cd,"m",Ad).call(this,h);if(this._addMessage({role:r,tool_call_id:n,content:d}),o)return}}}}ud=new WeakMap,ld=new WeakMap,hd=new WeakMap,dd=new WeakMap,fd=new WeakMap,pd=new WeakMap,md=new WeakMap,gd=new WeakMap,yd=new WeakMap,vd=new WeakMap,_d=new WeakMap,kd=new WeakMap,cd=new WeakSet,wd=function(){return xd(this,cd,"m",bd).call(this).content??null},bd=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(sd(t)){const{function_call:e,...n}=t,r={...n,content:t.content??null};return e&&(r.function_call=e),r}}throw new Rl("stream ended without producing a ChatCompletionMessage with role=assistant")},Ed=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(sd(t)&&t?.function_call)return t.function_call;if(sd(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},Id=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(ad(t)&&null!=t.content)return t.content;if(od(t)&&null!=t.content&&this.messages.some((e=>"assistant"===e.role&&e.tool_calls?.some((e=>"function"===e.type&&e.id===t.tool_call_id)))))return t.content}},Td=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Sd=function(e){if(null!=e.n&&e.n>1)throw new Rl("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Ad=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class Nd extends Pd{static runFunctions(e,t,n){const r=new Nd,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,i))),r}static runTools(e,t,n){const r=new Nd,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,i))),r}_addMessage(e){super._addMessage(e),sd(e)&&e.content&&this._emit("content",e.content)}}var Rd,jd,Ld,Dd,Md,Ud,$d=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},Fd=function(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n};class Bd extends Pd{constructor(){super(...arguments),Rd.add(this),jd.set(this,void 0)}get currentChatCompletionSnapshot(){return $d(this,jd,"f")}static fromReadableStream(e){const t=new Bd;return t._run((()=>t._fromReadableStream(e))),t}static createChatCompletion(e,t,n){const r=new Bd;return r._run((()=>r._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}async _createChatCompletion(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),$d(this,Rd,"m",Ld).call(this);const i=await e.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of i)$d(this,Rd,"m",Dd).call(this,e);if(i.controller.signal?.aborted)throw new Ll;return this._addChatCompletion($d(this,Rd,"m",Md).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),$d(this,Rd,"m",Ld).call(this),this._connected();const r=Kl.fromReadableStream(e,this.controller);let i;for await(const e of r)i&&i!==e.id&&this._addChatCompletion($d(this,Rd,"m",Md).call(this)),$d(this,Rd,"m",Dd).call(this,e),i=e.id;if(r.controller.signal?.aborted)throw new Ll;return this._addChatCompletion($d(this,Rd,"m",Md).call(this))}[(jd=new WeakMap,Rd=new WeakSet,Ld=function(){this.ended||Fd(this,jd,void 0,"f")},Dd=function(e){if(this.ended)return;const t=$d(this,Rd,"m",Ud).call(this,e);this._emit("chunk",e,t);const n=e.choices[0]?.delta?.content,r=t.choices[0]?.message;null!=n&&"assistant"===r?.role&&r?.content&&this._emit("content",n,r.content)},Md=function(){if(this.ended)throw new Rl("stream has ended, this shouldn't happen");const e=$d(this,jd,"f");if(!e)throw new Rl("request ended without sending any chunks");return Fd(this,jd,void 0,"f"),function(e){const{id:t,choices:n,created:r,model:i,system_fingerprint:s,...a}=e;return{...a,id:t,choices:n.map((({message:t,finish_reason:n,index:r,logprobs:i,...s})=>{if(!n)throw new Rl(`missing finish_reason for choice ${r}`);const{content:a=null,function_call:o,tool_calls:c,...u}=t,l=t.role;if(!l)throw new Rl(`missing role for choice ${r}`);if(o){const{arguments:e,name:t}=o;if(null==e)throw new Rl(`missing function_call.arguments for choice ${r}`);if(!t)throw new Rl(`missing function_call.name for choice ${r}`);return{...s,message:{content:a,function_call:{arguments:e,name:t},role:l},finish_reason:n,index:r,logprobs:i}}return c?{...s,index:r,finish_reason:n,logprobs:i,message:{...u,role:l,content:a,tool_calls:c.map(((t,n)=>{const{function:i,type:s,id:a,...o}=t,{arguments:c,name:u,...l}=i||{};if(null==a)throw new Rl(`missing choices[${r}].tool_calls[${n}].id\n${Vd(e)}`);if(null==s)throw new Rl(`missing choices[${r}].tool_calls[${n}].type\n${Vd(e)}`);if(null==u)throw new Rl(`missing choices[${r}].tool_calls[${n}].function.name\n${Vd(e)}`);if(null==c)throw new Rl(`missing choices[${r}].tool_calls[${n}].function.arguments\n${Vd(e)}`);return{...o,id:a,type:s,function:{...l,name:u,arguments:c}}}))}}:{...s,message:{...u,content:a,role:l},finish_reason:n,index:r,logprobs:i}})),created:r,model:i,object:"chat.completion",...s?{system_fingerprint:s}:{}}}(e)},Ud=function(e){var t,n,r;let i=$d(this,jd,"f");const{choices:s,...a}=e;i?Object.assign(i,a):i=Fd(this,jd,{...a,choices:[]},"f");for(const{delta:s,finish_reason:a,index:o,logprobs:c=null,...u}of e.choices){let e=i.choices[o];if(e||(e=i.choices[o]={finish_reason:a,index:o,message:{},logprobs:c,...u}),c)if(e.logprobs){const{content:n,...r}=c;Object.assign(e.logprobs,r),n&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...n))}else e.logprobs=Object.assign({},c);if(a&&(e.finish_reason=a),Object.assign(e,u),!s)continue;const{content:l,function_call:h,role:d,tool_calls:f,...p}=s;if(Object.assign(e.message,p),l&&(e.message.content=(e.message.content||"")+l),d&&(e.message.role=d),h&&(e.message.function_call?(h.name&&(e.message.function_call.name=h.name),h.arguments&&((n=e.message.function_call).arguments??(n.arguments=""),e.message.function_call.arguments+=h.arguments)):e.message.function_call=h),f){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:i,function:s,...a}of f){const o=(r=e.message.tool_calls)[t]??(r[t]={});Object.assign(o,a),n&&(o.id=n),i&&(o.type=i),s&&(o.function??(o.function={arguments:""})),s?.name&&(o.function.name=s.name),s?.arguments&&(o.function.arguments+=s.arguments)}}}return i},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Kl(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Vd(e){return JSON.stringify(e)}class qd extends Bd{static fromReadableStream(e){const t=new qd;return t._run((()=>t._fromReadableStream(e))),t}static runFunctions(e,t,n){const r=new qd,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,i))),r}static runTools(e,t,n){const r=new qd,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,i))),r}}class zd extends Lh{runFunctions(e,t){return e.stream?qd.runFunctions(this._client.chat.completions,e,t):Nd.runFunctions(this._client.chat.completions,e,t)}runTools(e,t){return e.stream?qd.runTools(this._client.chat.completions,e,t):Nd.runTools(this._client.chat.completions,e,t)}stream(e,t){return Bd.createChatCompletion(this._client.chat.completions,e,t)}}class Hd extends Lh{constructor(){super(...arguments),this.completions=new zd(this._client)}}!function(e){e.Completions=zd}(Hd||(Hd={}));var Kd,Wd,Gd,Zd,Jd,Qd,Xd,Yd,ef,tf,nf,rf,sf=function(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n},af=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class of{constructor(){this.controller=new AbortController,Kd.set(this,void 0),Wd.set(this,(()=>{})),Gd.set(this,(()=>{})),Zd.set(this,void 0),Jd.set(this,(()=>{})),Qd.set(this,(()=>{})),Xd.set(this,{}),Yd.set(this,!1),ef.set(this,!1),tf.set(this,!1),nf.set(this,!1),rf.set(this,(e=>{if(sf(this,ef,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new Ll),e instanceof Ll)return sf(this,tf,!0,"f"),this._emit("abort",e);if(e instanceof Rl)return this._emit("error",e);if(e instanceof Error){const t=new Rl(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Rl(String(e)))})),sf(this,Kd,new Promise(((e,t)=>{sf(this,Wd,e,"f"),sf(this,Gd,t,"f")})),"f"),sf(this,Zd,new Promise(((e,t)=>{sf(this,Jd,e,"f"),sf(this,Qd,t,"f")})),"f"),af(this,Kd,"f").catch((()=>{})),af(this,Zd,"f").catch((()=>{}))}_run(e){setTimeout((()=>{e().then((()=>{this._emit("end")}),af(this,rf,"f"))}),0)}_addRun(e){return e}_connected(){this.ended||(af(this,Wd,"f").call(this),this._emit("connect"))}get ended(){return af(this,Yd,"f")}get errored(){return af(this,ef,"f")}get aborted(){return af(this,tf,"f")}abort(){this.controller.abort()}on(e,t){return(af(this,Xd,"f")[e]||(af(this,Xd,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=af(this,Xd,"f")[e];if(!n)return this;const r=n.findIndex((e=>e.listener===t));return r>=0&&n.splice(r,1),this}once(e,t){return(af(this,Xd,"f")[e]||(af(this,Xd,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{sf(this,nf,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){sf(this,nf,!0,"f"),await af(this,Zd,"f")}_emit(e,...t){if(af(this,Yd,"f"))return;"end"===e&&(sf(this,Yd,!0,"f"),af(this,Jd,"f").call(this));const n=af(this,Xd,"f")[e];if(n&&(af(this,Xd,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return af(this,nf,"f")||n?.length||Promise.reject(e),af(this,Gd,"f").call(this,e),af(this,Qd,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];af(this,nf,"f")||n?.length||Promise.reject(e),af(this,Gd,"f").call(this,e),af(this,Qd,"f").call(this,e),this._emit("end")}}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,r){return await this._createAssistantStream(t,e,n,r)}async _runToolAssistantStream(e,t,n,r,i){return await this._createToolAssistantStream(n,e,t,r,i)}async _createThreadAssistantStream(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort())));const i=await e.createAndRun({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addRun(i)}async _createToolAssistantStream(e,t,n,r,i){const s=i?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort())));const a=await e.submitToolOutputs(t,n,{...r,stream:!1},{...i,signal:this.controller.signal});return this._connected(),this._addRun(a)}async _createAssistantStream(e,t,n,r){const i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",(()=>this.controller.abort())));const s=await e.create(t,{...n,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addRun(s)}}Kd=new WeakMap,Wd=new WeakMap,Gd=new WeakMap,Zd=new WeakMap,Jd=new WeakMap,Qd=new WeakMap,Xd=new WeakMap,Yd=new WeakMap,ef=new WeakMap,tf=new WeakMap,nf=new WeakMap,rf=new WeakMap;var cf,uf,lf,hf,df,ff,pf,mf,gf,yf,vf,_f,wf,bf,Ef,If,Tf,kf,Sf,Af,Of,xf,Cf,Pf=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},Nf=function(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n};class Rf extends of{constructor(){super(...arguments),cf.add(this),uf.set(this,[]),lf.set(this,{}),hf.set(this,{}),df.set(this,void 0),ff.set(this,void 0),pf.set(this,void 0),mf.set(this,void 0),gf.set(this,void 0),yf.set(this,void 0),vf.set(this,void 0),_f.set(this,void 0),wf.set(this,void 0)}[(uf=new WeakMap,lf=new WeakMap,hf=new WeakMap,df=new WeakMap,ff=new WeakMap,pf=new WeakMap,mf=new WeakMap,gf=new WeakMap,yf=new WeakMap,vf=new WeakMap,_f=new WeakMap,wf=new WeakMap,cf=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new Rf;return t._run((()=>t._fromReadableStream(e))),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),this._connected();const r=Kl.fromReadableStream(e,this.controller);for await(const e of r)Pf(this,cf,"m",bf).call(this,e);if(r.controller.signal?.aborted)throw new Ll;return this._addRun(Pf(this,cf,"m",Ef).call(this))}toReadableStream(){return new Kl(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,r,i){const s=new Rf;return s._run((()=>s._runToolAssistantStream(e,t,n,r,{...i,headers:{...i?.headers,"X-Stainless-Helper-Method":"stream"}}))),s}async _createToolAssistantStream(e,t,n,r,i){const s=i?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort())));const a={...r,stream:!0},o=await e.submitToolOutputs(t,n,a,{...i,signal:this.controller.signal});this._connected();for await(const e of o)Pf(this,cf,"m",bf).call(this,e);if(o.controller.signal?.aborted)throw new Ll;return this._addRun(Pf(this,cf,"m",Ef).call(this))}static createThreadAssistantStream(e,t,n){const r=new Rf;return r._run((()=>r._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}static createAssistantStream(e,t,n,r){const i=new Rf;return i._run((()=>i._runAssistantStream(e,t,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}}))),i}currentEvent(){return Pf(this,vf,"f")}currentRun(){return Pf(this,_f,"f")}currentMessageSnapshot(){return Pf(this,df,"f")}currentRunStepSnapshot(){return Pf(this,wf,"f")}async finalRunSteps(){return await this.done(),Object.values(Pf(this,lf,"f"))}async finalMessages(){return await this.done(),Object.values(Pf(this,hf,"f"))}async finalRun(){if(await this.done(),!Pf(this,ff,"f"))throw Error("Final run was not received.");return Pf(this,ff,"f")}async _createThreadAssistantStream(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort())));const i={...t,stream:!0},s=await e.createAndRun(i,{...n,signal:this.controller.signal});this._connected();for await(const e of s)Pf(this,cf,"m",bf).call(this,e);if(s.controller.signal?.aborted)throw new Ll;return this._addRun(Pf(this,cf,"m",Ef).call(this))}async _createAssistantStream(e,t,n,r){const i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",(()=>this.controller.abort())));const s={...n,stream:!0},a=await e.create(t,s,{...r,signal:this.controller.signal});this._connected();for await(const e of a)Pf(this,cf,"m",bf).call(this,e);if(a.controller.signal?.aborted)throw new Ll;return this._addRun(Pf(this,cf,"m",Ef).call(this))}static accumulateDelta(e,t){for(const[n,r]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=r;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof r)t+=r;else if("number"==typeof t&&"number"==typeof r)t+=r;else if(Nh(t)&&Nh(r))t=this.accumulateDelta(t,r);else{if(!Array.isArray(t)||!Array.isArray(r))throw Error(`Unhandled record type: ${n}, deltaValue: ${r}, accValue: ${t}`);if(t.every((e=>"string"==typeof e||"number"==typeof e))){t.push(...r);continue}}e[n]=t}else e[n]=r;else e[n]=r}return e}}bf=function(e){if(!this.ended)switch(Nf(this,vf,e,"f"),Pf(this,cf,"m",kf).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":Pf(this,cf,"m",xf).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Pf(this,cf,"m",Tf).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":Pf(this,cf,"m",If).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Ef=function(){if(this.ended)throw new Rl("stream has ended, this shouldn't happen");if(!Pf(this,ff,"f"))throw Error("Final run has not been received");return Pf(this,ff,"f")},If=function(e){const[t,n]=Pf(this,cf,"m",Af).call(this,e,Pf(this,df,"f"));Nf(this,df,t,"f"),Pf(this,hf,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,r=t.content[n.index];if(!r||"text"!=r.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,r.text)}if(n.index!=Pf(this,pf,"f")){if(Pf(this,mf,"f"))switch(Pf(this,mf,"f").type){case"text":this._emit("textDone",Pf(this,mf,"f").text,Pf(this,df,"f"));break;case"image_file":this._emit("imageFileDone",Pf(this,mf,"f").image_file,Pf(this,df,"f"))}Nf(this,pf,n.index,"f")}Nf(this,mf,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==Pf(this,pf,"f")){const t=e.data.content[Pf(this,pf,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,Pf(this,df,"f"));break;case"text":this._emit("textDone",t.text,Pf(this,df,"f"))}}Pf(this,df,"f")&&this._emit("messageDone",e.data),Nf(this,df,void 0,"f")}},Tf=function(e){const t=Pf(this,cf,"m",Sf).call(this,e);switch(Nf(this,wf,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==Pf(this,gf,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(Pf(this,yf,"f")&&this._emit("toolCallDone",Pf(this,yf,"f")),Nf(this,gf,e.index,"f"),Nf(this,yf,t.step_details.tool_calls[e.index],"f"),Pf(this,yf,"f")&&this._emit("toolCallCreated",Pf(this,yf,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Nf(this,wf,void 0,"f"),"tool_calls"==e.data.step_details.type&&Pf(this,yf,"f")&&(this._emit("toolCallDone",Pf(this,yf,"f")),Nf(this,yf,void 0,"f")),this._emit("runStepDone",e.data,t)}},kf=function(e){Pf(this,uf,"f").push(e),this._emit("event",e)},Sf=function(e){switch(e.event){case"thread.run.step.created":return Pf(this,lf,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=Pf(this,lf,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const r=Rf.accumulateDelta(t,n.delta);Pf(this,lf,"f")[e.data.id]=r}return Pf(this,lf,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":Pf(this,lf,"f")[e.data.id]=e.data}if(Pf(this,lf,"f")[e.data.id])return Pf(this,lf,"f")[e.data.id];throw new Error("No snapshot available")},Af=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const e of r.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=Pf(this,cf,"m",Of).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Of=function(e,t){return Rf.accumulateDelta(t,e)},xf=function(e){switch(Nf(this,_f,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Nf(this,ff,e.data,"f"),Pf(this,yf,"f")&&(this._emit("toolCallDone",Pf(this,yf,"f")),Nf(this,yf,void 0,"f"))}};class jf extends Lh{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return mh(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Lf,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class Lf extends jh{}!function(e){e.MessagesPage=Lf}(jf||(jf={}));class Df extends Lh{retrieve(e,t,n,r){return this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t,n={},r){return mh(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Mf,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class Mf extends jh{}!function(e){e.RunStepsPage=Mf}(Df||(Df={}));class Uf extends Lh{constructor(){super(...arguments),this.steps=new Df(this._client)}create(e,t,n){return this._client.post(`/threads/${e}/runs`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return mh(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,$f,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}createAndStream(e,t,n){return Rf.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:i,response:s}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...r}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=s.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Ih(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,n){return Rf.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,r){const i=await this.submitToolOutputs(e,t,n,r);return await this.poll(e,i.id,r)}submitToolOutputsStream(e,t,n,r){return Rf.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,r)}}class $f extends jh{}!function(e){e.RunsPage=$f,e.Steps=Df,e.RunStepsPage=Mf}(Uf||(Uf={}));class Ff extends Lh{constructor(){super(...arguments),this.runs=new Uf(this._client),this.messages=new jf(this._client)}create(e={},t){return mh(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return Rf.createThreadAssistantStream(e,this._client.beta.threads,t)}}!function(e){e.Runs=Uf,e.RunsPage=$f,e.Messages=jf,e.MessagesPage=Lf}(Ff||(Ff={}));class Bf extends Lh{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},n){return mh(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,Vf,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const i=await this.retrieve(e,t,{...n,headers:r}).withResponse(),s=i.data;switch(s.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=i.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Ih(e);break;case"failed":case"completed":return s}}}async upload(e,t,n){const r=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:r.id},n)}async uploadAndPoll(e,t,n){const r=await this.upload(e,t,n);return await this.poll(e,r.id,n)}}class Vf extends jh{}!function(e){e.VectorStoreFilesPage=Vf}(Bf||(Bf={}));class qf extends Lh{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t);return await this.poll(e,r.id,n)}listFiles(e,t,n={},r){return mh(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Vf,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:i,response:s}=await this.retrieve(e,t,{...n,headers:r}).withResponse();switch(i.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=s.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Ih(e);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},r){if(null===t||0==t.length)throw new Error("No files provided to process.");const i=r?.maxConcurrency??5,s=Math.min(i,t.length),a=this._client,o=t.values(),c=[...n],u=Array(s).fill(o).map((async function(e){for(let t of e){const e=await a.files.create({file:t,purpose:"assistants"},r);c.push(e.id)}}));return await(async e=>{const t=await Promise.allSettled(e),n=t.filter((e=>"rejected"===e.status));if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const e of t)"fulfilled"===e.status&&r.push(e.value);return r})(u),await this.createAndPoll(e,{file_ids:c})}}qf||(qf={});class zf extends Lh{constructor(){super(...arguments),this.files=new Bf(this._client),this.fileBatches=new qf(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return mh(e)?this.list({},e):this._client.getAPIList("/vector_stores",Hf,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Hf extends jh{}!function(e){e.VectorStoresPage=Hf,e.Files=Bf,e.VectorStoreFilesPage=Vf,e.FileBatches=qf}(zf||(zf={}));class Kf extends Lh{constructor(){super(...arguments),this.vectorStores=new zf(this._client),this.chat=new Hd(this._client),this.assistants=new nd(this._client),this.threads=new Ff(this._client)}}!function(e){e.VectorStores=zf,e.VectorStoresPage=Hf,e.Chat=Hd,e.Assistants=nd,e.AssistantsPage=rd,e.Threads=Ff}(Kf||(Kf={}));class Wf extends Lh{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return mh(e)?this.list({},e):this._client.getAPIList("/batches",Gf,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class Gf extends jh{}!function(e){e.BatchesPage=Gf}(Wf||(Wf={}));class Zf extends lh{constructor({baseURL:e=Sh("OPENAI_BASE_URL"),apiKey:t=Sh("OPENAI_API_KEY"),organization:n=Sh("OPENAI_ORG_ID")??null,project:r=Sh("OPENAI_PROJECT_ID")??null,...i}={}){if(void 0===t)throw new Rl("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const s={apiKey:t,organization:n,project:r,...i,baseURL:e||"https://api.openai.com/v1"};if(!s.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new Rl("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:s.baseURL,timeout:s.timeout??6e5,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new Dh(this),this.chat=new Uh(this),this.embeddings=new $h(this),this.files=new Fh(this),this.images=new Vh(this),this.audio=new Kh(this),this.moderations=new Wh(this),this.models=new Gh(this),this.fineTuning=new td(this),this.beta=new Kf(this),this.batches=new Wf(this),this._options=s,this.apiKey=t,this.organization=n,this.project=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}}Cf=Zf,Zf.OpenAI=Cf,Zf.OpenAIError=Rl,Zf.APIError=jl,Zf.APIConnectionError=Dl,Zf.APIConnectionTimeoutError=Ml,Zf.APIUserAbortError=Ll,Zf.NotFoundError=Bl,Zf.ConflictError=Vl,Zf.RateLimitError=zl,Zf.BadRequestError=Ul,Zf.AuthenticationError=$l,Zf.InternalServerError=Hl,Zf.PermissionDeniedError=Fl,Zf.UnprocessableEntityError=ql,Zf.toFile=eh,Zf.fileFromPath=kl;const{OpenAIError:Jf,APIError:Qf,APIConnectionError:Xf,APIConnectionTimeoutError:Yf,APIUserAbortError:ep,NotFoundError:tp,ConflictError:np,RateLimitError:rp,BadRequestError:ip,AuthenticationError:sp,InternalServerError:ap,PermissionDeniedError:op,UnprocessableEntityError:cp}=y;var up;(up=Zf||(Zf={})).Page=Rh,up.CursorPage=jh,up.Completions=Dh,up.Chat=Uh,up.Embeddings=$h,up.Files=Fh,up.FileObjectsPage=Bh,up.Images=Vh,up.Audio=Kh,up.Moderations=Wh,up.Models=Gh,up.ModelsPage=Zh,up.FineTuning=td,up.Beta=Kf,up.Batches=Wf,up.BatchesPage=Gf,new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations"]);const lp=Zf;function hp(e,t=dp){e=e.trim();const n=/```(json)?(.*)```/s.exec(e);return t(n?n[2]:e)}function dp(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const n=[];let r=!1,i=!1;for(let s of e){if(r)'"'!==s||i?"\n"!==s||i?i="\\"===s&&!i:s="\\n":r=!1;else if('"'===s)r=!0,i=!1;else if("{"===s)n.push("}");else if("["===s)n.push("]");else if("}"===s||"]"===s){if(!n||n[n.length-1]!==s)return null;n.pop()}t+=s}r&&(t+='"');for(let e=n.length-1;e>=0;e-=1)t+=n[e];try{return JSON.parse(t)}catch(e){return null}}var fp=i(409);function pp(e,t){return t?.[e]||fp(e)}function mp(e,t,n){const r={};for(const i in e)Object.hasOwn(e,i)&&(r[t(i,n)]=e[i]);return r}function gp(e){return Array.isArray(e)?[...e]:{...e}}function yp(e,t){const n=gp(e);for(const[e,r]of Object.entries(t)){const[t,...i]=e.split(".").reverse();let s=n;for(const e of i.reverse()){if(void 0===s[e])break;s[e]=gp(s[e]),s=s[e]}void 0!==s[t]&&(s[t]={lc:1,type:"secret",id:[r]})}return n}function vp(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}i(832);class _p{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,vp(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof _p||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},n=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let r=Object.getPrototypeOf(this);r;r=Object.getPrototypeOf(r))Object.assign(e,Reflect.get(r,"lc_aliases",this)),Object.assign(t,Reflect.get(r,"lc_secrets",this)),Object.assign(n,Reflect.get(r,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,r=n;const[i,...s]=e.split(".").reverse();for(const e of s.reverse()){if(!(e in t)||void 0===t[e])return;e in r&&void 0!==r[e]||("object"==typeof t[e]&&null!=t[e]?r[e]={}:Array.isArray(t[e])&&(r[e]=[])),t=t[e],r=r[e]}i in t&&void 0!==t[i]&&(r[i]=r[i]||t[i])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:mp(Object.keys(t).length?yp(n,t):n,pp,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function wp(e,t){return"string"==typeof e?"string"==typeof t?e+t:[{type:"text",text:e},...t]:Array.isArray(t)?[...e,...t]:[...e,{type:"text",text:t}]}class bp extends _p{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:""}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}}function Ep(e,t){const n={...e};for(const[e,r]of Object.entries(t))if(null==n[e])n[e]=r;else{if(null==r)continue;if(typeof n[e]!=typeof r||Array.isArray(n[e])!==Array.isArray(r))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof n[e])n[e]=n[e]+r;else if(Array.isArray(n[e])||"object"!=typeof n[e])if(Array.isArray(n[e]))n[e]=Ip(n[e],r);else{if(n[e]===r)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else n[e]=Ep(n[e],r)}return n}function Ip(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const n=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=n.findIndex((t=>t.index===e.index));-1!==t?n[t]=Ep(n[t],e):n.push(e)}else n.push(e);return n}}}class Tp extends bp{}function kp(e){return"function"==typeof e?._getType}class Sp extends Tp{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new Sp({content:wp(this.content,e.content),additional_kwargs:Ep(this.additional_kwargs,e.additional_kwargs),response_metadata:Ep(this.response_metadata,e.response_metadata),tool_call_id:this.tool_call_id})}}class Ap extends bp{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let n;if("string"==typeof e)n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{n=e;const t=n.additional_kwargs?.tool_calls,r=n.tool_calls;null!=t&&t.length>0&&(void 0===r||0===r.length)&&console.warn(["New LangChain packages are available that more efficiently handle","tool calling.\n\nPlease upgrade your packages to versions that set","message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(null!=t&&void 0===r){const[e,r]=function(e){const t=[],n=[];for(const r of e)if(r.function){const e=r.function.name;try{const n={name:e||"",args:JSON.parse(r.function.arguments)||{},id:r.id};t.push(n)}catch(t){n.push({name:e,args:r.function.arguments,id:r.id,error:"Malformed args."})}}return[t,n]}(t);n.tool_calls=e??[],n.invalid_tool_calls=r??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch(e){n.tool_calls=[],n.invalid_tool_calls=[]}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),"string"!=typeof n&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls)}static lc_name(){return"AIMessage"}_getType(){return"ai"}}class Op extends Tp{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else{const n=[],r=[];for(const t of e.tool_call_chunks){let i={};try{if(i=dp(t.args??"{}")??{},"object"!=typeof i||Array.isArray(i))throw new Error("Malformed tool call chunk args.");n.push({name:t.name??"",args:i,id:t.id})}catch(e){r.push({name:t.name,args:t.args,id:t.id,error:"Malformed args."})}}t={...e,tool_calls:n,invalid_tool_calls:r}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.tool_call_chunks=t?.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t?.tool_calls??this.tool_calls,this.invalid_tool_calls=t?.invalid_tool_calls??this.invalid_tool_calls}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){const t={content:wp(this.content,e.content),additional_kwargs:Ep(this.additional_kwargs,e.additional_kwargs),response_metadata:Ep(this.response_metadata,e.response_metadata),tool_call_chunks:[]};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const n=Ip(this.tool_call_chunks,e.tool_call_chunks);void 0!==n&&n.length>0&&(t.tool_call_chunks=n)}return new Op(t)}}class xp extends bp{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return xp}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}}class Cp extends Tp{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new Cp({content:wp(this.content,e.content),additional_kwargs:Ep(this.additional_kwargs,e.additional_kwargs),response_metadata:Ep(this.response_metadata,e.response_metadata),role:this.role})}}class Pp extends Tp{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new Pp({content:wp(this.content,e.content),additional_kwargs:Ep(this.additional_kwargs,e.additional_kwargs),response_metadata:Ep(this.response_metadata,e.response_metadata),name:this.name??""})}}class Np extends bp{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class Rp extends Tp{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new Rp({content:wp(this.content,e.content),additional_kwargs:Ep(this.additional_kwargs,e.additional_kwargs),response_metadata:Ep(this.response_metadata,e.response_metadata)})}}class jp extends bp{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class Lp extends Tp{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new Lp({content:wp(this.content,e.content),additional_kwargs:Ep(this.additional_kwargs,e.additional_kwargs),response_metadata:Ep(this.response_metadata,e.response_metadata)})}}function Dp(e){if("string"==typeof e)return new Np(e);if(kp(e))return e;const[t,n]=e;if("human"===t||"user"===t)return new Np({content:n});if("ai"===t||"assistant"===t)return new Ap({content:n});if("system"===t)return new jp({content:n});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function Mp(e,t="Human",n="AI"){const r=[];for(const i of e){let e;if("human"===i._getType())e=t;else if("ai"===i._getType())e=n;else if("system"===i._getType())e="System";else if("function"===i._getType())e="Function";else if("tool"===i._getType())e="Tool";else{if("generic"!==i._getType())throw new Error(`Got unsupported message type: ${i._getType()}`);e=i.role}const s=i.name?`${i.name}, `:"";r.push(`${e}: ${s}${i.content}`)}return r.join("\n")}function Up(e){const t=e._getType();if("human"===t)return new Rp({...e});if("ai"===t)return new Op({...e});if("system"===t)return new Lp({...e});if("function"===t)return new Pp({...e});if(xp.isInstance(e))return new Cp({...e});throw new Error("Unknown message type.")}const $p="__run";class Fp{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new Fp({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class Bp extends Fp{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new Bp({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}const Vp=()=>"undefined"!=typeof Deno;let qp;async function zp(){if(void 0===qp){const e=(()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||Vp()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":Vp()?"deno":"other":"node",e})();qp={library:"langchain-js",runtime:e}}return qp}function Hp(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}var Kp="object"==typeof window?window:{},Wp="0123456789abcdef".split(""),Gp=[-2147483648,8388608,32768,128],Zp=[24,16,8,0],Jp=[];function Qp(e){e?(Jp[0]=Jp[16]=Jp[1]=Jp[2]=Jp[3]=Jp[4]=Jp[5]=Jp[6]=Jp[7]=Jp[8]=Jp[9]=Jp[10]=Jp[11]=Jp[12]=Jp[13]=Jp[14]=Jp[15]=0,this.blocks=Jp):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Qp.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===Kp.ArrayBuffer&&(e=new Uint8Array(e));for(var n,r,i=0,s=e.length||0,a=this.blocks;i<s;){if(this.hashed&&(this.hashed=!1,a[0]=this.block,a[16]=a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=a[7]=a[8]=a[9]=a[10]=a[11]=a[12]=a[13]=a[14]=a[15]=0),t)for(r=this.start;i<s&&r<64;++i)a[r>>2]|=e[i]<<Zp[3&r++];else for(r=this.start;i<s&&r<64;++i)(n=e.charCodeAt(i))<128?a[r>>2]|=n<<Zp[3&r++]:n<2048?(a[r>>2]|=(192|n>>6)<<Zp[3&r++],a[r>>2]|=(128|63&n)<<Zp[3&r++]):n<55296||n>=57344?(a[r>>2]|=(224|n>>12)<<Zp[3&r++],a[r>>2]|=(128|n>>6&63)<<Zp[3&r++],a[r>>2]|=(128|63&n)<<Zp[3&r++]):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++i)),a[r>>2]|=(240|n>>18)<<Zp[3&r++],a[r>>2]|=(128|n>>12&63)<<Zp[3&r++],a[r>>2]|=(128|n>>6&63)<<Zp[3&r++],a[r>>2]|=(128|63&n)<<Zp[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=a[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},Qp.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=Gp[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},Qp.prototype.hash=function(){var e,t,n=this.h0,r=this.h1,i=this.h2,s=this.h3,a=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)n=(t=(r=(t=(i=(t=(s=(t=(a=(t=n<<5|n>>>27)+(r&i|~r&s)+a+1518500249+o[e]|0)<<5|a>>>27)+(n&(r=r<<30|r>>>2)|~n&i)+s+1518500249+o[e+1]|0)<<5|s>>>27)+(a&(n=n<<30|n>>>2)|~a&r)+i+1518500249+o[e+2]|0)<<5|i>>>27)+(s&(a=a<<30|a>>>2)|~s&n)+r+1518500249+o[e+3]|0)<<5|r>>>27)+(i&(s=s<<30|s>>>2)|~i&a)+n+1518500249+o[e+4]|0,i=i<<30|i>>>2;for(;e<40;e+=5)n=(t=(r=(t=(i=(t=(s=(t=(a=(t=n<<5|n>>>27)+(r^i^s)+a+1859775393+o[e]|0)<<5|a>>>27)+(n^(r=r<<30|r>>>2)^i)+s+1859775393+o[e+1]|0)<<5|s>>>27)+(a^(n=n<<30|n>>>2)^r)+i+1859775393+o[e+2]|0)<<5|i>>>27)+(s^(a=a<<30|a>>>2)^n)+r+1859775393+o[e+3]|0)<<5|r>>>27)+(i^(s=s<<30|s>>>2)^a)+n+1859775393+o[e+4]|0,i=i<<30|i>>>2;for(;e<60;e+=5)n=(t=(r=(t=(i=(t=(s=(t=(a=(t=n<<5|n>>>27)+(r&i|r&s|i&s)+a-1894007588+o[e]|0)<<5|a>>>27)+(n&(r=r<<30|r>>>2)|n&i|r&i)+s-1894007588+o[e+1]|0)<<5|s>>>27)+(a&(n=n<<30|n>>>2)|a&r|n&r)+i-1894007588+o[e+2]|0)<<5|i>>>27)+(s&(a=a<<30|a>>>2)|s&n|a&n)+r-1894007588+o[e+3]|0)<<5|r>>>27)+(i&(s=s<<30|s>>>2)|i&a|s&a)+n-1894007588+o[e+4]|0,i=i<<30|i>>>2;for(;e<80;e+=5)n=(t=(r=(t=(i=(t=(s=(t=(a=(t=n<<5|n>>>27)+(r^i^s)+a-899497514+o[e]|0)<<5|a>>>27)+(n^(r=r<<30|r>>>2)^i)+s-899497514+o[e+1]|0)<<5|s>>>27)+(a^(n=n<<30|n>>>2)^r)+i-899497514+o[e+2]|0)<<5|i>>>27)+(s^(a=a<<30|a>>>2)^n)+r-899497514+o[e+3]|0)<<5|r>>>27)+(i^(s=s<<30|s>>>2)^a)+n-899497514+o[e+4]|0,i=i<<30|i>>>2;this.h0=this.h0+n|0,this.h1=this.h1+r|0,this.h2=this.h2+i|0,this.h3=this.h3+s|0,this.h4=this.h4+a|0},Qp.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,i=this.h4;return Wp[e>>28&15]+Wp[e>>24&15]+Wp[e>>20&15]+Wp[e>>16&15]+Wp[e>>12&15]+Wp[e>>8&15]+Wp[e>>4&15]+Wp[15&e]+Wp[t>>28&15]+Wp[t>>24&15]+Wp[t>>20&15]+Wp[t>>16&15]+Wp[t>>12&15]+Wp[t>>8&15]+Wp[t>>4&15]+Wp[15&t]+Wp[n>>28&15]+Wp[n>>24&15]+Wp[n>>20&15]+Wp[n>>16&15]+Wp[n>>12&15]+Wp[n>>8&15]+Wp[n>>4&15]+Wp[15&n]+Wp[r>>28&15]+Wp[r>>24&15]+Wp[r>>20&15]+Wp[r>>16&15]+Wp[r>>12&15]+Wp[r>>8&15]+Wp[r>>4&15]+Wp[15&r]+Wp[i>>28&15]+Wp[i>>24&15]+Wp[i>>20&15]+Wp[i>>16&15]+Wp[i>>12&15]+Wp[i>>8&15]+Wp[i>>4&15]+Wp[15&i]},Qp.prototype.toString=Qp.prototype.hex,Qp.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,i=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24&255,r>>16&255,r>>8&255,255&r,i>>24&255,i>>16&255,i>>8&255,255&i]},Qp.prototype.array=Qp.prototype.digest,Qp.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};const Xp=(...e)=>{return t=e.join("_"),new Qp(!0).update(t).hex();var t};class Yp{}const em=new Map;class tm extends Yp{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Xp(e,t))??null)}async update(e,t,n){this.cache.set(Xp(e,t),n)}static global(){return new tm(em)}}class nm extends _p{}class rm extends nm{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Np(this.value)]}}class im extends nm{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Mp(this.messages)}toChatMessages(){return this.messages}}var sm=i(201),am=i(425);const om=[400,401,402,403,404,405,406,407,409],cm=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&om.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class um{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??cm;const t=am.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>sm((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}var lm=i(991),hm=Object.defineProperty;function dm(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let n=Array.from({length:e.length},((e,t)=>({start:t,end:t+1})));for(;n.length>1;){let r=null;for(let i=0;i<n.length-1;i++){const s=e.slice(n[i].start,n[i+1].end),a=t.get(s.join(","));null!=a&&(null==r||a<r[0])&&(r=[a,i])}if(null==r)break;{const e=r[1];n[e]={start:n[e].start,end:n[e+1].end},n.splice(e+1,1)}}return n}(e,t).map((n=>t.get(e.slice(n.start,n.end).join(",")))).filter((e=>null!=e))}var fm,pm,mm=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const n=e.bpe_ranks.split("\n").filter(Boolean).reduce(((e,t)=>{const[n,r,...i]=t.split(" "),s=Number.parseInt(r,10);return i.forEach(((t,n)=>e[t]=s+n)),e}),{});for(const[e,t]of Object.entries(n)){const n=lm.toByteArray(e);this.rankMap.set(n.join(","),t),this.textMap.set(t,n)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce(((e,[t,n])=>(e[n]=this.textEncoder.encode(t),e)),{})}encode(e,t=[],n="all"){const r=new RegExp(this.patStr,"ug"),i=mm.specialTokenRegex(Object.keys(this.specialTokens)),s=[],a=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===n?Object.keys(this.specialTokens).filter((e=>!a.has(e))):n);if(o.size>0){const t=mm.specialTokenRegex([...o]),n=e.match(t);if(null!=n)throw new Error(`The text contains a special token that is not allowed: ${n[0]}`)}let c=0;for(;;){let t=null,n=c;for(;i.lastIndex=n,t=i.exec(e),null!=t&&!a.has(t[0]);)n=t.index+1;const o=t?.index??e.length;for(const t of e.substring(c,o).matchAll(r)){const e=this.textEncoder.encode(t[0]),n=this.rankMap.get(e.join(","));null==n?s.push(...dm(e,this.rankMap)):s.push(n)}if(null==t)break;let u=this.specialTokens[t[0]];s.push(u),c=t.index+t[0].length}return s}decode(e){const t=[];let n=0;for(let r=0;r<e.length;++r){const i=e[r],s=this.textMap.get(i)??this.inverseSpecialTokens[i];null!=s&&(t.push(s),n+=s.length)}const r=new Uint8Array(n);let i=0;for(const e of t)r.set(e,i),i+=e.length;return this.textDecoder.decode(r)}},gm=mm;pm=e=>new RegExp(e.map((e=>function(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}(e))).join("|"),"g"),((e,t,n)=>{t in e?hm(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(gm,"symbol"!=typeof(fm="specialTokenRegex")?fm+"":fm,pm);const ym={},vm=new um({});var _m,wm;!function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter((e=>"number"!=typeof t[t[e]])),r={};for(const e of n)r[e]=t[e];return e.objectValues(r)},e.objectValues=t=>e.objectKeys(t).map((function(e){return t[e]})),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map((e=>"string"==typeof e?`'${e}'`:e)).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(_m||(_m={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(wm||(wm={}));const bm=_m.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Em=e=>{switch(typeof e){case"undefined":return bm.undefined;case"string":return bm.string;case"number":return isNaN(e)?bm.nan:bm.number;case"boolean":return bm.boolean;case"function":return bm.function;case"bigint":return bm.bigint;case"symbol":return bm.symbol;case"object":return Array.isArray(e)?bm.array:null===e?bm.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?bm.promise:"undefined"!=typeof Map&&e instanceof Map?bm.map:"undefined"!=typeof Set&&e instanceof Set?bm.set:"undefined"!=typeof Date&&e instanceof Date?bm.date:bm.object;default:return bm.unknown}},Im=_m.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class Tm extends Error{constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(e){return e.message},n={_errors:[]},r=e=>{for(const i of e.issues)if("invalid_union"===i.code)i.unionErrors.map(r);else if("invalid_return_type"===i.code)r(i.returnTypeError);else if("invalid_arguments"===i.code)r(i.argumentsError);else if(0===i.path.length)n._errors.push(t(i));else{let e=n,r=0;for(;r<i.path.length;){const n=i.path[r];r===i.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(i))):e[n]=e[n]||{_errors:[]},e=e[n],r++}}};return r(this),n}static assert(e){if(!(e instanceof Tm))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,_m.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=(e=>e.message)){const t={},n=[];for(const r of this.issues)r.path.length>0?(t[r.path[0]]=t[r.path[0]]||[],t[r.path[0]].push(e(r))):n.push(e(r));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}Tm.create=e=>new Tm(e);const km=(e,t)=>{let n;switch(e.code){case Im.invalid_type:n=e.received===bm.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case Im.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,_m.jsonStringifyReplacer)}`;break;case Im.unrecognized_keys:n=`Unrecognized key(s) in object: ${_m.joinValues(e.keys,", ")}`;break;case Im.invalid_union:n="Invalid input";break;case Im.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${_m.joinValues(e.options)}`;break;case Im.invalid_enum_value:n=`Invalid enum value. Expected ${_m.joinValues(e.options)}, received '${e.received}'`;break;case Im.invalid_arguments:n="Invalid function arguments";break;case Im.invalid_return_type:n="Invalid function return type";break;case Im.invalid_date:n="Invalid date";break;case Im.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:_m.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case Im.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case Im.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case Im.custom:n="Invalid input";break;case Im.invalid_intersection_types:n="Intersection results could not be merged";break;case Im.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case Im.not_finite:n="Number must be finite";break;default:n=t.defaultError,_m.assertNever(e)}return{message:n}};let Sm=km;function Am(){return Sm}const Om=e=>{const{data:t,path:n,errorMaps:r,issueData:i}=e,s=[...n,...i.path||[]],a={...i,path:s};if(void 0!==i.message)return{...i,path:s,message:i.message};let o="";const c=r.filter((e=>!!e)).slice().reverse();for(const e of c)o=e(a,{data:t,defaultError:o}).message;return{...i,path:s,message:o}};function xm(e,t){const n=Am(),r=Om({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===km?void 0:km].filter((e=>!!e))});e.common.issues.push(r)}class Cm{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const r of t){if("aborted"===r.status)return Pm;"dirty"===r.status&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,r=await e.value;n.push({key:t,value:r})}return Cm.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const r of t){const{key:t,value:i}=r;if("aborted"===t.status)return Pm;if("aborted"===i.status)return Pm;"dirty"===t.status&&e.dirty(),"dirty"===i.status&&e.dirty(),"__proto__"===t.value||void 0===i.value&&!r.alwaysSet||(n[t.value]=i.value)}return{status:e.value,value:n}}}const Pm=Object.freeze({status:"aborted"}),Nm=e=>({status:"dirty",value:e}),Rm=e=>({status:"valid",value:e}),jm=e=>"aborted"===e.status,Lm=e=>"dirty"===e.status,Dm=e=>"valid"===e.status,Mm=e=>"undefined"!=typeof Promise&&e instanceof Promise;function Um(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function $m(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n}var Fm,Bm,Vm;"function"==typeof SuppressedError&&SuppressedError,function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(Fm||(Fm={}));class qm{constructor(e,t,n,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=r}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const zm=(e,t)=>{if(Dm(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new Tm(e.common.issues);return this._error=t,this._error}}};function Hm(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:r,description:i}=e;if(t&&(n||r))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:i}:{errorMap:(t,i)=>{var s,a;const{message:o}=e;return"invalid_enum_value"===t.code?{message:null!=o?o:i.defaultError}:void 0===i.data?{message:null!==(s=null!=o?o:r)&&void 0!==s?s:i.defaultError}:"invalid_type"!==t.code?{message:i.defaultError}:{message:null!==(a=null!=o?o:n)&&void 0!==a?a:i.defaultError}},description:i}}class Km{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return Em(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Em(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Cm,ctx:{common:e.parent.common,data:e.data,parsedType:Em(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Mm(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;const r={common:{issues:[],async:null!==(n=null==t?void 0:t.async)&&void 0!==n&&n,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Em(e)},i=this._parseSync({data:e,path:r.path,parent:r});return zm(r,i)}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Em(e)},r=this._parse({data:e,path:n.path,parent:n}),i=await(Mm(r)?r:Promise.resolve(r));return zm(n,i)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement(((t,r)=>{const i=e(t),s=()=>r.addIssue({code:Im.custom,...n(t)});return"undefined"!=typeof Promise&&i instanceof Promise?i.then((e=>!!e||(s(),!1))):!!i||(s(),!1)}))}refinement(e,t){return this._refinement(((n,r)=>!!e(n)||(r.addIssue("function"==typeof t?t(n,r):t),!1)))}_refinement(e){return new Fg({schema:this,typeName:Xg.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return Bg.create(this,this._def)}nullable(){return Vg.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return bg.create(this,this._def)}promise(){return $g.create(this,this._def)}or(e){return Tg.create([this,e],this._def)}and(e){return Og.create(this,e,this._def)}transform(e){return new Fg({...Hm(this._def),schema:this,typeName:Xg.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new qg({...Hm(this._def),innerType:this,defaultValue:t,typeName:Xg.ZodDefault})}brand(){return new Wg({typeName:Xg.ZodBranded,type:this,...Hm(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new zg({...Hm(this._def),innerType:this,catchValue:t,typeName:Xg.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return Gg.create(this,e)}readonly(){return Zg.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Wm=/^c[^\s-]{8,}$/i,Gm=/^[0-9a-z]+$/,Zm=/^[0-9A-HJKMNP-TV-Z]{26}$/,Jm=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Qm=/^[a-z0-9_-]{21}$/i,Xm=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Ym=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let eg;const tg=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ng=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,rg=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,ig="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",sg=new RegExp(`^${ig}$`);function ag(e){let t="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),t}function og(e){let t=`${ig}T${ag(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}class cg extends Km{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==bm.string){const t=this._getOrReturnCtx(e);return xm(t,{code:Im.invalid_type,expected:bm.string,received:t.parsedType}),Pm}const t=new Cm;let n;for(const s of this._def.checks)if("min"===s.kind)e.data.length<s.value&&(n=this._getOrReturnCtx(e,n),xm(n,{code:Im.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("max"===s.kind)e.data.length>s.value&&(n=this._getOrReturnCtx(e,n),xm(n,{code:Im.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("length"===s.kind){const r=e.data.length>s.value,i=e.data.length<s.value;(r||i)&&(n=this._getOrReturnCtx(e,n),r?xm(n,{code:Im.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):i&&xm(n,{code:Im.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),t.dirty())}else if("email"===s.kind)Ym.test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{validation:"email",code:Im.invalid_string,message:s.message}),t.dirty());else if("emoji"===s.kind)eg||(eg=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),eg.test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{validation:"emoji",code:Im.invalid_string,message:s.message}),t.dirty());else if("uuid"===s.kind)Jm.test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{validation:"uuid",code:Im.invalid_string,message:s.message}),t.dirty());else if("nanoid"===s.kind)Qm.test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{validation:"nanoid",code:Im.invalid_string,message:s.message}),t.dirty());else if("cuid"===s.kind)Wm.test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{validation:"cuid",code:Im.invalid_string,message:s.message}),t.dirty());else if("cuid2"===s.kind)Gm.test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{validation:"cuid2",code:Im.invalid_string,message:s.message}),t.dirty());else if("ulid"===s.kind)Zm.test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{validation:"ulid",code:Im.invalid_string,message:s.message}),t.dirty());else if("url"===s.kind)try{new URL(e.data)}catch(r){n=this._getOrReturnCtx(e,n),xm(n,{validation:"url",code:Im.invalid_string,message:s.message}),t.dirty()}else"regex"===s.kind?(s.regex.lastIndex=0,s.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{validation:"regex",code:Im.invalid_string,message:s.message}),t.dirty())):"trim"===s.kind?e.data=e.data.trim():"includes"===s.kind?e.data.includes(s.value,s.position)||(n=this._getOrReturnCtx(e,n),xm(n,{code:Im.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),t.dirty()):"toLowerCase"===s.kind?e.data=e.data.toLowerCase():"toUpperCase"===s.kind?e.data=e.data.toUpperCase():"startsWith"===s.kind?e.data.startsWith(s.value)||(n=this._getOrReturnCtx(e,n),xm(n,{code:Im.invalid_string,validation:{startsWith:s.value},message:s.message}),t.dirty()):"endsWith"===s.kind?e.data.endsWith(s.value)||(n=this._getOrReturnCtx(e,n),xm(n,{code:Im.invalid_string,validation:{endsWith:s.value},message:s.message}),t.dirty()):"datetime"===s.kind?og(s).test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{code:Im.invalid_string,validation:"datetime",message:s.message}),t.dirty()):"date"===s.kind?sg.test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{code:Im.invalid_string,validation:"date",message:s.message}),t.dirty()):"time"===s.kind?new RegExp(`^${ag(s)}$`).test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{code:Im.invalid_string,validation:"time",message:s.message}),t.dirty()):"duration"===s.kind?Xm.test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{validation:"duration",code:Im.invalid_string,message:s.message}),t.dirty()):"ip"===s.kind?(r=e.data,("v4"!==(i=s.version)&&i||!tg.test(r))&&("v6"!==i&&i||!ng.test(r))&&(n=this._getOrReturnCtx(e,n),xm(n,{validation:"ip",code:Im.invalid_string,message:s.message}),t.dirty())):"base64"===s.kind?rg.test(e.data)||(n=this._getOrReturnCtx(e,n),xm(n,{validation:"base64",code:Im.invalid_string,message:s.message}),t.dirty()):_m.assertNever(s);var r,i;return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement((t=>e.test(t)),{validation:t,code:Im.invalid_string,...Fm.errToObj(n)})}_addCheck(e){return new cg({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...Fm.errToObj(e)})}url(e){return this._addCheck({kind:"url",...Fm.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...Fm.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...Fm.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...Fm.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...Fm.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...Fm.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...Fm.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...Fm.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...Fm.errToObj(e)})}datetime(e){var t,n;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(n=null==e?void 0:e.local)&&void 0!==n&&n,...Fm.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...Fm.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...Fm.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...Fm.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...Fm.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...Fm.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...Fm.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...Fm.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...Fm.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...Fm.errToObj(t)})}nonempty(e){return this.min(1,Fm.errToObj(e))}trim(){return new cg({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new cg({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new cg({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find((e=>"datetime"===e.kind))}get isDate(){return!!this._def.checks.find((e=>"date"===e.kind))}get isTime(){return!!this._def.checks.find((e=>"time"===e.kind))}get isDuration(){return!!this._def.checks.find((e=>"duration"===e.kind))}get isEmail(){return!!this._def.checks.find((e=>"email"===e.kind))}get isURL(){return!!this._def.checks.find((e=>"url"===e.kind))}get isEmoji(){return!!this._def.checks.find((e=>"emoji"===e.kind))}get isUUID(){return!!this._def.checks.find((e=>"uuid"===e.kind))}get isNANOID(){return!!this._def.checks.find((e=>"nanoid"===e.kind))}get isCUID(){return!!this._def.checks.find((e=>"cuid"===e.kind))}get isCUID2(){return!!this._def.checks.find((e=>"cuid2"===e.kind))}get isULID(){return!!this._def.checks.find((e=>"ulid"===e.kind))}get isIP(){return!!this._def.checks.find((e=>"ip"===e.kind))}get isBase64(){return!!this._def.checks.find((e=>"base64"===e.kind))}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function ug(e,t){const n=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,i=n>r?n:r;return parseInt(e.toFixed(i).replace(".",""))%parseInt(t.toFixed(i).replace(".",""))/Math.pow(10,i)}cg.create=e=>{var t;return new cg({checks:[],typeName:Xg.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...Hm(e)})};class lg extends Km{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==bm.number){const t=this._getOrReturnCtx(e);return xm(t,{code:Im.invalid_type,expected:bm.number,received:t.parsedType}),Pm}let t;const n=new Cm;for(const r of this._def.checks)"int"===r.kind?_m.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),xm(t,{code:Im.invalid_type,expected:"integer",received:"float",message:r.message}),n.dirty()):"min"===r.kind?(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),xm(t,{code:Im.too_small,minimum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty()):"max"===r.kind?(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),xm(t,{code:Im.too_big,maximum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty()):"multipleOf"===r.kind?0!==ug(e.data,r.value)&&(t=this._getOrReturnCtx(e,t),xm(t,{code:Im.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):"finite"===r.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),xm(t,{code:Im.not_finite,message:r.message}),n.dirty()):_m.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,Fm.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Fm.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Fm.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Fm.toString(t))}setLimit(e,t,n,r){return new lg({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Fm.toString(r)}]})}_addCheck(e){return new lg({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:Fm.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:Fm.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:Fm.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:Fm.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:Fm.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Fm.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:Fm.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:Fm.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:Fm.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find((e=>"int"===e.kind||"multipleOf"===e.kind&&_m.isInteger(e.value)))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}lg.create=e=>new lg({checks:[],typeName:Xg.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...Hm(e)});class hg extends Km{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==bm.bigint){const t=this._getOrReturnCtx(e);return xm(t,{code:Im.invalid_type,expected:bm.bigint,received:t.parsedType}),Pm}let t;const n=new Cm;for(const r of this._def.checks)"min"===r.kind?(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),xm(t,{code:Im.too_small,type:"bigint",minimum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty()):"max"===r.kind?(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),xm(t,{code:Im.too_big,type:"bigint",maximum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty()):"multipleOf"===r.kind?e.data%r.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),xm(t,{code:Im.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):_m.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,Fm.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Fm.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Fm.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Fm.toString(t))}setLimit(e,t,n,r){return new hg({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Fm.toString(r)}]})}_addCheck(e){return new hg({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:Fm.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:Fm.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:Fm.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:Fm.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Fm.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}hg.create=e=>{var t;return new hg({checks:[],typeName:Xg.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...Hm(e)})};class dg extends Km{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==bm.boolean){const t=this._getOrReturnCtx(e);return xm(t,{code:Im.invalid_type,expected:bm.boolean,received:t.parsedType}),Pm}return Rm(e.data)}}dg.create=e=>new dg({typeName:Xg.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...Hm(e)});class fg extends Km{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==bm.date){const t=this._getOrReturnCtx(e);return xm(t,{code:Im.invalid_type,expected:bm.date,received:t.parsedType}),Pm}if(isNaN(e.data.getTime()))return xm(this._getOrReturnCtx(e),{code:Im.invalid_date}),Pm;const t=new Cm;let n;for(const r of this._def.checks)"min"===r.kind?e.data.getTime()<r.value&&(n=this._getOrReturnCtx(e,n),xm(n,{code:Im.too_small,message:r.message,inclusive:!0,exact:!1,minimum:r.value,type:"date"}),t.dirty()):"max"===r.kind?e.data.getTime()>r.value&&(n=this._getOrReturnCtx(e,n),xm(n,{code:Im.too_big,message:r.message,inclusive:!0,exact:!1,maximum:r.value,type:"date"}),t.dirty()):_m.assertNever(r);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new fg({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:Fm.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:Fm.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}fg.create=e=>new fg({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:Xg.ZodDate,...Hm(e)});class pg extends Km{_parse(e){if(this._getType(e)!==bm.symbol){const t=this._getOrReturnCtx(e);return xm(t,{code:Im.invalid_type,expected:bm.symbol,received:t.parsedType}),Pm}return Rm(e.data)}}pg.create=e=>new pg({typeName:Xg.ZodSymbol,...Hm(e)});class mg extends Km{_parse(e){if(this._getType(e)!==bm.undefined){const t=this._getOrReturnCtx(e);return xm(t,{code:Im.invalid_type,expected:bm.undefined,received:t.parsedType}),Pm}return Rm(e.data)}}mg.create=e=>new mg({typeName:Xg.ZodUndefined,...Hm(e)});class gg extends Km{_parse(e){if(this._getType(e)!==bm.null){const t=this._getOrReturnCtx(e);return xm(t,{code:Im.invalid_type,expected:bm.null,received:t.parsedType}),Pm}return Rm(e.data)}}gg.create=e=>new gg({typeName:Xg.ZodNull,...Hm(e)});class yg extends Km{constructor(){super(...arguments),this._any=!0}_parse(e){return Rm(e.data)}}yg.create=e=>new yg({typeName:Xg.ZodAny,...Hm(e)});class vg extends Km{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Rm(e.data)}}vg.create=e=>new vg({typeName:Xg.ZodUnknown,...Hm(e)});class _g extends Km{_parse(e){const t=this._getOrReturnCtx(e);return xm(t,{code:Im.invalid_type,expected:bm.never,received:t.parsedType}),Pm}}_g.create=e=>new _g({typeName:Xg.ZodNever,...Hm(e)});class wg extends Km{_parse(e){if(this._getType(e)!==bm.undefined){const t=this._getOrReturnCtx(e);return xm(t,{code:Im.invalid_type,expected:bm.void,received:t.parsedType}),Pm}return Rm(e.data)}}wg.create=e=>new wg({typeName:Xg.ZodVoid,...Hm(e)});class bg extends Km{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),r=this._def;if(t.parsedType!==bm.array)return xm(t,{code:Im.invalid_type,expected:bm.array,received:t.parsedType}),Pm;if(null!==r.exactLength){const e=t.data.length>r.exactLength.value,i=t.data.length<r.exactLength.value;(e||i)&&(xm(t,{code:e?Im.too_big:Im.too_small,minimum:i?r.exactLength.value:void 0,maximum:e?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty())}if(null!==r.minLength&&t.data.length<r.minLength.value&&(xm(t,{code:Im.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),null!==r.maxLength&&t.data.length>r.maxLength.value&&(xm(t,{code:Im.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map(((e,n)=>r.type._parseAsync(new qm(t,e,t.path,n))))).then((e=>Cm.mergeArray(n,e)));const i=[...t.data].map(((e,n)=>r.type._parseSync(new qm(t,e,t.path,n))));return Cm.mergeArray(n,i)}get element(){return this._def.type}min(e,t){return new bg({...this._def,minLength:{value:e,message:Fm.toString(t)}})}max(e,t){return new bg({...this._def,maxLength:{value:e,message:Fm.toString(t)}})}length(e,t){return new bg({...this._def,exactLength:{value:e,message:Fm.toString(t)}})}nonempty(e){return this.min(1,e)}}function Eg(e){if(e instanceof Ig){const t={};for(const n in e.shape){const r=e.shape[n];t[n]=Bg.create(Eg(r))}return new Ig({...e._def,shape:()=>t})}return e instanceof bg?new bg({...e._def,type:Eg(e.element)}):e instanceof Bg?Bg.create(Eg(e.unwrap())):e instanceof Vg?Vg.create(Eg(e.unwrap())):e instanceof xg?xg.create(e.items.map((e=>Eg(e)))):e}bg.create=(e,t)=>new bg({type:e,minLength:null,maxLength:null,exactLength:null,typeName:Xg.ZodArray,...Hm(t)});class Ig extends Km{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=_m.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==bm.object){const t=this._getOrReturnCtx(e);return xm(t,{code:Im.invalid_type,expected:bm.object,received:t.parsedType}),Pm}const{status:t,ctx:n}=this._processInputParams(e),{shape:r,keys:i}=this._getCached(),s=[];if(!(this._def.catchall instanceof _g&&"strip"===this._def.unknownKeys))for(const e in n.data)i.includes(e)||s.push(e);const a=[];for(const e of i){const t=r[e],i=n.data[e];a.push({key:{status:"valid",value:e},value:t._parse(new qm(n,i,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof _g){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of s)a.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)s.length>0&&(xm(n,{code:Im.unrecognized_keys,keys:s}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of s){const r=n.data[t];a.push({key:{status:"valid",value:t},value:e._parse(new qm(n,r,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then((async()=>{const e=[];for(const t of a){const n=await t.key,r=await t.value;e.push({key:n,value:r,alwaysSet:t.alwaysSet})}return e})).then((e=>Cm.mergeObjectSync(t,e))):Cm.mergeObjectSync(t,a)}get shape(){return this._def.shape()}strict(e){return Fm.errToObj,new Ig({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{var r,i,s,a;const o=null!==(s=null===(i=(r=this._def).errorMap)||void 0===i?void 0:i.call(r,t,n).message)&&void 0!==s?s:n.defaultError;return"unrecognized_keys"===t.code?{message:null!==(a=Fm.errToObj(e).message)&&void 0!==a?a:o}:{message:o}}}:{}})}strip(){return new Ig({...this._def,unknownKeys:"strip"})}passthrough(){return new Ig({...this._def,unknownKeys:"passthrough"})}extend(e){return new Ig({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Ig({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:Xg.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new Ig({...this._def,catchall:e})}pick(e){const t={};return _m.objectKeys(e).forEach((n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])})),new Ig({...this._def,shape:()=>t})}omit(e){const t={};return _m.objectKeys(this.shape).forEach((n=>{e[n]||(t[n]=this.shape[n])})),new Ig({...this._def,shape:()=>t})}deepPartial(){return Eg(this)}partial(e){const t={};return _m.objectKeys(this.shape).forEach((n=>{const r=this.shape[n];e&&!e[n]?t[n]=r:t[n]=r.optional()})),new Ig({...this._def,shape:()=>t})}required(e){const t={};return _m.objectKeys(this.shape).forEach((n=>{if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof Bg;)e=e._def.innerType;t[n]=e}})),new Ig({...this._def,shape:()=>t})}keyof(){return Dg(_m.objectKeys(this.shape))}}Ig.create=(e,t)=>new Ig({shape:()=>e,unknownKeys:"strip",catchall:_g.create(),typeName:Xg.ZodObject,...Hm(t)}),Ig.strictCreate=(e,t)=>new Ig({shape:()=>e,unknownKeys:"strict",catchall:_g.create(),typeName:Xg.ZodObject,...Hm(t)}),Ig.lazycreate=(e,t)=>new Ig({shape:e,unknownKeys:"strip",catchall:_g.create(),typeName:Xg.ZodObject,...Hm(t)});class Tg extends Km{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map((async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}}))).then((function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map((e=>new Tm(e.ctx.common.issues)));return xm(t,{code:Im.invalid_union,unionErrors:n}),Pm}));{let e;const r=[];for(const i of n){const n={...t,common:{...t.common,issues:[]},parent:null},s=i._parseSync({data:t.data,path:t.path,parent:n});if("valid"===s.status)return s;"dirty"!==s.status||e||(e={result:s,ctx:n}),n.common.issues.length&&r.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const i=r.map((e=>new Tm(e)));return xm(t,{code:Im.invalid_union,unionErrors:i}),Pm}}get options(){return this._def.options}}Tg.create=(e,t)=>new Tg({options:e,typeName:Xg.ZodUnion,...Hm(t)});const kg=e=>e instanceof jg?kg(e.schema):e instanceof Fg?kg(e.innerType()):e instanceof Lg?[e.value]:e instanceof Mg?e.options:e instanceof Ug?_m.objectValues(e.enum):e instanceof qg?kg(e._def.innerType):e instanceof mg?[void 0]:e instanceof gg?[null]:e instanceof Bg?[void 0,...kg(e.unwrap())]:e instanceof Vg?[null,...kg(e.unwrap())]:e instanceof Wg||e instanceof Zg?kg(e.unwrap()):e instanceof zg?kg(e._def.innerType):[];class Sg extends Km{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==bm.object)return xm(t,{code:Im.invalid_type,expected:bm.object,received:t.parsedType}),Pm;const n=this.discriminator,r=t.data[n],i=this.optionsMap.get(r);return i?t.common.async?i._parseAsync({data:t.data,path:t.path,parent:t}):i._parseSync({data:t.data,path:t.path,parent:t}):(xm(t,{code:Im.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),Pm)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const r=new Map;for(const n of t){const t=kg(n.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const i of t){if(r.has(i))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(i)}`);r.set(i,n)}}return new Sg({typeName:Xg.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:r,...Hm(n)})}}function Ag(e,t){const n=Em(e),r=Em(t);if(e===t)return{valid:!0,data:e};if(n===bm.object&&r===bm.object){const n=_m.objectKeys(t),r=_m.objectKeys(e).filter((e=>-1!==n.indexOf(e))),i={...e,...t};for(const n of r){const r=Ag(e[n],t[n]);if(!r.valid)return{valid:!1};i[n]=r.data}return{valid:!0,data:i}}if(n===bm.array&&r===bm.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let r=0;r<e.length;r++){const i=Ag(e[r],t[r]);if(!i.valid)return{valid:!1};n.push(i.data)}return{valid:!0,data:n}}return n===bm.date&&r===bm.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}class Og extends Km{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=(e,r)=>{if(jm(e)||jm(r))return Pm;const i=Ag(e.value,r.value);return i.valid?((Lm(e)||Lm(r))&&t.dirty(),{status:t.value,value:i.data}):(xm(n,{code:Im.invalid_intersection_types}),Pm)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then((([e,t])=>r(e,t))):r(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}Og.create=(e,t,n)=>new Og({left:e,right:t,typeName:Xg.ZodIntersection,...Hm(n)});class xg extends Km{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==bm.array)return xm(n,{code:Im.invalid_type,expected:bm.array,received:n.parsedType}),Pm;if(n.data.length<this._def.items.length)return xm(n,{code:Im.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Pm;!this._def.rest&&n.data.length>this._def.items.length&&(xm(n,{code:Im.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const r=[...n.data].map(((e,t)=>{const r=this._def.items[t]||this._def.rest;return r?r._parse(new qm(n,e,n.path,t)):null})).filter((e=>!!e));return n.common.async?Promise.all(r).then((e=>Cm.mergeArray(t,e))):Cm.mergeArray(t,r)}get items(){return this._def.items}rest(e){return new xg({...this._def,rest:e})}}xg.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new xg({items:e,typeName:Xg.ZodTuple,rest:null,...Hm(t)})};class Cg extends Km{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==bm.object)return xm(n,{code:Im.invalid_type,expected:bm.object,received:n.parsedType}),Pm;const r=[],i=this._def.keyType,s=this._def.valueType;for(const e in n.data)r.push({key:i._parse(new qm(n,e,n.path,e)),value:s._parse(new qm(n,n.data[e],n.path,e)),alwaysSet:e in n.data});return n.common.async?Cm.mergeObjectAsync(t,r):Cm.mergeObjectSync(t,r)}get element(){return this._def.valueType}static create(e,t,n){return new Cg(t instanceof Km?{keyType:e,valueType:t,typeName:Xg.ZodRecord,...Hm(n)}:{keyType:cg.create(),valueType:e,typeName:Xg.ZodRecord,...Hm(t)})}}class Pg extends Km{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==bm.map)return xm(n,{code:Im.invalid_type,expected:bm.map,received:n.parsedType}),Pm;const r=this._def.keyType,i=this._def.valueType,s=[...n.data.entries()].map((([e,t],s)=>({key:r._parse(new qm(n,e,n.path,[s,"key"])),value:i._parse(new qm(n,t,n.path,[s,"value"]))})));if(n.common.async){const e=new Map;return Promise.resolve().then((async()=>{for(const n of s){const r=await n.key,i=await n.value;if("aborted"===r.status||"aborted"===i.status)return Pm;"dirty"!==r.status&&"dirty"!==i.status||t.dirty(),e.set(r.value,i.value)}return{status:t.value,value:e}}))}{const e=new Map;for(const n of s){const r=n.key,i=n.value;if("aborted"===r.status||"aborted"===i.status)return Pm;"dirty"!==r.status&&"dirty"!==i.status||t.dirty(),e.set(r.value,i.value)}return{status:t.value,value:e}}}}Pg.create=(e,t,n)=>new Pg({valueType:t,keyType:e,typeName:Xg.ZodMap,...Hm(n)});class Ng extends Km{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==bm.set)return xm(n,{code:Im.invalid_type,expected:bm.set,received:n.parsedType}),Pm;const r=this._def;null!==r.minSize&&n.data.size<r.minSize.value&&(xm(n,{code:Im.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),t.dirty()),null!==r.maxSize&&n.data.size>r.maxSize.value&&(xm(n,{code:Im.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),t.dirty());const i=this._def.valueType;function s(e){const n=new Set;for(const r of e){if("aborted"===r.status)return Pm;"dirty"===r.status&&t.dirty(),n.add(r.value)}return{status:t.value,value:n}}const a=[...n.data.values()].map(((e,t)=>i._parse(new qm(n,e,n.path,t))));return n.common.async?Promise.all(a).then((e=>s(e))):s(a)}min(e,t){return new Ng({...this._def,minSize:{value:e,message:Fm.toString(t)}})}max(e,t){return new Ng({...this._def,maxSize:{value:e,message:Fm.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Ng.create=(e,t)=>new Ng({valueType:e,minSize:null,maxSize:null,typeName:Xg.ZodSet,...Hm(t)});class Rg extends Km{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==bm.function)return xm(t,{code:Im.invalid_type,expected:bm.function,received:t.parsedType}),Pm;function n(e,n){return Om({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Am(),km].filter((e=>!!e)),issueData:{code:Im.invalid_arguments,argumentsError:n}})}function r(e,n){return Om({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Am(),km].filter((e=>!!e)),issueData:{code:Im.invalid_return_type,returnTypeError:n}})}const i={errorMap:t.common.contextualErrorMap},s=t.data;if(this._def.returns instanceof $g){const e=this;return Rm((async function(...t){const a=new Tm([]),o=await e._def.args.parseAsync(t,i).catch((e=>{throw a.addIssue(n(t,e)),a})),c=await Reflect.apply(s,this,o);return await e._def.returns._def.type.parseAsync(c,i).catch((e=>{throw a.addIssue(r(c,e)),a}))}))}{const e=this;return Rm((function(...t){const a=e._def.args.safeParse(t,i);if(!a.success)throw new Tm([n(t,a.error)]);const o=Reflect.apply(s,this,a.data),c=e._def.returns.safeParse(o,i);if(!c.success)throw new Tm([r(o,c.error)]);return c.data}))}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new Rg({...this._def,args:xg.create(e).rest(vg.create())})}returns(e){return new Rg({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new Rg({args:e||xg.create([]).rest(vg.create()),returns:t||vg.create(),typeName:Xg.ZodFunction,...Hm(n)})}}class jg extends Km{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}jg.create=(e,t)=>new jg({getter:e,typeName:Xg.ZodLazy,...Hm(t)});class Lg extends Km{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return xm(t,{received:t.data,code:Im.invalid_literal,expected:this._def.value}),Pm}return{status:"valid",value:e.data}}get value(){return this._def.value}}function Dg(e,t){return new Mg({values:e,typeName:Xg.ZodEnum,...Hm(t)})}Lg.create=(e,t)=>new Lg({value:e,typeName:Xg.ZodLiteral,...Hm(t)});class Mg extends Km{constructor(){super(...arguments),Bm.set(this,void 0)}_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return xm(t,{expected:_m.joinValues(n),received:t.parsedType,code:Im.invalid_type}),Pm}if(Um(this,Bm,"f")||$m(this,Bm,new Set(this._def.values),"f"),!Um(this,Bm,"f").has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return xm(t,{received:t.data,code:Im.invalid_enum_value,options:n}),Pm}return Rm(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Mg.create(e,{...this._def,...t})}exclude(e,t=this._def){return Mg.create(this.options.filter((t=>!e.includes(t))),{...this._def,...t})}}Bm=new WeakMap,Mg.create=Dg;class Ug extends Km{constructor(){super(...arguments),Vm.set(this,void 0)}_parse(e){const t=_m.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==bm.string&&n.parsedType!==bm.number){const e=_m.objectValues(t);return xm(n,{expected:_m.joinValues(e),received:n.parsedType,code:Im.invalid_type}),Pm}if(Um(this,Vm,"f")||$m(this,Vm,new Set(_m.getValidEnumValues(this._def.values)),"f"),!Um(this,Vm,"f").has(e.data)){const e=_m.objectValues(t);return xm(n,{received:n.data,code:Im.invalid_enum_value,options:e}),Pm}return Rm(e.data)}get enum(){return this._def.values}}Vm=new WeakMap,Ug.create=(e,t)=>new Ug({values:e,typeName:Xg.ZodNativeEnum,...Hm(t)});class $g extends Km{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==bm.promise&&!1===t.common.async)return xm(t,{code:Im.invalid_type,expected:bm.promise,received:t.parsedType}),Pm;const n=t.parsedType===bm.promise?t.data:Promise.resolve(t.data);return Rm(n.then((e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap}))))}}$g.create=(e,t)=>new $g({type:e,typeName:Xg.ZodPromise,...Hm(t)});class Fg extends Km{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===Xg.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=this._def.effect||null,i={addIssue:e=>{xm(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(i.addIssue=i.addIssue.bind(i),"preprocess"===r.type){const e=r.transform(n.data,i);if(n.common.async)return Promise.resolve(e).then((async e=>{if("aborted"===t.value)return Pm;const r=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===r.status?Pm:"dirty"===r.status||"dirty"===t.value?Nm(r.value):r}));{if("aborted"===t.value)return Pm;const r=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===r.status?Pm:"dirty"===r.status||"dirty"===t.value?Nm(r.value):r}}if("refinement"===r.type){const e=e=>{const t=r.refinement(e,i);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const r=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===r.status?Pm:("dirty"===r.status&&t.dirty(),e(r.value),{status:t.value,value:r.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((n=>"aborted"===n.status?Pm:("dirty"===n.status&&t.dirty(),e(n.value).then((()=>({status:t.value,value:n.value}))))))}if("transform"===r.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Dm(e))return e;const s=r.transform(e.value,i);if(s instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:s}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((e=>Dm(e)?Promise.resolve(r.transform(e.value,i)).then((e=>({status:t.value,value:e}))):e))}_m.assertNever(r)}}Fg.create=(e,t,n)=>new Fg({schema:e,typeName:Xg.ZodEffects,effect:t,...Hm(n)}),Fg.createWithPreprocess=(e,t,n)=>new Fg({schema:t,effect:{type:"preprocess",transform:e},typeName:Xg.ZodEffects,...Hm(n)});class Bg extends Km{_parse(e){return this._getType(e)===bm.undefined?Rm(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Bg.create=(e,t)=>new Bg({innerType:e,typeName:Xg.ZodOptional,...Hm(t)});class Vg extends Km{_parse(e){return this._getType(e)===bm.null?Rm(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Vg.create=(e,t)=>new Vg({innerType:e,typeName:Xg.ZodNullable,...Hm(t)});class qg extends Km{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===bm.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}qg.create=(e,t)=>new qg({innerType:e,typeName:Xg.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...Hm(t)});class zg extends Km{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Mm(r)?r.then((e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new Tm(n.common.issues)},input:n.data})}))):{status:"valid",value:"valid"===r.status?r.value:this._def.catchValue({get error(){return new Tm(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}zg.create=(e,t)=>new zg({innerType:e,typeName:Xg.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...Hm(t)});class Hg extends Km{_parse(e){if(this._getType(e)!==bm.nan){const t=this._getOrReturnCtx(e);return xm(t,{code:Im.invalid_type,expected:bm.nan,received:t.parsedType}),Pm}return{status:"valid",value:e.data}}}Hg.create=e=>new Hg({typeName:Xg.ZodNaN,...Hm(e)});const Kg=Symbol("zod_brand");class Wg extends Km{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class Gg extends Km{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?Pm:"dirty"===e.status?(t.dirty(),Nm(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})();{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?Pm:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new Gg({in:e,out:t,typeName:Xg.ZodPipeline})}}class Zg extends Km{_parse(e){const t=this._def.innerType._parse(e),n=e=>(Dm(e)&&(e.value=Object.freeze(e.value)),e);return Mm(t)?t.then((e=>n(e))):n(t)}unwrap(){return this._def.innerType}}function Jg(e,t={},n){return e?yg.create().superRefine(((r,i)=>{var s,a;if(!e(r)){const e="function"==typeof t?t(r):"string"==typeof t?{message:t}:t,o=null===(a=null!==(s=e.fatal)&&void 0!==s?s:n)||void 0===a||a,c="string"==typeof e?{message:e}:e;i.addIssue({code:"custom",...c,fatal:o})}})):yg.create()}Zg.create=(e,t)=>new Zg({innerType:e,typeName:Xg.ZodReadonly,...Hm(t)});const Qg={object:Ig.lazycreate};var Xg;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(Xg||(Xg={}));const Yg=cg.create,ey=lg.create,ty=Hg.create,ny=hg.create,ry=dg.create,iy=fg.create,sy=pg.create,ay=mg.create,oy=gg.create,cy=yg.create,uy=vg.create,ly=_g.create,hy=wg.create,dy=bg.create,fy=Ig.create,py=Ig.strictCreate,my=Tg.create,gy=Sg.create,yy=Og.create,vy=xg.create,_y=Cg.create,wy=Pg.create,by=Ng.create,Ey=Rg.create,Iy=jg.create,Ty=Lg.create,ky=Mg.create,Sy=Ug.create,Ay=$g.create,Oy=Fg.create,xy=Bg.create,Cy=Vg.create,Py=Fg.createWithPreprocess,Ny=Gg.create,Ry={string:e=>cg.create({...e,coerce:!0}),number:e=>lg.create({...e,coerce:!0}),boolean:e=>dg.create({...e,coerce:!0}),bigint:e=>hg.create({...e,coerce:!0}),date:e=>fg.create({...e,coerce:!0})},jy=Pm;var Ly=Object.freeze({__proto__:null,defaultErrorMap:km,setErrorMap:function(e){Sm=e},getErrorMap:Am,makeIssue:Om,EMPTY_PATH:[],addIssueToContext:xm,ParseStatus:Cm,INVALID:Pm,DIRTY:Nm,OK:Rm,isAborted:jm,isDirty:Lm,isValid:Dm,isAsync:Mm,get util(){return _m},get objectUtil(){return wm},ZodParsedType:bm,getParsedType:Em,ZodType:Km,datetimeRegex:og,ZodString:cg,ZodNumber:lg,ZodBigInt:hg,ZodBoolean:dg,ZodDate:fg,ZodSymbol:pg,ZodUndefined:mg,ZodNull:gg,ZodAny:yg,ZodUnknown:vg,ZodNever:_g,ZodVoid:wg,ZodArray:bg,ZodObject:Ig,ZodUnion:Tg,ZodDiscriminatedUnion:Sg,ZodIntersection:Og,ZodTuple:xg,ZodRecord:Cg,ZodMap:Pg,ZodSet:Ng,ZodFunction:Rg,ZodLazy:jg,ZodLiteral:Lg,ZodEnum:Mg,ZodNativeEnum:Ug,ZodPromise:$g,ZodEffects:Fg,ZodTransformer:Fg,ZodOptional:Bg,ZodNullable:Vg,ZodDefault:qg,ZodCatch:zg,ZodNaN:Hg,BRAND:Kg,ZodBranded:Wg,ZodPipeline:Gg,ZodReadonly:Zg,custom:Jg,Schema:Km,ZodSchema:Km,late:Qg,get ZodFirstPartyTypeKind(){return Xg},coerce:Ry,any:cy,array:dy,bigint:ny,boolean:ry,date:iy,discriminatedUnion:gy,effect:Oy,enum:ky,function:Ey,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>Jg((t=>t instanceof e),t),intersection:yy,lazy:Iy,literal:Ty,map:wy,nan:ty,nativeEnum:Sy,never:ly,null:oy,nullable:Cy,number:ey,object:fy,oboolean:()=>ry().optional(),onumber:()=>ey().optional(),optional:xy,ostring:()=>Yg().optional(),pipeline:Ny,preprocess:Py,promise:Ay,record:_y,set:by,strictObject:py,string:Yg,symbol:sy,transformer:Oy,tuple:vy,undefined:ay,union:my,unknown:uy,void:hy,NEVER:jy,ZodIssueCode:Im,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:Tm});const Dy={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let My;const Uy=new Uint8Array(16);function $y(){if(!My&&(My="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!My))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return My(Uy)}const Fy=[];for(let e=0;e<256;++e)Fy.push((e+256).toString(16).slice(1));const By=function(e,t,n){if(Dy.randomUUID&&!t&&!e)return Dy.randomUUID();const r=(e=e||{}).random||(e.rng||$y)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return function(e,t=0){return Fy[e[t+0]]+Fy[e[t+1]]+Fy[e[t+2]]+Fy[e[t+3]]+"-"+Fy[e[t+4]]+Fy[e[t+5]]+"-"+Fy[e[t+6]]+Fy[e[t+7]]+"-"+Fy[e[t+8]]+Fy[e[t+9]]+"-"+Fy[e[t+10]]+Fy[e[t+11]]+Fy[e[t+12]]+Fy[e[t+13]]+Fy[e[t+14]]+Fy[e[t+15]]}(r)};class Vy{}class qy extends Vy{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,vp(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"true"!==Hp("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.awaitHandlers=e._awaitHandler??this.awaitHandlers)}copy(){return new this.constructor(this)}toJSON(){return _p.prototype.toJSON.call(this)}toJSONNotImplemented(){return _p.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends qy{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:By()}),Object.assign(this,e)}}}}var zy=i(749);function Hy(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}class Ky extends qy{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){const t=function(e,t,n){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${r}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),n={...e};if(void 0!==n.parent_run_id){const e=this.runMap.get(n.parent_run_id);e&&(this._addChildRun(e,n),e.child_execution_order=Math.max(e.child_execution_order,n.child_execution_order),n.trace_id=e.trace_id,void 0!==e.dotted_order&&(n.dotted_order=[e.dotted_order,t].join(".")))}else n.trace_id=n.id,n.dotted_order=t;this.runMap.set(n.id,n),await(this.onRunCreate?.(n))}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,n,r,i,s,a,o){const c=this._getExecutionOrder(r),u=Date.now(),l=a?{...i,metadata:a}:i,h={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:l??{},tags:s||[]};return await this._startTrace(h),await(this.onLLMStart?.(h)),h}async handleChatModelStart(e,t,n,r,i,s,a,o){const c=this._getExecutionOrder(r),u=Date.now(),l=a?{...i,metadata:a}:i,h={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:l??{},tags:s||[]};return await this._startTrace(h),await(this.onLLMStart?.(h)),h}async handleLLMEnd(e,t){const n=this.runMap.get(t);if(!n||"llm"!==n?.run_type)throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.outputs=e,n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onLLMEnd?.(n)),await this._endTrace(n),n}async handleLLMError(e,t){const n=this.runMap.get(t);if(!n||"llm"!==n?.run_type)throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onLLMError?.(n)),await this._endTrace(n),n}async handleChainStart(e,t,n,r,i,s,a,o){const c=this._getExecutionOrder(r),u=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:a??"chain",child_runs:[],extra:s?{metadata:s}:{},tags:i||[]};return await this._startTrace(l),await(this.onChainStart?.(l)),l}async handleChainEnd(e,t,n,r,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=Hy(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),void 0!==i?.inputs&&(s.inputs=Hy(i.inputs,"input")),await(this.onChainEnd?.(s)),await this._endTrace(s),s}async handleChainError(e,t,n,r,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),void 0!==i?.inputs&&(s.inputs=Hy(i.inputs,"input")),await(this.onChainError?.(s)),await this._endTrace(s),s}async handleToolStart(e,t,n,r,i,s,a){const o=this._getExecutionOrder(r),c=Date.now(),u={id:n,name:a??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:s?{metadata:s}:{},tags:i||[]};return await this._startTrace(u),await(this.onToolStart?.(u)),u}async handleToolEnd(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onToolEnd?.(n)),await this._endTrace(n),n}async handleToolError(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onToolError?.(n)),await this._endTrace(n),n}async handleAgentAction(e,t){const n=this.runMap.get(t);if(!n||"chain"!==n?.run_type)return;const r=n;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(n))}async handleAgentEnd(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(n)))}async handleRetrieverStart(e,t,n,r,i,s,a){const o=this._getExecutionOrder(r),c=Date.now(),u={id:n,name:a??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:s?{metadata:s}:{},tags:i||[]};return await this._startTrace(u),await(this.onRetrieverStart?.(u)),u}async handleRetrieverEnd(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverEnd?.(n)),await this._endTrace(n),n}async handleRetrieverError(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverError?.(n)),await this._endTrace(n),n}async handleText(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(n)))}async handleLLMNewToken(e,t,n,r,i,s){const a=this.runMap.get(n);if(!a||"llm"!==a?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return a.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:s?.chunk}}),await(this.onLLMNewToken?.(a,e,{chunk:s?.chunk})),a}}function Wy(e,t){return`${e.open}${t}${e.close}`}function Gy(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function Zy(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:Jy}=zy;class Qy extends Ky{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let n=e;for(;n.parent_run_id;){const e=this.runMap.get(n.parent_run_id);if(!e)break;t.push(e),n=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,n)=>{const r=`${e.execution_order}:${e.run_type}:${e.name}`;return t===n.length-1?Wy(zy.bold,r):r})).join(" > ");return Wy(Jy.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Jy.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Gy(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Jy.cyan,"[chain/end]")} [${t}] [${Zy(e)}] Exiting Chain run with output: ${Gy(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Jy.red,"[chain/error]")} [${t}] [${Zy(e)}] Chain run errored with error: ${Gy(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${Wy(Jy.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Gy(n,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Jy.cyan,"[llm/end]")} [${t}] [${Zy(e)}] Exiting LLM run with output: ${Gy(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Jy.red,"[llm/error]")} [${t}] [${Zy(e)}] LLM run errored with error: ${Gy(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Jy.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Jy.cyan,"[tool/end]")} [${t}] [${Zy(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Jy.red,"[tool/error]")} [${t}] [${Zy(e)}] Tool run errored with error: ${Gy(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Jy.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Gy(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Jy.cyan,"[retriever/end]")} [${t}] [${Zy(e)}] Exiting Retriever run with output: ${Gy(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${Wy(Jy.red,"[retriever/error]")} [${t}] [${Zy(e)}] Retriever run errored with error: ${Gy(e.error,"[error]")}`)}onAgentAction(e){const t=e,n=this.getBreadcrumbs(e);console.log(`${Wy(Jy.blue,"[agent/action]")} [${n}] Agent selected action: ${Gy(t.actions[t.actions.length-1],"[action]")}`)}}const Xy=[400,401,403,404,405,406,407,408],Yy=[409];class ev{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.queue=new am.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const n=this.onFailedResponseHook;return this.queue.add((()=>sm((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response,r=t?.status;if(r){if(Xy.includes(+r))throw e;if(Yy.includes(+r))return;n&&await n(t)}},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}function tv(e){return"function"==typeof e?._getType}function nv(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}let rv;const iv=()=>"undefined"!=typeof Deno;let sv,av;function ov(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}const cv=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,uv=function(e){return"string"==typeof e&&cv.test(e)};function lv(e){if(!uv(e))throw new Error(`Invalid UUID: ${e}`)}async function hv(e){const t=await async function(){if(void 0===sv){const e=rv||(rv="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||iv()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":iv()?"deno":"other":"node",rv),t=function(){if(void 0!==av)return av;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const n of e){const e=ov(n);void 0!==e&&(t[n]=e)}return av=t,t}();sv={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:yv,...t}}return sv}(),n=function(){const e=function(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce(((e,[t,n])=>(e[t]=String(n),e)),{}):void 0}catch(e){return}}()||{},t={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[r,i]of Object.entries(e))!r.startsWith("LANGCHAIN_")||"string"!=typeof i||n.includes(r)||r.toLowerCase().includes("key")||r.toLowerCase().includes("secret")||r.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===r?t.revision_id=i:t[r]=i);return t}();return e.map((e=>{const r=e.extra??{},i=r.metadata;return e.extra={...r,runtime:{...t,...r?.runtime},metadata:{...n,...n.revision_id||e.revision_id?{revision_id:e.revision_id??n.revision_id}:{},...i}},e}))}const dv=async(e,t)=>{const n=await e.text();if(!e.ok)throw new Error(`Failed to ${t}: ${e.status} ${e.statusText} ${n}`)};function fv(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const pv=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise((e=>setTimeout(e,t))),!0}return!1};class mv{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise((t=>{this.items.push([e,t])}))}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");const t=[];for(;t.length<e&&this.items.length;){const e=this.items.shift();if(!e)break;t.push(e)}return[t.map((e=>e[0])),()=>t.forEach((e=>e[1]()))]}}class gv{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new mv}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=gv.getDefaultClientConfig();this.tracingSampleRate=(()=>{const e=ov("LANGCHAIN_TRACING_SAMPLING_RATE");if(void 0===e)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t})(),this.apiUrl=fv(e.apiUrl??t.apiUrl)??"",this.apiKey=fv(e.apiKey??t.apiKey),this.webUrl=fv(e.webUrl??t.webUrl),this.timeout_ms=e.timeout_ms??12e3,this.caller=new ev(e.callerOptions??{}),this.batchIngestCaller=new ev({...e.callerOptions??{},onFailedResponseHook:pv}),this.hideInputs=e.hideInputs??t.hideInputs,this.hideOutputs=e.hideOutputs??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){const e=ov("LANGCHAIN_API_KEY");return{apiUrl:ov("LANGCHAIN_ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===ov("LANGCHAIN_HIDE_INPUTS"),hideOutputs:"true"===ov("LANGCHAIN_HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(e=>{const t=this.apiUrl.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t})()?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${yv}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const n=t?.toString()??"",r=`${this.apiUrl}${e}?${n}`,i=await this.caller.call(fetch,r,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);return i}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let n=Number(t.get("offset"))||0;const r=Number(t.get("limit"))||100;for(;;){t.set("offset",String(n)),t.set("limit",String(r));const i=`${this.apiUrl}${e}?${t}`,s=await this.caller.call(fetch,i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);const a=await s.json();if(0===a.length)break;if(yield a,a.length<r)break;n+=a.length}}async*_getCursorPaginatedList(e,t=null,n="POST",r="runs"){const i=t?{...t}:{};for(;;){const t=await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(i)}),s=await t.json();if(!s)break;if(!s[r])break;yield s[r];const a=s.cursors;if(!a)break;if(!a.next)break;i.cursor=a.next}}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const n of e)this.sampledPostUuids.has(n.id)&&(t.push(n),this.sampledPostUuids.delete(n.id));return t}{const t=[];for(const n of e)Math.random()<this.tracingSampleRate&&(t.push(n),this.sampledPostUuids.add(n.id));return t}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){const[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length)return void t();try{await this.batchIngestRuns({runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))})}finally{t()}}}async processRunOperation(e,t){const n=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;const r=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)}),n?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),r}async _getServerInfo(){const e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch(e){return!1}return!0}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},n=e.project_name;delete e.project_name;const r=this.prepareRunCreateOrUpdateInputs({session_name:n,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void this.processRunOperation({action:"create",item:r}).catch(console.error);const i=await hv([r]),s=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(i[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await dv(s,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let n=e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[],r=t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[];if(n.length>0&&r.length>0){const e=n.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const n of r)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);n=Object.values(e),r=t}const i={post:this._filterForSampling(n),patch:this._filterForSampling(r,!0)};if(!i.post.length&&!i.patch.length)return;if(n=await hv(n),void 0===this.batchEndpointSupported&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(const e of i.post)await this.createRun(e);for(const e of i.patch)void 0!==e.id&&await this.updateRun(e.id,e);return}const s=this.serverInfo?.batch_ingest_config?.size_limit_bytes??20971520,a={post:[],patch:[]};let o=0;for(const e of["post","patch"]){const t=e,n=i[t].reverse();let r=n.pop();for(;void 0!==r;){const e=JSON.stringify(r);o>0&&o+e.length>s&&(await this._postBatchIngestRuns(JSON.stringify(a)),o=0,a.post=[],a.patch=[]),o+=e.length,a[t].push(r),r=n.pop()}}(a.post.length>0||a.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(a))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},n=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await dv(n,"batch create run")}async updateRun(e,t){lv(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const n={...t,id:e};if(!this._filterForSampling([n],!0).length)return;if(this.autoBatchTracing&&void 0!==n.trace_id&&void 0!==n.dotted_order)return void 0!==t.end_time&&void 0===n.parent_run_id?void await this.processRunOperation({action:"update",item:n},!0):void this.processRunOperation({action:"update",item:n}).catch(console.error);const r={...this.headers,"Content-Type":"application/json"},i=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:r,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await dv(i,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){lv(e);let n=await this._get(`/runs/${e}`);return t&&n.child_run_ids&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(void 0!==t){let e;e=t.session_id?t.session_id:n?.projectName?(await this.readProject({projectName:n?.projectName})).id:n?.projectId?n?.projectId:(await this.readProject({projectName:ov("LANGCHAIN_PROJECT")||"default"})).id;const r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const n of e)t.push(n);return t}(this.listRuns({id:e.child_run_ids})),n={},r={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in n||(n[e.parent_run_id]=[]),n[e.parent_run_id].push(e),r[e.id]=e}e.child_runs=n[e.id]||[];for(const t in n)t!==e.id&&(r[t].child_runs=n[t]);return e}async*listRuns(e){const{projectId:t,projectName:n,parentRunId:r,traceId:i,referenceExampleId:s,startTime:a,executionOrder:o,isRoot:c,runType:u,error:l,id:h,query:d,filter:f,traceFilter:p,treeFilter:m,limit:g,select:y}=e;let v=[];if(t&&(v=Array.isArray(t)?t:[t]),n){const e=Array.isArray(n)?n:[n],t=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));v.push(...t)}const _={session:v.length?v:null,run_type:u,reference_example:s,query:d,filter:f,trace_filter:p,tree_filter:m,execution_order:o,parent_run:r,start_time:a?a.toISOString():null,error:l,id:h,limit:g,trace:i,select:y||["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:c};let w=0;for await(const e of this._getCursorPaginatedList("/runs/query",_))if(g){if(w>=g)break;if(e.length+w>g){const t=e.slice(0,g-w);yield*t;break}w+=e.length,yield*e}else yield*e}async shareRun(e,{shareId:t}={}){const n={run_id:e,share_token:t||By()};lv(e);const r=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await r.json();if(null===i||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){lv(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await dv(t,"unshare run")}async readRunSharedLink(e){lv(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await t.json();if(null!==n&&"share_token"in n)return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const n=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)n.append("id",e);lv(e);const r=await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await r.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),lv(e);const n=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await n.json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const n={dataset_id:e};lv(e);const r=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await r.json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async unshareDataset(e){lv(e);const t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await dv(t,"unshare dataset")}async readSharedDataset(e){lv(e);const t=await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:r=!1,projectExtra:i=null,referenceDatasetId:s=null}){const a=r?"?upsert=true":"",o=`${this.apiUrl}/sessions${a}`,c=i||{};n&&(c.metadata=n);const u={name:e,extra:c,description:t};null!==s&&(u.reference_dataset_id=s);const l=await this.caller.call(fetch,o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),h=await l.json();if(!l.ok)throw new Error(`Failed to create session ${e}: ${l.status} ${l.statusText}`);return h}async updateProject(e,{name:t=null,description:n=null,metadata:r=null,projectExtra:i=null,endTime:s=null}){const a=`${this.apiUrl}/sessions/${e}`;let o=i;r&&(o={...o||{},metadata:r});const c={name:t,extra:o,description:n,end_time:s?new Date(s).toISOString():null},u=await this.caller.call(fetch,a,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),l=await u.json();if(!u.ok)throw new Error(`Failed to update project ${e}: ${u.status} ${u.statusText}`);return l}async hasProject({projectId:e,projectName:t}){let n="/sessions";const r=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)lv(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");r.append("name",t)}const i=await this.caller.call(fetch,`${this.apiUrl}${n}?${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const e=await i.json();return!!i.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let r="/sessions";const i=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)lv(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");i.append("name",t)}void 0!==n&&i.append("include_stats",n.toString());const s=await this._get(r,i);let a;if(Array.isArray(s)){if(0===s.length)throw new Error(`Project[id=${e}, name=${t}] not found`);a=s[0]}else a=s;return a}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/datasets/${n.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:r,referenceDatasetName:i,referenceFree:s}={}){const a=new URLSearchParams;if(void 0!==e)for(const t of e)a.append("id",t);if(void 0!==t&&a.append("name",t),void 0!==n&&a.append("name_contains",n),void 0!==r)a.append("reference_dataset",r);else if(void 0!==i){const e=await this.readDataset({datasetName:i});a.append("reference_dataset",e.id)}void 0!==s&&a.append("reference_free",s.toString());for await(const e of this._getPaginated("/sessions",a))yield*e}async deleteProject({projectId:e,projectName:t}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");n=void 0===e?(await this.readProject({projectName:t})).id:e,lv(n);const r=await this.caller.call(fetch,`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await dv(r,`delete session ${n} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:r,description:i,dataType:s,name:a}){const o=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),n.forEach((e=>{c.append("input_keys",e)})),r.forEach((e=>{c.append("output_keys",e)})),i&&c.append("description",i),s&&c.append("data_type",s),a&&c.append("name",a);const u=await this.caller.call(fetch,o,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!u.ok){const e=await u.json();if(e.detail&&e.detail.includes("already exists"))throw new Error(`Dataset ${t} already exists`);throw new Error(`Failed to upload CSV: ${u.status} ${u.statusText}`)}return await u.json()}async createDataset(e,{description:t,dataType:n}={}){const r={name:e,description:t};n&&(r.data_type=n);const i=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok){const t=await i.json();if(t.detail&&t.detail.includes("already exists"))throw new Error(`Dataset ${e} already exists`);throw new Error(`Failed to create dataset ${i.status} ${i.statusText}`)}return await i.json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets";const r=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)lv(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");r.append("name",t)}const i=await this._get(n,r);let s;if(Array.isArray(i)){if(0===i.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);s=i[0]}else s=i;return s}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:r}){let i=e;if(void 0===i&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==i&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");void 0===i&&(i=(await this.readDataset({datasetName:t})).id);const s=new URLSearchParams({from_version:"string"==typeof n?n:n.toISOString(),to_version:"string"==typeof r?r:r.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,s)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const n=await this._getResponse(`/datasets/${e}/openai_ft`);return(await n.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:r,datasetNameContains:i}={}){const s=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==n)for(const e of n)s.append("id",e);void 0!==r&&s.append("name",r),void 0!==i&&s.append("name_contains",i);for await(const e of this._getPaginated("/datasets",s))yield*e}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",r=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(r=(await this.readDataset({datasetName:t})).id),void 0===r)throw new Error("Must provide datasetName or datasetId");lv(r),n+=`/${r}`;const i=await this.caller.call(fetch,this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to delete ${n}: ${i.status} ${i.statusText}`);await i.json()}async createExample(e,t,{datasetId:n,datasetName:r,createdAt:i,exampleId:s,metadata:a,split:o}){let c=n;if(void 0===c&&void 0===r)throw new Error("Must provide either datasetName or datasetId");if(void 0!==c&&void 0!==r)throw new Error("Must provide either datasetName or datasetId, not both");void 0===c&&(c=(await this.readDataset({datasetName:r})).id);const u=i||new Date,l={dataset_id:c,inputs:e,outputs:t,created_at:u?.toISOString(),id:s,metadata:a,split:o},h=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!h.ok)throw new Error(`Failed to create example: ${h.status} ${h.statusText}`);return await h.json()}async createExamples(e){const{inputs:t,outputs:n,metadata:r,sourceRunIds:i,exampleIds:s,datasetId:a,datasetName:o}=e;let c=a;if(void 0===c&&void 0===o)throw new Error("Must provide either datasetName or datasetId");if(void 0!==c&&void 0!==o)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===c){const e=await this.readDataset({datasetName:o});c=e.id}const u=t.map(((t,a)=>({dataset_id:c,inputs:t,outputs:n?n[a]:void 0,metadata:r?r[a]:void 0,split:e.splits?e.splits[a]:void 0,id:s?s[a]:void 0,source_run_id:i?i[a]:void 0}))),l=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!l.ok)throw new Error(`Failed to create examples: ${l.status} ${l.statusText}`);return await l.json()}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){const r=e.map((e=>tv(e)?nv(e):e)),i=tv(t)?nv(t):t;return this.createExample({input:r},{output:i},n)}async readExample(e){lv(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:r,splits:i,inlineS3Urls:s,metadata:a}={}){let o;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)o=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");o=(await this.readDataset({datasetName:t})).id}const c=new URLSearchParams({dataset:o}),u=r?"string"==typeof r?r:r?.toISOString():void 0;u&&c.append("as_of",u);const l=s??!0;if(c.append("inline_s3_urls",l.toString()),void 0!==n)for(const e of n)c.append("id",e);if(void 0!==i)for(const e of i)c.append("splits",e);if(void 0!==a){const e=JSON.stringify(a);c.append("metadata",e)}for await(const e of this._getPaginated("/examples",c))yield*e}async deleteExample(e){lv(e);const t=`/examples/${e}`,n=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to delete ${t}: ${n.status} ${n.statusText}`);await n.json()}async updateExample(e,t){lv(e);const n=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to update example ${e}: ${n.status} ${n.statusText}`);return await n.json()}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:r,referenceExample:i}={loadChildRuns:!1}){let s;if("string"==typeof e)s=await this.readRun(e,{loadChildRuns:r});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);s=e}null!==s.reference_example_id&&void 0!==s.reference_example_id&&(i=await this.readExample(s.reference_example_id));const a=await t.evaluateRun(s,i);let o=n??{};a.evaluatorInfo&&(o={...o,...a.evaluatorInfo});const c=a.targetRunId??s.id;return await this.createFeedback(c,a.key,{score:a?.score,value:a?.value,comment:a?.comment,correction:a?.correction,sourceInfo:o,feedbackSourceType:"model",sourceRunId:a?.sourceRunId})}async createFeedback(e,t,{score:n,value:r,correction:i,comment:s,sourceInfo:a,feedbackSourceType:o="api",sourceRunId:c,feedbackId:u,feedbackConfig:l,projectId:h,comparativeExperimentId:d}){if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const f={type:o??"api",metadata:a??{}};void 0===c||void 0===f?.metadata||f.metadata.__run||(f.metadata.__run={run_id:c}),void 0!==f?.metadata&&void 0!==f.metadata.__run?.run_id&&lv(f.metadata.__run.run_id);const p={id:u??By(),run_id:e,key:t,score:n,value:r,correction:i,comment:s,feedback_source:f,comparative_experiment_id:d,feedbackConfig:l,session_id:h},m=`${this.apiUrl}/feedback`,g=await this.caller.call(fetch,m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(p),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await dv(g,"create feedback"),p}async updateFeedback(e,{score:t,value:n,correction:r,comment:i}){const s={};null!=t&&(s.score=t),null!=n&&(s.value=n),null!=r&&(s.correction=r),null!=i&&(s.comment=i),lv(e);const a=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await dv(a,"update feedback")}async readFeedback(e){lv(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){lv(e);const t=`/feedback/${e}`,n=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!n.ok)throw new Error(`Failed to delete ${t}: ${n.status} ${n.statusText}`);await n.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){const r=new URLSearchParams;if(e&&r.append("run",e.join(",")),t)for(const e of t)r.append("key",e);if(n)for(const e of n)r.append("source",e);for await(const e of this._getPaginated("/feedback",r))yield*e}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:r}={}){const i={run_id:e,feedback_key:t,feedback_config:r};n?"string"==typeof n?i.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(i.expires_in=n):i.expires_in={hours:3};const s=await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await s.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:r,description:i,metadata:s,id:a}){if(0===t.length)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!n)throw new Error("A reference dataset is required");const o={id:a,name:e,experiment_ids:t,reference_dataset_id:n,description:i,created_at:(r??new Date)?.toISOString(),extra:{}};s&&(o.extra.metadata=s);const c=await this.caller.call(fetch,`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await c.json()}async*listPresignedFeedbackTokens(e){lv(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:[e],t}async logEvaluationFeedback(e,t,n){const r=this._selectEvalResults(e);for(const e of r){let r=n||{};e.evaluatorInfo&&(r={...e.evaluatorInfo,...r});let i=null;e.targetRunId?i=e.targetRunId:t&&(i=t.id),await this.createFeedback(i,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:r,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"})}return r}}const yv="0.1.30";class vv extends Ky{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:n,client:r}=e;this.projectName=n??Hp("LANGCHAIN_PROJECT")??Hp("LANGCHAIN_SESSION"),this.exampleId=t,this.client=r??new gv({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await zp()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}}let _v;async function wv(e,t){!0===t?await e():(void 0===_v&&(_v=new(0,am.default)({autoStart:!0,concurrency:1})),_v.add(e))}"true"===Hp("LANGCHAIN_TRACING_V2")&&"true"!==Hp("LANGCHAIN_CALLBACKS_BACKGROUND")&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join("\n");class bv{setHandler(e){return this.setHandlers([e])}}class Ev{constructor(e,t,n,r,i,s,a,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}async handleText(e){await Promise.all(this.handlers.map((t=>wv((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleText: ${e}`)}}),t.awaitHandlers))))}}class Iv extends Ev{getChild(e){const t=new Av(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>wv((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>wv((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${e}`)}}),t.awaitHandlers))))}}class Tv extends Ev{async handleLLMNewToken(e,t,n,r,i,s){await Promise.all(this.handlers.map((n=>wv((async()=>{if(!n.ignoreLLM)try{await(n.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,s))}catch(e){console.error(`Error in handler ${n.constructor.name}, handleLLMNewToken: ${e}`)}}),n.awaitHandlers))))}async handleLLMError(e){await Promise.all(this.handlers.map((t=>wv((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`)}}),t.awaitHandlers))))}async handleLLMEnd(e){await Promise.all(this.handlers.map((t=>wv((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`)}}),t.awaitHandlers))))}}class kv extends Ev{getChild(e){const t=new Av(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,r,i){await Promise.all(this.handlers.map((t=>wv((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,i))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${e}`)}}),t.awaitHandlers))))}async handleChainEnd(e,t,n,r,i){await Promise.all(this.handlers.map((t=>wv((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,i))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`)}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>wv((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`)}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>wv((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`)}}),t.awaitHandlers))))}}class Sv extends Ev{getChild(e){const t=new Av(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>wv((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${e}`)}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>wv((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`)}}),t.awaitHandlers))))}}class Av extends bv{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,n=void 0,r=void 0,i=void 0,s=void 0,a=void 0,o=void 0){return Promise.all(t.map((async(t,r)=>{const s=0===r&&n?n:By();return await Promise.all(this.handlers.map((n=>wv((async()=>{if(!n.ignoreLLM)try{await(n.handleLLMStart?.(e,[t],s,this._parentRunId,i,this.tags,this.metadata,o))}catch(e){console.error(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`)}}),n.awaitHandlers)))),new Tv(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,t,n=void 0,r=void 0,i=void 0,s=void 0,a=void 0,o=void 0){return Promise.all(t.map((async(t,r)=>{const s=0===r&&n?n:By();return await Promise.all(this.handlers.map((n=>wv((async()=>{if(!n.ignoreLLM)try{if(n.handleChatModelStart)await(n.handleChatModelStart?.(e,[t],s,this._parentRunId,i,this.tags,this.metadata,o));else if(n.handleLLMStart){const r=Mp(t);await(n.handleLLMStart?.(e,[r],s,this._parentRunId,i,this.tags,this.metadata,o))}}catch(e){console.error(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`)}}),n.awaitHandlers)))),new Tv(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,t,n=By(),r=void 0,i=void 0,s=void 0,a=void 0){return await Promise.all(this.handlers.map((i=>wv((async()=>{if(!i.ignoreChain)try{await(i.handleChainStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,r,a))}catch(e){console.error(`Error in handler ${i.constructor.name}, handleChainStart: ${e}`)}}),i.awaitHandlers)))),new kv(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,n=By(),r=void 0,i=void 0,s=void 0,a=void 0){return await Promise.all(this.handlers.map((r=>wv((async()=>{if(!r.ignoreAgent)try{await(r.handleToolStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,a))}catch(e){console.error(`Error in handler ${r.constructor.name}, handleToolStart: ${e}`)}}),r.awaitHandlers)))),new Sv(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,n=By(),r=void 0,i=void 0,s=void 0,a=void 0){return await Promise.all(this.handlers.map((r=>wv((async()=>{if(!r.ignoreRetriever)try{await(r.handleRetrieverStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,a))}catch(e){console.error(`Error in handler ${r.constructor.name}, handleRetrieverStart: ${e}`)}}),r.awaitHandlers)))),new Iv(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const n=new Av(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);n.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);n.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);n.addMetadata({[e]:this.metadata[e]},t)}for(const r of e)n.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===r.name))||n.addHandler(r,t);return n}static fromHandlers(e){const t=new this;return t.addHandler(new class extends qy{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:By()}),Object.assign(this,e)}}),t}static async configure(e,t,n,r,i,s,a){let o;(e||t)&&(Array.isArray(e)||!e?(o=new Av,o.setHandlers(e?.map(Ov)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(Ov):t?.handlers,!1));const c="true"===Hp("LANGCHAIN_VERBOSE")||a?.verbose,u="true"===Hp("LANGCHAIN_TRACING_V2"),l=u||(Hp("LANGCHAIN_TRACING")??!1);if(c||l){if(o||(o=new Av),c&&!o.handlers.some((e=>e.name===Qy.prototype.name))){const e=new Qy;o.addHandler(e,!0)}l&&!o.handlers.some((e=>"langchain_tracer"===e.name))&&u&&o.addHandler(await async function(){return new vv}(),!0)}return(n||r)&&o&&(o.addTags(n??[]),o.addTags(r??[],!1)),(i||s)&&o&&(o.addMetadata(i??{}),o.addMetadata(s??{},!1)),o}}function Ov(e){return"name"in e?e:qy.fromMethods(e)}const xv=Object.prototype.hasOwnProperty;function Cv(e,t){return xv.call(e,t)}function Pv(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let n in e)Cv(e,n)&&t.push(n);return t}function Nv(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function Rv(e){let t=0;const n=e.length;let r;for(;t<n;){if(r=e.charCodeAt(t),!(r>=48&&r<=57))return!1;t++}return!0}function jv(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function Lv(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Dv(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(Dv(e[t]))return!0}else if("object"==typeof e){const n=Pv(e),r=n.length;for(var t=0;t<r;t++)if(Dv(e[n[t]]))return!0}return!1}function Mv(e,t){const n=[e];for(const e in t){const r="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==r&&n.push(`${e}: ${r}`)}return n.join("\n")}class Uv extends Error{constructor(e,t,n,r,i){super(Mv(e,{name:t,index:n,operation:r,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=Mv(e,{name:t,index:n,operation:r,tree:i})}}const $v=Uv,Fv=Nv,Bv={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){let r=qv(n,this.path);r&&(r=Nv(r));const i=zv(n,{op:"remove",path:this.from}).removed;return zv(n,{op:"add",path:this.path,value:i}),{newDocument:n,removed:r}},copy:function(e,t,n){const r=qv(n,this.from);return zv(n,{op:"add",path:this.path,value:Nv(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:Zv(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}};var Vv={add:function(e,t,n){return Rv(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){return{newDocument:n,removed:e.splice(t,1)[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:Bv.move,copy:Bv.copy,test:Bv.test,_get:Bv._get};function qv(e,t){if(""==t)return e;var n={op:"_get",path:t};return zv(e,n),n.value}function zv(e,t,n=!1,r=!0,i=!0,s=0){if(n&&("function"==typeof n?n(t,0,e,t.path):Wv(t,0)),""===t.path){let r={newDocument:e};if("add"===t.op)return r.newDocument=t.value,r;if("replace"===t.op)return r.newDocument=t.value,r.removed=e,r;if("move"===t.op||"copy"===t.op)return r.newDocument=qv(e,t.from),"move"===t.op&&(r.removed=e),r;if("test"===t.op){if(r.test=Zv(e,t.value),!1===r.test)throw new $v("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return r.newDocument=e,r}if("remove"===t.op)return r.removed=e,r.newDocument=null,r;if("_get"===t.op)return t.value=e,r;if(n)throw new $v("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,t,e);return r}{r||(e=Nv(e));const a=(t.path||"").split("/");let o,c,u,l=e,h=1,d=a.length;for(u="function"==typeof n?n:Wv;;){if(c=a[h],c&&-1!=c.indexOf("~")&&(c=Lv(c)),i&&("__proto__"==c||"prototype"==c&&h>0&&"constructor"==a[h-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&void 0===o&&(void 0===l[c]?o=a.slice(0,h).join("/"):h==d-1&&(o=t.path),void 0!==o&&u(t,0,e,o)),h++,Array.isArray(l)){if("-"===c)c=l.length;else{if(n&&!Rv(c))throw new $v("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,t,e);Rv(c)&&(c=~~c)}if(h>=d){if(n&&"add"===t.op&&c>l.length)throw new $v("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,t,e);const r=Vv[t.op].call(t,l,c,e);if(!1===r.test)throw new $v("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return r}}else if(h>=d){const n=Bv[t.op].call(t,l,c,e);if(!1===n.test)throw new $v("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return n}if(l=l[c],n&&h<d&&(!l||"object"!=typeof l))throw new $v("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,t,e)}}}function Hv(e,t,n,r=!0,i=!0){if(n&&!Array.isArray(t))throw new $v("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=Nv(e));const s=new Array(t.length);for(let r=0,a=t.length;r<a;r++)s[r]=zv(e,t[r],n,!0,i,r),e=s[r].newDocument;return s.newDocument=e,s}function Kv(e,t,n){const r=zv(e,t);if(!1===r.test)throw new $v("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return r.newDocument}function Wv(e,t,n,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new $v("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(!Bv[e.op])throw new $v("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n);if("string"!=typeof e.path)throw new $v("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new $v('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new $v("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new $v("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&Dv(e.value))throw new $v("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n)if("add"==e.op){var i=e.path.split("/").length,s=r.split("/").length;if(i!==s+1&&i!==s)throw new $v("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new $v("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if("move"===e.op||"copy"===e.op){var a=Gv([{op:"_get",path:e.from,value:void 0}],n);if(a&&"OPERATION_PATH_UNRESOLVABLE"===a.name)throw new $v("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}function Gv(e,t,n){try{if(!Array.isArray(e))throw new $v("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)Hv(Nv(t),Nv(e),n||!0);else{n=n||Wv;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(e){if(e instanceof $v)return e;throw e}}function Zv(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var n,r,i,s=Array.isArray(e),a=Array.isArray(t);if(s&&a){if((r=e.length)!=t.length)return!1;for(n=r;0!=n--;)if(!Zv(e[n],t[n]))return!1;return!0}if(s!=a)return!1;var o=Object.keys(e);if((r=o.length)!==Object.keys(t).length)return!1;for(n=r;0!=n--;)if(!t.hasOwnProperty(o[n]))return!1;for(n=r;0!=n--;)if(!Zv(e[i=o[n]],t[i]))return!1;return!0}return e!=e&&t!=t}function Jv(e,t,n,r,i){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var s=Pv(t),a=Pv(e),o=!1,c=a.length-1;c>=0;c--){var u=e[h=a[c]];if(!Cv(t,h)||void 0===t[h]&&void 0!==u&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(i&&n.push({op:"test",path:r+"/"+jv(h),value:Nv(u)}),n.push({op:"remove",path:r+"/"+jv(h)}),o=!0):(i&&n.push({op:"test",path:r,value:e}),n.push({op:"replace",path:r,value:t}));else{var l=t[h];"object"==typeof u&&null!=u&&"object"==typeof l&&null!=l&&Array.isArray(u)===Array.isArray(l)?Jv(u,l,n,r+"/"+jv(h),i):u!==l&&(i&&n.push({op:"test",path:r+"/"+jv(h),value:Nv(u)}),n.push({op:"replace",path:r+"/"+jv(h),value:Nv(l)}))}}if(o||s.length!=a.length)for(c=0;c<s.length;c++){var h;Cv(e,h=s[c])||void 0===t[h]||n.push({op:"add",path:r+"/"+jv(h),value:Nv(t[h])})}}}function Qv(e,t,n=!1){var r=[];return Jv(e,t,r,"",n),r}new WeakMap;class Xv extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new Xv({start:e=>function n(){return t.read().then((({done:t,value:r})=>{if(!t)return e.enqueue(r),n();e.close()}))}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new Xv({async pull(t){const{value:n,done:r}=await e.next();r&&t.close(),t.enqueue(n)},async cancel(t){await e.return(t)}})}}function Yv(e,t=2){const n=Array.from({length:t},(()=>[]));return n.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of n)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function e_(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const n={...e};for(const[e,r]of Object.entries(t))e in n&&!Array.isArray(n[e])?n[e]=e_(n[e],r):n[e]=r;return n}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class t_{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise(((n,r)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(n,r):this.firstResult.then((e=>n(void 0)),r)}))}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}class n_{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),n=Hv({},t);return new r_({ops:t,state:n[n.length-1].newDocument})}}class r_ extends n_{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),n=Hv(this.state,e.ops);return new r_({ops:t,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){const t=Hv({},e.ops);return new r_({ops:e.ops,state:t[t.length-1].newDocument})}}async function i_(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=e;return["retriever","llm","prompt"].includes(e.run_type)?n:1!==Object.keys(n).length||""!==n?.input?n.input:void 0}async function s_(e,t){const{outputs:n}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?n:void 0!==n&&1===Object.keys(n).length&&void 0!==n?.output?n.output:n}class a_ extends Ky{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Xv.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(n=n||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(n=n&&t.every((e=>!this.excludeTags?.includes(e)))),n}async*tapOutputIterable(e,t){for await(const n of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new n_({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new n_({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(n.inputs=await i_(e,this._schemaFormat)),await this.writer.write(new n_({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const n=[];"streaming_events"===this._schemaFormat&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await i_(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await s_(e,this._schemaFormat)}),void 0!==e.end_time&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const r=new n_({ops:n});await this.writer.write(r)}finally{if(e.id===this.rootId){const t=new n_({ops:[{op:"replace",path:"/final_output",value:await s_(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){const r=this.keyMapByRunId[e.id];if(void 0===r)return;let i;var s;void 0!==e.inputs.messages?(s=n?.chunk,i=void 0!==s&&void 0!==s.message?n?.chunk:new Op(t)):i=t;const a=new n_({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${r}/streamed_output/-`,value:i}]});await this.writer.write(a)}}class o_{getStore(){}run(e,t){return t()}}const c_=new class{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new o_}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}};async function u_(e){return Av.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function l_(...e){const t={};for(const n of e.filter((e=>!!e)))for(const e of Object.keys(n))if("metadata"===e)t[e]={...t[e],...n[e]};else if("tags"===e){const r=t[e]??[];t[e]=[...new Set(r.concat(n[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...n[e]};else if("callbacks"===e){const e=t.callbacks,r=n.callbacks;if(Array.isArray(r))if(e)if(Array.isArray(e))t.callbacks=e.concat(r);else{const n=e.copy();for(const e of r)n.addHandler(Ov(e),!0);t.callbacks=n}else t.callbacks=r;else if(r)if(e)if(Array.isArray(e)){const n=r.copy();for(const t of e)n.addHandler(Ov(t),!0);t.callbacks=n}else t.callbacks=new Av(r._parentRunId,{handlers:e.handlers.concat(r.handlers),inheritableHandlers:e.inheritableHandlers.concat(r.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(r.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(r.inheritableTags))),metadata:{...e.metadata,...r.metadata}});else t.callbacks=r}else{const r=e;t[r]=n[r]??t[r]}return t}const h_=new Set(["string","number","boolean"]);function d_(e){const t=e??c_.getInstance().getStore();let n={tags:[],metadata:{},callbacks:void 0,recursionLimit:25,runId:void 0};if(t&&(n={...n,...t}),t?.configurable)for(const e of Object.keys(t.configurable))h_.has(typeof t.configurable[e])&&!n.metadata?.[e]&&(n.metadata||(n.metadata={}),n.metadata[e]=t.configurable[e]);return n}function f_(e={},{callbacks:t,maxConcurrency:n,recursionLimit:r,runName:i,configurable:s,runId:a}={}){const o=d_(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==r&&(o.recursionLimit=r),void 0!==n&&(o.maxConcurrency=n),void 0!==i&&(o.runName=i),void 0!==s&&(o.configurable={...o.configurable,...s}),void 0!==a&&delete o.runId,o}class p_ extends Ky{constructor({config:e,onStart:t,onEnd:n,onError:r}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(1===this.argOnStart.length?await this.argOnStart(e):2===this.argOnStart.length&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(1===this.argOnError.length?await this.argOnError(e):2===this.argOnError.length&&await this.argOnError(e,this.config)):this.argOnEnd&&(1===this.argOnEnd.length?await this.argOnEnd(e):2===this.argOnEnd.length&&await this.argOnEnd(e,this.config)))}}function m_(e){return!!e&&e.lc_runnable}class g_{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let n=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const r=e.tags??[];return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(t)),void 0!==this.includeTags&&(n=n||r.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(n=n&&r.every((e=>!this.excludeTags?.includes(e)))),n}}const y_=Symbol("Let zodToJsonSchema decide on which parser to use"),v_={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",emailStrategy:"format:email",base64Strategy:"contentEncoding:base64"};function __(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function w_(e,t,n,r,i){e[t]=n,__(e,t,r,i)}function b_(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(((n,r)=>b_(e,t,n)))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return E_(e,t)}}const E_=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":w_(n,"minimum",r.value,r.message,t);break;case"max":w_(n,"maximum",r.value,r.message,t)}return n},I_={cuid:"^[cC][^\\s-]{8,}$",cuid2:"^[a-z][a-z0-9]*$",ulid:"^[0-9A-HJKMNP-TV-Z]{26}$",email:"^(?!\\.)(?!.*\\.\\.)([a-zA-Z0-9_+-\\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\\-]*\\.)+[a-zA-Z]{2,}$",emoji:"^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",uuid:"^[0-9a-fA-F]{8}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{12}$",ipv4:"^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$",ipv6:"^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$",base64:"^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$",nanoid:"^[a-zA-Z0-9_-]{21}$"};function T_(e,t){const n={type:"string"};function r(e){return"escape"===t.patternStrategy?k_(e):e}if(e.checks)for(const i of e.checks)switch(i.kind){case"min":w_(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,i.value):i.value,i.message,t);break;case"max":w_(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,i.value):i.value,i.message,t);break;case"email":switch(t.emailStrategy){case"format:email":S_(n,"email",i.message,t);break;case"format:idn-email":S_(n,"idn-email",i.message,t);break;case"pattern:zod":A_(n,I_.email,i.message,t)}break;case"url":S_(n,"uri",i.message,t);break;case"uuid":S_(n,"uuid",i.message,t);break;case"regex":A_(n,i.regex.source,i.message,t);break;case"cuid":A_(n,I_.cuid,i.message,t);break;case"cuid2":A_(n,I_.cuid2,i.message,t);break;case"startsWith":A_(n,"^"+r(i.value),i.message,t);break;case"endsWith":A_(n,r(i.value)+"$",i.message,t);break;case"datetime":S_(n,"date-time",i.message,t);break;case"date":S_(n,"date",i.message,t);break;case"time":S_(n,"time",i.message,t);break;case"duration":S_(n,"duration",i.message,t);break;case"length":w_(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,i.value):i.value,i.message,t),w_(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,i.value):i.value,i.message,t);break;case"includes":A_(n,r(i.value),i.message,t);break;case"ip":"v6"!==i.version&&S_(n,"ipv4",i.message,t),"v4"!==i.version&&S_(n,"ipv6",i.message,t);break;case"emoji":A_(n,I_.emoji,i.message,t);break;case"ulid":A_(n,I_.ulid,i.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":S_(n,"binary",i.message,t);break;case"contentEncoding:base64":w_(n,"contentEncoding","base64",i.message,t);break;case"pattern:zod":A_(n,I_.base64,i.message,t)}break;case"nanoid":A_(n,I_.nanoid,i.message,t)}return n}const k_=e=>Array.from(e).map((e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`)).join(""),S_=(e,t,n,r)=>{e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):w_(e,"format",t,n,r)},A_=(e,t,n,r)=>{e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:t,...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):w_(e,"pattern",t,n,r)};function O_(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===Xg.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((n,r)=>({...n,[r]:N_(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}})),{}),additionalProperties:!1};const n={type:"object",additionalProperties:N_(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===Xg.ZodString&&e.keyType._def.checks?.length){const r=Object.entries(T_(e.keyType._def,t)).reduce(((e,[t,n])=>"type"===t?e:{...e,[t]:n}),{});return{...n,propertyNames:r}}return e.keyType?._def.typeName===Xg.ZodEnum?{...n,propertyNames:{enum:e.keyType._def.values}}:n}const x_={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},C_=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,n)=>N_(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return n.length?{anyOf:n}:void 0};function P_(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:N_(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:N_(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function N_(e,t,n=!1){const r=t.seen.get(e);if(t.override){const i=t.override?.(e,t,r,n);if(i!==y_)return i}if(r&&!n){const e=R_(r,t);if(void 0!==e)return e}const i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);const s=L_(e,e.typeName,t);return s&&D_(e,t,s),i.jsonSchema=s,s}const R_=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:j_(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,n)=>t.currentPath[n]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},j_=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},L_=(e,t,n)=>{switch(t){case Xg.ZodString:return T_(e,n);case Xg.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",__(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?w_(n,"minimum",r.value,r.message,t):w_(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),w_(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?w_(n,"maximum",r.value,r.message,t):w_(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),w_(n,"maximum",r.value,r.message,t));break;case"multipleOf":w_(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case Xg.ZodObject:return function(e,t){const n={type:"object",...Object.entries(e.shape()).reduce(((e,[n,r])=>{if(void 0===r||void 0===r._def)return e;const i=N_(r._def,{...t,currentPath:[...t.currentPath,"properties",n],propertyPath:[...t.currentPath,"properties",n]});return void 0===i?e:{properties:{...e.properties,[n]:i},required:r.isOptional()?e.required:[...e.required,n]}}),{properties:{},required:[]}),additionalProperties:P_(e,t)};return n.required.length||delete n.required,n}(e,n);case Xg.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?w_(n,"minimum",r.value,r.message,t):w_(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),w_(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?w_(n,"maximum",r.value,r.message,t):w_(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),w_(n,"maximum",r.value,r.message,t));break;case"multipleOf":w_(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case Xg.ZodBoolean:return{type:"boolean"};case Xg.ZodDate:return b_(e,n);case Xg.ZodUndefined:return{not:{}};case Xg.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case Xg.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def?.typeName!==Xg.ZodAny&&(n.items=N_(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&w_(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&w_(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(w_(n,"minItems",e.exactLength.value,e.exactLength.message,t),w_(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case Xg.ZodUnion:case Xg.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return C_(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every((e=>e._def.typeName in x_&&(!e._def.checks||!e._def.checks.length)))){const e=n.reduce(((e,t)=>{const n=x_[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e}),[]);return{type:e.length>1?e:e[0]}}if(n.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=n.reduce(((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===n.length){const t=e.filter(((e,t,n)=>n.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:n.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(n.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:n.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return C_(e,t)}(e,n);case Xg.ZodIntersection:return function(e,t){const n=[N_(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),N_(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const i=[];return n.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;i.push(t)}else i.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t})),i.length?{allOf:i,...r}:void 0}(e,n);case Xg.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,n)=>N_(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:N_(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,n)=>N_(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,n);case Xg.ZodRecord:return O_(e,n);case Xg.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case Xg.ZodEnum:return function(e){return{type:"string",enum:e.values}}(e);case Xg.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])).map((e=>t[e])),r=Array.from(new Set(n.map((e=>typeof e))));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case Xg.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:x_[e.innerType._def.typeName],nullable:!0}:{type:[x_[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=N_(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=N_(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case Xg.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return N_(e.innerType._def,t);const n=N_(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case Xg.ZodMap:return function(e,t){return"record"===t.mapStrategy?O_(e,t):{type:"array",maxItems:125,items:{type:"array",items:[N_(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},N_(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case Xg.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:N_(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&w_(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&w_(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case Xg.ZodLazy:return N_(e.getter()._def,n);case Xg.ZodPromise:return function(e,t){return N_(e.type._def,t)}(e,n);case Xg.ZodNaN:case Xg.ZodNever:return{not:{}};case Xg.ZodEffects:return function(e,t){return"input"===t.effectStrategy?N_(e.schema._def,t):{}}(e,n);case Xg.ZodAny:case Xg.ZodUnknown:return{};case Xg.ZodDefault:return function(e,t){return{...N_(e.innerType._def,t),default:e.defaultValue()}}(e,n);case Xg.ZodBranded:return function(e,t){return N_(e.type._def,t)}(e,n);case Xg.ZodReadonly:case Xg.ZodCatch:return((e,t)=>N_(e.innerType._def,t))(e,n);case Xg.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return N_(e.in._def,t);if("output"===t.pipeStrategy)return N_(e.out._def,t);const n=N_(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,N_(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter((e=>void 0!==e))}})(e,n);case Xg.ZodFunction:case Xg.ZodVoid:case Xg.ZodSymbol:default:return}},D_=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),M_=(e,t)=>{const n=(e=>{const t=(e=>"string"==typeof e?{...v_,name:e}:{...v_,...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map((([e,n])=>[n._def,{def:n._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}})(t),r="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce(((e,[t,r])=>({...e,[t]:N_(r._def,{...n,currentPath:[...n.basePath,n.definitionPath,t]},!0)??{}})),{}):void 0,i="string"==typeof t?t:t?.name,s=N_(e._def,void 0===i?n:{...n,currentPath:[...n.basePath,n.definitionPath,i]},!1)??{},a=void 0===i?r?{...s,[n.definitionPath]:r}:s:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,i].join("/"),[n.definitionPath]:{...r,[i]:s}};return"jsonSchema7"===n.target?a.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===n.target&&(a.$schema="https://json-schema.org/draft/2019-09/schema#"),a};function U_(e){return m_(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...M_(e.data.schema),title:e.data.name}}}class $_{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){const e={};return Object.values(this.nodes).forEach(((t,n)=>{e[t.id]=uv(t.id)?n:t.id})),{nodes:Object.values(this.nodes).map((t=>({id:e[t.id],...U_(t)}))),edges:this.edges.map((t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]}))}}addNode(e,t){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const n=t||By(),r={id:n,data:e};return this.nodes[n]=r,r}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter((t=>t.source!==e.id&&t.target!==e.id))}addEdge(e,t,n){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const r={source:e.id,target:t.id,data:n};return this.edges.push(r),r}firstNode(){const e=new Set(this.edges.map((e=>e.target))),t=[];return Object.values(this.nodes).forEach((n=>{e.has(n.id)||t.push(n)})),t[0]}lastNode(){const e=new Set(this.edges.map((e=>e.source))),t=[];return Object.values(this.nodes).forEach((n=>{e.has(n.id)||t.push(n)})),t[0]}extend(e){Object.entries(e.nodes).forEach((([e,t])=>{this.nodes[e]=t})),this.edges=[...this.edges,...e.edges]}trimFirstNode(){const e=this.firstNode();if(e){const t=this.edges.filter((t=>t.source===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}trimLastNode(){const e=this.lastNode();if(e){const t=this.edges.filter((t=>t.target===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}}function F_(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function B_(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*V_(e,t){const n=c_.getInstance();for(;;){const{value:r,done:i}=n.run(e,t.next.bind(t));if(i)break;yield r}}async function*q_(e,t){const n=c_.getInstance(),r=t[Symbol.asyncIterator]();for(;;){const{value:i,done:s}=await n.run(e,r.next.bind(t));if(s)break;yield i}}function z_(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class H_ extends _p{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new K_({bound:this,kwargs:e,config:{}})}map(){return new W_({bound:this})}withRetry(e){return new G_({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new K_({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new X_({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(d_);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const n=Object.fromEntries(Object.entries(e).filter((([e])=>"runId"!==e)));return Array.from({length:t},((t,r)=>d_(0===r?e:n)))}return Array.from({length:t},(()=>d_(e)))}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),i=r[0]?.maxConcurrency??n?.maxConcurrency,s=new um({maxConcurrency:i,onFailedAttempt:e=>{throw e}}),a=e.map(((e,t)=>s.call((async()=>{try{return await this.invoke(e,r[t])}catch(e){if(n?.returnExceptions)return e;throw e}}))));return Promise.all(a)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const n=new t_(this._streamIterator(e,d_(t)));return await n.setup,Xv.fromAsyncGenerator(n)}_separateRunnableConfigFromCallOptions(e){let t;t=d_(void 0===e?e:{callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,[t,n]}async _callWithConfig(e,t,n){const r=d_(n),i=await u_(r),s=await(i?.handleChainStart(this.toJSON(),z_(t,"input"),r.runId,r?.runType,void 0,void 0,r?.runName??this.getName()));let a;delete r.runId;try{a=await e.call(this,t,r,s)}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(z_(a,"output"))),a}async _batchWithConfig(e,t,n,r){const i=this._getOptionsList(n??{},t.length),s=await Promise.all(i.map(u_)),a=await Promise.all(s.map((async(e,n)=>{const r=await(e?.handleChainStart(this.toJSON(),z_(t[n],"input"),i[n].runId,i[n].runType,void 0,void 0,i[n].runName??this.getName()));return delete i[n].runId,r})));let o;try{o=await e.call(this,t,i,a,r)}catch(e){throw await Promise.all(a.map((t=>t?.handleChainError(e)))),e}return await Promise.all(a.map((e=>e?.handleChainEnd(z_(o,"output"))))),o}async*_transformStreamWithConfig(e,t,n){let r,i,s=!0,a=!0;const o=d_(n),c=await u_(o);let u;try{const n=await async function(e,t,n,...r){const i=new t_(t,n),s=await i.setup;return{output:e(i,s,...r),setup:s}}(t.bind(this),async function*(){for await(const t of e){if(s)if(void 0===r)r=t;else try{r=e_(r,t)}catch{r=void 0,s=!1}yield t}}(),(async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName())),o);delete o.runId,u=n.setup;const l=e=>"log_stream_tracer"===e.name,h=u?.handlers.find(l);let d=n.output;void 0!==h&&void 0!==u&&(d=await h.tapOutputIterable(u.runId,n.output));for await(const e of d)if(yield e,a)if(void 0===i)i=e;else try{i=e_(i,e)}catch{i=void 0,a=!1}}catch(e){throw await(u?.handleChainError(e,void 0,void 0,void 0,{inputs:z_(r,"input")})),e}await(u?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:z_(r,"input")}))}getGraph(e){const t=new $_,n=t.addNode({name:`${this.getName()}Input`,schema:Ly.any()}),r=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:Ly.any()});return t.addEdge(n,r),t.addEdge(r,i),t}pipe(e){return new Z_({first:this,last:Y_(e)})}pick(e){return this.pipe(new tw(e))}assign(e){return this.pipe(new ew(new J_({steps:e})))}async*transform(e,t){let n;for await(const t of e)n=void 0===n?t:e_(n,t);yield*this._streamIterator(n,d_(t))}async*streamLog(e,t,n){const r=new a_({...n,autoClose:!1,_schemaFormat:"original"}),i=d_(t);yield*this._streamLog(e,r,i)}async*_streamLog(e,t,n){const{callbacks:r}=n;if(void 0===r)n.callbacks=[t];else if(Array.isArray(r))n.callbacks=r.concat([t]);else{const e=r.copy();e.inheritableHandlers.push(t),n.callbacks=e}const i=this.stream(e,n),s=async function(){try{const e=await i;for await(const n of e){const e=new n_({ops:[{op:"add",path:"/streamed_output/-",value:n}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await s}}async*streamEvents(e,t,n){if("text/event-stream"===t.encoding){const r=await this._streamEvents(e,t,n);yield*function(e){const t=new TextEncoder,n=new ReadableStream({async start(n){for await(const r of e)n.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(r)}\n\n`));n.enqueue(t.encode("event: end\n\n")),n.close()}});return Xv.fromReadableStream(n)}(r)}else yield*this._streamEvents(e,t,n)}async*_streamEvents(e,t,n){if("v1"!==t.version)throw new Error('Only version "v1" of the events schema is currently supported.');let r,i=!1;const s=d_(t),a=s.tags??[],o=s.metadata??{},c=s.runName??this.getName(),u=new a_({...n,autoClose:!1,_schemaFormat:"streaming_events"}),l=new g_({...n}),h=this._streamLog(e,u,s);for await(const t of h){if(r=r?r.concat(t):r_.fromRunLogPatch(t),void 0===r.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const t={...r.state},n={run_id:t.id,event:`on_${t.type}_start`,name:c,tags:a,metadata:o,data:{input:e}};l.includeEvent(n,t.type)&&(yield n)}const n=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),s=[...new Set(n)];for(const e of s){let t,n={};const i=r.state.logs[e];if(t=void 0===i.end_time?i.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==i.inputs&&(n.input=i.inputs);else if("end"===t)void 0!==i.inputs&&(n.input=i.inputs),n.output=i.final_output;else if("stream"===t){const e=i.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${i.name}"`);n={chunk:i.streamed_output[0]},i.streamed_output=[]}yield{event:`on_${i.type}_${t}`,name:i.name,run_id:i.id,tags:i.tags,metadata:i.metadata,data:n}}const{state:u}=r;if(u.streamed_output.length>0){const e=u.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${u.name}"`);const t={chunk:u.streamed_output[0]};u.streamed_output=[];const n={event:`on_${u.type}_stream`,run_id:u.id,tags:a,metadata:o,name:c,data:t};l.includeEvent(n,u.type)&&(yield n)}}const d=r?.state;if(void 0!==d){const e={event:`on_${d.type}_end`,name:c,run_id:d.id,tags:a,metadata:o,data:{output:d.final_output}};l.includeEvent(e,d.type)&&(yield e)}}static isRunnable(e){return m_(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new K_({bound:this,config:{},configFactories:[r=>({callbacks:[new p_({config:r,onStart:e,onEnd:t,onError:n})]})]})}}class K_ extends H_{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=l_(this.config,...e);return l_(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(d_(t),this.kwargs))}async batch(e,t,n){const r=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig(d_(e),this.kwargs)))):await this._mergeConfig(d_(t),this.kwargs);return this.bound.batch(e,r,n)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(d_(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(d_(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(d_(t),this.kwargs))}async*streamEvents(e,t,n){yield*this.bound.streamEvents(e,{...await this._mergeConfig(d_(t),this.kwargs),version:t.version},n)}static isRunnableBinding(e){return e.bound&&H_.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:n}){return new K_({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[r=>({callbacks:[new p_({config:r,onStart:e,onEnd:t,onError:n})]})]})}}class W_ extends H_{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new W_({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,n){return this.bound.batch(e,f_(t,{callbacks:n?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:n}){return new W_({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:n})})}}class G_ extends K_{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){const r=e>1?`retry:attempt:${e}`:void 0;return f_(t,{callbacks:n?.getChild(r)})}async _invoke(e,t,n){return sm((r=>super.invoke(e,this._patchConfigForRetry(r,t,n))),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,n,r){const i={};try{await sm((async s=>{const a=e.map(((e,t)=>t)).filter((e=>void 0===i[e.toString()]||i[e.toString()]instanceof Error)),o=a.map((t=>e[t])),c=a.map((e=>this._patchConfigForRetry(s,t?.[e],n?.[e]))),u=await super.batch(o,c,{...r,returnExceptions:!0});let l;for(let e=0;e<u.length;e+=1){const t=u[e],n=a[e];t instanceof Error&&void 0===l&&(l=t,l.input=o[e]),i[n.toString()]=t}if(l)throw l;return u}),{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==r?.returnExceptions)throw e}return Object.keys(i).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>i[parseInt(e,10)]))}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}}class Z_ extends H_{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const n=d_(t),r=await u_(n),i=await(r?.handleChainStart(this.toJSON(),z_(e,"input"),n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;let s,a=e;try{const e=[this.first,...this.middle];for(let t=0;t<e.length;t+=1){const r=e[t];a=await r.invoke(a,f_(n,{callbacks:i?.getChild(`seq:step:${t+1}`)}))}s=await this.last.invoke(a,f_(n,{callbacks:i?.getChild(`seq:step:${this.steps.length}`)}))}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(z_(s,"output"))),s}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),i=await Promise.all(r.map(u_)),s=await Promise.all(i.map((async(t,n)=>{const i=await(t?.handleChainStart(this.toJSON(),z_(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,i})));let a=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e];a=await t.batch(a,s.map(((t,n)=>{const i=t?.getChild(`seq:step:${e+1}`);return f_(r[n],{callbacks:i})})),n)}}catch(e){throw await Promise.all(s.map((t=>t?.handleChainError(e)))),e}return await Promise.all(s.map((e=>e?.handleChainEnd(z_(a,"output"))))),a}async*_streamIterator(e,t){const n=await u_(t),{runId:r,...i}=t??{},s=await(n?.handleChainStart(this.toJSON(),z_(e,"input"),r,void 0,void 0,void 0,i?.runName)),a=[this.first,...this.middle,this.last];let o,c=!0;try{let t=a[0].transform(async function*(){yield e}(),f_(i,{callbacks:s?.getChild("seq:step:1")}));for(let e=1;e<a.length;e+=1){const n=a[e];t=await n.transform(t,f_(i,{callbacks:s?.getChild(`seq:step:${e+1}`)}))}for await(const n of t)if(yield n,c)if(void 0===o)o=n;else try{o=e_(o,n)}catch(e){o=void 0,c=!1}}catch(e){throw await(s?.handleChainError(e)),e}await(s?.handleChainEnd(z_(o,"output")))}getGraph(e){const t=new $_;let n=null;return this.steps.forEach(((r,i)=>{const s=r.getGraph(e);0!==i&&s.trimFirstNode(),i!==this.steps.length-1&&s.trimLastNode(),t.extend(s);const a=s.firstNode();if(!a)throw new Error(`Runnable ${r} has no first node`);n&&t.addEdge(n,a),n=s.lastNode()})),t}pipe(e){return Z_.isRunnableSequence(e)?new Z_({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new Z_({first:this.first,middle:[...this.middle,this.last],last:Y_(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&H_.isRunnable(e)}static from([e,...t],n){return new Z_({first:Y_(e),middle:t.slice(0,-1).map(Y_),last:Y_(t[t.length-1]),name:n})}}class J_ extends H_{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,n]of Object.entries(e.steps))this.steps[t]=Y_(n)}static from(e){return new J_({steps:e})}async invoke(e,t){const n=d_(t),r=await u_(n),i=await(r?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;const s={};try{await Promise.all(Object.entries(this.steps).map((async([t,r])=>{s[t]=await r.invoke(e,f_(n,{callbacks:i?.getChild(`map:key:${t}`)}))})))}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(s)),s}async*_transform(e,t,n){const r={...this.steps},i=Yv(e,Object.keys(r).length),s=new Map(Object.entries(r).map((([e,r],s)=>{const a=r.transform(i[s],f_(n,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,a.next().then((t=>({key:e,gen:a,result:t})))]})));for(;s.size;){const{key:e,result:t,gen:n}=await Promise.race(s.values());s.delete(e),t.done||(yield{[e]:t.value},s.set(e,n.next().then((t=>({key:e,gen:n,result:t})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=new t_(this.transform(async function*(){yield e}(),t));return await n.setup,Xv.fromAsyncGenerator(n)}}class Q_ extends H_{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new Q_({func:e})}async _invoke(e,t,n){return new Promise(((r,i)=>{const s=f_(t,{callbacks:n?.getChild(),recursionLimit:(t?.recursionLimit??25)-1});c_.getInstance().run(s,(async()=>{try{let n=await this.func(e,{...s,config:s});if(n&&H_.isRunnable(n)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");n=await n.invoke(e,{...s,recursionLimit:(s.recursionLimit??25)-1})}else if(B_(n)){let e;for await(const t of q_(s,n))if(void 0===e)e=t;else try{e=e_(e,t)}catch(n){e=t}n=e}else if(F_(n)){let e;for(const t of V_(s,n))if(void 0===e)e=t;else try{e=e_(e,t)}catch(n){e=t}n=e}r(n)}catch(e){i(e)}}))}))}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,n){let r;for await(const t of e)if(void 0===r)r=t;else try{r=e_(r,t)}catch(e){r=t}const i=await new Promise(((e,t)=>{c_.getInstance().run(n,(async()=>{try{const t=await this.func(r,{...n,config:n});e(t)}catch(e){t(e)}}))}));if(i&&H_.isRunnable(i)){if(0===n?.recursionLimit)throw new Error("Recursion limit reached.");const e=await i.stream(r,f_(n,{callbacks:t?.getChild(),recursionLimit:(n?.recursionLimit??25)-1}));for await(const t of e)yield t}else if(B_(i))for await(const e of q_(n,i))yield e;else if(F_(i))for(const e of V_(n,i))yield e;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=new t_(this.transform(async function*(){yield e}(),t));return await n.setup,Xv.fromAsyncGenerator(n)}}class X_ extends H_{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const n=await Av.configure(t?.callbacks,void 0,t?.tags,void 0,t?.metadata),{runId:r,...i}=t??{},s=await(n?.handleChainStart(this.toJSON(),z_(e,"input"),r,void 0,void 0,void 0,i?.runName));let a;for(const t of this.runnables())try{const n=await t.invoke(e,f_(i,{callbacks:s?.getChild()}));return await(s?.handleChainEnd(z_(n,"output"))),n}catch(e){void 0===a&&(a=e)}if(void 0===a)throw new Error("No error stored at end of fallback.");throw await(s?.handleChainError(a)),a}async batch(e,t,n){if(n?.returnExceptions)throw new Error("Not implemented.");const r=this._getOptionsList(t??{},e.length),i=await Promise.all(r.map((e=>Av.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)))),s=await Promise.all(i.map((async(t,n)=>{const i=await(t?.handleChainStart(this.toJSON(),z_(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,i})));let a;for(const t of this.runnables())try{const i=await t.batch(e,s.map(((e,t)=>f_(r[t],{callbacks:e?.getChild()}))),n);return await Promise.all(s.map(((e,t)=>e?.handleChainEnd(z_(i[t],"output"))))),i}catch(e){void 0===a&&(a=e)}if(!a)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(s.map((e=>e?.handleChainError(a)))),a}}function Y_(e){if("function"==typeof e)return new Q_({func:e});if(H_.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[n,r]of Object.entries(e))t[n]=Y_(r);return new J_({steps:t})}}class ew extends H_{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof J_&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){const r=this.mapper.getStepsKeys(),[i,s]=Yv(e),a=this.mapper.transform(s,f_(n,{callbacks:t?.getChild()})),o=a.next();for await(const e of i){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!r.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of a)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=new t_(this.transform(async function*(){yield e}(),t));return await n.setup,Xv.fromAsyncGenerator(n)}}class tw extends H_{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=new t_(this.transform(async function*(){yield e}(),t));return await n.setup,Xv.fromAsyncGenerator(n)}}class nw extends H_{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class rw extends nw{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){super({callbacks:e??t,...n}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof n.cache?this.cache=n.cache:n.cache?this.cache=tm.global():this.cache=void 0,this.caller=new um(n??{})}async getNumTokens(e){if("string"!=typeof e)return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await async function(e){return async function(e){return e in ym||(ym[e]=vm.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then((e=>e.json())).then((e=>new gm(e))).catch((t=>{throw delete ym[e],t}))),await ym[e]}(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":return"o200k_base";default:throw new Error("Unknown model")}}(e))}("modelName"in this?(n=this.modelName,n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}var n;if(this._encoding)try{t=this._encoding.encode(e).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return t}static _convertInputToPromptValue(e){return"string"==typeof e?new rm(e):Array.isArray(e)?new im(e.map(Dp)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()},r=Object.entries(n).filter((([e,t])=>void 0!==t)),i=r.map((([e,t])=>`${e}:${JSON.stringify(t)}`)).sort().join(",");return i}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class iw extends rw{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n?.timeout&&!n.signal&&(n.signal=AbortSignal.timeout(n.timeout)),[t,n]}async invoke(e,t){const n=iw._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===iw.prototype._streamResponseChunks)yield this.invoke(e,t);else{const n=iw._convertInputToPromptValue(e).toChatMessages(),[r,i]=this._separateRunnableConfigFromCallOptions(t),s=await Av.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),a={options:i,invocation_params:this?.invocationParams(i),batch_size:1},o=await(s?.handleChatModelStart(this.toJSON(),[n],r.runId,void 0,a,void 0,void 0,r.runName));let c;try{for await(const e of this._streamResponseChunks(n,i,o?.[0]))e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,c=c?c.concat(e):e}catch(e){throw await Promise.all((o??[]).map((t=>t?.handleLLMError(e)))),e}await Promise.all((o??[]).map((e=>e?.handleLLMEnd({generations:[[c]]}))))}}async _generateUncached(e,t,n){const r=e.map((e=>e.map(Dp))),i=await Av.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),s={options:t,invocation_params:this?.invocationParams(t),batch_size:1},a=await(i?.handleChatModelStart(this.toJSON(),r,n.runId,void 0,s,void 0,void 0,n.runName)),o=await Promise.allSettled(r.map(((e,n)=>this._generate(e,{...t,promptIndex:n},a?.[n])))),c=[],u=[];await Promise.all(o.map((async(e,t)=>{if("fulfilled"===e.status){const n=e.value;for(const e of n.generations)e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};return 1===n.generations.length&&(n.generations[0].message.response_metadata={...n.llmOutput,...n.generations[0].message.response_metadata}),c[t]=n.generations,u[t]=n.llmOutput,a?.[t]?.handleLLMEnd({generations:[n.generations],llmOutput:n.llmOutput})}return await(a?.[t]?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const l={generations:c,llmOutput:u.length?this._combineLLMOutput?.(...u):void 0};return Object.defineProperty(l,$p,{value:a?{runIds:a?.map((e=>e.runId))}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:r,handledOptions:i}){const s=e.map((e=>e.map(Dp))),a=await Av.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),o={options:r,invocation_params:this?.invocationParams(r),batch_size:1,cached:!0},c=await(a?.handleChatModelStart(this.toJSON(),s,i.runId,void 0,o,void 0,void 0,i.runName)),u=[],l=await Promise.allSettled(s.map((async(e,r)=>{const i=iw._convertInputToPromptValue(e).toString(),s=await t.lookup(i,n);return null==s&&u.push(r),s}))),h=l.map(((e,t)=>({result:e,runManager:c?.[t]}))).filter((({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status)),d=[];await Promise.all(h.map((async({result:e,runManager:t},n)=>{if("fulfilled"===e.status){const r=e.value;return d[n]=r,r.length&&await(t?.handleLLMNewToken(r[0].text)),t?.handleLLMEnd({generations:[r]})}return await(t?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const f={generations:d,missingPromptIndices:u};return Object.defineProperty(f,$p,{value:c?{runIds:c?.map((e=>e.runId))}:void 0,configurable:!0}),f}async generate(e,t,n){let r;r=Array.isArray(t)?{stop:t}:t;const i=e.map((e=>e.map(Dp))),[s,a]=this._separateRunnableConfigFromCallOptions(r);if(s.callbacks=s.callbacks??n,!this.cache)return this._generateUncached(i,a,s);const{cache:o}=this,c=this._getSerializedCacheKeyParametersForCall(a),{generations:u,missingPromptIndices:l}=await this._generateCached({messages:i,cache:o,llmStringKey:c,parsedOptions:a,handledOptions:s});let h={};if(l.length>0){const e=await this._generateUncached(l.map((e=>i[e])),a,s);await Promise.all(e.generations.map((async(e,t)=>{const n=l[t];u[n]=e;const r=iw._convertInputToPromptValue(i[n]).toString();return o.update(r,c,e)}))),h=e.llmOutput??{}}return{generations:u,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){const r=e.map((e=>e.toChatMessages()));return this.generate(r,t,n)}async call(e,t,n){return(await this.generate([e.map(Dp)],t,n)).generations[0][0].message}async callPrompt(e,t,n){const r=e.toChatMessages();return this.call(r,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const r=new Np(e),i=await this.call([r],t,n);if("string"!=typeof i.content)throw new Error("Cannot use predict when output is not a string.");return i.content}}function sw(e){return{name:e.name,description:e.description,parameters:M_(e.schema)}}function aw(e){return function(e){return void 0!==e&&Array.isArray(e.lc_namespace)}(e)?{type:"function",function:sw(e)}:e}class ow extends H_{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const n=d_(t);return this.func&&await this.func(e,n),this._callWithConfig((e=>Promise.resolve(e)),e,n)}async*transform(e,t){const n=d_(t);let r,i=!0;for await(const t of this._transformStreamWithConfig(e,(e=>e),n))if(yield t,i)if(void 0===r)r=t;else try{r=e_(r,t)}catch{r=void 0,i=!1}this.func&&void 0!==r&&await this.func(r,n)}static assign(e){return new ew(new J_({steps:e}))}}class cw extends H_{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig((async(e,t)=>this.parseResult([{text:e}],t?.callbacks)),e,{...t,runType:"parser"}):this._callWithConfig((async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks)),e,{...t,runType:"parser"})}}class uw extends cw{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}}class lw extends Error{constructor(e,t,n,r=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=r,r&&(void 0===n||void 0===t))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}}function hw(e,t){const n=typeof e;if(n!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const n=e.length;if(n!==t.length)return!1;for(let r=0;r<n;r++)if(!hw(e[r],t[r]))return!1;return!0}if("object"===n){if(!e||!t)return e===t;const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(const r of n)if(!hw(e[r],t[r]))return!1;return!0}return e===t}"undefined"!=typeof self&&self.location&&"null"!==self.location.origin&&(self.location.origin,self.location.pathname,location.search);class dw extends uw{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class fw extends dw{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,n;for await(const i of e){if("string"!=typeof i&&"string"!=typeof i.content)throw new Error("Cannot handle non-string output.");let e;if(kp(r=i)&&"function"==typeof r.concat){if("string"!=typeof i.content)throw new Error("Cannot handle non-string message output.");e=new Bp({message:i,text:i.content})}else if(kp(i)){if("string"!=typeof i.content)throw new Error("Cannot handle non-string message output.");e=new Bp({message:Up(i),text:i.content})}else e=new Fp({text:i});n=void 0===n?e:n.concat(e);const s=await this.parsePartialResult([n]);null==s||hw(s,t)||(this.diff?yield this._diff(t,s):yield s,t=s)}var r}}class pw extends uw{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(Ly.object(Object.fromEntries(Object.entries(e).map((([e,t])=>[e,Ly.string().describe(t)])))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.\n\n"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.\n\nFor example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}\nwould match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.\nThus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.\n\nYour output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!\n\nHere is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:\n\`\`\`json\n${JSON.stringify(M_(this.schema))}\n\`\`\`\n`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,((e,t)=>`"${t.replace(/\n/g,"\\n")}"`)).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new lw(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class mw extends fw{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Qv(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return hp(e[0].text)}async parse(e){return hp(e,JSON.parse)}getFormatInstructions(){return""}}function gw(e,t){if(void 0===e.function)return;let n;if(t?.partial)try{n=dp(e.function.arguments??"{}")}catch(e){return}else try{n=JSON.parse(e.function.arguments)}catch(t){throw new lw([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${t.message}`].join("\n"))}const r={name:e.function.name,args:n};return t?.returnId&&(r.id=e.id),r}function yw(e){if(void 0===e.id)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function vw(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t}}class _w extends cw{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}async parseResult(e){const t=e[0].message.additional_kwargs.tool_calls;if(!t)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);const n=JSON.parse(JSON.stringify(t)),r=[];for(const e of n){const t=gw(e,{partial:!0});if(void 0!==t){const e={type:t.name,args:t.args,id:t.id};Object.defineProperty(e,"name",{get(){return this.type}}),Object.defineProperty(e,"arguments",{get(){return this.args}}),r.push(e)}}return r}}class ww extends cw{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.initialParser=new _w(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new lw(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=(await this.initialParser.parseResult(e)).filter((e=>e.type===this.keyName));let n=t;if(this.returnId||(n=t.map((e=>e.args))),this.returnSingle)return this._validateResult(n[0]);const r=await Promise.all(n.map((e=>this._validateResult(e))));return r}}function bw(e,t){const n=[];for(const[r,i]of Object.entries(e.properties??{}))i.description&&t<2&&n.push(`// ${i.description}`),e.required?.includes(r)?n.push(`${r}: ${Ew(i,t)},`):n.push(`${r}?: ${Ew(i,t)},`);return n.map((e=>" ".repeat(t)+e)).join("\n")}function Ew(e,t){if(function(e){return void 0!==e.anyOf&&Array.isArray(e.anyOf)}(e))return e.anyOf.map((e=>Ew(e,t))).join(" | ");switch(e.type){case"string":return e.enum?e.enum.map((e=>`"${e}"`)).join(" | "):"string";case"number":case"integer":return e.enum?e.enum.map((e=>`${e}`)).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",bw(e,t+2),"}"].join("\n");case"array":return e.items?`${Ew(e.items,t)}[]`:"any[]";default:return""}}function Iw(e){const t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!xp.isInstance(e))throw new Error("Invalid generic chat message");return function(e){return"system"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role}(e);default:throw new Error(`Unknown message type: ${t}`)}}function Tw(e){const t=e.tool_calls;if("assistant"===e.role){const n=[],r=[];for(const e of t??[])try{n.push(gw(e,{returnId:!0}))}catch(t){r.push(vw(e,t.message))}return new Ap({content:e.content||"",tool_calls:n,invalid_tool_calls:r,additional_kwargs:{function_call:e.function_call,tool_calls:t}})}return new xp(e.content||"",e.role??"unknown")}function kw(e,t){const n=e.role??t,r=e.content??"";let i;if(i=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},"user"===n)return new Rp({content:r});if("assistant"===n){const t=[];if(Array.isArray(e.tool_calls))for(const n of e.tool_calls)t.push({name:n.function?.name,args:n.function?.arguments,id:n.id,index:n.index});return new Op({content:r,tool_call_chunks:t,additional_kwargs:i})}return"system"===n?new Lp({content:r}):"function"===n?new Pp({content:r,additional_kwargs:i,name:e.name}):"tool"===n?new Sp({content:r,additional_kwargs:i,tool_call_id:e.tool_call_id}):new Cp({content:r,role:n})}function Sw(e){return e.map((e=>{const t={role:Iw(e),content:e.content};return null!=e.name&&(t.name=e.name),null!=e.additional_kwargs.function_call&&(t.function_call=e.additional_kwargs.function_call),"ai"===e._getType()&&e.tool_calls?.length?t.tool_calls=e.tool_calls.map(yw):(null!=e.additional_kwargs.tool_calls&&(t.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(t.tool_call_id=e.tool_call_id)),t}))}class Aw extends iw{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??Hp("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??Hp("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.apiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??Hp("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??Hp("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??Hp("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??Hp("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??Hp("OPENAI_ORGANIZATION"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??""}this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}bindTools(e,t){return this.bind({tools:e.map(aw),...t})}invocationParams(e){var t;return{model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:(t=e?.tools,void 0!==t&&t.every((e=>Array.isArray(e.lc_namespace)))?e?.tools.map(aw):e?.tools),tool_choice:e?.tool_choice,response_format:e?.response_format,seed:e?.seed,...this.modelKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){const r=Sw(e),i={...this.invocationParams(t),messages:r,stream:!0};let s;const a=await this.completionWithRetry(i,t);for await(const e of a){const r=e?.choices[0];if(!r)continue;const{delta:i}=r;if(!i)continue;const a=kw(i,s);s=i.role??s;const o={prompt:t.promptIndex??0,completion:r.index??0};if("string"!=typeof a.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const c={...o};void 0!==r.finish_reason&&(c.finish_reason=r.finish_reason),this.logprobs&&(c.logprobs=r.logprobs);const u=new Bp({message:a,text:a.content,generationInfo:c});yield u,n?.handleLLMNewToken(u.text??"",o,void 0,void 0,void 0,{chunk:u})}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,n){const r={},i=this.invocationParams(t),s=Sw(e);if(i.stream){const i=this._streamResponseChunks(e,t,n),s={};for await(const e of i){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};const t=e.generationInfo?.completion??0;void 0===s[t]?s[t]=e:s[t]=s[t].concat(e)}const a=Object.entries(s).sort((([e],[t])=>parseInt(e,10)-parseInt(t,10))).map((([e,t])=>t)),{functions:o,function_call:c}=this.invocationParams(t),u=await this.getEstimatedTokenCountFromPrompt(e,o,c),l=await this.getNumTokensFromGenerations(a);return r.promptTokens=u,r.completionTokens=l,r.totalTokens=u+l,{generations:a,llmOutput:{estimatedTokenUsage:r}}}{const e=await this.completionWithRetry({...i,stream:!1,messages:s},{signal:t?.signal,...t?.options}),{completion_tokens:n,prompt_tokens:a,total_tokens:o}=e?.usage??{};n&&(r.completionTokens=(r.completionTokens??0)+n),a&&(r.promptTokens=(r.promptTokens??0)+a),o&&(r.totalTokens=(r.totalTokens??0)+o);const c=[];for(const t of e?.choices??[]){const e={text:t.message?.content??"",message:Tw(t.message??{role:"assistant"})};e.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},c.push(e)}return{generations:c,llmOutput:{tokenUsage:r}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let r=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==n){const e=function(e){const t=["namespace functions {",""];for(const n of e)n.description&&t.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(t.push(`type ${n.name} = (_: {`),t.push(bw(n.parameters,0)),t.push("}) => any;")):t.push(`type ${n.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);r+=await this.getNumTokens(e),r+=9}return t&&e.find((e=>"system"===e._getType()))&&(r-=4),"none"===n?r+=1:"object"==typeof n&&(r+=await this.getNumTokens(n.name)+4),r}async getNumTokensFromGenerations(e){return(await Promise.all(e.map((async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content))))).reduce(((e,t)=>e+t),0)}async getNumTokensFromMessages(e){let t=0,n=0,r=0;"gpt-3.5-turbo-0301"===this.model?(n=4,r=-1):(n=3,r=1);const i=await Promise.all(e.map((async e=>{const i=await this.getNumTokens(e.content),s=await this.getNumTokens(Iw(e)),a=void 0!==e.name?r+await this.getNumTokens(e.name):0;let o=i+n+s+a;const c=e;if("function"===c._getType()&&(o-=2),c.additional_kwargs?.function_call&&(o+=3),c?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(c.additional_kwargs.function_call?.name)),c.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(c.additional_kwargs.function_call?.arguments)))}catch(e){console.error("Error parsing function arguments",e,JSON.stringify(c.additional_kwargs.function_call)),o+=await this.getNumTokens(c.additional_kwargs.function_call?.arguments)}return t+=o,o})));return t+=3,{totalCount:t,countPerMessage:i}}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call((async()=>{try{return await this.client.chat.completions.create(e,n)}catch(e){throw function(e){let t;return e.constructor.name===Yf.name?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===ep.name?(t=new Error(e.message),t.name="AbortError"):t=e,t}(e)}}))}_getClientOptions(e){if(!this.client){const e=function(e){const{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:i,baseURL:s}=e;if(r&&i&&t)return`${i}/${t}`;if(r){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${t}`}return s}({azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new Zf(t)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce(((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e)),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,r,i,s;var a;let o,c;if(void 0!==(a=e)&&"object"==typeof a.schema?(n=e.schema,r=e.name,i=e.method,s=e.includeRaw):(n=e,r=t?.name,i=t?.method,s=t?.includeRaw),"jsonMode"===i)o=this.bind({response_format:{type:"json_object"}}),c=Ow(n)?pw.fromZodSchema(n):new mw;else{let e=r??"extract";if(Ow(n)){const t=M_(n);o=this.bind({tools:[{type:"function",function:{name:e,description:t.description,parameters:t}}],tool_choice:{type:"function",function:{name:e}}}),c=new ww({returnSingle:!0,keyName:e,zodSchema:n})}else{let t;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(t=n,e=n.name):(e=n.title??e,t={name:e,description:n.description??"",parameters:n}),o=this.bind({tools:[{type:"function",function:t}],tool_choice:{type:"function",function:{name:e}}}),c=new ww({returnSingle:!0,keyName:e})}}if(!s)return o.pipe(c);const u=ow.assign({parsed:(e,t)=>c.invoke(e.raw,t)}),l=ow.assign({parsed:()=>null}),h=u.withFallbacks({fallbacks:[l]});return Z_.from([{raw:o},h])}}function Ow(e){return"function"==typeof e?.parse}class xw extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}class Cw extends nw{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1})}async invoke(e,t){return this.call(e,d_(t))}async call(e,t,n){let r;try{r=await this.schema.parseAsync(e)}catch(t){throw new xw("Received tool input did not match expected schema",JSON.stringify(e))}const i=function(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}(t),s=await Av.configure(i.callbacks,this.callbacks,i.tags||n,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),a=await(s?.handleToolStart(this.toJSON(),"string"==typeof r?r:JSON.stringify(r),i.runId,void 0,void 0,void 0,i.runName));let o;delete i.runId;try{o=await this._call(r,a,i)}catch(e){throw await(a?.handleToolError(e)),e}return await(a?.handleToolEnd(o)),o}}class Pw extends Cw{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:Ly.object({input:Ly.string().optional()}).transform((e=>e.input))})}call(e,t){return super.call("string"!=typeof e&&e?e:{input:e},t)}}function Nw(){return new Aw({})}function Rw(e,t,n){return Uint8Array.from([144+e,t,n])}function jw(e,t,n){return Uint8Array.from([128+e,t,n])}function Lw(e,t,n){return Uint8Array.from([176+e,t,n])}function Dw(e){return e.toISOString()}function Mw(){return Dw(new Date)}function Uw(e){return Dw(e).split("T")[0].replace(/-/g,"_")}function $w(){return Uw(new Date)}function Fw(e){return Number(e)}function Bw(){return Fw(new Date)}function Vw(e,t){return e.getTime()==t.getTime()}function qw(e){return new Date(e.getTime())}function zw(e){return e.toString().split(" ").slice(0,4).join(" ").replace(" ","_")}function Hw(e,t){let n=qw(e);switch(t){case"year":n.setMonth(0);case"month":n.setDate(1);case"day":n.setHours(0);case"hour":n.setMinutes(0);case"minute":n.setSeconds(0);case"second":n.setMilliseconds(0);case"millisecond":break;default:return n}return n}function Kw(e,t,n){let r=qw(e);switch(n){case"year":r.setFullYear(r.getFullYear()+t);break;case"month":r.setMonth(r.getMonth()+t);break;case"day":r.setDate(r.getDate()+t);break;case"hour":r.setHours(r.getHours()+t);break;case"minute":r.setMinutes(r.getMinutes()+t);break;case"second":r.setSeconds(r.getSeconds()+t);break;case"millisecond":r.setMilliseconds(r.getMilliseconds()+t);break;default:return r}return r}Object.defineProperty(class extends Pw{static lc_name(){return"DallEAPIWrapper"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t={apiKey:e?.apiKey??e?.openAIApiKey??Hp("OPENAI_API_KEY"),organization:e?.organization??Hp("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0};this.client=new Zf(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.responseFormat=e?.responseFormat??this.responseFormat,this.user=e?.user}async _call(e){const t=await this.client.images.generate({model:this.model,prompt:e,n:this.n,size:this.size,response_format:this.responseFormat,style:this.style,quality:this.quality,user:this.user});let n="";return"url"===this.responseFormat?[n]=t.data.map((e=>e.url)).filter((e=>"undefined"!==e)):[n]=t.data.map((e=>e.b64_json)).filter((e=>"undefined"!==e)),n}},"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var Ww={"1sec":1e3,"5sec":5e3,"10sec":1e4,"30sec":3e4,"1min":6e4,"2min":12e4,"5min":3e5,"10min":6e5,"30min":18e5,"1hr":36e5,"1day":864e5};const Gw=$e({id:"common"});async function Zw(e,t){let n=`${e}?${new URLSearchParams(t)}`;return Gw(`Querying with url= ${n}`),(await fetch(n,{method:"GET",cache:"no-cache",headers:{"Content-Type":"application/json"},redirect:"follow"})).json()}})();var a=t;for(var o in s)a[o]=s[o];s.__esModule&&Object.defineProperty(a,"__esModule",{value:!0})}},i={};function s(e){var t=i[e];if(void 0!==t)return t.exports;var n=i[e]={exports:{}};return r[e](n,n.exports,s),n.exports}s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};(()=>{s.r(a),s.d(a,{apis:()=>O,common:()=>N,components:()=>x,cryptocurrency:()=>g,umd:()=>P,util:()=>f});var e={};s.r(e),s.d(e,{_speak:()=>Z,default_rate:()=>W,finished_speaking:()=>F,finished_utterance:()=>$,get_voice:()=>q,get_voice_by_name:()=>z,get_voices:()=>V,is_speaking:()=>B,set_default_rate:()=>G,speak:()=>J,speech_que:()=>U,tts:()=>M,voices_ready:()=>H,wait_until_voices_ready:()=>K});var t={};s.r(t),s.d(t,{get_recognition_object:()=>Q});var r={};s.r(r),s.d(r,{audio_context:()=>te,error:()=>de,input_ready:()=>fe,m2f:()=>X,note_obj_to_midi:()=>ie,note_to_freq:()=>oe,note_to_midi:()=>ae,note_to_note_obj:()=>se,play_note:()=>ce,play_notes:()=>ue,play_notes_delay:()=>le,proceed:()=>pe,success:()=>he,tone:()=>re});var i={};s.r(i),s.d(i,{audio_primitives:()=>ge,connect:()=>ve,disconnect:()=>_e});var o={};s.r(o),s.d(o,{_recorder:()=>Ee,get_current_data:()=>Oe,get_recorder_object:()=>Ie,get_recorder_state:()=>xe,is_supported:()=>be,pause_recording:()=>Se,resume_recording:()=>Ae,start_recording:()=>Te,stop_recording:()=>ke});var c={};s.r(c),s.d(c,{audio_detector:()=>De,detection_threshold:()=>je,listeners:()=>Re,media_recorder:()=>o,mic:()=>i,set_detection_threshold:()=>Le,start_power:()=>Ne,stop:()=>Me});var u={};s.r(u),s.d(u,{dot_join:()=>Ve,full_name:()=>qe,get:()=>He,get_header:()=>We,get_keys:()=>Ke,get_t:()=>Ze,set_storage_header:()=>Be,store:()=>ze,store_t:()=>Ge});var l={};s.r(l),s.d(l,{RecognitionState:()=>Je,ap:()=>c,initialize_recognition:()=>et,pause_recognition:()=>tt,recognition:()=>Xe,recognition_state:()=>Ye,set_default_tts_rate:()=>ot,set_default_voice_from_name_preference_list:()=>ct,set_default_voice_uri:()=>at,speak:()=>lt,speak_with_rate:()=>ht,speak_with_voice:()=>ut,sr:()=>t,start_recognition:()=>rt,start_recognition_and_detection:()=>st,stop_recognition:()=>nt,stop_recognition_and_detection:()=>it,tts:()=>e});var h={};s.r(h),s.d(h,{WebSocketMaker:()=>ft});var d={};s.r(d),s.d(d,{set_value_by_id:()=>pt});var f={};s.r(f),s.d(f,{add_css:()=>It,add_script:()=>bt,alert:()=>gt,audio_processing:()=>c,define:()=>wt,dom:()=>d,inject_script:()=>Et,is_chrome:()=>yt,is_mobile:()=>vt,sounds:()=>r,speech_recognition:()=>t,tts:()=>e,uuid:()=>_t,voice_interface:()=>l,ws:()=>h});var p={};s.r(p),s.d(p,{basic_spot_kine_socket:()=>St,basic_spot_trade_socket:()=>Ot,spot_kline_socket:()=>kt,spot_trade_socket:()=>At});var m={};s.r(m),s.d(m,{buy_beep:()=>Pt,sell_beep:()=>Nt,set_sound_options:()=>Ct,sound_options:()=>xt,trade_beeper:()=>Rt});var g={};s.r(g),s.d(g,{binance_listener:()=>m,binance_ws:()=>p});var y={};s.r(y),s.d(y,{load_key_handlers:()=>Lt});var v={};s.r(v),s.d(v,{keys:()=>Vt,keys_to_notes_1:()=>qt,load_sound_key_handler:()=>Ht,sound_key_handler:()=>zt});var _={};s.r(_),s.d(_,{get_openai:()=>Jt,get_openai_tts_response:()=>Yt,openai_davinci_prompt:()=>en,speak:()=>Qt,text_to_audio:()=>Xt});var w={};s.r(w),s.d(w,{encode_json_to_uint8:()=>nn,get_datagram_writer:()=>rn,get_json_writer:()=>an,init:()=>tn,write_json_datagram:()=>sn});var b={};s.r(b),s.d(b,{FacebookAuthProvider:()=>Ls,GithubAuthProvider:()=>Ms,GoogleAuthProvider:()=>Ds,addDoc:()=>Pp,collection:()=>Wf,doc:()=>Gf,getDoc:()=>Op,getFirestore:()=>Qf,get_auth:()=>Lp,get_firestore_db:()=>Dp,initialize_app:()=>jp,initialize_firebase_auth_firestore:()=>Mp,log_out:()=>Up,setDoc:()=>Cp,signInWithRedirect:()=>ka});var E={};s.r(E),s.d(E,{get_midi_writer:()=>$p});var I={};s.r(I),s.d(I,{webtransport:()=>E});var T={};s.r(T),s.d(T,{log_motion:()=>Hp,log_orientation:()=>Kp,motion_handler:()=>Qp,motion_subscribers:()=>qp,orientation_handler:()=>Xp,orientation_subscribers:()=>zp,start_device_motion:()=>Yp,start_device_orientation:()=>em,stop_device_motion:()=>tm,stop_device_orientation:()=>nm,subscribe_to_motion:()=>Wp,subscribe_to_orientation:()=>Gp,unsubscribe_motion_id:()=>Zp,unsubscribe_orientation_id:()=>Jp});var k={};s.r(k),s.d(k,{CACHE_CHECK_INTERVAL:()=>lm,GET_DB:()=>mm,LOCAL_DB_HANDLE_CACHE:()=>um,START_CACHE_CHECK:()=>_m,STOP_CACHE_CHECK:()=>wm,cache_check_interval_id:()=>ym,default_db_header:()=>dm,default_store_name:()=>hm,deleteDB:()=>bm,do_cache_check:()=>vm,exportDBString:()=>Em,importFromJson:()=>Im,log:()=>om,set_cache_check_interval:()=>gm});var S={};s.r(S),s.d(S,{load_bokeh_scripts:()=>Sm});var A={};s.r(A),s.d(A,{SoundEventDetector:()=>zm,a1:()=>Hm,a2:()=>Km,analyser:()=>Cm,ctx:()=>Om,data_array:()=>Bm,decode_audio_array_buffer:()=>Dm,decode_audio_blob:()=>Mm,get_audio_context:()=>Rm,get_audio_stream:()=>jm,get_sampling_rate:()=>Lm,get_sound_event_detector:()=>Gm,initialize_microphone:()=>qm,mic_callbacks:()=>Um,mic_initialized:()=>Vm,plot_data:()=>Zm,register_mic_callback:()=>$m,run_mic_callbacks:()=>Fm,sound_event_detector:()=>Pm,stream:()=>xm,test_diff:()=>Wm});var O={};s.r(O),s.d(O,{bind_sounds_to_keys:()=>v,bokeh:()=>S,db:()=>k,firebase:()=>b,key_presses:()=>y,local_storage:()=>u,midi:()=>I,openai:()=>_,sensor:()=>T,web_audio:()=>A,webtransport:()=>w});var x={};s.r(x);var C={};s.r(C),s.d(C,{adjust_tts_rate:()=>lg,click_input:()=>Xm,configure_tts:()=>hg,default_monitoring_interval:()=>dg,enter_input:()=>Ym,finish_stream_handler:()=>ag,initialize_voice_system:()=>fg,initialize_voice_system_with_tts:()=>pg,input_area:()=>Jm,monitor_responses:()=>og,new_text_handler:()=>rg,set_input:()=>Qm,speak:()=>sg,speech_text_handler:()=>ig,start_speech_recognition_and_link_to_input:()=>eg,stop_monitoring:()=>ug,voice_preference_order:()=>cg});var P={};s.r(P),s.d(P,{chatgpt:()=>C});var N=s(78);let{asnc:R,fp:j,logger:L}=N,D=L.get_logger({id:"tts"});var M=function(){return window.speechSynthesis},U=[];async function $(){await R.wait_until((()=>!M().speaking),1/0,200)}async function F(){await R.wait_until((()=>!M().speaking&&U.length<1),1/0,200)}function B(){return M().speaking||U.length>0}function V(){return M().getVoices()}function q(e){let t=M().getVoices().filter((t=>t.voiceURI==e));return t.length>0?t[0]:null}function z(e){let t=M().getVoices().filter((t=>t.name==e));return t.length>0?t[0]:null}function H(){try{return M().getVoices().length>0}catch(e){return!1}}async function K(){await N.asnc.wait_until(H,3e3,200),D("voices_ready")}var W=1;function G(e){W=e,D("Default rate set to: "+e)}async function Z(e){let{voiceURI:t,rate:n=W,text:r}=e;if(M().speaking)console.log("Scheduling speech for later."),U.push(e);else{var i=new window.SpeechSynthesisUtterance(r);if(t){let e=q(t);e&&(i.voice=e)}i.rate=n,M().speak(i),await $();let e=U.shift();e?Z(e):console.log("done with speech que")}}function J(e){let{voiceURI:t,rate:n=W,text:r}=e;D("Request to speak  =:> "+r),D("With voice =:> "+t),j.map(j.partition(j.split(r," "),20),j.joiner(" ")).forEach((function(t){let n=j.clone(e);n.text=t,Z(n)}))}function Q(e={}){let{result_dispatch:t="tidyscripts_web_speech_recognition_result"}=e,{continuous:n=!0,interimResults:r=!1,onStart:i=(()=>{console.log("Recognition started")}),onSoundStart:s=(()=>{console.log("Sound started...")}),onSoundEnd:a=(()=>{console.log("Sound ended...")}),onSpeechStart:o=(()=>{console.log("Speech started...")}),onSpeechEnd:c=(()=>{console.log("Speech ended...")}),onResult:u=function(e){let n=e.results[e.resultIndex][0].transcript;console.log("Recognition result: "+n),window.dispatchEvent(new CustomEvent(t,{detail:n}))},onError:l=(e=>{console.log("Recognition error: "),console.log(e)}),onEnd:h=(()=>{console.log("Recognition ended")}),lang:d="en-US"}=e,f=new window.webkitSpeechRecognition;return f.onresult=u,f.onerror=l,f.onend=h,f.continuous=n,f.interimResults=r,f.onstart=i,f.onsoundstart=s,f.onsoundend=a,f.onspeechstart=o,f.onspeechend=c,f}var X={12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:27.5,22:29.135,23:30.868,24:32.703,25:34.648,26:36.708,27:38.891,28:41.203,29:43.654,30:46.249,31:48.999,32:51.913,33:55,34:58.27,35:61.735,36:65.406,37:69.296,38:73.416,39:77.782,40:82.407,41:87.307,42:92.499,43:97.999,44:103.826,45:110,46:116.541,47:123.471,48:130.813,49:138.591,50:146.832,51:155.564,52:164.814,53:174.614,54:184.997,55:195.998,56:207.652,57:220,58:233.082,59:246.942,60:261.626,61:277.183,62:293.665,63:311.127,64:329.628,65:349.228,66:369.994,67:391.995,68:415.305,69:440,70:466.164,71:493.883,72:523.251,73:554.365,74:587.33,75:622.254,76:659.255,77:698.457,78:739.989,79:783.991,80:830.609,81:880,82:932.328,83:987.767,84:1046.502,85:1108.731,86:1174.659,87:1244.508,88:1318.51,89:1396.913,90:1479.978,91:1567.982,92:1661.219,93:1760,94:1864.655,95:1975.533,96:2093.005,97:2217.461,98:2349.318,99:2489.016,100:2637.021,101:2793.826,102:2959.956,103:3135.964,104:3322.438,105:3520,106:3729.31,107:3951.066,108:4186.009,109:4434.922,110:4698.637,111:4978.032,112:5274.042,113:5587.652,114:5919.912,115:6271.928,116:6644.876,117:7040,118:7458.62,119:7902.133,120:8372.019,121:8869.845,122:9397.273,123:9956.064,124:10548.083,125:11175.305,126:11839.823,127:12543.855};let{fp:Y,asnc:ee}=N;var te=null,ne=function(){if(te)return te;{let e=window.AudioContext||window.webkitAudioContext;return te=new e}};async function re(e){let{type:t="sine",duration:n=600,gain:r=.5,delay:i,freq:s}=e,a=ne();var o=a.createOscillator();o.frequency.value=s,o.type=t;var c=a.createGain();if(i){var u=a.createDelay();u.delayTime.value=i,c.connect(u),u.connect(a.destination)}c.gain.value=r,o.connect(c),c.connect(a.destination),o.start(0),await ee.wait(n),o.stop()}function ie(e){let{num:t,mod:n,octave:r}=e,i=function(e){return Y.nth([0,0,2,4,5,7,9,11,12],e)}(t)+12*r;return n&&(i+="#"==n?1:-1),i}function se(e){let t=e.split(".");var n=0,r=null,i=null;return t.length>1&&(n=Number(t[1])),t[0].length>1?(r=t[0][0],i=Number(t[0][1])):i=Number(t[0][0]),{num:i,mod:r,octave:n}}function ae(e){return ie(se(e))}function oe(e){return X[ae(e)]}async function ce(e,t,n){console.log(Y.format("note | n= {}, dur={}, k={}",[e,t,n]));let r=n?ae(n):60,i=ae(e),s=X[String(r+i)],a=t||500;try{await re({freq:s,duration:a})}catch(e){console.log("Error playing. You likely played a note outside of currently supported range"),console.log(e),console.log("freq + duration:"),console.log({freq:s,duration:a})}}async function ue(e,t,n){e.map((e=>ce(e,t,n)))}async function le(e,t,n,r){for(var i of e)ce(i,n,r),await ee.wait(t)}function he(){ue(["1","3"],400,"3.5")}function de(){ue(["1","b5"],200,"3.5")}function fe(){le(["1","3"],100,100,"3.5")}function pe(){ue(["5.-1"],100,"3.5")}const me=N.logger.get_logger({id:"mic"});var ge={context:null,source:null,processor:null,stream:null,mic_sample_rate:null},ye=function(e,t){return function(n){var r,i,s,a,o;ge.stream=n,ge.context=new window.AudioContext,ge.source=null===(r=ge.context)||void 0===r?void 0:r.createMediaStreamSource(n),ge.processor=null===(i=ge.context)||void 0===i?void 0:i.createScriptProcessor(1024,1,1),null===(s=ge.source)||void 0===s||s.connect(ge.processor),null===(a=ge.processor)||void 0===a||a.connect(null===(o=ge.context)||void 0===o?void 0:o.destination),ge.processor.onaudioprocess=function(n){let r=e(n.inputBuffer.getChannelData(0));const i=new window.CustomEvent(t,{detail:r});window.dispatchEvent(i)};let c=n.getAudioTracks()[0].getSettings().sampleRate;ge.mic_sample_rate=c,me(`Determined sample rate of mic : ${ge.mic_sample_rate}`)}};function ve(e,t){let n=t||"tidyscripts_web_mic";window.navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(ye(e,n))}function _e(){let e=ge.context;e&&e.close(),ge={context:null,source:null,processor:null,stream:null,mic_sample_rate:null}}const we=N.logger.get_logger({id:"media_recorder"});function be(){return!!window.navigator.mediaDevices}var Ee=null;async function Ie(){if(Ee)return Ee;if(!be())return void we("NOT SUPPORTED");let e=await navigator.mediaDevices.getUserMedia({audio:!0});return Ee=new MediaRecorder(e)}async function Te(e,t){let n=await Ie();n.addEventListener("dataavailable",(async function(t){e(await t.data)})),n.start(t),we("Recording started")}async function ke(){(await Ie()).stop(),we("Recording stopped")}async function Se(){(await Ie()).pause(),we("Recording paused")}async function Ae(){(await Ie()).resume(),we("Recording resumed")}async function Oe(){return(await Ie()).requestData()}async function xe(){return(await Ie()).state}let{dsp:Ce,performance:Pe}=N.util;function Ne(){ve((e=>Ce.power(e)),"tidyscripts_web_mic")}var Re=[],je=1e3;function Le(e){je=e}function De(e,t){Ne(),t&&Le(t);var n=0,r=Pe.ms();let i=t=>{let i=t.detail;if(0==n)return void(n=i);let s=i/n*100;Pe.ms()-r>600&&s>je&&e(),n=i};window.addEventListener("tidyscripts_web_mic",i),Re.push(["tidyscripts_web_mic",i])}function Me(){for(var e of(_e(),Re))window.removeEventListener(e[0],e[1]);Re=[]}let{fp:Ue}=N,$e=function(){return window.localStorage};var Fe="tidyscripts";function Be(e){Fe=e}function Ve(e){return e.join(".")}function qe(e){return Ve([Fe,e])}function ze(e,t){$e()[qe(t)]=JSON.stringify(e)}function He(e){let t=$e()[qe(e)];return t?JSON.parse(t):null}function Ke(){return Object.keys($e())}function We(e){let t=Ke();return Ue.filter(t,(t=>t.startsWith(e)))}function Ge(e,t){ze({timestamp:Number(new Date),data:e},t)}function Ze(e){return He(e)}var Je,Qe=N.logger.get_logger({id:"voice_interface"}),Xe=null;!function(e){e.NULL="NULL",e.STOPPED="STOPPED",e.PAUSED="PAUSED",e.LISTENING="LISTENING",e.STOPPING="STOPPING"}(Je||(Je={}));var Ye=Je.NULL;function et(e){nt();let t=(e=e||{}).onEnd;e.onEnd=function(){Ye==Je.STOPPING?(Qe("Recognition stopped"),Ye=Je.STOPPED):(Ye=Je.PAUSED,Qe("Recognition paused")),t&&t()},Xe=Q(e),Ye=Je.PAUSED,De(rt)}function tt(){Xe&&(Xe.abort(),Ye=Je.PAUSED)}function nt(){Xe&&(Qe("Stopping recognition"),Ye=Je.STOPPING,Xe.abort(),Xe=null,Me())}async function rt(){Ye!=Je.LISTENING&&(B()&&Qe("Wont start recognition while tts active"),Xe?Xe.start():(et(),Qe("Recognition initialized without args")),Ye=Je.LISTENING)}function it(){let e=je;return tt(),Le(1/0),e}function st(e){rt(),Le(e)}function at(e){ze("default_voice_uri",e)}function ot(e){G(e)}function ct(e){for(var t of e){let e=z(t);if(e)return at(e.voiceURI),void Qe(`Set default voice to: ${e.name}`)}Qe("Unable to set default voice to any matching name in provided list")}async function ut(e,t,n){if(Xe){let r=it();J({text:e,voiceURI:t,rate:n}),await F(),st(r)}else J({text:e,voiceURI:t,rate:n}),await F()}async function lt(e){ut(e,He("default_voice_uri"),W)}async function ht(e,t){ut(e,He("default_voice_uri"),t)}let dt=N.logger.get_logger({id:"ws"});function ft(e){var{url:t,handler:n,open:r,error:i,close:s}=e;r=r||(()=>{dt(`ws to ${t} opened`)}),s=s||(()=>{dt(`ws to ${t} closed`)}),i=i||(e=>{dt(`ws to ${t} errored: ${JSON.stringify(e)}`)});let a=new WebSocket(t);return a.onopen=r,a.onclose=s,a.onerror=i,a.onmessage=e=>{n(e.data)},a}function pt(e,t){document.getElementById(e).value=t}let mt=N.logger.get_logger({id:"wutil"});function gt(e){mt("Alerting web page!"),window.alert(e)}function yt(){return/Chrome/.test(window.navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}function vt(){return/Mobi/.test(window.navigator.userAgent)}function _t(){var e=new Uint32Array(4);window.crypto.getRandomValues(e);var t=-1;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(n){t++;var r=e[t>>3]>>t%8*4&15;return("x"==n?r:3&r|8).toString(16)}))}async function wt(e,t){window[t]=await e,mt(`Defined ${t} on the window object :)`)}function bt(e){return new Promise(((t,n)=>{const r=window.document.createElement("script");r.setAttribute("src",e),r.addEventListener("load",t),r.addEventListener("error",n),document.body.appendChild(r)}))}function Et(e){return new Promise(((t,n)=>{const r=window.document.createElement("script");r.setAttribute("src",e.src);let i=e.attributes;if(i){let e=Object.keys(i);for(let t of e)r.setAttribute(t,i[t])}r.addEventListener("load",t),r.addEventListener("error",n),document.body.appendChild(r)}))}function It(e){return new Promise(((t,n)=>{var r=document.createElement("link");r.rel="stylesheet",r.type="text/css",r.href=e,r.media="all",r.addEventListener("load",t),r.addEventListener("error",n),document.getElementsByTagName("head")[0].appendChild(r)}))}let Tt=N.logger.get_logger({id:"bws"});function kt(e,t){let{sym:n,handler:r,error:i,close:s,open:a}=e;n=n.toLowerCase();let o=`wss://stream.binance.com:9443/ws/${n}@kline_${t=t||"1m"}`;return Tt("Using url for spot kline socket: "+o),ft({url:o,handler:r,error:i,close:s,open:a})}function St(e,t){return kt({sym:e,handler:t=t||(e=>{console.log(JSON.parse(e))})})}function At(e){let{sym:t,handler:n,error:r,close:i,open:s}=e;t=t.toLowerCase();let a=`wss://stream.binance.com:9443/ws/${t}@aggTrade`;return Tt("Using url for spot trade socket: "+a),ft({url:a,handler:n,error:r,close:i,open:s})}function Ot(e,t){return At({sym:e,handler:t=t||(e=>{console.log(JSON.parse(e))})})}var xt={freq:{buy:620,sell:580},duration:{buy:30,sell:30}};function Ct(e){xt=e}function Pt(e){re({freq:xt.freq.buy,gain:e,duration:xt.duration.buy})}function Nt(e){re({freq:xt.freq.sell,gain:e,duration:xt.duration.sell})}function Rt(e){return Ot(e,(function(e){let t=JSON.parse(e),{m:n,p:r,q:i}=t,s=Number(i),a=s>1?1:s;console.log(t),n?Nt(a):Pt(a)}))}let jt=N.logger.get_logger({id:"key_presses"});function Lt(e){window.onkeypress=function(t){jt("Keypress!");let n=t.key;console.log(n),e[n]&&e[n]()}}N.fp,N.util.debug;let Dt=N.logger.get_logger({id:"key_sounds"}),Mt=N.fp,Ut=N.util.debug;var $t=["q","w","e","r","t","y","u","i","o","p","["],Ft=["a","s","d","f","g","h","j","k","l",";"],Bt=["z","x","c","v","b","n","m",","],Vt={hi:$t,mid:Ft,lo:Bt};function qt(e){let t=Bt.concat(Ft).concat($t),n=0,r={};for(var i of Mt.enumerate(t)){i[0]%7==0&&(n+=1);let e=i[0]%7+1,t=Mt.format("{}.{}",[e,n]);r[i[1]]=t}return r}function zt(e,t=30,n="1.4"){let r={};for(var i of Mt.dict_to_list(e)){let e=i[0],s=i[1];r[e]=function(){Dt(String(s)),ce(String(s),t,n)}}return r}function Ht(e=30,t="1.4"){let n=zt(qt(),e,t);Lt(n),Ut.add("km",n)}let{get_json_from_url:Kt}=N,{OpenAI:Wt}=N.apis;var Gt=null;const Zt=N.logger.get_logger({id:"open_ai_web"});function Jt(){if(Gt)return Zt("OpenAI already initialized"),Gt;{Zt("Initializing open api in browser");let e=localStorage.OAAK;if(e)return Gt=new Wt({apiKey:e,dangerouslyAllowBrowser:!0}),Zt("Complete"),Gt;{let e='Unable to find API key; please make sure api key is under "OAAK" in local storage';return Zt(e),window.alert(e),1}}}async function Qt(e){Zt(`Request to speak ${e}`);let t=await Xt(e);return Zt("Retrieved audio data from openai"),Zt("Playing audio and returning data"),t.audio_element.play(),t}async function Xt(e){let t=await Yt(e),n=await t.blob(),r=URL.createObjectURL(n);return{audio_element:new Audio(r),blob:n}}async function Yt(e){let t=Jt();return await t.audio.speech.create({model:"tts-1",voice:"alloy",input:e})}async function en(e,t){return await Kt("https://www.tidyscripts.com/api/openai_davinci",{prompt:e,max_tokens:t})}function tn(e){return new WebTransport(e)}function nn(e){return(new TextEncoder).encode(JSON.stringify(e))}function rn(e){let t=tn(e);return{writer:t.datagrams.writable.getWriter(),transport:t}}async function sn(e,t){let n=nn(t);await e.write(n)}function an(e){let{writer:t,transport:n}=rn(e);return t.write_json=async function(e){await t.write(nn(e))},t}const on=function(e){const t=[];let n=0;for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=63&i|128):55296==(64512&i)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(i=65536+((1023&i)<<10)+(1023&e.charCodeAt(++r)),t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=63&i|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=63&i|128)}return t},cn={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let t=0;t<e.length;t+=3){const i=e[t],s=t+1<e.length,a=s?e[t+1]:0,o=t+2<e.length,c=o?e[t+2]:0,u=i>>2,l=(3&i)<<4|a>>4;let h=(15&a)<<2|c>>6,d=63&c;o||(d=64,s||(h=64)),r.push(n[u],n[l],n[h],n[d])}return r.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(on(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){const i=e[n++];if(i<128)t[r++]=String.fromCharCode(i);else if(i>191&&i<224){const s=e[n++];t[r++]=String.fromCharCode((31&i)<<6|63&s)}else if(i>239&&i<365){const s=((7&i)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536;t[r++]=String.fromCharCode(55296+(s>>10)),t[r++]=String.fromCharCode(56320+(1023&s))}else{const s=e[n++],a=e[n++];t[r++]=String.fromCharCode((15&i)<<12|(63&s)<<6|63&a)}}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const n=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let t=0;t<e.length;){const i=n[e.charAt(t++)],s=t<e.length?n[e.charAt(t)]:0;++t;const a=t<e.length?n[e.charAt(t)]:64;++t;const o=t<e.length?n[e.charAt(t)]:64;if(++t,null==i||null==s||null==a||null==o)throw new un;const c=i<<2|s>>4;if(r.push(c),64!==a){const e=s<<4&240|a>>2;if(r.push(e),64!==o){const e=a<<6&192|o;r.push(e)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class un extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const ln=function(e){return function(e){const t=on(e);return cn.encodeByteArray(t,!0)}(e).replace(/\./g,"")},hn=function(e){try{return cn.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null},dn=()=>{try{return function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==s.g)return s.g;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__||(()=>{if("undefined"==typeof process||void 0===process.env)return;const e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0})()||(()=>{if("undefined"==typeof document)return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}const t=e&&hn(e[1]);return t&&JSON.parse(t)})()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}},fn=e=>{var t,n;return null===(n=null===(t=dn())||void 0===t?void 0:t.emulatorHosts)||void 0===n?void 0:n[e]},pn=e=>{const t=fn(e);if(!t)return;const n=t.lastIndexOf(":");if(n<=0||n+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);const r=parseInt(t.substring(n+1),10);return"["===t[0]?[t.substring(1,n-1),r]:[t.substring(0,n),r]},mn=()=>{var e;return null===(e=dn())||void 0===e?void 0:e.config},gn=e=>{var t;return null===(t=dn())||void 0===t?void 0:t[`_${e}`]};class yn{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}wrapCallback(e){return(t,n)=>{t?this.reject(t):this.resolve(n),"function"==typeof e&&(this.promise.catch((()=>{})),1===e.length?e(t):e(t,n))}}}function vn(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}class _n extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,_n.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,wn.prototype.create)}}class wn{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){const n=t[0]||{},r=`${this.service}/${e}`,i=this.errors[e],s=i?function(e,t){return e.replace(bn,((e,n)=>{const r=t[n];return null!=r?String(r):`<${n}?>`}))}(i,n):"Error",a=`${this.serviceName}: ${s} (${r}).`;return new _n(r,a,n)}}const bn=/\{\$([^}]+)}/g;function En(e,t){if(e===t)return!0;const n=Object.keys(e),r=Object.keys(t);for(const i of n){if(!r.includes(i))return!1;const n=e[i],s=t[i];if(In(n)&&In(s)){if(!En(n,s))return!1}else if(n!==s)return!1}for(const e of r)if(!n.includes(e))return!1;return!0}function In(e){return null!==e&&"object"==typeof e}function Tn(e){const t=[];for(const[n,r]of Object.entries(e))Array.isArray(r)?r.forEach((e=>{t.push(encodeURIComponent(n)+"="+encodeURIComponent(e))})):t.push(encodeURIComponent(n)+"="+encodeURIComponent(r));return t.length?"&"+t.join("&"):""}function kn(e){const t={};return e.replace(/^\?/,"").split("&").forEach((e=>{if(e){const[n,r]=e.split("=");t[decodeURIComponent(n)]=decodeURIComponent(r)}})),t}function Sn(e){const t=e.indexOf("?");if(!t)return"";const n=e.indexOf("#",t);return e.substring(t,n>0?n:void 0)}class An{constructor(e,t){this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=t,this.task.then((()=>{e(this)})).catch((e=>{this.error(e)}))}next(e){this.forEachObserver((t=>{t.next(e)}))}error(e){this.forEachObserver((t=>{t.error(e)})),this.close(e)}complete(){this.forEachObserver((e=>{e.complete()})),this.close()}subscribe(e,t,n){let r;if(void 0===e&&void 0===t&&void 0===n)throw new Error("Missing Observer.");r=function(e,t){if("object"!=typeof e||null===e)return!1;for(const t of["next","error","complete"])if(t in e&&"function"==typeof e[t])return!0;return!1}(e)?e:{next:e,error:t,complete:n},void 0===r.next&&(r.next=On),void 0===r.error&&(r.error=On),void 0===r.complete&&(r.complete=On);const i=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then((()=>{try{this.finalError?r.error(this.finalError):r.complete()}catch(e){}})),this.observers.push(r),i}unsubscribeOne(e){void 0!==this.observers&&void 0!==this.observers[e]&&(delete this.observers[e],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))}forEachObserver(e){if(!this.finalized)for(let t=0;t<this.observers.length;t++)this.sendOne(t,e)}sendOne(e,t){this.task.then((()=>{if(void 0!==this.observers&&void 0!==this.observers[e])try{t(this.observers[e])}catch(e){"undefined"!=typeof console&&console.error&&console.error(e)}}))}close(e){this.finalized||(this.finalized=!0,void 0!==e&&(this.finalError=e),this.task.then((()=>{this.observers=void 0,this.onNoObservers=void 0})))}}function On(){}function xn(e){return e&&e._delegate?e._delegate:e}class Cn{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const Pn="[DEFAULT]";class Nn{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const n=new yn;if(this.instancesDeferred.set(t,n),this.isInitialized(t)||this.shouldAutoInitialize())try{const e=this.getOrInitializeService({instanceIdentifier:t});e&&n.resolve(e)}catch(e){}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const n=this.normalizeInstanceIdentifier(null==e?void 0:e.identifier),r=null!==(t=null==e?void 0:e.optional)&&void 0!==t&&t;if(!this.isInitialized(n)&&!this.shouldAutoInitialize()){if(r)return null;throw Error(`Service ${this.name} is not available`)}try{return this.getOrInitializeService({instanceIdentifier:n})}catch(e){if(r)return null;throw e}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()){if(function(e){return"EAGER"===e.instantiationMode}(e))try{this.getOrInitializeService({instanceIdentifier:Pn})}catch(e){}for(const[t,n]of this.instancesDeferred.entries()){const r=this.normalizeInstanceIdentifier(t);try{const e=this.getOrInitializeService({instanceIdentifier:r});n.resolve(e)}catch(e){}}}}clearInstance(e=Pn){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter((e=>"INTERNAL"in e)).map((e=>e.INTERNAL.delete())),...e.filter((e=>"_delete"in e)).map((e=>e._delete()))])}isComponentSet(){return null!=this.component}isInitialized(e=Pn){return this.instances.has(e)}getOptions(e=Pn){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,n=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(n))throw Error(`${this.name}(${n}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const r=this.getOrInitializeService({instanceIdentifier:n,options:t});for(const[e,t]of this.instancesDeferred.entries())n===this.normalizeInstanceIdentifier(e)&&t.resolve(r);return r}onInit(e,t){var n;const r=this.normalizeInstanceIdentifier(t),i=null!==(n=this.onInitCallbacks.get(r))&&void 0!==n?n:new Set;i.add(e),this.onInitCallbacks.set(r,i);const s=this.instances.get(r);return s&&e(s,r),()=>{i.delete(e)}}invokeOnInitCallbacks(e,t){const n=this.onInitCallbacks.get(t);if(n)for(const r of n)try{r(e,t)}catch(e){}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let n=this.instances.get(e);if(!n&&this.component&&(n=this.component.instanceFactory(this.container,{instanceIdentifier:(r=e,r===Pn?void 0:r),options:t}),this.instances.set(e,n),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(n,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,n)}catch(e){}var r;return n||null}normalizeInstanceIdentifier(e=Pn){return this.component?this.component.multipleInstances?e:Pn:e}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}}class Rn{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new Nn(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}const jn=[];var Ln;!function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(Ln||(Ln={}));const Dn={debug:Ln.DEBUG,verbose:Ln.VERBOSE,info:Ln.INFO,warn:Ln.WARN,error:Ln.ERROR,silent:Ln.SILENT},Mn=Ln.INFO,Un={[Ln.DEBUG]:"log",[Ln.VERBOSE]:"log",[Ln.INFO]:"info",[Ln.WARN]:"warn",[Ln.ERROR]:"error"},$n=(e,t,...n)=>{if(t<e.logLevel)return;const r=(new Date).toISOString(),i=Un[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)};class Fn{constructor(e){this.name=e,this._logLevel=Mn,this._logHandler=$n,this._userLogHandler=null,jn.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in Ln))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?Dn[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,Ln.DEBUG,...e),this._logHandler(this,Ln.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,Ln.VERBOSE,...e),this._logHandler(this,Ln.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,Ln.INFO,...e),this._logHandler(this,Ln.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,Ln.WARN,...e),this._logHandler(this,Ln.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,Ln.ERROR,...e),this._logHandler(this,Ln.ERROR,...e)}}const Bn=(e,t)=>t.some((t=>e instanceof t));let Vn,qn;const zn=new WeakMap,Hn=new WeakMap,Kn=new WeakMap,Wn=new WeakMap,Gn=new WeakMap;let Zn={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return Hn.get(e);if("objectStoreNames"===t)return e.objectStoreNames||Kn.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return Jn(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function Jn(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",s)},i=()=>{t(Jn(e.result)),r()},s=()=>{n(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",s)}));return t.then((t=>{t instanceof IDBCursor&&zn.set(t,e)})).catch((()=>{})),Gn.set(t,e),t}(e);if(Wn.has(e))return Wn.get(e);const t=function(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(qn||(qn=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(Qn(this),e),Jn(zn.get(this))}:function(...e){return Jn(t.apply(Qn(this),e))}:function(e,...n){const r=t.call(Qn(this),e,...n);return Kn.set(r,e.sort?e.sort():[e]),Jn(r)}:(e instanceof IDBTransaction&&function(e){if(Hn.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",s),e.removeEventListener("abort",s)},i=()=>{t(),r()},s=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",s),e.addEventListener("abort",s)}));Hn.set(e,t)}(e),Bn(e,Vn||(Vn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,Zn):e);var t}(e);return t!==e&&(Wn.set(e,t),Gn.set(t,e)),t}const Qn=e=>Gn.get(e),Xn=["get","getKey","getAll","getAllKeys","count"],Yn=["put","add","delete","clear"],er=new Map;function tr(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(er.get(t))return er.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=Yn.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!i&&!Xn.includes(n))return;const s=async function(e,...t){const s=this.transaction(e,i?"readwrite":"readonly");let a=s.store;return r&&(a=a.index(t.shift())),(await Promise.all([a[n](...t),i&&s.done]))[0]};return er.set(t,s),s}var nr;nr=Zn,Zn={...nr,get:(e,t,n)=>tr(e,t)||nr.get(e,t,n),has:(e,t)=>!!tr(e,t)||nr.has(e,t)};class rr{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map((e=>{if(function(e){const t=e.getComponent();return"VERSION"===(null==t?void 0:t.type)}(e)){const t=e.getImmediate();return`${t.library}/${t.version}`}return null})).filter((e=>e)).join(" ")}}const ir="@firebase/app",sr="0.10.5",ar=new Fn("@firebase/app"),or="@firebase/app-compat",cr="@firebase/analytics-compat",ur="@firebase/analytics",lr="@firebase/app-check-compat",hr="@firebase/app-check",dr="@firebase/auth",fr="@firebase/auth-compat",pr="@firebase/database",mr="@firebase/database-compat",gr="@firebase/functions",yr="@firebase/functions-compat",vr="@firebase/installations",_r="@firebase/installations-compat",wr="@firebase/messaging",br="@firebase/messaging-compat",Er="@firebase/performance",Ir="@firebase/performance-compat",Tr="@firebase/remote-config",kr="@firebase/remote-config-compat",Sr="@firebase/storage",Ar="@firebase/storage-compat",Or="@firebase/firestore",xr="@firebase/vertexai-preview",Cr="@firebase/firestore-compat",Pr="firebase",Nr="[DEFAULT]",Rr={[ir]:"fire-core",[or]:"fire-core-compat",[ur]:"fire-analytics",[cr]:"fire-analytics-compat",[hr]:"fire-app-check",[lr]:"fire-app-check-compat",[dr]:"fire-auth",[fr]:"fire-auth-compat",[pr]:"fire-rtdb",[mr]:"fire-rtdb-compat",[gr]:"fire-fn",[yr]:"fire-fn-compat",[vr]:"fire-iid",[_r]:"fire-iid-compat",[wr]:"fire-fcm",[br]:"fire-fcm-compat",[Er]:"fire-perf",[Ir]:"fire-perf-compat",[Tr]:"fire-rc",[kr]:"fire-rc-compat",[Sr]:"fire-gcs",[Ar]:"fire-gcs-compat",[Or]:"fire-fst",[Cr]:"fire-fst-compat",[xr]:"fire-vertex","fire-js":"fire-js",[Pr]:"fire-js-all"},jr=new Map,Lr=new Map,Dr=new Map;function Mr(e,t){try{e.container.addComponent(t)}catch(n){ar.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,n)}}function Ur(e){const t=e.name;if(Dr.has(t))return ar.debug(`There were multiple attempts to register component ${t}.`),!1;Dr.set(t,e);for(const t of jr.values())Mr(t,e);for(const t of Lr.values())Mr(t,e);return!0}function $r(e,t){const n=e.container.getProvider("heartbeat").getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}function Fr(e){return void 0!==e.settings}const Br=new wn("app","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."});class Vr{constructor(e,t,n){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=n,this.container.addComponent(new Cn("app",(()=>this),"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw Br.create("app-deleted",{appName:this._name})}}const qr="10.12.2";function zr(e,t={}){let n=e;"object"!=typeof t&&(t={name:t});const r=Object.assign({name:Nr,automaticDataCollectionEnabled:!1},t),i=r.name;if("string"!=typeof i||!i)throw Br.create("bad-app-name",{appName:String(i)});if(n||(n=mn()),!n)throw Br.create("no-options");const s=jr.get(i);if(s){if(En(n,s.options)&&En(r,s.config))return s;throw Br.create("duplicate-app",{appName:i})}const a=new Rn(i);for(const e of Dr.values())a.addComponent(e);const o=new Vr(n,r,a);return jr.set(i,o),o}function Hr(e=Nr){const t=jr.get(e);if(!t&&e===Nr&&mn())return zr();if(!t)throw Br.create("no-app",{appName:e});return t}function Kr(e,t,n){var r;let i=null!==(r=Rr[e])&&void 0!==r?r:e;n&&(i+=`-${n}`);const s=i.match(/\s|\//),a=t.match(/\s|\//);if(s||a){const e=[`Unable to register library "${i}" with version "${t}":`];return s&&e.push(`library name "${i}" contains illegal characters (whitespace or "/")`),s&&a&&e.push("and"),a&&e.push(`version name "${t}" contains illegal characters (whitespace or "/")`),void ar.warn(e.join(" "))}Ur(new Cn(`${i}-version`,(()=>({library:i,version:t})),"VERSION"))}const Wr="firebase-heartbeat-database",Gr=1,Zr="firebase-heartbeat-store";let Jr=null;function Qr(){return Jr||(Jr=function(e,t,{blocked:n,upgrade:r,blocking:i,terminated:s}={}){const a=indexedDB.open(e,t),o=Jn(a);return r&&a.addEventListener("upgradeneeded",(e=>{r(Jn(a.result),e.oldVersion,e.newVersion,Jn(a.transaction),e)})),n&&a.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),o.then((e=>{s&&e.addEventListener("close",(()=>s())),i&&e.addEventListener("versionchange",(e=>i(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),o}(Wr,Gr,{upgrade:(e,t)=>{if(0===t)try{e.createObjectStore(Zr)}catch(e){console.warn(e)}}}).catch((e=>{throw Br.create("idb-open",{originalErrorMessage:e.message})}))),Jr}async function Xr(e,t){try{const n=(await Qr()).transaction(Zr,"readwrite"),r=n.objectStore(Zr);await r.put(t,Yr(e)),await n.done}catch(e){if(e instanceof _n)ar.warn(e.message);else{const t=Br.create("idb-set",{originalErrorMessage:null==e?void 0:e.message});ar.warn(t.message)}}}function Yr(e){return`${e.name}!${e.options.appId}`}class ei{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new ni(t),this._heartbeatsCachePromise=this._storage.read().then((e=>(this._heartbeatsCache=e,e)))}async triggerHeartbeat(){var e,t;const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=ti();if((null!=(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||(this._heartbeatsCache=await this._heartbeatsCachePromise,null!=(null===(t=this._heartbeatsCache)||void 0===t?void 0:t.heartbeats)))&&this._heartbeatsCache.lastSentHeartbeatDate!==r&&!this._heartbeatsCache.heartbeats.some((e=>e.date===r)))return this._heartbeatsCache.heartbeats.push({date:r,agent:n}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter((e=>{const t=new Date(e.date).valueOf();return Date.now()-t<=2592e6})),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){var e;if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,null==(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||0===this._heartbeatsCache.heartbeats.length)return"";const t=ti(),{heartbeatsToSend:n,unsentEntries:r}=function(e,t=1024){const n=[];let r=e.slice();for(const i of e){const e=n.find((e=>e.agent===i.agent));if(e){if(e.dates.push(i.date),ri(n)>t){e.dates.pop();break}}else if(n.push({agent:i.agent,dates:[i.date]}),ri(n)>t){n.pop();break}r=r.slice(1)}return{heartbeatsToSend:n,unsentEntries:r}}(this._heartbeatsCache.heartbeats),i=ln(JSON.stringify({version:2,heartbeats:n}));return this._heartbeatsCache.lastSentHeartbeatDate=t,r.length>0?(this._heartbeatsCache.heartbeats=r,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),i}}function ti(){return(new Date).toISOString().substring(0,10)}class ni{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!function(){try{return"object"==typeof indexedDB}catch(e){return!1}}()&&new Promise(((e,t)=>{try{let n=!0;const r="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(r);i.onsuccess=()=>{i.result.close(),n||self.indexedDB.deleteDatabase(r),e(!0)},i.onupgradeneeded=()=>{n=!1},i.onerror=()=>{var e;t((null===(e=i.error)||void 0===e?void 0:e.message)||"")}}catch(e){t(e)}})).then((()=>!0)).catch((()=>!1))}async read(){if(await this._canUseIndexedDBPromise){const e=await async function(e){try{const t=(await Qr()).transaction(Zr),n=await t.objectStore(Zr).get(Yr(e));return await t.done,n}catch(e){if(e instanceof _n)ar.warn(e.message);else{const t=Br.create("idb-get",{originalErrorMessage:null==e?void 0:e.message});ar.warn(t.message)}}}(this.app);return(null==e?void 0:e.heartbeats)?e:{heartbeats:[]}}return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return Xr(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:e.heartbeats})}}async add(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return Xr(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...e.heartbeats]})}}}function ri(e){return ln(JSON.stringify({version:2,heartbeats:e})).length}function ii(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}Ur(new Cn("platform-logger",(e=>new rr(e)),"PRIVATE")),Ur(new Cn("heartbeat",(e=>new ei(e)),"PRIVATE")),Kr(ir,sr,""),Kr(ir,sr,"esm2017"),Kr("fire-js",""),Kr("firebase","10.12.2","app"),Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;const si=function(){return{"dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}},ai=new wn("auth","Firebase",{"dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}),oi=new Fn("@firebase/auth");function ci(e,...t){oi.logLevel<=Ln.ERROR&&oi.error(`Auth (${qr}): ${e}`,...t)}function ui(e,...t){throw fi(e,...t)}function li(e,...t){return fi(e,...t)}function hi(e,t,n){const r=Object.assign(Object.assign({},si()),{[t]:n});return new wn("auth","Firebase",r).create(t,{appName:e.name})}function di(e){return hi(e,"operation-not-supported-in-this-environment","Operations that alter the current user are not supported in conjunction with FirebaseServerApp")}function fi(e,...t){if("string"!=typeof e){const n=t[0],r=[...t.slice(1)];return r[0]&&(r[0].appName=e.name),e._errorFactory.create(n,...r)}return ai.create(e,...t)}function pi(e,t,...n){if(!e)throw fi(t,...n)}function mi(e){const t="INTERNAL ASSERTION FAILED: "+e;throw ci(t),new Error(t)}function gi(e,t){e||mi(t)}function yi(){var e;return"undefined"!=typeof self&&(null===(e=self.location)||void 0===e?void 0:e.href)||""}function vi(){var e;return"undefined"!=typeof self&&(null===(e=self.location)||void 0===e?void 0:e.protocol)||null}class _i{constructor(e,t){this.shortDelay=e,this.longDelay=t,gi(t>e,"Short delay should be less than long delay!"),this.isMobile="undefined"!=typeof window&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(vn())||"object"==typeof navigator&&"ReactNative"===navigator.product}get(){return"undefined"!=typeof navigator&&navigator&&"onLine"in navigator&&"boolean"==typeof navigator.onLine&&("http:"===vi()||"https:"===vi()||function(){const e="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0;return"object"==typeof e&&void 0!==e.id}()||"connection"in navigator)&&!navigator.onLine?Math.min(5e3,this.shortDelay):this.isMobile?this.longDelay:this.shortDelay}}function wi(e,t){gi(e.emulator,"Emulator should always be set here");const{url:n}=e.emulator;return t?`${n}${t.startsWith("/")?t.slice(1):t}`:n}class bi{static initialize(e,t,n){this.fetchImpl=e,t&&(this.headersImpl=t),n&&(this.responseImpl=n)}static fetch(){return this.fetchImpl?this.fetchImpl:"undefined"!=typeof self&&"fetch"in self?self.fetch:"undefined"!=typeof globalThis&&globalThis.fetch?globalThis.fetch:"undefined"!=typeof fetch?fetch:void mi("Could not find fetch implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static headers(){return this.headersImpl?this.headersImpl:"undefined"!=typeof self&&"Headers"in self?self.Headers:"undefined"!=typeof globalThis&&globalThis.Headers?globalThis.Headers:"undefined"!=typeof Headers?Headers:void mi("Could not find Headers implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static response(){return this.responseImpl?this.responseImpl:"undefined"!=typeof self&&"Response"in self?self.Response:"undefined"!=typeof globalThis&&globalThis.Response?globalThis.Response:"undefined"!=typeof Response?Response:void mi("Could not find Response implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}}const Ei={CREDENTIAL_MISMATCH:"custom-token-mismatch",MISSING_CUSTOM_TOKEN:"internal-error",INVALID_IDENTIFIER:"invalid-email",MISSING_CONTINUE_URI:"internal-error",INVALID_PASSWORD:"wrong-password",MISSING_PASSWORD:"missing-password",INVALID_LOGIN_CREDENTIALS:"invalid-credential",EMAIL_EXISTS:"email-already-in-use",PASSWORD_LOGIN_DISABLED:"operation-not-allowed",INVALID_IDP_RESPONSE:"invalid-credential",INVALID_PENDING_TOKEN:"invalid-credential",FEDERATED_USER_ID_ALREADY_LINKED:"credential-already-in-use",MISSING_REQ_TYPE:"internal-error",EMAIL_NOT_FOUND:"user-not-found",RESET_PASSWORD_EXCEED_LIMIT:"too-many-requests",EXPIRED_OOB_CODE:"expired-action-code",INVALID_OOB_CODE:"invalid-action-code",MISSING_OOB_CODE:"internal-error",CREDENTIAL_TOO_OLD_LOGIN_AGAIN:"requires-recent-login",INVALID_ID_TOKEN:"invalid-user-token",TOKEN_EXPIRED:"user-token-expired",USER_NOT_FOUND:"user-token-expired",TOO_MANY_ATTEMPTS_TRY_LATER:"too-many-requests",PASSWORD_DOES_NOT_MEET_REQUIREMENTS:"password-does-not-meet-requirements",INVALID_CODE:"invalid-verification-code",INVALID_SESSION_INFO:"invalid-verification-id",INVALID_TEMPORARY_PROOF:"invalid-credential",MISSING_SESSION_INFO:"missing-verification-id",SESSION_EXPIRED:"code-expired",MISSING_ANDROID_PACKAGE_NAME:"missing-android-pkg-name",UNAUTHORIZED_DOMAIN:"unauthorized-continue-uri",INVALID_OAUTH_CLIENT_ID:"invalid-oauth-client-id",ADMIN_ONLY_OPERATION:"admin-restricted-operation",INVALID_MFA_PENDING_CREDENTIAL:"invalid-multi-factor-session",MFA_ENROLLMENT_NOT_FOUND:"multi-factor-info-not-found",MISSING_MFA_ENROLLMENT_ID:"missing-multi-factor-info",MISSING_MFA_PENDING_CREDENTIAL:"missing-multi-factor-session",SECOND_FACTOR_EXISTS:"second-factor-already-in-use",SECOND_FACTOR_LIMIT_EXCEEDED:"maximum-second-factor-count-exceeded",BLOCKING_FUNCTION_ERROR_RESPONSE:"internal-error",RECAPTCHA_NOT_ENABLED:"recaptcha-not-enabled",MISSING_RECAPTCHA_TOKEN:"missing-recaptcha-token",INVALID_RECAPTCHA_TOKEN:"invalid-recaptcha-token",INVALID_RECAPTCHA_ACTION:"invalid-recaptcha-action",MISSING_CLIENT_TYPE:"missing-client-type",MISSING_RECAPTCHA_VERSION:"missing-recaptcha-version",INVALID_RECAPTCHA_VERSION:"invalid-recaptcha-version",INVALID_REQ_TYPE:"invalid-req-type"},Ii=new _i(3e4,6e4);function Ti(e,t){return e.tenantId&&!t.tenantId?Object.assign(Object.assign({},t),{tenantId:e.tenantId}):t}async function ki(e,t,n,r,i={}){return Si(e,i,(async()=>{let i={},s={};r&&("GET"===t?s=r:i={body:JSON.stringify(r)});const a=Tn(Object.assign({key:e.config.apiKey},s)).slice(1),o=await e._getAdditionalHeaders();return o["Content-Type"]="application/json",e.languageCode&&(o["X-Firebase-Locale"]=e.languageCode),bi.fetch()(Oi(e,e.config.apiHost,n,a),Object.assign({method:t,headers:o,referrerPolicy:"no-referrer"},i))}))}async function Si(e,t,n){e._canInitEmulator=!1;const r=Object.assign(Object.assign({},Ei),t);try{const t=new Ci(e),i=await Promise.race([n(),t.promise]);t.clearNetworkTimeout();const s=await i.json();if("needConfirmation"in s)throw Pi(e,"account-exists-with-different-credential",s);if(i.ok&&!("errorMessage"in s))return s;{const t=i.ok?s.errorMessage:s.error.message,[n,a]=t.split(" : ");if("FEDERATED_USER_ID_ALREADY_LINKED"===n)throw Pi(e,"credential-already-in-use",s);if("EMAIL_EXISTS"===n)throw Pi(e,"email-already-in-use",s);if("USER_DISABLED"===n)throw Pi(e,"user-disabled",s);const o=r[n]||n.toLowerCase().replace(/[_\s]+/g,"-");if(a)throw hi(e,o,a);ui(e,o)}}catch(t){if(t instanceof _n)throw t;ui(e,"network-request-failed",{message:String(t)})}}async function Ai(e,t,n,r,i={}){const s=await ki(e,t,n,r,i);return"mfaPendingCredential"in s&&ui(e,"multi-factor-auth-required",{_serverResponse:s}),s}function Oi(e,t,n,r){const i=`${t}${n}?${r}`;return e.config.emulator?wi(e.config,i):`${e.config.apiScheme}://${i}`}function xi(e){switch(e){case"ENFORCE":return"ENFORCE";case"AUDIT":return"AUDIT";case"OFF":return"OFF";default:return"ENFORCEMENT_STATE_UNSPECIFIED"}}class Ci{constructor(e){this.auth=e,this.timer=null,this.promise=new Promise(((e,t)=>{this.timer=setTimeout((()=>t(li(this.auth,"network-request-failed"))),Ii.get())}))}clearNetworkTimeout(){clearTimeout(this.timer)}}function Pi(e,t,n){const r={appName:e.name};n.email&&(r.email=n.email),n.phoneNumber&&(r.phoneNumber=n.phoneNumber);const i=li(e,t,r);return i.customData._tokenResponse=n,i}function Ni(e){return void 0!==e&&void 0!==e.enterprise}class Ri{constructor(e){if(this.siteKey="",this.recaptchaEnforcementState=[],void 0===e.recaptchaKey)throw new Error("recaptchaKey undefined");this.siteKey=e.recaptchaKey.split("/")[3],this.recaptchaEnforcementState=e.recaptchaEnforcementState}getProviderEnforcementState(e){if(!this.recaptchaEnforcementState||0===this.recaptchaEnforcementState.length)return null;for(const t of this.recaptchaEnforcementState)if(t.provider&&t.provider===e)return xi(t.enforcementState);return null}isProviderEnabled(e){return"ENFORCE"===this.getProviderEnforcementState(e)||"AUDIT"===this.getProviderEnforcementState(e)}}async function ji(e,t){return ki(e,"POST","/v1/accounts:lookup",t)}function Li(e){if(e)try{const t=new Date(Number(e));if(!isNaN(t.getTime()))return t.toUTCString()}catch(e){}}function Di(e){return 1e3*Number(e)}function Mi(e){const[t,n,r]=e.split(".");if(void 0===t||void 0===n||void 0===r)return ci("JWT malformed, contained fewer than 3 sections"),null;try{const e=hn(n);return e?JSON.parse(e):(ci("Failed to decode base64 JWT payload"),null)}catch(e){return ci("Caught error parsing JWT payload as JSON",null==e?void 0:e.toString()),null}}function Ui(e){const t=Mi(e);return pi(t,"internal-error"),pi(void 0!==t.exp,"internal-error"),pi(void 0!==t.iat,"internal-error"),Number(t.exp)-Number(t.iat)}async function $i(e,t,n=!1){if(n)return t;try{return await t}catch(t){throw t instanceof _n&&function({code:e}){return"auth/user-disabled"===e||"auth/user-token-expired"===e}(t)&&e.auth.currentUser===e&&await e.auth.signOut(),t}}class Fi{constructor(e){this.user=e,this.isRunning=!1,this.timerId=null,this.errorBackoff=3e4}_start(){this.isRunning||(this.isRunning=!0,this.schedule())}_stop(){this.isRunning&&(this.isRunning=!1,null!==this.timerId&&clearTimeout(this.timerId))}getInterval(e){var t;if(e){const e=this.errorBackoff;return this.errorBackoff=Math.min(2*this.errorBackoff,96e4),e}{this.errorBackoff=3e4;const e=(null!==(t=this.user.stsTokenManager.expirationTime)&&void 0!==t?t:0)-Date.now()-3e5;return Math.max(0,e)}}schedule(e=!1){if(!this.isRunning)return;const t=this.getInterval(e);this.timerId=setTimeout((async()=>{await this.iteration()}),t)}async iteration(){try{await this.user.getIdToken(!0)}catch(e){return void("auth/network-request-failed"===(null==e?void 0:e.code)&&this.schedule(!0))}this.schedule()}}class Bi{constructor(e,t){this.createdAt=e,this.lastLoginAt=t,this._initializeTime()}_initializeTime(){this.lastSignInTime=Li(this.lastLoginAt),this.creationTime=Li(this.createdAt)}_copy(e){this.createdAt=e.createdAt,this.lastLoginAt=e.lastLoginAt,this._initializeTime()}toJSON(){return{createdAt:this.createdAt,lastLoginAt:this.lastLoginAt}}}async function Vi(e){var t;const n=e.auth,r=await e.getIdToken(),i=await $i(e,ji(n,{idToken:r}));pi(null==i?void 0:i.users.length,n,"internal-error");const s=i.users[0];e._notifyReloadListener(s);const a=(null===(t=s.providerUserInfo)||void 0===t?void 0:t.length)?qi(s.providerUserInfo):[],o=(c=e.providerData,u=a,[...c.filter((e=>!u.some((t=>t.providerId===e.providerId)))),...u]);var c,u;const l=e.isAnonymous,h=!(e.email&&s.passwordHash||(null==o?void 0:o.length)),d=!!l&&h,f={uid:s.localId,displayName:s.displayName||null,photoURL:s.photoUrl||null,email:s.email||null,emailVerified:s.emailVerified||!1,phoneNumber:s.phoneNumber||null,tenantId:s.tenantId||null,providerData:o,metadata:new Bi(s.createdAt,s.lastLoginAt),isAnonymous:d};Object.assign(e,f)}function qi(e){return e.map((e=>{var{providerId:t}=e,n=ii(e,["providerId"]);return{providerId:t,uid:n.rawId||"",displayName:n.displayName||null,email:n.email||null,phoneNumber:n.phoneNumber||null,photoURL:n.photoUrl||null}}))}class zi{constructor(){this.refreshToken=null,this.accessToken=null,this.expirationTime=null}get isExpired(){return!this.expirationTime||Date.now()>this.expirationTime-3e4}updateFromServerResponse(e){pi(e.idToken,"internal-error"),pi(void 0!==e.idToken,"internal-error"),pi(void 0!==e.refreshToken,"internal-error");const t="expiresIn"in e&&void 0!==e.expiresIn?Number(e.expiresIn):Ui(e.idToken);this.updateTokensAndExpiration(e.idToken,e.refreshToken,t)}updateFromIdToken(e){pi(0!==e.length,"internal-error");const t=Ui(e);this.updateTokensAndExpiration(e,null,t)}async getToken(e,t=!1){return t||!this.accessToken||this.isExpired?(pi(this.refreshToken,e,"user-token-expired"),this.refreshToken?(await this.refresh(e,this.refreshToken),this.accessToken):null):this.accessToken}clearRefreshToken(){this.refreshToken=null}async refresh(e,t){const{accessToken:n,refreshToken:r,expiresIn:i}=await async function(e,t){const n=await Si(e,{},(async()=>{const n=Tn({grant_type:"refresh_token",refresh_token:t}).slice(1),{tokenApiHost:r,apiKey:i}=e.config,s=Oi(e,r,"/v1/token",`key=${i}`),a=await e._getAdditionalHeaders();return a["Content-Type"]="application/x-www-form-urlencoded",bi.fetch()(s,{method:"POST",headers:a,body:n})}));return{accessToken:n.access_token,expiresIn:n.expires_in,refreshToken:n.refresh_token}}(e,t);this.updateTokensAndExpiration(n,r,Number(i))}updateTokensAndExpiration(e,t,n){this.refreshToken=t||null,this.accessToken=e||null,this.expirationTime=Date.now()+1e3*n}static fromJSON(e,t){const{refreshToken:n,accessToken:r,expirationTime:i}=t,s=new zi;return n&&(pi("string"==typeof n,"internal-error",{appName:e}),s.refreshToken=n),r&&(pi("string"==typeof r,"internal-error",{appName:e}),s.accessToken=r),i&&(pi("number"==typeof i,"internal-error",{appName:e}),s.expirationTime=i),s}toJSON(){return{refreshToken:this.refreshToken,accessToken:this.accessToken,expirationTime:this.expirationTime}}_assign(e){this.accessToken=e.accessToken,this.refreshToken=e.refreshToken,this.expirationTime=e.expirationTime}_clone(){return Object.assign(new zi,this.toJSON())}_performRefresh(){return mi("not implemented")}}function Hi(e,t){pi("string"==typeof e||void 0===e,"internal-error",{appName:t})}class Ki{constructor(e){var{uid:t,auth:n,stsTokenManager:r}=e,i=ii(e,["uid","auth","stsTokenManager"]);this.providerId="firebase",this.proactiveRefresh=new Fi(this),this.reloadUserInfo=null,this.reloadListener=null,this.uid=t,this.auth=n,this.stsTokenManager=r,this.accessToken=r.accessToken,this.displayName=i.displayName||null,this.email=i.email||null,this.emailVerified=i.emailVerified||!1,this.phoneNumber=i.phoneNumber||null,this.photoURL=i.photoURL||null,this.isAnonymous=i.isAnonymous||!1,this.tenantId=i.tenantId||null,this.providerData=i.providerData?[...i.providerData]:[],this.metadata=new Bi(i.createdAt||void 0,i.lastLoginAt||void 0)}async getIdToken(e){const t=await $i(this,this.stsTokenManager.getToken(this.auth,e));return pi(t,this.auth,"internal-error"),this.accessToken!==t&&(this.accessToken=t,await this.auth._persistUserIfCurrent(this),this.auth._notifyListenersIfCurrent(this)),t}getIdTokenResult(e){return async function(e,t=!1){const n=xn(e),r=await n.getIdToken(t),i=Mi(r);pi(i&&i.exp&&i.auth_time&&i.iat,n.auth,"internal-error");const s="object"==typeof i.firebase?i.firebase:void 0,a=null==s?void 0:s.sign_in_provider;return{claims:i,token:r,authTime:Li(Di(i.auth_time)),issuedAtTime:Li(Di(i.iat)),expirationTime:Li(Di(i.exp)),signInProvider:a||null,signInSecondFactor:(null==s?void 0:s.sign_in_second_factor)||null}}(this,e)}reload(){return async function(e){const t=xn(e);await Vi(t),await t.auth._persistUserIfCurrent(t),t.auth._notifyListenersIfCurrent(t)}(this)}_assign(e){this!==e&&(pi(this.uid===e.uid,this.auth,"internal-error"),this.displayName=e.displayName,this.photoURL=e.photoURL,this.email=e.email,this.emailVerified=e.emailVerified,this.phoneNumber=e.phoneNumber,this.isAnonymous=e.isAnonymous,this.tenantId=e.tenantId,this.providerData=e.providerData.map((e=>Object.assign({},e))),this.metadata._copy(e.metadata),this.stsTokenManager._assign(e.stsTokenManager))}_clone(e){const t=new Ki(Object.assign(Object.assign({},this),{auth:e,stsTokenManager:this.stsTokenManager._clone()}));return t.metadata._copy(this.metadata),t}_onReload(e){pi(!this.reloadListener,this.auth,"internal-error"),this.reloadListener=e,this.reloadUserInfo&&(this._notifyReloadListener(this.reloadUserInfo),this.reloadUserInfo=null)}_notifyReloadListener(e){this.reloadListener?this.reloadListener(e):this.reloadUserInfo=e}_startProactiveRefresh(){this.proactiveRefresh._start()}_stopProactiveRefresh(){this.proactiveRefresh._stop()}async _updateTokensIfNecessary(e,t=!1){let n=!1;e.idToken&&e.idToken!==this.stsTokenManager.accessToken&&(this.stsTokenManager.updateFromServerResponse(e),n=!0),t&&await Vi(this),await this.auth._persistUserIfCurrent(this),n&&this.auth._notifyListenersIfCurrent(this)}async delete(){if(Fr(this.auth.app))return Promise.reject(di(this.auth));const e=await this.getIdToken();return await $i(this,async function(e,t){return ki(e,"POST","/v1/accounts:delete",t)}(this.auth,{idToken:e})),this.stsTokenManager.clearRefreshToken(),this.auth.signOut()}toJSON(){return Object.assign(Object.assign({uid:this.uid,email:this.email||void 0,emailVerified:this.emailVerified,displayName:this.displayName||void 0,isAnonymous:this.isAnonymous,photoURL:this.photoURL||void 0,phoneNumber:this.phoneNumber||void 0,tenantId:this.tenantId||void 0,providerData:this.providerData.map((e=>Object.assign({},e))),stsTokenManager:this.stsTokenManager.toJSON(),_redirectEventId:this._redirectEventId},this.metadata.toJSON()),{apiKey:this.auth.config.apiKey,appName:this.auth.name})}get refreshToken(){return this.stsTokenManager.refreshToken||""}static _fromJSON(e,t){var n,r,i,s,a,o,c,u;const l=null!==(n=t.displayName)&&void 0!==n?n:void 0,h=null!==(r=t.email)&&void 0!==r?r:void 0,d=null!==(i=t.phoneNumber)&&void 0!==i?i:void 0,f=null!==(s=t.photoURL)&&void 0!==s?s:void 0,p=null!==(a=t.tenantId)&&void 0!==a?a:void 0,m=null!==(o=t._redirectEventId)&&void 0!==o?o:void 0,g=null!==(c=t.createdAt)&&void 0!==c?c:void 0,y=null!==(u=t.lastLoginAt)&&void 0!==u?u:void 0,{uid:v,emailVerified:_,isAnonymous:w,providerData:b,stsTokenManager:E}=t;pi(v&&E,e,"internal-error");const I=zi.fromJSON(this.name,E);pi("string"==typeof v,e,"internal-error"),Hi(l,e.name),Hi(h,e.name),pi("boolean"==typeof _,e,"internal-error"),pi("boolean"==typeof w,e,"internal-error"),Hi(d,e.name),Hi(f,e.name),Hi(p,e.name),Hi(m,e.name),Hi(g,e.name),Hi(y,e.name);const T=new Ki({uid:v,auth:e,email:h,emailVerified:_,displayName:l,isAnonymous:w,photoURL:f,phoneNumber:d,tenantId:p,stsTokenManager:I,createdAt:g,lastLoginAt:y});return b&&Array.isArray(b)&&(T.providerData=b.map((e=>Object.assign({},e)))),m&&(T._redirectEventId=m),T}static async _fromIdTokenResponse(e,t,n=!1){const r=new zi;r.updateFromServerResponse(t);const i=new Ki({uid:t.localId,auth:e,stsTokenManager:r,isAnonymous:n});return await Vi(i),i}static async _fromGetAccountInfoResponse(e,t,n){const r=t.users[0];pi(void 0!==r.localId,"internal-error");const i=void 0!==r.providerUserInfo?qi(r.providerUserInfo):[],s=!(r.email&&r.passwordHash||(null==i?void 0:i.length)),a=new zi;a.updateFromIdToken(n);const o=new Ki({uid:r.localId,auth:e,stsTokenManager:a,isAnonymous:s}),c={uid:r.localId,displayName:r.displayName||null,photoURL:r.photoUrl||null,email:r.email||null,emailVerified:r.emailVerified||!1,phoneNumber:r.phoneNumber||null,tenantId:r.tenantId||null,providerData:i,metadata:new Bi(r.createdAt,r.lastLoginAt),isAnonymous:!(r.email&&r.passwordHash||(null==i?void 0:i.length))};return Object.assign(o,c),o}}const Wi=new Map;function Gi(e){gi(e instanceof Function,"Expected a class definition");let t=Wi.get(e);return t?(gi(t instanceof e,"Instance stored in cache mismatched with class"),t):(t=new e,Wi.set(e,t),t)}class Zi{constructor(){this.type="NONE",this.storage={}}async _isAvailable(){return!0}async _set(e,t){this.storage[e]=t}async _get(e){const t=this.storage[e];return void 0===t?null:t}async _remove(e){delete this.storage[e]}_addListener(e,t){}_removeListener(e,t){}}Zi.type="NONE";const Ji=Zi;function Qi(e,t,n){return`firebase:${e}:${t}:${n}`}class Xi{constructor(e,t,n){this.persistence=e,this.auth=t,this.userKey=n;const{config:r,name:i}=this.auth;this.fullUserKey=Qi(this.userKey,r.apiKey,i),this.fullPersistenceKey=Qi("persistence",r.apiKey,i),this.boundEventHandler=t._onStorageEvent.bind(t),this.persistence._addListener(this.fullUserKey,this.boundEventHandler)}setCurrentUser(e){return this.persistence._set(this.fullUserKey,e.toJSON())}async getCurrentUser(){const e=await this.persistence._get(this.fullUserKey);return e?Ki._fromJSON(this.auth,e):null}removeCurrentUser(){return this.persistence._remove(this.fullUserKey)}savePersistenceForRedirect(){return this.persistence._set(this.fullPersistenceKey,this.persistence.type)}async setPersistence(e){if(this.persistence===e)return;const t=await this.getCurrentUser();return await this.removeCurrentUser(),this.persistence=e,t?this.setCurrentUser(t):void 0}delete(){this.persistence._removeListener(this.fullUserKey,this.boundEventHandler)}static async create(e,t,n="authUser"){if(!t.length)return new Xi(Gi(Ji),e,n);const r=(await Promise.all(t.map((async e=>{if(await e._isAvailable())return e})))).filter((e=>e));let i=r[0]||Gi(Ji);const s=Qi(n,e.config.apiKey,e.name);let a=null;for(const n of t)try{const t=await n._get(s);if(t){const r=Ki._fromJSON(e,t);n!==i&&(a=r),i=n;break}}catch(e){}const o=r.filter((e=>e._shouldAllowMigration));return i._shouldAllowMigration&&o.length?(i=o[0],a&&await i._set(s,a.toJSON()),await Promise.all(t.map((async e=>{if(e!==i)try{await e._remove(s)}catch(e){}}))),new Xi(i,e,n)):new Xi(i,e,n)}}function Yi(e){const t=e.toLowerCase();if(t.includes("opera/")||t.includes("opr/")||t.includes("opios/"))return"Opera";if(rs(t))return"IEMobile";if(t.includes("msie")||t.includes("trident/"))return"IE";if(t.includes("edge/"))return"Edge";if(es(t))return"Firefox";if(t.includes("silk/"))return"Silk";if(ss(t))return"Blackberry";if(as(t))return"Webos";if(ts(t))return"Safari";if((t.includes("chrome/")||ns(t))&&!t.includes("edge/"))return"Chrome";if(is(t))return"Android";{const t=/([a-zA-Z\d\.]+)\/[a-zA-Z\d\.]*$/,n=e.match(t);if(2===(null==n?void 0:n.length))return n[1]}return"Other"}function es(e=vn()){return/firefox\//i.test(e)}function ts(e=vn()){const t=e.toLowerCase();return t.includes("safari/")&&!t.includes("chrome/")&&!t.includes("crios/")&&!t.includes("android")}function ns(e=vn()){return/crios\//i.test(e)}function rs(e=vn()){return/iemobile/i.test(e)}function is(e=vn()){return/android/i.test(e)}function ss(e=vn()){return/blackberry/i.test(e)}function as(e=vn()){return/webos/i.test(e)}function os(e=vn()){return/iphone|ipad|ipod/i.test(e)||/macintosh/i.test(e)&&/mobile/i.test(e)}function cs(e=vn()){return os(e)||is(e)||as(e)||ss(e)||/windows phone/i.test(e)||rs(e)}function us(e,t=[]){let n;switch(e){case"Browser":n=Yi(vn());break;case"Worker":n=`${Yi(vn())}-${e}`;break;default:n=e}const r=t.length?t.join(","):"FirebaseCore-web";return`${n}/JsCore/${qr}/${r}`}class ls{constructor(e){this.auth=e,this.queue=[]}pushCallback(e,t){const n=t=>new Promise(((n,r)=>{try{n(e(t))}catch(e){r(e)}}));n.onAbort=t,this.queue.push(n);const r=this.queue.length-1;return()=>{this.queue[r]=()=>Promise.resolve()}}async runMiddleware(e){if(this.auth.currentUser===e)return;const t=[];try{for(const n of this.queue)await n(e),n.onAbort&&t.push(n.onAbort)}catch(e){t.reverse();for(const n of t)try{n()}catch(e){}throw this.auth._errorFactory.create("login-blocked",{originalMessage:null==e?void 0:e.message})}}}class hs{constructor(e){var t,n,r,i;const s=e.customStrengthOptions;this.customStrengthOptions={},this.customStrengthOptions.minPasswordLength=null!==(t=s.minPasswordLength)&&void 0!==t?t:6,s.maxPasswordLength&&(this.customStrengthOptions.maxPasswordLength=s.maxPasswordLength),void 0!==s.containsLowercaseCharacter&&(this.customStrengthOptions.containsLowercaseLetter=s.containsLowercaseCharacter),void 0!==s.containsUppercaseCharacter&&(this.customStrengthOptions.containsUppercaseLetter=s.containsUppercaseCharacter),void 0!==s.containsNumericCharacter&&(this.customStrengthOptions.containsNumericCharacter=s.containsNumericCharacter),void 0!==s.containsNonAlphanumericCharacter&&(this.customStrengthOptions.containsNonAlphanumericCharacter=s.containsNonAlphanumericCharacter),this.enforcementState=e.enforcementState,"ENFORCEMENT_STATE_UNSPECIFIED"===this.enforcementState&&(this.enforcementState="OFF"),this.allowedNonAlphanumericCharacters=null!==(r=null===(n=e.allowedNonAlphanumericCharacters)||void 0===n?void 0:n.join(""))&&void 0!==r?r:"",this.forceUpgradeOnSignin=null!==(i=e.forceUpgradeOnSignin)&&void 0!==i&&i,this.schemaVersion=e.schemaVersion}validatePassword(e){var t,n,r,i,s,a;const o={isValid:!0,passwordPolicy:this};return this.validatePasswordLengthOptions(e,o),this.validatePasswordCharacterOptions(e,o),o.isValid&&(o.isValid=null===(t=o.meetsMinPasswordLength)||void 0===t||t),o.isValid&&(o.isValid=null===(n=o.meetsMaxPasswordLength)||void 0===n||n),o.isValid&&(o.isValid=null===(r=o.containsLowercaseLetter)||void 0===r||r),o.isValid&&(o.isValid=null===(i=o.containsUppercaseLetter)||void 0===i||i),o.isValid&&(o.isValid=null===(s=o.containsNumericCharacter)||void 0===s||s),o.isValid&&(o.isValid=null===(a=o.containsNonAlphanumericCharacter)||void 0===a||a),o}validatePasswordLengthOptions(e,t){const n=this.customStrengthOptions.minPasswordLength,r=this.customStrengthOptions.maxPasswordLength;n&&(t.meetsMinPasswordLength=e.length>=n),r&&(t.meetsMaxPasswordLength=e.length<=r)}validatePasswordCharacterOptions(e,t){let n;this.updatePasswordCharacterOptionsStatuses(t,!1,!1,!1,!1);for(let r=0;r<e.length;r++)n=e.charAt(r),this.updatePasswordCharacterOptionsStatuses(t,n>="a"&&n<="z",n>="A"&&n<="Z",n>="0"&&n<="9",this.allowedNonAlphanumericCharacters.includes(n))}updatePasswordCharacterOptionsStatuses(e,t,n,r,i){this.customStrengthOptions.containsLowercaseLetter&&(e.containsLowercaseLetter||(e.containsLowercaseLetter=t)),this.customStrengthOptions.containsUppercaseLetter&&(e.containsUppercaseLetter||(e.containsUppercaseLetter=n)),this.customStrengthOptions.containsNumericCharacter&&(e.containsNumericCharacter||(e.containsNumericCharacter=r)),this.customStrengthOptions.containsNonAlphanumericCharacter&&(e.containsNonAlphanumericCharacter||(e.containsNonAlphanumericCharacter=i))}}class ds{constructor(e,t,n,r){this.app=e,this.heartbeatServiceProvider=t,this.appCheckServiceProvider=n,this.config=r,this.currentUser=null,this.emulatorConfig=null,this.operations=Promise.resolve(),this.authStateSubscription=new ps(this),this.idTokenSubscription=new ps(this),this.beforeStateQueue=new ls(this),this.redirectUser=null,this.isProactiveRefreshEnabled=!1,this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION=1,this._canInitEmulator=!0,this._isInitialized=!1,this._deleted=!1,this._initializationPromise=null,this._popupRedirectResolver=null,this._errorFactory=ai,this._agentRecaptchaConfig=null,this._tenantRecaptchaConfigs={},this._projectPasswordPolicy=null,this._tenantPasswordPolicies={},this.lastNotifiedUid=void 0,this.languageCode=null,this.tenantId=null,this.settings={appVerificationDisabledForTesting:!1},this.frameworks=[],this.name=e.name,this.clientVersion=r.sdkClientVersion}_initializeWithPersistence(e,t){return t&&(this._popupRedirectResolver=Gi(t)),this._initializationPromise=this.queue((async()=>{var n,r;if(!this._deleted&&(this.persistenceManager=await Xi.create(this,e),!this._deleted)){if(null===(n=this._popupRedirectResolver)||void 0===n?void 0:n._shouldInitProactively)try{await this._popupRedirectResolver._initialize(this)}catch(e){}await this.initializeCurrentUser(t),this.lastNotifiedUid=(null===(r=this.currentUser)||void 0===r?void 0:r.uid)||null,this._deleted||(this._isInitialized=!0)}})),this._initializationPromise}async _onStorageEvent(){if(this._deleted)return;const e=await this.assertedPersistence.getCurrentUser();return this.currentUser||e?this.currentUser&&e&&this.currentUser.uid===e.uid?(this._currentUser._assign(e),void await this.currentUser.getIdToken()):void await this._updateCurrentUser(e,!0):void 0}async initializeCurrentUserFromIdToken(e){try{const t=await ji(this,{idToken:e}),n=await Ki._fromGetAccountInfoResponse(this,t,e);await this.directlySetCurrentUser(n)}catch(e){console.warn("FirebaseServerApp could not login user with provided authIdToken: ",e),await this.directlySetCurrentUser(null)}}async initializeCurrentUser(e){var t;if(Fr(this.app)){const e=this.app.settings.authIdToken;return e?new Promise((t=>{setTimeout((()=>this.initializeCurrentUserFromIdToken(e).then(t,t)))})):this.directlySetCurrentUser(null)}const n=await this.assertedPersistence.getCurrentUser();let r=n,i=!1;if(e&&this.config.authDomain){await this.getOrInitRedirectPersistenceManager();const n=null===(t=this.redirectUser)||void 0===t?void 0:t._redirectEventId,s=null==r?void 0:r._redirectEventId,a=await this.tryRedirectSignIn(e);n&&n!==s||!(null==a?void 0:a.user)||(r=a.user,i=!0)}if(!r)return this.directlySetCurrentUser(null);if(!r._redirectEventId){if(i)try{await this.beforeStateQueue.runMiddleware(r)}catch(e){r=n,this._popupRedirectResolver._overrideRedirectResult(this,(()=>Promise.reject(e)))}return r?this.reloadAndSetCurrentUserOrClear(r):this.directlySetCurrentUser(null)}return pi(this._popupRedirectResolver,this,"argument-error"),await this.getOrInitRedirectPersistenceManager(),this.redirectUser&&this.redirectUser._redirectEventId===r._redirectEventId?this.directlySetCurrentUser(r):this.reloadAndSetCurrentUserOrClear(r)}async tryRedirectSignIn(e){let t=null;try{t=await this._popupRedirectResolver._completeRedirectFn(this,e,!0)}catch(e){await this._setRedirectUser(null)}return t}async reloadAndSetCurrentUserOrClear(e){try{await Vi(e)}catch(e){if("auth/network-request-failed"!==(null==e?void 0:e.code))return this.directlySetCurrentUser(null)}return this.directlySetCurrentUser(e)}useDeviceLanguage(){this.languageCode=function(){if("undefined"==typeof navigator)return null;const e=navigator;return e.languages&&e.languages[0]||e.language||null}()}async _delete(){this._deleted=!0}async updateCurrentUser(e){if(Fr(this.app))return Promise.reject(di(this));const t=e?xn(e):null;return t&&pi(t.auth.config.apiKey===this.config.apiKey,this,"invalid-user-token"),this._updateCurrentUser(t&&t._clone(this))}async _updateCurrentUser(e,t=!1){if(!this._deleted)return e&&pi(this.tenantId===e.tenantId,this,"tenant-id-mismatch"),t||await this.beforeStateQueue.runMiddleware(e),this.queue((async()=>{await this.directlySetCurrentUser(e),this.notifyAuthListeners()}))}async signOut(){return Fr(this.app)?Promise.reject(di(this)):(await this.beforeStateQueue.runMiddleware(null),(this.redirectPersistenceManager||this._popupRedirectResolver)&&await this._setRedirectUser(null),this._updateCurrentUser(null,!0))}setPersistence(e){return Fr(this.app)?Promise.reject(di(this)):this.queue((async()=>{await this.assertedPersistence.setPersistence(Gi(e))}))}_getRecaptchaConfig(){return null==this.tenantId?this._agentRecaptchaConfig:this._tenantRecaptchaConfigs[this.tenantId]}async validatePassword(e){this._getPasswordPolicyInternal()||await this._updatePasswordPolicy();const t=this._getPasswordPolicyInternal();return t.schemaVersion!==this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION?Promise.reject(this._errorFactory.create("unsupported-password-policy-schema-version",{})):t.validatePassword(e)}_getPasswordPolicyInternal(){return null===this.tenantId?this._projectPasswordPolicy:this._tenantPasswordPolicies[this.tenantId]}async _updatePasswordPolicy(){const e=await async function(e,t={}){return ki(e,"GET","/v2/passwordPolicy",Ti(e,t))}(this),t=new hs(e);null===this.tenantId?this._projectPasswordPolicy=t:this._tenantPasswordPolicies[this.tenantId]=t}_getPersistence(){return this.assertedPersistence.persistence.type}_updateErrorMap(e){this._errorFactory=new wn("auth","Firebase",e())}onAuthStateChanged(e,t,n){return this.registerStateListener(this.authStateSubscription,e,t,n)}beforeAuthStateChanged(e,t){return this.beforeStateQueue.pushCallback(e,t)}onIdTokenChanged(e,t,n){return this.registerStateListener(this.idTokenSubscription,e,t,n)}authStateReady(){return new Promise(((e,t)=>{if(this.currentUser)e();else{const n=this.onAuthStateChanged((()=>{n(),e()}),t)}}))}async revokeAccessToken(e){if(this.currentUser){const t={providerId:"apple.com",tokenType:"ACCESS_TOKEN",token:e,idToken:await this.currentUser.getIdToken()};null!=this.tenantId&&(t.tenantId=this.tenantId),await async function(e,t){return ki(e,"POST","/v2/accounts:revokeToken",Ti(e,t))}(this,t)}}toJSON(){var e;return{apiKey:this.config.apiKey,authDomain:this.config.authDomain,appName:this.name,currentUser:null===(e=this._currentUser)||void 0===e?void 0:e.toJSON()}}async _setRedirectUser(e,t){const n=await this.getOrInitRedirectPersistenceManager(t);return null===e?n.removeCurrentUser():n.setCurrentUser(e)}async getOrInitRedirectPersistenceManager(e){if(!this.redirectPersistenceManager){const t=e&&Gi(e)||this._popupRedirectResolver;pi(t,this,"argument-error"),this.redirectPersistenceManager=await Xi.create(this,[Gi(t._redirectPersistence)],"redirectUser"),this.redirectUser=await this.redirectPersistenceManager.getCurrentUser()}return this.redirectPersistenceManager}async _redirectUserForId(e){var t,n;return this._isInitialized&&await this.queue((async()=>{})),(null===(t=this._currentUser)||void 0===t?void 0:t._redirectEventId)===e?this._currentUser:(null===(n=this.redirectUser)||void 0===n?void 0:n._redirectEventId)===e?this.redirectUser:null}async _persistUserIfCurrent(e){if(e===this.currentUser)return this.queue((async()=>this.directlySetCurrentUser(e)))}_notifyListenersIfCurrent(e){e===this.currentUser&&this.notifyAuthListeners()}_key(){return`${this.config.authDomain}:${this.config.apiKey}:${this.name}`}_startProactiveRefresh(){this.isProactiveRefreshEnabled=!0,this.currentUser&&this._currentUser._startProactiveRefresh()}_stopProactiveRefresh(){this.isProactiveRefreshEnabled=!1,this.currentUser&&this._currentUser._stopProactiveRefresh()}get _currentUser(){return this.currentUser}notifyAuthListeners(){var e,t;if(!this._isInitialized)return;this.idTokenSubscription.next(this.currentUser);const n=null!==(t=null===(e=this.currentUser)||void 0===e?void 0:e.uid)&&void 0!==t?t:null;this.lastNotifiedUid!==n&&(this.lastNotifiedUid=n,this.authStateSubscription.next(this.currentUser))}registerStateListener(e,t,n,r){if(this._deleted)return()=>{};const i="function"==typeof t?t:t.next.bind(t);let s=!1;const a=this._isInitialized?Promise.resolve():this._initializationPromise;if(pi(a,this,"internal-error"),a.then((()=>{s||i(this.currentUser)})),"function"==typeof t){const i=e.addObserver(t,n,r);return()=>{s=!0,i()}}{const n=e.addObserver(t);return()=>{s=!0,n()}}}async directlySetCurrentUser(e){this.currentUser&&this.currentUser!==e&&this._currentUser._stopProactiveRefresh(),e&&this.isProactiveRefreshEnabled&&e._startProactiveRefresh(),this.currentUser=e,e?await this.assertedPersistence.setCurrentUser(e):await this.assertedPersistence.removeCurrentUser()}queue(e){return this.operations=this.operations.then(e,e),this.operations}get assertedPersistence(){return pi(this.persistenceManager,this,"internal-error"),this.persistenceManager}_logFramework(e){e&&!this.frameworks.includes(e)&&(this.frameworks.push(e),this.frameworks.sort(),this.clientVersion=us(this.config.clientPlatform,this._getFrameworks()))}_getFrameworks(){return this.frameworks}async _getAdditionalHeaders(){var e;const t={"X-Client-Version":this.clientVersion};this.app.options.appId&&(t["X-Firebase-gmpid"]=this.app.options.appId);const n=await(null===(e=this.heartbeatServiceProvider.getImmediate({optional:!0}))||void 0===e?void 0:e.getHeartbeatsHeader());n&&(t["X-Firebase-Client"]=n);const r=await this._getAppCheckToken();return r&&(t["X-Firebase-AppCheck"]=r),t}async _getAppCheckToken(){var e;const t=await(null===(e=this.appCheckServiceProvider.getImmediate({optional:!0}))||void 0===e?void 0:e.getToken());return(null==t?void 0:t.error)&&function(e,...t){oi.logLevel<=Ln.WARN&&oi.warn(`Auth (${qr}): ${e}`,...t)}(`Error while retrieving App Check token: ${t.error}`),null==t?void 0:t.token}}function fs(e){return xn(e)}class ps{constructor(e){this.auth=e,this.observer=null,this.addObserver=function(e,t){const n=new An(e,void 0);return n.subscribe.bind(n)}((e=>this.observer=e))}get next(){return pi(this.observer,this.auth,"internal-error"),this.observer.next.bind(this.observer)}}let ms={async loadJS(){throw new Error("Unable to load external scripts")},recaptchaV2Script:"",recaptchaEnterpriseScript:"",gapiScript:""};function gs(e){return ms.loadJS(e)}function ys(e){return`__${e}${Math.floor(1e6*Math.random())}`}class vs{constructor(e){this.type="recaptcha-enterprise",this.auth=fs(e)}async verify(e="verify",t=!1){function n(t,n,r){const i=window.grecaptcha;Ni(i)?i.enterprise.ready((()=>{i.enterprise.execute(t,{action:e}).then((e=>{n(e)})).catch((()=>{n("NO_RECAPTCHA")}))})):r(Error("No reCAPTCHA enterprise script loaded."))}return new Promise(((e,r)=>{(async function(e){if(!t){if(null==e.tenantId&&null!=e._agentRecaptchaConfig)return e._agentRecaptchaConfig.siteKey;if(null!=e.tenantId&&void 0!==e._tenantRecaptchaConfigs[e.tenantId])return e._tenantRecaptchaConfigs[e.tenantId].siteKey}return new Promise((async(t,n)=>{(async function(e,t){return ki(e,"GET","/v2/recaptchaConfig",Ti(e,{clientType:"CLIENT_TYPE_WEB",version:"RECAPTCHA_ENTERPRISE"}))})(e).then((r=>{if(void 0!==r.recaptchaKey){const n=new Ri(r);return null==e.tenantId?e._agentRecaptchaConfig=n:e._tenantRecaptchaConfigs[e.tenantId]=n,t(n.siteKey)}n(new Error("recaptcha Enterprise site key undefined"))})).catch((e=>{n(e)}))}))})(this.auth).then((i=>{if(!t&&Ni(window.grecaptcha))n(i,e,r);else{if("undefined"==typeof window)return void r(new Error("RecaptchaVerifier is only supported in browser"));let t=ms.recaptchaEnterpriseScript;0!==t.length&&(t+=i),gs(t).then((()=>{n(i,e,r)})).catch((e=>{r(e)}))}})).catch((e=>{r(e)}))}))}}async function _s(e,t,n,r=!1){const i=new vs(e);let s;try{s=await i.verify(n)}catch(e){s=await i.verify(n,!0)}const a=Object.assign({},t);return r?Object.assign(a,{captchaResp:s}):Object.assign(a,{captchaResponse:s}),Object.assign(a,{clientType:"CLIENT_TYPE_WEB"}),Object.assign(a,{recaptchaVersion:"RECAPTCHA_ENTERPRISE"}),a}async function ws(e,t,n,r){var i;if(null===(i=e._getRecaptchaConfig())||void 0===i?void 0:i.isProviderEnabled("EMAIL_PASSWORD_PROVIDER")){const i=await _s(e,t,n,"getOobCode"===n);return r(e,i)}return r(e,t).catch((async i=>{if("auth/missing-recaptcha-token"===i.code){console.log(`${n} is protected by reCAPTCHA Enterprise for this project. Automatically triggering the reCAPTCHA flow and restarting the flow.`);const i=await _s(e,t,n,"getOobCode"===n);return r(e,i)}return Promise.reject(i)}))}function bs(e){const t=e.indexOf(":");return t<0?"":e.substr(0,t+1)}function Es(e){if(!e)return null;const t=Number(e);return isNaN(t)?null:t}class Is{constructor(e,t){this.providerId=e,this.signInMethod=t}toJSON(){return mi("not implemented")}_getIdTokenResponse(e){return mi("not implemented")}_linkToIdToken(e,t){return mi("not implemented")}_getReauthenticationResolver(e){return mi("not implemented")}}async function Ts(e,t){return ki(e,"POST","/v1/accounts:signUp",t)}async function ks(e,t){return Ai(e,"POST","/v1/accounts:signInWithPassword",Ti(e,t))}class Ss extends Is{constructor(e,t,n,r=null){super("password",n),this._email=e,this._password=t,this._tenantId=r}static _fromEmailAndPassword(e,t){return new Ss(e,t,"password")}static _fromEmailAndCode(e,t,n=null){return new Ss(e,t,"emailLink",n)}toJSON(){return{email:this._email,password:this._password,signInMethod:this.signInMethod,tenantId:this._tenantId}}static fromJSON(e){const t="string"==typeof e?JSON.parse(e):e;if((null==t?void 0:t.email)&&(null==t?void 0:t.password)){if("password"===t.signInMethod)return this._fromEmailAndPassword(t.email,t.password);if("emailLink"===t.signInMethod)return this._fromEmailAndCode(t.email,t.password,t.tenantId)}return null}async _getIdTokenResponse(e){switch(this.signInMethod){case"password":return ws(e,{returnSecureToken:!0,email:this._email,password:this._password,clientType:"CLIENT_TYPE_WEB"},"signInWithPassword",ks);case"emailLink":return async function(e,t){return Ai(e,"POST","/v1/accounts:signInWithEmailLink",Ti(e,t))}(e,{email:this._email,oobCode:this._password});default:ui(e,"internal-error")}}async _linkToIdToken(e,t){switch(this.signInMethod){case"password":return ws(e,{idToken:t,returnSecureToken:!0,email:this._email,password:this._password,clientType:"CLIENT_TYPE_WEB"},"signUpPassword",Ts);case"emailLink":return async function(e,t){return Ai(e,"POST","/v1/accounts:signInWithEmailLink",Ti(e,t))}(e,{idToken:t,email:this._email,oobCode:this._password});default:ui(e,"internal-error")}}_getReauthenticationResolver(e){return this._getIdTokenResponse(e)}}async function As(e,t){return Ai(e,"POST","/v1/accounts:signInWithIdp",Ti(e,t))}class Os extends Is{constructor(){super(...arguments),this.pendingToken=null}static _fromParams(e){const t=new Os(e.providerId,e.signInMethod);return e.idToken||e.accessToken?(e.idToken&&(t.idToken=e.idToken),e.accessToken&&(t.accessToken=e.accessToken),e.nonce&&!e.pendingToken&&(t.nonce=e.nonce),e.pendingToken&&(t.pendingToken=e.pendingToken)):e.oauthToken&&e.oauthTokenSecret?(t.accessToken=e.oauthToken,t.secret=e.oauthTokenSecret):ui("argument-error"),t}toJSON(){return{idToken:this.idToken,accessToken:this.accessToken,secret:this.secret,nonce:this.nonce,pendingToken:this.pendingToken,providerId:this.providerId,signInMethod:this.signInMethod}}static fromJSON(e){const t="string"==typeof e?JSON.parse(e):e,{providerId:n,signInMethod:r}=t,i=ii(t,["providerId","signInMethod"]);if(!n||!r)return null;const s=new Os(n,r);return s.idToken=i.idToken||void 0,s.accessToken=i.accessToken||void 0,s.secret=i.secret,s.nonce=i.nonce,s.pendingToken=i.pendingToken||null,s}_getIdTokenResponse(e){return As(e,this.buildRequest())}_linkToIdToken(e,t){const n=this.buildRequest();return n.idToken=t,As(e,n)}_getReauthenticationResolver(e){const t=this.buildRequest();return t.autoCreate=!1,As(e,t)}buildRequest(){const e={requestUri:"http://localhost",returnSecureToken:!0};if(this.pendingToken)e.pendingToken=this.pendingToken;else{const t={};this.idToken&&(t.id_token=this.idToken),this.accessToken&&(t.access_token=this.accessToken),this.secret&&(t.oauth_token_secret=this.secret),t.providerId=this.providerId,this.nonce&&!this.pendingToken&&(t.nonce=this.nonce),e.postBody=Tn(t)}return e}}const xs={USER_NOT_FOUND:"user-not-found"};class Cs extends Is{constructor(e){super("phone","phone"),this.params=e}static _fromVerification(e,t){return new Cs({verificationId:e,verificationCode:t})}static _fromTokenResponse(e,t){return new Cs({phoneNumber:e,temporaryProof:t})}_getIdTokenResponse(e){return async function(e,t){return Ai(e,"POST","/v1/accounts:signInWithPhoneNumber",Ti(e,t))}(e,this._makeVerificationRequest())}_linkToIdToken(e,t){return async function(e,t){const n=await Ai(e,"POST","/v1/accounts:signInWithPhoneNumber",Ti(e,t));if(n.temporaryProof)throw Pi(e,"account-exists-with-different-credential",n);return n}(e,Object.assign({idToken:t},this._makeVerificationRequest()))}_getReauthenticationResolver(e){return async function(e,t){return Ai(e,"POST","/v1/accounts:signInWithPhoneNumber",Ti(e,Object.assign(Object.assign({},t),{operation:"REAUTH"})),xs)}(e,this._makeVerificationRequest())}_makeVerificationRequest(){const{temporaryProof:e,phoneNumber:t,verificationId:n,verificationCode:r}=this.params;return e&&t?{temporaryProof:e,phoneNumber:t}:{sessionInfo:n,code:r}}toJSON(){const e={providerId:this.providerId};return this.params.phoneNumber&&(e.phoneNumber=this.params.phoneNumber),this.params.temporaryProof&&(e.temporaryProof=this.params.temporaryProof),this.params.verificationCode&&(e.verificationCode=this.params.verificationCode),this.params.verificationId&&(e.verificationId=this.params.verificationId),e}static fromJSON(e){"string"==typeof e&&(e=JSON.parse(e));const{verificationId:t,verificationCode:n,phoneNumber:r,temporaryProof:i}=e;return n||t||r||i?new Cs({verificationId:t,verificationCode:n,phoneNumber:r,temporaryProof:i}):null}}class Ps{constructor(e){var t,n,r,i,s,a;const o=kn(Sn(e)),c=null!==(t=o.apiKey)&&void 0!==t?t:null,u=null!==(n=o.oobCode)&&void 0!==n?n:null,l=function(e){switch(e){case"recoverEmail":return"RECOVER_EMAIL";case"resetPassword":return"PASSWORD_RESET";case"signIn":return"EMAIL_SIGNIN";case"verifyEmail":return"VERIFY_EMAIL";case"verifyAndChangeEmail":return"VERIFY_AND_CHANGE_EMAIL";case"revertSecondFactorAddition":return"REVERT_SECOND_FACTOR_ADDITION";default:return null}}(null!==(r=o.mode)&&void 0!==r?r:null);pi(c&&u&&l,"argument-error"),this.apiKey=c,this.operation=l,this.code=u,this.continueUrl=null!==(i=o.continueUrl)&&void 0!==i?i:null,this.languageCode=null!==(s=o.languageCode)&&void 0!==s?s:null,this.tenantId=null!==(a=o.tenantId)&&void 0!==a?a:null}static parseLink(e){const t=function(e){const t=kn(Sn(e)).link,n=t?kn(Sn(t)).deep_link_id:null,r=kn(Sn(e)).deep_link_id;return(r?kn(Sn(r)).link:null)||r||n||t||e}(e);try{return new Ps(t)}catch(e){return null}}}class Ns{constructor(){this.providerId=Ns.PROVIDER_ID}static credential(e,t){return Ss._fromEmailAndPassword(e,t)}static credentialWithLink(e,t){const n=Ps.parseLink(t);return pi(n,"argument-error"),Ss._fromEmailAndCode(e,n.code,n.tenantId)}}Ns.PROVIDER_ID="password",Ns.EMAIL_PASSWORD_SIGN_IN_METHOD="password",Ns.EMAIL_LINK_SIGN_IN_METHOD="emailLink";class Rs{constructor(e){this.providerId=e,this.defaultLanguageCode=null,this.customParameters={}}setDefaultLanguage(e){this.defaultLanguageCode=e}setCustomParameters(e){return this.customParameters=e,this}getCustomParameters(){return this.customParameters}}class js extends Rs{constructor(){super(...arguments),this.scopes=[]}addScope(e){return this.scopes.includes(e)||this.scopes.push(e),this}getScopes(){return[...this.scopes]}}class Ls extends js{constructor(){super("facebook.com")}static credential(e){return Os._fromParams({providerId:Ls.PROVIDER_ID,signInMethod:Ls.FACEBOOK_SIGN_IN_METHOD,accessToken:e})}static credentialFromResult(e){return Ls.credentialFromTaggedObject(e)}static credentialFromError(e){return Ls.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e||!("oauthAccessToken"in e))return null;if(!e.oauthAccessToken)return null;try{return Ls.credential(e.oauthAccessToken)}catch(e){return null}}}Ls.FACEBOOK_SIGN_IN_METHOD="facebook.com",Ls.PROVIDER_ID="facebook.com";class Ds extends js{constructor(){super("google.com"),this.addScope("profile")}static credential(e,t){return Os._fromParams({providerId:Ds.PROVIDER_ID,signInMethod:Ds.GOOGLE_SIGN_IN_METHOD,idToken:e,accessToken:t})}static credentialFromResult(e){return Ds.credentialFromTaggedObject(e)}static credentialFromError(e){return Ds.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;const{oauthIdToken:t,oauthAccessToken:n}=e;if(!t&&!n)return null;try{return Ds.credential(t,n)}catch(e){return null}}}Ds.GOOGLE_SIGN_IN_METHOD="google.com",Ds.PROVIDER_ID="google.com";class Ms extends js{constructor(){super("github.com")}static credential(e){return Os._fromParams({providerId:Ms.PROVIDER_ID,signInMethod:Ms.GITHUB_SIGN_IN_METHOD,accessToken:e})}static credentialFromResult(e){return Ms.credentialFromTaggedObject(e)}static credentialFromError(e){return Ms.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e||!("oauthAccessToken"in e))return null;if(!e.oauthAccessToken)return null;try{return Ms.credential(e.oauthAccessToken)}catch(e){return null}}}Ms.GITHUB_SIGN_IN_METHOD="github.com",Ms.PROVIDER_ID="github.com";class Us extends js{constructor(){super("twitter.com")}static credential(e,t){return Os._fromParams({providerId:Us.PROVIDER_ID,signInMethod:Us.TWITTER_SIGN_IN_METHOD,oauthToken:e,oauthTokenSecret:t})}static credentialFromResult(e){return Us.credentialFromTaggedObject(e)}static credentialFromError(e){return Us.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;const{oauthAccessToken:t,oauthTokenSecret:n}=e;if(!t||!n)return null;try{return Us.credential(t,n)}catch(e){return null}}}Us.TWITTER_SIGN_IN_METHOD="twitter.com",Us.PROVIDER_ID="twitter.com";class $s{constructor(e){this.user=e.user,this.providerId=e.providerId,this._tokenResponse=e._tokenResponse,this.operationType=e.operationType}static async _fromIdTokenResponse(e,t,n,r=!1){const i=await Ki._fromIdTokenResponse(e,n,r),s=Fs(n);return new $s({user:i,providerId:s,_tokenResponse:n,operationType:t})}static async _forOperation(e,t,n){await e._updateTokensIfNecessary(n,!0);const r=Fs(n);return new $s({user:e,providerId:r,_tokenResponse:n,operationType:t})}}function Fs(e){return e.providerId?e.providerId:"phoneNumber"in e?"phone":null}class Bs extends _n{constructor(e,t,n,r){var i;super(t.code,t.message),this.operationType=n,this.user=r,Object.setPrototypeOf(this,Bs.prototype),this.customData={appName:e.name,tenantId:null!==(i=e.tenantId)&&void 0!==i?i:void 0,_serverResponse:t.customData._serverResponse,operationType:n}}static _fromErrorAndOperation(e,t,n,r){return new Bs(e,t,n,r)}}function Vs(e,t,n,r){return("reauthenticate"===t?n._getReauthenticationResolver(e):n._getIdTokenResponse(e)).catch((n=>{if("auth/multi-factor-auth-required"===n.code)throw Bs._fromErrorAndOperation(e,n,t,r);throw n}))}new WeakMap;const qs="__sak";class zs{constructor(e,t){this.storageRetriever=e,this.type=t}_isAvailable(){try{return this.storage?(this.storage.setItem(qs,"1"),this.storage.removeItem(qs),Promise.resolve(!0)):Promise.resolve(!1)}catch(e){return Promise.resolve(!1)}}_set(e,t){return this.storage.setItem(e,JSON.stringify(t)),Promise.resolve()}_get(e){const t=this.storage.getItem(e);return Promise.resolve(t?JSON.parse(t):null)}_remove(e){return this.storage.removeItem(e),Promise.resolve()}get storage(){return this.storageRetriever()}}class Hs extends zs{constructor(){super((()=>window.localStorage),"LOCAL"),this.boundEventHandler=(e,t)=>this.onStorageEvent(e,t),this.listeners={},this.localCache={},this.pollTimer=null,this.safariLocalStorageNotSynced=function(){const e=vn();return ts(e)||os(e)}()&&function(){try{return!(!window||window===window.top)}catch(e){return!1}}(),this.fallbackToPolling=cs(),this._shouldAllowMigration=!0}forAllChangedKeys(e){for(const t of Object.keys(this.listeners)){const n=this.storage.getItem(t),r=this.localCache[t];n!==r&&e(t,r,n)}}onStorageEvent(e,t=!1){if(!e.key)return void this.forAllChangedKeys(((e,t,n)=>{this.notifyListeners(e,n)}));const n=e.key;if(t?this.detachListener():this.stopPolling(),this.safariLocalStorageNotSynced){const r=this.storage.getItem(n);if(e.newValue!==r)null!==e.newValue?this.storage.setItem(n,e.newValue):this.storage.removeItem(n);else if(this.localCache[n]===e.newValue&&!t)return}const r=()=>{const e=this.storage.getItem(n);(t||this.localCache[n]!==e)&&this.notifyListeners(n,e)},i=this.storage.getItem(n);!function(){const e=vn();return e.indexOf("MSIE ")>=0||e.indexOf("Trident/")>=0}()||10!==document.documentMode||i===e.newValue||e.newValue===e.oldValue?r():setTimeout(r,10)}notifyListeners(e,t){this.localCache[e]=t;const n=this.listeners[e];if(n)for(const e of Array.from(n))e(t?JSON.parse(t):t)}startPolling(){this.stopPolling(),this.pollTimer=setInterval((()=>{this.forAllChangedKeys(((e,t,n)=>{this.onStorageEvent(new StorageEvent("storage",{key:e,oldValue:t,newValue:n}),!0)}))}),1e3)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}attachListener(){window.addEventListener("storage",this.boundEventHandler)}detachListener(){window.removeEventListener("storage",this.boundEventHandler)}_addListener(e,t){0===Object.keys(this.listeners).length&&(this.fallbackToPolling?this.startPolling():this.attachListener()),this.listeners[e]||(this.listeners[e]=new Set,this.localCache[e]=this.storage.getItem(e)),this.listeners[e].add(t)}_removeListener(e,t){this.listeners[e]&&(this.listeners[e].delete(t),0===this.listeners[e].size&&delete this.listeners[e]),0===Object.keys(this.listeners).length&&(this.detachListener(),this.stopPolling())}async _set(e,t){await super._set(e,t),this.localCache[e]=JSON.stringify(t)}async _get(e){const t=await super._get(e);return this.localCache[e]=JSON.stringify(t),t}async _remove(e){await super._remove(e),delete this.localCache[e]}}Hs.type="LOCAL";const Ks=Hs;class Ws extends zs{constructor(){super((()=>window.sessionStorage),"SESSION")}_addListener(e,t){}_removeListener(e,t){}}Ws.type="SESSION";const Gs=Ws;class Zs{constructor(e){this.eventTarget=e,this.handlersMap={},this.boundEventHandler=this.handleEvent.bind(this)}static _getInstance(e){const t=this.receivers.find((t=>t.isListeningto(e)));if(t)return t;const n=new Zs(e);return this.receivers.push(n),n}isListeningto(e){return this.eventTarget===e}async handleEvent(e){const t=e,{eventId:n,eventType:r,data:i}=t.data,s=this.handlersMap[r];if(!(null==s?void 0:s.size))return;t.ports[0].postMessage({status:"ack",eventId:n,eventType:r});const a=Array.from(s).map((async e=>e(t.origin,i))),o=await function(e){return Promise.all(e.map((async e=>{try{return{fulfilled:!0,value:await e}}catch(e){return{fulfilled:!1,reason:e}}})))}(a);t.ports[0].postMessage({status:"done",eventId:n,eventType:r,response:o})}_subscribe(e,t){0===Object.keys(this.handlersMap).length&&this.eventTarget.addEventListener("message",this.boundEventHandler),this.handlersMap[e]||(this.handlersMap[e]=new Set),this.handlersMap[e].add(t)}_unsubscribe(e,t){this.handlersMap[e]&&t&&this.handlersMap[e].delete(t),t&&0!==this.handlersMap[e].size||delete this.handlersMap[e],0===Object.keys(this.handlersMap).length&&this.eventTarget.removeEventListener("message",this.boundEventHandler)}}function Js(e="",t=10){let n="";for(let e=0;e<t;e++)n+=Math.floor(10*Math.random());return e+n}Zs.receivers=[];class Qs{constructor(e){this.target=e,this.handlers=new Set}removeMessageHandler(e){e.messageChannel&&(e.messageChannel.port1.removeEventListener("message",e.onMessage),e.messageChannel.port1.close()),this.handlers.delete(e)}async _send(e,t,n=50){const r="undefined"!=typeof MessageChannel?new MessageChannel:null;if(!r)throw new Error("connection_unavailable");let i,s;return new Promise(((a,o)=>{const c=Js("",20);r.port1.start();const u=setTimeout((()=>{o(new Error("unsupported_event"))}),n);s={messageChannel:r,onMessage(e){const t=e;if(t.data.eventId===c)switch(t.data.status){case"ack":clearTimeout(u),i=setTimeout((()=>{o(new Error("timeout"))}),3e3);break;case"done":clearTimeout(i),a(t.data.response);break;default:clearTimeout(u),clearTimeout(i),o(new Error("invalid_response"))}}},this.handlers.add(s),r.port1.addEventListener("message",s.onMessage),this.target.postMessage({eventType:e,eventId:c,data:t},[r.port2])})).finally((()=>{s&&this.removeMessageHandler(s)}))}}function Xs(){return window}function Ys(){return void 0!==Xs().WorkerGlobalScope&&"function"==typeof Xs().importScripts}const ea="firebaseLocalStorageDb",ta="firebaseLocalStorage",na="fbase_key";class ra{constructor(e){this.request=e}toPromise(){return new Promise(((e,t)=>{this.request.addEventListener("success",(()=>{e(this.request.result)})),this.request.addEventListener("error",(()=>{t(this.request.error)}))}))}}function ia(e,t){return e.transaction([ta],t?"readwrite":"readonly").objectStore(ta)}function sa(){const e=indexedDB.open(ea,1);return new Promise(((t,n)=>{e.addEventListener("error",(()=>{n(e.error)})),e.addEventListener("upgradeneeded",(()=>{const t=e.result;try{t.createObjectStore(ta,{keyPath:na})}catch(e){n(e)}})),e.addEventListener("success",(async()=>{const n=e.result;n.objectStoreNames.contains(ta)?t(n):(n.close(),await function(){const e=indexedDB.deleteDatabase(ea);return new ra(e).toPromise()}(),t(await sa()))}))}))}async function aa(e,t,n){const r=ia(e,!0).put({[na]:t,value:n});return new ra(r).toPromise()}function oa(e,t){const n=ia(e,!0).delete(t);return new ra(n).toPromise()}class ca{constructor(){this.type="LOCAL",this._shouldAllowMigration=!0,this.listeners={},this.localCache={},this.pollTimer=null,this.pendingWrites=0,this.receiver=null,this.sender=null,this.serviceWorkerReceiverAvailable=!1,this.activeServiceWorker=null,this._workerInitializationPromise=this.initializeServiceWorkerMessaging().then((()=>{}),(()=>{}))}async _openDb(){return this.db||(this.db=await sa()),this.db}async _withRetries(e){let t=0;for(;;)try{const t=await this._openDb();return await e(t)}catch(e){if(t++>3)throw e;this.db&&(this.db.close(),this.db=void 0)}}async initializeServiceWorkerMessaging(){return Ys()?this.initializeReceiver():this.initializeSender()}async initializeReceiver(){this.receiver=Zs._getInstance(Ys()?self:null),this.receiver._subscribe("keyChanged",(async(e,t)=>({keyProcessed:(await this._poll()).includes(t.key)}))),this.receiver._subscribe("ping",(async(e,t)=>["keyChanged"]))}async initializeSender(){var e,t;if(this.activeServiceWorker=await async function(){if(!(null===navigator||void 0===navigator?void 0:navigator.serviceWorker))return null;try{return(await navigator.serviceWorker.ready).active}catch(e){return null}}(),!this.activeServiceWorker)return;this.sender=new Qs(this.activeServiceWorker);const n=await this.sender._send("ping",{},800);n&&(null===(e=n[0])||void 0===e?void 0:e.fulfilled)&&(null===(t=n[0])||void 0===t?void 0:t.value.includes("keyChanged"))&&(this.serviceWorkerReceiverAvailable=!0)}async notifyServiceWorker(e){var t;if(this.sender&&this.activeServiceWorker&&((null===(t=null===navigator||void 0===navigator?void 0:navigator.serviceWorker)||void 0===t?void 0:t.controller)||null)===this.activeServiceWorker)try{await this.sender._send("keyChanged",{key:e},this.serviceWorkerReceiverAvailable?800:50)}catch(t){}}async _isAvailable(){try{if(!indexedDB)return!1;const e=await sa();return await aa(e,qs,"1"),await oa(e,qs),!0}catch(e){}return!1}async _withPendingWrite(e){this.pendingWrites++;try{await e()}finally{this.pendingWrites--}}async _set(e,t){return this._withPendingWrite((async()=>(await this._withRetries((n=>aa(n,e,t))),this.localCache[e]=t,this.notifyServiceWorker(e))))}async _get(e){const t=await this._withRetries((t=>async function(e,t){const n=ia(e,!1).get(t),r=await new ra(n).toPromise();return void 0===r?null:r.value}(t,e)));return this.localCache[e]=t,t}async _remove(e){return this._withPendingWrite((async()=>(await this._withRetries((t=>oa(t,e))),delete this.localCache[e],this.notifyServiceWorker(e))))}async _poll(){const e=await this._withRetries((e=>{const t=ia(e,!1).getAll();return new ra(t).toPromise()}));if(!e)return[];if(0!==this.pendingWrites)return[];const t=[],n=new Set;if(0!==e.length)for(const{fbase_key:r,value:i}of e)n.add(r),JSON.stringify(this.localCache[r])!==JSON.stringify(i)&&(this.notifyListeners(r,i),t.push(r));for(const e of Object.keys(this.localCache))this.localCache[e]&&!n.has(e)&&(this.notifyListeners(e,null),t.push(e));return t}notifyListeners(e,t){this.localCache[e]=t;const n=this.listeners[e];if(n)for(const e of Array.from(n))e(t)}startPolling(){this.stopPolling(),this.pollTimer=setInterval((async()=>this._poll()),800)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}_addListener(e,t){0===Object.keys(this.listeners).length&&this.startPolling(),this.listeners[e]||(this.listeners[e]=new Set,this._get(e)),this.listeners[e].add(t)}_removeListener(e,t){this.listeners[e]&&(this.listeners[e].delete(t),0===this.listeners[e].size&&delete this.listeners[e]),0===Object.keys(this.listeners).length&&this.stopPolling()}}ca.type="LOCAL";const ua=ca;ys("rcb"),new _i(3e4,6e4);class la{constructor(e){this.providerId=la.PROVIDER_ID,this.auth=fs(e)}verifyPhoneNumber(e,t){return async function(e,t,n){var r;const i=await n.verify();try{let s;if(pi("string"==typeof i,e,"argument-error"),pi("recaptcha"===n.type,e,"argument-error"),s="string"==typeof t?{phoneNumber:t}:t,"session"in s){const t=s.session;if("phoneNumber"in s){pi("enroll"===t.type,e,"internal-error");const n=await function(e,t){return ki(e,"POST","/v2/accounts/mfaEnrollment:start",Ti(e,t))}(e,{idToken:t.credential,phoneEnrollmentInfo:{phoneNumber:s.phoneNumber,recaptchaToken:i}});return n.phoneSessionInfo.sessionInfo}{pi("signin"===t.type,e,"internal-error");const n=(null===(r=s.multiFactorHint)||void 0===r?void 0:r.uid)||s.multiFactorUid;pi(n,e,"missing-multi-factor-info");const a=await function(e,t){return ki(e,"POST","/v2/accounts/mfaSignIn:start",Ti(e,t))}(e,{mfaPendingCredential:t.credential,mfaEnrollmentId:n,phoneSignInInfo:{recaptchaToken:i}});return a.phoneResponseInfo.sessionInfo}}{const{sessionInfo:t}=await async function(e,t){return ki(e,"POST","/v1/accounts:sendVerificationCode",Ti(e,t))}(e,{phoneNumber:s.phoneNumber,recaptchaToken:i});return t}}finally{n._reset()}}(this.auth,e,xn(t))}static credential(e,t){return Cs._fromVerification(e,t)}static credentialFromResult(e){const t=e;return la.credentialFromTaggedObject(t)}static credentialFromError(e){return la.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject({_tokenResponse:e}){if(!e)return null;const{phoneNumber:t,temporaryProof:n}=e;return t&&n?Cs._fromTokenResponse(t,n):null}}function ha(e,t){return t?Gi(t):(pi(e._popupRedirectResolver,e,"argument-error"),e._popupRedirectResolver)}la.PROVIDER_ID="phone",la.PHONE_SIGN_IN_METHOD="phone";class da extends Is{constructor(e){super("custom","custom"),this.params=e}_getIdTokenResponse(e){return As(e,this._buildIdpRequest())}_linkToIdToken(e,t){return As(e,this._buildIdpRequest(t))}_getReauthenticationResolver(e){return As(e,this._buildIdpRequest())}_buildIdpRequest(e){const t={requestUri:this.params.requestUri,sessionId:this.params.sessionId,postBody:this.params.postBody,tenantId:this.params.tenantId,pendingToken:this.params.pendingToken,returnSecureToken:!0,returnIdpCredential:!0};return e&&(t.idToken=e),t}}function fa(e){return async function(e,t,n=!1){if(Fr(e.app))return Promise.reject(di(e));const r="signIn",i=await Vs(e,r,t),s=await $s._fromIdTokenResponse(e,r,i);return n||await e._updateCurrentUser(s.user),s}(e.auth,new da(e),e.bypassAuthState)}function pa(e){const{auth:t,user:n}=e;return pi(n,t,"internal-error"),async function(e,t,n=!1){const{auth:r}=e;if(Fr(r.app))return Promise.reject(di(r));const i="reauthenticate";try{const s=await $i(e,Vs(r,i,t,e),n);pi(s.idToken,r,"internal-error");const a=Mi(s.idToken);pi(a,r,"internal-error");const{sub:o}=a;return pi(e.uid===o,r,"user-mismatch"),$s._forOperation(e,i,s)}catch(e){throw"auth/user-not-found"===(null==e?void 0:e.code)&&ui(r,"user-mismatch"),e}}(n,new da(e),e.bypassAuthState)}async function ma(e){const{auth:t,user:n}=e;return pi(n,t,"internal-error"),async function(e,t,n=!1){const r=await $i(e,t._linkToIdToken(e.auth,await e.getIdToken()),n);return $s._forOperation(e,"link",r)}(n,new da(e),e.bypassAuthState)}class ga{constructor(e,t,n,r,i=!1){this.auth=e,this.resolver=n,this.user=r,this.bypassAuthState=i,this.pendingPromise=null,this.eventManager=null,this.filter=Array.isArray(t)?t:[t]}execute(){return new Promise((async(e,t)=>{this.pendingPromise={resolve:e,reject:t};try{this.eventManager=await this.resolver._initialize(this.auth),await this.onExecution(),this.eventManager.registerConsumer(this)}catch(e){this.reject(e)}}))}async onAuthEvent(e){const{urlResponse:t,sessionId:n,postBody:r,tenantId:i,error:s,type:a}=e;if(s)return void this.reject(s);const o={auth:this.auth,requestUri:t,sessionId:n,tenantId:i||void 0,postBody:r||void 0,user:this.user,bypassAuthState:this.bypassAuthState};try{this.resolve(await this.getIdpTask(a)(o))}catch(e){this.reject(e)}}onError(e){this.reject(e)}getIdpTask(e){switch(e){case"signInViaPopup":case"signInViaRedirect":return fa;case"linkViaPopup":case"linkViaRedirect":return ma;case"reauthViaPopup":case"reauthViaRedirect":return pa;default:ui(this.auth,"internal-error")}}resolve(e){gi(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.resolve(e),this.unregisterAndCleanUp()}reject(e){gi(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.reject(e),this.unregisterAndCleanUp()}unregisterAndCleanUp(){this.eventManager&&this.eventManager.unregisterConsumer(this),this.pendingPromise=null,this.cleanUp()}}const ya=new _i(2e3,1e4);class va extends ga{constructor(e,t,n,r,i){super(e,t,r,i),this.provider=n,this.authWindow=null,this.pollId=null,va.currentPopupAction&&va.currentPopupAction.cancel(),va.currentPopupAction=this}async executeNotNull(){const e=await this.execute();return pi(e,this.auth,"internal-error"),e}async onExecution(){gi(1===this.filter.length,"Popup operations only handle one event");const e=Js();this.authWindow=await this.resolver._openPopup(this.auth,this.provider,this.filter[0],e),this.authWindow.associatedEvent=e,this.resolver._originValidation(this.auth).catch((e=>{this.reject(e)})),this.resolver._isIframeWebStorageSupported(this.auth,(e=>{e||this.reject(li(this.auth,"web-storage-unsupported"))})),this.pollUserCancellation()}get eventId(){var e;return(null===(e=this.authWindow)||void 0===e?void 0:e.associatedEvent)||null}cancel(){this.reject(li(this.auth,"cancelled-popup-request"))}cleanUp(){this.authWindow&&this.authWindow.close(),this.pollId&&window.clearTimeout(this.pollId),this.authWindow=null,this.pollId=null,va.currentPopupAction=null}pollUserCancellation(){const e=()=>{var t,n;(null===(n=null===(t=this.authWindow)||void 0===t?void 0:t.window)||void 0===n?void 0:n.closed)?this.pollId=window.setTimeout((()=>{this.pollId=null,this.reject(li(this.auth,"popup-closed-by-user"))}),8e3):this.pollId=window.setTimeout(e,ya.get())};e()}}va.currentPopupAction=null;const _a="pendingRedirect",wa=new Map;class ba extends ga{constructor(e,t,n=!1){super(e,["signInViaRedirect","linkViaRedirect","reauthViaRedirect","unknown"],t,void 0,n),this.eventId=null}async execute(){let e=wa.get(this.auth._key());if(!e){try{const t=await async function(e,t){const n=Ta(t),r=Ia(e);if(!await r._isAvailable())return!1;const i="true"===await r._get(n);return await r._remove(n),i}(this.resolver,this.auth)?await super.execute():null;e=()=>Promise.resolve(t)}catch(t){e=()=>Promise.reject(t)}wa.set(this.auth._key(),e)}return this.bypassAuthState||wa.set(this.auth._key(),(()=>Promise.resolve(null))),e()}async onAuthEvent(e){if("signInViaRedirect"===e.type)return super.onAuthEvent(e);if("unknown"!==e.type){if(e.eventId){const t=await this.auth._redirectUserForId(e.eventId);if(t)return this.user=t,super.onAuthEvent(e);this.resolve(null)}}else this.resolve(null)}async onExecution(){}cleanUp(){}}function Ea(e,t){wa.set(e._key(),t)}function Ia(e){return Gi(e._redirectPersistence)}function Ta(e){return Qi(_a,e.config.apiKey,e.name)}function ka(e,t,n){return async function(e,t,n){if(Fr(e.app))return Promise.reject(di(e));const r=fs(e);(function(e,t,n){if(!(t instanceof n))throw n.name!==t.constructor.name&&ui(e,"argument-error"),hi(e,"argument-error",`Type of ${t.constructor.name} does not match expected instance.Did you pass a reference from a different Auth SDK?`)})(e,t,Rs),await r._initializationPromise;const i=ha(r,n);return await async function(e,t){return Ia(e)._set(Ta(t),"true")}(i,r),i._openRedirect(r,t,"signInViaRedirect")}(e,t,n)}async function Sa(e,t,n=!1){if(Fr(e.app))return Promise.reject(di(e));const r=fs(e),i=ha(r,t),s=new ba(r,i,n),a=await s.execute();return a&&!n&&(delete a.user._redirectEventId,await r._persistUserIfCurrent(a.user),await r._setRedirectUser(null,t)),a}class Aa{constructor(e){this.auth=e,this.cachedEventUids=new Set,this.consumers=new Set,this.queuedRedirectEvent=null,this.hasHandledPotentialRedirect=!1,this.lastProcessedEventTime=Date.now()}registerConsumer(e){this.consumers.add(e),this.queuedRedirectEvent&&this.isEventForConsumer(this.queuedRedirectEvent,e)&&(this.sendToConsumer(this.queuedRedirectEvent,e),this.saveEventToCache(this.queuedRedirectEvent),this.queuedRedirectEvent=null)}unregisterConsumer(e){this.consumers.delete(e)}onEvent(e){if(this.hasEventBeenHandled(e))return!1;let t=!1;return this.consumers.forEach((n=>{this.isEventForConsumer(e,n)&&(t=!0,this.sendToConsumer(e,n),this.saveEventToCache(e))})),this.hasHandledPotentialRedirect||!function(e){switch(e.type){case"signInViaRedirect":case"linkViaRedirect":case"reauthViaRedirect":return!0;case"unknown":return xa(e);default:return!1}}(e)||(this.hasHandledPotentialRedirect=!0,t||(this.queuedRedirectEvent=e,t=!0)),t}sendToConsumer(e,t){var n;if(e.error&&!xa(e)){const r=(null===(n=e.error.code)||void 0===n?void 0:n.split("auth/")[1])||"internal-error";t.onError(li(this.auth,r))}else t.onAuthEvent(e)}isEventForConsumer(e,t){const n=null===t.eventId||!!e.eventId&&e.eventId===t.eventId;return t.filter.includes(e.type)&&n}hasEventBeenHandled(e){return Date.now()-this.lastProcessedEventTime>=6e5&&this.cachedEventUids.clear(),this.cachedEventUids.has(Oa(e))}saveEventToCache(e){this.cachedEventUids.add(Oa(e)),this.lastProcessedEventTime=Date.now()}}function Oa(e){return[e.type,e.eventId,e.sessionId,e.tenantId].filter((e=>e)).join("-")}function xa({type:e,error:t}){return"unknown"===e&&"auth/no-auth-event"===(null==t?void 0:t.code)}const Ca=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,Pa=/^https?/;function Na(e){const t=yi(),{protocol:n,hostname:r}=new URL(t);if(e.startsWith("chrome-extension://")){const i=new URL(e);return""===i.hostname&&""===r?"chrome-extension:"===n&&e.replace("chrome-extension://","")===t.replace("chrome-extension://",""):"chrome-extension:"===n&&i.hostname===r}if(!Pa.test(n))return!1;if(Ca.test(e))return r===e;const i=e.replace(/\./g,"\\.");return new RegExp("^(.+\\."+i+"|"+i+")$","i").test(r)}const Ra=new _i(3e4,6e4);function ja(){const e=Xs().___jsl;if(null==e?void 0:e.H)for(const t of Object.keys(e.H))if(e.H[t].r=e.H[t].r||[],e.H[t].L=e.H[t].L||[],e.H[t].r=[...e.H[t].L],e.CP)for(let t=0;t<e.CP.length;t++)e.CP[t]=null}let La=null;const Da=new _i(5e3,15e3),Ma={style:{position:"absolute",top:"-100px",width:"1px",height:"1px"},"aria-hidden":"true",tabindex:"-1"},Ua=new Map([["identitytoolkit.googleapis.com","p"],["staging-identitytoolkit.sandbox.googleapis.com","s"],["test-identitytoolkit.sandbox.googleapis.com","t"]]);function $a(e){const t=e.config;pi(t.authDomain,e,"auth-domain-config-required");const n=t.emulator?wi(t,"emulator/auth/iframe"):`https://${e.config.authDomain}/__/auth/iframe`,r={apiKey:t.apiKey,appName:e.name,v:qr},i=Ua.get(e.config.apiHost);i&&(r.eid=i);const s=e._getFrameworks();return s.length&&(r.fw=s.join(",")),`${n}?${Tn(r).slice(1)}`}const Fa={location:"yes",resizable:"yes",statusbar:"yes",toolbar:"no"};class Ba{constructor(e){this.window=e,this.associatedEvent=null}close(){if(this.window)try{this.window.close()}catch(e){}}}const Va=encodeURIComponent("fac");async function qa(e,t,n,r,i,s){pi(e.config.authDomain,e,"auth-domain-config-required"),pi(e.config.apiKey,e,"invalid-api-key");const a={apiKey:e.config.apiKey,appName:e.name,authType:n,redirectUrl:r,v:qr,eventId:i};if(t instanceof Rs){t.setDefaultLanguage(e.languageCode),a.providerId=t.providerId||"",function(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}(t.getCustomParameters())||(a.customParameters=JSON.stringify(t.getCustomParameters()));for(const[e,t]of Object.entries(s||{}))a[e]=t}if(t instanceof js){const e=t.getScopes().filter((e=>""!==e));e.length>0&&(a.scopes=e.join(","))}e.tenantId&&(a.tid=e.tenantId);const o=a;for(const e of Object.keys(o))void 0===o[e]&&delete o[e];const c=await e._getAppCheckToken(),u=c?`#${Va}=${encodeURIComponent(c)}`:"";return`${function({config:e}){return e.emulator?wi(e,"emulator/auth/handler"):`https://${e.authDomain}/__/auth/handler`}(e)}?${Tn(o).slice(1)}${u}`}const za="webStorageSupport",Ha=class{constructor(){this.eventManagers={},this.iframes={},this.originValidationPromises={},this._redirectPersistence=Gs,this._completeRedirectFn=Sa,this._overrideRedirectResult=Ea}async _openPopup(e,t,n,r){var i;return gi(null===(i=this.eventManagers[e._key()])||void 0===i?void 0:i.manager,"_initialize() not called before _openPopup()"),function(e,t,n,r=500,i=600){const s=Math.max((window.screen.availHeight-i)/2,0).toString(),a=Math.max((window.screen.availWidth-r)/2,0).toString();let o="";const c=Object.assign(Object.assign({},Fa),{width:r.toString(),height:i.toString(),top:s,left:a}),u=vn().toLowerCase();n&&(o=ns(u)?"_blank":n),es(u)&&(t=t||"http://localhost",c.scrollbars="yes");const l=Object.entries(c).reduce(((e,[t,n])=>`${e}${t}=${n},`),"");if(function(e=vn()){var t;return os(e)&&!!(null===(t=window.navigator)||void 0===t?void 0:t.standalone)}(u)&&"_self"!==o)return function(e,t){const n=document.createElement("a");n.href=e,n.target=t;const r=document.createEvent("MouseEvent");r.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,1,null),n.dispatchEvent(r)}(t||"",o),new Ba(null);const h=window.open(t||"",o,l);pi(h,e,"popup-blocked");try{h.focus()}catch(e){}return new Ba(h)}(e,await qa(e,t,n,yi(),r),Js())}async _openRedirect(e,t,n,r){return await this._originValidation(e),i=await qa(e,t,n,yi(),r),Xs().location.href=i,new Promise((()=>{}));var i}_initialize(e){const t=e._key();if(this.eventManagers[t]){const{manager:e,promise:n}=this.eventManagers[t];return e?Promise.resolve(e):(gi(n,"If manager is not set, promise should be"),n)}const n=this.initAndGetManager(e);return this.eventManagers[t]={promise:n},n.catch((()=>{delete this.eventManagers[t]})),n}async initAndGetManager(e){const t=await async function(e){const t=await function(e){return La=La||function(e){return new Promise(((t,n)=>{var r,i,s;function a(){ja(),gapi.load("gapi.iframes",{callback:()=>{t(gapi.iframes.getContext())},ontimeout:()=>{ja(),n(li(e,"network-request-failed"))},timeout:Ra.get()})}if(null===(i=null===(r=Xs().gapi)||void 0===r?void 0:r.iframes)||void 0===i?void 0:i.Iframe)t(gapi.iframes.getContext());else{if(!(null===(s=Xs().gapi)||void 0===s?void 0:s.load)){const t=ys("iframefcb");return Xs()[t]=()=>{gapi.load?a():n(li(e,"network-request-failed"))},gs(`${ms.gapiScript}?onload=${t}`).catch((e=>n(e)))}a()}})).catch((e=>{throw La=null,e}))}(e),La}(e),n=Xs().gapi;return pi(n,e,"internal-error"),t.open({where:document.body,url:$a(e),messageHandlersFilter:n.iframes.CROSS_ORIGIN_IFRAMES_FILTER,attributes:Ma,dontclear:!0},(t=>new Promise((async(n,r)=>{await t.restyle({setHideOnLeave:!1});const i=li(e,"network-request-failed"),s=Xs().setTimeout((()=>{r(i)}),Da.get());function a(){Xs().clearTimeout(s),n(t)}t.ping(a).then(a,(()=>{r(i)}))}))))}(e),n=new Aa(e);return t.register("authEvent",(t=>(pi(null==t?void 0:t.authEvent,e,"invalid-auth-event"),{status:n.onEvent(t.authEvent)?"ACK":"ERROR"})),gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER),this.eventManagers[e._key()]={manager:n},this.iframes[e._key()]=t,n}_isIframeWebStorageSupported(e,t){this.iframes[e._key()].send(za,{type:za},(n=>{var r;const i=null===(r=null==n?void 0:n[0])||void 0===r?void 0:r[za];void 0!==i&&t(!!i),ui(e,"internal-error")}),gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER)}_originValidation(e){const t=e._key();return this.originValidationPromises[t]||(this.originValidationPromises[t]=async function(e){if(e.config.emulator)return;const{authorizedDomains:t}=await async function(e,t={}){return ki(e,"GET","/v1/projects",t)}(e);for(const n of t)try{if(Na(n))return}catch(e){}ui(e,"unauthorized-domain")}(e)),this.originValidationPromises[t]}get _shouldInitProactively(){return cs()||ts()||os()}};var Ka="@firebase/auth",Wa="1.7.4";class Ga{constructor(e){this.auth=e,this.internalListeners=new Map}getUid(){var e;return this.assertAuthConfigured(),(null===(e=this.auth.currentUser)||void 0===e?void 0:e.uid)||null}async getToken(e){return this.assertAuthConfigured(),await this.auth._initializationPromise,this.auth.currentUser?{accessToken:await this.auth.currentUser.getIdToken(e)}:null}addAuthTokenListener(e){if(this.assertAuthConfigured(),this.internalListeners.has(e))return;const t=this.auth.onIdTokenChanged((t=>{e((null==t?void 0:t.stsTokenManager.accessToken)||null)}));this.internalListeners.set(e,t),this.updateProactiveRefresh()}removeAuthTokenListener(e){this.assertAuthConfigured();const t=this.internalListeners.get(e);t&&(this.internalListeners.delete(e),t(),this.updateProactiveRefresh())}assertAuthConfigured(){pi(this.auth._initializationPromise,"dependent-sdk-initialized-before-auth")}updateProactiveRefresh(){this.internalListeners.size>0?this.auth._startProactiveRefresh():this.auth._stopProactiveRefresh()}}const Za=gn("authIdTokenMaxAge")||300;let Ja=null;const Qa=e=>async t=>{const n=t&&await t.getIdTokenResult(),r=n&&((new Date).getTime()-Date.parse(n.issuedAtTime))/1e3;if(r&&r>Za)return;const i=null==n?void 0:n.token;Ja!==i&&(Ja=i,await fetch(e,{method:i?"POST":"DELETE",headers:i?{Authorization:`Bearer ${i}`}:{}}))};var Xa,Ya;Xa={loadJS:e=>new Promise(((t,n)=>{const r=document.createElement("script");var i,s;r.setAttribute("src",e),r.onload=t,r.onerror=e=>{const t=li("internal-error");t.customData=e,n(t)},r.type="text/javascript",r.charset="UTF-8",(null!==(s=null===(i=document.getElementsByTagName("head"))||void 0===i?void 0:i[0])&&void 0!==s?s:document).appendChild(r)})),gapiScript:"https://apis.google.com/js/api.js",recaptchaV2Script:"https://www.google.com/recaptcha/api.js",recaptchaEnterpriseScript:"https://www.google.com/recaptcha/enterprise.js?render="},ms=Xa,Ya="Browser",Ur(new Cn("auth",((e,{options:t})=>{const n=e.getProvider("app").getImmediate(),r=e.getProvider("heartbeat"),i=e.getProvider("app-check-internal"),{apiKey:s,authDomain:a}=n.options;pi(s&&!s.includes(":"),"invalid-api-key",{appName:n.name});const o={apiKey:s,authDomain:a,clientPlatform:Ya,apiHost:"identitytoolkit.googleapis.com",tokenApiHost:"securetoken.googleapis.com",apiScheme:"https",sdkClientVersion:us(Ya)},c=new ds(n,r,i,o);return function(e,t){const n=(null==t?void 0:t.persistence)||[],r=(Array.isArray(n)?n:[n]).map(Gi);(null==t?void 0:t.errorMap)&&e._updateErrorMap(t.errorMap),e._initializeWithPersistence(r,null==t?void 0:t.popupRedirectResolver)}(c,t),c}),"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback(((e,t,n)=>{e.getProvider("auth-internal").initialize()}))),Ur(new Cn("auth-internal",(e=>{return t=fs(e.getProvider("auth").getImmediate()),new Ga(t);var t}),"PRIVATE").setInstantiationMode("EXPLICIT")),Kr(Ka,Wa,function(e){switch(e){case"Node":return"node";case"ReactNative":return"rn";case"Worker":return"webworker";case"Cordova":return"cordova";case"WebExtension":return"web-extension";default:return}}(Ya)),Kr(Ka,Wa,"esm2017");var eo,to,no="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},ro={};(function(){var e;function t(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}function n(e,t,n){n||(n=0);var r=Array(16);if("string"==typeof t)for(var i=0;16>i;++i)r[i]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(i=0;16>i;++i)r[i]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1],i=e.g[2];var s=e.g[3],a=t+(s^n&(i^s))+r[0]+3614090360&4294967295;a=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=n+(a<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[1]+3905402710&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[2]+606105819&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[3]+3250441966&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[4]+4118548399&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[5]+1200080426&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[6]+2821735955&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[7]+4249261313&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[8]+1770035416&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[9]+2336552879&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[10]+4294925233&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[11]+2304563134&4294967295)<<22&4294967295|a>>>10))+((a=t+(s^n&(i^s))+r[12]+1804603682&4294967295)<<7&4294967295|a>>>25))+((a=s+(i^t&(n^i))+r[13]+4254626195&4294967295)<<12&4294967295|a>>>20))+((a=i+(n^s&(t^n))+r[14]+2792965006&4294967295)<<17&4294967295|a>>>15))+((a=n+(t^i&(s^t))+r[15]+1236535329&4294967295)<<22&4294967295|a>>>10))+((a=t+(i^s&(n^i))+r[1]+4129170786&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[6]+3225465664&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[11]+643717713&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[0]+3921069994&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[5]+3593408605&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[10]+38016083&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[15]+3634488961&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[4]+3889429448&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[9]+568446438&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[14]+3275163606&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[3]+4107603335&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[8]+1163531501&4294967295)<<20&4294967295|a>>>12))+((a=t+(i^s&(n^i))+r[13]+2850285829&4294967295)<<5&4294967295|a>>>27))+((a=s+(n^i&(t^n))+r[2]+4243563512&4294967295)<<9&4294967295|a>>>23))+((a=i+(t^n&(s^t))+r[7]+1735328473&4294967295)<<14&4294967295|a>>>18))+((a=n+(s^t&(i^s))+r[12]+2368359562&4294967295)<<20&4294967295|a>>>12))+((a=t+(n^i^s)+r[5]+4294588738&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[8]+2272392833&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[11]+1839030562&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[14]+4259657740&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[1]+2763975236&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[4]+1272893353&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[7]+4139469664&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[10]+3200236656&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[13]+681279174&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[0]+3936430074&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[3]+3572445317&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[6]+76029189&4294967295)<<23&4294967295|a>>>9))+((a=t+(n^i^s)+r[9]+3654602809&4294967295)<<4&4294967295|a>>>28))+((a=s+(t^n^i)+r[12]+3873151461&4294967295)<<11&4294967295|a>>>21))+((a=i+(s^t^n)+r[15]+530742520&4294967295)<<16&4294967295|a>>>16))+((a=n+(i^s^t)+r[2]+3299628645&4294967295)<<23&4294967295|a>>>9))+((a=t+(i^(n|~s))+r[0]+4096336452&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[7]+1126891415&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[14]+2878612391&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[5]+4237533241&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[12]+1700485571&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[3]+2399980690&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[10]+4293915773&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[1]+2240044497&4294967295)<<21&4294967295|a>>>11))+((a=t+(i^(n|~s))+r[8]+1873313359&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[15]+4264355552&4294967295)<<10&4294967295|a>>>22))+((a=i+(t^(s|~n))+r[6]+2734768916&4294967295)<<15&4294967295|a>>>17))+((a=n+(s^(i|~t))+r[13]+1309151649&4294967295)<<21&4294967295|a>>>11))+((s=(t=n+((a=t+(i^(n|~s))+r[4]+4149444226&4294967295)<<6&4294967295|a>>>26))+((a=s+(n^(t|~i))+r[11]+3174756917&4294967295)<<10&4294967295|a>>>22))^((i=s+((a=i+(t^(s|~n))+r[2]+718787259&4294967295)<<15&4294967295|a>>>17))|~t))+r[9]+3951481745&4294967295,e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(i+(a<<21&4294967295|a>>>11))&4294967295,e.g[2]=e.g[2]+i&4294967295,e.g[3]=e.g[3]+s&4294967295}function r(e,t){this.h=t;for(var n=[],r=!0,i=e.length-1;0<=i;i--){var s=0|e[i];r&&s==t||(n[i]=s,r=!1)}this.g=n}!function(e,t){function n(){}n.prototype=t.prototype,e.D=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.C=function(e,n,r){for(var i=Array(arguments.length-2),s=2;s<arguments.length;s++)i[s-2]=arguments[s];return t.prototype[n].apply(e,i)}}(t,(function(){this.blockSize=-1})),t.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0},t.prototype.u=function(e,t){void 0===t&&(t=e.length);for(var r=t-this.blockSize,i=this.B,s=this.h,a=0;a<t;){if(0==s)for(;a<=r;)n(this,e,a),a+=this.blockSize;if("string"==typeof e){for(;a<t;)if(i[s++]=e.charCodeAt(a++),s==this.blockSize){n(this,i),s=0;break}}else for(;a<t;)if(i[s++]=e[a++],s==this.blockSize){n(this,i),s=0;break}}this.h=s,this.o+=t},t.prototype.v=function(){var e=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;var n=8*this.o;for(t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.u(e),e=Array(16),t=n=0;4>t;++t)for(var r=0;32>r;r+=8)e[n++]=this.g[t]>>>r&255;return e};var i={};function s(e){return-128<=e&&128>e?function(e,t){var n=i;return Object.prototype.hasOwnProperty.call(n,e)?n[e]:n[e]=function(e){return new r([0|e],0>e?-1:0)}(e)}(e):new r([0|e],0>e?-1:0)}function a(e){if(isNaN(e)||!isFinite(e))return o;if(0>e)return d(a(-e));for(var t=[],n=1,i=0;e>=n;i++)t[i]=e/n|0,n*=4294967296;return new r(t,0)}var o=s(0),c=s(1),u=s(16777216);function l(e){if(0!=e.h)return!1;for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return!1;return!0}function h(e){return-1==e.h}function d(e){for(var t=e.g.length,n=[],i=0;i<t;i++)n[i]=~e.g[i];return new r(n,~e.h).add(c)}function f(e,t){return e.add(d(t))}function p(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function m(e,t){this.g=e,this.h=t}function g(e,t){if(l(t))throw Error("division by zero");if(l(e))return new m(o,o);if(h(e))return t=g(d(e),t),new m(d(t.g),d(t.h));if(h(t))return t=g(e,d(t)),new m(d(t.g),t.h);if(30<e.g.length){if(h(e)||h(t))throw Error("slowDivide_ only works with positive integers.");for(var n=c,r=t;0>=r.l(e);)n=y(n),r=y(r);var i=v(n,1),s=v(r,1);for(r=v(r,2),n=v(n,2);!l(r);){var u=s.add(r);0>=u.l(e)&&(i=i.add(n),s=u),r=v(r,1),n=v(n,1)}return t=f(e,i.j(t)),new m(i,t)}for(i=o;0<=e.l(t);){for(n=Math.max(1,Math.floor(e.m()/t.m())),r=48>=(r=Math.ceil(Math.log(n)/Math.LN2))?1:Math.pow(2,r-48),u=(s=a(n)).j(t);h(u)||0<u.l(e);)u=(s=a(n-=r)).j(t);l(s)&&(s=c),i=i.add(s),e=f(e,u)}return new m(i,e)}function y(e){for(var t=e.g.length+1,n=[],i=0;i<t;i++)n[i]=e.i(i)<<1|e.i(i-1)>>>31;return new r(n,e.h)}function v(e,t){var n=t>>5;t%=32;for(var i=e.g.length-n,s=[],a=0;a<i;a++)s[a]=0<t?e.i(a+n)>>>t|e.i(a+n+1)<<32-t:e.i(a+n);return new r(s,e.h)}(e=r.prototype).m=function(){if(h(this))return-d(this).m();for(var e=0,t=1,n=0;n<this.g.length;n++){var r=this.i(n);e+=(0<=r?r:4294967296+r)*t,t*=4294967296}return e},e.toString=function(e){if(2>(e=e||10)||36<e)throw Error("radix out of range: "+e);if(l(this))return"0";if(h(this))return"-"+d(this).toString(e);for(var t=a(Math.pow(e,6)),n=this,r="";;){var i=g(n,t).g,s=((0<(n=f(n,i.j(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(l(n=i))return s+r;for(;6>s.length;)s="0"+s;r=s+r}},e.i=function(e){return 0>e?0:e<this.g.length?this.g[e]:this.h},e.l=function(e){return h(e=f(this,e))?-1:l(e)?0:1},e.abs=function(){return h(this)?d(this):this},e.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],i=0,s=0;s<=t;s++){var a=i+(65535&this.i(s))+(65535&e.i(s)),o=(a>>>16)+(this.i(s)>>>16)+(e.i(s)>>>16);i=o>>>16,a&=65535,o&=65535,n[s]=o<<16|a}return new r(n,-2147483648&n[n.length-1]?-1:0)},e.j=function(e){if(l(this)||l(e))return o;if(h(this))return h(e)?d(this).j(d(e)):d(d(this).j(e));if(h(e))return d(this.j(d(e)));if(0>this.l(u)&&0>e.l(u))return a(this.m()*e.m());for(var t=this.g.length+e.g.length,n=[],i=0;i<2*t;i++)n[i]=0;for(i=0;i<this.g.length;i++)for(var s=0;s<e.g.length;s++){var c=this.i(i)>>>16,f=65535&this.i(i),m=e.i(s)>>>16,g=65535&e.i(s);n[2*i+2*s]+=f*g,p(n,2*i+2*s),n[2*i+2*s+1]+=c*g,p(n,2*i+2*s+1),n[2*i+2*s+1]+=f*m,p(n,2*i+2*s+1),n[2*i+2*s+2]+=c*m,p(n,2*i+2*s+2)}for(i=0;i<t;i++)n[i]=n[2*i+1]<<16|n[2*i];for(i=t;i<2*t;i++)n[i]=0;return new r(n,0)},e.A=function(e){return g(this,e).h},e.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],i=0;i<t;i++)n[i]=this.i(i)&e.i(i);return new r(n,this.h&e.h)},e.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],i=0;i<t;i++)n[i]=this.i(i)|e.i(i);return new r(n,this.h|e.h)},e.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],i=0;i<t;i++)n[i]=this.i(i)^e.i(i);return new r(n,this.h^e.h)},t.prototype.digest=t.prototype.v,t.prototype.reset=t.prototype.s,t.prototype.update=t.prototype.u,to=ro.Md5=t,r.prototype.add=r.prototype.add,r.prototype.multiply=r.prototype.j,r.prototype.modulo=r.prototype.A,r.prototype.compare=r.prototype.l,r.prototype.toNumber=r.prototype.m,r.prototype.toString=r.prototype.toString,r.prototype.getBits=r.prototype.i,r.fromNumber=a,r.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if(2>(n=n||10)||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return d(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=a(Math.pow(n,8)),i=o,s=0;s<t.length;s+=8){var c=Math.min(8,t.length-s),u=parseInt(t.substring(s,s+c),n);8>c?(c=a(Math.pow(n,c)),i=i.j(c).add(a(u))):i=(i=i.j(r)).add(a(u))}return i},eo=ro.Integer=r}).apply(void 0!==no?no:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});var io,so,ao,oo,co,uo,lo,ho,fo,po="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},mo={};(function(){var e,t="function"==typeof Object.defineProperties?Object.defineProperty:function(e,t,n){return e==Array.prototype||e==Object.prototype||(e[t]=n.value),e},n=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof po&&po];for(var t=0;t<e.length;++t){var n=e[t];if(n&&n.Math==Math)return n}throw Error("Cannot find global object")}(this);!function(e,r){if(r)e:{var i=n;e=e.split(".");for(var s=0;s<e.length-1;s++){var a=e[s];if(!(a in i))break e;i=i[a]}(r=r(s=i[e=e[e.length-1]]))!=s&&null!=r&&t(i,e,{configurable:!0,writable:!0,value:r})}}("Array.prototype.values",(function(e){return e||function(){return function(e,t){e instanceof String&&(e+="");var n=0,r=!1,i={next:function(){if(!r&&n<e.length){var i=n++;return{value:t(0,e[i]),done:!1}}return r=!0,{done:!0,value:void 0}}};return i[Symbol.iterator]=function(){return i},i}(this,(function(e,t){return t}))}}));var r=r||{},i=this||self;function s(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function a(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}function o(e,t,n){return e.call.apply(e.bind,arguments)}function c(e,t,n){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),e.apply(t,n)}}return function(){return e.apply(t,arguments)}}function u(e,t,n){return(u=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?o:c).apply(null,arguments)}function l(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function h(e,t){function n(){}n.prototype=t.prototype,e.aa=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.Qb=function(e,n,r){for(var i=Array(arguments.length-2),s=2;s<arguments.length;s++)i[s-2]=arguments[s];return t.prototype[n].apply(e,i)}}function d(e){const t=e.length;if(0<t){const n=Array(t);for(let r=0;r<t;r++)n[r]=e[r];return n}return[]}function f(e,t){for(let t=1;t<arguments.length;t++){const n=arguments[t];if(s(n)){const t=e.length||0,r=n.length||0;e.length=t+r;for(let i=0;i<r;i++)e[t+i]=n[i]}else e.push(n)}}function p(e){return/^[\s\xa0]*$/.test(e)}function m(){var e=i.navigator;return e&&(e=e.userAgent)?e:""}function g(e){return g[" "](e),e}g[" "]=function(){};var y=!(-1==m().indexOf("Gecko")||-1!=m().toLowerCase().indexOf("webkit")&&-1==m().indexOf("Edge")||-1!=m().indexOf("Trident")||-1!=m().indexOf("MSIE")||-1!=m().indexOf("Edge"));function v(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function _(e){const t={};for(const n in e)t[n]=e[n];return t}const w="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function b(e,t){let n,r;for(let t=1;t<arguments.length;t++){for(n in r=arguments[t],r)e[n]=r[n];for(let t=0;t<w.length;t++)n=w[t],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function E(e){var t=1;e=e.split(":");const n=[];for(;0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}function I(e){i.setTimeout((()=>{throw e}),0)}function T(){var e=x;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}var k=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}((()=>new S),(e=>e.reset()));class S{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let A,O=!1,x=new class{constructor(){this.h=this.g=null}add(e,t){const n=k.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},C=()=>{const e=i.Promise.resolve(void 0);A=()=>{e.then(P)}};var P=()=>{for(var e;e=T();){try{e.h.call(e.g)}catch(e){I(e)}var t=k;t.j(e),100>t.h&&(t.h++,e.next=t.g,t.g=e)}O=!1};function N(){this.s=this.s,this.C=this.C}function R(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}N.prototype.s=!1,N.prototype.ma=function(){this.s||(this.s=!0,this.N())},N.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()},R.prototype.h=function(){this.defaultPrevented=!0};var j=function(){if(!i.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{const e=()=>{};i.addEventListener("test",e,t),i.removeEventListener("test",e,t)}catch(e){}return e}();function L(e,t){if(R.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(y){e:{try{g(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:D[e.pointerType]||"",this.state=e.state,this.i=e,e.defaultPrevented&&L.aa.h.call(this)}}h(L,R);var D={2:"touch",3:"pen",4:"mouse"};L.prototype.h=function(){L.aa.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var M="closure_listenable_"+(1e6*Math.random()|0),U=0;function $(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ha=i,this.key=++U,this.da=this.fa=!1}function F(e){e.da=!0,e.listener=null,e.proxy=null,e.src=null,e.ha=null}function B(e){this.src=e,this.g={},this.h=0}function V(e,t){var n=t.type;if(n in e.g){var r,i=e.g[n],s=Array.prototype.indexOf.call(i,t,void 0);(r=0<=s)&&Array.prototype.splice.call(i,s,1),r&&(F(t),0==e.g[n].length&&(delete e.g[n],e.h--))}}function q(e,t,n,r){for(var i=0;i<e.length;++i){var s=e[i];if(!s.da&&s.listener==t&&s.capture==!!n&&s.ha==r)return i}return-1}B.prototype.add=function(e,t,n,r,i){var s=e.toString();(e=this.g[s])||(e=this.g[s]=[],this.h++);var a=q(e,t,r,i);return-1<a?(t=e[a],n||(t.fa=!1)):((t=new $(t,this.src,s,!!r,i)).fa=n,e.push(t)),t};var z="closure_lm_"+(1e6*Math.random()|0),H={};function K(e,t,n,r,i){if(r&&r.once)return G(e,t,n,r,i);if(Array.isArray(t)){for(var s=0;s<t.length;s++)K(e,t[s],n,r,i);return null}return n=te(n),e&&e[M]?e.K(t,n,a(r)?!!r.capture:!!r,i):W(e,t,n,!1,r,i)}function W(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");var o=a(i)?!!i.capture:!!i,c=Y(e);if(c||(e[z]=c=new B(e)),(n=c.add(t,n,r,o,s)).proxy)return n;if(r=function(){const e=X;return function t(n){return e.call(t.src,t.listener,n)}}(),n.proxy=r,r.src=e,r.listener=n,e.addEventListener)j||(i=o),void 0===i&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(Q(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function G(e,t,n,r,i){if(Array.isArray(t)){for(var s=0;s<t.length;s++)G(e,t[s],n,r,i);return null}return n=te(n),e&&e[M]?e.L(t,n,a(r)?!!r.capture:!!r,i):W(e,t,n,!0,r,i)}function Z(e,t,n,r,i){if(Array.isArray(t))for(var s=0;s<t.length;s++)Z(e,t[s],n,r,i);else r=a(r)?!!r.capture:!!r,n=te(n),e&&e[M]?(e=e.i,(t=String(t).toString())in e.g&&-1<(n=q(s=e.g[t],n,r,i))&&(F(s[n]),Array.prototype.splice.call(s,n,1),0==s.length&&(delete e.g[t],e.h--))):e&&(e=Y(e))&&(t=e.g[t.toString()],e=-1,t&&(e=q(t,n,r,i)),(n=-1<e?t[e]:null)&&J(n))}function J(e){if("number"!=typeof e&&e&&!e.da){var t=e.src;if(t&&t[M])V(t.i,e);else{var n=e.type,r=e.proxy;t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(Q(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=Y(t))?(V(n,e),0==n.h&&(n.src=null,t[z]=null)):F(e)}}}function Q(e){return e in H?H[e]:H[e]="on"+e}function X(e,t){if(e.da)e=!0;else{t=new L(t,this);var n=e.listener,r=e.ha||e.src;e.fa&&J(e),e=n.call(r,t)}return e}function Y(e){return(e=e[z])instanceof B?e:null}var ee="__closure_events_fn_"+(1e9*Math.random()>>>0);function te(e){return"function"==typeof e?e:(e[ee]||(e[ee]=function(t){return e.handleEvent(t)}),e[ee])}function ne(){N.call(this),this.i=new B(this),this.M=this,this.F=null}function re(e,t){var n,r=e.F;if(r)for(n=[];r;r=r.F)n.push(r);if(e=e.M,r=t.type||t,"string"==typeof t)t=new R(t,e);else if(t instanceof R)t.target=t.target||e;else{var i=t;b(t=new R(r,e),i)}if(i=!0,n)for(var s=n.length-1;0<=s;s--){var a=t.g=n[s];i=ie(a,r,!0,t)&&i}if(i=ie(a=t.g=e,r,!0,t)&&i,i=ie(a,r,!1,t)&&i,n)for(s=0;s<n.length;s++)i=ie(a=t.g=n[s],r,!1,t)&&i}function ie(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var a=t[s];if(a&&!a.da&&a.capture==n){var o=a.listener,c=a.ha||a.src;a.fa&&V(e.i,a),i=!1!==o.call(c,r)&&i}}return i&&!r.defaultPrevented}function se(e,t,n){if("function"==typeof e)n&&(e=u(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=u(e.handleEvent,e)}return 2147483647<Number(t)?-1:i.setTimeout(e,t||0)}function ae(e){e.g=se((()=>{e.g=null,e.i&&(e.i=!1,ae(e))}),e.l);const t=e.h;e.h=null,e.m.apply(null,t)}h(ne,N),ne.prototype[M]=!0,ne.prototype.removeEventListener=function(e,t,n,r){Z(this,e,t,n,r)},ne.prototype.N=function(){if(ne.aa.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)F(n[r]);delete t.g[e],t.h--}}this.F=null},ne.prototype.K=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},ne.prototype.L=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};class oe extends N{constructor(e,t){super(),this.m=e,this.l=t,this.h=null,this.i=!1,this.g=null}j(e){this.h=arguments,this.g?this.i=!0:ae(this)}N(){super.N(),this.g&&(i.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ce(e){N.call(this),this.h=e,this.g={}}h(ce,N);var ue=[];function le(e){v(e.g,(function(e,t){this.g.hasOwnProperty(t)&&J(e)}),e),e.g={}}ce.prototype.N=function(){ce.aa.N.call(this),le(this)},ce.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var he=i.JSON.stringify,de=i.JSON.parse,fe=class{stringify(e){return i.JSON.stringify(e,void 0)}parse(e){return i.JSON.parse(e,void 0)}};function pe(){}function me(e){return e.h||(e.h=e.i())}function ge(){}pe.prototype.h=null;var ye={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function ve(){R.call(this,"d")}function _e(){R.call(this,"c")}h(ve,R),h(_e,R);var we={},be=null;function Ee(){return be=be||new ne}function Ie(e){R.call(this,we.La,e)}function Te(e){const t=Ee();re(t,new Ie(t))}function ke(e,t){R.call(this,we.STAT_EVENT,e),this.stat=t}function Se(e){const t=Ee();re(t,new ke(t,e))}function Ae(e,t){R.call(this,we.Ma,e),this.size=t}function Oe(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return i.setTimeout((function(){e()}),t)}function xe(){this.g=!0}function Ce(e,t,n,r){e.info((function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(2>r.length)){var i=r[1];if(Array.isArray(i)&&!(1>i.length)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var a=1;a<i.length;a++)i[a]=""}}}return he(n)}catch(e){return t}}(e,n)+(r?" "+r:"")}))}we.La="serverreachability",h(Ie,R),we.STAT_EVENT="statevent",h(ke,R),we.Ma="timingevent",h(Ae,R),xe.prototype.xa=function(){this.g=!1},xe.prototype.info=function(){};var Pe,Ne={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},Re={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"};function je(){}function Le(e,t,n,r){this.j=e,this.i=t,this.l=n,this.R=r||1,this.U=new ce(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new De}function De(){this.i=null,this.g="",this.h=!1}h(je,pe),je.prototype.g=function(){return new XMLHttpRequest},je.prototype.i=function(){return{}},Pe=new je;var Me={},Ue={};function $e(e,t,n){e.L=1,e.v=ht(at(t)),e.m=n,e.P=!0,Fe(e,null)}function Fe(e,t){e.F=Date.now(),qe(e),e.A=at(e.v);var n=e.A,r=e.R;Array.isArray(r)||(r=[String(r)]),kt(n.i,"t",r),e.C=0,n=e.j.J,e.h=new De,e.g=fn(e.j,n?t:null,!e.m),0<e.O&&(e.M=new oe(u(e.Y,e,e.g),e.O)),t=e.U,n=e.g,r=e.ca;var i="readystatechange";Array.isArray(i)||(i&&(ue[0]=i.toString()),i=ue);for(var s=0;s<i.length;s++){var a=K(n,i[s],r||t.handleEvent,!1,t.h||t);if(!a)break;t.g[a.key]=a}t=e.H?_(e.H):{},e.m?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ea(e.A,e.u,e.m,t)):(e.u="GET",e.g.ea(e.A,e.u,null,t)),Te(),function(e,t,n,r,i,s){e.info((function(){if(e.g)if(s)for(var a="",o=s.split("&"),c=0;c<o.length;c++){var u=o[c].split("=");if(1<u.length){var l=u[0];u=u[1];var h=l.split("_");a=2<=h.length&&"type"==h[1]?a+(l+"=")+u+"&":a+(l+"=redacted&")}}else a=null;else a=s;return"XMLHTTP REQ ("+r+") [attempt "+i+"]: "+t+"\n"+n+"\n"+a}))}(e.i,e.u,e.A,e.l,e.R,e.m)}function Be(e){return!!e.g&&"GET"==e.u&&2!=e.L&&e.j.Ca}function Ve(e,t){var n=e.C,r=t.indexOf("\n",n);return-1==r?Ue:(n=Number(t.substring(n,r)),isNaN(n)?Me:(r+=1)+n>t.length?Ue:(t=t.slice(r,r+n),e.C=r+n,t))}function qe(e){e.S=Date.now()+e.I,ze(e,e.I)}function ze(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=Oe(u(e.ba,e),t)}function He(e){e.B&&(i.clearTimeout(e.B),e.B=null)}function Ke(e){0==e.j.G||e.J||cn(e.j,e)}function We(e){He(e);var t=e.M;t&&"function"==typeof t.ma&&t.ma(),e.M=null,le(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.ma())}function Ge(e,t){try{var n=e.j;if(0!=n.G&&(n.g==e||Ye(n.h,e)))if(!e.K&&Ye(n.h,e)&&3==n.G){try{var r=n.Da.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;on(n),Jt(n)}rn(n),Se(18)}}else n.za=i[1],0<n.za-n.T&&37500>i[2]&&n.F&&0==n.v&&!n.C&&(n.C=Oe(u(n.Za,n),6e3));if(1>=Xe(n.h)&&n.ca){try{n.ca()}catch(e){}n.ca=void 0}}else ln(n,11)}else if((e.K||n.g==e)&&on(n),!p(t))for(i=n.Da.g.parse(t),t=0;t<i.length;t++){let u=i[t];if(n.T=u[0],u=u[1],2==n.G)if("c"==u[0]){n.K=u[1],n.ia=u[2];const t=u[3];null!=t&&(n.la=t,n.j.info("VER="+n.la));const i=u[4];null!=i&&(n.Aa=i,n.j.info("SVER="+n.Aa));const l=u[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.L=r,n.j.info("backChannelRequestTimeoutMs_="+r)),r=n;const h=e.g;if(h){const e=h.g?h.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(e){var s=r.h;s.g||-1==e.indexOf("spdy")&&-1==e.indexOf("quic")&&-1==e.indexOf("h2")||(s.j=s.l,s.g=new Set,s.h&&(et(s,s.h),s.h=null))}if(r.D){const e=h.g?h.g.getResponseHeader("X-HTTP-Session-Id"):null;e&&(r.ya=e,lt(r.I,r.D,e))}}n.G=3,n.l&&n.l.ua(),n.ba&&(n.R=Date.now()-e.F,n.j.info("Handshake RTT: "+n.R+"ms"));var a=e;if((r=n).qa=dn(r,r.J?r.ia:null,r.W),a.K){tt(r.h,a);var o=a,c=r.L;c&&(o.I=c),o.B&&(He(o),qe(o)),r.g=a}else nn(r);0<n.i.length&&Xt(n)}else"stop"!=u[0]&&"close"!=u[0]||ln(n,7);else 3==n.G&&("stop"==u[0]||"close"==u[0]?"stop"==u[0]?ln(n,7):Zt(n):"noop"!=u[0]&&n.l&&n.l.ta(u),n.v=0)}Te()}catch(e){}}Le.prototype.ca=function(e){e=e.target;const t=this.M;t&&3==Ht(e)?t.j():this.Y(e)},Le.prototype.Y=function(e){try{if(e==this.g)e:{const d=Ht(this.g);var t=this.g.Ba();if(this.g.Z(),!(3>d)&&(3!=d||this.g&&(this.h.h||this.g.oa()||Kt(this.g)))){this.J||4!=d||7==t||Te(),He(this);var n=this.g.Z();this.X=n;t:if(Be(this)){var r=Kt(this.g);e="";var s=r.length,a=4==Ht(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){We(this),Ke(this);var o="";break t}this.h.i=new i.TextDecoder}for(t=0;t<s;t++)this.h.h=!0,e+=this.h.i.decode(r[t],{stream:!(a&&t==s-1)});r.length=0,this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.oa();if(this.o=200==n,function(e,t,n,r,i,s,a){e.info((function(){return"XMLHTTP RESP ("+r+") [ attempt "+i+"]: "+t+"\n"+n+"\n"+s+" "+a}))}(this.i,this.u,this.A,this.l,this.R,d,n),this.o){if(this.T&&!this.K){t:{if(this.g){var c,u=this.g;if((c=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!p(c)){var l=c;break t}}l=null}if(!(n=l)){this.o=!1,this.s=3,Se(12),We(this),Ke(this);break e}Ce(this.i,this.l,n,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Ge(this,n)}if(this.P){let e;for(n=!0;!this.J&&this.C<o.length;){if(e=Ve(this,o),e==Ue){4==d&&(this.s=4,Se(14),n=!1),Ce(this.i,this.l,null,"[Incomplete Response]");break}if(e==Me){this.s=4,Se(15),Ce(this.i,this.l,o,"[Invalid Chunk]"),n=!1;break}Ce(this.i,this.l,e,null),Ge(this,e)}if(Be(this)&&0!=this.C&&(this.h.g=this.h.g.slice(this.C),this.C=0),4!=d||0!=o.length||this.h.h||(this.s=1,Se(16),n=!1),this.o=this.o&&n,n){if(0<o.length&&!this.W){this.W=!0;var h=this.j;h.g==this&&h.ba&&!h.M&&(h.j.info("Great, no buffering proxy detected. Bytes received: "+o.length),sn(h),h.M=!0,Se(11))}}else Ce(this.i,this.l,o,"[Invalid Chunked Response]"),We(this),Ke(this)}else Ce(this.i,this.l,o,null),Ge(this,o);4==d&&We(this),this.o&&!this.J&&(4==d?cn(this.j,this):(this.o=!1,qe(this)))}else(function(e){const t={};e=(e.g&&2<=Ht(e)&&e.g.getAllResponseHeaders()||"").split("\r\n");for(let r=0;r<e.length;r++){if(p(e[r]))continue;var n=E(e[r]);const i=n[0];if("string"!=typeof(n=n[1]))continue;n=n.trim();const s=t[i]||[];t[i]=s,s.push(n)}!function(e,t){for(const n in e)t.call(void 0,e[n],n,e)}(t,(function(e){return e.join(", ")}))})(this.g),400==n&&0<o.indexOf("Unknown SID")?(this.s=3,Se(12)):(this.s=0,Se(13)),We(this),Ke(this)}}}catch(e){}},Le.prototype.cancel=function(){this.J=!0,We(this)},Le.prototype.ba=function(){this.B=null;const e=Date.now();0<=e-this.S?(function(e,t){e.info((function(){return"TIMEOUT: "+t}))}(this.i,this.A),2!=this.L&&(Te(),Se(17)),We(this),this.s=2,Ke(this)):ze(this,this.S-e)};var Ze=class{constructor(e,t){this.g=e,this.map=t}};function Je(e){this.l=e||10,e=i.PerformanceNavigationTiming?0<(e=i.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(i.chrome&&i.chrome.loadTimes&&i.chrome.loadTimes()&&i.chrome.loadTimes().wasFetchedViaSpdy),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Qe(e){return!!e.h||!!e.g&&e.g.size>=e.j}function Xe(e){return e.h?1:e.g?e.g.size:0}function Ye(e,t){return e.h?e.h==t:!!e.g&&e.g.has(t)}function et(e,t){e.g?e.g.add(t):e.h=t}function tt(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function nt(e){if(null!=e.h)return e.i.concat(e.h.D);if(null!=e.g&&0!==e.g.size){let t=e.i;for(const n of e.g.values())t=t.concat(n.D);return t}return d(e.i)}function rt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(s(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.na&&"function"==typeof e.na)return e.na();if(!e.V||"function"!=typeof e.V){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(s(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.V&&"function"==typeof e.V)return e.V();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(s(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),i=r.length,a=0;a<i;a++)t.call(void 0,r[a],n&&n[a],e)}Je.prototype.cancel=function(){if(this.i=nt(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var it=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function st(e){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,e instanceof st){this.h=e.h,ot(this,e.j),this.o=e.o,this.g=e.g,ct(this,e.s),this.l=e.l;var t=e.i,n=new bt;n.i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),ut(this,n),this.m=e.m}else e&&(t=String(e).match(it))?(this.h=!1,ot(this,t[1]||"",!0),this.o=dt(t[2]||""),this.g=dt(t[3]||"",!0),ct(this,t[4]),this.l=dt(t[5]||"",!0),ut(this,t[6]||"",!0),this.m=dt(t[7]||"")):(this.h=!1,this.i=new bt(null,this.h))}function at(e){return new st(e)}function ot(e,t,n){e.j=n?dt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function ct(e,t){if(t){if(t=Number(t),isNaN(t)||0>t)throw Error("Bad port number "+t);e.s=t}else e.s=null}function ut(e,t,n){t instanceof bt?(e.i=t,function(e,t){t&&!e.j&&(Et(e),e.i=null,e.g.forEach((function(e,t){var n=t.toLowerCase();t!=n&&(It(this,t),kt(this,n,e))}),e)),e.j=t}(e.i,e.h)):(n||(t=ft(t,_t)),e.i=new bt(t,e.h))}function lt(e,t,n){e.i.set(t,n)}function ht(e){return lt(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function dt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function ft(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,pt),n&&(e=e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e):null}function pt(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}st.prototype.toString=function(){var e=[],t=this.j;t&&e.push(ft(t,gt,!0),":");var n=this.g;return(n||"file"==t)&&(e.push("//"),(t=this.o)&&e.push(ft(t,gt,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.s)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(ft(n,"/"==n.charAt(0)?vt:yt,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.m)&&e.push("#",ft(n,wt)),e.join("")};var mt,gt=/[#\/\?@]/g,yt=/[#\?:]/g,vt=/[#\?]/g,_t=/[#\?@]/g,wt=/#/g;function bt(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function Et(e){e.g||(e.g=new Map,e.h=0,e.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r=e[n].indexOf("="),i=null;if(0<=r){var s=e[n].substring(0,r);i=e[n].substring(r+1)}else s=e[n];t(s,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(e.i,(function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)})))}function It(e,t){Et(e),t=St(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function Tt(e,t){return Et(e),t=St(e,t),e.g.has(t)}function kt(e,t,n){It(e,t),0<n.length&&(e.i=null,e.g.set(St(e,t),d(n)),e.h+=n.length)}function St(e,t){return t=String(t),e.j&&(t=t.toLowerCase()),t}function At(e,t,n,r,i){try{i&&(i.onload=null,i.onerror=null,i.onabort=null,i.ontimeout=null),r(n)}catch(e){}}function Ot(){this.g=new fe}function xt(e,t,n){const r=n||"";try{rt(e,(function(e,n){let i=e;a(e)&&(i=he(e)),t.push(r+n+"="+encodeURIComponent(i))}))}catch(e){throw t.push(r+"type="+encodeURIComponent("_badmap")),e}}function Ct(e){this.l=e.Ub||null,this.j=e.eb||!1}function Pt(e,t){ne.call(this),this.D=e,this.o=t,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}function Nt(e){e.j.read().then(e.Pa.bind(e)).catch(e.ga.bind(e))}function Rt(e){e.readyState=4,e.l=null,e.j=null,e.v=null,jt(e)}function jt(e){e.onreadystatechange&&e.onreadystatechange.call(e)}function Lt(e){let t="";return v(e,(function(e,n){t+=n,t+=":",t+=e,t+="\r\n"})),t}function Dt(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=Lt(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):lt(e,t,n))}function Mt(e){ne.call(this),this.headers=new Map,this.o=e||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}(e=bt.prototype).add=function(e,t){Et(this),this.i=null,e=St(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},e.forEach=function(e,t){Et(this),this.g.forEach((function(n,r){n.forEach((function(n){e.call(t,n,r,this)}),this)}),this)},e.na=function(){Et(this);const e=Array.from(this.g.values()),t=Array.from(this.g.keys()),n=[];for(let r=0;r<t.length;r++){const i=e[r];for(let e=0;e<i.length;e++)n.push(t[r])}return n},e.V=function(e){Et(this);let t=[];if("string"==typeof e)Tt(this,e)&&(t=t.concat(this.g.get(St(this,e))));else{e=Array.from(this.g.values());for(let n=0;n<e.length;n++)t=t.concat(e[n])}return t},e.set=function(e,t){return Et(this),this.i=null,Tt(this,e=St(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},e.get=function(e,t){return e&&0<(e=this.V(e)).length?String(e[0]):t},e.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++){var r=t[n];const s=encodeURIComponent(String(r)),a=this.V(r);for(r=0;r<a.length;r++){var i=s;""!==a[r]&&(i+="="+encodeURIComponent(String(a[r]))),e.push(i)}}return this.i=e.join("&")},h(Ct,pe),Ct.prototype.g=function(){return new Pt(this.l,this.j)},Ct.prototype.i=(mt={},function(){return mt}),h(Pt,ne),(e=Pt.prototype).open=function(e,t){if(0!=this.readyState)throw this.abort(),Error("Error reopening a connection");this.B=e,this.A=t,this.readyState=1,jt(this)},e.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.u,method:this.B,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||i).fetch(new Request(this.A,t)).then(this.Sa.bind(this),this.ga.bind(this))},e.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Rt(this)),this.readyState=0},e.Sa=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,jt(this)),this.g&&(this.readyState=3,jt(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(void 0!==i.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;Nt(this)}else e.text().then(this.Ra.bind(this),this.ga.bind(this))},e.Pa=function(e){if(this.g){if(this.o&&e.value)this.response.push(e.value);else if(!this.o){var t=e.value?e.value:new Uint8Array(0);(t=this.v.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)}e.done?Rt(this):jt(this),3==this.readyState&&Nt(this)}},e.Ra=function(e){this.g&&(this.response=this.responseText=e,Rt(this))},e.Qa=function(e){this.g&&(this.response=e,Rt(this))},e.ga=function(){this.g&&Rt(this)},e.setRequestHeader=function(e,t){this.u.append(e,t)},e.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},e.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(Pt.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}}),h(Mt,ne);var Ut=/^https?$/i,$t=["POST","PUT"];function Ft(e,t){e.h=!1,e.g&&(e.j=!0,e.g.abort(),e.j=!1),e.l=t,e.m=5,Bt(e),qt(e)}function Bt(e){e.A||(e.A=!0,re(e,"complete"),re(e,"error"))}function Vt(e){if(e.h&&void 0!==r&&(!e.v[1]||4!=Ht(e)||2!=e.Z()))if(e.u&&4==Ht(e))se(e.Ea,0,e);else if(re(e,"readystatechange"),4==Ht(e)){e.h=!1;try{const r=e.Z();e:switch(r){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var t=!0;break e;default:t=!1}var n;if(!(n=t)){var s;if(s=0===r){var a=String(e.D).match(it)[1]||null;!a&&i.self&&i.self.location&&(a=i.self.location.protocol.slice(0,-1)),s=!Ut.test(a?a.toLowerCase():"")}n=s}if(n)re(e,"complete"),re(e,"success");else{e.m=6;try{var o=2<Ht(e)?e.g.statusText:""}catch(e){o=""}e.l=o+" ["+e.Z()+"]",Bt(e)}}finally{qt(e)}}}function qt(e,t){if(e.g){zt(e);const n=e.g,r=e.v[0]?()=>{}:null;e.g=null,e.v=null,t||re(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function zt(e){e.I&&(i.clearTimeout(e.I),e.I=null)}function Ht(e){return e.g?e.g.readyState:0}function Kt(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.H){case"":case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function Wt(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Gt(e){this.Aa=0,this.i=[],this.j=new xe,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=Wt("failFast",!1,e),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=Wt("baseRetryDelayMs",5e3,e),this.cb=Wt("retryDelaySeedMs",1e4,e),this.Wa=Wt("forwardChannelMaxRetries",2,e),this.wa=Wt("forwardChannelRequestTimeoutMs",2e4,e),this.pa=e&&e.xmlHttpFactory||void 0,this.Xa=e&&e.Tb||void 0,this.Ca=e&&e.useFetchStreams||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.h=new Je(e&&e.concurrentRequestLimit),this.Da=new Ot,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=e&&e.Rb||!1,e&&e.xa&&this.j.xa(),e&&e.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&e&&e.detectBufferingProxy||!1,this.ja=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.ja=e.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}function Zt(e){if(Qt(e),3==e.G){var t=e.U++,n=at(e.I);if(lt(n,"SID",e.K),lt(n,"RID",t),lt(n,"TYPE","terminate"),en(e,n),(t=new Le(e,e.j,t)).L=2,t.v=ht(at(n)),n=!1,i.navigator&&i.navigator.sendBeacon)try{n=i.navigator.sendBeacon(t.v.toString(),"")}catch(e){}!n&&i.Image&&((new Image).src=t.v,n=!0),n||(t.g=fn(t.j,null),t.g.ea(t.v)),t.F=Date.now(),qe(t)}hn(e)}function Jt(e){e.g&&(sn(e),e.g.cancel(),e.g=null)}function Qt(e){Jt(e),e.u&&(i.clearTimeout(e.u),e.u=null),on(e),e.h.cancel(),e.s&&("number"==typeof e.s&&i.clearTimeout(e.s),e.s=null)}function Xt(e){if(!Qe(e.h)&&!e.s){e.s=!0;var t=e.Ga;A||C(),O||(A(),O=!0),x.add(t,e),e.B=0}}function Yt(e,t){var n;n=t?t.l:e.U++;const r=at(e.I);lt(r,"SID",e.K),lt(r,"RID",n),lt(r,"AID",e.T),en(e,r),e.m&&e.o&&Dt(r,e.m,e.o),n=new Le(e,e.j,n,e.B+1),null===e.m&&(n.H=e.o),t&&(e.i=t.D.concat(e.i)),t=tn(e,n,1e3),n.I=Math.round(.5*e.wa)+Math.round(.5*e.wa*Math.random()),et(e.h,n),$e(n,r,t)}function en(e,t){e.H&&v(e.H,(function(e,n){lt(t,n,e)})),e.l&&rt({},(function(e,n){lt(t,n,e)}))}function tn(e,t,n){n=Math.min(e.i.length,n);var r=e.l?u(e.l.Na,e.l,e):null;e:{var i=e.i;let t=-1;for(;;){const s=["count="+n];-1==t?0<n?(t=i[0].g,s.push("ofs="+t)):t=0:s.push("ofs="+t);let a=!0;for(let o=0;o<n;o++){let n=i[o].g;const c=i[o].map;if(n-=t,0>n)t=Math.max(0,i[o].g-100),a=!1;else try{xt(c,s,"req"+n+"_")}catch(e){r&&r(c)}}if(a){r=s.join("&");break e}}}return e=e.i.splice(0,n),t.D=e,r}function nn(e){if(!e.g&&!e.u){e.Y=1;var t=e.Fa;A||C(),O||(A(),O=!0),x.add(t,e),e.v=0}}function rn(e){return!(e.g||e.u||3<=e.v||(e.Y++,e.u=Oe(u(e.Fa,e),un(e,e.v)),e.v++,0))}function sn(e){null!=e.A&&(i.clearTimeout(e.A),e.A=null)}function an(e){e.g=new Le(e,e.j,"rpc",e.Y),null===e.m&&(e.g.H=e.o),e.g.O=0;var t=at(e.qa);lt(t,"RID","rpc"),lt(t,"SID",e.K),lt(t,"AID",e.T),lt(t,"CI",e.F?"0":"1"),!e.F&&e.ja&&lt(t,"TO",e.ja),lt(t,"TYPE","xmlhttp"),en(e,t),e.m&&e.o&&Dt(t,e.m,e.o),e.L&&(e.g.I=e.L);var n=e.g;e=e.ia,n.L=1,n.v=ht(at(t)),n.m=null,n.P=!0,Fe(n,e)}function on(e){null!=e.C&&(i.clearTimeout(e.C),e.C=null)}function cn(e,t){var n=null;if(e.g==t){on(e),sn(e),e.g=null;var r=2}else{if(!Ye(e.h,t))return;n=t.D,tt(e.h,t),r=1}if(0!=e.G)if(t.o)if(1==r){n=t.m?t.m.length:0,t=Date.now()-t.F;var i=e.B;re(r=Ee(),new Ae(r,n)),Xt(e)}else nn(e);else if(3==(i=t.s)||0==i&&0<t.X||!(1==r&&function(e,t){return!(Xe(e.h)>=e.h.j-(e.s?1:0)||(e.s?(e.i=t.D.concat(e.i),0):1==e.G||2==e.G||e.B>=(e.Va?0:e.Wa)||(e.s=Oe(u(e.Ga,e,t),un(e,e.B)),e.B++,0)))}(e,t)||2==r&&rn(e)))switch(n&&0<n.length&&(t=e.h,t.i=t.i.concat(n)),i){case 1:ln(e,5);break;case 4:ln(e,10);break;case 3:ln(e,6);break;default:ln(e,2)}}function un(e,t){let n=e.Ta+Math.floor(Math.random()*e.cb);return e.isActive()||(n*=2),n*t}function ln(e,t){if(e.j.info("Error code "+t),2==t){var n=u(e.fb,e),r=e.Xa;const t=!r;r=new st(r||"//www.google.com/images/cleardot.gif"),i.location&&"http"==i.location.protocol||ot(r,"https"),ht(r),t?function(e,t){const n=new xe;if(i.Image){const r=new Image;r.onload=l(At,n,"TestLoadImage: loaded",!0,t,r),r.onerror=l(At,n,"TestLoadImage: error",!1,t,r),r.onabort=l(At,n,"TestLoadImage: abort",!1,t,r),r.ontimeout=l(At,n,"TestLoadImage: timeout",!1,t,r),i.setTimeout((function(){r.ontimeout&&r.ontimeout()}),1e4),r.src=e}else t(!1)}(r.toString(),n):function(e,t){new xe;const n=new AbortController,r=setTimeout((()=>{n.abort(),At(0,0,!1,t)}),1e4);fetch(e,{signal:n.signal}).then((e=>{clearTimeout(r),e.ok?At(0,0,!0,t):At(0,0,!1,t)})).catch((()=>{clearTimeout(r),At(0,0,!1,t)}))}(r.toString(),n)}else Se(2);e.G=0,e.l&&e.l.sa(t),hn(e),Qt(e)}function hn(e){if(e.G=0,e.ka=[],e.l){const t=nt(e.h);0==t.length&&0==e.i.length||(f(e.ka,t),f(e.ka,e.i),e.h.i.length=0,d(e.i),e.i.length=0),e.l.ra()}}function dn(e,t,n){var r=n instanceof st?at(n):new st(n);if(""!=r.g)t&&(r.g=t+"."+r.g),ct(r,r.s);else{var s=i.location;r=s.protocol,t=t?t+"."+s.hostname:s.hostname,s=+s.port;var a=new st(null);r&&ot(a,r),t&&(a.g=t),s&&ct(a,s),n&&(a.l=n),r=a}return n=e.D,t=e.ya,n&&t&&lt(r,n,t),lt(r,"VER",e.la),en(e,r),r}function fn(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=e.Ca&&!e.pa?new Mt(new Ct({eb:n})):new Mt(e.pa)).Ha(e.J),t}function pn(){}function mn(){}function gn(e,t){ne.call(this),this.g=new Gt(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.o=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.va&&(e?e["X-WebChannel-Client-Profile"]=t.va:e={"X-WebChannel-Client-Profile":t.va}),this.g.S=e,(e=t&&t.Sb)&&!p(e)&&(this.g.m=e),this.v=t&&t.supportsCrossDomainXhr||!1,this.u=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!p(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&t in(e=this.h)&&delete e[t]),this.j=new _n(this)}function yn(e){ve.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function vn(){_e.call(this),this.status=1}function _n(e){this.g=e}(e=Mt.prototype).Ha=function(e){this.J=e},e.ea=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+e);t=t?t.toUpperCase():"GET",this.D=e,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():Pe.g(),this.v=this.o?me(this.o):me(Pe),this.g.onreadystatechange=u(this.Ea,this);try{this.B=!0,this.g.open(t,String(e),!0),this.B=!1}catch(e){return void Ft(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const e of r.keys())n.set(e,r.get(e))}r=Array.from(n.keys()).find((e=>"content-type"==e.toLowerCase())),s=i.FormData&&e instanceof i.FormData,!(0<=Array.prototype.indexOf.call($t,t,void 0))||r||s||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[e,t]of n)this.g.setRequestHeader(e,t);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{zt(this),this.u=!0,this.g.send(e),this.u=!1}catch(e){Ft(this,e)}},e.abort=function(e){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=e||7,re(this,"complete"),re(this,"abort"),qt(this))},e.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),qt(this,!0)),Mt.aa.N.call(this)},e.Ea=function(){this.s||(this.B||this.u||this.j?Vt(this):this.bb())},e.bb=function(){Vt(this)},e.isActive=function(){return!!this.g},e.Z=function(){try{return 2<Ht(this)?this.g.status:-1}catch(e){return-1}},e.oa=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},e.Oa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),de(t)}},e.Ba=function(){return this.m},e.Ka=function(){return"string"==typeof this.l?this.l:String(this.l)},(e=Gt.prototype).la=8,e.G=1,e.connect=function(e,t,n,r){Se(0),this.W=e,this.H=t||{},n&&void 0!==r&&(this.H.OSID=n,this.H.OAID=r),this.F=this.X,this.I=dn(this,null,this.W),Xt(this)},e.Ga=function(e){if(this.s)if(this.s=null,1==this.G){if(!e){this.U=Math.floor(1e5*Math.random()),e=this.U++;const i=new Le(this,this.j,e);let s=this.o;if(this.S&&(s?(s=_(s),b(s,this.S)):s=this.S),null!==this.m||this.O||(i.H=s,s=null),this.P)e:{for(var t=0,n=0;n<this.i.length;n++){var r=this.i[n];if(void 0===(r="__data__"in r.map&&"string"==typeof(r=r.map.__data__)?r.length:void 0))break;if(4096<(t+=r)){t=n;break e}if(4096===t||n===this.i.length-1){t=n+1;break e}}t=1e3}else t=1e3;t=tn(this,i,t),lt(n=at(this.I),"RID",e),lt(n,"CVER",22),this.D&&lt(n,"X-HTTP-Session-Id",this.D),en(this,n),s&&(this.O?t="headers="+encodeURIComponent(String(Lt(s)))+"&"+t:this.m&&Dt(n,this.m,s)),et(this.h,i),this.Ua&&lt(n,"TYPE","init"),this.P?(lt(n,"$req",t),lt(n,"SID","null"),i.T=!0,$e(i,n,null)):$e(i,n,t),this.G=2}}else 3==this.G&&(e?Yt(this,e):0==this.i.length||Qe(this.h)||Yt(this))},e.Fa=function(){if(this.u=null,an(this),this.ba&&!(this.M||null==this.g||0>=this.R)){var e=2*this.R;this.j.info("BP detection timer enabled: "+e),this.A=Oe(u(this.ab,this),e)}},e.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,Se(10),Jt(this),an(this))},e.Za=function(){null!=this.C&&(this.C=null,Jt(this),rn(this),Se(19))},e.fb=function(e){e?(this.j.info("Successfully pinged google.com"),Se(2)):(this.j.info("Failed to ping google.com"),Se(1))},e.isActive=function(){return!!this.l&&this.l.isActive(this)},(e=pn.prototype).ua=function(){},e.ta=function(){},e.sa=function(){},e.ra=function(){},e.isActive=function(){return!0},e.Na=function(){},mn.prototype.g=function(e,t){return new gn(e,t)},h(gn,ne),gn.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},gn.prototype.close=function(){Zt(this.g)},gn.prototype.o=function(e){var t=this.g;if("string"==typeof e){var n={};n.__data__=e,e=n}else this.u&&((n={}).__data__=he(e),e=n);t.i.push(new Ze(t.Ya++,e)),3==t.G&&Xt(t)},gn.prototype.N=function(){this.g.l=null,delete this.j,Zt(this.g),delete this.g,gn.aa.N.call(this)},h(yn,ve),h(vn,_e),h(_n,pn),_n.prototype.ua=function(){re(this.g,"a")},_n.prototype.ta=function(e){re(this.g,new yn(e))},_n.prototype.sa=function(e){re(this.g,new vn)},_n.prototype.ra=function(){re(this.g,"b")},mn.prototype.createWebChannel=mn.prototype.g,gn.prototype.send=gn.prototype.o,gn.prototype.open=gn.prototype.m,gn.prototype.close=gn.prototype.close,fo=mo.createWebChannelTransport=function(){return new mn},ho=mo.getStatEventTarget=function(){return Ee()},lo=mo.Event=we,uo=mo.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Ne.NO_ERROR=0,Ne.TIMEOUT=8,Ne.HTTP_ERROR=6,co=mo.ErrorCode=Ne,Re.COMPLETE="complete",oo=mo.EventType=Re,ge.EventType=ye,ye.OPEN="a",ye.CLOSE="b",ye.ERROR="c",ye.MESSAGE="d",ne.prototype.listen=ne.prototype.K,ao=mo.WebChannel=ge,so=mo.FetchXmlHttpFactory=Ct,Mt.prototype.listenOnce=Mt.prototype.L,Mt.prototype.getLastError=Mt.prototype.Ka,Mt.prototype.getLastErrorCode=Mt.prototype.Ba,Mt.prototype.getStatus=Mt.prototype.Z,Mt.prototype.getResponseJson=Mt.prototype.Oa,Mt.prototype.getResponseText=Mt.prototype.oa,Mt.prototype.send=Mt.prototype.ea,Mt.prototype.setWithCredentials=Mt.prototype.Ha,io=mo.XhrIo=Mt}).apply(void 0!==po?po:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});const go="@firebase/firestore";class yo{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}yo.UNAUTHENTICATED=new yo(null),yo.GOOGLE_CREDENTIALS=new yo("google-credentials-uid"),yo.FIRST_PARTY=new yo("first-party-uid"),yo.MOCK_USER=new yo("mock-user");let vo="10.12.1";const _o=new Fn("@firebase/firestore");function wo(){return _o.logLevel}function bo(e,...t){if(_o.logLevel<=Ln.DEBUG){const n=t.map(To);_o.debug(`Firestore (${vo}): ${e}`,...n)}}function Eo(e,...t){if(_o.logLevel<=Ln.ERROR){const n=t.map(To);_o.error(`Firestore (${vo}): ${e}`,...n)}}function Io(e,...t){if(_o.logLevel<=Ln.WARN){const n=t.map(To);_o.warn(`Firestore (${vo}): ${e}`,...n)}}function To(e){if("string"==typeof e)return e;try{return function(e){return JSON.stringify(e)}(e)}catch(t){return e}}function ko(e="Unexpected state"){const t=`FIRESTORE (${vo}) INTERNAL ASSERTION FAILED: `+e;throw Eo(t),new Error(t)}function So(e,t){e||ko()}function Ao(e,t){return e}const Oo={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class xo extends _n{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Co{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class Po{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class No{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(yo.UNAUTHENTICATED)))}shutdown(){}}class Ro{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class jo{constructor(e){this.t=e,this.currentUser=yo.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let i=new Co;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Co,e.enqueueRetryable((()=>r(this.currentUser)))};const s=()=>{const t=i;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},a=e=>{bo("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),s()};this.t.onInit((e=>a(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?a(e):(bo("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Co)}}),0),s()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(bo("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(So("string"==typeof t.accessToken),new Po(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return So(null===e||"string"==typeof e),new yo(e)}}class Lo{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=yo.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class Do{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new Lo(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable((()=>t(yo.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class Mo{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Uo{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){const n=e=>{null!=e.error&&bo("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.R;return this.R=e.token,bo("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{bo("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.A.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.A.getImmediate({optional:!0});e?r(e):bo("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(So("string"==typeof e.token),this.R=e.token,new Mo(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function $o(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}class Fo{static newId(){const e=62*Math.floor(256/62);let t="";for(;t.length<20;){const n=$o(40);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function Bo(e,t){return e<t?-1:e>t?1:0}function Vo(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}class qo{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new xo(Oo.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new xo(Oo.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new xo(Oo.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new xo(Oo.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return qo.fromMillis(Date.now())}static fromDate(e){return qo.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new qo(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Bo(this.nanoseconds,e.nanoseconds):Bo(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class zo{constructor(e){this.timestamp=e}static fromTimestamp(e){return new zo(e)}static min(){return new zo(new qo(0,0))}static max(){return new zo(new qo(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class Ho{constructor(e,t,n){void 0===t?t=0:t>e.length&&ko(),void 0===n?n=e.length-t:n>e.length-t&&ko(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===Ho.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof Ho?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),i=t.get(r);if(n<i)return-1;if(n>i)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class Ko extends Ho{construct(e,t,n){return new Ko(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new xo(Oo.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new Ko(t)}static emptyPath(){return new Ko([])}}const Wo=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Go extends Ho{construct(e,t,n){return new Go(e,t,n)}static isValidIdentifier(e){return Wo.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),Go.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Go(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const i=()=>{if(0===n.length)throw new xo(Oo.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let s=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new xo(Oo.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new xo(Oo.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(s=!s,r++):"."!==t||s?(n+=t,r++):(i(),r++)}if(i(),s)throw new xo(Oo.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new Go(t)}static emptyPath(){return new Go([])}}class Zo{constructor(e){this.path=e}static fromPath(e){return new Zo(Ko.fromString(e))}static fromName(e){return new Zo(Ko.fromString(e).popFirst(5))}static empty(){return new Zo(Ko.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===Ko.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return Ko.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Zo(new Ko(e.slice()))}}function Jo(e){return new Qo(e.readTime,e.key,-1)}class Qo{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Qo(zo.min(),Zo.empty(),-1)}static max(){return new Qo(zo.max(),Zo.empty(),-1)}}function Xo(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=Zo.comparator(e.documentKey,t.documentKey),0!==n?n:Bo(e.largestBatchId,t.largestBatchId))}const Yo="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ec{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function tc(e){if(e.code!==Oo.FAILED_PRECONDITION||e.message!==Yo)throw e;bo("LocalStore","Unexpectedly lost primary lease")}class nc{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&ko(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new nc(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof nc?t:nc.resolve(t)}catch(e){return nc.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):nc.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):nc.reject(t)}static resolve(e){return new nc(((t,n)=>{t(e)}))}static reject(e){return new nc(((t,n)=>{n(e)}))}static waitFor(e){return new nc(((t,n)=>{let r=0,i=0,s=!1;e.forEach((e=>{++r,e.next((()=>{++i,s&&i===r&&t()}),(e=>n(e)))})),s=!0,i===r&&t()}))}static or(e){let t=nc.resolve(!1);for(const n of e)t=t.next((e=>e?nc.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new nc(((n,r)=>{const i=e.length,s=new Array(i);let a=0;for(let o=0;o<i;o++){const c=o;t(e[c]).next((e=>{s[c]=e,++a,a===i&&n(s)}),(e=>r(e)))}}))}static doWhile(e,t){return new nc(((n,r)=>{const i=()=>{!0===e()?t().next((()=>{i()}),r):n()};i()}))}}function rc(e){return"IndexedDbTransactionError"===e.name}class ic{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ie(e),this.se=e=>t.writeSequenceNumber(e))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.se&&this.se(e),e}}function sc(e){return null==e}function ac(e){return 0===e&&1/e==-1/0}function oc(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function cc(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function uc(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}ic.oe=-1;class lc{constructor(e,t){this.comparator=e,this.root=t||dc.EMPTY}insert(e,t){return new lc(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,dc.BLACK,null,null))}remove(e){return new lc(this.comparator,this.root.remove(e,this.comparator).copy(null,null,dc.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new hc(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new hc(this.root,e,this.comparator,!1)}getReverseIterator(){return new hc(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new hc(this.root,e,this.comparator,!0)}}class hc{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class dc{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:dc.RED,this.left=null!=r?r:dc.EMPTY,this.right=null!=i?i:dc.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new dc(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return dc.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return dc.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,dc.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,dc.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw ko();if(this.right.isRed())throw ko();const e=this.left.check();if(e!==this.right.check())throw ko();return e+(this.isRed()?0:1)}}dc.EMPTY=null,dc.RED=!0,dc.BLACK=!1,dc.EMPTY=new class{constructor(){this.size=0}get key(){throw ko()}get value(){throw ko()}get color(){throw ko()}get left(){throw ko()}get right(){throw ko()}copy(e,t,n,r,i){return this}insert(e,t,n){return new dc(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class fc{constructor(e){this.comparator=e,this.data=new lc(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new pc(this.data.getIterator())}getIteratorFrom(e){return new pc(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof fc))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new fc(this.comparator);return t.data=e,t}}class pc{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}class mc{constructor(e){this.fields=e,e.sort(Go.comparator)}static empty(){return new mc([])}unionWith(e){let t=new fc(Go.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new mc(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Vo(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class gc extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class yc{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new gc("Invalid base64 string: "+e):e}}(e);return new yc(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new yc(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Bo(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}yc.EMPTY_BYTE_STRING=new yc("");const vc=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function _c(e){if(So(!!e),"string"==typeof e){let t=0;const n=vc.exec(e);if(So(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:wc(e.seconds),nanos:wc(e.nanos)}}function wc(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function bc(e){return"string"==typeof e?yc.fromBase64String(e):yc.fromUint8Array(e)}function Ec(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Ic(e){const t=e.mapValue.fields.__previous_value__;return Ec(t)?Ic(t):t}function Tc(e){const t=_c(e.mapValue.fields.__local_write_time__.timestampValue);return new qo(t.seconds,t.nanos)}class kc{constructor(e,t,n,r,i,s,a,o,c){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=c}}class Sc{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Sc("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Sc&&e.projectId===this.projectId&&e.database===this.database}}const Ac={mapValue:{fields:{__type__:{stringValue:"__max__"}}}};function Oc(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Ec(e)?4:Bc(e)?9007199254740991:10:ko()}function xc(e,t){if(e===t)return!0;const n=Oc(e);if(n!==Oc(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Tc(e).isEqual(Tc(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=_c(e.timestampValue),r=_c(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return bc(e.bytesValue).isEqual(bc(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return wc(e.geoPointValue.latitude)===wc(t.geoPointValue.latitude)&&wc(e.geoPointValue.longitude)===wc(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return wc(e.integerValue)===wc(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=wc(e.doubleValue),r=wc(t.doubleValue);return n===r?ac(n)===ac(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return Vo(e.arrayValue.values||[],t.arrayValue.values||[],xc);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(oc(n)!==oc(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!xc(n[e],r[e])))return!1;return!0}(e,t);default:return ko()}}function Cc(e,t){return void 0!==(e.values||[]).find((e=>xc(e,t)))}function Pc(e,t){if(e===t)return 0;const n=Oc(e),r=Oc(t);if(n!==r)return Bo(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return Bo(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=wc(e.integerValue||e.doubleValue),r=wc(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return Nc(e.timestampValue,t.timestampValue);case 4:return Nc(Tc(e),Tc(t));case 5:return Bo(e.stringValue,t.stringValue);case 6:return function(e,t){const n=bc(e),r=bc(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){const t=Bo(n[e],r[e]);if(0!==t)return t}return Bo(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=Bo(wc(e.latitude),wc(t.latitude));return 0!==n?n:Bo(wc(e.longitude),wc(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){const t=Pc(n[e],r[e]);if(t)return t}return Bo(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Ac.mapValue&&t===Ac.mapValue)return 0;if(e===Ac.mapValue)return 1;if(t===Ac.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){const t=Bo(r[e],s[e]);if(0!==t)return t;const a=Pc(n[r[e]],i[s[e]]);if(0!==a)return a}return Bo(r.length,s.length)}(e.mapValue,t.mapValue);default:throw ko()}}function Nc(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Bo(e,t);const n=_c(e),r=_c(t),i=Bo(n.seconds,r.seconds);return 0!==i?i:Bo(n.nanos,r.nanos)}function Rc(e){return jc(e)}function jc(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=_c(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function(e){return bc(e).toBase64()}(e.bytesValue):"referenceValue"in e?function(e){return Zo.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=jc(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const i of t)r?r=!1:n+=",",n+=`${i}:${jc(e.fields[i])}`;return n+"}"}(e.mapValue):ko()}function Lc(e){return!!e&&"integerValue"in e}function Dc(e){return!!e&&"arrayValue"in e}function Mc(e){return!!e&&"nullValue"in e}function Uc(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function $c(e){return!!e&&"mapValue"in e}function Fc(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return cc(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=Fc(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=Fc(e.arrayValue.values[n]);return t}return Object.assign({},e)}function Bc(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}class Vc{constructor(e){this.value=e}static empty(){return new Vc({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!$c(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Fc(t)}setAll(e){let t=Go.emptyPath(),n={},r=[];e.forEach(((e,i)=>{if(!t.isImmediateParentOf(i)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=Fc(e):r.push(i.lastSegment())}));const i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){const t=this.field(e.popLast());$c(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return xc(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];$c(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){cc(t,((t,n)=>e[t]=n));for(const t of n)delete e[t]}clone(){return new Vc(Fc(this.value))}}function qc(e){const t=[];return cc(e.fields,((e,n)=>{const r=new Go([e]);if($c(n)){const e=qc(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new mc(t)}class zc{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new zc(e,0,zo.min(),zo.min(),zo.min(),Vc.empty(),0)}static newFoundDocument(e,t,n,r){return new zc(e,1,t,zo.min(),n,r,0)}static newNoDocument(e,t){return new zc(e,2,t,zo.min(),zo.min(),Vc.empty(),0)}static newUnknownDocument(e,t){return new zc(e,3,t,zo.min(),zo.min(),Vc.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(zo.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Vc.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Vc.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=zo.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof zc&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new zc(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Hc{constructor(e,t){this.position=e,this.inclusive=t}}function Kc(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){const s=t[i],a=e.position[i];if(r=s.field.isKeyField()?Zo.comparator(Zo.fromName(a.referenceValue),n.key):Pc(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function Wc(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!xc(e.position[n],t.position[n]))return!1;return!0}class Gc{constructor(e,t="asc"){this.field=e,this.dir=t}}function Zc(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class Jc{}class Qc extends Jc{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new iu(e,t,n):"array-contains"===t?new cu(e,n):"in"===t?new uu(e,n):"not-in"===t?new lu(e,n):"array-contains-any"===t?new hu(e,n):new Qc(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new su(e,n):new au(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Pc(t,this.value)):null!==t&&Oc(this.value)===Oc(t)&&this.matchesComparison(Pc(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return ko()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class Xc extends Jc{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new Xc(e,t)}matches(e){return Yc(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.ae||(this.ae=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function Yc(e){return"and"===e.op}function eu(e){return function(e){for(const t of e.filters)if(t instanceof Xc)return!1;return!0}(e)&&Yc(e)}function tu(e){if(e instanceof Qc)return e.field.canonicalString()+e.op.toString()+Rc(e.value);if(eu(e))return e.filters.map((e=>tu(e))).join(",");{const t=e.filters.map((e=>tu(e))).join(",");return`${e.op}(${t})`}}function nu(e,t){return e instanceof Qc?function(e,t){return t instanceof Qc&&e.op===t.op&&e.field.isEqual(t.field)&&xc(e.value,t.value)}(e,t):e instanceof Xc?function(e,t){return t instanceof Xc&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,r)=>e&&nu(n,t.filters[r])),!0)}(e,t):void ko()}function ru(e){return e instanceof Qc?function(e){return`${e.field.canonicalString()} ${e.op} ${Rc(e.value)}`}(e):e instanceof Xc?function(e){return e.op.toString()+" {"+e.getFilters().map(ru).join(" ,")+"}"}(e):"Filter"}class iu extends Qc{constructor(e,t,n){super(e,t,n),this.key=Zo.fromName(n.referenceValue)}matches(e){const t=Zo.comparator(e.key,this.key);return this.matchesComparison(t)}}class su extends Qc{constructor(e,t){super(e,"in",t),this.keys=ou(0,t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class au extends Qc{constructor(e,t){super(e,"not-in",t),this.keys=ou(0,t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function ou(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>Zo.fromName(e.referenceValue)))}class cu extends Qc{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Dc(t)&&Cc(t.arrayValue,this.value)}}class uu extends Qc{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&Cc(this.value.arrayValue,t)}}class lu extends Qc{constructor(e,t){super(e,"not-in",t)}matches(e){if(Cc(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!Cc(this.value.arrayValue,t)}}class hu extends Qc{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Dc(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>Cc(this.value.arrayValue,e)))}}class du{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.ue=null}}function fu(e,t=null,n=[],r=[],i=null,s=null,a=null){return new du(e,t,n,r,i,s,a)}function pu(e){const t=Ao(e);if(null===t.ue){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>tu(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),sc(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>Rc(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>Rc(e))).join(",")),t.ue=e}return t.ue}function mu(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!Zc(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!nu(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Wc(e.startAt,t.startAt)&&Wc(e.endAt,t.endAt)}function gu(e){return Zo.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}class yu{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function vu(e){return new yu(e)}function _u(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function wu(e){const t=Ao(e);if(null===t.ce){t.ce=[];const e=new Set;for(const n of t.explicitOrderBy)t.ce.push(n),e.add(n.field.canonicalString());const n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc",r=function(e){let t=new fc(Go.comparator);return e.filters.forEach((e=>{e.getFlattenedFilters().forEach((e=>{e.isInequality()&&(t=t.add(e.field))}))})),t}(t);r.forEach((r=>{e.has(r.canonicalString())||r.isKeyField()||t.ce.push(new Gc(r,n))})),e.has(Go.keyField().canonicalString())||t.ce.push(new Gc(Go.keyField(),n))}return t.ce}function bu(e){const t=Ao(e);return t.le||(t.le=function(e,t){if("F"===e.limitType)return fu(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map((e=>{const t="desc"===e.dir?"asc":"desc";return new Gc(e.field,t)}));const n=e.endAt?new Hc(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new Hc(e.startAt.position,e.startAt.inclusive):null;return fu(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}(t,wu(e))),t.le}function Eu(e,t,n){return new yu(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Iu(e,t){return mu(bu(e),bu(t))&&e.limitType===t.limitType}function Tu(e){return`${pu(bu(e))}|lt:${e.limitType}`}function ku(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>ru(e))).join(", ")}]`),sc(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>Rc(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>Rc(e))).join(",")),`Target(${t})`}(bu(e))}; limitType=${e.limitType})`}function Su(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):Zo.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of wu(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=Kc(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,wu(e),t)||e.endAt&&!function(e,t,n){const r=Kc(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,wu(e),t))}(e,t)}function Au(e){return(t,n)=>{let r=!1;for(const i of wu(e)){const e=Ou(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}function Ou(e,t,n){const r=e.field.isKeyField()?Zo.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?Pc(r,i):ko()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return ko()}}class xu{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){cc(this.inner,((t,n)=>{for(const[t,r]of n)e(t,r)}))}isEmpty(){return uc(this.inner)}size(){return this.innerSize}}const Cu=new lc(Zo.comparator);function Pu(){return Cu}const Nu=new lc(Zo.comparator);function Ru(...e){let t=Nu;for(const n of e)t=t.insert(n.key,n);return t}function ju(e){let t=Nu;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function Lu(){return Mu()}function Du(){return Mu()}function Mu(){return new xu((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Uu=new lc(Zo.comparator),$u=new fc(Zo.comparator);function Fu(...e){let t=$u;for(const n of e)t=t.add(n);return t}const Bu=new fc(Bo);function Vu(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ac(t)?"-0":t}}function qu(e){return{integerValue:""+e}}class zu{constructor(){this._=void 0}}function Hu(e,t,n){return e instanceof Gu?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&Ec(t)&&(t=Ic(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof Zu?Ju(e,t):e instanceof Qu?Xu(e,t):function(e,t){const n=Wu(e,t),r=el(n)+el(e.Pe);return Lc(n)&&Lc(e.Pe)?qu(r):Vu(e.serializer,r)}(e,t)}function Ku(e,t,n){return e instanceof Zu?Ju(e,t):e instanceof Qu?Xu(e,t):n}function Wu(e,t){return e instanceof Yu?function(e){return Lc(e)||function(e){return!!e&&"doubleValue"in e}(e)}(t)?t:{integerValue:0}:null}class Gu extends zu{}class Zu extends zu{constructor(e){super(),this.elements=e}}function Ju(e,t){const n=tl(t);for(const t of e.elements)n.some((e=>xc(e,t)))||n.push(t);return{arrayValue:{values:n}}}class Qu extends zu{constructor(e){super(),this.elements=e}}function Xu(e,t){let n=tl(t);for(const t of e.elements)n=n.filter((e=>!xc(e,t)));return{arrayValue:{values:n}}}class Yu extends zu{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function el(e){return wc(e.integerValue||e.doubleValue)}function tl(e){return Dc(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class nl{constructor(e,t){this.version=e,this.transformResults=t}}class rl{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new rl}static exists(e){return new rl(void 0,e)}static updateTime(e){return new rl(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function il(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class sl{}function al(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new gl(e.key,rl.none()):new hl(e.key,e.data,rl.none());{const n=e.data,r=Vc.empty();let i=new fc(Go.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new dl(e.key,r,new mc(i.toArray()),rl.none())}}function ol(e,t,n){e instanceof hl?function(e,t,n){const r=e.value.clone(),i=pl(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof dl?function(e,t,n){if(!il(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=pl(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(fl(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function cl(e,t,n,r){return e instanceof hl?function(e,t,n,r){if(!il(e.precondition,t))return n;const i=e.value.clone(),s=ml(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof dl?function(e,t,n,r){if(!il(e.precondition,t))return n;const i=ml(e.fieldTransforms,r,t),s=t.data;return s.setAll(fl(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return il(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function ul(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),i=Wu(r.transform,e||null);null!=i&&(null===n&&(n=Vc.empty()),n.set(r.field,i))}return n||null}function ll(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&Vo(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof Zu&&t instanceof Zu||e instanceof Qu&&t instanceof Qu?Vo(e.elements,t.elements,xc):e instanceof Yu&&t instanceof Yu?xc(e.Pe,t.Pe):e instanceof Gu&&t instanceof Gu}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class hl extends sl{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class dl extends sl{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function fl(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function pl(e,t,n){const r=new Map;So(e.length===n.length);for(let i=0;i<n.length;i++){const s=e[i],a=s.transform,o=t.data.field(s.field);r.set(s.field,Ku(a,o,n[i]))}return r}function ml(e,t,n){const r=new Map;for(const i of e){const e=i.transform,s=n.data.field(i.field);r.set(i.field,Hu(e,s,t))}return r}class gl extends sl{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class yl extends sl{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class vl{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];r.key.isEqual(e.key)&&ol(r,e,n[t])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=cl(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=cl(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Du();return this.mutations.forEach((r=>{const i=e.get(r.key),s=i.overlayedDocument;let a=this.applyToLocalView(s,i.mutatedFields);a=t.has(r.key)?null:a;const o=al(s,a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument(zo.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),Fu())}isEqual(e){return this.batchId===e.batchId&&Vo(this.mutations,e.mutations,((e,t)=>ll(e,t)))&&Vo(this.baseMutations,e.baseMutations,((e,t)=>ll(e,t)))}}class _l{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){So(e.mutations.length===n.length);let r=Uu;const i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new _l(e,t,n,r)}}class wl{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class bl{constructor(e,t){this.count=e,this.unchangedNames=t}}var El,Il;function Tl(e){if(void 0===e)return Eo("GRPC error has no .code"),Oo.UNKNOWN;switch(e){case El.OK:return Oo.OK;case El.CANCELLED:return Oo.CANCELLED;case El.UNKNOWN:return Oo.UNKNOWN;case El.DEADLINE_EXCEEDED:return Oo.DEADLINE_EXCEEDED;case El.RESOURCE_EXHAUSTED:return Oo.RESOURCE_EXHAUSTED;case El.INTERNAL:return Oo.INTERNAL;case El.UNAVAILABLE:return Oo.UNAVAILABLE;case El.UNAUTHENTICATED:return Oo.UNAUTHENTICATED;case El.INVALID_ARGUMENT:return Oo.INVALID_ARGUMENT;case El.NOT_FOUND:return Oo.NOT_FOUND;case El.ALREADY_EXISTS:return Oo.ALREADY_EXISTS;case El.PERMISSION_DENIED:return Oo.PERMISSION_DENIED;case El.FAILED_PRECONDITION:return Oo.FAILED_PRECONDITION;case El.ABORTED:return Oo.ABORTED;case El.OUT_OF_RANGE:return Oo.OUT_OF_RANGE;case El.UNIMPLEMENTED:return Oo.UNIMPLEMENTED;case El.DATA_LOSS:return Oo.DATA_LOSS;default:return ko()}}(Il=El||(El={}))[Il.OK=0]="OK",Il[Il.CANCELLED=1]="CANCELLED",Il[Il.UNKNOWN=2]="UNKNOWN",Il[Il.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Il[Il.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Il[Il.NOT_FOUND=5]="NOT_FOUND",Il[Il.ALREADY_EXISTS=6]="ALREADY_EXISTS",Il[Il.PERMISSION_DENIED=7]="PERMISSION_DENIED",Il[Il.UNAUTHENTICATED=16]="UNAUTHENTICATED",Il[Il.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Il[Il.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Il[Il.ABORTED=10]="ABORTED",Il[Il.OUT_OF_RANGE=11]="OUT_OF_RANGE",Il[Il.UNIMPLEMENTED=12]="UNIMPLEMENTED",Il[Il.INTERNAL=13]="INTERNAL",Il[Il.UNAVAILABLE=14]="UNAVAILABLE",Il[Il.DATA_LOSS=15]="DATA_LOSS";const kl=new eo([4294967295,4294967295],0);function Sl(e){const t=(new TextEncoder).encode(e),n=new to;return n.update(t),new Uint8Array(n.digest())}function Al(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new eo([n,r],0),new eo([i,s],0)]}class Ol{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new xl(`Invalid padding: ${t}`);if(n<0)throw new xl(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new xl(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new xl(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=eo.fromNumber(this.Ie)}Ee(e,t,n){let r=e.add(t.multiply(eo.fromNumber(n)));return 1===r.compare(kl)&&(r=new eo([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Te).toNumber()}de(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ie)return!1;const t=Sl(e),[n,r]=Al(t);for(let e=0;e<this.hashCount;e++){const t=this.Ee(n,r,e);if(!this.de(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,i=new Uint8Array(Math.ceil(e/8)),s=new Ol(i,r,t);return n.forEach((e=>s.insert(e))),s}insert(e){if(0===this.Ie)return;const t=Sl(e),[n,r]=Al(t);for(let e=0;e<this.hashCount;e++){const t=this.Ee(n,r,e);this.Ae(t)}}Ae(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class xl extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Cl{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Pl.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Cl(zo.min(),r,new lc(Bo),Pu(),Fu())}}class Pl{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Pl(n,t,Fu(),Fu(),Fu())}}class Nl{constructor(e,t,n,r){this.Re=e,this.removedTargetIds=t,this.key=n,this.Ve=r}}class Rl{constructor(e,t){this.targetId=e,this.me=t}}class jl{constructor(e,t,n=yc.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Ll{constructor(){this.fe=0,this.ge=Ul(),this.pe=yc.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return 0!==this.fe}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}Ce(){let e=Fu(),t=Fu(),n=Fu();return this.ge.forEach(((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:ko()}})),new Pl(this.pe,this.ye,e,t,n)}ve(){this.we=!1,this.ge=Ul()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,So(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}}class Dl{constructor(e){this.Le=e,this.Be=new Map,this.ke=Pu(),this.qe=Ml(),this.Qe=new lc(Bo)}Ke(e){for(const t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(const t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,(t=>{const n=this.Ge(t);switch(e.state){case 0:this.ze(t)&&n.De(e.resumeToken);break;case 1:n.Oe(),n.Se||n.ve(),n.De(e.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(n.Ne(),n.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),n.De(e.resumeToken));break;default:ko()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach(((e,n)=>{this.ze(n)&&t(n)}))}He(e){const t=e.targetId,n=e.me.count,r=this.Je(t);if(r){const i=r.target;if(gu(i))if(0===n){const e=new Zo(i.path);this.Ue(t,e,zc.newNoDocument(e,zo.min()))}else So(1===n);else{const r=this.Ye(t);if(r!==n){const n=this.Ze(e),i=n?this.Xe(n,e,r):1;if(0!==i){this.je(t);const e=2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,e)}}}}}Ze(e){const t=e.me.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:i=0}=t;let s,a;try{s=bc(n).toUint8Array()}catch(e){if(e instanceof gc)return Io("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{a=new Ol(s,r,i)}catch(e){return Io(e instanceof xl?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===a.Ie?null:a}Xe(e,t,n){return t.me.count===n-this.nt(e,t.targetId)?0:2}nt(e,t){const n=this.Le.getRemoteKeysForTarget(t);let r=0;return n.forEach((n=>{const i=this.Le.tt(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(s)||(this.Ue(t,n,null),r++)})),r}rt(e){const t=new Map;this.Be.forEach(((n,r)=>{const i=this.Je(r);if(i){if(n.current&&gu(i.target)){const t=new Zo(i.target.path);null!==this.ke.get(t)||this.it(r,t)||this.Ue(r,t,zc.newNoDocument(t,e))}n.be&&(t.set(r,n.Ce()),n.ve())}}));let n=Fu();this.qe.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.Je(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.ke.forEach(((t,n)=>n.setReadTime(e)));const r=new Cl(e,t,this.Qe,this.ke,n);return this.ke=Pu(),this.qe=Ml(),this.Qe=new lc(Bo),r}$e(e,t){if(!this.ze(e))return;const n=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,n),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,n){if(!this.ze(e))return;const r=this.Ge(e);this.it(e,t)?r.Fe(t,1):r.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),n&&(this.ke=this.ke.insert(t,n))}removeTarget(e){this.Be.delete(e)}Ye(e){const t=this.Ge(e).Ce();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new Ll,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new fc(Bo),this.qe=this.qe.insert(e,t)),t}ze(e){const t=null!==this.Je(e);return t||bo("WatchChangeAggregator","Detected inactive target",e),t}Je(e){const t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new Ll),this.Le.getRemoteKeysForTarget(e).forEach((t=>{this.Ue(e,t,null)}))}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function Ml(){return new lc(Zo.comparator)}function Ul(){return new lc(Zo.comparator)}const $l={asc:"ASCENDING",desc:"DESCENDING"},Fl={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Bl={and:"AND",or:"OR"};class Vl{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function ql(e,t){return e.useProto3Json||sc(t)?t:{value:t}}function zl(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Hl(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function Kl(e,t){return zl(e,t.toTimestamp())}function Wl(e){return So(!!e),zo.fromTimestamp(function(e){const t=_c(e);return new qo(t.seconds,t.nanos)}(e))}function Gl(e,t){return Zl(e,t).canonicalString()}function Zl(e,t){const n=function(e){return new Ko(["projects",e.projectId,"databases",e.database])}(e).child("documents");return void 0===t?n:n.child(t)}function Jl(e){const t=Ko.fromString(e);return So(ph(t)),t}function Ql(e,t){return Gl(e.databaseId,t.path)}function Xl(e,t){const n=Jl(t);if(n.get(1)!==e.databaseId.projectId)throw new xo(Oo.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new xo(Oo.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new Zo(th(n))}function Yl(e,t){return Gl(e.databaseId,t)}function eh(e){return new Ko(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function th(e){return So(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function nh(e,t,n){return{name:Ql(e,t),fields:n.value.mapValue.fields}}function rh(e,t){return{documents:[Yl(e,t.path)]}}function ih(e,t){const n={structuredQuery:{}},r=t.path;let i;null!==t.collectionGroup?(i=r,n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=Yl(e,i);const s=function(e){if(0!==e.length)return dh(Xc.create(e,"and"))}(t.filters);s&&(n.structuredQuery.where=s);const a=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:lh(e.field),direction:oh(e.dir)}}(e)))}(t.orderBy);a&&(n.structuredQuery.orderBy=a);const o=ql(e,t.limit);return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt=function(e){return{before:e.inclusive,values:e.position}}(t.startAt)),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),{_t:n,parent:i}}function sh(e){let t=function(e){const t=Jl(e);return 4===t.length?Ko.emptyPath():th(t)}(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let i=null;if(r>0){So(1===r);const e=n.from[0];e.allDescendants?i=e.collectionId:t=t.child(e.collectionId)}let s=[];n.where&&(s=function(e){const t=ah(e);return t instanceof Xc&&eu(t)?t.getFilters():[t]}(n.where));let a=[];n.orderBy&&(a=function(e){return e.map((e=>function(e){return new Gc(hh(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)))}(n.orderBy));let o=null;n.limit&&(o=function(e){let t;return t="object"==typeof e?e.value:e,sc(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function(e){const t=!!e.before,n=e.values||[];return new Hc(n,t)}(n.startAt));let u=null;return n.endAt&&(u=function(e){const t=!e.before,n=e.values||[];return new Hc(n,t)}(n.endAt)),function(e,t,n,r,i,s,a,o){return new yu(e,t,n,r,i,"F",a,o)}(t,i,a,s,o,0,c,u)}function ah(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=hh(e.unaryFilter.field);return Qc.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=hh(e.unaryFilter.field);return Qc.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=hh(e.unaryFilter.field);return Qc.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=hh(e.unaryFilter.field);return Qc.create(i,"!=",{nullValue:"NULL_VALUE"});default:return ko()}}(e):void 0!==e.fieldFilter?function(e){return Qc.create(hh(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return ko()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return Xc.create(e.compositeFilter.filters.map((e=>ah(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return ko()}}(e.compositeFilter.op))}(e):ko()}function oh(e){return $l[e]}function ch(e){return Fl[e]}function uh(e){return Bl[e]}function lh(e){return{fieldPath:e.canonicalString()}}function hh(e){return Go.fromServerFormat(e.fieldPath)}function dh(e){return e instanceof Qc?function(e){if("=="===e.op){if(Uc(e.value))return{unaryFilter:{field:lh(e.field),op:"IS_NAN"}};if(Mc(e.value))return{unaryFilter:{field:lh(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Uc(e.value))return{unaryFilter:{field:lh(e.field),op:"IS_NOT_NAN"}};if(Mc(e.value))return{unaryFilter:{field:lh(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:lh(e.field),op:ch(e.op),value:e.value}}}(e):e instanceof Xc?function(e){const t=e.getFilters().map((e=>dh(e)));return 1===t.length?t[0]:{compositeFilter:{op:uh(e.op),filters:t}}}(e):ko()}function fh(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function ph(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class mh{constructor(e,t,n,r,i=zo.min(),s=zo.min(),a=yc.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new mh(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new mh(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new mh(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new mh(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class gh{constructor(e){this.ct=e}}function yh(e){const t=sh({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Eu(t,t.limit,"L"):t}class vh{constructor(){}Pt(e,t){this.It(e,t),t.Tt()}It(e,t){if("nullValue"in e)this.Et(t,5);else if("booleanValue"in e)this.Et(t,10),t.dt(e.booleanValue?1:0);else if("integerValue"in e)this.Et(t,15),t.dt(wc(e.integerValue));else if("doubleValue"in e){const n=wc(e.doubleValue);isNaN(n)?this.Et(t,13):(this.Et(t,15),ac(n)?t.dt(0):t.dt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.Et(t,20),"string"==typeof n&&(n=_c(n)),t.At(`${n.seconds||""}`),t.dt(n.nanos||0)}else if("stringValue"in e)this.Rt(e.stringValue,t),this.Vt(t);else if("bytesValue"in e)this.Et(t,30),t.ft(bc(e.bytesValue)),this.Vt(t);else if("referenceValue"in e)this.gt(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.Et(t,45),t.dt(n.latitude||0),t.dt(n.longitude||0)}else"mapValue"in e?Bc(e)?this.Et(t,Number.MAX_SAFE_INTEGER):(this.yt(e.mapValue,t),this.Vt(t)):"arrayValue"in e?(this.wt(e.arrayValue,t),this.Vt(t)):ko()}Rt(e,t){this.Et(t,25),this.St(e,t)}St(e,t){t.At(e)}yt(e,t){const n=e.fields||{};this.Et(t,55);for(const e of Object.keys(n))this.Rt(e,t),this.It(n[e],t)}wt(e,t){const n=e.values||[];this.Et(t,50);for(const e of n)this.It(e,t)}gt(e,t){this.Et(t,37),Zo.fromName(e).path.forEach((e=>{this.Et(t,60),this.St(e,t)}))}Et(e,t){e.dt(t)}Vt(e){e.dt(2)}}vh.bt=new vh;class _h{constructor(){this._n=new wh}addToCollectionParentIndex(e,t){return this._n.add(t),nc.resolve()}getCollectionParents(e,t){return nc.resolve(this._n.getEntries(t))}addFieldIndex(e,t){return nc.resolve()}deleteFieldIndex(e,t){return nc.resolve()}deleteAllFieldIndexes(e){return nc.resolve()}createTargetIndexes(e,t){return nc.resolve()}getDocumentsMatchingTarget(e,t){return nc.resolve(null)}getIndexType(e,t){return nc.resolve(0)}getFieldIndexes(e,t){return nc.resolve([])}getNextCollectionGroupToUpdate(e){return nc.resolve(null)}getMinOffset(e,t){return nc.resolve(Qo.min())}getMinOffsetFromCollectionGroup(e,t){return nc.resolve(Qo.min())}updateCollectionGroup(e,t,n){return nc.resolve()}updateIndexEntries(e,t){return nc.resolve()}}class wh{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new fc(Ko.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new fc(Ko.comparator)).toArray()}}new Uint8Array(0);class bh{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new bh(e,bh.DEFAULT_COLLECTION_PERCENTILE,bh.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}bh.DEFAULT_COLLECTION_PERCENTILE=10,bh.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,bh.DEFAULT=new bh(41943040,bh.DEFAULT_COLLECTION_PERCENTILE,bh.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),bh.DISABLED=new bh(-1,0,0);class Eh{constructor(e){this.On=e}next(){return this.On+=2,this.On}static Nn(){return new Eh(0)}static Ln(){return new Eh(-1)}}class Ih{constructor(){this.changes=new xu((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,zc.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?nc.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Th{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class kh{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&cl(n.mutation,e,mc.empty(),qo.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,Fu()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=Fu()){const r=Lu();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=Ru();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=Lu();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,Fu())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let i=Pu();const s=Mu(),a=Mu();return t.forEach(((e,t)=>{const a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof dl)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),cl(a.mutation,t,a.mutation.getFieldMask(),qo.now())):s.set(t.key,mc.empty())})),this.recalculateAndSaveOverlays(e,i).next((e=>(e.forEach(((e,t)=>s.set(e,t))),t.forEach(((e,t)=>{var n;return a.set(e,new Th(t,null!==(n=s.get(e))&&void 0!==n?n:null))})),a)))}recalculateAndSaveOverlays(e,t){const n=Mu();let r=new lc(((e,t)=>e-t)),i=Fu();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const i of e)i.keys().forEach((e=>{const s=t.get(e);if(null===s)return;let a=n.get(e)||mc.empty();a=i.applyToLocalView(s,a),n.set(e,a);const o=(r.get(i.batchId)||Fu()).add(e);r=r.insert(i.batchId,o)}))})).next((()=>{const s=[],a=r.getReverseIterator();for(;a.hasNext();){const r=a.getNext(),o=r.key,c=r.value,u=Du();c.forEach((e=>{if(!i.has(e)){const r=al(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}})),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return nc.waitFor(s)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n,r){return function(e){return Zo.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):function(e){return null!==e.collectionGroup}(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((i=>{const s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):nc.resolve(Lu());let a=-1,o=i;return s.next((t=>nc.forEach(t,((t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?nc.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{o=o.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,i))).next((()=>this.computeViews(e,o,t,Fu()))).next((e=>({batchId:a,changes:ju(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Zo(t)).next((e=>{let t=Ru();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){const i=t.collectionGroup;let s=Ru();return this.indexManager.getCollectionParents(e,i).next((a=>nc.forEach(a,(a=>{const o=function(e,t){return new yu(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,a.child(i));return this.getDocumentsMatchingCollectionQuery(e,o,n,r).next((e=>{e.forEach(((e,t)=>{s=s.insert(e,t)}))}))})).next((()=>s))))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r)))).next((e=>{i.forEach(((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,zc.newInvalidDocument(r)))}));let n=Ru();return e.forEach(((e,r)=>{const s=i.get(e);void 0!==s&&cl(s.mutation,r,mc.empty(),qo.now()),Su(t,r)&&(n=n.insert(e,r))})),n}))}}class Sh{constructor(e){this.serializer=e,this.cr=new Map,this.lr=new Map}getBundleMetadata(e,t){return nc.resolve(this.cr.get(t))}saveBundleMetadata(e,t){return this.cr.set(t.id,function(e){return{id:e.id,version:e.version,createTime:Wl(e.createTime)}}(t)),nc.resolve()}getNamedQuery(e,t){return nc.resolve(this.lr.get(t))}saveNamedQuery(e,t){return this.lr.set(t.name,function(e){return{name:e.name,query:yh(e.bundledQuery),readTime:Wl(e.readTime)}}(t)),nc.resolve()}}class Ah{constructor(){this.overlays=new lc(Zo.comparator),this.hr=new Map}getOverlay(e,t){return nc.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Lu();return nc.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.ht(e,t,r)})),nc.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.hr.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.hr.delete(n)),nc.resolve()}getOverlaysForCollection(e,t,n){const r=Lu(),i=t.length+1,s=new Zo(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){const e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return nc.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new lc(((e,t)=>e-t));const s=this.overlays.getIterator();for(;s.hasNext();){const e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=Lu(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const a=Lu(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach(((e,t)=>a.set(e,t))),!(a.size()>=r)););return nc.resolve(a)}ht(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.hr.get(r.largestBatchId).delete(n.key);this.hr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new wl(t,n));let i=this.hr.get(t);void 0===i&&(i=Fu(),this.hr.set(t,i)),this.hr.set(t,i.add(n.key))}}class Oh{constructor(){this.Pr=new fc(xh.Ir),this.Tr=new fc(xh.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(e,t){const n=new xh(e,t);this.Pr=this.Pr.add(n),this.Tr=this.Tr.add(n)}dr(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.Ar(new xh(e,t))}Rr(e,t){e.forEach((e=>this.removeReference(e,t)))}Vr(e){const t=new Zo(new Ko([])),n=new xh(t,e),r=new xh(t,e+1),i=[];return this.Tr.forEachInRange([n,r],(e=>{this.Ar(e),i.push(e.key)})),i}mr(){this.Pr.forEach((e=>this.Ar(e)))}Ar(e){this.Pr=this.Pr.delete(e),this.Tr=this.Tr.delete(e)}gr(e){const t=new Zo(new Ko([])),n=new xh(t,e),r=new xh(t,e+1);let i=Fu();return this.Tr.forEachInRange([n,r],(e=>{i=i.add(e.key)})),i}containsKey(e){const t=new xh(e,0),n=this.Pr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class xh{constructor(e,t){this.key=e,this.pr=t}static Ir(e,t){return Zo.comparator(e.key,t.key)||Bo(e.pr,t.pr)}static Er(e,t){return Bo(e.pr,t.pr)||Zo.comparator(e.key,t.key)}}class Ch{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.yr=1,this.wr=new fc(xh.Ir)}checkEmpty(e){return nc.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const i=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const s=new vl(i,t,n,r);this.mutationQueue.push(s);for(const t of r)this.wr=this.wr.add(new xh(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return nc.resolve(s)}lookupMutationBatch(e,t){return nc.resolve(this.Sr(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.br(n),i=r<0?0:r;return nc.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)}getHighestUnacknowledgedBatchId(){return nc.resolve(0===this.mutationQueue.length?-1:this.yr-1)}getAllMutationBatches(e){return nc.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new xh(t,0),r=new xh(t,Number.POSITIVE_INFINITY),i=[];return this.wr.forEachInRange([n,r],(e=>{const t=this.Sr(e.pr);i.push(t)})),nc.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new fc(Bo);return t.forEach((e=>{const t=new xh(e,0),r=new xh(e,Number.POSITIVE_INFINITY);this.wr.forEachInRange([t,r],(e=>{n=n.add(e.pr)}))})),nc.resolve(this.Dr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let i=n;Zo.isDocumentKey(i)||(i=i.child(""));const s=new xh(new Zo(i),0);let a=new fc(Bo);return this.wr.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.pr)),!0)}),s),nc.resolve(this.Dr(a))}Dr(e){const t=[];return e.forEach((e=>{const n=this.Sr(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){So(0===this.Cr(t.batchId,"removed")),this.mutationQueue.shift();let n=this.wr;return nc.forEach(t.mutations,(r=>{const i=new xh(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.wr=n}))}Mn(e){}containsKey(e,t){const n=new xh(t,0),r=this.wr.firstAfterOrEqual(n);return nc.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,nc.resolve()}Cr(e,t){return this.br(e)}br(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Sr(e){const t=this.br(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Ph{constructor(e){this.vr=e,this.docs=new lc(Zo.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.vr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return nc.resolve(n?n.document.mutableCopy():zc.newInvalidDocument(t))}getEntries(e,t){let n=Pu();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():zc.newInvalidDocument(e))})),nc.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=Pu();const s=t.path,a=new Zo(s.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){const{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||Xo(Jo(a),n)<=0||(r.has(a.key)||Su(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return nc.resolve(i)}getAllFromCollectionGroup(e,t,n,r){ko()}Fr(e,t){return nc.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new Nh(this)}getSize(e){return nc.resolve(this.size)}}class Nh extends Ih{constructor(e){super(),this.ar=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.ar.addEntry(e,r)):this.ar.removeEntry(n)})),nc.waitFor(t)}getFromCache(e,t){return this.ar.getEntry(e,t)}getAllFromCache(e,t){return this.ar.getEntries(e,t)}}class Rh{constructor(e){this.persistence=e,this.Mr=new xu((e=>pu(e)),mu),this.lastRemoteSnapshotVersion=zo.min(),this.highestTargetId=0,this.Or=0,this.Nr=new Oh,this.targetCount=0,this.Lr=Eh.Nn()}forEachTarget(e,t){return this.Mr.forEach(((e,n)=>t(n))),nc.resolve()}getLastRemoteSnapshotVersion(e){return nc.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return nc.resolve(this.Or)}allocateTargetId(e){return this.highestTargetId=this.Lr.next(),nc.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Or&&(this.Or=t),nc.resolve()}qn(e){this.Mr.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Lr=new Eh(t),this.highestTargetId=t),e.sequenceNumber>this.Or&&(this.Or=e.sequenceNumber)}addTargetData(e,t){return this.qn(t),this.targetCount+=1,nc.resolve()}updateTargetData(e,t){return this.qn(t),nc.resolve()}removeTargetData(e,t){return this.Mr.delete(t.target),this.Nr.Vr(t.targetId),this.targetCount-=1,nc.resolve()}removeTargets(e,t,n){let r=0;const i=[];return this.Mr.forEach(((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.Mr.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)})),nc.waitFor(i).next((()=>r))}getTargetCount(e){return nc.resolve(this.targetCount)}getTargetData(e,t){const n=this.Mr.get(t)||null;return nc.resolve(n)}addMatchingKeys(e,t,n){return this.Nr.dr(t,n),nc.resolve()}removeMatchingKeys(e,t,n){this.Nr.Rr(t,n);const r=this.persistence.referenceDelegate,i=[];return r&&t.forEach((t=>{i.push(r.markPotentiallyOrphaned(e,t))})),nc.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Nr.Vr(t),nc.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Nr.gr(t);return nc.resolve(n)}containsKey(e,t){return nc.resolve(this.Nr.containsKey(t))}}class jh{constructor(e,t){this.Br={},this.overlays={},this.kr=new ic(0),this.qr=!1,this.qr=!0,this.referenceDelegate=e(this),this.Qr=new Rh(this),this.indexManager=new _h,this.remoteDocumentCache=function(e){return new Ph(e)}((e=>this.referenceDelegate.Kr(e))),this.serializer=new gh(t),this.$r=new Sh(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Ah,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Br[e.toKey()];return n||(n=new Ch(t,this.referenceDelegate),this.Br[e.toKey()]=n),n}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(e,t,n){bo("MemoryPersistence","Starting transaction:",e);const r=new Lh(this.kr.next());return this.referenceDelegate.Ur(),n(r).next((e=>this.referenceDelegate.Wr(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Gr(e,t){return nc.or(Object.values(this.Br).map((n=>()=>n.containsKey(e,t))))}}class Lh extends ec{constructor(e){super(),this.currentSequenceNumber=e}}class Dh{constructor(e){this.persistence=e,this.zr=new Oh,this.jr=null}static Hr(e){return new Dh(e)}get Jr(){if(this.jr)return this.jr;throw ko()}addReference(e,t,n){return this.zr.addReference(n,t),this.Jr.delete(n.toString()),nc.resolve()}removeReference(e,t,n){return this.zr.removeReference(n,t),this.Jr.add(n.toString()),nc.resolve()}markPotentiallyOrphaned(e,t){return this.Jr.add(t.toString()),nc.resolve()}removeTarget(e,t){this.zr.Vr(t.targetId).forEach((e=>this.Jr.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Jr.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Ur(){this.jr=new Set}Wr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return nc.forEach(this.Jr,(n=>{const r=Zo.fromPath(n);return this.Yr(e,r).next((e=>{e||t.removeEntry(r,zo.min())}))})).next((()=>(this.jr=null,t.apply(e))))}updateLimboDocument(e,t){return this.Yr(e,t).next((e=>{e?this.Jr.delete(t.toString()):this.Jr.add(t.toString())}))}Kr(e){return 0}Yr(e,t){return nc.or([()=>nc.resolve(this.zr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gr(e,t)])}}class Mh{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.qi=n,this.Qi=r}static Ki(e,t){let n=Fu(),r=Fu();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Mh(e,t.fromCache,n,r)}}class Uh{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class $h{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=!function(){var e;const t=null===(e=dn())||void 0===e?void 0:e.forceEnvironment;if("node"===t)return!0;if("browser"===t)return!1;try{return"[object process]"===Object.prototype.toString.call(s.g.process)}catch(e){return!1}}()&&navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")?8:function(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}(vn())>0?6:4}initialize(e,t){this.zi=e,this.indexManager=t,this.$i=!0}getDocumentsMatchingQuery(e,t,n,r){const i={result:null};return this.ji(e,t).next((e=>{i.result=e})).next((()=>{if(!i.result)return this.Hi(e,t,r,n).next((e=>{i.result=e}))})).next((()=>{if(i.result)return;const n=new Uh;return this.Ji(e,t,n).next((r=>{if(i.result=r,this.Ui)return this.Yi(e,t,n,r.size)}))})).next((()=>i.result))}Yi(e,t,n,r){return n.documentReadCount<this.Wi?(wo()<=Ln.DEBUG&&bo("QueryEngine","SDK will not create cache indexes for query:",ku(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),nc.resolve()):(wo()<=Ln.DEBUG&&bo("QueryEngine","Query:",ku(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Gi*r?(wo()<=Ln.DEBUG&&bo("QueryEngine","The SDK decides to create cache indexes for query:",ku(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,bu(t))):nc.resolve())}ji(e,t){if(_u(t))return nc.resolve(null);let n=bu(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=Eu(t,null,"F"),n=bu(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const i=Fu(...r);return this.zi.getDocuments(e,i).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{const s=this.Zi(t,r);return this.Xi(t,s,i,n.readTime)?this.ji(e,Eu(t,null,"F")):this.es(e,s,t,n)}))))})))))}Hi(e,t,n,r){return _u(t)||r.isEqual(zo.min())?nc.resolve(null):this.zi.getDocuments(e,n).next((i=>{const s=this.Zi(t,i);return this.Xi(t,s,n,r)?nc.resolve(null):(wo()<=Ln.DEBUG&&bo("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),ku(t)),this.es(e,s,t,function(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,i=zo.fromTimestamp(1e9===r?new qo(n+1,0):new qo(n,r));return new Qo(i,Zo.empty(),-1)}(r)).next((e=>e)))}))}Zi(e,t){let n=new fc(Au(e));return t.forEach(((t,r)=>{Su(e,r)&&(n=n.add(r))})),n}Xi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}Ji(e,t,n){return wo()<=Ln.DEBUG&&bo("QueryEngine","Using full collection scan to execute query:",ku(t)),this.zi.getDocumentsMatchingQuery(e,t,Qo.min(),n)}es(e,t,n,r){return this.zi.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class Fh{constructor(e,t,n,r){this.persistence=e,this.ts=t,this.serializer=r,this.ns=new lc(Bo),this.rs=new xu((e=>pu(e)),mu),this.ss=new Map,this.os=e.getRemoteDocumentCache(),this.Qr=e.getTargetCache(),this.$r=e.getBundleCache(),this._s(n)}_s(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new kh(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.ns)))}}async function Bh(e,t){const n=Ao(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((i=>(r=i,n._s(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const i=[],s=[];let a=Fu();for(const e of r){i.push(e.batchId);for(const t of e.mutations)a=a.add(t.key)}for(const e of t){s.push(e.batchId);for(const t of e.mutations)a=a.add(t.key)}return n.localDocuments.getDocuments(e,a).next((e=>({us:e,removedBatchIds:i,addedBatchIds:s})))}))}))}function Vh(e){const t=Ao(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Qr.getLastRemoteSnapshotVersion(e)))}function qh(e,t){const n=Ao(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}async function zh(e,t,n){const r=Ao(e),i=r.ns.get(t),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,(e=>r.persistence.referenceDelegate.removeTarget(e,i)))}catch(e){if(!rc(e))throw e;bo("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.ns=r.ns.remove(t),r.rs.delete(i.target)}function Hh(e,t,n){const r=Ao(e);let i=zo.min(),s=Fu();return r.persistence.runTransaction("Execute query","readwrite",(e=>function(e,t,n){const r=Ao(e),i=r.rs.get(n);return void 0!==i?nc.resolve(r.ns.get(i)):r.Qr.getTargetData(t,n)}(r,e,bu(t)).next((t=>{if(t)return i=t.lastLimboFreeSnapshotVersion,r.Qr.getMatchingKeysForTargetId(e,t.targetId).next((e=>{s=e}))})).next((()=>r.ts.getDocumentsMatchingQuery(e,t,n?i:zo.min(),n?s:Fu()))).next((e=>(function(e,t,n){let r=e.ss.get(t)||zo.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.ss.set(t,r)}(r,function(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}(t),e),{documents:e,hs:s})))))}class Kh{constructor(){this.activeTargetIds=Bu}As(e){this.activeTargetIds=this.activeTargetIds.add(e)}Rs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}ds(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Wh{constructor(){this.no=new Kh,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.no.As(e),this.ro[e]||"not-current"}updateQueryState(e,t,n){this.ro[e]=t}removeLocalQueryTarget(e){this.no.Rs(e)}isLocalQueryTarget(e){return this.no.activeTargetIds.has(e)}clearQueryState(e){delete this.ro[e]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(e){return this.no.activeTargetIds.has(e)}start(){return this.no=new Kh,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Gh{io(e){}shutdown(){}}class Zh{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(e){this.uo.push(e)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){bo("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.uo)e(0)}ao(){bo("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.uo)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let Jh=null;function Qh(){return null===Jh?Jh=268435456+Math.round(2147483648*Math.random()):Jh++,"0x"+Jh.toString(16)}const Xh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Yh{constructor(e){this.lo=e.lo,this.ho=e.ho}Po(e){this.Io=e}To(e){this.Eo=e}Ao(e){this.Ro=e}onMessage(e){this.Vo=e}close(){this.ho()}send(e){this.lo(e)}mo(){this.Io()}fo(){this.Eo()}po(e){this.Ro(e)}yo(e){this.Vo(e)}}const ed="WebChannelConnection";class td extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.wo=t+"://"+e.host,this.So=`projects/${n}/databases/${r}`,this.bo="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get Do(){return!1}Co(e,t,n,r,i){const s=Qh(),a=this.vo(e,t.toUriEncodedString());bo("RestConnection",`Sending RPC '${e}' ${s}:`,a,n);const o={"google-cloud-resource-prefix":this.So,"x-goog-request-params":this.bo};return this.Fo(o,r,i),this.Mo(e,a,o,n).then((t=>(bo("RestConnection",`Received RPC '${e}' ${s}: `,t),t)),(t=>{throw Io("RestConnection",`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t}))}xo(e,t,n,r,i,s){return this.Co(e,t,n,r,i)}Fo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+vo,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}vo(e,t){const n=Xh[e];return`${this.wo}/v1/${t}:${n}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Mo(e,t,n,r){const i=Qh();return new Promise(((s,a)=>{const o=new io;o.setWithCredentials(!0),o.listenOnce(oo.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case co.NO_ERROR:const t=o.getResponseJson();bo(ed,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case co.TIMEOUT:bo(ed,`RPC '${e}' ${i} timed out`),a(new xo(Oo.DEADLINE_EXCEEDED,"Request time out"));break;case co.HTTP_ERROR:const n=o.getStatus();if(bo(ed,`RPC '${e}' ${i} failed with status:`,n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(Oo).indexOf(t)>=0?t:Oo.UNKNOWN}(t.status);a(new xo(e,t.message))}else a(new xo(Oo.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new xo(Oo.UNAVAILABLE,"Connection failed."));break;default:ko()}}finally{bo(ed,`RPC '${e}' ${i} completed.`)}}));const c=JSON.stringify(r);bo(ed,`RPC '${e}' ${i} sending request:`,r),o.send(t,"POST",c,n,15)}))}Oo(e,t,n){const r=Qh(),i=[this.wo,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=fo(),a=ho(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;void 0!==c&&(o.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(o.xmlHttpFactory=new so({})),this.Fo(o.initMessageHeaders,t,n),o.encodeInitMessageHeaders=!0;const u=i.join("");bo(ed,`Creating RPC '${e}' stream ${r}: ${u}`,o);const l=s.createWebChannel(u,o);let h=!1,d=!1;const f=new Yh({lo:t=>{d?bo(ed,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(h||(bo(ed,`Opening RPC '${e}' stream ${r} transport.`),l.open(),h=!0),bo(ed,`RPC '${e}' stream ${r} sending:`,t),l.send(t))},ho:()=>l.close()}),p=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return p(l,ao.EventType.OPEN,(()=>{d||(bo(ed,`RPC '${e}' stream ${r} transport opened.`),f.mo())})),p(l,ao.EventType.CLOSE,(()=>{d||(d=!0,bo(ed,`RPC '${e}' stream ${r} transport closed`),f.po())})),p(l,ao.EventType.ERROR,(t=>{d||(d=!0,Io(ed,`RPC '${e}' stream ${r} transport errored:`,t),f.po(new xo(Oo.UNAVAILABLE,"The operation could not be completed")))})),p(l,ao.EventType.MESSAGE,(t=>{var n;if(!d){const i=t.data[0];So(!!i);const s=i,a=s.error||(null===(n=s[0])||void 0===n?void 0:n.error);if(a){bo(ed,`RPC '${e}' stream ${r} received error:`,a);const t=a.status;let n=function(e){const t=El[e];if(void 0!==t)return Tl(t)}(t),i=a.message;void 0===n&&(n=Oo.INTERNAL,i="Unknown error status: "+t+" with message "+a.message),d=!0,f.po(new xo(n,i)),l.close()}else bo(ed,`RPC '${e}' stream ${r} received:`,i),f.yo(i)}})),p(a,lo.STAT_EVENT,(t=>{t.stat===uo.PROXY?bo(ed,`RPC '${e}' stream ${r} detected buffering proxy`):t.stat===uo.NOPROXY&&bo(ed,`RPC '${e}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{f.fo()}),0),f}}function nd(){return"undefined"!=typeof document?document:null}function rd(e){return new Vl(e,!0)}class id{constructor(e,t,n=1e3,r=1.5,i=6e4){this.oi=e,this.timerId=t,this.No=n,this.Lo=r,this.Bo=i,this.ko=0,this.qo=null,this.Qo=Date.now(),this.reset()}reset(){this.ko=0}Ko(){this.ko=this.Bo}$o(e){this.cancel();const t=Math.floor(this.ko+this.Uo()),n=Math.max(0,Date.now()-this.Qo),r=Math.max(0,t-n);r>0&&bo("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.ko} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.qo=this.oi.enqueueAfterDelay(this.timerId,r,(()=>(this.Qo=Date.now(),e()))),this.ko*=this.Lo,this.ko<this.No&&(this.ko=this.No),this.ko>this.Bo&&(this.ko=this.Bo)}Wo(){null!==this.qo&&(this.qo.skipDelay(),this.qo=null)}cancel(){null!==this.qo&&(this.qo.cancel(),this.qo=null)}Uo(){return(Math.random()-.5)*this.ko}}class sd{constructor(e,t,n,r,i,s,a,o){this.oi=e,this.Go=n,this.zo=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.jo=0,this.Ho=null,this.Jo=null,this.stream=null,this.Yo=new id(e,t)}Zo(){return 1===this.state||5===this.state||this.Xo()}Xo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.e_()}async stop(){this.Zo()&&await this.close(0)}t_(){this.state=0,this.Yo.reset()}n_(){this.Xo()&&null===this.Ho&&(this.Ho=this.oi.enqueueAfterDelay(this.Go,6e4,(()=>this.r_())))}i_(e){this.s_(),this.stream.send(e)}async r_(){if(this.Xo())return this.close(0)}s_(){this.Ho&&(this.Ho.cancel(),this.Ho=null)}o_(){this.Jo&&(this.Jo.cancel(),this.Jo=null)}async close(e,t){this.s_(),this.o_(),this.Yo.cancel(),this.jo++,4!==e?this.Yo.reset():t&&t.code===Oo.RESOURCE_EXHAUSTED?(Eo(t.toString()),Eo("Using maximum backoff delay to prevent overloading the backend."),this.Yo.Ko()):t&&t.code===Oo.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.__(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Ao(t)}__(){}auth(){this.state=1;const e=this.a_(this.jo),t=this.jo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.jo===t&&this.u_(e,n)}),(t=>{e((()=>{const e=new xo(Oo.UNKNOWN,"Fetching auth token failed: "+t.message);return this.c_(e)}))}))}u_(e,t){const n=this.a_(this.jo);this.stream=this.l_(e,t),this.stream.Po((()=>{n((()=>this.listener.Po()))})),this.stream.To((()=>{n((()=>(this.state=2,this.Jo=this.oi.enqueueAfterDelay(this.zo,1e4,(()=>(this.Xo()&&(this.state=3),Promise.resolve()))),this.listener.To())))})),this.stream.Ao((e=>{n((()=>this.c_(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}e_(){this.state=5,this.Yo.$o((async()=>{this.state=0,this.start()}))}c_(e){return bo("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}a_(e){return t=>{this.oi.enqueueAndForget((()=>this.jo===e?t():(bo("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class ad extends sd{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}l_(e,t){return this.connection.Oo("Listen",e,t)}onMessage(e){this.Yo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:ko()}(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],s=function(e,t){return e.useProto3Json?(So(void 0===t||"string"==typeof t),yc.fromBase64String(t||"")):(So(void 0===t||t instanceof Buffer||t instanceof Uint8Array),yc.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),a=t.targetChange.cause,o=a&&function(e){const t=void 0===e.code?Oo.UNKNOWN:Tl(e.code);return new xo(t,e.message||"")}(a);n=new jl(r,i,s,o||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const i=Xl(e,r.document.name),s=Wl(r.document.updateTime),a=r.document.createTime?Wl(r.document.createTime):zo.min(),o=new Vc({mapValue:{fields:r.document.fields}}),c=zc.newFoundDocument(i,s,a,o),u=r.targetIds||[],l=r.removedTargetIds||[];n=new Nl(u,l,c.key,c)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const i=Xl(e,r.document),s=r.readTime?Wl(r.readTime):zo.min(),a=zc.newNoDocument(i,s),o=r.removedTargetIds||[];n=new Nl([],o,a.key,a)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const i=Xl(e,r.document),s=r.removedTargetIds||[];n=new Nl([],s,i,null)}else{if(!("filter"in t))return ko();{t.filter;const e=t.filter;e.targetId;const{count:r=0,unchangedNames:i}=e,s=new bl(r,i),a=e.targetId;n=new Rl(a,s)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return zo.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?zo.min():t.readTime?Wl(t.readTime):zo.min()}(e);return this.listener.h_(t,n)}P_(e){const t={};t.database=eh(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=gu(r)?{documents:rh(e,r)}:{query:ih(e,r)._t},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=Hl(e,t.resumeToken);const r=ql(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(zo.min())>0){n.readTime=zl(e,t.snapshotVersion.toTimestamp());const r=ql(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);const n=function(e,t){const n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return ko()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.i_(t)}I_(e){const t={};t.database=eh(this.serializer),t.removeTarget=e,this.i_(t)}}class od extends sd{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i,this.T_=!1}get E_(){return this.T_}start(){this.T_=!1,this.lastStreamToken=void 0,super.start()}__(){this.T_&&this.d_([])}l_(e,t){return this.connection.Oo("Write",e,t)}onMessage(e){if(So(!!e.streamToken),this.lastStreamToken=e.streamToken,this.T_){this.Yo.reset();const t=function(e,t){return e&&e.length>0?(So(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?Wl(e.updateTime):Wl(t);return n.isEqual(zo.min())&&(n=Wl(t)),new nl(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=Wl(e.commitTime);return this.listener.A_(n,t)}return So(!e.writeResults||0===e.writeResults.length),this.T_=!0,this.listener.R_()}V_(){const e={};e.database=eh(this.serializer),this.i_(e)}d_(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>function(e,t){let n;if(t instanceof hl)n={update:nh(e,t.key,t.value)};else if(t instanceof gl)n={delete:Ql(e,t.key)};else if(t instanceof dl)n={update:nh(e,t.key,t.data),updateMask:fh(t.fieldMask)};else{if(!(t instanceof yl))return ko();n={verify:Ql(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof Gu)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Zu)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Qu)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Yu)return{fieldPath:t.field.canonicalString(),increment:n.Pe};throw ko()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:Kl(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:ko()}(e,t.precondition)),n}(this.serializer,e)))};this.i_(t)}}class cd extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.m_=!1}f_(){if(this.m_)throw new xo(Oo.FAILED_PRECONDITION,"The client has already been terminated.")}Co(e,t,n,r){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,s])=>this.connection.Co(e,Zl(t,n),r,i,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===Oo.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new xo(Oo.UNKNOWN,e.toString())}))}xo(e,t,n,r,i){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,a])=>this.connection.xo(e,Zl(t,n),r,s,a,i))).catch((e=>{throw"FirebaseError"===e.name?(e.code===Oo.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new xo(Oo.UNKNOWN,e.toString())}))}terminate(){this.m_=!0,this.connection.terminate()}}class ud{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.g_=0,this.p_=null,this.y_=!0}w_(){0===this.g_&&(this.S_("Unknown"),this.p_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.p_=null,this.b_("Backend didn't respond within 10 seconds."),this.S_("Offline"),Promise.resolve()))))}D_(e){"Online"===this.state?this.S_("Unknown"):(this.g_++,this.g_>=1&&(this.C_(),this.b_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.S_("Offline")))}set(e){this.C_(),this.g_=0,"Online"===e&&(this.y_=!1),this.S_(e)}S_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}b_(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.y_?(Eo(t),this.y_=!1):bo("OnlineStateTracker",t)}C_(){null!==this.p_&&(this.p_.cancel(),this.p_=null)}}class ld{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.v_=[],this.F_=new Map,this.M_=new Set,this.x_=[],this.O_=i,this.O_.io((e=>{n.enqueueAndForget((async()=>{_d(this)&&(bo("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=Ao(e);t.M_.add(4),await dd(t),t.N_.set("Unknown"),t.M_.delete(4),await hd(t)}(this))}))})),this.N_=new ud(n,r)}}async function hd(e){if(_d(e))for(const t of e.x_)await t(!0)}async function dd(e){for(const t of e.x_)await t(!1)}function fd(e,t){const n=Ao(e);n.F_.has(t.targetId)||(n.F_.set(t.targetId,t),vd(n)?yd(n):Md(n).Xo()&&md(n,t))}function pd(e,t){const n=Ao(e),r=Md(n);n.F_.delete(t),r.Xo()&&gd(n,t),0===n.F_.size&&(r.Xo()?r.n_():_d(n)&&n.N_.set("Unknown"))}function md(e,t){if(e.L_.xe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(zo.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}Md(e).P_(t)}function gd(e,t){e.L_.xe(t),Md(e).I_(t)}function yd(e){e.L_=new Dl({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>e.F_.get(t)||null,tt:()=>e.datastore.serializer.databaseId}),Md(e).start(),e.N_.w_()}function vd(e){return _d(e)&&!Md(e).Zo()&&e.F_.size>0}function _d(e){return 0===Ao(e).M_.size}function wd(e){e.L_=void 0}async function bd(e){e.N_.set("Online")}async function Ed(e){e.F_.forEach(((t,n)=>{md(e,t)}))}async function Id(e,t){wd(e),vd(e)?(e.N_.D_(t),yd(e)):e.N_.set("Unknown")}async function Td(e,t,n){if(e.N_.set("Online"),t instanceof jl&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.F_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.F_.delete(r),e.L_.removeTarget(r))}(e,t)}catch(n){bo("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await kd(e,n)}else if(t instanceof Nl?e.L_.Ke(t):t instanceof Rl?e.L_.He(t):e.L_.We(t),!n.isEqual(zo.min()))try{const t=await Vh(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.L_.rt(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const i=e.F_.get(r);i&&e.F_.set(r,i.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach(((t,n)=>{const r=e.F_.get(t);if(!r)return;e.F_.set(t,r.withResumeToken(yc.EMPTY_BYTE_STRING,r.snapshotVersion)),gd(e,t);const i=new mh(r.target,t,n,r.sequenceNumber);md(e,i)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){bo("RemoteStore","Failed to raise snapshot:",t),await kd(e,t)}}async function kd(e,t,n){if(!rc(t))throw t;e.M_.add(1),await dd(e),e.N_.set("Offline"),n||(n=()=>Vh(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{bo("RemoteStore","Retrying IndexedDB access"),await n(),e.M_.delete(1),await hd(e)}))}function Sd(e,t){return t().catch((n=>kd(e,n,t)))}async function Ad(e){const t=Ao(e),n=Ud(t);let r=t.v_.length>0?t.v_[t.v_.length-1].batchId:-1;for(;Od(t);)try{const e=await qh(t.localStore,r);if(null===e){0===t.v_.length&&n.n_();break}r=e.batchId,xd(t,e)}catch(e){await kd(t,e)}Cd(t)&&Pd(t)}function Od(e){return _d(e)&&e.v_.length<10}function xd(e,t){e.v_.push(t);const n=Ud(e);n.Xo()&&n.E_&&n.d_(t.mutations)}function Cd(e){return _d(e)&&!Ud(e).Zo()&&e.v_.length>0}function Pd(e){Ud(e).start()}async function Nd(e){Ud(e).V_()}async function Rd(e){const t=Ud(e);for(const n of e.v_)t.d_(n.mutations)}async function jd(e,t,n){const r=e.v_.shift(),i=_l.from(r,t,n);await Sd(e,(()=>e.remoteSyncer.applySuccessfulWrite(i))),await Ad(e)}async function Ld(e,t){t&&Ud(e).E_&&await async function(e,t){if(function(e){return function(e){switch(e){default:return ko();case Oo.CANCELLED:case Oo.UNKNOWN:case Oo.DEADLINE_EXCEEDED:case Oo.RESOURCE_EXHAUSTED:case Oo.INTERNAL:case Oo.UNAVAILABLE:case Oo.UNAUTHENTICATED:return!1;case Oo.INVALID_ARGUMENT:case Oo.NOT_FOUND:case Oo.ALREADY_EXISTS:case Oo.PERMISSION_DENIED:case Oo.FAILED_PRECONDITION:case Oo.ABORTED:case Oo.OUT_OF_RANGE:case Oo.UNIMPLEMENTED:case Oo.DATA_LOSS:return!0}}(e)&&e!==Oo.ABORTED}(t.code)){const n=e.v_.shift();Ud(e).t_(),await Sd(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await Ad(e)}}(e,t),Cd(e)&&Pd(e)}async function Dd(e,t){const n=Ao(e);n.asyncQueue.verifyOperationInProgress(),bo("RemoteStore","RemoteStore received new credentials");const r=_d(n);n.M_.add(3),await dd(n),r&&n.N_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.M_.delete(3),await hd(n)}function Md(e){return e.B_||(e.B_=function(e,t,n){const r=Ao(e);return r.f_(),new ad(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Po:bd.bind(null,e),To:Ed.bind(null,e),Ao:Id.bind(null,e),h_:Td.bind(null,e)}),e.x_.push((async t=>{t?(e.B_.t_(),vd(e)?yd(e):e.N_.set("Unknown")):(await e.B_.stop(),wd(e))}))),e.B_}function Ud(e){return e.k_||(e.k_=function(e,t,n){const r=Ao(e);return r.f_(),new od(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Po:()=>Promise.resolve(),To:Nd.bind(null,e),Ao:Ld.bind(null,e),R_:Rd.bind(null,e),A_:jd.bind(null,e)}),e.x_.push((async t=>{t?(e.k_.t_(),await Ad(e)):(await e.k_.stop(),e.v_.length>0&&(bo("RemoteStore",`Stopping write stream with ${e.v_.length} pending writes`),e.v_=[]))}))),e.k_}class $d{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Co,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){const s=Date.now()+n,a=new $d(e,t,s,r,i);return a.start(n),a}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new xo(Oo.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Fd(e,t){if(Eo("AsyncQueue",`${t}: ${e}`),rc(e))return new xo(Oo.UNAVAILABLE,`${t}: ${e}`);throw e}class Bd{constructor(e){this.comparator=e?(t,n)=>e(t,n)||Zo.comparator(t.key,n.key):(e,t)=>Zo.comparator(e.key,t.key),this.keyedMap=Ru(),this.sortedSet=new lc(this.comparator)}static emptySet(e){return new Bd(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Bd))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new Bd;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Vd{constructor(){this.q_=new lc(Zo.comparator)}track(e){const t=e.doc.key,n=this.q_.get(t);n?0!==e.type&&3===n.type?this.q_=this.q_.insert(t,e):3===e.type&&1!==n.type?this.q_=this.q_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.q_=this.q_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.q_=this.q_.remove(t):1===e.type&&2===n.type?this.q_=this.q_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):ko():this.q_=this.q_.insert(t,e)}Q_(){const e=[];return this.q_.inorderTraversal(((t,n)=>{e.push(n)})),e}}class qd{constructor(e,t,n,r,i,s,a,o,c){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=c}static fromInitialDocuments(e,t,n,r,i){const s=[];return t.forEach((e=>{s.push({type:0,doc:e})})),new qd(e,t,Bd.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Iu(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class zd{constructor(){this.K_=void 0,this.U_=[]}W_(){return this.U_.some((e=>e.G_()))}}class Hd{constructor(){this.queries=new xu((e=>Tu(e)),Iu),this.onlineState="Unknown",this.z_=new Set}}function Kd(e,t){const n=Ao(e);let r=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.U_)t.H_(e)&&(r=!0);i.K_=e}}r&&Gd(n)}function Wd(e,t,n){const r=Ao(e),i=r.queries.get(t);if(i)for(const e of i.U_)e.onError(n);r.queries.delete(t)}function Gd(e){e.z_.forEach((e=>{e.next()}))}var Zd,Jd;(Jd=Zd||(Zd={})).J_="default",Jd.Cache="cache";class Qd{constructor(e,t,n){this.query=e,this.Y_=t,this.Z_=!1,this.X_=null,this.onlineState="Unknown",this.options=n||{}}H_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new qd(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Z_?this.ea(e)&&(this.Y_.next(e),t=!0):this.ta(e,this.onlineState)&&(this.na(e),t=!0),this.X_=e,t}onError(e){this.Y_.error(e)}j_(e){this.onlineState=e;let t=!1;return this.X_&&!this.Z_&&this.ta(this.X_,e)&&(this.na(this.X_),t=!0),t}ta(e,t){if(!e.fromCache)return!0;if(!this.G_())return!0;const n="Offline"!==t;return(!this.options.ra||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}ea(e){if(e.docChanges.length>0)return!0;const t=this.X_&&this.X_.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}na(e){e=qd.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Z_=!0,this.Y_.next(e)}G_(){return this.options.source!==Zd.Cache}}class Xd{constructor(e){this.key=e}}class Yd{constructor(e){this.key=e}}class ef{constructor(e,t){this.query=e,this.la=t,this.ha=null,this.hasCachedResults=!1,this.current=!1,this.Pa=Fu(),this.mutatedKeys=Fu(),this.Ia=Au(e),this.Ta=new Bd(this.Ia)}get Ea(){return this.la}da(e,t){const n=t?t.Aa:new Vd,r=t?t.Ta:this.Ta;let i=t?t.mutatedKeys:this.mutatedKeys,s=r,a=!1;const o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,c="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const u=r.get(e),l=Su(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;u&&l?u.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Ra(u,l)||(n.track({type:2,doc:l}),f=!0,(o&&this.Ia(l,o)>0||c&&this.Ia(l,c)<0)&&(a=!0)):!u&&l?(n.track({type:0,doc:l}),f=!0):u&&!l&&(n.track({type:1,doc:u}),f=!0,(o||c)&&(a=!0)),f&&(l?(s=s.add(l),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))})),null!==this.query.limit)for(;s.size>this.query.limit;){const e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{Ta:s,Aa:n,Xi:a,mutatedKeys:i}}Ra(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){const i=this.Ta;this.Ta=e.Ta,this.mutatedKeys=e.mutatedKeys;const s=e.Aa.Q_();s.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return ko()}};return n(e)-n(t)}(e.type,t.type)||this.Ia(e.doc,t.doc))),this.Va(n),r=null!=r&&r;const a=t&&!r?this.ma():[],o=0===this.Pa.size&&this.current&&!r?1:0,c=o!==this.ha;return this.ha=o,0!==s.length||c?{snapshot:new qd(this.query,e.Ta,i,s,e.mutatedKeys,0===o,c,!1,!!n&&n.resumeToken.approximateByteSize()>0),fa:a}:{fa:a}}j_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ta:this.Ta,Aa:new Vd,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{fa:[]}}ga(e){return!this.la.has(e)&&!!this.Ta.has(e)&&!this.Ta.get(e).hasLocalMutations}Va(e){e&&(e.addedDocuments.forEach((e=>this.la=this.la.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.la=this.la.delete(e))),this.current=e.current)}ma(){if(!this.current)return[];const e=this.Pa;this.Pa=Fu(),this.Ta.forEach((e=>{this.ga(e.key)&&(this.Pa=this.Pa.add(e.key))}));const t=[];return e.forEach((e=>{this.Pa.has(e)||t.push(new Yd(e))})),this.Pa.forEach((n=>{e.has(n)||t.push(new Xd(n))})),t}pa(e){this.la=e.hs,this.Pa=Fu();const t=this.da(e.documents);return this.applyChanges(t,!0)}ya(){return qd.fromInitialDocuments(this.query,this.Ta,this.mutatedKeys,0===this.ha,this.hasCachedResults)}}class tf{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class nf{constructor(e){this.key=e,this.wa=!1}}class rf{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Sa={},this.ba=new xu((e=>Tu(e)),Iu),this.Da=new Map,this.Ca=new Set,this.va=new lc(Zo.comparator),this.Fa=new Map,this.Ma=new Oh,this.xa={},this.Oa=new Map,this.Na=Eh.Ln(),this.onlineState="Unknown",this.La=void 0}get isPrimaryClient(){return!0===this.La}}async function sf(e,t,n=!0){const r=kf(e);let i;const s=r.ba.get(t);return s?(r.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.ya()):i=await of(r,t,n,!0),i}async function af(e,t){const n=kf(e);await of(n,t,!0,!1)}async function of(e,t,n,r){const i=await function(e,t){const n=Ao(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Qr.getTargetData(e,t).next((i=>i?(r=i,nc.resolve(r)):n.Qr.allocateTargetId(e).next((i=>(r=new mh(t,i,"TargetPurposeListen",e.currentSequenceNumber),n.Qr.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.ns.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.ns=n.ns.insert(e.targetId,e),n.rs.set(t,e.targetId)),e}))}(e.localStore,bu(t)),s=i.targetId,a=n?e.sharedClientState.addLocalQueryTarget(s):"not-current";let o;return r&&(o=await async function(e,t,n,r,i){e.Ba=(t,n,r)=>async function(e,t,n,r){let i=t.view.da(n);i.Xi&&(i=await Hh(e.localStore,t.query,!1).then((({documents:e})=>t.view.da(e,i))));const s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return _f(e,t.targetId,o.fa),o.snapshot}(e,t,n,r);const s=await Hh(e.localStore,t,!0),a=new ef(t,s.hs),o=a.da(s.documents),c=Pl.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,c);_f(e,n,u.fa);const l=new tf(t,n,a);return e.ba.set(t,l),e.Da.has(n)?e.Da.get(n).push(t):e.Da.set(n,[t]),u.snapshot}(e,t,s,"current"===a,i.resumeToken)),e.isPrimaryClient&&n&&fd(e.remoteStore,i),o}async function cf(e,t,n){const r=Ao(e),i=r.ba.get(t),s=r.Da.get(i.targetId);if(s.length>1)return r.Da.set(i.targetId,s.filter((e=>!Iu(e,t)))),void r.ba.delete(t);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||await zh(r.localStore,i.targetId,!1).then((()=>{r.sharedClientState.clearQueryState(i.targetId),n&&pd(r.remoteStore,i.targetId),yf(r,i.targetId)})).catch(tc)):(yf(r,i.targetId),await zh(r.localStore,i.targetId,!0))}async function uf(e,t){const n=Ao(e),r=n.ba.get(t),i=n.Da.get(r.targetId);n.isPrimaryClient&&1===i.length&&(n.sharedClientState.removeLocalQueryTarget(r.targetId),pd(n.remoteStore,r.targetId))}async function lf(e,t){const n=Ao(e);try{const e=await function(e,t){const n=Ao(e),r=t.snapshotVersion;let i=n.ns;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const s=n.os.newChangeBuffer({trackRemovals:!0});i=n.ns;const a=[];t.targetChanges.forEach(((s,o)=>{const c=i.get(o);if(!c)return;a.push(n.Qr.removeMatchingKeys(e,s.removedDocuments,o).next((()=>n.Qr.addMatchingKeys(e,s.addedDocuments,o))));let u=c.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(o)?u=u.withResumeToken(yc.EMPTY_BYTE_STRING,zo.min()).withLastLimboFreeSnapshotVersion(zo.min()):s.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(s.resumeToken,r)),i=i.insert(o,u),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,s)&&a.push(n.Qr.updateTargetData(e,u))}));let o=Pu(),c=Fu();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&a.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),a.push(function(e,t,n){let r=Fu(),i=Fu();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=Pu();return n.forEach(((n,s)=>{const a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(zo.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):bo("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)})),{cs:r,ls:i}}))}(e,s,t.documentUpdates).next((e=>{o=e.cs,c=e.ls}))),!r.isEqual(zo.min())){const t=n.Qr.getLastRemoteSnapshotVersion(e).next((t=>n.Qr.setTargetsMetadata(e,e.currentSequenceNumber,r)));a.push(t)}return nc.waitFor(a).next((()=>s.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,o,c))).next((()=>o))})).then((e=>(n.ns=i,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.Fa.get(t);r&&(So(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.wa=!0:e.modifiedDocuments.size>0?So(r.wa):e.removedDocuments.size>0&&(So(r.wa),r.wa=!1))})),await Ef(n,e,t)}catch(e){await tc(e)}}function hf(e,t,n){const r=Ao(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.ba.forEach(((n,r)=>{const i=r.view.j_(t);i.snapshot&&e.push(i.snapshot)})),function(e,t){const n=Ao(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const e of n.U_)e.j_(t)&&(r=!0)})),r&&Gd(n)}(r.eventManager,t),e.length&&r.Sa.h_(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function df(e,t,n){const r=Ao(e);r.sharedClientState.updateQueryState(t,"rejected",n);const i=r.Fa.get(t),s=i&&i.key;if(s){let e=new lc(Zo.comparator);e=e.insert(s,zc.newNoDocument(s,zo.min()));const n=Fu().add(s),i=new Cl(zo.min(),new Map,new lc(Bo),e,n);await lf(r,i),r.va=r.va.remove(s),r.Fa.delete(t),bf(r)}else await zh(r.localStore,t,!1).then((()=>yf(r,t,n))).catch(tc)}async function ff(e,t){const n=Ao(e),r=t.batch.batchId;try{const e=await function(e,t){const n=Ao(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),i=n.os.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const i=n.batch,s=i.keys();let a=nc.resolve();return s.forEach((e=>{a=a.next((()=>r.getEntry(t,e))).next((t=>{const s=n.docVersions.get(e);So(null!==s),t.version.compareTo(s)<0&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),a.next((()=>e.mutationQueue.removeMutationBatch(t,i)))}(n,e,t,i).next((()=>i.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Fu();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);gf(n,r,null),mf(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Ef(n,e)}catch(e){await tc(e)}}async function pf(e,t,n){const r=Ao(e);try{const e=await function(e,t){const n=Ao(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(So(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);gf(r,t,n),mf(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Ef(r,e)}catch(n){await tc(n)}}function mf(e,t){(e.Oa.get(t)||[]).forEach((e=>{e.resolve()})),e.Oa.delete(t)}function gf(e,t,n){const r=Ao(e);let i=r.xa[r.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),r.xa[r.currentUser.toKey()]=i}}function yf(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.Da.get(t))e.ba.delete(r),n&&e.Sa.ka(r,n);e.Da.delete(t),e.isPrimaryClient&&e.Ma.Vr(t).forEach((t=>{e.Ma.containsKey(t)||vf(e,t)}))}function vf(e,t){e.Ca.delete(t.path.canonicalString());const n=e.va.get(t);null!==n&&(pd(e.remoteStore,n),e.va=e.va.remove(t),e.Fa.delete(n),bf(e))}function _f(e,t,n){for(const r of n)r instanceof Xd?(e.Ma.addReference(r.key,t),wf(e,r)):r instanceof Yd?(bo("SyncEngine","Document no longer in limbo: "+r.key),e.Ma.removeReference(r.key,t),e.Ma.containsKey(r.key)||vf(e,r.key)):ko()}function wf(e,t){const n=t.key,r=n.path.canonicalString();e.va.get(n)||e.Ca.has(r)||(bo("SyncEngine","New document in limbo: "+n),e.Ca.add(r),bf(e))}function bf(e){for(;e.Ca.size>0&&e.va.size<e.maxConcurrentLimboResolutions;){const t=e.Ca.values().next().value;e.Ca.delete(t);const n=new Zo(Ko.fromString(t)),r=e.Na.next();e.Fa.set(r,new nf(n)),e.va=e.va.insert(n,r),fd(e.remoteStore,new mh(bu(vu(n.path)),r,"TargetPurposeLimboResolution",ic.oe))}}async function Ef(e,t,n){const r=Ao(e),i=[],s=[],a=[];r.ba.isEmpty()||(r.ba.forEach(((e,o)=>{a.push(r.Ba(o,t,n).then((e=>{if((e||n)&&r.isPrimaryClient){const t=e&&!e.fromCache;r.sharedClientState.updateQueryState(o.targetId,t?"current":"not-current")}if(e){i.push(e);const t=Mh.Ki(o.targetId,e);s.push(t)}})))})),await Promise.all(a),r.Sa.h_(i),await async function(e,t){const n=Ao(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>nc.forEach(t,(t=>nc.forEach(t.qi,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>nc.forEach(t.Qi,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!rc(e))throw e;bo("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.ns.get(t),r=e.snapshotVersion,i=e.withLastLimboFreeSnapshotVersion(r);n.ns=n.ns.insert(t,i)}}}(r.localStore,s))}async function If(e,t){const n=Ao(e);if(!n.currentUser.isEqual(t)){bo("SyncEngine","User change. New user:",t.toKey());const e=await Bh(n.localStore,t);n.currentUser=t,function(e,t){e.Oa.forEach((e=>{e.forEach((e=>{e.reject(new xo(Oo.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.Oa.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await Ef(n,e.us)}}function Tf(e,t){const n=Ao(e),r=n.Fa.get(t);if(r&&r.wa)return Fu().add(r.key);{let e=Fu();const r=n.Da.get(t);if(!r)return e;for(const t of r){const r=n.ba.get(t);e=e.unionWith(r.view.Ea)}return e}}function kf(e){const t=Ao(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=lf.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Tf.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=df.bind(null,t),t.Sa.h_=Kd.bind(null,t.eventManager),t.Sa.ka=Wd.bind(null,t.eventManager),t}function Sf(e){const t=Ao(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=ff.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=pf.bind(null,t),t}class Af{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=rd(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return function(e,t,n,r){return new Fh(e,t,n,r)}(this.persistence,new $h,e.initialUser,this.serializer)}createPersistence(e){return new jh(Dh.Hr,this.serializer)}createSharedClientState(e){return new Wh}async terminate(){var e,t;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(t=this.indexBackfillerScheduler)||void 0===t||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Of{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>hf(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=If.bind(null,this.syncEngine),await async function(e,t){const n=Ao(e);t?(n.M_.delete(2),await hd(n)):t||(n.M_.add(2),await dd(n),n.N_.set("Unknown"))}(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Hd}createDatastore(e){const t=rd(e.databaseInfo.databaseId),n=function(e){return new td(e)}(e.databaseInfo);return function(e,t,n,r){return new cd(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return function(e,t,n,r,i){return new ld(e,t,n,r,i)}(this.localStore,this.datastore,e.asyncQueue,(e=>hf(this.syncEngine,e,0)),Zh.D()?new Zh:new Gh)}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){const o=new rf(e,t,n,r,i,s);return a&&(o.La=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e;await async function(e){const t=Ao(e);bo("RemoteStore","RemoteStore shutting down."),t.M_.add(5),await dd(t),t.O_.shutdown(),t.N_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate()}}class xf{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ka(this.observer.next,e)}error(e){this.observer.error?this.Ka(this.observer.error,e):Eo("Uncaught Error in snapshot listener:",e.toString())}$a(){this.muted=!0}Ka(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Cf{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=yo.UNAUTHENTICATED,this.clientId=Fo.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{bo("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(bo("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new xo(Oo.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new Co;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=Fd(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function Pf(e,t){e.asyncQueue.verifyOperationInProgress(),bo("FirestoreClient","Initializing OfflineComponentProvider");const n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await Bh(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e._offlineComponents=t}async function Nf(e,t){e.asyncQueue.verifyOperationInProgress();const n=await async function(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){bo("FirestoreClient","Using user provided OfflineComponentProvider");try{await Pf(e,e._uninitializedComponentsProvider._offline)}catch(t){const n=t;if(!function(e){return"FirebaseError"===e.name?e.code===Oo.FAILED_PRECONDITION||e.code===Oo.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}(n))throw n;Io("Error using user provided cache. Falling back to memory cache: "+n),await Pf(e,new Af)}}else bo("FirestoreClient","Using default OfflineComponentProvider"),await Pf(e,new Af);return e._offlineComponents}(e);bo("FirestoreClient","Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener((e=>Dd(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Dd(t.remoteStore,n))),e._onlineComponents=t}async function Rf(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(bo("FirestoreClient","Using user provided OnlineComponentProvider"),await Nf(e,e._uninitializedComponentsProvider._online)):(bo("FirestoreClient","Using default OnlineComponentProvider"),await Nf(e,new Of))),e._onlineComponents}async function jf(e){const t=await Rf(e),n=t.eventManager;return n.onListen=sf.bind(null,t.syncEngine),n.onUnlisten=cf.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=af.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=uf.bind(null,t.syncEngine),n}function Lf(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const Df=new Map;function Mf(e,t,n){if(!n)throw new xo(Oo.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Uf(e){if(!Zo.isDocumentKey(e))throw new xo(Oo.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function $f(e){if(Zo.isDocumentKey(e))throw new xo(Oo.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Ff(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":ko()}function Bf(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new xo(Oo.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Ff(e);throw new xo(Oo.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}class Vf{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new xo(Oo.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new xo(Oo.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,n,r){if(!0===t&&!0===r)throw new xo(Oo.INVALID_ARGUMENT,"experimentalForceLongPolling and experimentalAutoDetectLongPolling cannot be used together.")})(0,e.experimentalForceLongPolling,0,e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Lf(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new xo(Oo.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new xo(Oo.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new xo(Oo.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(e,t){return e.timeoutSeconds===t.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class qf{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Vf({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new xo(Oo.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new xo(Oo.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Vf(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new No;switch(e.type){case"firstParty":return new Do(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new xo(Oo.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Df.get(e);t&&(bo("ComponentProvider","Removing Datastore"),Df.delete(e),t.terminate())}(this),Promise.resolve()}}class zf{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new zf(this.firestore,e,this._query)}}class Hf{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Kf(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Hf(this.firestore,e,this._key)}}class Kf extends zf{constructor(e,t,n){super(e,t,vu(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Hf(this.firestore,null,new Zo(e))}withConverter(e){return new Kf(this.firestore,e,this._path)}}function Wf(e,t,...n){if(e=xn(e),Mf("collection","path",t),e instanceof qf){const r=Ko.fromString(t,...n);return $f(r),new Kf(e,null,r)}{if(!(e instanceof Hf||e instanceof Kf))throw new xo(Oo.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(Ko.fromString(t,...n));return $f(r),new Kf(e.firestore,null,r)}}function Gf(e,t,...n){if(e=xn(e),1===arguments.length&&(t=Fo.newId()),Mf("doc","path",t),e instanceof qf){const r=Ko.fromString(t,...n);return Uf(r),new Hf(e,null,new Zo(r))}{if(!(e instanceof Hf||e instanceof Kf))throw new xo(Oo.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(Ko.fromString(t,...n));return Uf(r),new Hf(e.firestore,e instanceof Kf?e.converter:null,new Zo(r))}}class Zf{constructor(){this.iu=Promise.resolve(),this.su=[],this.ou=!1,this._u=[],this.au=null,this.uu=!1,this.cu=!1,this.lu=[],this.Yo=new id(this,"async_queue_retry"),this.hu=()=>{const e=nd();e&&bo("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Yo.Wo()};const e=nd();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.hu)}get isShuttingDown(){return this.ou}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Pu(),this.Iu(e)}enterRestrictedMode(e){if(!this.ou){this.ou=!0,this.cu=e||!1;const t=nd();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.hu)}}enqueue(e){if(this.Pu(),this.ou)return new Promise((()=>{}));const t=new Co;return this.Iu((()=>this.ou&&this.cu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.su.push(e),this.Tu())))}async Tu(){if(0!==this.su.length){try{await this.su[0](),this.su.shift(),this.Yo.reset()}catch(e){if(!rc(e))throw e;bo("AsyncQueue","Operation failed with retryable error: "+e)}this.su.length>0&&this.Yo.$o((()=>this.Tu()))}}Iu(e){const t=this.iu.then((()=>(this.uu=!0,e().catch((e=>{this.au=e,this.uu=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw Eo("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.uu=!1,e))))));return this.iu=t,t}enqueueAfterDelay(e,t,n){this.Pu(),this.lu.indexOf(e)>-1&&(t=0);const r=$d.createAndSchedule(this,e,t,n,(e=>this.Eu(e)));return this._u.push(r),r}Pu(){this.au&&ko()}verifyOperationInProgress(){}async du(){let e;do{e=this.iu,await e}while(e!==this.iu)}Au(e){for(const t of this._u)if(t.timerId===e)return!0;return!1}Ru(e){return this.du().then((()=>{this._u.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this._u)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.du()}))}Vu(e){this.lu.push(e)}Eu(e){const t=this._u.indexOf(e);this._u.splice(t,1)}}class Jf extends qf{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Zf,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Yf(this),this._firestoreClient.terminate()}}function Qf(e,t){const n="string"==typeof e?e:t||"(default)",r=$r("object"==typeof e?e:Hr(),"firestore").getImmediate({identifier:n});if(!r._initialized){const e=pn("firestore");e&&function(e,t,n,r={}){var i;const s=(e=Bf(e,qf))._getSettings(),a=`${t}:${n}`;if("firestore.googleapis.com"!==s.host&&s.host!==a&&Io("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=yo.MOCK_USER;else{t=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const n=t||"demo-project",r=e.iat||0,i=e.sub||e.user_id;if(!i)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const s=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:i,user_id:i,firebase:{sign_in_provider:"custom",identities:{}}},e);return[ln(JSON.stringify({alg:"none",type:"JWT"})),ln(JSON.stringify(s)),""].join(".")}(r.mockUserToken,null===(i=e._app)||void 0===i?void 0:i.options.projectId);const s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new xo(Oo.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new yo(s)}e._authCredentials=new Ro(new Po(t,n))}}(r,...e)}return r}function Xf(e){return e._firestoreClient||Yf(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Yf(e){var t,n,r;const i=e._freezeSettings(),s=function(e,t,n,r){return new kc(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,Lf(r.experimentalLongPollingOptions),r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,i);e._firestoreClient=new Cf(e._authCredentials,e._appCheckCredentials,e._queue,s),(null===(n=i.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=i.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}class ep{constructor(e){this._byteString=e}static fromBase64String(e){try{return new ep(yc.fromBase64String(e))}catch(e){throw new xo(Oo.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new ep(yc.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class tp{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new xo(Oo.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Go(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class np{constructor(e){this._methodName=e}}class rp{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new xo(Oo.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new xo(Oo.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Bo(this._lat,e._lat)||Bo(this._long,e._long)}}const ip=/^__.*__$/;class sp{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new dl(e,this.data,this.fieldMask,t,this.fieldTransforms):new hl(e,this.data,t,this.fieldTransforms)}}function ap(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw ko()}}class op{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.mu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get fu(){return this.settings.fu}gu(e){return new op(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}pu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.gu({path:n,yu:!1});return r.wu(e),r}Su(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.gu({path:n,yu:!1});return r.mu(),r}bu(e){return this.gu({path:void 0,yu:!0})}Du(e){return vp(e,this.settings.methodName,this.settings.Cu||!1,this.path,this.settings.vu)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}mu(){if(this.path)for(let e=0;e<this.path.length;e++)this.wu(this.path.get(e))}wu(e){if(0===e.length)throw this.Du("Document fields must not be empty");if(ap(this.fu)&&ip.test(e))throw this.Du('Document fields cannot begin and end with "__"')}}class cp{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||rd(e)}Fu(e,t,n,r=!1){return new op({fu:e,methodName:t,vu:n,path:Go.emptyPath(),yu:!1,Cu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function up(e){const t=e._freezeSettings(),n=rd(e._databaseId);return new cp(e._databaseId,!!t.ignoreUndefinedProperties,n)}function lp(e,t,n,r,i,s={}){const a=e.Fu(s.merge||s.mergeFields?2:0,t,n,i);pp("Data must be an object, but it was:",a,r);const o=dp(r,a);let c,u;if(s.merge)c=new mc(a.fieldMask),u=a.fieldTransforms;else if(s.mergeFields){const e=[];for(const r of s.mergeFields){const i=mp(t,r,n);if(!a.contains(i))throw new xo(Oo.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);_p(e,i)||e.push(i)}c=new mc(e),u=a.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,u=a.fieldTransforms;return new sp(new Vc(o),c,u)}function hp(e,t){if(fp(e=xn(e)))return pp("Unsupported field value:",t,e),dp(e,t);if(e instanceof np)return function(e,t){if(!ap(t.fu))throw t.Du(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Du(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.yu&&4!==t.fu)throw t.Du("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const i of e){let e=hp(i,t.bu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=xn(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return function(e,t){return function(e){return"number"==typeof e&&Number.isInteger(e)&&!ac(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}(t)?qu(t):Vu(e,t)}(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=qo.fromDate(e);return{timestampValue:zl(t.serializer,n)}}if(e instanceof qo){const n=new qo(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:zl(t.serializer,n)}}if(e instanceof rp)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof ep)return{bytesValue:Hl(t.serializer,e._byteString)};if(e instanceof Hf){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Du(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Gl(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.Du(`Unsupported field value: ${Ff(e)}`)}(e,t)}function dp(e,t){const n={};return uc(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):cc(e,((e,r)=>{const i=hp(r,t.pu(e));null!=i&&(n[e]=i)})),{mapValue:{fields:n}}}function fp(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof qo||e instanceof rp||e instanceof ep||e instanceof Hf||e instanceof np)}function pp(e,t,n){if(!fp(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=Ff(n);throw"an object"===r?t.Du(e+" a custom object"):t.Du(e+" "+r)}}function mp(e,t,n){if((t=xn(t))instanceof tp)return t._internalPath;if("string"==typeof t)return yp(e,t);throw vp("Field path arguments must be of type string or ",e,!1,void 0,n)}const gp=new RegExp("[~\\*/\\[\\]]");function yp(e,t,n){if(t.search(gp)>=0)throw vp(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new tp(...t.split("."))._internalPath}catch(r){throw vp(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function vp(e,t,n,r,i){const s=r&&!r.isEmpty(),a=void 0!==i;let o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let c="";return(s||a)&&(c+=" (found",s&&(c+=` in field ${r}`),a&&(c+=` in document ${i}`),c+=")"),new xo(Oo.INVALID_ARGUMENT,o+e+c)}function _p(e,t){return e.some((e=>e.isEqual(t)))}class wp{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new Hf(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new bp(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Ep("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class bp extends wp{data(){return super.data()}}function Ep(e,t){return"string"==typeof t?yp(e,t):t instanceof tp?t._internalPath:t._delegate._internalPath}class Ip{convertValue(e,t="none"){switch(Oc(e)){case 0:return null;case 1:return e.booleanValue;case 2:return wc(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(bc(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw ko()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return cc(e,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new rp(wc(e.latitude),wc(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=Ic(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Tc(e));default:return null}}convertTimestamp(e){const t=_c(e);return new qo(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=Ko.fromString(e);So(ph(n));const r=new Sc(n.get(1),n.get(3)),i=new Zo(n.popFirst(5));return r.isEqual(t)||Eo(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function Tp(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class kp{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Sp extends wp{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Ap(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Ep("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Ap extends Sp{data(e={}){return super.data(e)}}function Op(e){e=Bf(e,Hf);const t=Bf(e.firestore,Jf);return function(e,t,n={}){const r=new Co;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,i){const s=new xf({next:s=>{t.enqueueAndForget((()=>async function(e,t){const n=Ao(e),r=t.query;let i=3;const s=n.queries.get(r);if(s){const e=s.U_.indexOf(t);e>=0&&(s.U_.splice(e,1),0===s.U_.length?i=t.G_()?0:1:!s.W_()&&t.G_()&&(i=2))}switch(i){case 0:return n.queries.delete(r),n.onUnlisten(r,!0);case 1:return n.queries.delete(r),n.onUnlisten(r,!1);case 2:return n.onLastRemoteStoreUnlisten(r);default:return}}(e,a)));const o=s.docs.has(n);!o&&s.fromCache?i.reject(new xo(Oo.UNAVAILABLE,"Failed to get document because the client is offline.")):o&&s.fromCache&&r&&"server"===r.source?i.reject(new xo(Oo.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(s)},error:e=>i.reject(e)}),a=new Qd(vu(n.path),s,{includeMetadataChanges:!0,ra:!0});return async function(e,t){const n=Ao(e);let r=3;const i=t.query;let s=n.queries.get(i);s?!s.W_()&&t.G_()&&(r=2):(s=new zd,r=t.G_()?0:1);try{switch(r){case 0:s.K_=await n.onListen(i,!0);break;case 1:s.K_=await n.onListen(i,!1);break;case 2:await n.onFirstRemoteStoreListen(i)}}catch(e){const n=Fd(e,`Initialization of query '${ku(t.query)}' failed`);return void t.onError(n)}n.queries.set(i,s),s.U_.push(t),t.j_(n.onlineState),s.K_&&t.H_(s.K_)&&Gd(n)}(e,a)}(await jf(e),e.asyncQueue,t,n,r))),r.promise}(Xf(t),e._key).then((n=>function(e,t,n){const r=n.docs.get(t._key),i=new xp(e);return new Sp(e,i,t._key,r,new kp(n.hasPendingWrites,n.fromCache),t.converter)}(t,e,n)))}class xp extends Ip{constructor(e){super(),this.firestore=e}convertBytes(e){return new ep(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Hf(this.firestore,null,t)}}function Cp(e,t,n){e=Bf(e,Hf);const r=Bf(e.firestore,Jf),i=Tp(e.converter,t,n);return Np(r,[lp(up(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,rl.none())])}function Pp(e,t){const n=Bf(e.firestore,Jf),r=Gf(e),i=Tp(e.converter,t);return Np(n,[lp(up(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,rl.exists(!1))]).then((()=>r))}function Np(e,t){return function(e,t){const n=new Co;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=Sf(e);try{const e=await function(e,t){const n=Ao(e),r=qo.now(),i=t.reduce(((e,t)=>e.add(t.key)),Fu());let s,a;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let o=Pu(),c=Fu();return n.os.getEntries(e,i).next((e=>{o=e,o.forEach(((e,t)=>{t.isValidDocument()||(c=c.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,o))).next((i=>{s=i;const a=[];for(const e of t){const t=ul(e,s.get(e.key).overlayedDocument);null!=t&&a.push(new dl(e.key,t,qc(t.value.mapValue),rl.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,a,t)})).next((t=>{a=t;const r=t.applyToLocalDocumentSet(s,c);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:a.batchId,changes:ju(s)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.xa[e.currentUser.toKey()];r||(r=new lc(Bo)),r=r.insert(t,n),e.xa[e.currentUser.toKey()]=r}(r,e.batchId,n),await Ef(r,e.changes),await Ad(r.remoteStore)}catch(e){const t=Fd(e,"Failed to persist write");n.reject(t)}}(await function(e){return Rf(e).then((e=>e.syncEngine))}(e),t,n))),n.promise}(Xf(e),t)}new WeakMap,function(e,t=!0){!function(e){vo=e}(qr),Ur(new Cn("firestore",((e,{instanceIdentifier:n,options:r})=>{const i=e.getProvider("app").getImmediate(),s=new Jf(new jo(e.getProvider("auth-internal")),new Uo(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new xo(Oo.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Sc(e.options.projectId,t)}(i,n),i);return r=Object.assign({useFetchStreams:t},r),s._setSettings(r),s}),"PUBLIC").setMultipleInstances(!0)),Kr(go,"4.6.3",e),Kr(go,"4.6.3","esm2017")}();const Rp=N.logger.get_logger({id:"firebase"});function jp(e){return zr(e)}function Lp(e){return function(e=Hr()){const t=$r(e,"auth");if(t.isInitialized())return t.getImmediate();const n=function(e,t){const n=$r(e,"auth");if(n.isInitialized()){const e=n.getImmediate();if(En(n.getOptions(),null!=t?t:{}))return e;ui(e,"already-initialized")}return n.initialize({options:t})}(e,{popupRedirectResolver:Ha,persistence:[ua,Ks,Gs]}),r=gn("authTokenSyncURL");if(r&&"boolean"==typeof isSecureContext&&isSecureContext){const e=new URL(r,location.origin);if(location.origin===e.origin){const t=Qa(e.toString());!function(e,t,n){xn(e).beforeAuthStateChanged(t,n)}(n,t,(()=>t(n.currentUser))),function(e,n,r,i){xn(e).onIdTokenChanged((e=>t(e)),void 0,void 0)}(n)}}const i=fn("auth");return i&&function(e,t,n){const r=fs(e);pi(r._canInitEmulator,r,"emulator-config-failed"),pi(/^https?:\/\//.test(t),r,"invalid-emulator-scheme");const i=bs(t),{host:s,port:a}=function(e){const t=bs(e),n=/(\/\/)?([^?#/]+)/.exec(e.substr(t.length));if(!n)return{host:"",port:null};const r=n[2].split("@").pop()||"",i=/^(\[[^\]]+\])(:|$)/.exec(r);if(i){const e=i[1];return{host:e,port:Es(r.substr(e.length+1))}}{const[e,t]=r.split(":");return{host:e,port:Es(t)}}}(t),o=null===a?"":`:${a}`;r.config.emulator={url:`${i}//${s}${o}/`},r.settings.appVerificationDisabledForTesting=!0,r.emulatorConfig=Object.freeze({host:s,port:a,protocol:i.replace(":",""),options:Object.freeze({disableWarnings:!1})}),function(){function e(){const e=document.createElement("p"),t=e.style;e.innerText="Running in emulator mode. Do not use with production credentials.",t.position="fixed",t.width="100%",t.backgroundColor="#ffffff",t.border=".1em solid #000000",t.color="#b50000",t.bottom="0px",t.left="0px",t.margin="0px",t.zIndex="10000",t.textAlign="center",e.classList.add("firebase-emulator-warning"),document.body.appendChild(e)}"undefined"!=typeof console&&"function"==typeof console.info&&console.info("WARNING: You are using the Auth Emulator, which is intended for local testing only.  Do not use with production credentials."),"undefined"!=typeof window&&"undefined"!=typeof document&&("loading"===document.readyState?window.addEventListener("DOMContentLoaded",e):e())}()}(n,`http://${i}`),n}(e)}function Dp(e){return Qf(e)}function Mp(e){let t=jp(e);return{app:t,auth:Lp(t),db:Dp(t)}}function Up(e){(function(e){return xn(e).signOut()})(e).then((()=>{Rp("User signed out")})).catch((e=>{Rp("Signout error")}))}function $p(e){let t=rn(e);return t.note_on=function(e,n,r){let i=N.midi_encoder.note_on(e,n,r);t.write(i)},t.note_off=function(e,n,r){let i=Uint8Array.from([128+e,n,r]);t.write(i)},t.control_change=function(e,n,r){let i=N.midi_encoder.control_change(e,n,r);t.write(i)},t}const Fp=N.logger.get_logger({id:"sensors"});var Bp=!1,Vp=!1,qp={},zp={};function Hp(e){let t="default.motion.logger";Wp(t,(function(e){let{acceleration:t,rotationRate:n}=e,{x:r,y:i,z:s}=t,{alpha:a,beta:o,gamma:c}=n;Fp(`x,y,z,alpha,beta,gamma=${r},${i},${s},${a},${o},${c}`)})),window.setTimeout((function(){Zp(t)}),1e3*e)}function Kp(e){let t="default.orientation.logger";Gp(t,(function(e){let{alpha:t,beta:n,gamma:r}=e;Fp(`alpha,beta,gamma=${t},${n},${r}`)})),window.setTimeout((function(){Jp(t)}),1e3*e)}function Wp(e,t){Yp(),qp[e]&&Fp(`WARNING! motion subscription id ${e} has already been used`),qp[e]=t}function Gp(e,t){em(),zp[e]&&Fp(`WARNING! orientation subscription id ${e} has already been used`),zp[e]=t}function Zp(e){delete qp[e],Fp(`Unsubscribed motion id: ${e}`),N.fp.is_empty_array(N.fp.keys(qp))&&(Fp("No more motion subscribers; so listener will be detached"),tm())}function Jp(e){delete zp[e],Fp(`Unsubscribed orientation id: ${e}`),N.fp.is_empty_array(N.fp.keys(zp))&&(Fp("No more orientation subscribers; so listener will be detached"),nm())}function Qp(e){N.fp.values(qp).map((t=>t(e)))}function Xp(e){N.fp.values(zp).map((t=>t(e)))}function Yp(){Bp||(window.addEventListener("devicemotion",Qp),Fp("Started listening to device motion (registered handler"),Bp=!0)}function em(){Vp||(window.addEventListener("deviceorientation",Xp),Fp("Started listening to device orientation (registered handler"),Vp=!0)}function tm(){window.removeEventListener("devicemotion",Qp),Bp=!1,Fp("Unregistered device motion handler")}function nm(){window.removeEventListener("deviceorientation",Xp),Vp=!1,Fp("Unregistered device orientation handler")}const rm=N.logger.get_logger({id:"idbmod"});class im{constructor(e="keyval-store",t="keyval"){this.storeName=t,this._db=null,this._dbp=new Promise(((n,r)=>{let i=this;const s=indexedDB.open(e,1);s.onerror=()=>r(s.error),s.onsuccess=function(){n(s.result),i._db=s.result},s.onupgradeneeded=()=>{rm(`creating store: ${e},  ${t}`),s.result.createObjectStore(t)}}))}_withIDBStore(e,t){return this._dbp.then((n=>new Promise(((r,i)=>{const s=n.transaction(this.storeName,e);s.oncomplete=()=>r(),s.onabort=s.onerror=()=>i(s.error),t(s.objectStore(this.storeName))}))))}get_db(){return this._db}}let sm;function am(){return sm||(sm=new im),sm}const om=N.logger.get_logger({id:"db"}),cm=N.dates,um={};var lm=5e3;const hm="main_store",dm="TIDYSCRIPTS_WEB_";var fm=null,pm=!1;function mm(e,t=!0){if(pm||(om("initializing TTL"),pm=!0,fm=mm("TTL")),um[e])return t&&om(`getting db from local cache: ${e}`),um[e];var n=new im(dm+e,hm);function r(e,t){return function(e,t,n=am()){return n._withIDBStore("readwrite",(n=>{n.put(t,e)}))}(e,t,n)}let i={store:n,set:r,get:function(e){return function(e,t=am()){let n;return t._withIDBStore("readonly",(t=>{n=t.get(e)})).then((()=>n.result))}(e,n)},del:function(e){return function(e,t=am()){return t._withIDBStore("readwrite",(t=>{t.delete(e)}))}(e,n)},keys:function(){return function(e=am()){const t=[];return e._withIDBStore("readonly",(e=>{(e.openKeyCursor||e.openCursor).call(e).onsuccess=function(){this.result&&(t.push(this.result.key),this.result.continue())}})).then((()=>t))}(n)},clear:function(){return function(e=am()){return e._withIDBStore("readwrite",(e=>{e.clear()}))}(n)},set_with_ttl:async function(t){let{id:n,ttl_ms:i,value:s}=t,a=i+cm.ms_now();om(`In db "${e}" setting "${n}" with ttl_ms ${i}, expiration = ${a}`),await r(n,s),await fm.set(a,{db_id:e,del_id:n}),om("done setting with ttl \\(^.^)/")},get_db_store:function(){return n},ready:function(){return n._dbp}};return um[e]=i,t&&om(`getting db: ${e}`),i}function gm(e){lm=e,om("Updated cache check interval to "+e+" ms")}var ym=null;async function vm(){let e=await fm.keys(),t=e.length,n=e.filter((e=>e<cm.ms_now())),r=n.length,i=[];for(var s of n){let{db_id:e,del_id:t}=await fm.get(s),n=mm(e,!1);await n.del(t),await fm.del(s),i.push({db_id:e,del_id:t})}om(`CacheCheck |> ${r}/${t} expired:`),r>0&&om(i)}function _m(e){ym&&(om("Already checking, will clear old interval."),wm()),gm(e),ym=setInterval(vm,lm)}function wm(){clearInterval(ym),om("Stopped cache check")}function bm(e){return window.indexedDB.deleteDatabase(dm+e)}async function Em(e){let t=mm(e).get_db_store()._db;return await(n=t,new Promise(((e,t)=>{const r={};if(0===n.objectStoreNames.length)e(JSON.stringify(r));else{const i=n.transaction(n.objectStoreNames,"readonly");i.addEventListener("error",t);for(const t of n.objectStoreNames){const s=[];i.objectStore(t).openCursor().addEventListener("success",(i=>{const a=i.target.result;a?(s.push([a.key,a.value]),a.continue()):(r[t]=s,n.objectStoreNames.length===Object.keys(r).length&&e(JSON.stringify(r)))}))}}})));var n}async function Im(e,t){let n=mm(e);await n.ready();let r=n.get_db_store()._db;return await(i=r,s=t,new Promise(((e,t)=>{const n=i.transaction(i.objectStoreNames,"readwrite");n.addEventListener("error",t);var r=JSON.parse(s);for(const t of i.objectStoreNames){let i=0;for(const s of r[t]){let[a,o]=s;n.objectStore(t).add(o,a).addEventListener("success",(()=>{i++,i===r[t].length&&(delete r[t],0===Object.keys(r).length&&e("ok"))}))}}})));var i,s}const Tm=N.logger.get_logger({id:"bokeh"});var km=!1;async function Sm(){if(window.Bokeh)return void Tm("Bokeh is already loaded! Skipping load for now...");if(km)return void Tm("Bokeh is already loading! Skipping load for now...");km=!0;let e="3.0.0",t=[`https://cdn.bokeh.org/bokeh/release/bokeh-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-widgets-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-tables-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-api-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-gl-${e}.min.js`,`https://cdn.bokeh.org/bokeh/release/bokeh-mathjax-${e}.min.js`];for(var n of(Tm("Loading scripts"),t))Tm(`Loading ${n}`),await Et({src:n,attributes:{crossorigin:"anonymous"}});Tm("Done")}const Am=N.util.dsp;N.util.debug;var Om=null,xm=null,Cm=null,Pm=null;const Nm=N.logger.get_logger({id:"web_audio"});async function Rm(){return Om||(Om=new window.AudioContext,xm=await window.navigator.mediaDevices.getUserMedia({audio:!0}),Om)}async function jm(){return xm||(await Rm(),await window.navigator.mediaDevices.getUserMedia({audio:!0}))}async function Lm(){return(await jm()).getAudioTracks()[0].getSettings().sampleRate}async function Dm(e){let t=await Rm();return await t.decodeAudioData(e)}async function Mm(e){return await Dm(await e.arrayBuffer())}var Um={};function $m(e,t){Um[e]=t}function Fm(e){Object.keys(Um).length>0&&N.fp.apply_function_dictionary_to_object(Um,e)}var Bm,Vm=!1;async function qm(){if(Vm)return Nm("mic already initialized");let e=await Rm(),t=await jm(),n=e.createMediaStreamSource(t);(Cm=e.createAnalyser()).fftSize=2048,Bm=new Float32Array(Cm.frequencyBinCount),n.connect(Cm),Vm=!0,function e(){requestAnimationFrame(e),Cm.getFloatTimeDomainData(Bm),Fm(Bm)}()}var zm,Hm=new Float32Array(1024),Km=new Float32Array(1024);async function Wm(e){Nm(`testing diff with ${e} ms`),Cm.getFloatTimeDomainData(Hm),window.setTimeout((function(){Cm.getFloatTimeDomainData(Km);let e=JSON.stringify(Hm)==JSON.stringify(Km);Nm(`Equality = ${e}`)}),e)}async function Gm(e){if(await qm(),Pm)return Nm("sound event detector already initialized"),Pm;let t={threshold:.2,margin:600,audio_buffer_size:Bm.length,register_fn:$m},n=Object.assign(t,e);return Pm=new zm(n),await Pm.init(),Pm}async function Zm(e,t){await Sm();const n=N.fp.range(0,e.length),r=Array.from(e),i=new Bokeh.ColumnDataSource({data:{x:n,y:r}}),s=new Bokeh.Plot({width:300,height:100}),a=new Bokeh.LinearAxis({axis_line_color:null}),o=new Bokeh.LinearAxis({axis_line_color:null});s.add_layout(a,"below"),s.add_layout(o,"left");const c=new Bokeh.Grid({ticker:a.ticker,dimension:0}),u=new Bokeh.Grid({ticker:o.ticker,dimension:1});s.add_layout(c),s.add_layout(u);const l=new Bokeh.Line({x:{field:"x"},y:{field:"y"},line_color:"#666699",line_width:2});s.add_glyph(l,i),Bokeh.Plotting.show(s,document.getElementById(t))}function Jm(){return document.querySelector("textarea")}function Qm(e){Jm().value=e}function Xm(){Jm().parentElement.querySelector("button").click()}function Ym(e){Qm(e),Xm()}function eg(){window.addEventListener("tidyscripts_web_speech_recognition_result",(function(e){Ym(e.detail)})),et()}"undefined"!=typeof window&&(zm=class extends window.EventTarget{constructor(e){super();let{threshold:t,margin:n,register_fn:r,audio_buffer_size:i}=e;this.threshold=t,this.margin=n,this.register_fn=r,this.log=N.logger.get_logger({id:"snd_evt"}),this.sampling_rate=48e3,this.audio_buffer_size=i,this.tmp_buffer=[],this.tmp_buffer_max_length=10,this.recording_event=!1,this.event_start_time=0,this.time_of_last_detection=performance.now(),this.media_recorder=null}async init(){let e=this;this.register_fn("SED",(function(t){e.handle_data(t)})),this.log("Linked sound event detector to audio source"),this.sampling_rate=await Lm(),this.log(`Got sampling rate ${this.sampling_rate}`);let t=this.num_buffers_to_cover_margin();this.log(`Created tmp buffer of size ${t}`),this.tmp_buffer_max_length=t,this.tmp_buffer=N.fp.range(0,t).map((e=>new Float32Array(this.audio_buffer_size)));let n=await jm();this.media_recorder=new window.MediaRecorder(n),this.log("Initialized media recorder")}handle_data(e){this.tmp_buffer.shift(),this.tmp_buffer.push(e),this.analyze_tmp_buffer()}analyze_tmp_buffer(){let e=this.tmp_buffer,t=N.fp.all_true(e.map((e=>Am.mean_abs(e)>this.threshold)));if(this.recording_event){if(t)return void(this.time_of_last_detection=performance.now());let n=N.fp.all_true(e.map((e=>Am.mean_abs(e)<this.threshold))),r=performance.now()-this.time_of_last_detection>this.margin;n&&r&&(this.log("Detected quiet while recording event..."),this.recording_event=!1,this.media_recorder.stop(),this.log("Stopped recording"))}else if(t){let e=this;this.media_recorder.ondataavailable=function(t){let n=t.data,r=new window.CustomEvent("sound_event_ended",{detail:n});e.dispatchEvent(r)},this.media_recorder.start(),this.log("Detected event start"),this.time_since_last_detection=performance.now();let t=new window.Event("sound_event_started");this.dispatchEvent(t),this.recording_event=!0,this.event_start_time=N.util.unix_timestamp_ms()}}samples_to_ms(e){return 1e3*e/this.sampling_rate}ms_to_samples(e){return e*this.sampling_rate/1e3}num_buffers_to_cover_margin(){let e=this.ms_to_samples(this.margin);return Math.ceil(e/this.audio_buffer_size)}});var tg=null,ng="";function rg(e){console.log("new text:"+e)}function ig(e){lt(e)}function sg(e){lt(e)}function ag(){console.log("finished stream"),et()}function og(e,t){let n=e;tg=window.setInterval((function(){let e=document.querySelector(".result-streaming");if(e){let n=e.innerText,r=n.replace(ng,"");t?ig(r):rg(r),ng=n}else if(""==ng);else{let e=N.fp.last(Array.from(document.querySelectorAll("div.markdown"))).innerText.replace(ng,"");t?ig(e):rg(e),ng="",ag()}}),n)}var cg=["Google UK English Female","Google UK English Male","Google UK English","Karen","Rishi"];function ug(){window.clearInterval(tg)}function lg(e){ot(e)}async function hg(){await K(),ot(1.3),ct(cg)}var dg=2e3;async function fg(){eg(),await hg(),og(dg,!1)}async function pg(){eg(),await hg(),og(dg,!0)}})();var o=t;for(var c in a)o[c]=a[c];a.__esModule&&Object.defineProperty(o,"__esModule",{value:!0})}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,n),s.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};return(()=>{"use strict";n.r(r);var e=n(515);window.tsw=e})(),r})()));